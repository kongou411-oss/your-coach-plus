rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ============================================
    // ヘルパー関数（2024-12-24 updated）
    // ============================================

    // 認証済みユーザーかどうか
    function isAuthenticated() {
      return request.auth != null;
    }

    // 本人かどうか
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }

    // 管理者かどうか（メールアドレスベース）
    function isAdmin() {
      return isAuthenticated() &&
        (request.auth.token.email == 'official@your-coach-plus.com' ||
         request.auth.token.email == 'kongou411@gmail.com');
    }

    // ============================================
    // giftCodes: クライアントアクセス禁止（Cloud Functionsのみ）
    // ============================================
    match /giftCodes/{codeId} {
      allow read, write: if false;
    }

    // ============================================
    // gymLeads: ジム営業リスト（管理者のみ）
    // ============================================
    match /gymLeads/{gymId} {
      allow read, write: if isAdmin();
    }

    // ============================================
    // b2b2cOrganizations: 認証済みユーザーのみ読み取り可能
    // ============================================
    match /b2b2cOrganizations/{orgId} {
      allow read: if isAuthenticated();
      allow write: if false;
    }

    // ============================================
    // corporateContracts: 法人契約（管理者のみ読み取り可能）
    // ============================================
    match /corporateContracts/{contractId} {
      allow read: if isAdmin();
      allow write: if false; // Cloud Functionsのみ
    }

    // ============================================
    // referrals: 認証済みユーザーのみ読み取り可能
    // ============================================
    match /referrals/{referralId} {
      allow read: if isAuthenticated();
      allow write: if false;
    }

    // ============================================
    // users: ユーザープロフィール
    // - 読み取り: 認証済みユーザー全員（コミュニティ機能でプロフィール表示のため）
    // - 書き込み: 本人のみ（ただし課金関連フィールドはCloud Functionsのみ）
    // ============================================
    match /users/{userId} {
      allow read: if isAuthenticated();

      // 本人は保護フィールド以外のみ書き込み可能
      // 他の認証済みユーザーはfollowerCountのみ更新可能（フォロー機能用）
      allow create: if isOwner(userId);
      allow update: if isAdmin()
                    || (isOwner(userId)
                    && resource.data != null
                    && !request.resource.data.diff(resource.data).affectedKeys().hasAny([
          'subscription',
          'subscriptionStatus',
          'subscriptionTier',
          'paidCredits',
          'freeCredits',
          'stripeCustomerId',
          'b2b2cOrgId',
          'b2b2cOrgName',
          'b2b2cAccessCode',
          'b2b2cJoinedAt',
          'isPremium',
          'referralCode',
          'referredBy',
          'referralCodeUsed',
          'referralCreditsEarned',
          'experience',
          'level',
          'processedScoreDates',
          'processedDirectiveDates',
          'role'
        ]))
                    || (isAuthenticated()
                    && resource.data != null
                    && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['followerCount']));
      allow delete: if isOwner(userId);

      // サブコレクション: settings
      match /settings/{settingId} {
        allow read, write: if isOwner(userId);
      }

      // サブコレクション: pgbaseChats
      match /pgbaseChats/{chatId} {
        allow read, write: if isOwner(userId);
      }

      // サブコレクション: analysisReports
      match /analysisReports/{reportId} {
        allow read, write: if isOwner(userId);
      }

      // サブコレクション: templates (食事・運動テンプレート)
      match /templates/{templateId} {
        allow read, write: if isOwner(userId);
      }

      // サブコレクション: mealTemplates（食事テンプレート）
      match /mealTemplates/{templateId} {
        allow read, write: if isOwner(userId);
      }

      // サブコレクション: workoutTemplates（運動テンプレート）
      match /workoutTemplates/{templateId} {
        allow read, write: if isOwner(userId);
      }

      // サブコレクション: routines
      match /routines/{routineId} {
        allow read, write: if isOwner(userId);
      }

      // サブコレクション: routinePatterns（ネイティブアプリ用）
      match /routinePatterns/{patternId} {
        allow read, write: if isOwner(userId);
      }

      // サブコレクション: customFoods
      match /customFoods/{foodId} {
        allow read, write: if isOwner(userId);
      }

      // サブコレクション: customExercises
      match /customExercises/{exerciseId} {
        allow read, write: if isOwner(userId);
      }

      // サブコレクション: purchasedTextbooks
      match /purchasedTextbooks/{textbookId} {
        allow read, write: if isOwner(userId);
      }

      // サブコレクション: directives（AI分析の指示）
      match /directives/{directiveId} {
        allow read, write: if isOwner(userId);
      }

      // サブコレクション: custom_quests（トレーナー指定カスタムクエスト）
      // - 読み取り: 本人のみ
      // - 書き込み: 管理者のみ（admin.htmlから操作）
      match /custom_quests/{questDate} {
        allow read: if isOwner(userId);
        allow write: if isAdmin();
      }

      // サブコレクション: pgbase_progress（PGBASE記事の進捗）
      match /pgbase_progress/{articleId} {
        allow read, write: if isOwner(userId);
      }

      // サブコレクション: comy_likes（COMYのいいね）
      match /comy_likes/{postId} {
        allow read, write: if isOwner(userId);
      }

      // サブコレクション: analyses（AI分析結果）
      match /analyses/{analysisId} {
        allow read, write: if isOwner(userId);
      }

      // サブコレクション: conditions（コンディション記録）
      match /conditions/{conditionId} {
        allow read, write: if isOwner(userId);
      }

      // サブコレクション: meals（食事記録）
      match /meals/{mealId} {
        allow read, write: if isOwner(userId);
      }

      // サブコレクション: workouts（運動記録）
      match /workouts/{workoutId} {
        allow read, write: if isOwner(userId);
      }

      // サブコレクション: dailyScores（デイリースコア）
      match /dailyScores/{scoreId} {
        allow read, write: if isOwner(userId);
      }

      // サブコレクション: badges（バッジ）
      match /badges/{badgeId} {
        allow read, write: if isOwner(userId);
      }

      // サブコレクション: experience（経験値・クレジット）
      match /experience/{expId} {
        allow read: if isOwner(userId);
        // 書き込みはCloud Functionsのみ（クレジット操作のため）
        allow write: if false;
      }
    }

    // ============================================
    // dailyRecords: 日次記録（本人のみ）
    // ============================================
    match /dailyRecords/{userId} {
      allow read, write: if isOwner(userId);

      match /records/{date} {
        allow read, write: if isOwner(userId);
      }
    }

    // ============================================
    // mealTemplates: 食事テンプレート（本人のみ）
    // ============================================
    match /mealTemplates/{userId} {
      allow read, write: if isOwner(userId);
    }

    // ============================================
    // workoutTemplates: 運動テンプレート（本人のみ）
    // ============================================
    match /workoutTemplates/{userId} {
      allow read, write: if isOwner(userId);
    }

    // ============================================
    // communityProjects: COMYプロジェクト
    // - 読み取り: 認証済みユーザー全員
    // - 作成: 認証済みユーザー（自分のuserIdで）
    // - 更新: 作成者本人、またはいいね操作（likes/likedUsersフィールドのみ）
    // - 削除: 作成者本人のみ
    // ============================================
    match /communityProjects/{projectId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated()
                    && request.resource.data.userId == request.auth.uid;
      allow update: if isAuthenticated()
                    && (resource.data.userId == request.auth.uid
                        || (request.resource.data.diff(resource.data).affectedKeys()
                            .hasOnly(['likes', 'likedUsers', 'commentCount'])));
      allow delete: if isAuthenticated()
                    && resource.data.userId == request.auth.uid;

      // サブコレクション: progress（プロジェクト進捗）
      match /progress/{progressId} {
        allow read: if isAuthenticated();
        allow create: if isAuthenticated();
        // 更新: プロジェクト作成者本人、またはいいね/コメント操作（likes/likedUsers/commentCountフィールドのみ）
        allow update: if isAuthenticated()
                      && (get(/databases/$(database)/documents/communityProjects/$(projectId)).data.userId == request.auth.uid
                          || (request.resource.data.diff(resource.data).affectedKeys()
                              .hasOnly(['likes', 'likedUsers', 'commentCount'])));
        // 削除: プロジェクト作成者本人のみ
        allow delete: if isAuthenticated()
                      && get(/databases/$(database)/documents/communityProjects/$(projectId)).data.userId == request.auth.uid;

        // サブコレクション: comments（コメント）- progress配下
        match /comments/{commentId} {
          allow read: if isAuthenticated();
          allow create: if isAuthenticated()
                        && request.resource.data.userId == request.auth.uid;
          allow update, delete: if isAuthenticated()
                                && resource.data.userId == request.auth.uid;
        }
      }

      // サブコレクション: comments（コメント）- project直下（後方互換性）
      match /comments/{commentId} {
        allow read: if isAuthenticated();
        allow create: if isAuthenticated()
                      && request.resource.data.userId == request.auth.uid;
        allow update, delete: if isAuthenticated()
                              && resource.data.userId == request.auth.uid;
      }
    }

    // ============================================
    // communityPosts: コミュニティ投稿
    // - 読み取り: 認証済みユーザー全員
    // - 作成: 認証済みユーザー（自分のuserIdで）
    // - 更新: 作成者本人、またはいいね操作（likes/likedUsersフィールドのみ）
    // - 削除: 作成者本人のみ
    // ============================================
    match /communityPosts/{postId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated()
                    && request.resource.data.userId == request.auth.uid;
      // 更新: 作成者本人、またはいいね操作のみ許可
      allow update: if isAuthenticated()
                    && (resource.data.userId == request.auth.uid
                        || (request.resource.data.diff(resource.data).affectedKeys()
                            .hasOnly(['likes', 'likedUsers'])));
      allow delete: if isAuthenticated()
                    && resource.data.userId == request.auth.uid;

      // サブコレクション: comments（コメント）
      match /comments/{commentId} {
        allow read: if isAuthenticated();
        allow create: if isAuthenticated()
                      && request.resource.data.userId == request.auth.uid;
        allow update, delete: if isAuthenticated()
                              && resource.data.userId == request.auth.uid;
      }
    }

    // ============================================
    // pgbase_articles: PGBASE教科書記事（グローバル）
    // - 読み取り: 認証済みユーザー全員
    // - 書き込み: 管理者のみ
    // ============================================
    match /pgbase_articles/{articleId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }

    // ============================================
    // comy_posts: COMYコミュニティ投稿（ネイティブアプリ用）
    // - 読み取り: 認証済みユーザー全員
    // - 作成: 認証済みユーザー（自分のuserIdで）
    // - 更新: 作成者本人、またはいいね/コメント数操作
    // - 削除: 作成者本人または管理者
    // ============================================
    match /comy_posts/{postId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated()
                    && request.resource.data.userId == request.auth.uid;
      allow update: if isAuthenticated()
                    && (resource.data.userId == request.auth.uid
                        || (request.resource.data.diff(resource.data).affectedKeys()
                            .hasOnly(['likeCount', 'commentCount'])));
      allow delete: if isAuthenticated()
                    && (resource.data.userId == request.auth.uid || isAdmin());

      // サブコレクション: comments（コメント）
      match /comments/{commentId} {
        allow read: if isAuthenticated();
        allow create: if isAuthenticated()
                      && request.resource.data.userId == request.auth.uid;
        allow update: if isAuthenticated()
                      && resource.data.userId == request.auth.uid;
        allow delete: if isAuthenticated()
                      && (resource.data.userId == request.auth.uid || isAdmin());
      }
    }

    // ============================================
    // follows: フォロー関係
    // - 読み取り: 認証済みユーザー全員
    // - 作成: 認証済みユーザー（自分がフォロワーの場合のみ）
    // - 削除: フォロワー本人のみ
    // ============================================
    match /follows/{followId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated()
                    && request.resource.data.followerId == request.auth.uid;
      allow delete: if isAuthenticated()
                    && resource.data.followerId == request.auth.uid;
      allow update: if false; // 更新は不可
    }

    // ============================================
    // notifications: 通知スケジュール（Cloud Functionsのみ）
    // ============================================
    match /notifications/{notificationId} {
      allow read, write: if false;
    }

    // ============================================
    // analytics: ユーザー行動トラッキング（本人のみ）
    // ============================================
    match /analytics/{userId} {
      allow read, write: if isOwner(userId);

      // サブコレクション: events
      match /events/{eventId} {
        allow read, write: if isOwner(userId);
      }

      // サブコレクション: dailyEvents（日別集計）
      match /dailyEvents/{eventId} {
        allow read, write: if isOwner(userId);
      }
    }

    // ============================================
    // stripeCustomers: Stripe顧客情報（Cloud Functionsのみ）
    // ============================================
    match /stripeCustomers/{customerId} {
      allow read, write: if false;
    }

    // ============================================
    // quest_templates: カスタムクエストテンプレート（管理者のみ）
    // ============================================
    match /quest_templates/{templateId} {
      allow read: if isAdmin();
      allow write: if isAdmin();
    }

    // ============================================
    // analysis_requests: AI分析リクエスト（非同期処理用）
    // - 作成: 認証済みユーザー（自分のuserIdで）
    // - 読み取り: 本人のみ
    // - 更新: Cloud Functionsのみ（ステータス更新）
    // ============================================
    match /analysis_requests/{requestId} {
      allow create: if isAuthenticated()
                    && request.resource.data.userId == request.auth.uid;
      allow read: if isAuthenticated()
                  && resource.data.userId == request.auth.uid;
      allow update, delete: if false; // Cloud Functionsのみ
    }
  }
}
