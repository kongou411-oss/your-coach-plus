rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ============================================
    // ヘルパー関数
    // ============================================

    // 認証済みユーザーかどうか
    function isAuthenticated() {
      return request.auth != null;
    }

    // 本人かどうか
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }

    // 管理者かどうか（UIDベース）
    function isAdmin() {
      return isAuthenticated() && request.auth.uid == 'jipZEwO1TPfSdm55qypEmPYwOA02';
    }

    // ============================================
    // giftCodes: クライアントアクセス禁止（Cloud Functionsのみ）
    // ============================================
    match /giftCodes/{codeId} {
      allow read, write: if false;
    }

    // ============================================
    // b2b2cOrganizations: 認証済みユーザーのみ読み取り可能
    // ============================================
    match /b2b2cOrganizations/{orgId} {
      allow read: if isAuthenticated();
      allow write: if false;
    }

    // ============================================
    // referrals: 認証済みユーザーのみ読み取り可能
    // ============================================
    match /referrals/{referralId} {
      allow read: if isAuthenticated();
      allow write: if false;
    }

    // ============================================
    // users: ユーザープロフィール（本人または管理者）
    // ============================================
    match /users/{userId} {
      allow read: if isOwner(userId) || isAdmin();
      allow write: if isOwner(userId);

      // サブコレクション: settings
      match /settings/{settingId} {
        allow read, write: if isOwner(userId);
      }

      // サブコレクション: pgbaseChats
      match /pgbaseChats/{chatId} {
        allow read, write: if isOwner(userId);
      }

      // サブコレクション: analysisReports
      match /analysisReports/{reportId} {
        allow read, write: if isOwner(userId);
      }

      // サブコレクション: templates (食事・運動テンプレート)
      match /templates/{templateId} {
        allow read, write: if isOwner(userId);
      }

      // サブコレクション: routines
      match /routines/{routineId} {
        allow read, write: if isOwner(userId);
      }

      // サブコレクション: customFoods
      match /customFoods/{foodId} {
        allow read, write: if isOwner(userId);
      }

      // サブコレクション: customExercises
      match /customExercises/{exerciseId} {
        allow read, write: if isOwner(userId);
      }

      // サブコレクション: purchasedTextbooks
      match /purchasedTextbooks/{textbookId} {
        allow read, write: if isOwner(userId);
      }

      // サブコレクション: directives（AI分析の指示）
      match /directives/{directiveId} {
        allow read, write: if isOwner(userId);
      }

      // サブコレクション: analyses（AI分析結果）
      match /analyses/{analysisId} {
        allow read, write: if isOwner(userId);
      }
    }

    // ============================================
    // dailyRecords: 日次記録（本人のみ）
    // ============================================
    match /dailyRecords/{userId} {
      allow read, write: if isOwner(userId);

      match /records/{date} {
        allow read, write: if isOwner(userId);
      }
    }

    // ============================================
    // mealTemplates: 食事テンプレート（本人のみ）
    // ============================================
    match /mealTemplates/{userId} {
      allow read, write: if isOwner(userId);
    }

    // ============================================
    // workoutTemplates: 運動テンプレート（本人のみ）
    // ============================================
    match /workoutTemplates/{userId} {
      allow read, write: if isOwner(userId);
    }

    // ============================================
    // communityProjects: COMYプロジェクト
    // - 読み取り: 認証済みユーザー全員
    // - 作成: 認証済みユーザー（自分のuserIdで）
    // - 更新: 作成者本人、またはいいね操作（likes/likedUsersフィールドのみ）
    // - 削除: 作成者本人のみ
    // ============================================
    match /communityProjects/{projectId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated()
                    && request.resource.data.userId == request.auth.uid;
      allow update: if isAuthenticated()
                    && (resource.data.userId == request.auth.uid
                        || (request.resource.data.diff(resource.data).affectedKeys()
                            .hasOnly(['likes', 'likedUsers', 'commentCount'])));
      allow delete: if isAuthenticated()
                    && resource.data.userId == request.auth.uid;

      // サブコレクション: progress（プロジェクト進捗）
      match /progress/{progressId} {
        allow read: if isAuthenticated();
        allow create: if isAuthenticated();
        // 更新: プロジェクト作成者本人、またはいいね/コメント操作（likes/likedUsers/commentCountフィールドのみ）
        allow update: if isAuthenticated()
                      && (get(/databases/$(database)/documents/communityProjects/$(projectId)).data.userId == request.auth.uid
                          || (request.resource.data.diff(resource.data).affectedKeys()
                              .hasOnly(['likes', 'likedUsers', 'commentCount'])));
        // 削除: プロジェクト作成者本人のみ
        allow delete: if isAuthenticated()
                      && get(/databases/$(database)/documents/communityProjects/$(projectId)).data.userId == request.auth.uid;

        // サブコレクション: comments（コメント）- progress配下
        match /comments/{commentId} {
          allow read: if isAuthenticated();
          allow create: if isAuthenticated()
                        && request.resource.data.userId == request.auth.uid;
          allow update, delete: if isAuthenticated()
                                && resource.data.userId == request.auth.uid;
        }
      }

      // サブコレクション: comments（コメント）- project直下（後方互換性）
      match /comments/{commentId} {
        allow read: if isAuthenticated();
        allow create: if isAuthenticated()
                      && request.resource.data.userId == request.auth.uid;
        allow update, delete: if isAuthenticated()
                              && resource.data.userId == request.auth.uid;
      }
    }

    // ============================================
    // communityPosts: コミュニティ投稿
    // - 読み取り: 認証済みユーザー全員
    // - 作成: 認証済みユーザー（自分のuserIdで）
    // - 更新: 作成者本人、またはいいね操作（likes/likedUsersフィールドのみ）
    // - 削除: 作成者本人のみ
    // ============================================
    match /communityPosts/{postId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated()
                    && request.resource.data.userId == request.auth.uid;
      // 更新: 作成者本人、またはいいね操作のみ許可
      allow update: if isAuthenticated()
                    && (resource.data.userId == request.auth.uid
                        || (request.resource.data.diff(resource.data).affectedKeys()
                            .hasOnly(['likes', 'likedUsers'])));
      allow delete: if isAuthenticated()
                    && resource.data.userId == request.auth.uid;

      // サブコレクション: comments（コメント）
      match /comments/{commentId} {
        allow read: if isAuthenticated();
        allow create: if isAuthenticated()
                      && request.resource.data.userId == request.auth.uid;
        allow update, delete: if isAuthenticated()
                              && resource.data.userId == request.auth.uid;
      }
    }

    // ============================================
    // follows: フォロー関係
    // - 読み取り: 認証済みユーザー全員
    // - 作成: 認証済みユーザー（自分がフォロワーの場合のみ）
    // - 削除: フォロワー本人のみ
    // ============================================
    match /follows/{followId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated()
                    && request.resource.data.followerId == request.auth.uid;
      allow delete: if isAuthenticated()
                    && resource.data.followerId == request.auth.uid;
      allow update: if false; // 更新は不可
    }

    // ============================================
    // notifications: 通知スケジュール（Cloud Functionsのみ）
    // ============================================
    match /notifications/{notificationId} {
      allow read, write: if false;
    }

    // ============================================
    // analytics: ユーザー行動トラッキング（本人のみ）
    // ============================================
    match /analytics/{userId} {
      allow read, write: if isOwner(userId);

      // サブコレクション: events
      match /events/{eventId} {
        allow read, write: if isOwner(userId);
      }

      // サブコレクション: dailyEvents（日別集計）
      match /dailyEvents/{eventId} {
        allow read, write: if isOwner(userId);
      }
    }

    // ============================================
    // stripeCustomers: Stripe顧客情報（Cloud Functionsのみ）
    // ============================================
    match /stripeCustomers/{customerId} {
      allow read, write: if false;
    }
  }
}
