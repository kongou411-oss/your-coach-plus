rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ============================================
    // ヘルパー関数
    // ============================================

    // 認証済みユーザーかどうか
    function isAuthenticated() {
      return request.auth != null;
    }

    // 本人かどうか
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }

    // ============================================
    // giftCodes: クライアントアクセス禁止（Cloud Functionsのみ）
    // ============================================
    match /giftCodes/{codeId} {
      allow read, write: if false;
    }

    // ============================================
    // b2b2cOrganizations: クライアントアクセス禁止（Cloud Functionsのみ）
    // ============================================
    match /b2b2cOrganizations/{orgId} {
      allow read, write: if false;
    }

    // ============================================
    // referrals: クライアントアクセス禁止（Cloud Functionsのみ）
    // ============================================
    match /referrals/{referralId} {
      allow read, write: if false;
    }

    // ============================================
    // users: ユーザープロフィール（本人のみ）
    // ============================================
    match /users/{userId} {
      allow read, write: if isOwner(userId);

      // サブコレクション: settings
      match /settings/{settingId} {
        allow read, write: if isOwner(userId);
      }

      // サブコレクション: pgbaseChats
      match /pgbaseChats/{chatId} {
        allow read, write: if isOwner(userId);
      }

      // サブコレクション: analysisReports
      match /analysisReports/{reportId} {
        allow read, write: if isOwner(userId);
      }

      // サブコレクション: templates (食事・運動テンプレート)
      match /templates/{templateId} {
        allow read, write: if isOwner(userId);
      }

      // サブコレクション: routines
      match /routines/{routineId} {
        allow read, write: if isOwner(userId);
      }

      // サブコレクション: customFoods
      match /customFoods/{foodId} {
        allow read, write: if isOwner(userId);
      }

      // サブコレクション: customExercises
      match /customExercises/{exerciseId} {
        allow read, write: if isOwner(userId);
      }

      // サブコレクション: purchasedTextbooks
      match /purchasedTextbooks/{textbookId} {
        allow read, write: if isOwner(userId);
      }
    }

    // ============================================
    // dailyRecords: 日次記録（本人のみ）
    // ============================================
    match /dailyRecords/{userId} {
      allow read, write: if isOwner(userId);

      match /records/{date} {
        allow read, write: if isOwner(userId);
      }
    }

    // ============================================
    // communityPosts: コミュニティ投稿
    // - 読み取り: 認証済みユーザー全員
    // - 作成: 認証済みユーザー（自分のuserIdで）
    // - 更新: 作成者本人、またはいいね操作（likes/likedUsersフィールドのみ）
    // - 削除: 作成者本人のみ
    // ============================================
    match /communityPosts/{postId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated()
                    && request.resource.data.userId == request.auth.uid;
      // 更新: 作成者本人、またはいいね操作のみ許可
      allow update: if isAuthenticated()
                    && (resource.data.userId == request.auth.uid
                        || (request.resource.data.diff(resource.data).affectedKeys()
                            .hasOnly(['likes', 'likedUsers'])));
      allow delete: if isAuthenticated()
                    && resource.data.userId == request.auth.uid;

      // サブコレクション: comments（コメント）
      match /comments/{commentId} {
        allow read: if isAuthenticated();
        allow create: if isAuthenticated()
                      && request.resource.data.userId == request.auth.uid;
        allow update, delete: if isAuthenticated()
                              && resource.data.userId == request.auth.uid;
      }
    }

    // ============================================
    // follows: フォロー関係
    // - 読み取り: 認証済みユーザー全員
    // - 作成: 認証済みユーザー（自分がフォロワーの場合のみ）
    // - 削除: フォロワー本人のみ
    // ============================================
    match /follows/{followId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated()
                    && request.resource.data.followerId == request.auth.uid;
      allow delete: if isAuthenticated()
                    && resource.data.followerId == request.auth.uid;
      allow update: if false; // 更新は不可
    }

    // ============================================
    // notifications: 通知スケジュール（Cloud Functionsのみ）
    // ============================================
    match /notifications/{notificationId} {
      allow read, write: if false;
    }

    // ============================================
    // stripeCustomers: Stripe顧客情報（Cloud Functionsのみ）
    // ============================================
    match /stripeCustomers/{customerId} {
      allow read, write: if false;
    }
  }
}
