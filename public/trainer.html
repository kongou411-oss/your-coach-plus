<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>トレーナーポータル - Your Coach+</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-functions-compat.js"></script>
    <script src="/config.js"></script>
    <script src="/js/cq-databases.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif; background: #f0f2f5; color: #333; height: 100vh; overflow: hidden; }
        .cq-header { background: white; border-bottom: 1px solid #e0e0e0; padding: 12px 24px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 4px rgba(0,0,0,0.05); z-index: 40; position: relative; }
        .cq-layout { display: flex; height: calc(100vh - 57px); }
        .cq-left { width: 280px; min-width: 280px; background: white; border-right: 1px solid #e0e0e0; display: flex; flex-direction: column; overflow: hidden; }
        .cq-main { flex: 1; overflow-y: auto; padding: 20px; }
        .cq-drawer-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.3); z-index: 45; opacity: 0; pointer-events: none; transition: opacity 0.3s; }
        .cq-drawer-overlay.open { opacity: 1; pointer-events: auto; }
        .cq-drawer { position: fixed; right: 0; top: 0; height: 100vh; width: 540px; background: rgba(255,255,255,0.92); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border-left: 1px solid rgba(255,255,255,0.3); box-shadow: -8px 0 30px rgba(0,0,0,0.12); transform: translateX(100%); transition: transform 0.3s cubic-bezier(0.4,0,0.2,1); z-index: 50; display: flex; flex-direction: column; overflow: hidden; }
        .cq-drawer.open { transform: translateX(0); }
        .tpl-card { border: 1px solid #e5e7eb; border-radius: 10px; padding: 10px 12px; margin-bottom: 8px; cursor: pointer; transition: all 0.15s; background: white; }
        .tpl-card:hover { border-color: #5eead4; box-shadow: 0 2px 8px rgba(94,234,212,0.2); }
        .tpl-card-meal { border-left: 3px solid #22c55e; }
        .tpl-card-workout { border-left: 3px solid #3b82f6; }
        .bento-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; }
        .bento-card { background: white; border-radius: 14px; padding: 16px; box-shadow: 0 1px 4px rgba(0,0,0,0.06); border: 1px solid #e5e7eb; }
        .bento-card-lg { grid-column: span 2; grid-row: span 2; }
        .bento-card-md { grid-column: span 2; }
        .pfc-bar-bg { height: 22px; background: #f3f4f6; border-radius: 11px; overflow: hidden; position: relative; margin-bottom: 8px; }
        .pfc-bar-fill { height: 100%; border-radius: 11px; transition: width 0.4s ease, background-color 0.3s; }
        .pfc-bar-label { position: absolute; left: 8px; top: 50%; transform: translateY(-50%); font-size: 11px; font-weight: 600; color: #374151; z-index: 1; }
        .pfc-bar-value { position: absolute; right: 8px; top: 50%; transform: translateY(-50%); font-size: 10px; color: #6b7280; z-index: 1; }
        .cq-cat-btn { font-size: 11px; padding: 3px 8px; border: 1px solid #d1d5db; border-radius: 9999px; background: white; cursor: pointer; transition: all 0.15s; }
        .cq-cat-btn:hover { background: #fef9c3; border-color: #facc15; }
        .cq-cat-active { background: #fef08a !important; border-color: #eab308 !important; font-weight: 600; }
        .slot-timeline { display: flex; gap: 12px; overflow-x: auto; padding: 8px 0; }
        .slot-card { min-width: 110px; border: 2px solid #e5e7eb; border-radius: 12px; padding: 10px; text-align: center; cursor: pointer; transition: all 0.2s; flex-shrink: 0; }
        .slot-card:hover { border-color: #5eead4; transform: translateY(-2px); }
        .slot-card.assigned { border-color: #22c55e; background: #f0fdf4; }
        .slot-card.selected { border-color: #0d9488; background: #f0fdfa; box-shadow: 0 4px 12px rgba(13,148,136,0.15); }
        .cq-left::-webkit-scrollbar, .cq-main::-webkit-scrollbar, .cq-drawer::-webkit-scrollbar { width: 6px; }
        .cq-left::-webkit-scrollbar-thumb, .cq-main::-webkit-scrollbar-thumb, .cq-drawer::-webkit-scrollbar-thumb { background: #d1d5db; border-radius: 3px; }
        .prof-tab { padding: 6px 14px; font-size: 12px; font-weight: 600; border-bottom: 2px solid transparent; cursor: pointer; color: #6b7280; transition: all 0.2s; border-radius: 6px 6px 0 0; }
        .prof-tab.active { border-color: #0d9488; color: #0d9488; background: #f0fdfa; }
        @media (max-width: 1200px) { .bento-grid { grid-template-columns: repeat(2, 1fr); } .bento-card-lg { grid-column: span 2; grid-row: span 1; } }
        @media (max-width: 768px) { .cq-layout { flex-direction: column; } .cq-left { width: 100%; min-width: 100%; max-height: 200px; border-right: none; border-bottom: 1px solid #e0e0e0; } .cq-drawer { width: 100%; } .bento-grid { grid-template-columns: 1fr; } .bento-card-lg, .bento-card-md { grid-column: span 1; } }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="cq-header">
        <div class="flex items-center gap-3">
            <h1 class="text-lg font-bold text-gray-800">トレーナーポータル</h1>
            <span class="text-xs bg-teal-100 text-teal-700 px-2 py-0.5 rounded-full font-bold"><span id="cq-template-count">0</span>件</span>
            <span class="text-xs text-teal-600 font-bold" id="trainer-org-label"></span>
        </div>
        <div class="flex items-center gap-3">
            <button onclick="toggleGuide()" class="text-xs bg-gray-100 text-gray-600 px-3 py-1 rounded-lg hover:bg-gray-200 font-bold">? 使い方</button>
            <span class="text-sm text-gray-500" id="user-info"></span>
            <button onclick="logout()" class="text-xs text-red-500 hover:text-red-700">ログアウト</button>
        </div>
    </div>

    <div class="cq-layout">
        <!-- Left Pane: Template Library -->
        <div class="cq-left">
            <div class="p-3 border-b border-gray-200">
                <div class="flex items-center justify-between mb-2">
                    <span class="text-sm font-bold text-gray-700">テンプレート</span>
                    <button onclick="openDrawer('create')" class="bg-teal-600 text-white text-xs px-3 py-1.5 rounded-lg hover:bg-teal-700 font-bold">+ 新規</button>
                </div>
                <input type="text" id="cq-tpl-search" placeholder="検索..." oninput="renderTemplateList()" class="w-full border border-gray-300 rounded-lg px-3 py-1.5 text-sm mb-2">
                <div class="flex gap-1">
                    <button onclick="setLeftFilter('ALL')" class="cq-left-filter text-[10px] px-2 py-1 rounded-full border border-gray-300 cq-cat-active" data-filter="ALL">ALL</button>
                    <button onclick="setLeftFilter('MEAL')" class="cq-left-filter text-[10px] px-2 py-1 rounded-full border border-gray-300" data-filter="MEAL">MEAL</button>
                    <button onclick="setLeftFilter('WORKOUT')" class="cq-left-filter text-[10px] px-2 py-1 rounded-full border border-gray-300" data-filter="WORKOUT">WORKOUT</button>
                    <select id="cq-tpl-sort" onchange="renderTemplateList()" class="text-[10px] border border-gray-300 rounded px-1 py-0.5 ml-auto">
                        <option value="newest">新しい順</option><option value="oldest">古い順</option><option value="name-asc">名前順</option><option value="cal-desc">Cal高い順</option><option value="cal-asc">Cal低い順</option>
                    </select>
                </div>
            </div>
            <div class="flex-1 overflow-y-auto p-3" id="cq-template-list"><div class="text-center text-gray-400 text-sm py-8">読み込み中...</div></div>
        </div>

        <!-- Main Pane -->
        <div class="cq-main">
            <!-- Client Selection -->
            <div class="bg-white rounded-xl p-4 mb-4 shadow-sm border border-gray-200">
                <div class="flex flex-wrap items-center gap-3 mb-3">
                    <div class="flex-1 min-w-[200px]">
                        <div class="flex gap-2">
                            <select id="cq-client-dropdown" class="flex-1 border border-gray-300 rounded-lg px-3 py-2 text-sm">
                                <option value="">クライアントを選択...</option>
                            </select>
                            <button onclick="loadUserSlots()" class="bg-teal-600 text-white px-4 py-2 rounded-lg text-sm hover:bg-teal-700 font-bold">読み込み</button>
                        </div>
                    </div>
                    <div class="flex items-center gap-2">
                        <label class="flex items-center gap-1 text-sm cursor-pointer">
                            <input type="checkbox" id="cq-assign-persistent" checked class="rounded">
                            <span class="text-xs font-bold text-yellow-700 bg-yellow-100 px-2 py-0.5 rounded">永続</span>
                        </label>
                        <input type="date" id="cq-assign-date" class="border border-gray-300 rounded-lg px-2 py-1.5 text-sm">
                    </div>
                </div>
                <div id="cq-assign-user-info" class="mt-2 text-sm font-bold text-teal-700"></div>
            </div>

            <!-- Bento Grid -->
            <div id="cq-bento-container" class="hidden">
                <div class="bento-grid">
                    <!-- PFC Summary -->
                    <div class="bento-card bento-card-lg" id="bento-pfc">
                        <div class="flex items-center justify-between mb-3">
                            <h3 class="font-bold text-gray-800">PFC サマリー</h3>
                            <span class="text-xs text-gray-400" id="pfc-target-label">---</span>
                        </div>
                        <div id="pfc-bars-container"><div class="text-gray-400 text-sm text-center py-4">クライアントを読み込んでください</div></div>
                    </div>
                    <!-- Slot Timeline -->
                    <div class="bento-card bento-card-lg" id="bento-slots">
                        <div class="flex items-center justify-between mb-2">
                            <h3 class="font-bold text-gray-800">スロットタイムライン</h3>
                            <button onclick="assignAllSlots()" class="text-[10px] bg-green-600 text-white px-3 py-1 rounded hover:bg-green-700 font-bold">一括保存</button>
                        </div>
                        <div id="cq-slot-timeline" class="slot-timeline mb-3"></div>
                        <div id="cq-assign-slot-container"><div class="text-gray-400 text-sm text-center py-2">---</div></div>
                        <input type="hidden" id="cq-assign-slot" value="">
                        <div id="cq-bulk-assign-message" class="mt-1 text-sm"></div>
                        <div id="cq-assign-message" class="mt-1 text-sm"></div>
                    </div>
                    <!-- Profile (unified view + edit) -->
                    <div class="bento-card bento-card-md" id="bento-profile">
                        <div class="flex items-center justify-between mb-2">
                            <h3 class="font-bold text-gray-800 text-sm">プロフィール</h3>
                            <div class="flex items-center gap-1">
                                <button onclick="switchProfileMode('view')" id="prof-mode-view" class="prof-mode-btn text-[10px] px-2 py-1 rounded font-bold bg-teal-100 text-teal-700">表示</button>
                                <button onclick="switchProfileMode('schedule')" id="prof-mode-schedule" class="prof-mode-btn text-[10px] px-2 py-1 rounded font-bold text-gray-500 hover:bg-gray-100">時刻</button>
                                <button onclick="switchProfileMode('basic')" id="prof-mode-basic" class="prof-mode-btn text-[10px] px-2 py-1 rounded font-bold text-gray-500 hover:bg-gray-100">基本</button>
                                <button onclick="switchProfileMode('goal')" id="prof-mode-goal" class="prof-mode-btn text-[10px] px-2 py-1 rounded font-bold text-gray-500 hover:bg-gray-100">目標</button>
                                <button onclick="switchProfileMode('food')" id="prof-mode-food" class="prof-mode-btn text-[10px] px-2 py-1 rounded font-bold text-gray-500 hover:bg-gray-100">食材</button>
                            </div>
                        </div>
                        <!-- View mode -->
                        <div id="cq-profile-view" class="text-xs max-h-[400px] overflow-y-auto">
                            <div id="cq-user-profile-content"><span class="text-gray-400">データなし</span></div>
                        </div>
                        <!-- Edit modes -->
                        <div id="cq-profile-edit-container" class="hidden">
                            <div id="cq-profile-save-msg" class="hidden text-sm mb-2"></div>
                            <div id="cq-panel-schedule" class="cq-prof-panel hidden">
                                <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                                    <div><label class="block text-xs text-gray-500 mb-1">起床</label><input type="time" id="cq-prof-wake" value="07:00" class="w-full border border-gray-300 rounded px-2 py-1.5 text-sm" onchange="onMealsPerDayChange()"></div>
                                    <div><label class="block text-xs text-gray-500 mb-1">就寝</label><input type="time" id="cq-prof-sleep" value="23:00" class="w-full border border-gray-300 rounded px-2 py-1.5 text-sm" onchange="onMealsPerDayChange()"></div>
                                    <div><label class="block text-xs text-gray-500 mb-1">食事回数</label><input type="number" id="cq-prof-meals" value="5" min="2" max="8" class="w-full border border-gray-300 rounded px-2 py-1.5 text-sm" onchange="onMealsPerDayChange()"></div>
                                    <div><label class="block text-xs text-gray-500 mb-1">トレ後食事番号</label><input type="number" id="cq-prof-training-after" placeholder="例:3" min="1" max="8" class="w-full border border-gray-300 rounded px-2 py-1.5 text-sm" onchange="toggleTrainingFields();onMealsPerDayChange()"></div>
                                </div>
                                <div id="cq-training-fields" class="hidden mt-3 grid grid-cols-3 gap-3">
                                    <div><label class="block text-xs text-gray-500 mb-1">トレ開始</label><input type="time" id="cq-prof-training-time" value="17:00" class="w-full border border-gray-300 rounded px-2 py-1.5 text-sm" onchange="onMealsPerDayChange()"></div>
                                    <div><label class="block text-xs text-gray-500 mb-1">トレ時間(分)</label><input type="number" id="cq-prof-training-dur" value="120" class="w-full border border-gray-300 rounded px-2 py-1.5 text-sm"></div>
                                    <div><label class="block text-xs text-gray-500 mb-1">スタイル</label><select id="cq-prof-style" class="w-full border border-gray-300 rounded px-2 py-1.5 text-sm"><option value="POWER">パワー</option><option value="PUMP" selected>パンプ</option><option value="MIXED">ミックス</option></select></div>
                                </div>
                            </div>
                            <div id="cq-panel-basic" class="cq-prof-panel hidden">
                                <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                                    <div><label class="block text-xs text-gray-500 mb-1">ニックネーム</label><input type="text" id="cq-prof-nickname" class="w-full border border-gray-300 rounded px-2 py-1.5 text-sm"></div>
                                    <div><label class="block text-xs text-gray-500 mb-1">年齢</label><input type="number" id="cq-prof-age" class="w-full border border-gray-300 rounded px-2 py-1.5 text-sm"></div>
                                    <div><label class="block text-xs text-gray-500 mb-1">性別</label><select id="cq-prof-gender" class="w-full border border-gray-300 rounded px-2 py-1.5 text-sm"><option value="MALE">男性</option><option value="FEMALE">女性</option><option value="OTHER">その他</option></select></div>
                                    <div><label class="block text-xs text-gray-500 mb-1">身長cm</label><input type="number" id="cq-prof-height" step="0.1" class="w-full border border-gray-300 rounded px-2 py-1.5 text-sm"></div>
                                    <div><label class="block text-xs text-gray-500 mb-1">体重kg</label><input type="number" id="cq-prof-weight" step="0.1" class="w-full border border-gray-300 rounded px-2 py-1.5 text-sm"></div>
                                    <div><label class="block text-xs text-gray-500 mb-1">体脂肪%</label><input type="number" id="cq-prof-bodyfat" step="0.1" class="w-full border border-gray-300 rounded px-2 py-1.5 text-sm"></div>
                                    <div><label class="block text-xs text-gray-500 mb-1">理想体重</label><input type="number" id="cq-prof-ideal-weight" step="0.1" class="w-full border border-gray-300 rounded px-2 py-1.5 text-sm"></div>
                                    <div><label class="block text-xs text-gray-500 mb-1">理想体脂肪%</label><input type="number" id="cq-prof-ideal-bodyfat" step="0.1" class="w-full border border-gray-300 rounded px-2 py-1.5 text-sm"></div>
                                </div>
                            </div>
                            <div id="cq-panel-goal" class="cq-prof-panel hidden">
                                <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                                    <div><label class="block text-xs text-gray-500 mb-1">目標</label><select id="cq-prof-goal" class="w-full border border-gray-300 rounded px-2 py-1.5 text-sm"><option value="LOSE_WEIGHT">ダイエット</option><option value="MAINTAIN" selected>メンテナンス・リコンプ</option><option value="GAIN_MUSCLE">バルクアップ</option></select></div>
                                    <div><label class="block text-xs text-gray-500 mb-1">活動レベル</label><select id="cq-prof-activity" class="w-full border border-gray-300 rounded px-2 py-1.5 text-sm"><option value="DESK_WORK" selected>デスクワーク</option><option value="STANDING_WORK">立ち仕事</option><option value="PHYSICAL_LABOR">肉体労働</option></select></div>
                                    <div><label class="block text-xs text-gray-500 mb-1">Cal調整</label><input type="number" id="cq-prof-cal-adjust" value="0" class="w-full border border-gray-300 rounded px-2 py-1.5 text-sm"></div>
                                    <div><label class="block text-xs text-gray-500 mb-1">食費</label><select id="cq-prof-budget" class="w-full border border-gray-300 rounded px-2 py-1.5 text-sm"><option value="1">節約</option><option value="2" selected>標準</option><option value="3">ゆとり</option></select></div>
                                </div>
                                <div class="mt-3 grid grid-cols-3 gap-3">
                                    <div><label class="block text-xs text-gray-500 mb-1">P%</label><input type="number" id="cq-prof-prot-ratio" value="35" class="w-full border border-gray-300 rounded px-2 py-1.5 text-sm"></div>
                                    <div><label class="block text-xs text-gray-500 mb-1">F%</label><input type="number" id="cq-prof-fat-ratio" value="15" class="w-full border border-gray-300 rounded px-2 py-1.5 text-sm"></div>
                                    <div><label class="block text-xs text-gray-500 mb-1">C%</label><input type="number" id="cq-prof-carb-ratio" value="50" class="w-full border border-gray-300 rounded px-2 py-1.5 text-sm"></div>
                                </div>
                                <div class="mt-3"><div class="text-xs font-bold text-gray-600 mb-1">トレ前PFC(g)</div><div class="grid grid-cols-3 gap-3"><div><input type="number" id="cq-prof-pre-p" value="20" class="w-full border border-gray-300 rounded px-2 py-1.5 text-sm" placeholder="P"></div><div><input type="number" id="cq-prof-pre-f" value="1" class="w-full border border-gray-300 rounded px-2 py-1.5 text-sm" placeholder="F"></div><div><input type="number" id="cq-prof-pre-c" value="25" class="w-full border border-gray-300 rounded px-2 py-1.5 text-sm" placeholder="C"></div></div></div>
                                <div class="mt-2"><div class="text-xs font-bold text-gray-600 mb-1">トレ後PFC(g)</div><div class="grid grid-cols-3 gap-3"><div><input type="number" id="cq-prof-post-p" value="20" class="w-full border border-gray-300 rounded px-2 py-1.5 text-sm" placeholder="P"></div><div><input type="number" id="cq-prof-post-f" value="1" class="w-full border border-gray-300 rounded px-2 py-1.5 text-sm" placeholder="F"></div><div><input type="number" id="cq-prof-post-c" value="25" class="w-full border border-gray-300 rounded px-2 py-1.5 text-sm" placeholder="C"></div></div></div>
                            </div>
                            <div id="cq-panel-food" class="cq-prof-panel hidden">
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                                    <div><label class="block text-xs text-gray-500 mb-1">優先タンパク源</label><input type="text" id="cq-prof-prot-sources" placeholder="鶏むね肉, 鮭" class="w-full border border-gray-300 rounded px-2 py-1.5 text-sm"></div>
                                    <div><label class="block text-xs text-gray-500 mb-1">優先炭水化物源</label><input type="text" id="cq-prof-carb-sources" placeholder="白米, 玄米" class="w-full border border-gray-300 rounded px-2 py-1.5 text-sm"></div>
                                    <div><label class="block text-xs text-gray-500 mb-1">優先脂質源</label><input type="text" id="cq-prof-fat-sources" placeholder="オリーブオイル" class="w-full border border-gray-300 rounded px-2 py-1.5 text-sm"></div>
                                    <div><label class="block text-xs text-gray-500 mb-1">避けたい食材</label><input type="text" id="cq-prof-avoid-foods" class="w-full border border-gray-300 rounded px-2 py-1.5 text-sm"></div>
                                    <div><label class="block text-xs text-gray-500 mb-1">アレルギー</label><input type="text" id="cq-prof-allergies" class="w-full border border-gray-300 rounded px-2 py-1.5 text-sm"></div>
                                    <div><label class="block text-xs text-gray-500 mb-1">よく食べる食材</label><input type="text" id="cq-prof-fav-foods" class="w-full border border-gray-300 rounded px-2 py-1.5 text-sm"></div>
                                    <div><label class="block text-xs text-gray-500 mb-1">NG食材</label><input type="text" id="cq-prof-ng-foods" class="w-full border border-gray-300 rounded px-2 py-1.5 text-sm"></div>
                                </div>
                            </div>
                            <div class="flex gap-2 mt-3 pt-3 border-t border-gray-200">
                                <button onclick="resetAllProfileDefaults()" class="text-xs text-gray-500 hover:text-gray-700 px-3 py-1.5 border border-gray-300 rounded-lg">リセット</button>
                                <button onclick="saveUserProfile()" class="bg-green-600 text-white px-4 py-1.5 rounded-lg text-xs hover:bg-green-700 font-bold flex-1">保存</button>
                            </div>
                        </div>
                    </div>
                    <!-- Routine -->
                    <div class="bento-card bento-card-md">
                        <h3 class="font-bold text-gray-800 text-sm mb-2">ルーティン</h3>
                        <div id="cq-user-routine-content" class="text-xs max-h-[300px] overflow-y-auto"><span class="text-gray-400">データなし</span></div>
                    </div>
                    <!-- User Templates -->
                    <div class="bento-card bento-card-md">
                        <h3 class="font-bold text-gray-800 text-sm mb-2" id="cq-info-tab-templates">テンプレート</h3>
                        <div id="cq-user-templates-content" class="text-xs max-h-[300px] overflow-y-auto"><span class="text-gray-400">データなし</span></div>
                    </div>
                    <!-- Assignment History -->
                    <div class="bento-card bento-card-md">
                        <h3 class="font-bold text-gray-800 text-sm mb-2" id="cq-assign-list-title">割当履歴</h3>
                        <div id="cq-assign-list" class="text-xs max-h-[300px] overflow-y-auto"><span class="text-gray-400">データなし</span></div>
                    </div>
                </div>
            </div>

            <!-- Custom Items Panel (hidden by default) -->
            <div id="cq-user-panels" class="hidden mt-4 bg-white rounded-xl p-4 shadow-sm border border-gray-200">
                <h3 class="font-bold text-gray-800 text-sm mb-2" id="cq-info-tab-custom">カスタムアイテム</h3>
                <div id="cq-user-custom-items-content" class="text-xs max-h-[300px] overflow-y-auto"><span class="text-gray-400">データなし</span></div>
            </div>
        </div>
    </div>

    <!-- Drawer Overlay -->
    <div class="cq-drawer-overlay" id="cq-drawer-overlay" onclick="closeDrawer()"></div>
    <!-- Glassmorphism Drawer -->
    <div class="cq-drawer" id="cq-drawer">
        <div class="p-4 border-b border-gray-200 flex items-center justify-between">
            <h2 class="font-bold text-gray-800" id="cq-drawer-title">テンプレート作成</h2>
            <button onclick="closeDrawer()" class="text-gray-400 hover:text-gray-600 text-2xl leading-none">&times;</button>
        </div>
        <div class="flex-1 overflow-y-auto p-4">
            <div class="mb-3"><label class="block text-sm font-bold mb-1">テンプレート名</label><input type="text" id="cq-tpl-title" placeholder="例: 【減量】定番の朝食セット" class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm"></div>
            <div class="mb-3"><label class="block text-sm font-bold mb-1">タイプ</label><select id="cq-tpl-type" class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm" onchange="onTemplateTypeChange()"><option value="MEAL">MEAL</option><option value="WORKOUT">WORKOUT</option></select></div>
            <div class="flex flex-wrap gap-1 mb-3" id="cq-category-tabs"></div>
            <!-- Meal inputs -->
            <div id="cq-meal-inputs">
                <div class="flex gap-2 items-end mb-2">
                    <div class="flex-1"><label class="block text-xs text-gray-500 mb-1" id="cq-tpl-item-label">食品名</label><div class="relative"><input type="text" id="cq-tpl-food-search" placeholder="食品名で検索..." class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm" oninput="filterFoodList()" onfocus="showFoodDropdown()" autocomplete="off"><div id="cq-food-dropdown" class="absolute z-50 w-full bg-white border border-gray-300 rounded-lg mt-1 max-h-48 overflow-y-auto hidden shadow-lg"></div></div></div>
                    <div style="width:75px"><label class="block text-xs text-gray-500 mb-1">量</label><input type="number" id="cq-tpl-food-amount" placeholder="100" min="0" step="0.1" class="w-full border border-gray-300 rounded-lg px-2 py-2 text-sm"></div>
                    <div style="width:65px"><label class="block text-xs text-gray-500 mb-1">単位</label><select id="cq-tpl-food-unit" class="w-full border border-gray-300 rounded-lg px-1 py-2 text-sm"><option value="g">g</option><option value="個">個</option><option value="ml">ml</option><option value="杯">杯</option><option value="枚">枚</option><option value="本">本</option><option value="丁">丁</option><option value="粒">粒</option></select></div>
                    <button onclick="addTemplateItem()" class="bg-blue-500 text-white px-3 py-2 rounded-lg text-sm hover:bg-blue-600 font-bold">+</button>
                </div>
            </div>
            <!-- Workout inputs -->
            <div id="cq-workout-inputs" class="hidden">
                <div class="flex gap-2 items-end mb-2">
                    <div class="flex-1"><label class="block text-xs text-gray-500 mb-1">種目名</label><div class="relative"><input type="text" id="cq-tpl-exercise-search" placeholder="種目名で検索..." class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm" oninput="filterFoodList()" onfocus="showFoodDropdown()" autocomplete="off"><div id="cq-exercise-dropdown" class="absolute z-50 w-full bg-white border border-gray-300 rounded-lg mt-1 max-h-48 overflow-y-auto hidden shadow-lg"></div></div></div>
                    <button onclick="addTemplateItem()" class="bg-blue-500 text-white px-3 py-2 rounded-lg text-sm hover:bg-blue-600 font-bold">+</button>
                </div>
                <div id="cq-strength-fields" class="flex flex-wrap gap-2 mt-2">
                    <div style="width:75px"><label class="block text-xs text-gray-500 mb-1">セット</label><input type="number" id="cq-ex-sets" placeholder="3" class="w-full border border-gray-300 rounded px-2 py-1.5 text-sm"></div>
                    <div style="width:75px"><label class="block text-xs text-gray-500 mb-1">回数</label><input type="number" id="cq-ex-reps" placeholder="10" class="w-full border border-gray-300 rounded px-2 py-1.5 text-sm"></div>
                    <div style="width:75px"><label class="block text-xs text-gray-500 mb-1">重量kg</label><input type="number" id="cq-ex-weight" placeholder="60" step="0.5" class="w-full border border-gray-300 rounded px-2 py-1.5 text-sm"></div>
                    <div style="width:75px"><label class="block text-xs text-gray-500 mb-1">分</label><input type="number" id="cq-ex-duration-strength" placeholder="15" class="w-full border border-gray-300 rounded px-2 py-1.5 text-sm"></div>
                </div>
                <div id="cq-rm-fields" class="flex gap-2 mt-2">
                    <div style="width:85px"><label class="block text-xs text-gray-500 mb-1">1RM%下限</label><input type="number" id="cq-ex-rm-min" placeholder="70" max="100" step="5" class="w-full border border-orange-300 rounded px-2 py-1.5 text-sm"></div>
                    <div style="width:85px"><label class="block text-xs text-gray-500 mb-1">1RM%上限</label><input type="number" id="cq-ex-rm-max" placeholder="80" max="100" step="5" class="w-full border border-orange-300 rounded px-2 py-1.5 text-sm"></div>
                </div>
                <div id="cq-cardio-fields" class="hidden flex gap-2 mt-2">
                    <div style="width:75px"><label class="block text-xs text-gray-500 mb-1">分</label><input type="number" id="cq-ex-duration-cardio" placeholder="30" class="w-full border border-gray-300 rounded px-2 py-1.5 text-sm"></div>
                    <div style="width:85px"><label class="block text-xs text-gray-500 mb-1">距離km</label><input type="number" id="cq-ex-distance" placeholder="5" step="0.1" class="w-full border border-gray-300 rounded px-2 py-1.5 text-sm"></div>
                </div>
                <div id="cq-stretch-fields" class="hidden flex gap-2 mt-2">
                    <div style="width:75px"><label class="block text-xs text-gray-500 mb-1">分</label><input type="number" id="cq-ex-duration-stretch" placeholder="10" class="w-full border border-gray-300 rounded px-2 py-1.5 text-sm"></div>
                </div>
            </div>
            <div class="mt-3"><label class="block text-sm font-bold mb-1">追加済みアイテム</label><div id="cq-tpl-item-list" class="border border-dashed border-gray-300 rounded-lg p-3 min-h-[50px] text-sm text-gray-400">アイテムを追加してください</div></div>
            <div id="cq-tpl-message" class="mt-2 text-sm"></div>
        </div>
        <div class="p-4 border-t border-gray-200">
            <button onclick="handleDrawerSave()" id="cq-drawer-save-btn" class="w-full bg-teal-600 text-white py-2.5 rounded-lg font-bold hover:bg-teal-700 transition">テンプレートを保存</button>
        </div>
    </div>

    <!-- Usage Guide Modal -->
    <div id="cq-guide-overlay" class="fixed inset-0 bg-black/40 z-[60] hidden" onclick="toggleGuide()"></div>
    <div id="cq-guide-modal" class="fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-[720px] max-w-[90vw] max-h-[85vh] bg-white rounded-2xl shadow-2xl z-[61] hidden flex flex-col">
        <div class="flex items-center justify-between p-5 border-b border-gray-200">
            <h2 class="text-lg font-bold text-gray-800">トレーナーポータル — 使い方ガイド</h2>
            <button onclick="toggleGuide()" class="text-gray-400 hover:text-gray-600 text-2xl leading-none">&times;</button>
        </div>
        <div class="flex-1 overflow-y-auto p-5 text-sm text-gray-700 leading-relaxed space-y-6">
            <!-- Step 1 -->
            <section>
                <h3 class="font-bold text-base text-green-700 mb-2">Step 1: テンプレートを作成する</h3>
                <div class="bg-green-50 rounded-lg p-3 space-y-2">
                    <p>テンプレートは「食事メニュー」または「運動メニュー」の雛形です。1回分の献立や1セッション分のトレーニングを登録します。</p>
                    <ol class="list-decimal pl-5 space-y-1">
                        <li>左サイドバー上部の <span class="bg-teal-600 text-white text-xs px-2 py-0.5 rounded font-bold">+ 新規</span> をクリック</li>
                        <li>右側に編集パネルが開くので <strong>テンプレート名</strong> を入力（例: 【減量】朝食セット）</li>
                        <li><strong>タイプ</strong> を MEAL（食事） or WORKOUT（運動）から選択</li>
                        <li><strong>カテゴリタブ</strong> で食品/種目を絞り込み、検索欄で素早く見つける</li>
                        <li>アイテムを <span class="bg-blue-500 text-white text-xs px-2 py-0.5 rounded font-bold">+</span> で追加。追加後も量・単位・セット数等を直接編集可</li>
                        <li><span class="bg-teal-600 text-white text-xs px-2 py-0.5 rounded font-bold">テンプレートを保存</span> をクリック</li>
                    </ol>
                    <div class="text-xs text-gray-500 mt-1">作成したテンプレートは自社専用として保存されます。共通テンプレートも利用可能です。</div>
                </div>
            </section>

            <!-- Step 2 -->
            <section>
                <h3 class="font-bold text-base text-blue-700 mb-2">Step 2: クライアントを選択する</h3>
                <div class="bg-blue-50 rounded-lg p-3 space-y-2">
                    <ol class="list-decimal pl-5 space-y-1">
                        <li>中央エリア上部のドロップダウンから <strong>クライアント</strong> を選択</li>
                        <li><span class="bg-teal-600 text-white text-xs px-2 py-0.5 rounded font-bold">読み込み</span> をクリック</li>
                        <li>クライアントのプロフィール・ルーティン・PFCサマリー・スロットタイムラインが表示される</li>
                    </ol>
                    <div class="text-xs text-gray-500 mt-1">ドロップダウンには自社所属のクライアントのみ表示されます。</div>
                </div>
            </section>

            <!-- Step 3 -->
            <section>
                <h3 class="font-bold text-base text-orange-700 mb-2">Step 3: スロットにテンプレートを割り当てる</h3>
                <div class="bg-orange-50 rounded-lg p-3 space-y-2">
                    <p>スロット＝1日の食事・運動枠です。例: 5食+1トレーニング ＝ 6スロット。</p>
                    <ol class="list-decimal pl-5 space-y-1">
                        <li><strong>スロットタイムライン</strong> の各カードにあるドロップダウンからテンプレートを選択</li>
                        <li>テンプレート選択時、カロリーがスロット目標に自動スケーリングされる（食事のみ）</li>
                        <li>PFCサマリーがリアルタイムで更新 — 過不足をバーで確認</li>
                        <li>全スロット設定後、<span class="bg-green-600 text-white text-xs px-2 py-0.5 rounded font-bold">一括保存</span> で保存</li>
                    </ol>
                    <div class="mt-2 text-xs">
                        <div class="font-bold text-gray-600 mb-1">永続 / 日付指定の違い:</div>
                        <ul class="list-disc pl-5 space-y-0.5 text-gray-600">
                            <li><span class="bg-yellow-100 text-yellow-800 text-[10px] px-1.5 py-0.5 rounded font-bold">永続</span> — 毎日適用されるデフォルトプラン（_default として保存）</li>
                            <li><span class="text-[10px]">日付指定</span> — 特定日のみ上書き（その日だけの特別プラン）</li>
                        </ul>
                    </div>
                </div>
            </section>

            <!-- Step 4 -->
            <section>
                <h3 class="font-bold text-base text-red-700 mb-2">Step 4: PFCバーの見方</h3>
                <div class="bg-red-50 rounded-lg p-3 space-y-2">
                    <p>PFCサマリーの各バーは、クライアントの目標に対する割当量の割合を表示します。</p>
                    <div class="grid grid-cols-2 gap-2 text-xs mt-1">
                        <div class="flex items-center gap-2"><span class="inline-block w-4 h-4 rounded" style="background:#0d9488"></span> <strong>ティール (95-105%)</strong>: 目標達成</div>
                        <div class="flex items-center gap-2"><span class="inline-block w-4 h-4 rounded" style="background:#f97316"></span> <strong>オレンジ (&lt;95%)</strong>: やや不足</div>
                        <div class="flex items-center gap-2"><span class="inline-block w-4 h-4 rounded" style="background:#ef4444"></span> <strong>赤 (&lt;70%)</strong>: 大幅不足</div>
                        <div class="flex items-center gap-2"><span class="inline-block w-4 h-4 rounded" style="background:#8b5cf6"></span> <strong>紫 (&gt;105%)</strong>: 超過</div>
                    </div>
                </div>
            </section>

            <!-- Theory / Coaching Reference -->
            <section>
                <h3 class="font-bold text-base text-teal-700 mb-2">コーチング・セオリー</h3>
                <div class="space-y-3">
                    <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-3 text-xs">
                        <div class="font-bold text-yellow-800 mb-1">基本哲学</div>
                        <ul class="space-y-0.5 text-gray-700 list-disc pl-4">
                            <li><strong>食べなければ身体は作れない</strong> — トレーニングはきっかけ、身体を作るのは食事</li>
                            <li><strong>365日の継続</strong> — オン・オフを作らず淡々と続ける</li>
                            <li><strong>外食より自炊</strong> — 見えない脂質・調味料を排除</li>
                        </ul>
                    </div>
                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-3 text-xs">
                        <div class="font-bold text-blue-800 mb-1">PFC戦略 — P35% F15% C50%</div>
                        <div class="grid grid-cols-3 gap-2 mt-1">
                            <div class="text-center bg-red-50 rounded p-1.5"><div class="font-bold text-red-700">P = エンジン</div><div class="text-gray-600">筋肉の材料 / 最重要</div></div>
                            <div class="text-center bg-amber-50 rounded p-1.5"><div class="font-bold text-amber-700">C = ガソリン</div><div class="text-gray-600">筋肉を動かす / 抜くとハリ喪失</div></div>
                            <div class="text-center bg-gray-100 rounded p-1.5"><div class="font-bold text-gray-600">F = 最小限</div><div class="text-gray-500">9kcal/gで過剰注意 / 必須脂肪酸はサプリで</div></div>
                        </div>
                    </div>
                    <div class="bg-green-50 border border-green-200 rounded-lg p-3 text-xs">
                        <div class="font-bold text-green-800 mb-1">GIタイミング戦略</div>
                        <table class="w-full text-[11px]">
                            <thead><tr class="border-b border-green-300"><th class="text-left py-0.5">タイミング</th><th class="text-left py-0.5">GI</th><th class="text-left py-0.5">推奨食材</th><th class="text-left py-0.5">理由</th></tr></thead>
                            <tbody>
                                <tr class="border-b border-green-100"><td class="py-0.5"><span class="bg-red-100 text-red-700 px-1 rounded text-[10px] font-bold">トレ直後</span></td><td class="font-bold text-red-600">高GI</td><td>マルトデキストリン、白米（炊飯直後）、もち、バナナ</td><td>インスリン→筋肉へ急速デリバリー</td></tr>
                                <tr class="border-b border-green-100"><td class="py-0.5"><span class="bg-orange-100 text-orange-700 px-1 rounded text-[10px] font-bold">トレ前</span></td><td class="font-bold text-blue-600">低GI</td><td>白米（冷やご飯・再加熱）、オートミール、さつまいも + 低脂質</td><td>消化遅延防止＆持続エネルギー</td></tr>
                                <tr class="border-b border-green-100"><td class="py-0.5"><span class="bg-gray-200 text-gray-700 px-1 rounded text-[10px] font-bold">通常食</span></td><td class="font-bold text-blue-600">低GI</td><td>白米（冷やご飯・再加熱）、玄米、オートミール、そば</td><td>血糖安定＆体脂肪化防止</td></tr>
                                <tr><td class="py-0.5" colspan="4"><span class="text-[10px] text-gray-500">冷却でレジスタントスターチ生成（RS: 0.64→1.65g/100g）。再加熱してもRSは維持されGI低下（88→65）。炊飯直後はトレ直後専用</span></td></tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="bg-teal-50 border border-teal-200 rounded-lg p-3 text-xs">
                        <div class="font-bold text-teal-800 mb-1">ベースライン法（炭水化物量の調整）</div>
                        <ol class="space-y-0.5 text-gray-700 list-decimal pl-4">
                            <li>基準量（ベースライン）を決めて1週間食べる</li>
                            <li>体重増加 → 炭水化物を半分に減らす</li>
                            <li>体重減少しすぎ → 炭水化物を倍に増やす</li>
                            <li>微調整を繰り返し、体脂肪が増えないギリギリのラインを探す</li>
                        </ol>
                        <div class="mt-1 text-gray-500 italic">「減らしすぎない」— 代謝を落とさず筋肉のハリを保つ</div>
                    </div>
                </div>
            </section>

            <!-- Editing Templates -->
            <section>
                <h3 class="font-bold text-base text-indigo-700 mb-2">テンプレートの編集・複製・削除</h3>
                <div class="bg-indigo-50 rounded-lg p-3 space-y-1 text-xs">
                    <p>左サイドバーのテンプレートカードにカーソルを当てると、操作ボタンが表示されます。</p>
                    <ul class="list-disc pl-5 space-y-0.5">
                        <li><strong>編集</strong> — 右側に編集パネルが開き、名前・アイテムの変更が可能</li>
                        <li><strong>複製</strong> — 同じ内容で新しいテンプレートを作成</li>
                        <li><strong>削除</strong> — 自社テンプレートのみ削除可能（共通テンプレートは削除不可）</li>
                    </ul>
                </div>
            </section>

            <!-- Profile -->
            <section>
                <h3 class="font-bold text-base text-amber-700 mb-2">プロフィール編集</h3>
                <div class="bg-amber-50 rounded-lg p-3 space-y-1 text-xs">
                    <p>中央エリア「プロフィール」カード右上のタブで表示と編集を切り替えます。</p>
                    <ul class="list-disc pl-5 space-y-0.5">
                        <li><strong>表示</strong> — 現在のプロフィール情報を確認（読み取り専用）</li>
                        <li><strong>時刻</strong> — 起床/就寝/食事回数/トレーニング時間帯</li>
                        <li><strong>基本</strong> — 身長/体重/体脂肪率/理想体型</li>
                        <li><strong>目標</strong> — 減量/維持/増量 + PFC比率 + トレ前後PFC固定値</li>
                        <li><strong>食材</strong> — 優先食材/NG食材/アレルギー</li>
                    </ul>
                    <p class="mt-1">編集後は <span class="bg-green-600 text-white text-[10px] px-1.5 py-0.5 rounded font-bold">保存</span> を忘れずに。</p>
                </div>
            </section>

            <!-- Tips -->
            <section>
                <h3 class="font-bold text-base text-gray-700 mb-2">Tips</h3>
                <div class="bg-gray-50 rounded-lg p-3 text-xs space-y-1">
                    <ul class="list-disc pl-5 space-y-0.5 text-gray-600">
                        <li>ESCキーで編集パネルを閉じることができます</li>
                        <li>テンプレートの量変更時は追加済みアイテムの数値を直接クリックして編集できます</li>
                        <li>スロット割当を変更するたびにPFCバーがリアルタイムで更新されます</li>
                        <li>共通テンプレートと自社テンプレートはバッジで区別されます</li>
                    </ul>
                </div>
            </section>
        </div>
        <div class="p-4 border-t border-gray-200 text-center">
            <button onclick="toggleGuide()" class="bg-teal-600 text-white px-6 py-2 rounded-lg font-bold hover:bg-teal-700 transition">閉じる</button>
        </div>
    </div>

    <!-- MAIN SCRIPT (loaded after cq-databases.js) -->
    <script src="/js/trainer-functions.js"></script>
    <script>
        function toggleGuide() {
            const o = document.getElementById('cq-guide-overlay');
            const m = document.getElementById('cq-guide-modal');
            const open = o.classList.contains('hidden');
            o.classList.toggle('hidden', !open);
            m.classList.toggle('hidden', !open);
        }
    </script>
</body>
</html>
