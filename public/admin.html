<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç®¡ç†ç”»é¢ - Your Coach+ v2</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            background: #f5f7fa;
            color: #333;
        }

        .header {
            background: white;
            border-bottom: 1px solid #e0e0e0;
            padding: 16px 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .header h1 {
            font-size: 24px;
            color: #667eea;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .user-info {
            font-size: 14px;
            color: #666;
        }

        .btn-logout {
            padding: 8px 16px;
            background: #f5f5f5;
            border: 1px solid #ddd;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.2s;
        }

        .btn-logout:hover {
            background: #e0e0e0;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 24px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 32px;
        }

        .stat-card {
            background: white;
            padding: 24px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }

        .stat-card h3 {
            font-size: 14px;
            color: #666;
            margin-bottom: 8px;
        }

        .stat-card .value {
            font-size: 32px;
            font-weight: 700;
            color: #667eea;
        }

        .section {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            margin-bottom: 24px;
        }

        .section-header {
            padding: 20px 24px;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .section-header h2 {
            font-size: 20px;
        }

        .section-content {
            padding: 24px;
        }

        .org-list {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .org-card {
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            padding: 20px;
            transition: border-color 0.2s;
        }

        .org-card:hover {
            border-color: #667eea;
        }

        .org-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 16px;
        }

        .org-name {
            font-size: 18px;
            font-weight: 700;
            color: #333;
            margin-bottom: 4px;
        }

        .org-email {
            font-size: 14px;
            color: #666;
        }

        .org-status {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        .org-status.active {
            background: #d4edda;
            color: #155724;
        }

        .org-status.cancelled {
            background: #f8d7da;
            color: #721c24;
        }

        .org-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 16px;
        }

        .org-info-item {
            display: flex;
            flex-direction: column;
        }

        .org-info-label {
            font-size: 12px;
            color: #666;
            margin-bottom: 4px;
        }

        .org-info-value {
            font-size: 14px;
            font-weight: 600;
            color: #333;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e0e0e0;
            border-radius: 4px;
            overflow: hidden;
            margin-top: 8px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            transition: width 0.3s;
        }

        .code-display {
            background: #f5f5f5;
            padding: 12px 16px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 16px;
            font-weight: 700;
            color: #667eea;
            text-align: center;
            margin-top: 8px;
        }

        .btn-primary {
            padding: 10px 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
        }

        .btn-secondary {
            padding: 8px 16px;
            background: white;
            color: #667eea;
            border: 2px solid #667eea;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-secondary:hover {
            background: #667eea;
            color: white;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #999;
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 16px;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>ğŸ”§ Your Coach+ ç®¡ç†ç”»é¢</h1>
        <div class="header-right">
            <span class="user-info" id="user-info">èª­ã¿è¾¼ã¿ä¸­...</span>
            <button class="btn-logout" onclick="logout()">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
        </div>
    </div>

    <div class="container">
        <!-- ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ -->
        <div class="flex flex-wrap gap-2 mb-6">
            <button id="tab-affiliation" onclick="switchTab('affiliation')" class="px-6 py-3 rounded-lg font-bold transition bg-purple-600 text-white">
                ğŸ¢ æ‰€å±åç®¡ç†
            </button>
            <button id="tab-users" onclick="switchTab('users')" class="px-6 py-3 rounded-lg font-bold transition bg-gray-200 text-gray-700 hover:bg-gray-300">
                ğŸ‘¥ ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†
            </button>
            <button id="tab-comy" onclick="switchTab('comy')" class="px-6 py-3 rounded-lg font-bold transition bg-gray-200 text-gray-700 hover:bg-gray-300">
                ğŸ’¬ COMYæŠ•ç¨¿
            </button>
            <button id="tab-analytics" onclick="switchTab('analytics')" class="px-6 py-3 rounded-lg font-bold transition bg-gray-200 text-gray-700 hover:bg-gray-300">
                ğŸ“Š ä½¿ç”¨çŠ¶æ³åˆ†æ
            </button>
            <button id="tab-pgbase" onclick="switchTab('pgbase')" class="px-6 py-3 rounded-lg font-bold transition bg-gray-200 text-gray-700 hover:bg-gray-300">
                ğŸ“š PGBASEè¨˜äº‹
            </button>
            <button id="tab-gymhunter" onclick="switchTab('gymhunter')" class="px-6 py-3 rounded-lg font-bold transition bg-gray-200 text-gray-700 hover:bg-gray-300">
                ğŸ¯ å–¶æ¥­ãƒªã‚¹ãƒˆ
            </button>
            <button id="tab-customquest" onclick="switchTab('customquest')" class="px-6 py-3 rounded-lg font-bold transition bg-gray-200 text-gray-700 hover:bg-gray-300">
                â­ ã‚«ã‚¹ã‚¿ãƒ ã‚¯ã‚¨ã‚¹ãƒˆ
            </button>
        </div>

        <!-- æ‰€å±åç®¡ç†ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
        <div id="affiliation-section">
            <!-- çµ±è¨ˆæƒ…å ± -->
            <div class="stats-grid">
                <div class="stat-card">
                    <h3>æ³•äººå¥‘ç´„æ•°</h3>
                    <div class="value" id="total-contracts">-</div>
                </div>
                <div class="stat-card">
                    <h3>æ‰€å±åç™»éŒ²æ•°</h3>
                    <div class="value" id="total-affiliations">-</div>
                </div>
                <div class="stat-card">
                    <h3>æ‰€å±ååˆ©ç”¨ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°</h3>
                    <div class="value" id="affiliation-users">-</div>
                </div>
            </div>

            <!-- æ³•äººå¥‘ç´„ã‚’æ‰‹å‹•ä½œæˆ -->
            <div class="section mb-6">
                <div class="section-header">
                    <h2>ğŸ¢ æ³•äººå¥‘ç´„ã‚’ä½œæˆ</h2>
                </div>
                <div class="section-content">
                    <div class="grid md:grid-cols-2 gap-4 mb-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">ä¼æ¥­åï¼ˆæ‰€å±åï¼‰*</label>
                            <input type="text" id="contract-company-name"
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500"
                                placeholder="ä¾‹: æ ªå¼ä¼šç¤¾ABC">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹*</label>
                            <input type="email" id="contract-email"
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500"
                                placeholder="ä¾‹: info@example.com">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">ãƒ—ãƒ©ãƒ³*</label>
                            <select id="contract-plan"
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500">
                                <option value="standard">ã‚¹ã‚¿ãƒ³ãƒ€ãƒ¼ãƒ‰ï¼ˆ10åï¼‰</option>
                                <option value="pro">ãƒ—ãƒ­ï¼ˆ30åï¼‰</option>
                                <option value="elite">ã‚¨ãƒªãƒ¼ãƒˆï¼ˆ100åï¼‰</option>
                                <option value="custom">ã‚«ã‚¹ã‚¿ãƒ </option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">ãƒ©ã‚¤ã‚»ãƒ³ã‚¹æ•°</label>
                            <input type="number" id="contract-licenses"
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500"
                                placeholder="ã‚«ã‚¹ã‚¿ãƒ ã®å ´åˆã®ã¿å…¥åŠ›" min="1">
                        </div>
                    </div>
                    <div class="flex items-center gap-4 mb-4">
                        <label class="flex items-center gap-2">
                            <input type="checkbox" id="contract-send-email" checked class="w-4 h-4">
                            <span class="text-sm text-gray-700">ç¢ºèªãƒ¡ãƒ¼ãƒ«ã‚’é€ä¿¡ã™ã‚‹</span>
                        </label>
                    </div>
                    <button onclick="createContract()" id="create-contract-btn" class="btn-primary">
                        âœ¨ å¥‘ç´„ã‚’ä½œæˆ
                    </button>
                </div>
            </div>

            <!-- æ³•äººå¥‘ç´„ä¸€è¦§ -->
            <div class="section mb-6">
                <div class="section-header">
                    <h2>ğŸ“‹ æ³•äººå¥‘ç´„ä¸€è¦§</h2>
                    <button onclick="loadContracts()" class="btn-secondary">ğŸ”„ æ›´æ–°</button>
                </div>
                <div class="section-content">
                    <div id="contracts-loading" class="loading">ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™...</div>
                    <div id="contracts-list" style="display:none;"></div>
                    <div id="contracts-empty" class="empty-state" style="display:none;">
                        <div class="empty-state-icon">ğŸ“­</div>
                        <p>æ³•äººå¥‘ç´„ã¯ã‚ã‚Šã¾ã›ã‚“</p>
                    </div>
                </div>
            </div>

            <!-- ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«æ‰€å±åã‚’è¨­å®š -->
            <div class="section mb-6">
                <div class="section-header">
                    <h2>â• ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«æ‰€å±åã‚’è¨­å®š</h2>
                </div>
                <div class="section-content">
                    <div class="grid md:grid-cols-2 gap-4 mb-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">ãƒ¦ãƒ¼ã‚¶ãƒ¼ID ã¾ãŸã¯ ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹</label>
                            <input type="text" id="affiliation-user-id"
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500"
                                placeholder="ä¾‹: user123 ã¾ãŸã¯ user@example.com">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">æ‰€å±å</label>
                            <input type="text" id="affiliation-org-name"
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500"
                                placeholder="ä¾‹: æ ªå¼ä¼šç¤¾ABC">
                        </div>
                    </div>
                    <button onclick="setUserAffiliation()" id="set-affiliation-btn" class="btn-primary">
                        âœ¨ æ‰€å±åã‚’è¨­å®š
                    </button>
                </div>
            </div>

            <!-- æ‰€å±ååˆ¥ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§ -->
            <div class="section">
                <div class="section-header">
                    <h2>ğŸ“‹ æ‰€å±ååˆ¥ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§</h2>
                    <button onclick="loadAffiliations()" class="btn-secondary">ğŸ”„ æ›´æ–°</button>
                </div>
                <div class="section-content">
                    <div id="affiliation-loading" class="loading">ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™...</div>
                    <div id="affiliation-list" class="space-y-4" style="display:none;"></div>
                    <div id="affiliation-empty" class="empty-state" style="display:none;">
                        <div class="empty-state-icon">ğŸ“­</div>
                        <p>æ‰€å±åãŒè¨­å®šã•ã‚ŒãŸãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ã„ã¾ã›ã‚“</p>
                    </div>
                </div>
            </div>
        </div><!-- æ‰€å±åç®¡ç†ã‚»ã‚¯ã‚·ãƒ§ãƒ³çµ‚äº† -->

        <!-- ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
        <div id="users-section" style="display:none;">
            <!-- çµ±è¨ˆ -->
            <div class="stats-grid">
                <div class="stat-card">
                    <h3>ç·ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°</h3>
                    <div class="value" id="total-users">-</div>
                </div>
                <div class="stat-card">
                    <h3>Premiumä¼šå“¡</h3>
                    <div class="value" id="premium-users">-</div>
                </div>
                <div class="stat-card">
                    <h3>æ‰€å±ååˆ©ç”¨</h3>
                    <div class="value" id="org-users">-</div>
                </div>
                <div class="stat-card">
                    <h3>Google Playèª²é‡‘</h3>
                    <div class="value" id="billing-users">-</div>
                </div>
            </div>

            <!-- ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ -->
            <div class="section mb-6">
                <div class="section-content">
                    <div class="flex flex-wrap gap-3 items-center">
                        <label class="flex items-center gap-2">
                            <span class="text-sm font-medium">è¡¨ç¤º:</span>
                            <select id="user-filter" onchange="loadUsers()" class="px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500">
                                <option value="all">å…¨ãƒ¦ãƒ¼ã‚¶ãƒ¼</option>
                                <option value="premium">Premiumä¼šå“¡ã®ã¿</option>
                                <option value="affiliation">æ‰€å±ååˆ©ç”¨è€…</option>
                                <option value="billing">Google Playèª²é‡‘è€…</option>
                            </select>
                        </label>
                        <button onclick="loadUsers()" class="btn-secondary">ğŸ”„ æ›´æ–°</button>
                    </div>
                </div>
            </div>

            <!-- ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§ -->
            <div class="section">
                <div class="section-header">
                    <h2>ğŸ“‹ ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§</h2>
                    <span id="user-count" class="text-sm text-gray-500"></span>
                </div>
                <div class="section-content">
                    <div id="users-loading" class="loading">ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™...</div>
                    <div id="users-list" style="display:none;">
                        <div class="overflow-x-auto">
                            <table class="min-w-full text-sm">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-4 py-3 text-left font-medium text-gray-600">ãƒ¦ãƒ¼ã‚¶ãƒ¼</th>
                                        <th class="px-4 py-3 text-left font-medium text-gray-600">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</th>
                                        <th class="px-4 py-3 text-left font-medium text-gray-600">ç™»éŒ²æ—¥</th>
                                        <th class="px-4 py-3 text-left font-medium text-gray-600">æœ€çµ‚ãƒ­ã‚°ã‚¤ãƒ³</th>
                                        <th class="px-4 py-3 text-left font-medium text-gray-600">ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆ</th>
                                        <th class="px-4 py-3 text-left font-medium text-gray-600">è©³ç´°</th>
                                    </tr>
                                </thead>
                                <tbody id="users-tbody" class="divide-y divide-gray-200"></tbody>
                            </table>
                        </div>
                    </div>
                    <div id="users-empty" class="empty-state" style="display:none;">
                        <div class="empty-state-icon">ğŸ‘¤</div>
                        <p>è©²å½“ã™ã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã„ã¾ã›ã‚“</p>
                    </div>
                </div>
            </div>
        </div><!-- ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†ã‚»ã‚¯ã‚·ãƒ§ãƒ³çµ‚äº† -->


        <!-- COMYã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
        <div id="comy-section" style="display:none;">
            <!-- çµ±è¨ˆ -->
            <div class="stats-grid">
                <div class="stat-card">
                    <h3>ç·æŠ•ç¨¿æ•°</h3>
                    <div class="value" id="total-posts">-</div>
                </div>
                <div class="stat-card">
                    <h3>æ‰¿èªå¾…ã¡</h3>
                    <div class="value text-yellow-600" id="pending-posts">-</div>
                </div>
                <div class="stat-card">
                    <h3>æ‰¿èªæ¸ˆã¿</h3>
                    <div class="value text-green-600" id="approved-posts">-</div>
                </div>
                <div class="stat-card">
                    <h3>å´ä¸‹æ¸ˆã¿</h3>
                    <div class="value text-red-600" id="rejected-posts">-</div>
                </div>
            </div>

            <!-- ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ -->
            <div class="section mb-6">
                <div class="section-content">
                    <div class="flex flex-wrap gap-3 items-center">
                        <label class="flex items-center gap-2">
                            <span class="text-sm font-medium">è¡¨ç¤º:</span>
                            <select id="comy-filter" onchange="loadCommunityPosts()" class="px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500">
                                <option value="all">ã™ã¹ã¦</option>
                                <option value="pending">æ‰¿èªå¾…ã¡ã®ã¿</option>
                                <option value="approved">æ‰¿èªæ¸ˆã¿ã®ã¿</option>
                                <option value="rejected">å´ä¸‹æ¸ˆã¿ã®ã¿</option>
                            </select>
                        </label>
                        <button onclick="loadCommunityPosts()" class="btn-secondary">ğŸ”„ æ›´æ–°</button>
                    </div>
                </div>
            </div>

            <!-- æŠ•ç¨¿ä¸€è¦§ -->
            <div class="section">
                <div class="section-header">
                    <h2>ğŸ’¬ COMYæŠ•ç¨¿ä¸€è¦§</h2>
                    <span id="comy-count" class="text-sm text-gray-500"></span>
                </div>
                <div class="section-content">
                    <div id="comy-loading" class="loading">æŠ•ç¨¿ã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™...</div>
                    <div id="comy-list" class="space-y-4" style="display:none;"></div>
                    <div id="comy-empty" class="empty-state" style="display:none;">
                        <div class="empty-state-icon">ğŸ’¬</div>
                        <p>è©²å½“ã™ã‚‹æŠ•ç¨¿ãŒã‚ã‚Šã¾ã›ã‚“</p>
                    </div>
                </div>
            </div>
        </div><!-- COMYã‚»ã‚¯ã‚·ãƒ§ãƒ³çµ‚äº† -->

        <!-- ä½¿ç”¨çŠ¶æ³åˆ†æã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
        <div id="analytics-section" style="display:none;">
            <!-- æœŸé–“ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ -->
            <div class="section mb-6">
                <div class="section-content">
                    <div class="flex flex-wrap gap-3 items-center">
                        <label class="flex items-center gap-2">
                            <span class="text-sm font-medium">æœŸé–“:</span>
                            <select id="analytics-period" onchange="loadAnalytics()" class="px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500">
                                <option value="7">éå»7æ—¥</option>
                                <option value="30" selected>éå»30æ—¥</option>
                                <option value="90">éå»90æ—¥</option>
                                <option value="365">éå»1å¹´</option>
                            </select>
                        </label>
                        <button onclick="loadAnalytics()" class="btn-secondary">ğŸ”„ æ›´æ–°</button>
                    </div>
                </div>
            </div>

            <!-- çµ±è¨ˆã‚µãƒãƒªãƒ¼ -->
            <div class="stats-grid">
                <div class="stat-card">
                    <h3>ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒ¦ãƒ¼ã‚¶ãƒ¼</h3>
                    <div class="value" id="analytics-users">-</div>
                </div>
                <div class="stat-card">
                    <h3>ç·ã‚¤ãƒ™ãƒ³ãƒˆæ•°</h3>
                    <div class="value" id="analytics-events">-</div>
                </div>
                <div class="stat-card">
                    <h3>ä½¿ç”¨æ©Ÿèƒ½æ•°</h3>
                    <div class="value" id="analytics-features-used">-</div>
                </div>
                <div class="stat-card">
                    <h3>æœªä½¿ç”¨æ©Ÿèƒ½æ•°</h3>
                    <div class="value text-red-600" id="analytics-features-unused">-</div>
                </div>
            </div>

            <!-- ã‚«ãƒ†ã‚´ãƒªåˆ¥ä½¿ç”¨ç‡ -->
            <div class="section mb-6">
                <div class="section-header">
                    <h2>ğŸ“Š ã‚«ãƒ†ã‚´ãƒªåˆ¥ä½¿ç”¨ç‡</h2>
                </div>
                <div class="section-content">
                    <div id="analytics-categories" class="grid grid-cols-2 md:grid-cols-4 gap-4"></div>
                </div>
            </div>

            <!-- æ©Ÿèƒ½ãƒ©ãƒ³ã‚­ãƒ³ã‚° -->
            <div class="grid md:grid-cols-2 gap-6 mb-6">
                <!-- äººæ°—æ©Ÿèƒ½TOP10 -->
                <div class="section">
                    <div class="section-header">
                        <h2>ğŸ”¥ äººæ°—æ©Ÿèƒ½TOP10</h2>
                    </div>
                    <div class="section-content">
                        <div id="analytics-top-features" class="space-y-2"></div>
                    </div>
                </div>

                <!-- æœªä½¿ç”¨æ©Ÿèƒ½ -->
                <div class="section">
                    <div class="section-header">
                        <h2>âš ï¸ æœªä½¿ç”¨æ©Ÿèƒ½</h2>
                    </div>
                    <div class="section-content">
                        <div id="analytics-unused-features" class="space-y-2"></div>
                    </div>
                </div>
            </div>

            <!-- æ—¥åˆ¥æ¨ç§» -->
            <div class="section mb-6">
                <div class="section-header">
                    <h2>ğŸ“ˆ æ—¥åˆ¥ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£</h2>
                </div>
                <div class="section-content">
                    <div id="analytics-daily" class="overflow-x-auto">
                        <div class="flex gap-1 min-w-max" id="analytics-daily-chart"></div>
                    </div>
                </div>
            </div>

            <!-- ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§ -->
            <div class="section">
                <div class="section-header">
                    <h2>ğŸ‘¥ ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ©ãƒ³ã‚­ãƒ³ã‚°</h2>
                    <span id="analytics-user-count" class="text-sm text-gray-500"></span>
                </div>
                <div class="section-content">
                    <div id="analytics-loading" class="loading">ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™...</div>
                    <div id="analytics-users-list" style="display:none;">
                        <div class="overflow-x-auto">
                            <table class="min-w-full text-sm">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-4 py-3 text-left font-medium text-gray-600">é †ä½</th>
                                        <th class="px-4 py-3 text-left font-medium text-gray-600">ãƒ¦ãƒ¼ã‚¶ãƒ¼</th>
                                        <th class="px-4 py-3 text-left font-medium text-gray-600">ã‚¤ãƒ™ãƒ³ãƒˆæ•°</th>
                                        <th class="px-4 py-3 text-left font-medium text-gray-600">ä½¿ç”¨æ©Ÿèƒ½æ•°</th>
                                        <th class="px-4 py-3 text-left font-medium text-gray-600">è©³ç´°</th>
                                    </tr>
                                </thead>
                                <tbody id="analytics-users-tbody" class="divide-y divide-gray-200"></tbody>
                            </table>
                        </div>
                    </div>
                    <div id="analytics-empty" class="empty-state" style="display:none;">
                        <div class="empty-state-icon">ğŸ“Š</div>
                        <p>ã¾ã åˆ†æãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</p>
                    </div>
                </div>
            </div>
        </div><!-- ä½¿ç”¨çŠ¶æ³åˆ†æã‚»ã‚¯ã‚·ãƒ§ãƒ³çµ‚äº† -->

        <!-- PGBASEè¨˜äº‹ç®¡ç†ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
        <div id="pgbase-section" style="display:none;">
            <!-- ã‚·ãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿æŠ•å…¥ -->
            <div class="section mb-6">
                <div class="section-header">
                    <h2>ğŸ“¥ ã‚·ãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿ä¸€æ‹¬æŠ•å…¥</h2>
                </div>
                <div class="section-content">
                    <p class="text-sm text-gray-600 mb-4">JSONãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ‰ãƒ­ãƒƒãƒ—ã€ã¾ãŸã¯è²¼ã‚Šä»˜ã‘ã¦è¨˜äº‹ãƒ‡ãƒ¼ã‚¿ã‚’æŠ•å…¥ã—ã¾ã™ã€‚</p>

                    <!-- ãƒ‰ãƒ­ãƒƒãƒ—ã‚¾ãƒ¼ãƒ³ -->
                    <div id="pgbase-dropzone"
                        class="border-4 border-dashed border-gray-300 rounded-xl p-8 text-center mb-4 transition-all cursor-pointer hover:border-purple-400 hover:bg-purple-50"
                        ondrop="handleFileDrop(event)"
                        ondragover="handleDragOver(event)"
                        ondragleave="handleDragLeave(event)"
                        onclick="document.getElementById('pgbase-file-input').click()">
                        <div class="text-4xl mb-2">ğŸ“</div>
                        <p class="text-lg font-medium text-gray-700">JSONãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã“ã“ã«ãƒ‰ãƒ­ãƒƒãƒ—</p>
                        <p class="text-sm text-gray-500 mt-1">ã¾ãŸã¯ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ</p>
                        <input type="file" id="pgbase-file-input" accept=".json" style="display:none" onchange="handleFileSelect(event)">
                    </div>

                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-1">JSONãƒ‡ãƒ¼ã‚¿ï¼ˆç›´æ¥ç·¨é›†ã‚‚å¯ï¼‰</label>
                        <textarea id="pgbase-json-input" rows="6"
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 font-mono text-sm"
                            placeholder='{"articles": [{"id": "protein_001", "title": "...", ...}]}'></textarea>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="seedPgBaseArticles()" class="btn-primary">
                            ğŸš€ ä¸€æ‹¬æŠ•å…¥
                        </button>
                        <button onclick="clearPgBaseInput()" class="btn-secondary">
                            ğŸ—‘ï¸ ã‚¯ãƒªã‚¢
                        </button>
                    </div>
                    <div id="pgbase-seed-result" class="mt-4"></div>
                </div>
            </div>

            <!-- è¨˜äº‹ä¸€è¦§ -->
            <div class="section">
                <div class="section-header">
                    <h2>ğŸ“š PGBASEè¨˜äº‹ä¸€è¦§</h2>
                    <button onclick="loadPgBaseArticles()" class="btn-secondary">ğŸ”„ æ›´æ–°</button>
                </div>
                <div class="section-content">
                    <div id="pgbase-loading" class="loading">è¨˜äº‹ã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™...</div>
                    <div id="pgbase-stats" class="grid grid-cols-4 gap-4 mb-6" style="display:none;">
                        <div class="bg-blue-50 p-4 rounded-lg text-center">
                            <div class="text-2xl font-bold text-blue-600" id="pgbase-total">0</div>
                            <div class="text-sm text-gray-600">ç·è¨˜äº‹æ•°</div>
                        </div>
                        <div class="bg-green-50 p-4 rounded-lg text-center">
                            <div class="text-2xl font-bold text-green-600" id="pgbase-free">0</div>
                            <div class="text-sm text-gray-600">ç„¡æ–™è¨˜äº‹</div>
                        </div>
                        <div class="bg-yellow-50 p-4 rounded-lg text-center">
                            <div class="text-2xl font-bold text-yellow-600" id="pgbase-premium">0</div>
                            <div class="text-sm text-gray-600">ãƒ—ãƒ¬ãƒŸã‚¢ãƒ </div>
                        </div>
                        <div class="bg-purple-50 p-4 rounded-lg text-center">
                            <div class="text-2xl font-bold text-purple-600" id="pgbase-categories">0</div>
                            <div class="text-sm text-gray-600">ã‚«ãƒ†ã‚´ãƒªæ•°</div>
                        </div>
                    </div>
                    <div id="pgbase-list" class="space-y-4" style="display:none;"></div>
                    <div id="pgbase-empty" class="empty-state" style="display:none;">
                        <div class="empty-state-icon">ğŸ“­</div>
                        <p>ã¾ã è¨˜äº‹ãŒã‚ã‚Šã¾ã›ã‚“</p>
                        <p class="text-sm text-gray-500 mt-2">ä¸Šã®ãƒ•ã‚©ãƒ¼ãƒ ã‹ã‚‰ã‚·ãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿ã‚’æŠ•å…¥ã—ã¦ãã ã•ã„</p>
                    </div>
                </div>
            </div>
        </div><!-- PGBASEè¨˜äº‹ç®¡ç†ã‚»ã‚¯ã‚·ãƒ§ãƒ³çµ‚äº† -->

        <!-- å–¶æ¥­ãƒªã‚¹ãƒˆï¼ˆGym Hunterï¼‰ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
        <div id="gymhunter-section" style="display:none;">
            <div class="section mb-6">
                <div class="section-header">
                    <h2>ğŸ“¤ Excelãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ‰ãƒ­ãƒƒãƒ—</h2>
                </div>
                <div class="section-content">
                    <div id="drop-zone" style="border: 3px dashed #ccc; border-radius: 12px; padding: 60px; text-align: center; cursor: pointer; transition: all 0.3s;">
                        <div style="font-size: 48px; margin-bottom: 16px;">ğŸ“</div>
                        <p style="font-size: 18px; color: #666;">Gym Hunterã§ç”Ÿæˆã—ãŸ<br><strong>.xlsx ãƒ•ã‚¡ã‚¤ãƒ«</strong>ã‚’ã“ã“ã«ãƒ‰ãƒ­ãƒƒãƒ—</p>
                        <p style="font-size: 14px; color: #999; margin-top: 8px;">ã¾ãŸã¯ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠ</p>
                        <input type="file" id="file-input" accept=".xlsx,.xls" style="display: none;">
                    </div>
                </div>
            </div>

            <!-- ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ -->
            <div class="section mb-6" id="filter-section" style="display:none;">
                <div class="section-content">
                    <div class="flex flex-wrap gap-2">
                        <button onclick="filterByRank('all')" class="filter-btn px-4 py-2 rounded-lg bg-gray-800 text-white">å…¨ã¦</button>
                        <button onclick="filterByRank('S')" class="filter-btn px-4 py-2 rounded-lg bg-green-500 text-white">ğŸ”¥ S ãƒ©ãƒ³ã‚¯</button>
                        <button onclick="filterByRank('A')" class="filter-btn px-4 py-2 rounded-lg bg-blue-500 text-white">â­ A ãƒ©ãƒ³ã‚¯</button>
                        <button onclick="filterByRank('B')" class="filter-btn px-4 py-2 rounded-lg bg-gray-400 text-white">ğŸ“‹ B ãƒ©ãƒ³ã‚¯</button>
                        <button onclick="filterByRank('C')" class="filter-btn px-4 py-2 rounded-lg bg-red-400 text-white">âŒ C ãƒ©ãƒ³ã‚¯</button>
                        <span id="gym-count" class="ml-4 py-2 text-gray-600"></span>
                    </div>
                </div>
            </div>

            <!-- ãƒªã‚¹ãƒˆè¡¨ç¤º -->
            <div class="section" id="list-section" style="display:none;">
                <div class="section-header">
                    <h2>ğŸ“‹ å–¶æ¥­ãƒªã‚¹ãƒˆ</h2>
                </div>
                <div class="section-content" style="overflow-x: auto;">
                    <table id="gym-table" class="min-w-full text-sm">
                        <thead>
                            <tr class="bg-gray-100">
                                <th class="px-4 py-3 text-left">ãƒ©ãƒ³ã‚¯</th>
                                <th class="px-4 py-3 text-left">çŠ¶æ…‹</th>
                                <th class="px-4 py-3 text-left">åº—å</th>
                                <th class="px-4 py-3 text-left">é›»è©±</th>
                                <th class="px-4 py-3 text-left">åˆ¤å®šç†ç”±</th>
                                <th class="px-4 py-3 text-left">è©•ä¾¡</th>
                                <th class="px-4 py-3 text-left">HP</th>
                            </tr>
                        </thead>
                        <tbody id="gym-tbody"></tbody>
                    </table>
                </div>
            </div>
        </div><!-- å–¶æ¥­ãƒªã‚¹ãƒˆã‚»ã‚¯ã‚·ãƒ§ãƒ³çµ‚äº† -->

        <!-- ã‚«ã‚¹ã‚¿ãƒ ã‚¯ã‚¨ã‚¹ãƒˆç®¡ç†ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
        <div id="customquest-section" style="display:none;">
            <!-- çµ±è¨ˆ -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                <div class="stat-card">
                    <div class="stat-label">ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆæ•°</div>
                    <div class="stat-value" id="cq-template-count">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">å‰²å½“æ¸ˆã¿ãƒ¦ãƒ¼ã‚¶ãƒ¼</div>
                    <div class="stat-value" id="cq-assigned-count">0</div>
                </div>
            </div>

            <!-- ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆä½œæˆ -->
            <div class="section mb-6">
                <div class="section-header">
                    <h2>ğŸ“ ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆä½œæˆ</h2>
                </div>
                <div class="section-body">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-bold mb-1">ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆå</label>
                            <input type="text" id="cq-tpl-title" placeholder="ä¾‹: ã€æ¸›é‡ã€‘å®šç•ªã®æœé£Ÿã‚»ãƒƒãƒˆ" class="w-full border-2 border-gray-300 rounded-lg px-3 py-2">
                        </div>
                        <div>
                            <label class="block text-sm font-bold mb-1">ã‚¿ã‚¤ãƒ—</label>
                            <select id="cq-tpl-type" class="w-full border-2 border-gray-300 rounded-lg px-3 py-2" onchange="onTemplateTypeChange()">
                                <option value="MEAL">ğŸ½ é£Ÿäº‹</option>
                                <option value="WORKOUT">ğŸ‹ï¸ é‹å‹•</option>
                            </select>
                        </div>
                    </div>
                    <!-- ã‚¢ã‚¤ãƒ†ãƒ è¿½åŠ UI -->
                    <div class="mt-4">
                        <label class="block text-sm font-bold mb-2">ã‚¢ã‚¤ãƒ†ãƒ è¿½åŠ </label>
                        <!-- ã‚«ãƒ†ã‚´ãƒªãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ -->
                        <div class="flex flex-wrap gap-1 mb-2" id="cq-category-tabs">
                            <button onclick="setFoodCategory('all')" class="cq-cat-btn cq-cat-active" data-cat="all">ã™ã¹ã¦</button>
                            <button onclick="setFoodCategory('è‚‰é¡')" class="cq-cat-btn" data-cat="è‚‰é¡">ğŸ¥© è‚‰é¡</button>
                            <button onclick="setFoodCategory('é­šä»‹é¡')" class="cq-cat-btn" data-cat="é­šä»‹é¡">ğŸŸ é­šä»‹é¡</button>
                            <button onclick="setFoodCategory('åµé¡')" class="cq-cat-btn" data-cat="åµé¡">ğŸ¥š åµé¡</button>
                            <button onclick="setFoodCategory('ä¸»é£Ÿ')" class="cq-cat-btn" data-cat="ä¸»é£Ÿ">ğŸš ä¸»é£Ÿ</button>
                            <button onclick="setFoodCategory('é‡èœé¡')" class="cq-cat-btn" data-cat="é‡èœé¡">ğŸ¥¦ é‡èœé¡</button>
                            <button onclick="setFoodCategory('ä¹³è£½å“')" class="cq-cat-btn" data-cat="ä¹³è£½å“">ğŸ§€ ä¹³è£½å“</button>
                            <button onclick="setFoodCategory('è±†é¡ãƒ»ãƒŠãƒƒãƒ„')" class="cq-cat-btn" data-cat="è±†é¡ãƒ»ãƒŠãƒƒãƒ„">ğŸ¥œ è±†é¡</button>
                            <button onclick="setFoodCategory('æœç‰©é¡')" class="cq-cat-btn" data-cat="æœç‰©é¡">ğŸ æœç‰©</button>
                            <button onclick="setFoodCategory('ã‚µãƒ—ãƒªãƒ¡ãƒ³ãƒˆ')" class="cq-cat-btn" data-cat="ã‚µãƒ—ãƒªãƒ¡ãƒ³ãƒˆ">ğŸ’Š ã‚µãƒ—ãƒª</button>
                            <button onclick="setFoodCategory('ãƒ‰ãƒªãƒ³ã‚¯')" class="cq-cat-btn" data-cat="ãƒ‰ãƒªãƒ³ã‚¯">ğŸ¥¤ ãƒ‰ãƒªãƒ³ã‚¯</button>
                            <button onclick="setFoodCategory('èª¿å‘³æ–™')" class="cq-cat-btn" data-cat="èª¿å‘³æ–™">ğŸ§‚ èª¿å‘³æ–™</button>
                            <button onclick="setFoodCategory('å’Œè“å­')" class="cq-cat-btn" data-cat="å’Œè“å­">ğŸ¡ å’Œè“å­</button>
                        </div>
                        <style>
                            .cq-cat-btn { font-size: 11px; padding: 3px 8px; border: 1px solid #d1d5db; border-radius: 9999px; background: white; cursor: pointer; transition: all 0.15s; }
                            .cq-cat-btn:hover { background: #fef9c3; border-color: #facc15; }
                            .cq-cat-active { background: #fef08a !important; border-color: #eab308 !important; font-weight: 600; }
                        </style>
                        <div class="flex gap-2 items-end">
                            <div class="flex-1">
                                <label class="block text-xs text-gray-500 mb-1" id="cq-tpl-item-label">é£Ÿå“å</label>
                                <div class="relative">
                                    <input type="text" id="cq-tpl-food-search" placeholder="é£Ÿå“åã§æ¤œç´¢..."
                                        class="w-full border-2 border-gray-300 rounded-lg px-3 py-2 text-sm"
                                        oninput="filterFoodList()" onfocus="showFoodDropdown()" autocomplete="off">
                                    <div id="cq-food-dropdown" class="absolute z-50 w-full bg-white border-2 border-gray-300 rounded-lg mt-1 max-h-60 overflow-y-auto hidden shadow-lg"></div>
                                </div>
                            </div>
                            <div style="width: 100px;">
                                <label class="block text-xs text-gray-500 mb-1">é‡</label>
                                <input type="number" id="cq-tpl-food-amount" placeholder="100" min="0" step="0.1"
                                    class="w-full border-2 border-gray-300 rounded-lg px-3 py-2 text-sm">
                            </div>
                            <div style="width: 80px;">
                                <label class="block text-xs text-gray-500 mb-1">å˜ä½</label>
                                <select id="cq-tpl-food-unit" class="w-full border-2 border-gray-300 rounded-lg px-3 py-2 text-sm">
                                    <option value="g">g</option>
                                    <option value="å€‹">å€‹</option>
                                    <option value="ml">ml</option>
                                    <option value="æ¯">æ¯</option>
                                    <option value="æš">æš</option>
                                    <option value="æœ¬">æœ¬</option>
                                    <option value="ä¸">ä¸</option>
                                    <option value="ç²’">ç²’</option>
                                </select>
                            </div>
                            <button onclick="addTemplateItem()" class="bg-blue-500 text-white px-4 py-2 rounded-lg text-sm hover:bg-blue-600 whitespace-nowrap">ï¼‹è¿½åŠ </button>
                        </div>
                    </div>
                    <!-- è¿½åŠ æ¸ˆã¿ã‚¢ã‚¤ãƒ†ãƒ ãƒªã‚¹ãƒˆ -->
                    <div class="mt-3">
                        <label class="block text-sm font-bold mb-1">è¿½åŠ æ¸ˆã¿ã‚¢ã‚¤ãƒ†ãƒ </label>
                        <div id="cq-tpl-item-list" class="border-2 border-dashed border-gray-300 rounded-lg p-3 min-h-[60px] text-sm text-gray-400">ã‚¢ã‚¤ãƒ†ãƒ ã‚’è¿½åŠ ã—ã¦ãã ã•ã„</div>
                    </div>
                    <button onclick="createTemplate()" class="btn-primary mt-4">ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’ä¿å­˜</button>
                    <div id="cq-tpl-message" class="mt-2 text-sm"></div>
                </div>
            </div>

            <!-- ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆä¸€è¦§ -->
            <div class="section mb-6">
                <div class="section-header">
                    <h2>ğŸ“‹ ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆä¸€è¦§</h2>
                </div>
                <div class="section-body">
                    <div id="cq-template-list">èª­ã¿è¾¼ã¿ä¸­...</div>
                </div>
            </div>

            <!-- ãƒ¦ãƒ¼ã‚¶ãƒ¼å‰²å½“ -->
            <div class="section mb-6">
                <div class="section-header">
                    <h2>ğŸ“… ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¸ã®å‰²å½“</h2>
                </div>
                <div class="section-body">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 items-end">
                        <div>
                            <label class="block text-sm font-bold mb-1">å¯¾è±¡ãƒ¦ãƒ¼ã‚¶ãƒ¼ID</label>
                            <div class="flex gap-2">
                                <input type="text" id="cq-assign-uid" placeholder="UID" class="flex-1 border-2 border-gray-300 rounded-lg px-3 py-2">
                                <button onclick="loadUserSlots()" class="bg-blue-500 text-white px-4 py-2 rounded-lg text-sm hover:bg-blue-600 whitespace-nowrap">å–å¾—</button>
                            </div>
                            <div id="cq-assign-user-info" class="mt-1 text-xs text-gray-500"></div>
                        </div>
                        <div>
                            <label class="block text-sm font-bold mb-1">æ—¥ä»˜</label>
                            <input type="date" id="cq-assign-date" class="w-full border-2 border-gray-300 rounded-lg px-3 py-2">
                        </div>
                    </div>
                    <div class="mt-3">
                        <label class="block text-sm font-bold mb-1">ã‚¹ãƒ­ãƒƒãƒˆ</label>
                        <div id="cq-assign-slot-container" class="flex flex-wrap gap-2">
                            <span class="text-gray-400 text-sm">ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã‚’å…¥åŠ›ã—ã¦ã€Œå–å¾—ã€ã‚’æŠ¼ã—ã¦ãã ã•ã„</span>
                        </div>
                        <input type="hidden" id="cq-assign-slot" value="">
                    </div>
                    <div class="mt-4">
                        <label class="block text-sm font-bold mb-1">å‰²å½“ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ</label>
                        <select id="cq-assign-template" class="w-full border-2 border-gray-300 rounded-lg px-3 py-2">
                            <option value="">-- ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’é¸æŠ --</option>
                        </select>
                    </div>
                    <button onclick="assignQuestToUser()" class="btn-primary mt-4">å‰²å½“ã‚’ä¿å­˜</button>
                    <div id="cq-assign-message" class="mt-2 text-sm"></div>
                </div>
            </div>

            <!-- æœ€è¿‘ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼†å‰²å½“ä¸€è¦§ -->
            <div class="section mb-6">
                <div class="section-header">
                    <h2>ğŸ‘¤ æœ€è¿‘ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ / å‰²å½“ä¸€è¦§</h2>
                </div>
                <div class="section-body">
                    <!-- æœ€è¿‘ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼åˆ‡æ›¿ -->
                    <div class="mb-3">
                        <label class="block text-sm font-bold mb-1">æœ€è¿‘ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼</label>
                        <div id="cq-recent-users" class="flex flex-wrap gap-2">
                            <span class="text-gray-400 text-sm">ã¾ã å±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“</span>
                        </div>
                    </div>
                    <hr class="my-3">
                    <!-- å‰²å½“ä¸€è¦§ -->
                    <div>
                        <div class="flex items-center justify-between mb-2">
                            <label class="block text-sm font-bold" id="cq-assign-list-title">å‰²å½“ä¸€è¦§</label>
                            <button onclick="loadUserAssignments()" class="text-xs text-blue-500 hover:text-blue-700">ğŸ”„ æ›´æ–°</button>
                        </div>
                        <div id="cq-assign-list" class="text-gray-400 text-sm">ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’é¸æŠã—ã¦ãã ã•ã„</div>
                    </div>
                </div>
            </div>
        </div><!-- ã‚«ã‚¹ã‚¿ãƒ ã‚¯ã‚¨ã‚¹ãƒˆã‚»ã‚¯ã‚·ãƒ§ãƒ³çµ‚äº† -->
    </div>

    <!-- SheetJS (Excelèª­ã¿è¾¼ã¿ç”¨) -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-functions-compat.js"></script>
    <script src="/config.js"></script>

    <script>
        // FirebaseåˆæœŸåŒ–
        firebase.initializeApp(FIREBASE_CONFIG);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const functions = firebase.app().functions('asia-northeast2');

        // ç®¡ç†è€…ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã®ãƒ›ãƒ¯ã‚¤ãƒˆãƒªã‚¹ãƒˆ
        const ADMIN_EMAILS = [
            'official@your-coach-plus.com'
        ];

        // ç®¡ç†è€…PIN
        let adminPassword = '';

        // èªè¨¼ãƒã‚§ãƒƒã‚¯
        auth.onAuthStateChanged(async (user) => {
            if (!user || !ADMIN_EMAILS.includes(user.email)) {
                // æœªãƒ­ã‚°ã‚¤ãƒ³ã¾ãŸã¯ç®¡ç†è€…ã§ãªã„å ´åˆã¯ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã¸
                window.location.href = '/admin-login.html';
                return;
            }

            // ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±è¡¨ç¤º
            document.getElementById('user-info').textContent = user.email;

            // ç®¡ç†è€…PINã‚’å–å¾—ï¼ˆãƒ—ãƒ­ãƒ³ãƒ—ãƒˆï¼‰
            adminPassword = prompt('4æ¡ã®ç®¡ç†è€…PINã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
            if (!adminPassword) {
                alert('PINãŒå¿…è¦ã§ã™');
            }

            // ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
            await loadAffiliations();
        });

        // ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ
        function switchTab(tab) {
            const sections = ['affiliation', 'users', 'comy', 'analytics', 'pgbase', 'gymhunter', 'customquest'];
            const activeClass = 'px-6 py-3 rounded-lg font-bold transition bg-purple-600 text-white';
            const inactiveClass = 'px-6 py-3 rounded-lg font-bold transition bg-gray-200 text-gray-700 hover:bg-gray-300';

            sections.forEach(s => {
                const section = document.getElementById(s + '-section');
                const tabBtn = document.getElementById('tab-' + s);
                if (section) section.style.display = s === tab ? 'block' : 'none';
                if (tabBtn) tabBtn.className = s === tab ? activeClass : inactiveClass;
            });

            // ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
            if (tab === 'affiliation') { loadContracts(); loadAffiliations(); }
            if (tab === 'users') loadUsers();
            if (tab === 'comy') loadCommunityPosts();
            if (tab === 'analytics') loadAnalytics();
            if (tab === 'pgbase') loadPgBaseArticles();
            if (tab === 'gymhunter') initGymHunter();
            if (tab === 'customquest') initCustomQuest();
        }

        // ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
        function logout() {
            auth.signOut().then(() => {
                window.location.href = '/admin-login.html';
            });
        }

        // æ—¥ä»˜ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
        function formatDate(date) {
            return date.toLocaleDateString('ja-JP', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit'
            });
        }

        // ===== æ‰€å±åç®¡ç†æ©Ÿèƒ½ =====

        // æ³•äººå¥‘ç´„ä½œæˆ
        async function createContract() {
            const companyName = document.getElementById('contract-company-name').value.trim();
            const email = document.getElementById('contract-email').value.trim();
            const planId = document.getElementById('contract-plan').value;
            const customLicenses = document.getElementById('contract-licenses').value;
            const sendEmail = document.getElementById('contract-send-email').checked;

            if (!companyName || !email) {
                alert('ä¼æ¥­åã¨ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¯å¿…é ˆã§ã™');
                return;
            }

            // ãƒ—ãƒ©ãƒ³ã«å¿œã˜ãŸãƒ©ã‚¤ã‚»ãƒ³ã‚¹æ•°
            const planLicenses = {
                'standard': 10,
                'pro': 30,
                'elite': 100,
                'custom': parseInt(customLicenses) || 10
            };
            const licenses = planLicenses[planId];

            const btn = document.getElementById('create-contract-btn');
            btn.disabled = true;
            btn.textContent = 'ä½œæˆä¸­...';

            try {
                const createContractFn = functions.httpsCallable('adminCreateContract');
                const result = await createContractFn({
                    companyName,
                    email,
                    planId,
                    licenses,
                    sendEmail
                });

                if (result.data.success) {
                    alert('å¥‘ç´„ã‚’ä½œæˆã—ã¾ã—ãŸ: ' + companyName);
                    document.getElementById('contract-company-name').value = '';
                    document.getElementById('contract-email').value = '';
                    document.getElementById('contract-plan').value = 'standard';
                    document.getElementById('contract-licenses').value = '';
                    loadContracts();
                }
            } catch (error) {
                console.error('Create contract error:', error);
                alert('ã‚¨ãƒ©ãƒ¼: ' + error.message);
            } finally {
                btn.disabled = false;
                btn.textContent = 'âœ¨ å¥‘ç´„ã‚’ä½œæˆ';
            }
        }

        // æ³•äººå¥‘ç´„ä¸€è¦§èª­ã¿è¾¼ã¿
        async function loadContracts() {
            const loading = document.getElementById('contracts-loading');
            const list = document.getElementById('contracts-list');
            const empty = document.getElementById('contracts-empty');

            loading.style.display = 'block';
            list.style.display = 'none';
            empty.style.display = 'none';

            try {
                const snapshot = await db.collection('corporateContracts')
                    .orderBy('createdAt', 'desc')
                    .get();

                document.getElementById('total-contracts').textContent = snapshot.size;

                loading.style.display = 'none';

                if (snapshot.empty) {
                    empty.style.display = 'block';
                    return;
                }

                list.style.display = 'block';
                const contracts = [];
                snapshot.forEach(doc => {
                    contracts.push({ id: doc.id, ...doc.data() });
                });
                renderContracts(contracts);

            } catch (error) {
                console.error('Load contracts error:', error);
                loading.innerHTML = '<p style="color: red;">ã‚¨ãƒ©ãƒ¼: ' + error.message + '</p>';
            }
        }

        // æ³•äººå¥‘ç´„ä¸€è¦§è¡¨ç¤º
        function renderContracts(contracts) {
            const container = document.getElementById('contracts-list');
            container.innerHTML = `
                <table class="w-full text-sm">
                    <thead class="bg-gray-100">
                        <tr>
                            <th class="px-4 py-2 text-left">æ‰€å±å</th>
                            <th class="px-4 py-2 text-left">ãƒ¡ãƒ¼ãƒ«</th>
                            <th class="px-4 py-2 text-center">ãƒ—ãƒ©ãƒ³</th>
                            <th class="px-4 py-2 text-center">ãƒ©ã‚¤ã‚»ãƒ³ã‚¹</th>
                            <th class="px-4 py-2 text-center">åˆ©ç”¨ä¸­</th>
                            <th class="px-4 py-2 text-center">æœ‰åŠ¹æœŸé™</th>
                            <th class="px-4 py-2 text-center">çŠ¶æ…‹</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${contracts.map(c => {
                            const validUntil = c.validUntil?.toDate ? c.validUntil.toDate().toLocaleDateString('ja-JP') : '-';
                            const isExpired = c.validUntil?.toDate && c.validUntil.toDate() < new Date();
                            const statusClass = c.status === 'active' && !isExpired ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800';
                            const statusText = c.status === 'active' && !isExpired ? 'æœ‰åŠ¹' : 'ç„¡åŠ¹';
                            return `
                                <tr class="border-t hover:bg-gray-50">
                                    <td class="px-4 py-3 font-medium">${c.organizationName || '-'}</td>
                                    <td class="px-4 py-3">${c.email || '-'}</td>
                                    <td class="px-4 py-3 text-center">${c.planId || '-'}</td>
                                    <td class="px-4 py-3 text-center">${c.licenses || '-'}</td>
                                    <td class="px-4 py-3 text-center">${(c.registeredUsers || []).length}</td>
                                    <td class="px-4 py-3 text-center">${validUntil}</td>
                                    <td class="px-4 py-3 text-center">
                                        <span class="px-2 py-1 rounded-full text-xs font-medium ${statusClass}">${statusText}</span>
                                    </td>
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
            `;
        }

        // æ‰€å±ååˆ¥ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§èª­ã¿è¾¼ã¿
        async function loadAffiliations() {
            const loading = document.getElementById('affiliation-loading');
            const list = document.getElementById('affiliation-list');
            const empty = document.getElementById('affiliation-empty');

            loading.style.display = 'block';
            list.style.display = 'none';
            empty.style.display = 'none';

            try {
                // organizationNameãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’å–å¾—
                const snapshot = await db.collection('users')
                    .where('organizationName', '!=', null)
                    .get();

                const affiliationMap = {};
                let totalUsers = 0;

                snapshot.forEach(doc => {
                    const user = { id: doc.id, ...doc.data() };
                    const orgName = user.organizationName;
                    if (orgName && orgName.trim()) {
                        if (!affiliationMap[orgName]) {
                            affiliationMap[orgName] = [];
                        }
                        affiliationMap[orgName].push(user);
                        totalUsers++;
                    }
                });

                // çµ±è¨ˆæ›´æ–°
                document.getElementById('total-affiliations').textContent = Object.keys(affiliationMap).length;
                document.getElementById('affiliation-users').textContent = totalUsers;

                loading.style.display = 'none';

                if (Object.keys(affiliationMap).length === 0) {
                    empty.style.display = 'block';
                    return;
                }

                list.style.display = 'block';
                renderAffiliations(affiliationMap);

            } catch (error) {
                console.error('Load affiliations error:', error);
                loading.innerHTML = '<p style="color: red;">ã‚¨ãƒ©ãƒ¼: ' + error.message + '</p>';
            }
        }

        // æ‰€å±ååˆ¥ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§è¡¨ç¤º
        function renderAffiliations(affiliationMap) {
            const container = document.getElementById('affiliation-list');
            const sortedOrgs = Object.keys(affiliationMap).sort();

            container.innerHTML = sortedOrgs.map(orgName => {
                const users = affiliationMap[orgName];
                return `
                    <div class="border-2 rounded-xl p-4 border-blue-300 bg-blue-50">
                        <div class="flex items-start justify-between mb-3">
                            <div class="flex items-center gap-3">
                                <span class="font-bold text-xl text-blue-700">ğŸ¢ ${orgName}</span>
                                <span class="px-2 py-1 text-xs rounded-full font-medium bg-blue-200 text-blue-800">
                                    ${users.length}äºº
                                </span>
                            </div>
                        </div>

                        <details class="mt-3" open>
                            <summary class="text-sm text-blue-600 cursor-pointer hover:underline font-medium">
                                ğŸ‘¤ æ‰€å±ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§
                            </summary>
                            <div class="mt-2 bg-white rounded-lg p-3 space-y-2 border border-gray-200">
                                ${users.map((user, i) => `
                                    <div class="text-sm flex items-center justify-between ${i > 0 ? 'pt-2 border-t border-gray-100' : ''}">
                                        <div class="flex items-center gap-2">
                                            <span class="w-6 h-6 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center text-xs font-bold">${i + 1}</span>
                                            <div>
                                                <span class="text-gray-800 font-medium">${user.displayName || user.nickname || 'åå‰æœªè¨­å®š'}</span>
                                                <span class="text-gray-400 text-xs ml-2">${user.email || ''}</span>
                                            </div>
                                        </div>
                                        <button onclick="removeUserAffiliation('${user.id}', '${orgName}')"
                                            class="px-2 py-1 text-xs rounded bg-red-100 text-red-700 hover:bg-red-200 transition">
                                            è§£é™¤
                                        </button>
                                    </div>
                                `).join('')}
                            </div>
                        </details>
                    </div>
                `;
            }).join('');
        }

        // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«æ‰€å±åã‚’è¨­å®š
        async function setUserAffiliation() {
            const userIdOrEmail = document.getElementById('affiliation-user-id').value.trim();
            const orgName = document.getElementById('affiliation-org-name').value.trim();
            const btn = document.getElementById('set-affiliation-btn');

            if (!userIdOrEmail) {
                alert('ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã¾ãŸã¯ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }
            if (!orgName) {
                alert('æ‰€å±åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }

            btn.disabled = true;
            btn.textContent = 'â³ è¨­å®šä¸­...';

            try {
                // ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‹IDã‹ã‚’åˆ¤å®š
                let userId = userIdOrEmail;
                if (userIdOrEmail.includes('@')) {
                    // ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‹ã‚‰ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’æ¤œç´¢
                    const snapshot = await db.collection('users')
                        .where('email', '==', userIdOrEmail)
                        .limit(1)
                        .get();
                    if (snapshot.empty) {
                        throw new Error('è©²å½“ã™ã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: ' + userIdOrEmail);
                    }
                    userId = snapshot.docs[0].id;
                }

                // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®organizationNameã‚’æ›´æ–°
                await db.collection('users').doc(userId).update({
                    organizationName: orgName
                });

                alert('âœ… æ‰€å±åã‚’è¨­å®šã—ã¾ã—ãŸ\n\nãƒ¦ãƒ¼ã‚¶ãƒ¼: ' + userIdOrEmail + '\næ‰€å±å: ' + orgName);
                document.getElementById('affiliation-user-id').value = '';
                document.getElementById('affiliation-org-name').value = '';
                await loadAffiliations();

            } catch (error) {
                console.error('Set affiliation error:', error);
                alert('âŒ ' + (error.message || 'è¨­å®šã«å¤±æ•—ã—ã¾ã—ãŸ'));
            } finally {
                btn.disabled = false;
                btn.textContent = 'âœ¨ æ‰€å±åã‚’è¨­å®š';
            }
        }

        // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æ‰€å±åã‚’è§£é™¤
        async function removeUserAffiliation(userId, orgName) {
            if (!confirm(`ã“ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æ‰€å±åã€Œ${orgName}ã€ã‚’è§£é™¤ã—ã¾ã™ã‹ï¼Ÿ\n\nãƒ—ãƒ¬ãƒŸã‚¢ãƒ æ©Ÿèƒ½ãŒä½¿ãˆãªããªã‚Šã¾ã™ã€‚`)) return;

            try {
                await db.collection('users').doc(userId).update({
                    organizationName: firebase.firestore.FieldValue.delete()
                });
                await loadAffiliations();
            } catch (error) {
                console.error('Remove affiliation error:', error);
                alert('âŒ è§£é™¤ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (error.message || error));
            }
        }

        // ===== ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†æ©Ÿèƒ½ =====
        let allUsers = [];

        async function loadUsers() {
            const loading = document.getElementById('users-loading');
            const list = document.getElementById('users-list');
            const empty = document.getElementById('users-empty');
            const filter = document.getElementById('user-filter').value;

            loading.style.display = 'block';
            list.style.display = 'none';
            empty.style.display = 'none';

            try {
                // Cloud Functionã‹ã‚‰ Firebase Auth æƒ…å ±ã‚’å«ã‚€ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§ã‚’å–å¾—
                console.log('[Admin] Calling getAdminUserList...');
                const getAdminUserList = functions.httpsCallable('getAdminUserList');
                const result = await getAdminUserList();
                console.log('[Admin] Result:', result.data);

                if (!result.data.success) {
                    throw new Error('ãƒ‡ãƒ¼ã‚¿å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
                }

                // æœ€åˆã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æ—¥ä»˜ã‚’ç¢ºèª
                if (result.data.users.length > 0) {
                    console.log('[Admin] First user dates:', {
                        createdAt: result.data.users[0].createdAt,
                        lastLoginAt: result.data.users[0].lastLoginAt
                    });
                }

                allUsers = [];
                const now = new Date();
                let premiumCount = 0;
                let orgCount = 0;
                let billingCount = 0;

                result.data.users.forEach(user => {
                    // Premiumåˆ¤å®šï¼ˆæ‰€å±åãŒã‚ã‚‹ã‹ã€isPremiumãŒtrueï¼‰
                    const hasOrganization = user.organizationName && user.organizationName.trim();
                    const isPremium = user.isPremium === true || hasOrganization;

                    // ç™»éŒ²æ—¥ãƒ»ãƒ­ã‚°ã‚¤ãƒ³æ—¥ï¼ˆFirebase Authã‹ã‚‰å–å¾—æ¸ˆã¿ï¼‰
                    const regDate = user.createdAt ? new Date(user.createdAt) : new Date();
                    const lastLogin = user.lastLoginAt ? new Date(user.lastLoginAt) : null;
                    const daysSinceReg = Math.floor((now - regDate) / (1000 * 60 * 60 * 24));

                    user._isPremium = isPremium;
                    user._hasOrganization = hasOrganization;
                    user._regDate = regDate;
                    user._lastLogin = lastLogin;
                    user._daysSinceReg = daysSinceReg;

                    allUsers.push(user);

                    if (isPremium) premiumCount++;
                    if (hasOrganization) orgCount++;
                    if (user.isPremium === true && !hasOrganization) billingCount++;
                });

                // çµ±è¨ˆæ›´æ–°
                document.getElementById('total-users').textContent = allUsers.length;
                document.getElementById('premium-users').textContent = premiumCount;
                document.getElementById('org-users').textContent = orgCount;
                document.getElementById('billing-users').textContent = billingCount;

                // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼é©ç”¨
                let filtered = allUsers;
                switch (filter) {
                    case 'premium':
                        filtered = allUsers.filter(u => u._isPremium);
                        break;
                    case 'affiliation':
                        filtered = allUsers.filter(u => u._hasOrganization);
                        break;
                    case 'billing':
                        filtered = allUsers.filter(u => u.isPremium === true && !u._hasOrganization);
                        break;
                }

                // ç™»éŒ²æ—¥ã§ã‚½ãƒ¼ãƒˆï¼ˆæ–°ã—ã„é †ï¼‰
                filtered.sort((a, b) => b._regDate - a._regDate);

                loading.style.display = 'none';

                if (filtered.length === 0) {
                    empty.style.display = 'block';
                    return;
                }

                list.style.display = 'block';
                document.getElementById('user-count').textContent = `${filtered.length}äºº`;
                renderUsers(filtered);

            } catch (error) {
                console.error('Load users error:', error);
                loading.innerHTML = '<p style="color: red;">ã‚¨ãƒ©ãƒ¼: ' + error.message + '</p>';
            }
        }

        function renderUsers(users) {
            const tbody = document.getElementById('users-tbody');
            tbody.innerHTML = users.map(user => {
                const status = [];
                if (user.isPremium === true && !user._hasOrganization) {
                    status.push('<span class="px-2 py-1 text-xs rounded-full bg-yellow-100 text-yellow-800">ğŸ’³ èª²é‡‘</span>');
                }
                if (user._hasOrganization) {
                    status.push('<span class="px-2 py-1 text-xs rounded-full bg-blue-100 text-blue-800">ğŸ¢ ' + (user.organizationName || 'æ‰€å±') + '</span>');
                }
                if (status.length === 0) {
                    status.push('<span class="px-2 py-1 text-xs rounded-full bg-gray-100 text-gray-600">ç„¡æ–™</span>');
                }

                const freeCredits = user.freeCredits || 0;
                const paidCredits = user.paidCredits || 0;

                return `
                    <tr class="hover:bg-gray-50">
                        <td class="px-4 py-3">
                            <div class="font-medium text-gray-900">${user.displayName || user.nickname || 'åå‰æœªè¨­å®š'}</div>
                            <div class="text-xs text-gray-500">${user.email || 'ãƒ¡ãƒ¼ãƒ«æœªè¨­å®š'}</div>
                        </td>
                        <td class="px-4 py-3">
                            <div class="flex flex-wrap gap-1">
                                ${status.join('')}
                            </div>
                        </td>
                        <td class="px-4 py-3 text-gray-600">
                            ${user._regDate.toLocaleDateString('ja-JP')}
                            <div class="text-xs text-gray-400">${user._daysSinceReg}æ—¥ç›®</div>
                        </td>
                        <td class="px-4 py-3 text-gray-600">
                            ${user._lastLogin ? user._lastLogin.toLocaleDateString('ja-JP') : '-'}
                        </td>
                        <td class="px-4 py-3">
                            <div class="text-xs">
                                <span class="text-green-600">ç„¡æ–™: ${freeCredits}</span> /
                                <span class="text-blue-600">æœ‰å„Ÿ: ${paidCredits}</span>
                            </div>
                        </td>
                        <td class="px-4 py-3">
                            <button onclick="showUserDetail('${user.id}')" class="text-purple-600 hover:underline text-sm">
                                è©³ç´°
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function showUserDetail(userId) {
            const user = allUsers.find(u => u.id === userId);
            if (!user) return;

            const details = [
                `ID: ${user.id}`,
                `ãƒ¡ãƒ¼ãƒ«: ${user.email || 'æœªè¨­å®š'}`,
                `åå‰: ${user.displayName || user.nickname || 'æœªè¨­å®š'}`,
                `ç™»éŒ²æ—¥: ${user._regDate.toLocaleDateString('ja-JP')}`,
                `---`,
                `ç„¡æ–™ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆ: ${user.freeCredits || 0}`,
                `æœ‰å„Ÿã‚¯ãƒ¬ã‚¸ãƒƒãƒˆ: ${user.paidCredits || 0}`,
                `---`,
                `Premium: ${user.isPremium ? 'ã¯ã„' : 'ã„ã„ãˆ'}`,
                `æ‰€å±å: ${user.organizationName || 'ãªã—'}`,
            ];

            alert(details.join('\n'));
        }

        // ===== COMYæŠ•ç¨¿ç®¡ç†æ©Ÿèƒ½ =====
        let allCommunityPosts = [];

        async function loadCommunityPosts() {
            const loading = document.getElementById('comy-loading');
            const list = document.getElementById('comy-list');
            const empty = document.getElementById('comy-empty');
            const filter = document.getElementById('comy-filter').value;

            loading.style.display = 'block';
            list.style.display = 'none';
            empty.style.display = 'none';

            try {
                const getAdminCommunityPosts = functions.httpsCallable('getAdminCommunityPosts');
                const result = await getAdminCommunityPosts({ adminPassword, filter });

                if (!result.data.success) {
                    throw new Error('ãƒ‡ãƒ¼ã‚¿å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
                }

                allCommunityPosts = result.data.posts;
                const stats = result.data.stats;

                // çµ±è¨ˆæ›´æ–°
                document.getElementById('total-posts').textContent = stats.total;
                document.getElementById('pending-posts').textContent = stats.pending;
                document.getElementById('approved-posts').textContent = stats.approved;
                document.getElementById('rejected-posts').textContent = stats.rejected;

                loading.style.display = 'none';

                if (allCommunityPosts.length === 0) {
                    empty.style.display = 'block';
                    return;
                }

                list.style.display = 'block';
                document.getElementById('comy-count').textContent = `${allCommunityPosts.length}ä»¶`;
                renderCommunityPosts(allCommunityPosts);

            } catch (error) {
                console.error('Load community posts error:', error);
                loading.innerHTML = '<p style="color: red;">ã‚¨ãƒ©ãƒ¼: ' + error.message + '</p>';
            }
        }

        function renderCommunityPosts(posts) {
            const container = document.getElementById('comy-list');
            container.innerHTML = posts.map(post => {
                const statusBadge = getStatusBadge(post.approvalStatus);
                const categoryBadge = post.category === 'body'
                    ? '<span class="px-2 py-1 text-xs rounded-full bg-sky-100 text-sky-700">ğŸ’ª ãƒœãƒ‡ã‚£ãƒ¡ã‚¤ã‚¯</span>'
                    : '<span class="px-2 py-1 text-xs rounded-full bg-teal-100 text-teal-700">ğŸ§  ãƒ¡ãƒ³ã‚¿ãƒ«</span>';

                const goalCategoryBadge = post.goalCategory
                    ? `<span class="px-2 py-1 text-xs rounded-full bg-purple-100 text-purple-700">${post.goalCategory}</span>`
                    : '';

                const timestamp = post.timestamp ? new Date(post.timestamp).toLocaleString('ja-JP') : 'ä¸æ˜';

                return `
                    <div class="border-2 rounded-xl p-4 transition-all ${getStatusBorderColor(post.approvalStatus)}">
                        <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
                        <div class="flex items-start justify-between mb-3">
                            <div class="flex items-center gap-3">
                                <div class="w-10 h-10 bg-gradient-to-br from-pink-500 to-orange-500 rounded-full flex items-center justify-center text-white font-bold">
                                    ${(post.author || 'U')[0]}
                                </div>
                                <div>
                                    <div class="font-bold text-gray-800">${post.userInfo?.displayName || post.author || 'ä¸æ˜'}</div>
                                    <div class="text-xs text-gray-500">${post.userInfo?.email || ''}</div>
                                </div>
                            </div>
                            <div class="flex items-center gap-2 flex-wrap">
                                ${categoryBadge}
                                ${goalCategoryBadge}
                                ${statusBadge}
                            </div>
                        </div>

                        <!-- ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚¿ã‚¤ãƒˆãƒ« -->
                        ${post.projectTitle ? `
                        <div class="text-sm font-semibold text-gray-800 mb-2">
                            ğŸ“‹ ${post.projectTitle}
                        </div>
                        ` : ''}

                        <!-- æŠ•ç¨¿æ—¥æ™‚ -->
                        <div class="text-xs text-gray-500 mb-3">
                            ğŸ“… ${timestamp}
                        </div>

                        <!-- ç”»åƒ -->
                        ${post.photo ? `
                            <div class="mb-3">
                                <p class="text-xs text-gray-600 mb-1 font-semibold">ğŸ“¸ ${post.progressType === 'before' ? 'ãƒ“ãƒ•ã‚©ãƒ¼å†™çœŸ' : 'é€²æ—å†™çœŸ'}</p>
                                <img src="${post.photo}" alt="Photo" class="w-full max-w-xs h-48 object-cover rounded-lg border-2 ${post.progressType === 'before' ? 'border-gray-300' : 'border-sky-300'}">
                                ${post.photoSourceInfo ? `
                                    <div class="mt-1 flex items-center gap-2 text-xs">
                                        <span class="text-gray-600">${post.photoSourceInfo.source === 'camera' ? 'ğŸ“· ã‚«ãƒ¡ãƒ©' : 'ğŸ–¼ï¸ ã‚®ãƒ£ãƒ©ãƒªãƒ¼'}</span>
                                        ${post.photoSourceInfo.isEdited
                                            ? `<span class="px-1.5 py-0.5 bg-orange-100 text-orange-700 rounded font-medium">åŠ å·¥${post.photoSourceInfo.editedApp ? ': ' + post.photoSourceInfo.editedApp : ''}</span>`
                                            : `<span class="px-1.5 py-0.5 bg-green-100 text-green-700 rounded font-medium">ãƒãƒ¼ãƒãƒ«</span>`
                                        }
                                        ${post.photoSourceInfo.deviceModel ? `<span class="text-gray-500">${post.photoSourceInfo.deviceMake || ''} ${post.photoSourceInfo.deviceModel}</span>` : ''}
                                    </div>
                                ` : ''}
                            </div>
                        ` : post.beforePhoto ? `
                            <div class="mb-3">
                                <p class="text-xs text-gray-600 mb-1 font-semibold">ğŸ“¸ ãƒ“ãƒ•ã‚©ãƒ¼å†™çœŸ</p>
                                <img src="${post.beforePhoto}" alt="Before" class="w-full max-w-xs h-48 object-cover rounded-lg border-2 border-gray-200">
                            </div>
                        ` : post.afterPhoto ? `
                            <div class="mb-3">
                                <p class="text-xs text-gray-600 mb-1 font-semibold">ğŸ“¸ é€²æ—å†™çœŸ</p>
                                <img src="${post.afterPhoto}" alt="Progress" class="w-full max-w-xs h-48 object-cover rounded-lg border-2 border-sky-300">
                            </div>
                        ` : ''}

                        <!-- æŠ•ç¨¿å†…å®¹ -->
                        <div class="bg-gray-50 p-3 rounded-lg mb-3">
                            <p class="text-sm text-gray-800 whitespace-pre-wrap">${post.content || '(å†…å®¹ãªã—)'}</p>
                        </div>

                        <!-- ãƒ‡ãƒ¼ã‚¿é€£æºæƒ…å ± -->
                        ${post.attachedData && (post.attachedData.bodyData || post.attachedData.historyData) ? `
                            <div class="bg-blue-50 border border-blue-200 rounded-lg p-3 mb-3">
                                <p class="text-xs font-semibold text-blue-700 mb-2">ğŸ“Š é€£æºãƒ‡ãƒ¼ã‚¿</p>
                                <div class="space-y-2 text-xs text-gray-600">
                                    <!-- ä½“çµ„æˆ -->
                                    <div class="flex flex-wrap gap-2">
                                        ${post.attachedData.daysSinceStart !== undefined ? `<span>çµŒé: ${post.attachedData.daysSinceStart}æ—¥</span>` : ''}
                                        ${post.attachedData.bodyData?.weight ? `<span>ä½“é‡: ${post.attachedData.bodyData.weight}kg</span>` : ''}
                                        ${post.attachedData.bodyData?.lbm ? `<span>LBM: ${post.attachedData.bodyData.lbm}kg</span>` : ''}
                                        ${post.attachedData.bodyData?.bodyFat ? `<span>ä½“è„‚è‚ªç‡: ${post.attachedData.bodyData.bodyFat}%</span>` : ''}
                                    </div>
                                    <!-- é£Ÿäº‹ -->
                                    ${post.attachedData.historyData?.calories || post.attachedData.historyData?.protein ? `
                                        <div class="flex flex-wrap gap-2">
                                            <span class="text-gray-500">é£Ÿäº‹:</span>
                                            ${post.attachedData.historyData?.calories ? `<span class="text-blue-600">${post.attachedData.historyData.calories}kcal</span>` : ''}
                                            ${post.attachedData.historyData?.protein ? `<span class="text-red-500">P${post.attachedData.historyData.protein}g</span>` : ''}
                                            ${post.attachedData.historyData?.fat ? `<span class="text-yellow-500">F${post.attachedData.historyData.fat}g</span>` : ''}
                                            ${post.attachedData.historyData?.carbs ? `<span class="text-green-500">C${post.attachedData.historyData.carbs}g</span>` : ''}
                                        </div>
                                    ` : ''}
                                    <!-- é‹å‹• -->
                                    ${post.attachedData.historyData?.exerciseCount || post.attachedData.historyData?.totalSets || post.attachedData.historyData?.workoutTime ? `
                                        <div class="flex flex-wrap gap-2">
                                            <span class="text-gray-500">é‹å‹•:</span>
                                            ${post.attachedData.historyData?.exerciseCount ? `<span class="text-orange-600">${post.attachedData.historyData.exerciseCount}ç¨®ç›®</span>` : ''}
                                            ${post.attachedData.historyData?.totalSets ? `<span class="text-orange-600">${post.attachedData.historyData.totalSets}ã‚»ãƒƒãƒˆ</span>` : ''}
                                            ${post.attachedData.historyData?.totalVolume ? `<span class="text-orange-600">${post.attachedData.historyData.totalVolume.toLocaleString()}kg</span>` : ''}
                                            ${post.attachedData.historyData?.workoutTime ? `<span class="text-orange-600">${post.attachedData.historyData.workoutTime}åˆ†</span>` : ''}
                                        </div>
                                    ` : ''}
                                    <!-- ã‚³ãƒ³ãƒ‡ã‚£ã‚·ãƒ§ãƒ³ -->
                                    ${post.attachedData.historyData?.sleepHours || post.attachedData.historyData?.sleepQuality || post.attachedData.historyData?.digestion || post.attachedData.historyData?.focus || post.attachedData.historyData?.stress ? `
                                        <div class="flex flex-wrap gap-2">
                                            <span class="text-gray-500">ã‚³ãƒ³ãƒ‡ã‚£:</span>
                                            ${post.attachedData.historyData?.sleepHours ? `<span class="text-red-500">ç¡çœ ${post.attachedData.historyData.sleepHours}h</span>` : ''}
                                            ${post.attachedData.historyData?.sleepQuality ? `<span class="text-red-500">è³ª${post.attachedData.historyData.sleepQuality}</span>` : ''}
                                            ${post.attachedData.historyData?.digestion ? `<span class="text-red-500">è…¸${post.attachedData.historyData.digestion}</span>` : ''}
                                            ${post.attachedData.historyData?.focus ? `<span class="text-red-500">é›†ä¸­${post.attachedData.historyData.focus}</span>` : ''}
                                            ${post.attachedData.historyData?.stress ? `<span class="text-red-500">ã‚¹ãƒˆãƒ¬ã‚¹${post.attachedData.historyData.stress}</span>` : ''}
                                        </div>
                                    ` : ''}
                                </div>
                            </div>
                        ` : ''}

                        <!-- å´ä¸‹ç†ç”± -->
                        ${post.approvalStatus === 'rejected' && post.rejectionReason ? `
                            <div class="bg-red-50 border border-red-200 rounded-lg p-3 mb-3">
                                <p class="text-xs font-semibold text-red-700 mb-1">âŒ å´ä¸‹ç†ç”±</p>
                                <p class="text-sm text-red-800">${post.rejectionReason}</p>
                            </div>
                        ` : ''}

                        <!-- ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ -->
                        <div class="flex gap-2 flex-wrap">
                            ${post.approvalStatus === 'pending' ? `
                                <button onclick="approvePost('${post.id}', '${post.projectId}')"
                                    class="px-4 py-2 text-sm rounded-lg font-medium bg-green-100 text-green-700 hover:bg-green-200 transition flex items-center gap-1">
                                    âœ… æ‰¿èª
                                </button>
                                <button onclick="showRejectDialog('${post.id}', '${post.projectId}')"
                                    class="px-4 py-2 text-sm rounded-lg font-medium bg-orange-100 text-orange-700 hover:bg-orange-200 transition flex items-center gap-1">
                                    â›” å´ä¸‹
                                </button>
                            ` : ''}
                            ${post.approvalStatus === 'rejected' ? `
                                <button onclick="approvePost('${post.id}', '${post.projectId}')"
                                    class="px-4 py-2 text-sm rounded-lg font-medium bg-green-100 text-green-700 hover:bg-green-200 transition flex items-center gap-1">
                                    âœ… æ‰¿èªã«å¤‰æ›´
                                </button>
                            ` : ''}
                            ${post.approvalStatus === 'approved' ? `
                                <button onclick="showRejectDialog('${post.id}', '${post.projectId}')"
                                    class="px-4 py-2 text-sm rounded-lg font-medium bg-orange-100 text-orange-700 hover:bg-orange-200 transition flex items-center gap-1">
                                    â›” å´ä¸‹ã«å¤‰æ›´
                                </button>
                            ` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function getStatusBadge(status) {
            switch (status) {
                case 'pending':
                    return '<span class="px-2 py-1 text-xs rounded-full bg-yellow-100 text-yellow-800 font-medium">â³ æ‰¿èªå¾…ã¡</span>';
                case 'approved':
                    return '<span class="px-2 py-1 text-xs rounded-full bg-green-100 text-green-800 font-medium">âœ… æ‰¿èªæ¸ˆã¿</span>';
                case 'rejected':
                    return '<span class="px-2 py-1 text-xs rounded-full bg-red-100 text-red-800 font-medium">âŒ å´ä¸‹æ¸ˆã¿</span>';
                default:
                    return '<span class="px-2 py-1 text-xs rounded-full bg-gray-100 text-gray-800 font-medium">â“ ä¸æ˜</span>';
            }
        }

        function getStatusBorderColor(status) {
            switch (status) {
                case 'pending':
                    return 'border-yellow-300 bg-yellow-50';
                case 'approved':
                    return 'border-green-300 bg-green-50';
                case 'rejected':
                    return 'border-red-300 bg-red-50';
                default:
                    return 'border-gray-200 bg-gray-50';
            }
        }

        async function approvePost(postId, projectId) {
            if (!confirm('ã“ã®æŠ•ç¨¿ã‚’æ‰¿èªã—ã¾ã™ã‹ï¼Ÿ\næ‰¿èªã™ã‚‹ã¨COMYãƒ•ã‚£ãƒ¼ãƒ‰ã«å…¬é–‹ã•ã‚Œã¾ã™ã€‚')) return;

            try {
                const adminApprovePost = functions.httpsCallable('adminApprovePost');
                const result = await adminApprovePost({ postId, projectId, adminPassword });

                if (result.data.success) {
                    alert('âœ… æŠ•ç¨¿ã‚’æ‰¿èªã—ã¾ã—ãŸ');
                    await loadCommunityPosts();
                }
            } catch (error) {
                console.error('Approve post error:', error);
                alert('âŒ æ‰¿èªã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (error.message || error));
            }
        }

        function showRejectDialog(postId, projectId) {
            const reason = prompt('å´ä¸‹ç†ç”±ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆæŠ•ç¨¿è€…ã«ã¯é€šçŸ¥ã•ã‚Œã¾ã›ã‚“ï¼‰:');
            if (reason === null) return; // ã‚­ãƒ£ãƒ³ã‚»ãƒ«

            rejectPost(postId, projectId, reason);
        }

        async function rejectPost(postId, projectId, reason) {
            try {
                const adminRejectPost = functions.httpsCallable('adminRejectPost');
                const result = await adminRejectPost({ postId, projectId, reason, adminPassword });

                if (result.data.success) {
                    alert('â›” æŠ•ç¨¿ã‚’å´ä¸‹ã—ã¾ã—ãŸ');
                    await loadCommunityPosts();
                }
            } catch (error) {
                console.error('Reject post error:', error);
                alert('âŒ å´ä¸‹ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (error.message || error));
            }
        }

        // ===== ä½¿ç”¨çŠ¶æ³åˆ†ææ©Ÿèƒ½ =====
        let analyticsData = null;

        async function loadAnalytics() {
            const loading = document.getElementById('analytics-loading');
            const usersList = document.getElementById('analytics-users-list');
            const empty = document.getElementById('analytics-empty');
            const period = parseInt(document.getElementById('analytics-period').value);

            loading.style.display = 'block';
            usersList.style.display = 'none';
            empty.style.display = 'none';

            try {
                const getAdminAnalytics = functions.httpsCallable('getAdminAnalytics');
                const result = await getAdminAnalytics({ adminPassword, period });

                if (!result.data.success) {
                    throw new Error('ãƒ‡ãƒ¼ã‚¿å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
                }

                analyticsData = result.data;
                console.log('[Analytics] Data loaded:', analyticsData);

                // çµ±è¨ˆã‚µãƒãƒªãƒ¼æ›´æ–°
                document.getElementById('analytics-users').textContent = analyticsData.totalUsers;

                const totalEvents = Object.values(analyticsData.featureUsage).reduce((sum, f) => sum + f.count, 0);
                document.getElementById('analytics-events').textContent = totalEvents.toLocaleString();

                document.getElementById('analytics-features-used').textContent = Object.keys(analyticsData.featureUsage).length;
                document.getElementById('analytics-features-unused').textContent = analyticsData.unusedFeatures.length;

                // ã‚«ãƒ†ã‚´ãƒªåˆ¥ä½¿ç”¨ç‡
                renderCategoryStats(analyticsData.categoryStats);

                // äººæ°—æ©Ÿèƒ½TOP10
                renderTopFeatures(analyticsData.featureUsage, analyticsData.allFeatures);

                // æœªä½¿ç”¨æ©Ÿèƒ½
                renderUnusedFeatures(analyticsData.unusedFeatures);

                // æ—¥åˆ¥æ¨ç§»
                renderDailyChart(analyticsData.dailyUsage);

                // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ©ãƒ³ã‚­ãƒ³ã‚°
                renderAnalyticsUsers(analyticsData.userStats);

                loading.style.display = 'none';

                if (analyticsData.totalUsers === 0) {
                    empty.style.display = 'block';
                } else {
                    usersList.style.display = 'block';
                }

            } catch (error) {
                console.error('Load analytics error:', error);
                loading.innerHTML = '<p style="color: red;">ã‚¨ãƒ©ãƒ¼: ' + error.message + '</p>';
            }
        }

        function renderCategoryStats(categoryStats) {
            const container = document.getElementById('analytics-categories');
            const categoryNames = {
                dashboard: { name: 'ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰', icon: 'ğŸ ', color: 'blue' },
                meal: { name: 'é£Ÿäº‹è¨˜éŒ²', icon: 'ğŸ½ï¸', color: 'green' },
                workout: { name: 'é‹å‹•è¨˜éŒ²', icon: 'ğŸ’ª', color: 'orange' },
                analysis: { name: 'AIåˆ†æ', icon: 'ğŸ§ ', color: 'purple' },
                pgbase: { name: 'PGBASE', icon: 'ğŸ“š', color: 'pink' },
                comy: { name: 'COMY', icon: 'ğŸ‘¥', color: 'teal' },
                history: { name: 'å±¥æ­´', icon: 'ğŸ“…', color: 'gray' },
                settings: { name: 'è¨­å®š', icon: 'âš™ï¸', color: 'slate' },
                navigation: { name: 'ãƒŠãƒ“', icon: 'ğŸ§­', color: 'indigo' },
                condition: { name: 'ã‚³ãƒ³ãƒ‡ã‚£', icon: 'â¤ï¸', color: 'red' },
            };

            container.innerHTML = Object.entries(categoryStats).map(([key, stats]) => {
                const cat = categoryNames[key] || { name: key, icon: 'ğŸ“Š', color: 'gray' };
                const barColor = stats.usageRate >= 80 ? 'bg-green-500' :
                                stats.usageRate >= 50 ? 'bg-yellow-500' :
                                stats.usageRate >= 20 ? 'bg-orange-500' : 'bg-red-500';
                return `
                    <div class="bg-white border rounded-lg p-3">
                        <div class="flex items-center gap-2 mb-2">
                            <span class="text-xl">${cat.icon}</span>
                            <span class="font-medium text-sm">${cat.name}</span>
                        </div>
                        <div class="text-2xl font-bold text-${cat.color}-600">${stats.usageRate}%</div>
                        <div class="text-xs text-gray-500">${stats.used}/${stats.total}æ©Ÿèƒ½</div>
                        <div class="w-full h-2 bg-gray-200 rounded mt-2">
                            <div class="${barColor} h-2 rounded" style="width: ${stats.usageRate}%"></div>
                        </div>
                        <div class="text-xs text-gray-400 mt-1">${stats.totalCount.toLocaleString()}å›ä½¿ç”¨</div>
                    </div>
                `;
            }).join('');
        }

        function renderTopFeatures(featureUsage, allFeatures) {
            const container = document.getElementById('analytics-top-features');

            const sorted = Object.entries(featureUsage)
                .sort((a, b) => b[1].count - a[1].count)
                .slice(0, 10);

            if (sorted.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center">ãƒ‡ãƒ¼ã‚¿ãªã—</p>';
                return;
            }

            const maxCount = sorted[0][1].count;

            container.innerHTML = sorted.map(([key, data], idx) => {
                const feature = allFeatures[key] || { name: key };
                const barWidth = Math.round((data.count / maxCount) * 100);
                const medal = idx === 0 ? 'ğŸ¥‡' : idx === 1 ? 'ğŸ¥ˆ' : idx === 2 ? 'ğŸ¥‰' : `${idx + 1}.`;
                return `
                    <div class="flex items-center gap-3">
                        <span class="w-6 text-center font-bold">${medal}</span>
                        <div class="flex-1">
                            <div class="flex justify-between text-sm mb-1">
                                <span class="font-medium">${feature.name}</span>
                                <span class="text-gray-500">${data.count.toLocaleString()}å› (${data.userCount}äºº)</span>
                            </div>
                            <div class="w-full h-2 bg-gray-200 rounded">
                                <div class="bg-purple-500 h-2 rounded" style="width: ${barWidth}%"></div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function renderUnusedFeatures(unusedFeatures) {
            const container = document.getElementById('analytics-unused-features');

            if (unusedFeatures.length === 0) {
                container.innerHTML = '<p class="text-green-600 text-center font-medium">ğŸ‰ å…¨æ©Ÿèƒ½ãŒä½¿ç”¨ã•ã‚Œã¦ã„ã¾ã™ï¼</p>';
                return;
            }

            container.innerHTML = unusedFeatures.map(feature => `
                <div class="flex items-center gap-2 p-2 bg-red-50 border border-red-200 rounded">
                    <span class="text-red-500">âš ï¸</span>
                    <span class="text-sm">${feature.name}</span>
                    <span class="text-xs text-gray-400">(${feature.category})</span>
                </div>
            `).join('');
        }

        function renderDailyChart(dailyUsage) {
            const container = document.getElementById('analytics-daily-chart');

            // æ—¥ä»˜ã§ã‚½ãƒ¼ãƒˆ
            const sorted = Object.entries(dailyUsage).sort((a, b) => a[0].localeCompare(b[0]));

            if (sorted.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center py-4">ãƒ‡ãƒ¼ã‚¿ãªã—</p>';
                return;
            }

            const maxCount = Math.max(...sorted.map(([, d]) => d.count));

            container.innerHTML = sorted.map(([date, data]) => {
                const barHeight = Math.max(10, Math.round((data.count / maxCount) * 100));
                const shortDate = date.slice(5); // MM-DDå½¢å¼
                return `
                    <div class="flex flex-col items-center" style="min-width: 30px;">
                        <div class="text-xs text-gray-500 mb-1">${data.count}</div>
                        <div class="w-5 bg-purple-500 rounded-t" style="height: ${barHeight}px;"></div>
                        <div class="text-xs text-gray-400 mt-1 transform -rotate-45 origin-top-left" style="white-space: nowrap;">${shortDate}</div>
                    </div>
                `;
            }).join('');
        }

        function renderAnalyticsUsers(userStats) {
            const container = document.getElementById('analytics-users-tbody');
            document.getElementById('analytics-user-count').textContent = `${userStats.length}äºº`;

            container.innerHTML = userStats.map((user, idx) => `
                <tr class="hover:bg-gray-50">
                    <td class="px-4 py-3 font-bold text-purple-600">${idx + 1}</td>
                    <td class="px-4 py-3">
                        <div class="font-medium text-gray-900">${user.displayName}</div>
                        <div class="text-xs text-gray-500">${user.email}</div>
                    </td>
                    <td class="px-4 py-3 text-gray-600">${user.totalEvents.toLocaleString()}</td>
                    <td class="px-4 py-3 text-gray-600">${user.featureCount}</td>
                    <td class="px-4 py-3">
                        <button onclick="showUserAnalyticsDetail('${user.userId}')" class="text-purple-600 hover:underline text-sm">
                            è©³ç´°
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        function showUserAnalyticsDetail(userId) {
            const user = analyticsData.userStats.find(u => u.userId === userId);
            if (!user) return;

            const featureList = Object.entries(user.features)
                .sort((a, b) => b[1] - a[1])
                .map(([key, count]) => {
                    const feature = analyticsData.allFeatures[key] || { name: key };
                    return `${feature.name}: ${count}å›`;
                })
                .join('\n');

            alert(`ãƒ¦ãƒ¼ã‚¶ãƒ¼: ${user.displayName}\nãƒ¡ãƒ¼ãƒ«: ${user.email}\n\nã€ä½¿ç”¨æ©Ÿèƒ½ã€‘\n${featureList}`);
        }

        // ========== PGBASEè¨˜äº‹ç®¡ç† ==========

        const categoryLabels = {
            NUTRITION: 'ğŸ¥— æ „é¤Šã®åŸºæœ¬',
            PROTEIN: 'ğŸ¥© ã‚¿ãƒ³ãƒ‘ã‚¯è³ª',
            CARBS: 'ğŸš ç‚­æ°´åŒ–ç‰©',
            FAT: 'ğŸ¥‘ è„‚è³ª',
            VITAMINS: 'ğŸ’Š ãƒ“ã‚¿ãƒŸãƒ³ãƒ»ãƒŸãƒãƒ©ãƒ«',
            TRAINING: 'ğŸ‹ï¸ ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°',
            RECOVERY: 'ğŸ˜´ å›å¾©ãƒ»ä¼‘é¤Š',
            MINDSET: 'ğŸ§  ãƒ¡ãƒ³ã‚¿ãƒ«'
        };

        // PGBASEè¨˜äº‹ä¸€è¦§èª­ã¿è¾¼ã¿
        async function loadPgBaseArticles() {
            const loading = document.getElementById('pgbase-loading');
            const list = document.getElementById('pgbase-list');
            const empty = document.getElementById('pgbase-empty');
            const stats = document.getElementById('pgbase-stats');

            loading.style.display = 'block';
            list.style.display = 'none';
            empty.style.display = 'none';
            stats.style.display = 'none';

            try {
                const snapshot = await db.collection('pgbase_articles').orderBy('order').get();

                if (snapshot.empty) {
                    loading.style.display = 'none';
                    empty.style.display = 'block';
                    return;
                }

                const articles = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                // çµ±è¨ˆæ›´æ–°
                const freeCount = articles.filter(a => !a.isPremium).length;
                const premiumCount = articles.filter(a => a.isPremium).length;
                const categories = [...new Set(articles.map(a => a.category))];

                document.getElementById('pgbase-total').textContent = articles.length;
                document.getElementById('pgbase-free').textContent = freeCount;
                document.getElementById('pgbase-premium').textContent = premiumCount;
                document.getElementById('pgbase-categories').textContent = categories.length;

                // è¨˜äº‹ä¸€è¦§ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
                list.innerHTML = articles.map(article => `
                    <div class="border-2 border-gray-200 rounded-lg p-4 hover:border-purple-400 transition">
                        <div class="flex justify-between items-start">
                            <div class="flex-1">
                                <div class="flex items-center gap-2 mb-2">
                                    <span class="text-xs px-2 py-1 rounded-full ${article.isPremium ? 'bg-yellow-100 text-yellow-800' : 'bg-green-100 text-green-800'}">
                                        ${article.isPremium ? 'â­ ãƒ—ãƒ¬ãƒŸã‚¢ãƒ ' : 'ğŸ†“ ç„¡æ–™'}
                                    </span>
                                    <span class="text-xs px-2 py-1 bg-purple-100 text-purple-800 rounded-full">
                                        ${categoryLabels[article.category] || article.category}
                                    </span>
                                    <span class="text-xs text-gray-500">é †åº: ${article.order}</span>
                                </div>
                                <h3 class="font-bold text-lg text-gray-900">${article.title}</h3>
                                <p class="text-sm text-gray-600 mt-1">${article.summary}</p>
                                <div class="flex gap-4 mt-2 text-xs text-gray-500">
                                    <span>ğŸ“– ${article.readingTime}åˆ†</span>
                                    <span>ğŸ†” ${article.id}</span>
                                </div>
                            </div>
                            <button onclick="deletePgBaseArticle('${article.id}')" class="text-red-500 hover:text-red-700 p-2" title="å‰Šé™¤">
                                ğŸ—‘ï¸
                            </button>
                        </div>
                    </div>
                `).join('');

                loading.style.display = 'none';
                stats.style.display = 'grid';
                list.style.display = 'block';

            } catch (error) {
                console.error('Load PGBASE articles error:', error);
                loading.innerHTML = '<p style="color: red;">ã‚¨ãƒ©ãƒ¼: ' + error.message + '</p>';
            }
        }

        // ã‚·ãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿ä¸€æ‹¬æŠ•å…¥
        async function seedPgBaseArticles() {
            const jsonInput = document.getElementById('pgbase-json-input').value.trim();
            const resultDiv = document.getElementById('pgbase-seed-result');

            if (!jsonInput) {
                resultDiv.innerHTML = '<p class="text-red-500">JSONãƒ‡ãƒ¼ã‚¿ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</p>';
                return;
            }

            try {
                const data = JSON.parse(jsonInput);
                const articles = data.articles || [];

                if (articles.length === 0) {
                    resultDiv.innerHTML = '<p class="text-red-500">è¨˜äº‹ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“</p>';
                    return;
                }

                resultDiv.innerHTML = '<p class="text-blue-500">æŠ•å…¥ä¸­...</p>';

                const batch = db.batch();
                articles.forEach(article => {
                    const docRef = db.collection('pgbase_articles').doc(article.id);
                    batch.set(docRef, {
                        ...article,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                });

                await batch.commit();

                resultDiv.innerHTML = `
                    <div class="bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded">
                        âœ… ${articles.length}ä»¶ã®è¨˜äº‹ã‚’æŠ•å…¥ã—ã¾ã—ãŸï¼
                    </div>
                `;

                // ä¸€è¦§ã‚’æ›´æ–°
                loadPgBaseArticles();

            } catch (error) {
                console.error('Seed error:', error);
                resultDiv.innerHTML = `<p class="text-red-500">ã‚¨ãƒ©ãƒ¼: ${error.message}</p>`;
            }
        }

        // è¨˜äº‹å‰Šé™¤
        async function deletePgBaseArticle(articleId) {
            if (!confirm(`è¨˜äº‹ã€Œ${articleId}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) return;

            try {
                await db.collection('pgbase_articles').doc(articleId).delete();
                alert('å‰Šé™¤ã—ã¾ã—ãŸ');
                loadPgBaseArticles();
            } catch (error) {
                alert('å‰Šé™¤ã‚¨ãƒ©ãƒ¼: ' + error.message);
            }
        }

        // ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‰ãƒ­ãƒƒãƒ—å‡¦ç†
        function handleDragOver(e) {
            e.preventDefault();
            e.stopPropagation();
            const dropzone = document.getElementById('pgbase-dropzone');
            dropzone.classList.add('border-purple-500', 'bg-purple-100');
            dropzone.classList.remove('border-gray-300');
        }

        function handleDragLeave(e) {
            e.preventDefault();
            e.stopPropagation();
            const dropzone = document.getElementById('pgbase-dropzone');
            dropzone.classList.remove('border-purple-500', 'bg-purple-100');
            dropzone.classList.add('border-gray-300');
        }

        function handleFileDrop(e) {
            e.preventDefault();
            e.stopPropagation();
            handleDragLeave(e);

            const files = e.dataTransfer.files;
            if (files.length > 0) {
                readJsonFile(files[0]);
            }
        }

        function handleFileSelect(e) {
            const files = e.target.files;
            if (files.length > 0) {
                readJsonFile(files[0]);
            }
        }

        function readJsonFile(file) {
            const resultDiv = document.getElementById('pgbase-seed-result');

            if (!file.name.endsWith('.json')) {
                resultDiv.innerHTML = '<p class="text-red-500">JSONãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„</p>';
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const json = JSON.parse(e.target.result);
                    document.getElementById('pgbase-json-input').value = JSON.stringify(json, null, 2);

                    const articleCount = json.articles ? json.articles.length : 0;
                    resultDiv.innerHTML = `
                        <div class="bg-blue-100 border border-blue-400 text-blue-700 px-4 py-3 rounded">
                            âœ… ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿å®Œäº†: <strong>${file.name}</strong> (${articleCount}ä»¶ã®è¨˜äº‹)
                            <br><span class="text-sm">ã€ŒğŸš€ ä¸€æ‹¬æŠ•å…¥ã€ãƒœã‚¿ãƒ³ã§æŠ•å…¥ã—ã¦ãã ã•ã„</span>
                        </div>
                    `;
                } catch (err) {
                    resultDiv.innerHTML = `<p class="text-red-500">JSONãƒ‘ãƒ¼ã‚¹ã‚¨ãƒ©ãƒ¼: ${err.message}</p>`;
                }
            };
            reader.readAsText(file);
        }

        function clearPgBaseInput() {
            document.getElementById('pgbase-json-input').value = '';
            document.getElementById('pgbase-seed-result').innerHTML = '';
        }

        // ===== Gym Hunter å–¶æ¥­ãƒªã‚¹ãƒˆæ©Ÿèƒ½ =====
        let gymData = [];
        let gymHunterInitialized = false;
        const GYMS_COLLECTION = 'gymLeads';

        // ã‚¸ãƒ IDã‚’ç”Ÿæˆï¼ˆåº—å+ä½æ‰€ã®ãƒãƒƒã‚·ãƒ¥ï¼‰
        function generateGymId(name, address) {
            const str = `${name || ''}_${address || ''}`.toLowerCase().replace(/\s+/g, '');
            let hash = 0;
            for (let i = 0; i < str.length; i++) {
                const char = str.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash = hash & hash;
            }
            return 'gym_' + Math.abs(hash).toString(36);
        }

        // Firestoreã‹ã‚‰ã‚¸ãƒ ãƒªã‚¹ãƒˆã‚’èª­ã¿è¾¼ã¿
        async function loadGymsFromFirestore() {
            try {
                const snapshot = await db.collection(GYMS_COLLECTION).orderBy('createdAt', 'desc').get();
                gymData = [];
                snapshot.forEach(doc => {
                    gymData.push({ id: doc.id, ...doc.data() });
                });
                return gymData;
            } catch (err) {
                console.error('Firestoreèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', err);
                return [];
            }
        }

        // Firestoreã«ã‚¸ãƒ ã‚’ä¿å­˜ï¼ˆé‡è¤‡ãƒã‚§ãƒƒã‚¯ä»˜ãï¼‰
        async function saveGymsToFirestore(gyms) {
            const batch = db.batch();
            let newCount = 0;
            let skipCount = 0;

            for (const gym of gyms) {
                const gymId = generateGymId(gym.name, gym.address);
                const docRef = db.collection(GYMS_COLLECTION).doc(gymId);

                // æ—¢å­˜ãƒã‚§ãƒƒã‚¯
                const existing = await docRef.get();
                if (existing.exists) {
                    skipCount++;
                    continue;
                }

                // æ–°è¦è¿½åŠ 
                batch.set(docRef, {
                    name: gym.name || '',
                    address: gym.address || '',
                    phone: gym.phone || '',
                    website: gym.website || '',
                    rank: gym.rank || 'B',
                    reason: gym.reason || '',
                    features: gym.features || '',
                    rating: gym.rating || null,
                    status: '',
                    scrapedAt: gym.scraped_at || null,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                newCount++;
            }

            if (newCount > 0) {
                await batch.commit();
            }

            return { newCount, skipCount };
        }

        // ã‚¸ãƒ ã®çŠ¶æ…‹ã‚’Firestoreã§æ›´æ–°
        async function updateGymStatusInFirestore(gymId, status) {
            try {
                await db.collection(GYMS_COLLECTION).doc(gymId).update({
                    status: status,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
            } catch (err) {
                console.error('çŠ¶æ…‹æ›´æ–°ã‚¨ãƒ©ãƒ¼:', err);
            }
        }

        async function initGymHunter() {
            if (gymHunterInitialized) return;
            gymHunterInitialized = true;

            const dropZone = document.getElementById('drop-zone');
            const fileInput = document.getElementById('file-input');

            // ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—
            dropZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                dropZone.style.borderColor = '#667eea';
                dropZone.style.background = '#f0f4ff';
            });

            dropZone.addEventListener('dragleave', (e) => {
                e.preventDefault();
                dropZone.style.borderColor = '#ccc';
                dropZone.style.background = 'white';
            });

            dropZone.addEventListener('drop', (e) => {
                e.preventDefault();
                dropZone.style.borderColor = '#ccc';
                dropZone.style.background = 'white';
                const file = e.dataTransfer.files[0];
                if (file) loadExcelFile(file);
            });

            // ã‚¯ãƒªãƒƒã‚¯ã§ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠ
            dropZone.addEventListener('click', () => fileInput.click());
            fileInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) loadExcelFile(file);
            });

            // æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã‚’Firestoreã‹ã‚‰èª­ã¿è¾¼ã¿
            showGymLoading(true);
            gymData = await loadGymsFromFirestore();
            showGymLoading(false);

            if (gymData.length > 0) {
                displayGymList(gymData);
                document.getElementById('filter-section').style.display = 'block';
                document.getElementById('list-section').style.display = 'block';
                updateGymCount(gymData.length);
            }
        }

        function showGymLoading(show) {
            const dropZone = document.getElementById('drop-zone');
            if (show) {
                dropZone.innerHTML = '<p class="text-gray-500">èª­ã¿è¾¼ã¿ä¸­...</p>';
            } else {
                dropZone.innerHTML = `
                    <p class="text-gray-500 mb-2">Excelãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—</p>
                    <p class="text-gray-400 text-sm">ã¾ãŸã¯ ã‚¯ãƒªãƒƒã‚¯ã—ã¦é¸æŠ</p>
                `;
            }
        }

        async function loadExcelFile(file) {
            const reader = new FileReader();
            reader.onload = async function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const sheetName = workbook.SheetNames[0];
                    const sheet = workbook.Sheets[sheetName];
                    const excelData = XLSX.utils.sheet_to_json(sheet);

                    // Firestoreã«ä¿å­˜ï¼ˆé‡è¤‡ãƒã‚§ãƒƒã‚¯ä»˜ãï¼‰
                    showGymLoading(true);
                    const result = await saveGymsToFirestore(excelData);

                    // æœ€æ–°ãƒ‡ãƒ¼ã‚¿ã‚’å†èª­ã¿è¾¼ã¿
                    gymData = await loadGymsFromFirestore();
                    showGymLoading(false);

                    displayGymList(gymData);
                    document.getElementById('filter-section').style.display = 'block';
                    document.getElementById('list-section').style.display = 'block';
                    updateGymCount(gymData.length);

                    // çµæœã‚’é€šçŸ¥
                    alert(`ã‚¤ãƒ³ãƒãƒ¼ãƒˆå®Œäº†\næ–°è¦è¿½åŠ : ${result.newCount}ä»¶\nã‚¹ã‚­ãƒƒãƒ—ï¼ˆé‡è¤‡ï¼‰: ${result.skipCount}ä»¶`);
                } catch (err) {
                    alert('ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: ' + err.message);
                    showGymLoading(false);
                }
            };
            reader.readAsArrayBuffer(file);
        }

        function displayGymList(data) {
            const tbody = document.getElementById('gym-tbody');
            tbody.innerHTML = '';

            data.forEach((row, idx) => {
                const rank = row.rank || 'B';
                const rankStyle = getRankStyle(rank);
                const reason = row.reason || '';
                const shortReason = reason.substring(0, 60);
                const hasMore = reason.length > 60;
                const gymId = row.id || '';
                const status = row.status || '';
                const tr = document.createElement('tr');
                tr.className = 'border-b hover:bg-gray-50 gym-row';
                tr.dataset.rank = rank;

                tr.innerHTML = `
                    <td class="px-4 py-3">
                        <span class="px-3 py-1 rounded-full text-white font-bold ${rankStyle.bg}">${rank}</span>
                    </td>
                    <td class="px-4 py-3">
                        ${renderStatusSelect(gymId, status, idx)}
                    </td>
                    <td class="px-4 py-3 font-medium">${escapeHtml(row.name || '')}</td>
                    <td class="px-4 py-3">
                        ${row.phone ? `<a href="tel:${row.phone}" class="text-blue-600 hover:underline">${escapeHtml(row.phone)}</a>` : '-'}
                    </td>
                    <td class="px-4 py-3 text-gray-600 text-xs" style="max-width: 350px;">
                        <span id="reason-short-${idx}">${escapeHtml(shortReason)}${hasMore ? '...' : ''}</span>
                        <span id="reason-full-${idx}" style="display:none;">${escapeHtml(reason)}</span>
                        ${hasMore ? `<button onclick="toggleReason(${idx})" id="reason-btn-${idx}" class="ml-2 text-blue-500 hover:underline text-xs">â–¼ å±•é–‹</button>` : ''}
                    </td>
                    <td class="px-4 py-3">${row.rating || '-'}</td>
                    <td class="px-4 py-3">
                        ${row.website ? `<a href="${escapeHtml(row.website)}" target="_blank" class="text-blue-600 hover:underline">HP</a>` : '-'}
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        function getRankStyle(rank) {
            const styles = {
                'S': { bg: 'bg-green-500' },
                'A': { bg: 'bg-blue-500' },
                'B': { bg: 'bg-gray-400' },
                'C': { bg: 'bg-red-400' }
            };
            return styles[rank] || styles['B'];
        }

        // çŠ¶æ…‹ç®¡ç†
        const STATUS_OPTIONS = [
            { value: '', label: 'æœªå¯¾å¿œ', color: 'bg-gray-200 text-gray-600' },
            { value: 'called', label: 'æ¶é›»æ¸ˆ', color: 'bg-yellow-100 text-yellow-700' },
            { value: 'negotiating', label: 'å•†è«‡ä¸­', color: 'bg-blue-100 text-blue-700' },
            { value: 'closed', label: 'æˆç´„', color: 'bg-green-100 text-green-700' },
            { value: 'rejected', label: 'è¦‹é€ã‚Š', color: 'bg-red-100 text-red-700' }
        ];

        function renderStatusSelect(gymId, currentStatus, idx) {
            const options = STATUS_OPTIONS.map(opt =>
                `<option value="${opt.value}" ${currentStatus === opt.value ? 'selected' : ''}>${opt.label}</option>`
            ).join('');
            return `<select onchange="updateStatus('${gymId}', this.value, ${idx})"
                           id="status-${idx}"
                           class="text-xs px-2 py-1 rounded border ${getStatusColor(currentStatus)}">
                        ${options}
                    </select>`;
        }

        function getStatusColor(status) {
            const opt = STATUS_OPTIONS.find(o => o.value === status);
            return opt ? opt.color : 'bg-gray-200 text-gray-600';
        }

        async function updateStatus(gymId, status, idx) {
            // UIã‚’å³åº§ã«æ›´æ–°
            const select = document.getElementById(`status-${idx}`);
            select.className = `text-xs px-2 py-1 rounded border ${getStatusColor(status)}`;

            // ãƒ­ãƒ¼ã‚«ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚‚æ›´æ–°
            const gym = gymData.find(g => g.id === gymId);
            if (gym) gym.status = status;

            // Firestoreã«ä¿å­˜
            await updateGymStatusInFirestore(gymId, status);
        }

        function filterByRank(rank) {
            const rows = document.querySelectorAll('.gym-row');
            let count = 0;

            rows.forEach(row => {
                if (rank === 'all' || row.dataset.rank === rank) {
                    row.style.display = '';
                    count++;
                } else {
                    row.style.display = 'none';
                }
            });

            updateGymCount(count);

            // ãƒœã‚¿ãƒ³ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ–çŠ¶æ…‹
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.style.opacity = '0.6';
            });
            event.target.style.opacity = '1';
        }

        function updateGymCount(count) {
            document.getElementById('gym-count').textContent = `è¡¨ç¤º: ${count}ä»¶`;
        }

        function toggleReason(idx) {
            const short = document.getElementById(`reason-short-${idx}`);
            const full = document.getElementById(`reason-full-${idx}`);
            const btn = document.getElementById(`reason-btn-${idx}`);

            if (full.style.display === 'none') {
                short.style.display = 'none';
                full.style.display = 'inline';
                btn.textContent = 'â–² é–‰ã˜ã‚‹';
            } else {
                short.style.display = 'inline';
                full.style.display = 'none';
                btn.textContent = 'â–¼ å±•é–‹';
            }
        }

        // =====================================================
        // ã‚«ã‚¹ã‚¿ãƒ ã‚¯ã‚¨ã‚¹ãƒˆç®¡ç†
        // =====================================================

        async function initCustomQuest() {
            await loadTemplates();
            // æ—¥ä»˜ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã‚’æ˜æ—¥ã«è¨­å®š
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            document.getElementById('cq-assign-date').value = tomorrow.toISOString().split('T')[0];
            // æœ€è¿‘ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’å¾©å…ƒ
            renderRecentUsers();
        }

        // ========== FoodDatabaseï¼ˆã‚«ãƒ†ã‚´ãƒªä»˜ãï¼‰ ==========
        const FOOD_DATABASE = {
            "è‚‰é¡": ["ãƒ©ãƒ è‚‰ï¼ˆã‚‚ã‚‚è„‚èº«ã¤ãç”Ÿï¼‰","ç‰›ã²ãè‚‰ï¼ˆç”Ÿï¼‰","ç‰›ã‚‚ã‚‚è‚‰ï¼ˆè„‚èº«ã¤ãç”Ÿï¼‰","ç‰›ã‚‚ã‚‚è‚‰ï¼ˆèµ¤è‚‰ç”Ÿï¼‰","ç‰›ãƒãƒ©ï¼ˆè„‚èº«ã¤ãç”Ÿï¼‰","ç‰›ãƒ’ãƒ¬ï¼ˆèµ¤è‚‰ç”Ÿï¼‰","ç‰›è‚©ãƒ­ãƒ¼ã‚¹ï¼ˆè„‚èº«ã¤ãç”Ÿï¼‰","ç‰›è‚©ãƒ­ãƒ¼ã‚¹ï¼ˆèµ¤è‚‰ç”Ÿï¼‰","è±šã²ãè‚‰ï¼ˆç”Ÿï¼‰","è±šã‚‚ã‚‚è‚‰ï¼ˆè„‚èº«ã¤ãç”Ÿï¼‰","è±šã‚‚ã‚‚è‚‰ï¼ˆèµ¤è‚‰ç”Ÿï¼‰","è±šãƒãƒ©ï¼ˆè„‚èº«ã¤ãç”Ÿï¼‰","è±šãƒ’ãƒ¬ï¼ˆèµ¤è‚‰ç”Ÿï¼‰","è±šãƒ­ãƒ¼ã‚¹ï¼ˆè„‚èº«ã¤ãç”Ÿï¼‰","è±šãƒ­ãƒ¼ã‚¹ï¼ˆèµ¤è‚‰ç”Ÿï¼‰","é¶ã•ã•ã¿ï¼ˆç”Ÿï¼‰","é¶ã²ãè‚‰ï¼ˆç”Ÿï¼‰","é¶ã‚€ã­è‚‰ï¼ˆçš®ã¤ãç”Ÿï¼‰","é¶ã‚€ã­è‚‰ï¼ˆçš®ãªã—ç”Ÿï¼‰","é¶ã‚‚ã‚‚è‚‰ï¼ˆçš®ã¤ãç”Ÿï¼‰","é¶ã‚‚ã‚‚è‚‰ï¼ˆçš®ãªã—ç”Ÿï¼‰","é¹¿è‚‰ï¼ˆèµ¤è‚‰ç”Ÿï¼‰"],
            "é­šä»‹é¡": ["ã‚¢ã‚µãƒªï¼ˆç”Ÿï¼‰","ã‚¢ã‚¸ï¼ˆç”Ÿï¼‰","ã‚¤ã‚«ï¼ˆã‚¹ãƒ«ãƒ¡ã‚¤ã‚«ç”Ÿï¼‰","ã‚¤ãƒ¯ã‚·ç¼¶ï¼ˆæ°´ç…®ï¼‰","ã‚¤ãƒ¯ã‚·ï¼ˆç”Ÿï¼‰","ã‚¦ãƒŠã‚®ï¼ˆé¤Šæ®–ç”Ÿï¼‰","ã‚¨ãƒ“ï¼ˆãƒãƒŠãƒ¡ã‚¤ç”Ÿï¼‰","ã‚¨ãƒ“ï¼ˆãƒ–ãƒ©ãƒƒã‚¯ã‚¿ã‚¤ã‚¬ãƒ¼ç”Ÿï¼‰","ã‚«ã‚­ï¼ˆç”Ÿï¼‰","ã‚«ãƒ„ã‚ªï¼ˆç”Ÿï¼‰","ã‚«ãƒ¬ã‚¤ï¼ˆç”Ÿï¼‰","ã‚«ãƒ³ãƒ‘ãƒï¼ˆç”Ÿï¼‰","ã‚µã‚±ï¼ˆç”Ÿï¼‰","ã‚µãƒç¼¶ï¼ˆå‘³å™Œç…®ï¼‰","ã‚µãƒç¼¶ï¼ˆæ°´ç…®ï¼‰","ã‚µãƒï¼ˆç”Ÿï¼‰","ã‚µãƒï¼ˆç„¼ãï¼‰","ã‚µãƒ³ãƒç¼¶ï¼ˆè’²ç„¼ï¼‰","ã‚µãƒ³ãƒï¼ˆç”Ÿï¼‰","ã‚·ã‚¸ãƒŸï¼ˆç”Ÿï¼‰","ã‚¿ã‚¤ï¼ˆç”Ÿï¼‰","ã‚¿ã‚³ï¼ˆãƒãƒ€ã‚³ç”Ÿï¼‰","ã‚¿ãƒ©ï¼ˆç”Ÿï¼‰","ãƒ„ãƒŠç¼¶ï¼ˆæ°´ç…®ï¼‰","ãƒ„ãƒŠç¼¶ï¼ˆæ²¹æ¼¬ï¼‰","ãƒãƒãƒï¼ˆç”Ÿï¼‰","ãƒ’ãƒ©ãƒ¡ï¼ˆç”Ÿï¼‰","ãƒ“ãƒ³ãƒãƒ§ã‚¦ãƒã‚°ãƒ­ï¼ˆç”Ÿï¼‰","ãƒ–ãƒªï¼ˆç”Ÿï¼‰","ãƒ™ãƒ‹ã‚¶ã‚±ï¼ˆç”Ÿï¼‰","ãƒ›ã‚¿ãƒ†è²æŸ±ï¼ˆç”Ÿï¼‰","ãƒã‚°ãƒ­ï¼ˆãƒˆãƒ­ç”Ÿï¼‰","ãƒ ãƒ¼ãƒ«è²ï¼ˆç”Ÿï¼‰","ãƒ¡ãƒãƒ«ï¼ˆç”Ÿï¼‰","ç”˜ã‚¨ãƒ“ï¼ˆç”Ÿï¼‰"],
            "åµé¡": ["ã†ãšã‚‰åµ æ°´ç…®ï¼ˆ1å€‹12gï¼‰","ã†ãšã‚‰åµï¼ˆ1å€‹10gï¼‰","ã‚†ã§åµ Mï¼ˆ58gï¼‰","åµç„¼ãï¼ˆåµ1å€‹åˆ†+èª¿å‘³æ–™ï¼‰","æ¸©æ³‰åµ Mï¼ˆ58gï¼‰","ç›®ç‰ç„¼ã Mï¼ˆåµ58g+æ²¹3gï¼‰","é¶åµ LLï¼ˆ70gï¼‰","é¶åµ Lï¼ˆ64gï¼‰","é¶åµ MSï¼ˆ50gï¼‰","é¶åµ Mï¼ˆ58gï¼‰","é¶åµ Sï¼ˆ46gï¼‰","é¶åµï¼ˆåµç™½ã®ã¿ï¼‰","é¶åµï¼ˆåµé»„ã®ã¿ï¼‰"],
            "ä¸»é£Ÿ": ["10å‰²ãã°ï¼ˆã‚†ã§ï¼‰","10å‰²ãã°ï¼ˆä¹¾ï¼‰","ã†ã©ã‚“ï¼ˆã‚†ã§ï¼‰","ãŠã‹ã‚†ï¼ˆå…¨ãŒã‚†ï¼‰","ãã†ã‚ã‚“ï¼ˆã‚†ã§ï¼‰","ãã°ï¼ˆã‚†ã§ï¼‰","ã‚‚ã¡éº¦ã”ã¯ã‚“ï¼ˆç‚Šé£¯ç›´å¾Œï¼‰","ã‚‚ã¡ç±³ï¼ˆç‚Šé£¯å¾Œï¼‰","ã‚ªãƒ¼ãƒˆãƒŸãƒ¼ãƒ«","ã‚¯ãƒ­ãƒ¯ãƒƒã‚µãƒ³","ã‚°ãƒ©ãƒãƒ¼ãƒ©","ã‚³ãƒ¼ãƒ³ãƒ•ãƒ¬ãƒ¼ã‚¯","ã‚¹ãƒ‘ã‚²ãƒ†ã‚£ï¼ˆä¹¾ï¼‰","ãƒ‘ã‚¹ã‚¿ï¼ˆã‚†ã§ï¼‰","ãƒ“ãƒ¼ãƒ•ãƒ³ï¼ˆä¹¾ï¼‰","ãƒ•ãƒ©ãƒ³ã‚¹ãƒ‘ãƒ³","ãƒ™ãƒ¼ã‚°ãƒ«","ãƒã‚«ãƒ­ãƒ‹ï¼ˆä¹¾ï¼‰","ãƒ©ã‚¤éº¦ãƒ‘ãƒ³","ãƒ­ãƒ¼ãƒ«ãƒ‘ãƒ³","ä¸­è¯éººï¼ˆã‚†ã§ï¼‰","å…¨ç²’ç²‰ãƒ‘ãƒ³","å°éº¦ç²‰ï¼ˆå¼·åŠ›ç²‰ï¼‰","å°éº¦ç²‰ï¼ˆè–„åŠ›ç²‰ï¼‰","æ˜¥é›¨ï¼ˆä¹¾ï¼‰","ç‰‡æ —ç²‰","ç„ç±³","ç„ç±³ï¼ˆç‚Šé£¯å¾Œï¼‰","ç™ºèŠ½ç„ç±³ï¼ˆç‚Šé£¯å¾Œï¼‰","ç™½ç±³ï¼ˆå†·ã‚„ã”é£¯ãƒ»å†åŠ ç†±ï¼‰","ç™½ç±³ï¼ˆç‚Šé£¯ç›´å¾Œï¼‰","ç™½ç±³ï¼ˆç²¾ç™½ç±³ï¼‰","ã‚ã‚“ã“","èƒšèŠ½ç±³ï¼ˆç‚Šé£¯å¾Œï¼‰","èµ¤é£¯","é£Ÿãƒ‘ãƒ³","é¤…"],
            "é‡èœé¡": ["ãˆã®ããŸã‘ï¼ˆç”Ÿï¼‰","ã‹ã¼ã¡ã‚ƒï¼ˆç”Ÿï¼‰","ãã‚…ã†ã‚Šï¼ˆç”Ÿï¼‰","ã”ã¼ã†ï¼ˆç”Ÿï¼‰","ã•ã¤ã¾ã„ã‚‚ï¼ˆç”Ÿï¼‰","ã•ã‚„ã„ã‚“ã’ã‚“ï¼ˆç”Ÿï¼‰","ã—ã„ãŸã‘ï¼ˆç”Ÿï¼‰","ã—ã‚ã˜ï¼ˆç”Ÿï¼‰","ã—ã‚‡ã†ãŒï¼ˆç”Ÿï¼‰","ã˜ã‚ƒãŒã„ã‚‚ï¼ˆç”Ÿï¼‰","ãªã™ï¼ˆç”Ÿï¼‰","ã«ã‚“ã˜ã‚“ï¼ˆç”Ÿï¼‰","ã«ã‚“ã«ãï¼ˆç”Ÿï¼‰","ã»ã†ã‚Œã‚“è‰ï¼ˆç”Ÿï¼‰","ã¾ã„ãŸã‘ï¼ˆç”Ÿï¼‰","ã‚‚ã‚„ã—ï¼ˆç”Ÿï¼‰","ã‚Œã‚“ã“ã‚“ï¼ˆç”Ÿï¼‰","ã‚¢ã‚¹ãƒ‘ãƒ©ã‚¬ã‚¹ï¼ˆç”Ÿï¼‰","ã‚¢ãƒœã‚«ãƒ‰ï¼ˆç”Ÿï¼‰","ã‚¨ãƒªãƒ³ã‚®ï¼ˆç”Ÿï¼‰","ã‚ªã‚¯ãƒ©ï¼ˆç”Ÿï¼‰","ã‚«ãƒªãƒ•ãƒ©ãƒ¯ãƒ¼ï¼ˆç”Ÿï¼‰","ã‚­ãƒ£ãƒ™ãƒ„ï¼ˆç”Ÿï¼‰","ãƒ–ãƒ­ãƒƒã‚³ãƒªãƒ¼ï¼ˆç”Ÿï¼‰","ã‚»ãƒ­ãƒªï¼ˆç”Ÿï¼‰","ãƒãƒ³ã‚²ãƒ³èœï¼ˆç”Ÿï¼‰","ãƒˆãƒãƒˆï¼ˆç”Ÿï¼‰","ãƒ‘ãƒ—ãƒªã‚«ï¼ˆèµ¤ãƒ»ç”Ÿï¼‰","ãƒ‘ãƒ—ãƒªã‚«ï¼ˆé»„ãƒ»ç”Ÿï¼‰","ãƒ”ãƒ¼ãƒãƒ³ï¼ˆç”Ÿï¼‰","ãƒŸãƒ‹ãƒˆãƒãƒˆï¼ˆç”Ÿï¼‰","ãƒ¬ã‚¿ã‚¹ï¼ˆç”Ÿï¼‰","å¤§æ ¹ï¼ˆç”Ÿï¼‰","å°æ¾èœï¼ˆç”Ÿï¼‰","æ˜¥èŠï¼ˆç”Ÿï¼‰","æè±†ï¼ˆã•ã‚„ãªã—ç”Ÿï¼‰","ç‰ã­ãï¼ˆç”Ÿï¼‰","ç™½èœï¼ˆç”Ÿï¼‰","é‡ŒèŠ‹ï¼ˆç”Ÿï¼‰","é•·ã­ãï¼ˆç”Ÿï¼‰","é•·èŠ‹ï¼ˆç”Ÿï¼‰"],
            "ä¹³è£½å“": ["ã‚«ãƒƒãƒ†ãƒ¼ã‚¸ãƒãƒ¼ã‚º","ã‚®ãƒªã‚·ãƒ£ãƒ¨ãƒ¼ã‚°ãƒ«ãƒˆï¼ˆç„¡ç³–ï¼‰","ãƒ‘ãƒ«ãƒ¡ã‚¶ãƒ³ãƒãƒ¼ã‚º","ãƒ—ãƒ­ã‚»ã‚¹ãƒãƒ¼ã‚º","ãƒ¢ãƒƒãƒ„ã‚¡ãƒ¬ãƒ©ãƒãƒ¼ã‚º","ãƒ¨ãƒ¼ã‚°ãƒ«ãƒˆï¼ˆç„¡ç³–ï¼‰","ä½è„‚è‚ªç‰›ä¹³","ç„¡è„‚è‚ªç‰›ä¹³","ç”Ÿã‚¯ãƒªãƒ¼ãƒ "],
            "è±†é¡ãƒ»ãƒŠãƒƒãƒ„": ["ãã‚‹ã¿","ã‚¢ãƒ¼ãƒ¢ãƒ³ãƒ‰","ã‚«ã‚·ãƒ¥ãƒ¼ãƒŠãƒƒãƒ„","ãƒ”ã‚¹ã‚¿ãƒã‚ª","ãƒ”ãƒ¼ãƒŠãƒƒãƒ„","åšæšã’","å¤§è±†ï¼ˆã‚†ã§ï¼‰","æœ¨ç¶¿è±†è…","æè±†ï¼ˆã‚†ã§ï¼‰","æ²¹æšã’","çµ¹ã”ã—è±†è…","ç´è±†ï¼ˆç³¸å¼•ãï¼‰"],
            "æœç‰©é¡": ["ã„ã¡ã”","ãƒãƒŠãƒŠ","ã¶ã©ã†","ã¿ã‹ã‚“","ã‚Šã‚“ã”","ã‚ªãƒ¬ãƒ³ã‚¸","ã‚­ã‚¦ã‚¤","ã‚¹ã‚¤ã‚«","ãƒ‘ã‚¤ãƒŠãƒƒãƒ—ãƒ«","ãƒ–ãƒ«ãƒ¼ãƒ™ãƒªãƒ¼","ãƒãƒ³ã‚´ãƒ¼"],
            "ã‚µãƒ—ãƒªãƒ¡ãƒ³ãƒˆ": ["BCAA","EAA","NatureMade DHA","NatureMade L-ã‚«ãƒ«ãƒ‹ãƒãƒ³","NatureMade ã‚¢ã‚¹ã‚¿ã‚­ã‚µãƒ³ãƒãƒ³","NatureMade ã‚«ãƒ«ã‚·ã‚¦ãƒ  200mg","NatureMade ã‚«ãƒ«ã‚·ã‚¦ãƒ ãƒ»ãƒã‚°ãƒã‚·ã‚¦ãƒ ãƒ»äºœé‰›","NatureMade ã‚³ã‚¨ãƒ³ã‚¶ã‚¤ãƒ Q10","NatureMade ã‚¹ãƒ¼ãƒ‘ãƒ¼ãƒãƒ«ãƒãƒ“ã‚¿ãƒŸãƒ³&ãƒŸãƒãƒ©ãƒ«","NatureMade ãƒ“ã‚¿ãƒŸãƒ³Bç¾¤","NatureMade ãƒ“ã‚¿ãƒŸãƒ³C 500mg","NatureMade ãƒ“ã‚¿ãƒŸãƒ³D 1000IU","NatureMade ãƒ“ã‚¿ãƒŸãƒ³E 400IU","NatureMade ãƒ•ã‚£ãƒƒã‚·ãƒ¥ã‚ªã‚¤ãƒ«ï¼ˆEPAãƒ»DHAï¼‰","NatureMade ãƒãƒ«ãƒãƒ“ã‚¿ãƒŸãƒ³","NatureMade ãƒ«ãƒ†ã‚¤ãƒ³","NatureMade äºœé‰›","NatureMade è‘‰é…¸","NatureMade é‰„","Î²ã‚¢ãƒ©ãƒ‹ãƒ³","ãƒ›ã‚¨ã‚¤ãƒ—ãƒ­ãƒ†ã‚¤ãƒ³","ã‚«ã‚¼ã‚¤ãƒ³ãƒ—ãƒ­ãƒ†ã‚¤ãƒ³","ã‚¯ãƒ¬ã‚¢ãƒãƒ³","ã‚¯ãƒ¬ã‚¢ãƒãƒ³ãƒ¢ãƒãƒã‚¤ãƒ‰ãƒ¬ãƒ¼ãƒˆ","ã‚°ãƒ«ã‚¿ãƒŸãƒ³","ã‚·ãƒˆãƒ«ãƒªãƒ³ãƒãƒ¬ãƒ¼ãƒˆ","ã‚½ã‚¤ãƒ—ãƒ­ãƒ†ã‚¤ãƒ³","ãƒãƒ«ãƒˆãƒ‡ã‚­ã‚¹ãƒˆãƒªãƒ³"],
            "ãƒ‰ãƒªãƒ³ã‚¯": ["ãƒ–ãƒ©ãƒƒã‚¯ã‚³ãƒ¼ãƒ’ãƒ¼","ç·‘èŒ¶ï¼ˆã›ã‚“èŒ¶ï¼‰","ãƒ”ãƒ³ã‚¯ã‚½ãƒ«ãƒˆï¼ˆãƒ’ãƒãƒ©ãƒ¤å²©å¡©ï¼‰"],
            "èª¿å‘³æ–™": ["MCTã‚ªã‚¤ãƒ«","ãˆã”ã¾æ²¹","ã”ã¾æ²¹","ã¯ã¡ã¿ã¤","ã¿ã‚Šã‚“","ã‚ã‚“ã¤ã‚†ï¼ˆ3å€æ¿ƒç¸®ï¼‰","ã‚¢ãƒãƒ‹æ²¹","ã‚ªã‚¤ã‚¹ã‚¿ãƒ¼ã‚½ãƒ¼ã‚¹","ã‚ªãƒªãƒ¼ãƒ–ã‚ªã‚¤ãƒ«","ã‚°ãƒ©ãƒ‹ãƒ¥ãƒ¼ç³–","ã‚±ãƒãƒ£ãƒƒãƒ—","ã‚³ã‚³ãƒŠãƒƒãƒ„ã‚ªã‚¤ãƒ«","ãƒã‚¿ãƒ¼","ãƒãƒ³é…¢","ãƒãƒ¨ãƒãƒ¼ã‚º","ãƒ¡ãƒ¼ãƒ—ãƒ«ã‚·ãƒ­ãƒƒãƒ—","ä¸‰æ¸©ç³–","ä¸Šç™½ç³–","å‘³å™Œï¼ˆæ·¡è‰²è¾›ã¿ãï¼‰","å‘³å™Œï¼ˆèµ¤è‰²è¾›ã¿ãï¼‰","æ–™ç†é…’","æ¿ƒå£é†¤æ²¹","ç„¡å¡©ãƒã‚¿ãƒ¼","ç±³æ²¹","ç±³é…¢","ç²—å¡©","è–„å£é†¤æ²¹","è±†æ¿é†¤","é»’ç³–","é»’é…¢"],
            "å’Œè“å­": ["ã‚ã‚‰ã‚Œï¼ˆå¡©å‘³ï¼‰","ã„ã¡ã”å¤§ç¦","ãã‚“ã¤ã°","ããšã‚‚ã¡ï¼ˆé»’èœœããªã“ï¼‰","ã“ã—ã‚ã‚“","ã–ã‚‰ã‚ã›ã‚“ã¹ã„","ã—ã‚‡ã†ã‚†ã›ã‚“ã¹ã„","ã¤ã¶ã‚ã‚“","ã©ã‚‰ç„¼ã","ã¿ãŸã‚‰ã—å›£å­","ã‚ˆã†ã‹ã‚“ï¼ˆç·´ã‚Šï¼‰","ã‚ã‚‰ã³é¤…ï¼ˆé»’èœœããªã“ï¼‰","ã‚«ã‚¹ãƒ†ãƒ©","å¤§ç¦é¤…","æœ€ä¸­ï¼ˆã‚‚ãªã‹ï¼‰","æŸé¤…","æ¡œé¤…ï¼ˆé–¢æ±é¢¨ï¼‰","æ°´ã‚ˆã†ã‹ã‚“","ç™½ç‰å›£å­","è‰é¤…ï¼ˆã‚ˆã‚‚ãé¤…ï¼‰","è–¯è•·ã¾ã‚“ã˜ã‚…ã†"]
        };

        const CATEGORY_EMOJI = { "è‚‰é¡":"ğŸ¥©","é­šä»‹é¡":"ğŸŸ","åµé¡":"ğŸ¥š","ä¸»é£Ÿ":"ğŸš","é‡èœé¡":"ğŸ¥¦","ä¹³è£½å“":"ğŸ§€","è±†é¡ãƒ»ãƒŠãƒƒãƒ„":"ğŸ¥œ","æœç‰©é¡":"ğŸ","ã‚µãƒ—ãƒªãƒ¡ãƒ³ãƒˆ":"ğŸ’Š","ãƒ‰ãƒªãƒ³ã‚¯":"ğŸ¥¤","èª¿å‘³æ–™":"ğŸ§‚","å’Œè“å­":"ğŸ¡" };

        // ========== ExerciseDatabaseï¼ˆã‚«ãƒ†ã‚´ãƒªä»˜ãï¼‰ ==========
        const EXERCISE_DATABASE = {
            "èƒ¸": ["ãƒãƒ¼ãƒ™ãƒ«ãƒ™ãƒ³ãƒãƒ—ãƒ¬ã‚¹","ãƒ€ãƒ³ãƒ™ãƒ«ãƒ™ãƒ³ãƒãƒ—ãƒ¬ã‚¹","ã‚¤ãƒ³ã‚¯ãƒ©ã‚¤ãƒ³ãƒ™ãƒ³ãƒãƒ—ãƒ¬ã‚¹","ãƒ€ãƒ³ãƒ™ãƒ«ãƒ•ãƒ©ã‚¤","è…•ç«‹ã¦ä¼ã›"],
            "èƒŒä¸­": ["ãƒ‡ãƒƒãƒ‰ãƒªãƒ•ãƒˆ","æ‡¸å‚ï¼ˆãƒãƒ³ãƒ‹ãƒ³ã‚°ï¼‰","ãƒ©ãƒƒãƒˆãƒ—ãƒ«ãƒ€ã‚¦ãƒ³","ãƒ™ãƒ³ãƒˆã‚ªãƒ¼ãƒãƒ¼ãƒ­ã‚¦"],
            "è‚©": ["ã‚ªãƒ¼ãƒãƒ¼ãƒ˜ãƒƒãƒ‰ãƒ—ãƒ¬ã‚¹","ã‚µã‚¤ãƒ‰ãƒ¬ã‚¤ã‚º","ãƒ•ãƒ­ãƒ³ãƒˆãƒ¬ã‚¤ã‚º","ãƒªã‚¢ãƒ‡ãƒ«ãƒˆãƒ•ãƒ©ã‚¤"],
            "è…•": ["ãƒãƒ¼ãƒ™ãƒ«ã‚«ãƒ¼ãƒ«","ãƒ€ãƒ³ãƒ™ãƒ«ã‚«ãƒ¼ãƒ«","ãƒˆãƒ©ã‚¤ã‚»ãƒ—ã‚¹ã‚¨ã‚¯ã‚¹ãƒ†ãƒ³ã‚·ãƒ§ãƒ³"],
            "è„š": ["ãƒãƒ¼ãƒ™ãƒ«ã‚¹ã‚¯ãƒ¯ãƒƒãƒˆ","ãƒ¬ãƒƒã‚°ãƒ—ãƒ¬ã‚¹","ãƒ©ãƒ³ã‚¸","ãƒ¬ãƒƒã‚°ã‚¨ã‚¯ã‚¹ãƒ†ãƒ³ã‚·ãƒ§ãƒ³","ãƒ¬ãƒƒã‚°ã‚«ãƒ¼ãƒ«","ã‚«ãƒ¼ãƒ•ãƒ¬ã‚¤ã‚º"],
            "ä½“å¹¹": ["ãƒ—ãƒ©ãƒ³ã‚¯","ã‚¯ãƒ©ãƒ³ãƒ","ãƒ¬ãƒƒã‚°ãƒ¬ã‚¤ã‚º"],
            "æœ‰é…¸ç´ ": ["ãƒ©ãƒ³ãƒ‹ãƒ³ã‚°","ã‚¦ã‚©ãƒ¼ã‚­ãƒ³ã‚°","ã‚µã‚¤ã‚¯ãƒªãƒ³ã‚°","æ°´æ³³","HIIT"],
            "ã‚¹ãƒˆãƒ¬ãƒƒãƒ": ["é™çš„ã‚¹ãƒˆãƒ¬ãƒƒãƒ","å‹•çš„ã‚¹ãƒˆãƒ¬ãƒƒãƒ","ãƒ¨ã‚¬"]
        };
        const EXERCISE_EMOJI = { "èƒ¸":"ğŸ’ª","èƒŒä¸­":"ğŸ”™","è‚©":"ğŸ‹ï¸","è…•":"ğŸ’ª","è„š":"ğŸ¦µ","ä½“å¹¹":"ğŸ§˜","æœ‰é…¸ç´ ":"ğŸƒ","ã‚¹ãƒˆãƒ¬ãƒƒãƒ":"ğŸ§˜â€â™€ï¸" };
        const EXERCISE_UNITS = ["ã‚»ãƒƒãƒˆ","å›","åˆ†","km","m"];

        // é£Ÿå“100gã‚ãŸã‚Šã®å…¨æ „é¤Šç´ ï¼ˆFoodDatabase.ktå…«è¨‚æº–æ‹ å€¤ã¨åŒæœŸï¼‰
        function r1(v) { return Math.round(v * 10) / 10; }
        function r2(v) { return Math.round(v * 100) / 100; }
        function scaleMap(map, coeff) {
            if (!map) return {};
            const result = {};
            for (const [k, v] of Object.entries(map)) { result[k] = r2((v || 0) * coeff); }
            return result;
        }
        const FOOD_NUTRIENTS_PER_100G = {
            "é¶ã‚€ã­è‚‰ï¼ˆçš®ãªã—ç”Ÿï¼‰": { calories: 108, protein: 23.3, fat: 1.9, carbs: 0, fiber: 0, solubleFiber: 0, insolubleFiber: 0, sugar: 0, saturatedFat: 0.47, monounsaturatedFat: 0.63, polyunsaturatedFat: 0.36, diaas: 1.08, gi: 0, vitamins: { vitaminA: 6, vitaminB1: 0.1, vitaminB2: 0.11, vitaminB6: 0.64, vitaminB12: 0.2, vitaminC: 0, vitaminD: 0.1, vitaminE: 0.2, vitaminK: 6, niacin: 12.2, pantothenicAcid: 1.8, biotin: 4.5, folicAcid: 12 }, minerals: { sodium: 46, potassium: 380, calcium: 4, magnesium: 31, phosphorus: 230, iron: 0.3, zinc: 0.7, copper: 0.04, manganese: 0.01, iodine: 0, selenium: 28, chromium: 0, molybdenum: 0 } },
            "é¶ã‚€ã­è‚‰ï¼ˆçš®ã¤ãç”Ÿï¼‰": { calories: 133, protein: 21.3, fat: 5.9, carbs: 0, fiber: 0, solubleFiber: 0, insolubleFiber: 0, sugar: 0, saturatedFat: 1.53, monounsaturatedFat: 2.67, polyunsaturatedFat: 1.03, diaas: 1.07, gi: 0, vitamins: { vitaminA: 13, vitaminB1: 0.1, vitaminB2: 0.12, vitaminB6: 0.6, vitaminB12: 0.3, vitaminC: 0, vitaminD: 0.1, vitaminE: 0.3, vitaminK: 8, niacin: 11, pantothenicAcid: 1.6, biotin: 4.2, folicAcid: 13 }, minerals: { sodium: 52, potassium: 360, calcium: 4, magnesium: 29, phosphorus: 210, iron: 0.3, zinc: 0.7, copper: 0.04, manganese: 0.01, iodine: 0, selenium: 26, chromium: 0, molybdenum: 0 } },
            "é¶ã‚‚ã‚‚è‚‰ï¼ˆçš®ãªã—ç”Ÿï¼‰": { calories: 113, protein: 19, fat: 5, carbs: 0, fiber: 0, solubleFiber: 0, insolubleFiber: 0, sugar: 0, saturatedFat: 1.38, monounsaturatedFat: 2.06, polyunsaturatedFat: 0.71, diaas: 1.05, gi: 0, vitamins: { vitaminA: 18, vitaminB1: 0.1, vitaminB2: 0.18, vitaminB6: 0.25, vitaminB12: 0.3, vitaminC: 0, vitaminD: 0.2, vitaminE: 0.3, vitaminK: 17, niacin: 6.5, pantothenicAcid: 1.8, biotin: 4.5, folicAcid: 12 }, minerals: { sodium: 68, potassium: 340, calcium: 5, magnesium: 26, phosphorus: 180, iron: 0.6, zinc: 1.6, copper: 0.04, manganese: 0.01, iodine: 0, selenium: 21, chromium: 0, molybdenum: 0 } },
            "é¶ã‚‚ã‚‚è‚‰ï¼ˆçš®ã¤ãç”Ÿï¼‰": { calories: 190, protein: 16.6, fat: 14.2, carbs: 0, fiber: 0, solubleFiber: 0, insolubleFiber: 0, sugar: 0, saturatedFat: 4.37, monounsaturatedFat: 6.71, polyunsaturatedFat: 1.85, diaas: 1.05, gi: 0, vitamins: { vitaminA: 22, vitaminB1: 0.09, vitaminB2: 0.16, vitaminB6: 0.23, vitaminB12: 0.3, vitaminC: 0, vitaminD: 0.2, vitaminE: 0.4, vitaminK: 19, niacin: 5.7, pantothenicAcid: 1.7, biotin: 4.3, folicAcid: 11 }, minerals: { sodium: 75, potassium: 290, calcium: 6, magnesium: 22, phosphorus: 160, iron: 0.7, zinc: 1.7, copper: 0.05, manganese: 0.01, iodine: 0, selenium: 19, chromium: 0, molybdenum: 0 } },
            "é¶ã•ã•ã¿ï¼ˆç”Ÿï¼‰": { calories: 98, protein: 23.9, fat: 0.8, carbs: 0, fiber: 0, solubleFiber: 0, insolubleFiber: 0, sugar: 0, saturatedFat: 0.17, monounsaturatedFat: 0.22, polyunsaturatedFat: 0.13, diaas: 1.09, gi: 0, vitamins: { vitaminA: 6, vitaminB1: 0.11, vitaminB2: 0.11, vitaminB6: 0.6, vitaminB12: 0.3, vitaminC: 0, vitaminD: 0.1, vitaminE: 0.2, vitaminK: 7, niacin: 12, pantothenicAcid: 2, biotin: 5, folicAcid: 13 }, minerals: { sodium: 49, potassium: 410, calcium: 3, magnesium: 31, phosphorus: 240, iron: 0.2, zinc: 0.5, copper: 0.03, manganese: 0.01, iodine: 0, selenium: 30, chromium: 0, molybdenum: 0 } },
            "ç‰›ã‚‚ã‚‚è‚‰ï¼ˆè„‚èº«ã¤ãç”Ÿï¼‰": { calories: 165, protein: 20.5, fat: 9.6, carbs: 0.5, fiber: 0, solubleFiber: 0, insolubleFiber: 0, sugar: 0, saturatedFat: 3.22, monounsaturatedFat: 3.69, polyunsaturatedFat: 0.25, diaas: 1.11, gi: 0, vitamins: { vitaminA: 3, vitaminB1: 0.08, vitaminB2: 0.19, vitaminB6: 0.38, vitaminB12: 1.3, vitaminC: 1, vitaminD: 0, vitaminE: 0.4, vitaminK: 5, niacin: 5.4, pantothenicAcid: 0.86, biotin: 2, folicAcid: 9 }, minerals: { sodium: 48, potassium: 340, calcium: 4, magnesium: 22, phosphorus: 170, iron: 2.5, zinc: 4.2, copper: 0.07, manganese: 0.01, iodine: 0, selenium: 15, chromium: 0, molybdenum: 0 } },
            "ç‰›ã²ãè‚‰ï¼ˆç”Ÿï¼‰": { calories: 224, protein: 19, fat: 17, carbs: 0.3, fiber: 0, solubleFiber: 0, insolubleFiber: 0, sugar: 0, saturatedFat: 7.25, monounsaturatedFat: 11.06, polyunsaturatedFat: 0.63, diaas: 1.1, gi: 0, vitamins: { vitaminA: 4, vitaminB1: 0.07, vitaminB2: 0.16, vitaminB6: 0.32, vitaminB12: 1.2, vitaminC: 1, vitaminD: 0, vitaminE: 0.4, vitaminK: 6, niacin: 4.5, pantothenicAcid: 0.75, biotin: 1.8, folicAcid: 8 }, minerals: { sodium: 46, potassium: 290, calcium: 5, magnesium: 19, phosphorus: 150, iron: 2.2, zinc: 4, copper: 0.06, manganese: 0.01, iodine: 0, selenium: 14, chromium: 0, molybdenum: 0 } },
            "è±šãƒ­ãƒ¼ã‚¹ï¼ˆè„‚èº«ã¤ãç”Ÿï¼‰": { calories: 248, protein: 19.3, fat: 19.2, carbs: 0.2, fiber: 0, solubleFiber: 0, insolubleFiber: 0, sugar: 0, saturatedFat: 7.84, monounsaturatedFat: 7.68, polyunsaturatedFat: 2.21, diaas: 1.05, gi: 0, vitamins: { vitaminA: 5, vitaminB1: 0.6, vitaminB2: 0.15, vitaminB6: 0.32, vitaminB12: 0.3, vitaminC: 1, vitaminD: 0.1, vitaminE: 0.3, vitaminK: 2, niacin: 6.7, pantothenicAcid: 1.1, biotin: 2.5, folicAcid: 2 }, minerals: { sodium: 48, potassium: 310, calcium: 4, magnesium: 22, phosphorus: 170, iron: 0.3, zinc: 1.9, copper: 0.06, manganese: 0.01, iodine: 0, selenium: 18, chromium: 0, molybdenum: 0 } },
            "è±šã‚‚ã‚‚è‚‰ï¼ˆè„‚èº«ã¤ãç”Ÿï¼‰": { calories: 171, protein: 20.5, fat: 10.2, carbs: 0.2, fiber: 0, solubleFiber: 0, insolubleFiber: 0, sugar: 0, saturatedFat: 3.59, monounsaturatedFat: 4.24, polyunsaturatedFat: 1.24, diaas: 1.05, gi: 0, vitamins: { vitaminA: 4, vitaminB1: 0.72, vitaminB2: 0.19, vitaminB6: 0.36, vitaminB12: 0.3, vitaminC: 1, vitaminD: 0.1, vitaminE: 0.3, vitaminK: 2, niacin: 7.5, pantothenicAcid: 1.28, biotin: 2.8, folicAcid: 3 }, minerals: { sodium: 51, potassium: 340, calcium: 4, magnesium: 25, phosphorus: 190, iron: 0.4, zinc: 2.2, copper: 0.07, manganese: 0.01, iodine: 0, selenium: 20, chromium: 0, molybdenum: 0 } },
            "è±šã²ãè‚‰ï¼ˆç”Ÿï¼‰": { calories: 209, protein: 18.8, fat: 15.1, carbs: 0, fiber: 0, solubleFiber: 0, insolubleFiber: 0, sugar: 0, saturatedFat: 6.24, monounsaturatedFat: 7.55, polyunsaturatedFat: 1.62, diaas: 1.05, gi: 0, vitamins: { vitaminA: 5, vitaminB1: 0.62, vitaminB2: 0.16, vitaminB6: 0.3, vitaminB12: 0.3, vitaminC: 1, vitaminD: 0.1, vitaminE: 0.3, vitaminK: 2, niacin: 6.5, pantothenicAcid: 1.15, biotin: 2.6, folicAcid: 2 }, minerals: { sodium: 47, potassium: 300, calcium: 4, magnesium: 21, phosphorus: 160, iron: 0.6, zinc: 2, copper: 0.06, manganese: 0.01, iodine: 0, selenium: 18, chromium: 0, molybdenum: 0 } },
            "ãƒ©ãƒ è‚‰ï¼ˆã‚‚ã‚‚è„‚èº«ã¤ãç”Ÿï¼‰": { calories: 198, protein: 20, fat: 14.1, carbs: 0.2, fiber: 0, solubleFiber: 0, insolubleFiber: 0, sugar: 0, saturatedFat: 4.91, monounsaturatedFat: 4.39, polyunsaturatedFat: 0.52, diaas: 1.09, gi: 0, vitamins: { vitaminA: 3, vitaminB1: 0.13, vitaminB2: 0.23, vitaminB6: 0.28, vitaminB12: 2.5, vitaminC: 1, vitaminD: 0, vitaminE: 0.3, vitaminK: 6, niacin: 5.8, pantothenicAcid: 0.85, biotin: 2, folicAcid: 8 }, minerals: { sodium: 50, potassium: 310, calcium: 5, magnesium: 22, phosphorus: 170, iron: 1.5, zinc: 3.6, copper: 0.1, manganese: 0.02, iodine: 0, selenium: 16, chromium: 0, molybdenum: 0 } },
            "é®­ï¼ˆç”Ÿï¼‰": { calories: 124, protein: 22.3, fat: 4.1, carbs: 0.1, fiber: 0, solubleFiber: 0, insolubleFiber: 0, sugar: 0, saturatedFat: 0.8, monounsaturatedFat: 1.69, polyunsaturatedFat: 1.01, diaas: 1.03, gi: 0, vitamins: { vitaminA: 11, vitaminB1: 0.15, vitaminB2: 0.21, vitaminB6: 0.64, vitaminB12: 5.9, vitaminC: 1, vitaminD: 32, vitaminE: 1.2, vitaminK: 0, niacin: 6.7, pantothenicAcid: 1.5, biotin: 7.5, folicAcid: 26 }, minerals: { sodium: 47, potassium: 350, calcium: 14, magnesium: 28, phosphorus: 240, iron: 0.5, zinc: 0.5, copper: 0.07, manganese: 0.01, iodine: 0, selenium: 38, chromium: 0, molybdenum: 0 } },
            "ã¾ãã‚èµ¤èº«ï¼ˆç”Ÿï¼‰": { calories: 98, protein: 26, fat: 0.7, carbs: 0.2, fiber: 0, solubleFiber: 0, insolubleFiber: 0, sugar: 0, saturatedFat: 0.15, monounsaturatedFat: 0.19, polyunsaturatedFat: 0.23, diaas: 1.04, gi: 0, vitamins: { vitaminA: 3, vitaminB1: 0.08, vitaminB2: 0.04, vitaminB6: 0.94, vitaminB12: 1.2, vitaminC: 0, vitaminD: 3, vitaminE: 0.3, vitaminK: 0, niacin: 16, pantothenicAcid: 0.18, biotin: 2.8, folicAcid: 4 }, minerals: { sodium: 47, potassium: 440, calcium: 4, magnesium: 42, phosphorus: 290, iron: 0.8, zinc: 0.3, copper: 0.03, manganese: 0.01, iodine: 16, selenium: 120, chromium: 0, molybdenum: 0 } },
            "ã•ã°ï¼ˆç”Ÿï¼‰": { calories: 211, protein: 20.6, fat: 16.8, carbs: 0.3, fiber: 0, solubleFiber: 0, insolubleFiber: 0, sugar: 0, saturatedFat: 4.57, monounsaturatedFat: 5.03, polyunsaturatedFat: 2.66, diaas: 1.02, gi: 0, vitamins: { vitaminA: 13, vitaminB1: 0.21, vitaminB2: 0.29, vitaminB6: 0.51, vitaminB12: 10.6, vitaminC: 1, vitaminD: 11, vitaminE: 1.6, vitaminK: 5, niacin: 10.4, pantothenicAcid: 0.7, biotin: 6, folicAcid: 12 }, minerals: { sodium: 130, potassium: 360, calcium: 9, magnesium: 30, phosphorus: 220, iron: 1.2, zinc: 1.1, copper: 0.11, manganese: 0.01, iodine: 28, selenium: 52, chromium: 0, molybdenum: 0 } },
            "ãˆã³ï¼ˆãƒãƒŠãƒ¡ã‚¤ç”Ÿï¼‰": { calories: 77, protein: 18.1, fat: 0.4, carbs: 0.1, fiber: 0, solubleFiber: 0, insolubleFiber: 0, sugar: 0, saturatedFat: 0.08, monounsaturatedFat: 0.04, polyunsaturatedFat: 0.16, diaas: 0.98, gi: 0, vitamins: { vitaminA: 0, vitaminB1: 0.01, vitaminB2: 0.02, vitaminB6: 0.04, vitaminB12: 1.2, vitaminC: 0, vitaminD: 0, vitaminE: 1.4, vitaminK: 0, niacin: 2, pantothenicAcid: 0.35, biotin: 1.3, folicAcid: 7 }, minerals: { sodium: 220, potassium: 240, calcium: 42, magnesium: 34, phosphorus: 180, iron: 0.2, zinc: 1.2, copper: 0.35, manganese: 0.03, iodine: 0, selenium: 35, chromium: 0, molybdenum: 0 } },
            "é¶åµ Mï¼ˆ58gï¼‰": { calories: 141, protein: 12.2, fat: 10.2, carbs: 0.3, fiber: 0, solubleFiber: 0, insolubleFiber: 0, sugar: 0, saturatedFat: 3.29, monounsaturatedFat: 4.62, polyunsaturatedFat: 1.45, diaas: 1.13, gi: 0, vitamins: { vitaminA: 150, vitaminB1: 0.07, vitaminB2: 0.43, vitaminB6: 0.09, vitaminB12: 1.21, vitaminC: 0, vitaminD: 1.72, vitaminE: 1.03, vitaminK: 13.8, niacin: 0.1, pantothenicAcid: 1.5, biotin: 25, folicAcid: 48.3 }, minerals: { sodium: 141, potassium: 129, calcium: 50, magnesium: 10, phosphorus: 172, iron: 1.72, zinc: 1.38, copper: 0.07, manganese: 0.02, iodine: 17, selenium: 33, chromium: 0, molybdenum: 3.4 } },
            "é¶åµ Lï¼ˆ64gï¼‰": { calories: 142, protein: 12.2, fat: 10.2, carbs: 0.5, fiber: 0, solubleFiber: 0, insolubleFiber: 0, sugar: 0, saturatedFat: 3.3, monounsaturatedFat: 4.6, polyunsaturatedFat: 1.44, diaas: 1.13, gi: 0, vitamins: { vitaminA: 150, vitaminB1: 0, vitaminB2: 0.28, vitaminB6: 0, vitaminB12: 0.8, vitaminC: 0, vitaminD: 1.2, vitaminE: 0.6, vitaminK: 0, niacin: 0, pantothenicAcid: 0, biotin: 0, folicAcid: 31 }, minerals: { sodium: 0, potassium: 0, calcium: 0, magnesium: 0, phosphorus: 0, iron: 1.2, zinc: 0.9, copper: 0, manganese: 0, iodine: 0, selenium: 21, chromium: 0, molybdenum: 0 } },
            "ã‚†ã§åµ Mï¼ˆ58gï¼‰": { calories: 134, protein: 12.6, fat: 10.3, carbs: 0.3, fiber: 0, solubleFiber: 0, insolubleFiber: 0, sugar: 0, saturatedFat: 3.34, monounsaturatedFat: 4.69, polyunsaturatedFat: 1.47, diaas: 1.13, gi: 0, vitamins: { vitaminA: 145, vitaminB1: 0, vitaminB2: 0.41, vitaminB6: 0, vitaminB12: 1.21, vitaminC: 0, vitaminD: 1.72, vitaminE: 1.03, vitaminK: 0, niacin: 0, pantothenicAcid: 0, biotin: 0, folicAcid: 45 }, minerals: { sodium: 0, potassium: 0, calcium: 0, magnesium: 0, phosphorus: 0, iron: 1.72, zinc: 1.38, copper: 0, manganese: 0, iodine: 0, selenium: 33, chromium: 0, molybdenum: 0 } },
            "ã†ãšã‚‰åµ æ°´ç…®ï¼ˆ1å€‹12gï¼‰": { calories: 150, protein: 12.5, fat: 11.7, carbs: 0.3, fiber: 0, solubleFiber: 0, insolubleFiber: 0, sugar: 0, saturatedFat: 3.75, monounsaturatedFat: 4.67, polyunsaturatedFat: 1.5, diaas: 1.12, gi: 0, vitamins: { vitaminA: 333, vitaminB1: 0, vitaminB2: 0.67, vitaminB6: 0, vitaminB12: 5, vitaminC: 0, vitaminD: 6.67, vitaminE: 0.83, vitaminK: 0, niacin: 0, pantothenicAcid: 0, biotin: 0, folicAcid: 83 }, minerals: { sodium: 0, potassium: 0, calcium: 0, magnesium: 0, phosphorus: 0, iron: 3.33, zinc: 1.67, copper: 0, manganese: 0, iodine: 0, selenium: 0, chromium: 0, molybdenum: 0 } },
            "ç™½ç±³ï¼ˆç‚Šé£¯ç›´å¾Œï¼‰": { calories: 168, protein: 2.5, fat: 0.3, carbs: 37.1, fiber: 0.3, solubleFiber: 0, insolubleFiber: 0.3, sugar: 36.8, saturatedFat: 0, monounsaturatedFat: 0, polyunsaturatedFat: 0, diaas: 0.59, gi: 88, vitamins: { vitaminA: 0, vitaminB1: 0.02, vitaminB2: 0.01, vitaminB6: 0.02, vitaminB12: 0, vitaminC: 0, vitaminD: 0, vitaminE: 0, vitaminK: 0, niacin: 0.2, pantothenicAcid: 0.25, biotin: 0.5, folicAcid: 3 }, minerals: { sodium: 1, potassium: 29, calcium: 3, magnesium: 7, phosphorus: 34, iron: 0.1, zinc: 0.6, copper: 0.1, manganese: 0.35, iodine: 0, selenium: 1, chromium: 0, molybdenum: 30 } },
            "ç„ç±³ï¼ˆç‚Šé£¯ç›´å¾Œï¼‰": { calories: 152, protein: 2.8, fat: 1, carbs: 35.6, fiber: 1.4, solubleFiber: 0.2, insolubleFiber: 1.2, sugar: 34.2, saturatedFat: 0, monounsaturatedFat: 0, polyunsaturatedFat: 0, diaas: 0.62, gi: 56, vitamins: { vitaminA: 0, vitaminB1: 0.16, vitaminB2: 0.02, vitaminB6: 0.21, vitaminB12: 0, vitaminC: 0, vitaminD: 0, vitaminE: 0.5, vitaminK: 0, niacin: 2.9, pantothenicAcid: 0.65, biotin: 2.5, folicAcid: 10 }, minerals: { sodium: 1, potassium: 95, calcium: 7, magnesium: 49, phosphorus: 130, iron: 0.6, zinc: 0.8, copper: 0.12, manganese: 1.04, iodine: 0, selenium: 1, chromium: 0, molybdenum: 34 } },
            "ã‚‚ã¡éº¦ã”ã¯ã‚“ï¼ˆç‚Šé£¯ç›´å¾Œï¼‰": { calories: 143, protein: 2.7, fat: 0.5, carbs: 33.2, fiber: 2.3, solubleFiber: 1.3, insolubleFiber: 1.0, sugar: 30.9, saturatedFat: 0.1, monounsaturatedFat: 0.15, polyunsaturatedFat: 0.2, diaas: 0.5, gi: 48, vitamins: { vitaminA: 0, vitaminB1: 0.06, vitaminB2: 0.01, vitaminB6: 0.03, vitaminB12: 0, vitaminC: 0, vitaminD: 0, vitaminE: 0, vitaminK: 0, niacin: 0.4, pantothenicAcid: 0.3, biotin: 0.5, folicAcid: 4 }, minerals: { sodium: 1, potassium: 35, calcium: 3, magnesium: 12, phosphorus: 40, iron: 0.3, zinc: 0.5, copper: 0.08, manganese: 0.3, iodine: 0, selenium: 1, chromium: 0, molybdenum: 20 } },
            "é£Ÿãƒ‘ãƒ³ï¼ˆ6æšåˆ‡ã‚Šï¼‰": { calories: 248, protein: 8.9, fat: 4.1, carbs: 44.3, fiber: 2.1, solubleFiber: 0.4, insolubleFiber: 1.7, sugar: 42.2, saturatedFat: 0, monounsaturatedFat: 0, polyunsaturatedFat: 0, diaas: 0.42, gi: 91, vitamins: { vitaminA: 0, vitaminB1: 0.07, vitaminB2: 0.05, vitaminB6: 0.03, vitaminB12: 0, vitaminC: 0, vitaminD: 0, vitaminE: 0.4, vitaminK: 0, niacin: 1.1, pantothenicAcid: 0.42, biotin: 2.3, folicAcid: 30 }, minerals: { sodium: 470, potassium: 86, calcium: 22, magnesium: 18, phosphorus: 67, iron: 0.5, zinc: 0.5, copper: 0.09, manganese: 0.25, iodine: 1, selenium: 22, chromium: 1, molybdenum: 15 } },
            "é¤…ï¼ˆåˆ‡ã‚Šé¤…ï¼‰": { calories: 223, protein: 4, fat: 0.6, carbs: 50.8, fiber: 0.5, solubleFiber: 0, insolubleFiber: 0.5, sugar: 50.3, saturatedFat: 0, monounsaturatedFat: 0, polyunsaturatedFat: 0, diaas: 0.59, gi: 85, vitamins: { vitaminA: 0, vitaminB1: 0.03, vitaminB2: 0.01, vitaminB6: 0.03, vitaminB12: 0, vitaminC: 0, vitaminD: 0, vitaminE: 0, vitaminK: 0, niacin: 0.2, pantothenicAcid: 0.34, biotin: 0.6, folicAcid: 4 }, minerals: { sodium: 0, potassium: 32, calcium: 3, magnesium: 6, phosphorus: 22, iron: 0.1, zinc: 0.9, copper: 0.13, manganese: 0.58, iodine: 0, selenium: 2, chromium: 0, molybdenum: 56 } },
            "10å‰²ãã°ï¼ˆã‚†ã§ï¼‰": { calories: 136, protein: 4.8, fat: 1.2, carbs: 27.8, fiber: 1.8, solubleFiber: 0.6, insolubleFiber: 1.2, sugar: 26, saturatedFat: 0, monounsaturatedFat: 0, polyunsaturatedFat: 0, diaas: 0.95, gi: 54, vitamins: { vitaminA: 0, vitaminB1: 0.18, vitaminB2: 0.04, vitaminB6: 0.12, vitaminB12: 0, vitaminC: 0, vitaminD: 0, vitaminE: 2.9, vitaminK: 0, niacin: 1.8, pantothenicAcid: 0.62, biotin: 6.8, folicAcid: 20 }, minerals: { sodium: 1, potassium: 164, calcium: 7, magnesium: 76, phosphorus: 160, iron: 1.1, zinc: 1, copper: 0.22, manganese: 0.44, iodine: 0, selenium: 3, chromium: 2, molybdenum: 19 } },
            "ã•ã¤ã¾ã„ã‚‚ï¼ˆç„¼ãï¼‰": { calories: 126, protein: 1.2, fat: 0.2, carbs: 31.9, fiber: 2.2, solubleFiber: 0.5, insolubleFiber: 1.7, sugar: 0.6, saturatedFat: 0, monounsaturatedFat: 0, polyunsaturatedFat: 0, diaas: 0.51, gi: 55, vitamins: { vitaminA: 3, vitaminB1: 0.1, vitaminB2: 0.02, vitaminB6: 0.2, vitaminB12: 0, vitaminC: 25, vitaminD: 0, vitaminE: 1, vitaminK: 0, niacin: 0.6, pantothenicAcid: 0.48, biotin: 4.8, folicAcid: 49 }, minerals: { sodium: 23, potassium: 380, calcium: 40, magnesium: 24, phosphorus: 46, iron: 0.5, zinc: 0.2, copper: 0.13, manganese: 0.37, iodine: 1, selenium: 0, chromium: 0, molybdenum: 5 } },
            "ã˜ã‚ƒãŒã„ã‚‚ï¼ˆç”Ÿï¼‰": { calories: 59, protein: 1.8, fat: 0.1, carbs: 17.3, fiber: 1.8, solubleFiber: 1.2, insolubleFiber: 0.6, sugar: 0.9, saturatedFat: 0, monounsaturatedFat: 0, polyunsaturatedFat: 0, diaas: 0.63, gi: 90, vitamins: { vitaminA: 0, vitaminB1: 0.09, vitaminB2: 0.03, vitaminB6: 0.2, vitaminB12: 0, vitaminC: 28, vitaminD: 0, vitaminE: 0, vitaminK: 1, niacin: 1.5, pantothenicAcid: 0.5, biotin: 0.4, folicAcid: 20 }, minerals: { sodium: 1, potassium: 410, calcium: 4, magnesium: 19, phosphorus: 47, iron: 0.4, zinc: 0.2, copper: 0.09, manganese: 0.37, iodine: 1, selenium: 0, chromium: 4, molybdenum: 3 } },
            "æœ¨ç¶¿è±†è…": { calories: 73, protein: 7, fat: 4.9, carbs: 0.4, fiber: 0.2, solubleFiber: 0, insolubleFiber: 0.2, sugar: 0.2, saturatedFat: 0.68, monounsaturatedFat: 1.01, polyunsaturatedFat: 2.71, diaas: 0.82, gi: 0, vitamins: { vitaminA: 0, vitaminB1: 0.09, vitaminB2: 0.04, vitaminB6: 0.05, vitaminB12: 0, vitaminC: 0, vitaminD: 0, vitaminE: 0.2, vitaminK: 6, niacin: 0.2, pantothenicAcid: 0.02, biotin: 4.1, folicAcid: 12 }, minerals: { sodium: 9, potassium: 110, calcium: 93, magnesium: 57, phosphorus: 88, iron: 1.5, zinc: 0.6, copper: 0.16, manganese: 0.41, iodine: 6, selenium: 4, chromium: 4, molybdenum: 44 } },
            "çµ¹ã”ã—è±†è…": { calories: 56, protein: 5.3, fat: 3.5, carbs: 2, fiber: 0.3, solubleFiber: 0.1, insolubleFiber: 0.2, sugar: 1.7, saturatedFat: 0.49, monounsaturatedFat: 0.72, polyunsaturatedFat: 1.94, diaas: 0.82, gi: 0, vitamins: { vitaminA: 0, vitaminB1: 0.11, vitaminB2: 0.04, vitaminB6: 0.06, vitaminB12: 0, vitaminC: 0, vitaminD: 0, vitaminE: 3.4, vitaminK: 9, niacin: 0.2, pantothenicAcid: 0.09, biotin: 3.5, folicAcid: 12 }, minerals: { sodium: 11, potassium: 150, calcium: 75, magnesium: 50, phosphorus: 68, iron: 1.2, zinc: 0.5, copper: 0.16, manganese: 0.34, iodine: 1, selenium: 1, chromium: 1, molybdenum: 69 } },
            "ç´è±†ï¼ˆç³¸å¼•ãï¼‰": { calories: 200, protein: 16.5, fat: 10, carbs: 12.1, fiber: 6.7, solubleFiber: 2.3, insolubleFiber: 4.4, sugar: 5.4, saturatedFat: 1.54, monounsaturatedFat: 2.36, polyunsaturatedFat: 5.46, diaas: 0.9, gi: 33, vitamins: { vitaminA: 0, vitaminB1: 0.07, vitaminB2: 0.56, vitaminB6: 0.24, vitaminB12: 0, vitaminC: 0, vitaminD: 0, vitaminE: 0.5, vitaminK: 600, niacin: 1.1, pantothenicAcid: 3.6, biotin: 18.2, folicAcid: 120 }, minerals: { sodium: 2, potassium: 660, calcium: 90, magnesium: 100, phosphorus: 190, iron: 3.3, zinc: 1.9, copper: 0.61, manganese: 0, iodine: 0, selenium: 16, chromium: 1, molybdenum: 290 } },
            "ãƒãƒŠãƒŠ": { calories: 93, protein: 1.1, fat: 0.2, carbs: 22.5, fiber: 1.1, solubleFiber: 0.1, insolubleFiber: 1.0, sugar: 21.4, saturatedFat: 0.07, monounsaturatedFat: 0.04, polyunsaturatedFat: 0.05, diaas: 0.5, gi: 51, vitamins: { vitaminA: 5, vitaminB1: 0.05, vitaminB2: 0.04, vitaminB6: 0.38, vitaminB12: 0, vitaminC: 16, vitaminD: 0, vitaminE: 0.5, vitaminK: 0, niacin: 0.7, pantothenicAcid: 0.44, biotin: 1.4, folicAcid: 26 }, minerals: { sodium: 0, potassium: 360, calcium: 6, magnesium: 32, phosphorus: 27, iron: 0.3, zinc: 0.2, copper: 0.09, manganese: 0.26, iodine: 0, selenium: 1, chromium: 0, molybdenum: 0 } },
            "ã‚Šã‚“ã”": { calories: 56, protein: 0.2, fat: 0.2, carbs: 16.2, fiber: 1.9, solubleFiber: 0.5, insolubleFiber: 1.4, sugar: 14.3, saturatedFat: 0, monounsaturatedFat: 0, polyunsaturatedFat: 0, diaas: 1.0, gi: 36, vitamins: { vitaminA: 1, vitaminB1: 0.02, vitaminB2: 0, vitaminB6: 0.04, vitaminB12: 0, vitaminC: 4, vitaminD: 0, vitaminE: 0.1, vitaminK: 0, niacin: 0.1, pantothenicAcid: 0.03, biotin: 0.5, folicAcid: 2 }, minerals: { sodium: 0, potassium: 120, calcium: 3, magnesium: 3, phosphorus: 12, iron: 0.1, zinc: 0, copper: 0.05, manganese: 0.02, iodine: 0, selenium: 0, chromium: 1, molybdenum: 0 } },
            "ã‚¢ãƒœã‚«ãƒ‰": { calories: 178, protein: 2.5, fat: 17.5, carbs: 7.9, fiber: 5.6, solubleFiber: 1.7, insolubleFiber: 3.9, sugar: 0.8, saturatedFat: 0, monounsaturatedFat: 0, polyunsaturatedFat: 0, diaas: 0.65, gi: 27, vitamins: { vitaminA: 7, vitaminB1: 0.09, vitaminB2: 0.2, vitaminB6: 0.29, vitaminB12: 0, vitaminC: 12, vitaminD: 0, vitaminE: 3.3, vitaminK: 21, niacin: 2.3, pantothenicAcid: 1.65, biotin: 5.3, folicAcid: 83 }, minerals: { sodium: 7, potassium: 590, calcium: 8, magnesium: 34, phosphorus: 52, iron: 0.6, zinc: 0.7, copper: 0.24, manganese: 0.19, iodine: 0, selenium: 1, chromium: 0, molybdenum: 2 } },
            "ãƒ–ãƒ­ãƒƒã‚³ãƒªãƒ¼ï¼ˆç”Ÿï¼‰": { calories: 37, protein: 5.4, fat: 0.6, carbs: 6.6, fiber: 5.1, solubleFiber: 0.9, insolubleFiber: 4.2, sugar: 1.3, saturatedFat: 0.1, monounsaturatedFat: 0, polyunsaturatedFat: 0.2, diaas: 0.8, gi: 25, vitamins: { vitaminA: 810, vitaminB1: 0.14, vitaminB2: 0.23, vitaminB6: 0.27, vitaminB12: 0, vitaminC: 140, vitaminD: 0, vitaminE: 3, vitaminK: 210, niacin: 1.2, pantothenicAcid: 1.42, biotin: 9.3, folicAcid: 220 }, minerals: { sodium: 7, potassium: 460, calcium: 50, magnesium: 29, phosphorus: 110, iron: 1.3, zinc: 0.8, copper: 0.1, manganese: 0.28, iodine: 0, selenium: 2, chromium: 1, molybdenum: 16 } },
            "ã»ã†ã‚Œã‚“è‰ï¼ˆç”Ÿï¼‰": { calories: 18, protein: 2.2, fat: 0.4, carbs: 3.1, fiber: 2.7, solubleFiber: 0.7, insolubleFiber: 2, sugar: 0.4, saturatedFat: 0, monounsaturatedFat: 0, polyunsaturatedFat: 0, diaas: 0.5, gi: 15, vitamins: { vitaminA: 350, vitaminB1: 0.11, vitaminB2: 0.2, vitaminB6: 0.14, vitaminB12: 0, vitaminC: 35, vitaminD: 0, vitaminE: 2.1, vitaminK: 270, niacin: 0.6, pantothenicAcid: 0.2, biotin: 2.9, folicAcid: 210 }, minerals: { sodium: 16, potassium: 690, calcium: 49, magnesium: 69, phosphorus: 47, iron: 2, zinc: 0.7, copper: 0.11, manganese: 0.32, iodine: 3, selenium: 3, chromium: 2, molybdenum: 5 } },
            "ãƒ¨ãƒ¼ã‚°ãƒ«ãƒˆï¼ˆãƒ—ãƒ¬ãƒ¼ãƒ³ï¼‰": { calories: 56, protein: 3.6, fat: 3, carbs: 4.9, fiber: 0, solubleFiber: 0, insolubleFiber: 0, sugar: 0, saturatedFat: 1.83, monounsaturatedFat: 0.69, polyunsaturatedFat: 0.1, diaas: 1.22, gi: 0, vitamins: { vitaminA: 33, vitaminB1: 0.04, vitaminB2: 0.14, vitaminB6: 0.04, vitaminB12: 0.1, vitaminC: 1, vitaminD: 0, vitaminE: 0.1, vitaminK: 1, niacin: 0.1, pantothenicAcid: 0.49, biotin: 2.5, folicAcid: 11 }, minerals: { sodium: 48, potassium: 170, calcium: 120, magnesium: 12, phosphorus: 100, iron: 0.02, zinc: 0.4, copper: 0.01, manganese: 0, iodine: 15, selenium: 3, chromium: 0, molybdenum: 4 } },
            "ã‚®ãƒªã‚·ãƒ£ãƒ¨ãƒ¼ã‚°ãƒ«ãƒˆ": { calories: 59, protein: 10, fat: 0.4, carbs: 3.9, fiber: 0, solubleFiber: 0, insolubleFiber: 0, sugar: 0, saturatedFat: 0.24, monounsaturatedFat: 0.09, polyunsaturatedFat: 0.01, diaas: 1.22, gi: 0, vitamins: { vitaminA: 1, vitaminB1: 0.03, vitaminB2: 0.14, vitaminB6: 0.04, vitaminB12: 0.5, vitaminC: 0, vitaminD: 0, vitaminE: 0, vitaminK: 0, niacin: 0.1, pantothenicAcid: 0.4, biotin: 4.2, folicAcid: 7 }, minerals: { sodium: 36, potassium: 150, calcium: 100, magnesium: 11, phosphorus: 130, iron: 0.01, zinc: 0.5, copper: 0.01, manganese: 0, iodine: 12, selenium: 5, chromium: 0, molybdenum: 5 } },
            "ä½è„‚è‚ªç‰›ä¹³": { calories: 42, protein: 3.4, fat: 1, carbs: 5.2, fiber: 0, solubleFiber: 0, insolubleFiber: 0, sugar: 0, saturatedFat: 0.61, monounsaturatedFat: 0.23, polyunsaturatedFat: 0.03, diaas: 1.22, gi: 39, vitamins: { vitaminA: 15, vitaminB1: 0.04, vitaminB2: 0.17, vitaminB6: 0.03, vitaminB12: 0.3, vitaminC: 1, vitaminD: 0.3, vitaminE: 0.05, vitaminK: 1, niacin: 0.1, pantothenicAcid: 0.6, biotin: 2, folicAcid: 5 }, minerals: { sodium: 46, potassium: 160, calcium: 120, magnesium: 11, phosphorus: 100, iron: 0.01, zinc: 0.4, copper: 0.01, manganese: 0, iodine: 17, selenium: 3, chromium: 0, molybdenum: 4 } },
            "ç„¡è„‚è‚ªç‰›ä¹³": { calories: 33, protein: 3.4, fat: 0.1, carbs: 5, fiber: 0, solubleFiber: 0, insolubleFiber: 0, sugar: 0, saturatedFat: 0.06, monounsaturatedFat: 0.02, polyunsaturatedFat: 0, diaas: 1.22, gi: 37, vitamins: { vitaminA: 1, vitaminB1: 0.04, vitaminB2: 0.17, vitaminB6: 0.03, vitaminB12: 0.3, vitaminC: 1, vitaminD: 0, vitaminE: 0, vitaminK: 0, niacin: 0.1, pantothenicAcid: 0.62, biotin: 2.1, folicAcid: 5 }, minerals: { sodium: 47, potassium: 170, calcium: 125, magnesium: 12, phosphorus: 105, iron: 0, zinc: 0.4, copper: 0.01, manganese: 0, iodine: 18, selenium: 3, chromium: 0, molybdenum: 5 } },
            "ãƒ›ã‚¨ã‚¤ãƒ—ãƒ­ãƒ†ã‚¤ãƒ³": { calories: 400, protein: 80, fat: 3, carbs: 10, fiber: 0, solubleFiber: 0, insolubleFiber: 0, sugar: 3, saturatedFat: 1.5, monounsaturatedFat: 1, polyunsaturatedFat: 0.5, diaas: 1.09, gi: 0, vitamins: { vitaminA: 0, vitaminB1: 0.3, vitaminB2: 0.7, vitaminB6: 0.3, vitaminB12: 1.7, vitaminC: 0, vitaminD: 0, vitaminE: 0, vitaminK: 0, niacin: 0.3, pantothenicAcid: 1.7, biotin: 0, folicAcid: 0 }, minerals: { sodium: 330, potassium: 500, calcium: 400, magnesium: 67, phosphorus: 330, iron: 0.3, zinc: 1.7, copper: 0.03, manganese: 0, iodine: 0, selenium: 7, chromium: 0, molybdenum: 0 } },
            "ã‚«ã‚¼ã‚¤ãƒ³ãƒ—ãƒ­ãƒ†ã‚¤ãƒ³": { calories: 373, protein: 85, fat: 1, carbs: 3.7, fiber: 0, solubleFiber: 0, insolubleFiber: 0, sugar: 0, saturatedFat: 0, monounsaturatedFat: 0, polyunsaturatedFat: 0, diaas: 1.12, gi: 0, vitamins: { vitaminA: 0, vitaminB1: 0, vitaminB2: 1.7, vitaminB6: 0, vitaminB12: 2.67, vitaminC: 0, vitaminD: 0, vitaminE: 0, vitaminK: 0, niacin: 0, pantothenicAcid: 3.17, biotin: 0, folicAcid: 0 }, minerals: { sodium: 533, potassium: 433, calcium: 700, magnesium: 60, phosphorus: 467, iron: 0.67, zinc: 3.33, copper: 0.03, manganese: 0, iodine: 0, selenium: 10, chromium: 0, molybdenum: 0 } },
            "ã‚½ã‚¤ãƒ—ãƒ­ãƒ†ã‚¤ãƒ³": { calories: 360, protein: 80, fat: 3.7, carbs: 6, fiber: 0, solubleFiber: 0, insolubleFiber: 0, sugar: 0, saturatedFat: 0, monounsaturatedFat: 0, polyunsaturatedFat: 0, diaas: 0.9, gi: 0, vitamins: { vitaminA: 0, vitaminB1: 0.8, vitaminB2: 0.27, vitaminB6: 0.5, vitaminB12: 0, vitaminC: 0, vitaminD: 0, vitaminE: 1, vitaminK: 13.3, niacin: 1, pantothenicAcid: 0.67, biotin: 25, folicAcid: 240 }, minerals: { sodium: 3.3, potassium: 1900, calcium: 210, magnesium: 210, phosphorus: 550, iron: 8, zinc: 3, copper: 0.93, manganese: 0.8, iodine: 0, selenium: 6.67, chromium: 0, molybdenum: 250 } },
            "BCAA": { calories: 400, protein: 100, fat: 0, carbs: 0, fiber: 0, solubleFiber: 0, insolubleFiber: 0, sugar: 0, saturatedFat: 0, monounsaturatedFat: 0, polyunsaturatedFat: 0, diaas: 0, gi: 0, vitamins: { vitaminA: 0, vitaminB1: 0, vitaminB2: 0, vitaminB6: 0, vitaminB12: 0, vitaminC: 0, vitaminD: 0, vitaminE: 0, vitaminK: 0, niacin: 0, pantothenicAcid: 0, biotin: 0, folicAcid: 0 }, minerals: { sodium: 0, potassium: 0, calcium: 0, magnesium: 0, phosphorus: 0, iron: 0, zinc: 0, copper: 0, manganese: 0, iodine: 0, selenium: 0, chromium: 0, molybdenum: 0 } },
            "EAA": { calories: 400, protein: 100, fat: 0, carbs: 0, fiber: 0, solubleFiber: 0, insolubleFiber: 0, sugar: 0, saturatedFat: 0, monounsaturatedFat: 0, polyunsaturatedFat: 0, diaas: 0, gi: 0, vitamins: { vitaminA: 0, vitaminB1: 0, vitaminB2: 0, vitaminB6: 0, vitaminB12: 0, vitaminC: 0, vitaminD: 0, vitaminE: 0, vitaminK: 0, niacin: 0, pantothenicAcid: 0, biotin: 0, folicAcid: 0 }, minerals: { sodium: 0, potassium: 0, calcium: 0, magnesium: 0, phosphorus: 0, iron: 0, zinc: 0, copper: 0, manganese: 0, iodine: 0, selenium: 0, chromium: 0, molybdenum: 0 } },
            "ãƒãƒ«ãƒˆãƒ‡ã‚­ã‚¹ãƒˆãƒªãƒ³": { calories: 380, protein: 0, fat: 0, carbs: 95, fiber: 0, solubleFiber: 0, insolubleFiber: 0, sugar: 0, saturatedFat: 0, monounsaturatedFat: 0, polyunsaturatedFat: 0, diaas: 0, gi: 105, vitamins: { vitaminA: 0, vitaminB1: 0, vitaminB2: 0, vitaminB6: 0, vitaminB12: 0, vitaminC: 0, vitaminD: 0, vitaminE: 0, vitaminK: 0, niacin: 0, pantothenicAcid: 0, biotin: 0, folicAcid: 0 }, minerals: { sodium: 0, potassium: 0, calcium: 0, magnesium: 0, phosphorus: 0, iron: 0, zinc: 0, copper: 0, manganese: 0, iodine: 0, selenium: 0, chromium: 0, molybdenum: 0 } },
            "ã‚¯ãƒ¬ã‚¢ãƒãƒ³": { calories: 18, protein: 4.4, fat: 0, carbs: 0, fiber: 0, solubleFiber: 0, insolubleFiber: 0, sugar: 0, saturatedFat: 0, monounsaturatedFat: 0, polyunsaturatedFat: 0, diaas: 0, gi: 0, vitamins: { vitaminA: 0, vitaminB1: 0, vitaminB2: 0, vitaminB6: 0, vitaminB12: 0, vitaminC: 0, vitaminD: 0, vitaminE: 0, vitaminK: 0, niacin: 0, pantothenicAcid: 0, biotin: 0, folicAcid: 0 }, minerals: { sodium: 0, potassium: 0, calcium: 0, magnesium: 0, phosphorus: 0, iron: 0, zinc: 0, copper: 0, manganese: 0, iodine: 0, selenium: 0, chromium: 0, molybdenum: 0 } },
            "ã‚ªãƒ¼ãƒˆãƒŸãƒ¼ãƒ«": { calories: 350, protein: 13.7, fat: 5.7, carbs: 69.1, fiber: 9.4, solubleFiber: 3.2, insolubleFiber: 6.2, sugar: 59.7, saturatedFat: 0, monounsaturatedFat: 0, polyunsaturatedFat: 0, diaas: 0.75, gi: 55, vitamins: { vitaminA: 0, vitaminB1: 0.2, vitaminB2: 0.08, vitaminB6: 0.11, vitaminB12: 0, vitaminC: 0, vitaminD: 0, vitaminE: 0.6, vitaminK: 0, niacin: 1.1, pantothenicAcid: 1.29, biotin: 22, folicAcid: 30 }, minerals: { sodium: 3, potassium: 260, calcium: 47, magnesium: 100, phosphorus: 370, iron: 3.9, zinc: 2.1, copper: 0.28, manganese: 0, iodine: 0, selenium: 18, chromium: 0, molybdenum: 110 } },
            "ãã‚‹ã¿": { calories: 674, protein: 14.6, fat: 68.8, carbs: 11.7, fiber: 7.5, solubleFiber: 0.6, insolubleFiber: 6.9, sugar: 2.6, saturatedFat: 6.87, monounsaturatedFat: 10.26, polyunsaturatedFat: 50.28, diaas: 0.43, gi: 18, vitamins: { vitaminA: 2, vitaminB1: 0.26, vitaminB2: 0.15, vitaminB6: 0.49, vitaminB12: 0, vitaminC: 0, vitaminD: 0, vitaminE: 28, vitaminK: 7, niacin: 1, pantothenicAcid: 0.67, biotin: 0, folicAcid: 91 }, minerals: { sodium: 4, potassium: 540, calcium: 85, magnesium: 150, phosphorus: 280, iron: 2.6, zinc: 2.6, copper: 1.21, manganese: 3.44, iodine: 0, selenium: 0, chromium: 0, molybdenum: 0 } },
            "ã‚¢ãƒ¼ãƒ¢ãƒ³ãƒ‰": { calories: 587, protein: 20.3, fat: 51.8, carbs: 20.9, fiber: 11, solubleFiber: 1.1, insolubleFiber: 9.9, sugar: 4.8, saturatedFat: 3.95, monounsaturatedFat: 33.17, polyunsaturatedFat: 12.52, diaas: 0.52, gi: 30, vitamins: { vitaminA: 1, vitaminB1: 0.03, vitaminB2: 1.04, vitaminB6: 0.08, vitaminB12: 0, vitaminC: 0, vitaminD: 0, vitaminE: 29, vitaminK: 0, niacin: 3.9, pantothenicAcid: 0.26, biotin: 0, folicAcid: 48 }, minerals: { sodium: 0, potassium: 740, calcium: 260, magnesium: 310, phosphorus: 480, iron: 3.7, zinc: 3.7, copper: 1.19, manganese: 2.46, iodine: 0, selenium: 0, chromium: 0, molybdenum: 0 } },
            "ã‚ªãƒªãƒ¼ãƒ–ã‚ªã‚¤ãƒ«": { calories: 921, protein: 0, fat: 100, carbs: 0, fiber: 0, solubleFiber: 0, insolubleFiber: 0, sugar: 0, saturatedFat: 13.29, monounsaturatedFat: 74.04, polyunsaturatedFat: 7.24, diaas: 0, gi: 0, vitamins: { vitaminA: 15, vitaminB1: 0, vitaminB2: 0, vitaminB6: 0, vitaminB12: 0, vitaminC: 0, vitaminD: 0, vitaminE: 8.9, vitaminK: 42, niacin: 0, pantothenicAcid: 0, biotin: 0, folicAcid: 0 }, minerals: { sodium: 0, potassium: 0, calcium: 0, magnesium: 0, phosphorus: 0, iron: 0, zinc: 0, copper: 0, manganese: 0, iodine: 0, selenium: 0, chromium: 0, molybdenum: 0 } },
            "MCTã‚ªã‚¤ãƒ«": { calories: 900, protein: 0, fat: 100, carbs: 0, fiber: 0, solubleFiber: 0, insolubleFiber: 0, sugar: 0, saturatedFat: 0, monounsaturatedFat: 0, polyunsaturatedFat: 0, diaas: 0, gi: 0, vitamins: { vitaminA: 0, vitaminB1: 0, vitaminB2: 0, vitaminB6: 0, vitaminB12: 0, vitaminC: 0, vitaminD: 0, vitaminE: 0, vitaminK: 0, niacin: 0, pantothenicAcid: 0, biotin: 0, folicAcid: 0 }, minerals: { sodium: 0, potassium: 0, calcium: 0, magnesium: 0, phosphorus: 0, iron: 0, zinc: 0, copper: 0, manganese: 0, iodine: 0, selenium: 0, chromium: 0, molybdenum: 0 } },
            "ã¯ã¡ã¿ã¤": { calories: 329, protein: 0.3, fat: 0, carbs: 81.9, fiber: 0, solubleFiber: 0, insolubleFiber: 0, sugar: 0, saturatedFat: 0, monounsaturatedFat: 0, polyunsaturatedFat: 0, diaas: 0, gi: 58, vitamins: { vitaminA: 0, vitaminB1: 0, vitaminB2: 0.01, vitaminB6: 0.02, vitaminB12: 0, vitaminC: 0, vitaminD: 0, vitaminE: 0, vitaminK: 0, niacin: 0.3, pantothenicAcid: 0.12, biotin: 0.4, folicAcid: 7 }, minerals: { sodium: 2, potassium: 65, calcium: 4, magnesium: 2, phosphorus: 5, iron: 0.2, zinc: 0.1, copper: 0.04, manganese: 0.21, iodine: 0, selenium: 0, chromium: 1, molybdenum: 0 } },
            "ã¿ã‹ã‚“": { calories: 46, protein: 0.7, fat: 0.1, carbs: 12, fiber: 1, solubleFiber: 0.5, insolubleFiber: 0.5, sugar: 11, saturatedFat: 0.01, monounsaturatedFat: 0.02, polyunsaturatedFat: 0.02, diaas: 0.4, gi: 33, vitamins: { vitaminA: 84, vitaminB1: 0.1, vitaminB2: 0.03, vitaminB6: 0.06, vitaminB12: 0, vitaminC: 32, vitaminD: 0, vitaminE: 0.4, vitaminK: 0, niacin: 0.3, pantothenicAcid: 0.23, biotin: 0.5, folicAcid: 22 }, minerals: { sodium: 1, potassium: 150, calcium: 21, magnesium: 11, phosphorus: 15, iron: 0.2, zinc: 0.1, copper: 0.03, manganese: 0.03, iodine: 0, selenium: 0, chromium: 0, molybdenum: 0 } },
            "ã†ã©ã‚“ï¼ˆã‚†ã§ï¼‰": { calories: 95, protein: 2.6, fat: 0.4, carbs: 21.6, fiber: 0.8, solubleFiber: 0.2, insolubleFiber: 0.6, sugar: 20.8, saturatedFat: 0, monounsaturatedFat: 0, polyunsaturatedFat: 0, diaas: 0.39, gi: 80, vitamins: { vitaminA: 0, vitaminB1: 0.02, vitaminB2: 0.01, vitaminB6: 0.01, vitaminB12: 0, vitaminC: 0, vitaminD: 0, vitaminE: 0.1, vitaminK: 0, niacin: 0.2, pantothenicAcid: 0.13, biotin: 0.3, folicAcid: 2 }, minerals: { sodium: 120, potassium: 9, calcium: 6, magnesium: 6, phosphorus: 18, iron: 0.2, zinc: 0.1, copper: 0.04, manganese: 0.12, iodine: 0, selenium: 2, chromium: 1, molybdenum: 2 } },
            "ãã°ï¼ˆã‚†ã§ï¼‰": { calories: 130, protein: 4.8, fat: 0.7, carbs: 26, fiber: 2, solubleFiber: 0.8, insolubleFiber: 1.2, sugar: 24, saturatedFat: 0, monounsaturatedFat: 0, polyunsaturatedFat: 0, diaas: 0.87, gi: 59, vitamins: { vitaminA: 0, vitaminB1: 0.05, vitaminB2: 0.02, vitaminB6: 0.04, vitaminB12: 0, vitaminC: 0, vitaminD: 0, vitaminE: 0.1, vitaminK: 0, niacin: 0.5, pantothenicAcid: 0.33, biotin: 2.7, folicAcid: 8 }, minerals: { sodium: 2, potassium: 34, calcium: 9, magnesium: 27, phosphorus: 80, iron: 0.8, zinc: 0.4, copper: 0.1, manganese: 0.38, iodine: 0, selenium: 12, chromium: 2, molybdenum: 11 } },
        };

        // é£Ÿå“ã®å˜ä½â†’ã‚°ãƒ©ãƒ æ›ç®—ï¼ˆFoodDatabase.kt servingSizesã¨åŒæœŸï¼‰
        const FOOD_SERVING_SIZES = {
            "é¶åµ Mï¼ˆ58gï¼‰": { "å€‹": 58 },
            "é¶åµ Lï¼ˆ64gï¼‰": { "å€‹": 64 },
            "é¶åµ LLï¼ˆ70gï¼‰": { "å€‹": 70 },
            "é¶åµ Sï¼ˆ46gï¼‰": { "å€‹": 46 },
            "é¶åµ MSï¼ˆ50gï¼‰": { "å€‹": 50 },
            "ã‚†ã§åµ Mï¼ˆ58gï¼‰": { "å€‹": 58 },
            "æ¸©æ³‰åµ Mï¼ˆ58gï¼‰": { "å€‹": 58 },
            "ç›®ç‰ç„¼ã Mï¼ˆåµ58g+æ²¹3gï¼‰": { "å€‹": 61 },
            "ã†ãšã‚‰åµ æ°´ç…®ï¼ˆ1å€‹12gï¼‰": { "å€‹": 12 },
            "ã†ãšã‚‰åµï¼ˆ1å€‹10gï¼‰": { "å€‹": 10 },
            "ç™½ç±³ï¼ˆç‚Šé£¯ç›´å¾Œï¼‰": { "æ¯": 150 },
            "ç„ç±³ï¼ˆç‚Šé£¯ç›´å¾Œï¼‰": { "æ¯": 150 },
            "ã‚‚ã¡éº¦ã”ã¯ã‚“ï¼ˆç‚Šé£¯ç›´å¾Œï¼‰": { "æ¯": 150 },
            "é£Ÿãƒ‘ãƒ³ï¼ˆ6æšåˆ‡ã‚Šï¼‰": { "æš": 60 },
            "é¤…ï¼ˆåˆ‡ã‚Šé¤…ï¼‰": { "å€‹": 50 },
            "æœ¨ç¶¿è±†è…": { "ä¸": 300 },
            "çµ¹ã”ã—è±†è…": { "ä¸": 300 },
            "ç´è±†ï¼ˆç³¸å¼•ãï¼‰": { "ãƒ‘ãƒƒã‚¯": 45 },
            "ãƒãƒŠãƒŠ": { "æœ¬": 100 },
            "ã‚Šã‚“ã”": { "å€‹": 250 },
            "ã‚¢ãƒœã‚«ãƒ‰": { "å€‹": 140 },
            "ã•ã¤ã¾ã„ã‚‚ï¼ˆç„¼ãï¼‰": { "æœ¬": 200 },
            "ã˜ã‚ƒãŒã„ã‚‚ï¼ˆç”Ÿï¼‰": { "å€‹": 150 },
            "ãƒ¨ãƒ¼ã‚°ãƒ«ãƒˆï¼ˆãƒ—ãƒ¬ãƒ¼ãƒ³ï¼‰": { "å€‹": 100 },
            "ã‚®ãƒªã‚·ãƒ£ãƒ¨ãƒ¼ã‚°ãƒ«ãƒˆ": { "å€‹": 100 },
            "ä½è„‚è‚ªç‰›ä¹³": { "ml": 1, "æ¯": 200 },
            "ç„¡è„‚è‚ªç‰›ä¹³": { "ml": 1, "æ¯": 200 },
            "BCAA": { "æ¯": 5 },
            "EAA": { "æ¯": 4 },
            "ã‚«ã‚¼ã‚¤ãƒ³ãƒ—ãƒ­ãƒ†ã‚¤ãƒ³": { "æ¯": 30 },
            "ã‚½ã‚¤ãƒ—ãƒ­ãƒ†ã‚¤ãƒ³": { "æ¯": 30 },
            "ãƒãƒ«ãƒˆãƒ‡ã‚­ã‚¹ãƒˆãƒªãƒ³": { "æ¯": 30 },
            "ãƒ›ã‚¨ã‚¤ãƒ—ãƒ­ãƒ†ã‚¤ãƒ³": { "æ¯": 30 },
            "ã¿ã‹ã‚“": { "å€‹": 80 },
            "ã†ã©ã‚“ï¼ˆã‚†ã§ï¼‰": { "ç‰": 200 },
            "ãã°ï¼ˆã‚†ã§ï¼‰": { "ç‰": 170 },
            "10å‰²ãã°ï¼ˆã‚†ã§ï¼‰": { "ç‰": 170 },
            "é¶ã‚€ã­è‚‰ï¼ˆçš®ã¤ãç”Ÿï¼‰": { "æš": 250 },
            "é¶ã‚€ã­è‚‰ï¼ˆçš®ãªã—ç”Ÿï¼‰": { "æš": 250 },
            "ãƒ”ãƒ³ã‚¯ã‚½ãƒ«ãƒˆï¼ˆãƒ’ãƒãƒ©ãƒ¤å²©å¡©ï¼‰": { "å°ã•ã˜": 5 },
            "MCTã‚ªã‚¤ãƒ«": { "å¤§ã•ã˜": 13 },
            "ãˆã”ã¾æ²¹": { "å¤§ã•ã˜": 12 },
            "ã”ã¾æ²¹": { "å¤§ã•ã˜": 12 },
            "ã¯ã¡ã¿ã¤": { "å¤§ã•ã˜": 21 },
            "ã¿ã‚Šã‚“": { "å¤§ã•ã˜": 18 },
            "ã‚ã‚“ã¤ã‚†ï¼ˆ3å€æ¿ƒç¸®ï¼‰": { "å¤§ã•ã˜": 15 },
            "ã‚¢ãƒãƒ‹æ²¹": { "å¤§ã•ã˜": 12 },
            "ã‚ªã‚¤ã‚¹ã‚¿ãƒ¼ã‚½ãƒ¼ã‚¹": { "å¤§ã•ã˜": 18 },
            "ã‚ªãƒªãƒ¼ãƒ–ã‚ªã‚¤ãƒ«": { "å¤§ã•ã˜": 12 },
            "ã‚°ãƒ©ãƒ‹ãƒ¥ãƒ¼ç³–": { "å¤§ã•ã˜": 12 },
            "ã‚±ãƒãƒ£ãƒƒãƒ—": { "å¤§ã•ã˜": 15 },
            "ã‚³ã‚³ãƒŠãƒƒãƒ„ã‚ªã‚¤ãƒ«": { "å¤§ã•ã˜": 12 },
            "ãƒã‚¿ãƒ¼": { "å¤§ã•ã˜": 12 },
            "ãƒãƒ³é…¢": { "å¤§ã•ã˜": 15 },
            "ãƒãƒ¨ãƒãƒ¼ã‚º": { "å¤§ã•ã˜": 12 },
            "ãƒ¡ãƒ¼ãƒ—ãƒ«ã‚·ãƒ­ãƒƒãƒ—": { "å¤§ã•ã˜": 21 },
            "ä¸‰æ¸©ç³–": { "å¤§ã•ã˜": 9 },
            "ä¸Šç™½ç³–": { "å¤§ã•ã˜": 9 },
            "å‘³å™Œï¼ˆæ·¡è‰²è¾›ã¿ãï¼‰": { "å¤§ã•ã˜": 18 },
            "å‘³å™Œï¼ˆèµ¤è‰²è¾›ã¿ãï¼‰": { "å¤§ã•ã˜": 18 },
            "æ–™ç†é…’": { "å¤§ã•ã˜": 15 },
            "æ¿ƒå£é†¤æ²¹": { "å¤§ã•ã˜": 18 },
            "ç„¡å¡©ãƒã‚¿ãƒ¼": { "å¤§ã•ã˜": 12 },
            "ç±³æ²¹": { "å¤§ã•ã˜": 12 },
            "ç±³é…¢": { "å¤§ã•ã˜": 15 },
            "ç²—å¡©": { "å°ã•ã˜": 5 },
            "è–„å£é†¤æ²¹": { "å¤§ã•ã˜": 18 },
            "è±†æ¿é†¤": { "å°ã•ã˜": 6 },
            "é»’ç³–": { "å¤§ã•ã˜": 9 },
            "é»’é…¢": { "å¤§ã•ã˜": 15 },
        };

        // ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚¢ã‚¤ãƒ†ãƒ ä¸€æ™‚ä¿æŒ
        let templateItems = [];
        let selectedFoodCategory = 'all';

        function isWorkoutMode() {
            return document.getElementById('cq-tpl-type').value === 'WORKOUT';
        }

        function onTemplateTypeChange() {
            const workout = isWorkoutMode();
            const catTabs = document.getElementById('cq-category-tabs');
            const unitSelect = document.getElementById('cq-tpl-food-unit');
            const label = document.getElementById('cq-tpl-item-label');

            if (workout) {
                // é‹å‹•ã‚«ãƒ†ã‚´ãƒªã‚¿ãƒ–ã«åˆ‡æ›¿
                label.textContent = 'ç¨®ç›®å';
                catTabs.innerHTML = `<button onclick="setFoodCategory('all')" class="cq-cat-btn cq-cat-active" data-cat="all">ã™ã¹ã¦</button>` +
                    Object.keys(EXERCISE_DATABASE).map(cat =>
                        `<button onclick="setFoodCategory('${cat}')" class="cq-cat-btn" data-cat="${cat}">${EXERCISE_EMOJI[cat]||''} ${cat}</button>`
                    ).join('');
                unitSelect.innerHTML = EXERCISE_UNITS.map(u => `<option value="${u}">${u}</option>`).join('');
            } else {
                // é£Ÿäº‹ã‚«ãƒ†ã‚´ãƒªã‚¿ãƒ–ã«æˆ»ã™
                label.textContent = 'é£Ÿå“å';
                catTabs.innerHTML = `<button onclick="setFoodCategory('all')" class="cq-cat-btn cq-cat-active" data-cat="all">ã™ã¹ã¦</button>` +
                    Object.keys(FOOD_DATABASE).map(cat =>
                        `<button onclick="setFoodCategory('${cat}')" class="cq-cat-btn" data-cat="${cat}">${CATEGORY_EMOJI[cat]||''} ${cat.replace('è±†é¡ãƒ»ãƒŠãƒƒãƒ„','è±†é¡').replace('ã‚µãƒ—ãƒªãƒ¡ãƒ³ãƒˆ','ã‚µãƒ—ãƒª')}</button>`
                    ).join('');
                unitSelect.innerHTML = ['g','å€‹','ml','æ¯','æš','æœ¬','ä¸','ç²’'].map(u => `<option value="${u}">${u}</option>`).join('');
            }
            selectedFoodCategory = 'all';
            document.getElementById('cq-tpl-food-search').value = '';
            document.getElementById('cq-tpl-food-search').placeholder = workout ? 'ç¨®ç›®åã§æ¤œç´¢...' : 'é£Ÿå“åã§æ¤œç´¢...';
            filterFoodList();
        }

        function setFoodCategory(cat) {
            selectedFoodCategory = cat;
            document.querySelectorAll('.cq-cat-btn').forEach(btn => {
                btn.classList.toggle('cq-cat-active', btn.getAttribute('data-cat') === cat);
            });
            filterFoodList();
            document.getElementById('cq-food-dropdown').classList.remove('hidden');
        }

        function getItemDatabase() {
            return isWorkoutMode() ? EXERCISE_DATABASE : FOOD_DATABASE;
        }

        function getItemEmoji() {
            return isWorkoutMode() ? EXERCISE_EMOJI : CATEGORY_EMOJI;
        }

        function getFoodList() {
            const db = getItemDatabase();
            if (selectedFoodCategory === 'all') {
                const result = [];
                for (const [cat, items] of Object.entries(db)) {
                    items.forEach(f => result.push({ name: f, category: cat }));
                }
                return result;
            } else {
                return (db[selectedFoodCategory] || []).map(f => ({ name: f, category: selectedFoodCategory }));
            }
        }

        function showFoodDropdown() {
            filterFoodList();
            document.getElementById('cq-food-dropdown').classList.remove('hidden');
        }

        function filterFoodList() {
            const query = document.getElementById('cq-tpl-food-search').value.trim().toLowerCase();
            const dropdown = document.getElementById('cq-food-dropdown');
            const allFoods = getFoodList();
            const emojiMap = getItemEmoji();
            const filtered = query
                ? allFoods.filter(f => f.name.toLowerCase().includes(query))
                : allFoods;

            if (filtered.length === 0) {
                dropdown.innerHTML = '<div class="px-3 py-2 text-gray-400 text-sm">è©²å½“ãªã—</div>';
            } else {
                let html = '';
                let lastCat = '';
                const items = filtered.slice(0, 80);
                items.forEach(f => {
                    if (f.category !== lastCat) {
                        lastCat = f.category;
                        const emoji = emojiMap[f.category] || '';
                        html += `<div class="px-3 py-1 text-xs font-bold text-gray-500 bg-gray-100 sticky top-0">${emoji} ${f.category}</div>`;
                    }
                    html += `<div class="px-3 py-1.5 text-sm cursor-pointer hover:bg-yellow-50" onmousedown="selectFood('${escapeHtml(f.name)}')">${escapeHtml(f.name)}</div>`;
                });
                if (filtered.length > 80) {
                    html += '<div class="px-3 py-2 text-xs text-gray-400">...ä»– ' + (filtered.length - 80) + ' ä»¶</div>';
                }
                dropdown.innerHTML = html;
            }
            dropdown.classList.remove('hidden');
        }

        function selectFood(name) {
            document.getElementById('cq-tpl-food-search').value = name;
            document.getElementById('cq-food-dropdown').classList.add('hidden');

            // å˜ä½ã¨ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆé‡ã‚’è‡ªå‹•è¨­å®š
            const serving = FOOD_SERVING_SIZES[name];
            const unitSelect = document.getElementById('cq-tpl-food-unit');
            const amountInput = document.getElementById('cq-tpl-food-amount');
            if (serving) {
                const defaultUnit = Object.keys(serving)[0];
                unitSelect.value = defaultUnit;
                amountInput.value = defaultUnit === 'g' ? '100' : '1';
            } else {
                unitSelect.value = 'g';
                amountInput.value = '100';
            }
            amountInput.focus();
        }

        function addTemplateItem() {
            const foodName = document.getElementById('cq-tpl-food-search').value.trim();
            const amount = parseFloat(document.getElementById('cq-tpl-food-amount').value);
            const unit = document.getElementById('cq-tpl-food-unit').value;

            if (!foodName) { alert('é£Ÿå“ã‚’é¸æŠã—ã¦ãã ã•ã„'); return; }
            if (!amount || amount <= 0) { alert('é‡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }

            // ã‚°ãƒ©ãƒ æ›ç®— â†’ ratioè¨ˆç®— â†’ ãƒã‚¯ãƒ­ç®—å‡º
            let grams = amount;
            if (unit !== 'g') {
                const serving = FOOD_SERVING_SIZES[foodName];
                if (serving && serving[unit]) {
                    grams = amount * serving[unit];
                }
            }
            const ratio = grams / 100;
            const nutrients = FOOD_NUTRIENTS_PER_100G[foodName];
            let item = { foodName, amount, unit, calories: 0, protein: 0, fat: 0, carbs: 0,
                fiber: 0, solubleFiber: 0, insolubleFiber: 0, sugar: 0,
                saturatedFat: 0, monounsaturatedFat: 0, polyunsaturatedFat: 0,
                diaas: 0, gi: 0, vitamins: {}, minerals: {} };
            if (nutrients) {
                item.calories = Math.round(nutrients.calories * ratio);
                item.protein = r1(nutrients.protein * ratio);
                item.fat = r1(nutrients.fat * ratio);
                item.carbs = r1(nutrients.carbs * ratio);
                item.fiber = r1((nutrients.fiber || 0) * ratio);
                item.solubleFiber = r1((nutrients.solubleFiber || 0) * ratio);
                item.insolubleFiber = r1((nutrients.insolubleFiber || 0) * ratio);
                item.sugar = r1((nutrients.sugar || 0) * ratio);
                item.saturatedFat = r2((nutrients.saturatedFat || 0) * ratio);
                item.monounsaturatedFat = r2((nutrients.monounsaturatedFat || 0) * ratio);
                item.polyunsaturatedFat = r2((nutrients.polyunsaturatedFat || 0) * ratio);
                item.diaas = nutrients.diaas || 0;
                item.gi = nutrients.gi || 0;
                item.vitamins = scaleMap(nutrients.vitamins || {}, ratio);
                item.minerals = scaleMap(nutrients.minerals || {}, ratio);
            }

            templateItems.push(item);
            renderTemplateItems();

            // å…¥åŠ›æ¬„ãƒªã‚»ãƒƒãƒˆ
            document.getElementById('cq-tpl-food-search').value = '';
            document.getElementById('cq-tpl-food-amount').value = '';
            document.getElementById('cq-tpl-food-search').focus();
        }

        function removeTemplateItem(index) {
            templateItems.splice(index, 1);
            renderTemplateItems();
        }

        function renderTemplateItems() {
            const container = document.getElementById('cq-tpl-item-list');
            if (templateItems.length === 0) {
                container.innerHTML = '<span class="text-gray-400">ã‚¢ã‚¤ãƒ†ãƒ ã‚’è¿½åŠ ã—ã¦ãã ã•ã„</span>';
                return;
            }
            let html = templateItems.map((item, i) =>
                `<div class="flex items-center justify-between py-1 px-2 rounded ${i % 2 === 0 ? 'bg-yellow-50' : ''}">
                    <span class="text-sm"><strong>${escapeHtml(item.foodName)}</strong> â€” ${item.amount} ${escapeHtml(item.unit)}
                    ${item.calories > 0 ? `<span class="text-xs text-gray-500 ml-1">(${item.calories}kcal P${item.protein} F${item.fat} C${item.carbs})</span>` : ''}</span>
                    <button onclick="removeTemplateItem(${i})" class="text-red-400 hover:text-red-600 text-xs ml-2">âœ•</button>
                </div>`
            ).join('');
            // åˆè¨ˆè¡¨ç¤º
            const totals = templateItems.reduce((acc, item) => ({
                calories: acc.calories + (item.calories || 0),
                protein: acc.protein + (item.protein || 0),
                fat: acc.fat + (item.fat || 0),
                carbs: acc.carbs + (item.carbs || 0),
                fiber: acc.fiber + (item.fiber || 0),
                iron: acc.iron + ((item.minerals || {}).iron || 0),
                calcium: acc.calcium + ((item.minerals || {}).calcium || 0),
                vitD: acc.vitD + ((item.vitamins || {}).vitaminD || 0),
                vitC: acc.vitC + ((item.vitamins || {}).vitaminC || 0)
            }), { calories: 0, protein: 0, fat: 0, carbs: 0, fiber: 0, iron: 0, calcium: 0, vitD: 0, vitC: 0 });
            html += `<div class="mt-2 pt-2 border-t border-gray-200 text-sm font-bold text-gray-700">
                åˆè¨ˆ: ${totals.calories}kcal ï½œ P${r1(totals.protein)}g F${r1(totals.fat)}g C${r1(totals.carbs)}g
                <span class="text-xs font-normal text-gray-500 ml-2">ç¹Šç¶­${r1(totals.fiber)}g é‰„${r2(totals.iron)}mg Ca${r1(totals.calcium)}mg VitD${r1(totals.vitD)}Î¼g VitC${r1(totals.vitC)}mg</span>
            </div>`;
            container.innerHTML = html;
        }

        // ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã‚’é–‰ã˜ã‚‹ï¼ˆå¤–å´ã‚¯ãƒªãƒƒã‚¯ï¼‰
        document.addEventListener('click', function(e) {
            const search = document.getElementById('cq-tpl-food-search');
            const dropdown = document.getElementById('cq-food-dropdown');
            if (search && dropdown && !search.contains(e.target) && !dropdown.contains(e.target)) {
                dropdown.classList.add('hidden');
            }
        });

        async function createTemplate() {
            const title = document.getElementById('cq-tpl-title').value.trim();
            const type = document.getElementById('cq-tpl-type').value;

            if (!title) { alert('ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆåã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
            if (templateItems.length === 0) { alert('ã‚¢ã‚¤ãƒ†ãƒ ã‚’1ã¤ä»¥ä¸Šè¿½åŠ ã—ã¦ãã ã•ã„'); return; }

            try {
                const currentUser = auth.currentUser;
                const totals = templateItems.reduce((acc, item) => {
                    acc.calories += (item.calories || 0);
                    acc.protein += (item.protein || 0);
                    acc.fat += (item.fat || 0);
                    acc.carbs += (item.carbs || 0);
                    acc.fiber += (item.fiber || 0);
                    const iv = item.vitamins || {};
                    const im = item.minerals || {};
                    for (const k of Object.keys(iv)) { acc.vitamins[k] = (acc.vitamins[k] || 0) + (iv[k] || 0); }
                    for (const k of Object.keys(im)) { acc.minerals[k] = (acc.minerals[k] || 0) + (im[k] || 0); }
                    return acc;
                }, { calories: 0, protein: 0, fat: 0, carbs: 0, fiber: 0, vitamins: {}, minerals: {} });
                // round vitamin/mineral totals
                const roundedVitamins = {}; for (const [k,v] of Object.entries(totals.vitamins)) { roundedVitamins[k] = r2(v); }
                const roundedMinerals = {}; for (const [k,v] of Object.entries(totals.minerals)) { roundedMinerals[k] = r2(v); }
                await db.collection('quest_templates').add({
                    ownerId: currentUser.uid,
                    title: title,
                    type: type,
                    items: templateItems.map(i => ({ ...i })),
                    totalMacros: { protein: r1(totals.protein), fat: r1(totals.fat), carbs: r1(totals.carbs), calories: totals.calories, fiber: r1(totals.fiber), vitamins: roundedVitamins, minerals: roundedMinerals },
                    isActive: true,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                document.getElementById('cq-tpl-message').innerHTML = '<span class="text-green-600">âœ… ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’ä¿å­˜ã—ã¾ã—ãŸ</span>';
                document.getElementById('cq-tpl-title').value = '';
                templateItems = [];
                renderTemplateItems();
                await loadTemplates();
            } catch (e) {
                document.getElementById('cq-tpl-message').innerHTML = '<span class="text-red-500">âŒ ã‚¨ãƒ©ãƒ¼: ' + e.message + '</span>';
            }
        }

        async function loadTemplates() {
            try {
                const snapshot = await db.collection('quest_templates').where('isActive', '==', true).get();
                const templates = [];
                snapshot.forEach(doc => {
                    templates.push({ id: doc.id, ...doc.data() });
                });
                // ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã§ã‚½ãƒ¼ãƒˆï¼ˆè¤‡åˆã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ä¸è¦ï¼‰
                templates.sort((a, b) => {
                    const aTime = a.createdAt?.toMillis ? a.createdAt.toMillis() : 0;
                    const bTime = b.createdAt?.toMillis ? b.createdAt.toMillis() : 0;
                    return bTime - aTime;
                });
                document.getElementById('cq-template-count').textContent = templates.length;

                // ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆé¸æŠè‚¢ã‚’æ›´æ–°
                const select = document.getElementById('cq-assign-template');
                select.innerHTML = '<option value="">-- ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’é¸æŠ --</option>';
                templates.forEach(t => {
                    select.innerHTML += `<option value="${t.id}">${escapeHtml(t.title)} (${t.type})</option>`;
                });

                if (templates.length === 0) {
                    document.getElementById('cq-template-list').innerHTML = '<p class="text-gray-400">ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãŒã‚ã‚Šã¾ã›ã‚“</p>';
                    return;
                }

                let html = '<div class="space-y-3">';
                templates.forEach(t => {
                    const typeBadge = t.type === 'MEAL'
                        ? '<span class="bg-green-100 text-green-800 text-xs px-2 py-1 rounded-full">ğŸ½ é£Ÿäº‹</span>'
                        : '<span class="bg-blue-100 text-blue-800 text-xs px-2 py-1 rounded-full">ğŸ’ª é‹å‹•</span>';
                    const items = (t.items || []).map(i => `${i.foodName} ${i.amount}${i.unit}`).join(', ');
                    html += `<div class="p-3 border border-yellow-200 bg-yellow-50 rounded-lg">
                        <div class="flex items-center justify-between">
                            <div>
                                <span class="font-bold">${escapeHtml(t.title)}</span> ${typeBadge}
                            </div>
                            <button onclick="deleteTemplate('${t.id}')" class="text-xs text-red-500 hover:text-red-700">å‰Šé™¤</button>
                        </div>
                        <div class="text-sm text-gray-600 mt-1">${escapeHtml(items)}</div>
                    </div>`;
                });
                html += '</div>';
                document.getElementById('cq-template-list').innerHTML = html;
            } catch (e) {
                document.getElementById('cq-template-list').innerHTML = '<p class="text-red-500">èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: ' + e.message + '</p>';
            }
        }

        async function deleteTemplate(templateId) {
            if (!confirm('ã“ã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
            try {
                await db.collection('quest_templates').doc(templateId).update({ isActive: false });
                await loadTemplates();
            } catch (e) {
                alert('ã‚¨ãƒ©ãƒ¼: ' + e.message);
            }
        }

        // ========== è‡ªå‹•ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°ç”¨è¨ˆç®— ==========
        function calculateUserTargetCalories(profile) {
            const weight = profile.weight || 70;
            const bodyFatPct = profile.bodyFatPercentage || 15;
            const activityLevel = profile.activityLevel || 'MODERATE';
            const goal = profile.goal || 'MAINTAIN';
            const trainingDays = profile.trainingDaysPerWeek || 3;

            const fatMass = weight * (bodyFatPct / 100);
            const lbm = weight - fatMass;
            const bmr = 370 + (21.6 * lbm) + (fatMass * 4.5);

            const activityMultipliers = {
                'SEDENTARY': 1.2, 'LIGHT': 1.375, 'MODERATE': 1.55,
                'ACTIVE': 1.725, 'VERY_ACTIVE': 1.9
            };
            const tdee = bmr * (activityMultipliers[activityLevel] || 1.55);

            const goalAdjustments = {
                'LOSE_FAST': -750, 'LOSE': -500, 'LOSE_SLOW': -250,
                'MAINTAIN': 0, 'GAIN_SLOW': 250, 'GAIN': 500
            };
            const calorieAdjustment = goalAdjustments[goal] || 0;
            const trainingBonus = (trainingDays >= 4) ? 100 : 0;

            return Math.round(tdee + calorieAdjustment + trainingBonus);
        }

        function calculateSlotTargetCalories(profile, slotKey, totalCalories) {
            const mealSlotConfig = profile.mealSlotConfig || {};
            const slots = mealSlotConfig.slots || [];
            const mealsPerDay = mealSlotConfig.mealsPerDay || profile.mealsPerDay || 3;

            // ãƒˆãƒ¬å‰å¾Œã®å›ºå®šPFCã‚«ãƒ­ãƒªãƒ¼ã‚’ç®—å‡º
            let preWorkoutCals = 0, postWorkoutCals = 0;
            const prePFC = profile.preWorkoutMacros || {};
            const postPFC = profile.postWorkoutMacros || {};
            if (prePFC.protein || prePFC.fat || prePFC.carbs) {
                preWorkoutCals = (prePFC.protein || 0) * 4 + (prePFC.fat || 0) * 9 + (prePFC.carbs || 0) * 4;
            }
            if (postPFC.protein || postPFC.fat || postPFC.carbs) {
                postWorkoutCals = (postPFC.protein || 0) * 4 + (postPFC.fat || 0) * 9 + (postPFC.carbs || 0) * 4;
            }

            // ã‚¹ãƒ­ãƒƒãƒˆã®ç¨®åˆ¥åˆ¤å®š
            const slot = slots.find(s => s.slotNumber === parseInt(slotKey.replace('meal_', ''))) || {};
            const relTime = slot.relativeTime || '';

            if (relTime.startsWith('training-')) return preWorkoutCals || Math.round(totalCalories / mealsPerDay);
            if (relTime === 'training+0' || relTime.startsWith('training+')) return postWorkoutCals || Math.round(totalCalories / mealsPerDay);

            // é€šå¸¸é£Ÿäº‹: (total - ãƒˆãƒ¬å‰å¾Œ) / é€šå¸¸é£Ÿäº‹æ•°
            let trainingSlots = 0;
            slots.forEach(s => {
                const rt = s.relativeTime || '';
                if (rt.startsWith('training-') || rt === 'training+0' || rt.startsWith('training+')) trainingSlots++;
            });
            const normalSlots = mealsPerDay - trainingSlots;
            const remainingCals = totalCalories - preWorkoutCals - postWorkoutCals;
            return normalSlots > 0 ? Math.round(remainingCals / normalSlots) : Math.round(totalCalories / mealsPerDay);
        }

        // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®MealSlotConfigã‚’å–å¾—ã—ã¦ã‚¹ãƒ­ãƒƒãƒˆé¸æŠè‚¢ã‚’ç”Ÿæˆ
        async function loadUserSlots() {
            const uid = document.getElementById('cq-assign-uid').value.trim();
            if (!uid) { alert('ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }

            const container = document.getElementById('cq-assign-slot-container');
            const infoEl = document.getElementById('cq-assign-user-info');
            container.innerHTML = '<span class="text-gray-400 text-sm">èª­ã¿è¾¼ã¿ä¸­...</span>';
            infoEl.textContent = '';

            try {
                const userDoc = await db.collection('users').doc(uid).get();
                if (!userDoc.exists) { container.innerHTML = '<span class="text-red-500 text-sm">ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“</span>'; return; }

                const userData = userDoc.data();
                const displayName = userData.displayName || userData.email || uid;
                const profile = userData.profile || {};
                const mealSlotConfig = profile.mealSlotConfig || {};
                const mealsPerDay = mealSlotConfig.mealsPerDay || profile.mealsPerDay || 3;
                const slots = mealSlotConfig.slots || [];

                // ç›®æ¨™ã‚«ãƒ­ãƒªãƒ¼ç®—å‡º
                const targetCalories = calculateUserTargetCalories(profile);

                // ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±è¡¨ç¤º & æœ€è¿‘ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ä¿å­˜
                infoEl.innerHTML = `<strong>${escapeHtml(displayName)}</strong> ï½œ é£Ÿäº‹${mealsPerDay}å› ï½œ ç›®æ¨™ <strong>${targetCalories}kcal/æ—¥</strong>`;
                saveRecentUser(uid, displayName);

                // ã‚¹ãƒ­ãƒƒãƒˆãƒœã‚¿ãƒ³ç”Ÿæˆ
                let html = '';
                for (let i = 1; i <= mealsPerDay; i++) {
                    const slot = slots.find(s => s.slotNumber === i) || {};
                    const relTime = slot.relativeTime || '';
                    let label = `é£Ÿäº‹${i}`;
                    let badge = '';

                    // ãƒˆãƒ¬å‰å¾Œã®åˆ¤å®š
                    if (relTime.startsWith('training-')) {
                        badge = '<span class="text-[10px] bg-orange-100 text-orange-700 px-1 rounded">ãƒˆãƒ¬å‰</span>';
                    } else if (relTime === 'training+0' || relTime.startsWith('training+')) {
                        const offset = parseInt(relTime.replace('training+', '') || '0');
                        badge = offset === 0
                            ? '<span class="text-[10px] bg-red-100 text-red-700 px-1 rounded">ãƒˆãƒ¬ç›´å¾Œ</span>'
                            : '<span class="text-[10px] bg-orange-100 text-orange-700 px-1 rounded">ãƒˆãƒ¬å¾Œ</span>';
                    } else if (relTime.startsWith('wake')) {
                        badge = '<span class="text-[10px] bg-blue-100 text-blue-700 px-1 rounded">èµ·åºŠ</span>';
                    } else if (relTime.startsWith('sleep')) {
                        badge = '<span class="text-[10px] bg-purple-100 text-purple-700 px-1 rounded">å°±å¯å‰</span>';
                    }

                    const slotTargetCals = calculateSlotTargetCalories(profile, 'meal_' + i, targetCalories);
                    html += `<button onclick="selectSlot('meal_${i}')" data-slot="meal_${i}" data-target-cals="${slotTargetCals}"
                        class="cq-slot-btn border-2 border-gray-300 rounded-lg px-3 py-2 text-sm hover:border-yellow-500 hover:bg-yellow-50 transition-all flex flex-col items-center gap-0.5">
                        <span class="font-bold">${label}</span>${badge}<span class="text-[10px] text-gray-400">${slotTargetCals}kcal</span>
                    </button>`;
                }

                // é‹å‹•ã‚¹ãƒ­ãƒƒãƒˆ
                html += `<button onclick="selectSlot('workout')" data-slot="workout"
                    class="cq-slot-btn border-2 border-blue-300 rounded-lg px-3 py-2 text-sm hover:border-blue-500 hover:bg-blue-50 transition-all flex flex-col items-center gap-0.5">
                    <span class="font-bold">ğŸ‹ï¸ é‹å‹•</span>
                </button>`;

                container.innerHTML = html;
                document.getElementById('cq-assign-slot').value = '';

                // å‰²å½“ä¸€è¦§ã‚‚è‡ªå‹•èª­ã¿è¾¼ã¿
                await loadUserAssignments();

            } catch (e) {
                container.innerHTML = '<span class="text-red-500 text-sm">ã‚¨ãƒ©ãƒ¼: ' + e.message + '</span>';
            }
        }

        function selectSlot(slotKey) {
            document.getElementById('cq-assign-slot').value = slotKey;
            // ã‚¢ã‚¯ãƒ†ã‚£ãƒ–çŠ¶æ…‹ã‚’æ›´æ–°
            document.querySelectorAll('.cq-slot-btn').forEach(btn => {
                const isActive = btn.getAttribute('data-slot') === slotKey;
                btn.classList.toggle('border-yellow-500', isActive && slotKey !== 'workout');
                btn.classList.toggle('bg-yellow-100', isActive && slotKey !== 'workout');
                btn.classList.toggle('border-blue-500', isActive && slotKey === 'workout');
                btn.classList.toggle('bg-blue-100', isActive && slotKey === 'workout');
                btn.classList.toggle('border-gray-300', !isActive && slotKey !== 'workout');
            });
        }

        async function assignQuestToUser() {
            const uid = document.getElementById('cq-assign-uid').value.trim();
            const date = document.getElementById('cq-assign-date').value;
            const slotKey = document.getElementById('cq-assign-slot').value;
            const templateId = document.getElementById('cq-assign-template').value;

            if (!uid || !date || !slotKey || !templateId) {
                alert('ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã€æ—¥ä»˜ã€ã‚¹ãƒ­ãƒƒãƒˆã€ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’å…¨ã¦æŒ‡å®šã—ã¦ãã ã•ã„');
                return;
            }

            try {
                // ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
                const tplDoc = await db.collection('quest_templates').doc(templateId).get();
                if (!tplDoc.exists) { alert('ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“'); return; }
                const tpl = tplDoc.data();

                // custom_questsãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’å–å¾—ï¼ˆæ—¢å­˜ãŒã‚ã‚Œã°æ›´æ–°ï¼‰
                const docRef = db.collection('users').doc(uid).collection('custom_quests').doc(date);
                const existing = await docRef.get();

                // ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°: é‹å‹•ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã¯ã‚¹ã‚­ãƒƒãƒ—
                let scaledItems = tpl.items;
                let scaledMacros = tpl.totalMacros || { protein: 0, fat: 0, carbs: 0, calories: 0 };

                if (tpl.type === 'MEAL' && scaledMacros.calories > 0) {
                    // ã‚¹ãƒ­ãƒƒãƒˆã®ç›®æ¨™ã‚«ãƒ­ãƒªãƒ¼ã‚’å–å¾—
                    const slotBtn = document.querySelector(`.cq-slot-btn[data-slot="${slotKey}"]`);
                    const slotTargetCals = slotBtn ? parseInt(slotBtn.getAttribute('data-target-cals') || '0') : 0;

                    if (slotTargetCals > 0) {
                        const coefficient = slotTargetCals / scaledMacros.calories;
                        scaledItems = tpl.items.map(item => ({
                            ...item,
                            amount: r1((item.amount || 0) * coefficient),
                            calories: Math.round((item.calories || 0) * coefficient),
                            protein: r1((item.protein || 0) * coefficient),
                            fat: r1((item.fat || 0) * coefficient),
                            carbs: r1((item.carbs || 0) * coefficient),
                            fiber: r1((item.fiber || 0) * coefficient),
                            solubleFiber: r1((item.solubleFiber || 0) * coefficient),
                            insolubleFiber: r1((item.insolubleFiber || 0) * coefficient),
                            sugar: r1((item.sugar || 0) * coefficient),
                            saturatedFat: r2((item.saturatedFat || 0) * coefficient),
                            monounsaturatedFat: r2((item.monounsaturatedFat || 0) * coefficient),
                            polyunsaturatedFat: r2((item.polyunsaturatedFat || 0) * coefficient),
                            diaas: item.diaas || 0,
                            gi: item.gi || 0,
                            vitamins: scaleMap(item.vitamins || {}, coefficient),
                            minerals: scaleMap(item.minerals || {}, coefficient),
                        }));
                        scaledMacros = {
                            calories: Math.round(scaledMacros.calories * coefficient),
                            protein: r1((scaledMacros.protein || 0) * coefficient),
                            fat: r1((scaledMacros.fat || 0) * coefficient),
                            carbs: r1((scaledMacros.carbs || 0) * coefficient),
                            fiber: r1((scaledMacros.fiber || 0) * coefficient),
                            vitamins: scaleMap(scaledMacros.vitamins || {}, coefficient),
                            minerals: scaleMap(scaledMacros.minerals || {}, coefficient),
                        };
                    }
                }

                const slotData = {
                    templateId: templateId,
                    title: tpl.title,
                    type: tpl.type,
                    items: scaledItems,
                    totalMacros: scaledMacros
                };

                if (existing.exists) {
                    // æ—¢å­˜ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã«ã‚¹ãƒ­ãƒƒãƒˆã‚’è¿½åŠ /ä¸Šæ›¸ã
                    await docRef.update({
                        [`slots.${slotKey}`]: slotData
                    });
                } else {
                    // æ–°è¦ä½œæˆ
                    await docRef.set({
                        date: date,
                        assignedBy: auth.currentUser.uid,
                        isCustom: true,
                        slots: { [slotKey]: slotData },
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                }

                const slotLabel = slotKey === 'workout' ? 'é‹å‹•' : slotKey.replace('meal_', 'é£Ÿäº‹');
                document.getElementById('cq-assign-message').innerHTML = '<span class="text-green-600">âœ… å‰²å½“ã‚’ä¿å­˜ã—ã¾ã—ãŸ (' + date + ' / ' + slotLabel + ')</span>';

                // å‰²å½“ä¸€è¦§ã‚’æ›´æ–°
                await loadUserAssignments();
            } catch (e) {
                document.getElementById('cq-assign-message').innerHTML = '<span class="text-red-500">âŒ ã‚¨ãƒ©ãƒ¼: ' + e.message + '</span>';
            }
        }

        async function updateAssignedCount() {
            // å‰²å½“æ•°ã¯ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆå‰²å½“æ™‚ã«ã‚¤ãƒ³ã‚¯ãƒªãƒ¡ãƒ³ãƒˆã•ã‚Œã‚‹ã ã‘ã®ç°¡æ˜“è¡¨ç¤º
            // ï¼ˆã‚µãƒ–ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³æ¨ªæ–­ã‚¯ã‚¨ãƒªã¯ä¸å¯ã®ãŸã‚æ­£ç¢ºãªã‚«ã‚¦ãƒ³ãƒˆã¯çœç•¥ï¼‰
        }

        // ========== æœ€è¿‘ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç† ==========
        function getRecentUsers() {
            try { return JSON.parse(localStorage.getItem('cq_recent_users') || '[]'); } catch { return []; }
        }

        function saveRecentUser(uid, displayName) {
            let users = getRecentUsers().filter(u => u.uid !== uid);
            users.unshift({ uid, displayName, timestamp: Date.now() });
            if (users.length > 10) users = users.slice(0, 10);
            localStorage.setItem('cq_recent_users', JSON.stringify(users));
            renderRecentUsers();
        }

        function renderRecentUsers() {
            const users = getRecentUsers();
            const container = document.getElementById('cq-recent-users');
            if (users.length === 0) {
                container.innerHTML = '<span class="text-gray-400 text-sm">ã¾ã å±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“</span>';
                return;
            }
            container.innerHTML = users.map(u =>
                `<button onclick="switchToUser('${u.uid}')" class="text-xs border border-gray-300 rounded-full px-3 py-1 hover:bg-yellow-50 hover:border-yellow-400 transition-all ${document.getElementById('cq-assign-uid').value === u.uid ? 'bg-yellow-100 border-yellow-500 font-bold' : ''}">
                    ${escapeHtml(u.displayName || u.uid.substring(0, 8) + '...')}
                </button>`
            ).join('');
        }

        async function switchToUser(uid) {
            document.getElementById('cq-assign-uid').value = uid;
            await loadUserSlots();
            await loadUserAssignments();
        }

        // ========== å‰²å½“ä¸€è¦§è¡¨ç¤º ==========
        async function loadUserAssignments() {
            const uid = document.getElementById('cq-assign-uid').value.trim();
            if (!uid) return;

            const listEl = document.getElementById('cq-assign-list');
            const titleEl = document.getElementById('cq-assign-list-title');
            listEl.innerHTML = '<span class="text-gray-400">èª­ã¿è¾¼ã¿ä¸­...</span>';

            try {
                const snapshot = await db.collection('users').doc(uid).collection('custom_quests').orderBy('date', 'desc').limit(30).get();

                if (snapshot.empty) {
                    listEl.innerHTML = '<span class="text-gray-400">å‰²å½“ãªã—</span>';
                    titleEl.textContent = 'å‰²å½“ä¸€è¦§ï¼ˆ0ä»¶ï¼‰';
                    return;
                }

                titleEl.textContent = `å‰²å½“ä¸€è¦§ï¼ˆ${snapshot.size}ä»¶ï¼‰`;
                let html = '<div class="space-y-2">';
                snapshot.forEach(doc => {
                    const data = doc.data();
                    const date = data.date || doc.id;
                    const slots = data.slots || {};
                    const slotKeys = Object.keys(slots);
                    const isToday = date === new Date().toISOString().split('T')[0];
                    const isPast = date < new Date().toISOString().split('T')[0];

                    let dateBadge = '';
                    if (isToday) dateBadge = '<span class="text-[10px] bg-green-100 text-green-700 px-1 rounded ml-1">ä»Šæ—¥</span>';
                    else if (isPast) dateBadge = '<span class="text-[10px] bg-gray-100 text-gray-500 px-1 rounded ml-1">éå»</span>';
                    else dateBadge = '<span class="text-[10px] bg-blue-100 text-blue-700 px-1 rounded ml-1">äºˆå®š</span>';

                    const slotDetails = slotKeys.map(key => {
                        const s = slots[key];
                        const label = key === 'workout' ? 'ğŸ‹ï¸é‹å‹•' : key.replace('meal_', 'é£Ÿäº‹');
                        const typeBadge = s.type === 'WORKOUT'
                            ? '<span class="text-[10px] bg-blue-50 text-blue-600 px-1 rounded">é‹å‹•</span>'
                            : '<span class="text-[10px] bg-green-50 text-green-600 px-1 rounded">é£Ÿäº‹</span>';
                        return `<span class="inline-flex items-center gap-1">${label}: <strong>${escapeHtml(s.title || '?')}</strong> ${typeBadge}</span>`;
                    }).join('<span class="text-gray-300 mx-1">|</span>');

                    html += `<div class="p-2 border ${isToday ? 'border-green-300 bg-green-50' : isPast ? 'border-gray-200 bg-gray-50' : 'border-yellow-200 bg-yellow-50'} rounded-lg text-sm">
                        <div class="flex items-center justify-between">
                            <span class="font-bold">${date}${dateBadge}</span>
                            <button onclick="deleteAssignment('${uid}','${date}')" class="text-xs text-red-400 hover:text-red-600">å‰Šé™¤</button>
                        </div>
                        <div class="mt-1 text-xs">${slotDetails}</div>
                    </div>`;
                });
                html += '</div>';
                listEl.innerHTML = html;
            } catch (e) {
                listEl.innerHTML = '<span class="text-red-500 text-sm">ã‚¨ãƒ©ãƒ¼: ' + e.message + '</span>';
            }
        }

        async function deleteAssignment(uid, date) {
            if (!confirm(`${date} ã®å‰²å½“ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) return;
            try {
                await db.collection('users').doc(uid).collection('custom_quests').doc(date).delete();
                await loadUserAssignments();
            } catch (e) {
                alert('å‰Šé™¤ã‚¨ãƒ©ãƒ¼: ' + e.message);
            }
        }

        function escapeHtml(str) {
            if (!str) return '';
            return str.replace(/[&<>"']/g, (m) => ({
                '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;'
            }[m]));
        }

    </script>
</body>
</html>
