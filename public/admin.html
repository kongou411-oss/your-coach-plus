<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç®¡ç†ç”»é¢ - Your Coach+ v2</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            background: #f5f7fa;
            color: #333;
        }

        .header {
            background: white;
            border-bottom: 1px solid #e0e0e0;
            padding: 16px 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .header h1 {
            font-size: 24px;
            color: #667eea;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .user-info {
            font-size: 14px;
            color: #666;
        }

        .btn-logout {
            padding: 8px 16px;
            background: #f5f5f5;
            border: 1px solid #ddd;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.2s;
        }

        .btn-logout:hover {
            background: #e0e0e0;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 24px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 32px;
        }

        .stat-card {
            background: white;
            padding: 24px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }

        .stat-card h3 {
            font-size: 14px;
            color: #666;
            margin-bottom: 8px;
        }

        .stat-card .value {
            font-size: 32px;
            font-weight: 700;
            color: #667eea;
        }

        .section {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            margin-bottom: 24px;
        }

        .section-header {
            padding: 20px 24px;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .section-header h2 {
            font-size: 20px;
        }

        .section-content {
            padding: 24px;
        }

        .org-list {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .org-card {
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            padding: 20px;
            transition: border-color 0.2s;
        }

        .org-card:hover {
            border-color: #667eea;
        }

        .org-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 16px;
        }

        .org-name {
            font-size: 18px;
            font-weight: 700;
            color: #333;
            margin-bottom: 4px;
        }

        .org-email {
            font-size: 14px;
            color: #666;
        }

        .org-status {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        .org-status.active {
            background: #d4edda;
            color: #155724;
        }

        .org-status.cancelled {
            background: #f8d7da;
            color: #721c24;
        }

        .org-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 16px;
        }

        .org-info-item {
            display: flex;
            flex-direction: column;
        }

        .org-info-label {
            font-size: 12px;
            color: #666;
            margin-bottom: 4px;
        }

        .org-info-value {
            font-size: 14px;
            font-weight: 600;
            color: #333;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e0e0e0;
            border-radius: 4px;
            overflow: hidden;
            margin-top: 8px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            transition: width 0.3s;
        }

        .code-display {
            background: #f5f5f5;
            padding: 12px 16px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 16px;
            font-weight: 700;
            color: #667eea;
            text-align: center;
            margin-top: 8px;
        }

        .btn-primary {
            padding: 10px 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
        }

        .btn-secondary {
            padding: 8px 16px;
            background: white;
            color: #667eea;
            border: 2px solid #667eea;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-secondary:hover {
            background: #667eea;
            color: white;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #999;
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 16px;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>ğŸ”§ Your Coach+ ç®¡ç†ç”»é¢</h1>
        <div class="header-right">
            <span class="user-info" id="user-info">èª­ã¿è¾¼ã¿ä¸­...</span>
            <button class="btn-logout" onclick="logout()">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
        </div>
    </div>

    <div class="container">
        <!-- ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ -->
        <div class="flex flex-wrap gap-2 mb-6">
            <button id="tab-affiliation" onclick="switchTab('affiliation')" class="px-6 py-3 rounded-lg font-bold transition bg-purple-600 text-white">
                ğŸ¢ æ‰€å±åç®¡ç†
            </button>
            <button id="tab-users" onclick="switchTab('users')" class="px-6 py-3 rounded-lg font-bold transition bg-gray-200 text-gray-700 hover:bg-gray-300">
                ğŸ‘¥ ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†
            </button>
            <button id="tab-comy" onclick="switchTab('comy')" class="px-6 py-3 rounded-lg font-bold transition bg-gray-200 text-gray-700 hover:bg-gray-300">
                ğŸ’¬ COMYæŠ•ç¨¿
            </button>
            <button id="tab-pgbase" onclick="switchTab('pgbase')" class="px-6 py-3 rounded-lg font-bold transition bg-gray-200 text-gray-700 hover:bg-gray-300">
                ğŸ“š PGBASEè¨˜äº‹
            </button>
            <button id="tab-gymhunter" onclick="switchTab('gymhunter')" class="px-6 py-3 rounded-lg font-bold transition bg-gray-200 text-gray-700 hover:bg-gray-300">
                ğŸ¯ å–¶æ¥­ãƒªã‚¹ãƒˆ
            </button>
            <button id="tab-customquest" onclick="switchTab('customquest')" class="px-6 py-3 rounded-lg font-bold transition bg-gray-200 text-gray-700 hover:bg-gray-300">
                â­ ã‚«ã‚¹ã‚¿ãƒ ã‚¯ã‚¨ã‚¹ãƒˆ
            </button>
        </div>

        <!-- æ‰€å±åç®¡ç†ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
        <div id="affiliation-section">
            <!-- çµ±è¨ˆæƒ…å ± -->
            <div class="stats-grid">
                <div class="stat-card">
                    <h3>æ³•äººå¥‘ç´„æ•°</h3>
                    <div class="value" id="total-contracts">-</div>
                </div>
                <div class="stat-card">
                    <h3>æ‰€å±åç™»éŒ²æ•°</h3>
                    <div class="value" id="total-affiliations">-</div>
                </div>
                <div class="stat-card">
                    <h3>æ‰€å±ååˆ©ç”¨ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°</h3>
                    <div class="value" id="affiliation-users">-</div>
                </div>
            </div>

            <!-- æ³•äººå¥‘ç´„ã‚’æ‰‹å‹•ä½œæˆ -->
            <div class="section mb-6">
                <div class="section-header">
                    <h2>ğŸ¢ æ³•äººå¥‘ç´„ã‚’ä½œæˆ</h2>
                </div>
                <div class="section-content">
                    <div class="grid md:grid-cols-2 gap-4 mb-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">ä¼æ¥­åï¼ˆæ‰€å±åï¼‰*</label>
                            <input type="text" id="contract-company-name"
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500"
                                placeholder="ä¾‹: æ ªå¼ä¼šç¤¾ABC">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹*</label>
                            <input type="email" id="contract-email"
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500"
                                placeholder="ä¾‹: info@example.com">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">ãƒ—ãƒ©ãƒ³*</label>
                            <select id="contract-plan"
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500">
                                <option value="standard">ã‚¹ã‚¿ãƒ³ãƒ€ãƒ¼ãƒ‰ï¼ˆ10åï¼‰</option>
                                <option value="pro">ãƒ—ãƒ­ï¼ˆ30åï¼‰</option>
                                <option value="elite">ã‚¨ãƒªãƒ¼ãƒˆï¼ˆ100åï¼‰</option>
                                <option value="custom">ã‚«ã‚¹ã‚¿ãƒ </option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">ãƒ©ã‚¤ã‚»ãƒ³ã‚¹æ•°</label>
                            <input type="number" id="contract-licenses"
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500"
                                placeholder="ã‚«ã‚¹ã‚¿ãƒ ã®å ´åˆã®ã¿å…¥åŠ›" min="1">
                        </div>
                    </div>
                    <div class="flex items-center gap-4 mb-4">
                        <label class="flex items-center gap-2">
                            <input type="checkbox" id="contract-send-email" checked class="w-4 h-4">
                            <span class="text-sm text-gray-700">ç¢ºèªãƒ¡ãƒ¼ãƒ«ã‚’é€ä¿¡ã™ã‚‹</span>
                        </label>
                    </div>
                    <button onclick="createContract()" id="create-contract-btn" class="btn-primary">
                        âœ¨ å¥‘ç´„ã‚’ä½œæˆ
                    </button>
                </div>
            </div>

            <!-- æ³•äººå¥‘ç´„ä¸€è¦§ -->
            <div class="section mb-6">
                <div class="section-header">
                    <h2>ğŸ“‹ æ³•äººå¥‘ç´„ä¸€è¦§</h2>
                    <button onclick="loadContracts()" class="btn-secondary">ğŸ”„ æ›´æ–°</button>
                </div>
                <div class="section-content">
                    <div id="contracts-loading" class="loading">ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™...</div>
                    <div id="contracts-list" style="display:none; overflow-x:auto;"></div>
                    <div id="contracts-empty" class="empty-state" style="display:none;">
                        <div class="empty-state-icon">ğŸ“­</div>
                        <p>æ³•äººå¥‘ç´„ã¯ã‚ã‚Šã¾ã›ã‚“</p>
                    </div>
                </div>
            </div>

            <!-- ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«æ‰€å±åã‚’è¨­å®š -->
            <div class="section mb-6">
                <div class="section-header">
                    <h2>â• ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«æ‰€å±åã‚’è¨­å®š</h2>
                </div>
                <div class="section-content">
                    <div class="grid md:grid-cols-2 gap-4 mb-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">ãƒ¦ãƒ¼ã‚¶ãƒ¼ID ã¾ãŸã¯ ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹</label>
                            <input type="text" id="affiliation-user-id"
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500"
                                placeholder="ä¾‹: user123 ã¾ãŸã¯ user@example.com">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">æ‰€å±å</label>
                            <input type="text" id="affiliation-org-name"
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500"
                                placeholder="ä¾‹: æ ªå¼ä¼šç¤¾ABC">
                        </div>
                    </div>
                    <button onclick="setUserAffiliation()" id="set-affiliation-btn" class="btn-primary">
                        âœ¨ æ‰€å±åã‚’è¨­å®š
                    </button>
                </div>
            </div>

            <!-- æ‰€å±ååˆ¥ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§ -->
            <div class="section">
                <div class="section-header">
                    <h2>ğŸ“‹ æ‰€å±ååˆ¥ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§</h2>
                    <button onclick="loadAffiliations()" class="btn-secondary">ğŸ”„ æ›´æ–°</button>
                </div>
                <div class="section-content">
                    <div id="affiliation-loading" class="loading">ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™...</div>
                    <div id="affiliation-list" class="space-y-4" style="display:none;"></div>
                    <div id="affiliation-empty" class="empty-state" style="display:none;">
                        <div class="empty-state-icon">ğŸ“­</div>
                        <p>æ‰€å±åãŒè¨­å®šã•ã‚ŒãŸãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ã„ã¾ã›ã‚“</p>
                    </div>
                </div>
            </div>
        </div><!-- æ‰€å±åç®¡ç†ã‚»ã‚¯ã‚·ãƒ§ãƒ³çµ‚äº† -->

        <!-- ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
        <div id="users-section" style="display:none;">
            <!-- çµ±è¨ˆ -->
            <div class="stats-grid">
                <div class="stat-card">
                    <h3>ç·ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°</h3>
                    <div class="value" id="total-users">-</div>
                </div>
                <div class="stat-card">
                    <h3>Premiumä¼šå“¡</h3>
                    <div class="value" id="premium-users">-</div>
                </div>
                <div class="stat-card">
                    <h3>æ‰€å±ååˆ©ç”¨</h3>
                    <div class="value" id="org-users">-</div>
                </div>
                <div class="stat-card">
                    <h3>Google Playèª²é‡‘</h3>
                    <div class="value" id="billing-users">-</div>
                </div>
            </div>

            <!-- ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ -->
            <div class="section mb-6">
                <div class="section-content">
                    <div class="flex flex-wrap gap-3 items-center">
                        <label class="flex items-center gap-2">
                            <span class="text-sm font-medium">è¡¨ç¤º:</span>
                            <select id="user-filter" onchange="loadUsers()" class="px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500">
                                <option value="all">å…¨ãƒ¦ãƒ¼ã‚¶ãƒ¼</option>
                                <option value="premium">Premiumä¼šå“¡ã®ã¿</option>
                                <option value="affiliation">æ‰€å±ååˆ©ç”¨è€…</option>
                                <option value="billing">Google Playèª²é‡‘è€…</option>
                                <option value="trainer">ãƒˆãƒ¬ãƒ¼ãƒŠãƒ¼ã®ã¿</option>
                            </select>
                        </label>
                        <button onclick="loadUsers()" class="btn-secondary">ğŸ”„ æ›´æ–°</button>
                    </div>
                </div>
            </div>

            <!-- ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§ -->
            <div class="section">
                <div class="section-header">
                    <h2>ğŸ“‹ ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§</h2>
                    <span id="user-count" class="text-sm text-gray-500"></span>
                </div>
                <div class="section-content">
                    <div id="users-loading" class="loading">ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™...</div>
                    <div id="users-list" style="display:none;">
                        <div class="overflow-x-auto">
                            <table class="min-w-full text-sm">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-4 py-3 text-left font-medium text-gray-600">ãƒ¦ãƒ¼ã‚¶ãƒ¼</th>
                                        <th class="px-4 py-3 text-left font-medium text-gray-600">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</th>
                                        <th class="px-4 py-3 text-left font-medium text-gray-600">ç™»éŒ²æ—¥</th>
                                        <th class="px-4 py-3 text-left font-medium text-gray-600">æœ€çµ‚ãƒ­ã‚°ã‚¤ãƒ³</th>
                                        <th class="px-4 py-3 text-left font-medium text-gray-600">ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆ</th>
                                        <th class="px-4 py-3 text-left font-medium text-gray-600">è©³ç´°</th>
                                    </tr>
                                </thead>
                                <tbody id="users-tbody" class="divide-y divide-gray-200"></tbody>
                            </table>
                        </div>
                    </div>
                    <div id="users-empty" class="empty-state" style="display:none;">
                        <div class="empty-state-icon">ğŸ‘¤</div>
                        <p>è©²å½“ã™ã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã„ã¾ã›ã‚“</p>
                    </div>
                </div>
            </div>
        </div><!-- ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†ã‚»ã‚¯ã‚·ãƒ§ãƒ³çµ‚äº† -->


        <!-- COMYã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
        <div id="comy-section" style="display:none;">
            <!-- çµ±è¨ˆ -->
            <div class="stats-grid">
                <div class="stat-card">
                    <h3>ç·æŠ•ç¨¿æ•°</h3>
                    <div class="value" id="comy-total">-</div>
                </div>
                <div class="stat-card">
                    <h3>â“ è³ªå•</h3>
                    <div class="value text-blue-600" id="comy-cat-question">-</div>
                </div>
                <div class="stat-card">
                    <h3>ğŸ’¡ ã‚³ãƒ„</h3>
                    <div class="value text-yellow-600" id="comy-cat-tips">-</div>
                </div>
                <div class="stat-card">
                    <h3>ğŸ“ˆ çµŒéå ±å‘Š</h3>
                    <div class="value text-green-600" id="comy-cat-progress">-</div>
                </div>
                <div class="stat-card">
                    <h3>ğŸ³ ãƒ¬ã‚·ãƒ”</h3>
                    <div class="value text-orange-600" id="comy-cat-recipe">-</div>
                </div>
                <div class="stat-card">
                    <h3>ğŸ”¥ ãƒ¢ãƒãƒ™</h3>
                    <div class="value text-red-600" id="comy-cat-motivation">-</div>
                </div>
            </div>

            <!-- ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ -->
            <div class="section mb-6">
                <div class="section-content">
                    <div class="flex flex-wrap gap-3 items-center">
                        <label class="flex items-center gap-2">
                            <span class="text-sm font-medium">ã‚«ãƒ†ã‚´ãƒª:</span>
                            <select id="comy-filter" onchange="loadComyPosts()" class="px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500">
                                <option value="all">ã™ã¹ã¦</option>
                                <option value="question">â“ è³ªå•</option>
                                <option value="tips">ğŸ’¡ ã‚³ãƒ„ãƒ»ãƒã‚¦ãƒã‚¦</option>
                                <option value="progress">ğŸ“ˆ çµŒéå ±å‘Š</option>
                                <option value="recipe">ğŸ³ ãƒ¬ã‚·ãƒ”</option>
                                <option value="motivation">ğŸ”¥ ãƒ¢ãƒãƒ™ãƒ¼ã‚·ãƒ§ãƒ³</option>
                            </select>
                        </label>
                        <button onclick="loadComyPosts()" class="btn-secondary">ğŸ”„ æ›´æ–°</button>
                    </div>
                </div>
            </div>

            <!-- æŠ•ç¨¿ä¸€è¦§ -->
            <div class="section">
                <div class="section-header">
                    <h2>ğŸ’¬ COMYæŠ•ç¨¿ä¸€è¦§</h2>
                    <span id="comy-count" class="text-sm text-gray-500"></span>
                </div>
                <div class="section-content">
                    <div id="comy-loading" class="loading">æŠ•ç¨¿ã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™...</div>
                    <div id="comy-list" class="space-y-4" style="display:none;"></div>
                    <div id="comy-empty" class="empty-state" style="display:none;">
                        <div class="empty-state-icon">ğŸ’¬</div>
                        <p>æŠ•ç¨¿ãŒã‚ã‚Šã¾ã›ã‚“</p>
                    </div>
                </div>
            </div>
        </div><!-- COMYã‚»ã‚¯ã‚·ãƒ§ãƒ³çµ‚äº† -->


        <!-- PGBASEè¨˜äº‹ç®¡ç†ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
        <div id="pgbase-section" style="display:none;">
            <!-- ã‚·ãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿æŠ•å…¥ -->
            <div class="section mb-6">
                <div class="section-header">
                    <h2>ğŸ“¥ ã‚·ãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿ä¸€æ‹¬æŠ•å…¥</h2>
                </div>
                <div class="section-content">
                    <p class="text-sm text-gray-600 mb-4">JSONãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ‰ãƒ­ãƒƒãƒ—ã€ã¾ãŸã¯è²¼ã‚Šä»˜ã‘ã¦è¨˜äº‹ãƒ‡ãƒ¼ã‚¿ã‚’æŠ•å…¥ã—ã¾ã™ã€‚</p>

                    <!-- ãƒ‰ãƒ­ãƒƒãƒ—ã‚¾ãƒ¼ãƒ³ -->
                    <div id="pgbase-dropzone"
                        class="border-4 border-dashed border-gray-300 rounded-xl p-8 text-center mb-4 transition-all cursor-pointer hover:border-purple-400 hover:bg-purple-50"
                        ondrop="handleFileDrop(event)"
                        ondragover="handleDragOver(event)"
                        ondragleave="handleDragLeave(event)"
                        onclick="document.getElementById('pgbase-file-input').click()">
                        <div class="text-4xl mb-2">ğŸ“</div>
                        <p class="text-lg font-medium text-gray-700">JSONãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã“ã“ã«ãƒ‰ãƒ­ãƒƒãƒ—</p>
                        <p class="text-sm text-gray-500 mt-1">ã¾ãŸã¯ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ</p>
                        <input type="file" id="pgbase-file-input" accept=".json" style="display:none" onchange="handleFileSelect(event)">
                    </div>

                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-1">JSONãƒ‡ãƒ¼ã‚¿ï¼ˆç›´æ¥ç·¨é›†ã‚‚å¯ï¼‰</label>
                        <textarea id="pgbase-json-input" rows="6"
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 font-mono text-sm"
                            placeholder='{"articles": [{"id": "protein_001", "title": "...", ...}]}'></textarea>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="seedPgBaseArticles()" class="btn-primary">
                            ğŸš€ ä¸€æ‹¬æŠ•å…¥
                        </button>
                        <button onclick="clearPgBaseInput()" class="btn-secondary">
                            ğŸ—‘ï¸ ã‚¯ãƒªã‚¢
                        </button>
                    </div>
                    <div id="pgbase-seed-result" class="mt-4"></div>
                </div>
            </div>

            <!-- è¨˜äº‹ä¸€è¦§ -->
            <div class="section">
                <div class="section-header">
                    <h2>ğŸ“š PGBASEè¨˜äº‹ä¸€è¦§</h2>
                    <button onclick="loadPgBaseArticles()" class="btn-secondary">ğŸ”„ æ›´æ–°</button>
                </div>
                <div class="section-content">
                    <div id="pgbase-loading" class="loading">è¨˜äº‹ã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™...</div>
                    <div id="pgbase-stats" class="grid grid-cols-4 gap-4 mb-6" style="display:none;">
                        <div class="bg-blue-50 p-4 rounded-lg text-center">
                            <div class="text-2xl font-bold text-blue-600" id="pgbase-total">0</div>
                            <div class="text-sm text-gray-600">ç·è¨˜äº‹æ•°</div>
                        </div>
                        <div class="bg-green-50 p-4 rounded-lg text-center">
                            <div class="text-2xl font-bold text-green-600" id="pgbase-free">0</div>
                            <div class="text-sm text-gray-600">ç„¡æ–™è¨˜äº‹</div>
                        </div>
                        <div class="bg-yellow-50 p-4 rounded-lg text-center">
                            <div class="text-2xl font-bold text-yellow-600" id="pgbase-premium">0</div>
                            <div class="text-sm text-gray-600">ãƒ—ãƒ¬ãƒŸã‚¢ãƒ </div>
                        </div>
                        <div class="bg-purple-50 p-4 rounded-lg text-center">
                            <div class="text-2xl font-bold text-purple-600" id="pgbase-categories">0</div>
                            <div class="text-sm text-gray-600">ã‚«ãƒ†ã‚´ãƒªæ•°</div>
                        </div>
                    </div>
                    <div id="pgbase-list" class="space-y-4" style="display:none;"></div>
                    <div id="pgbase-empty" class="empty-state" style="display:none;">
                        <div class="empty-state-icon">ğŸ“­</div>
                        <p>ã¾ã è¨˜äº‹ãŒã‚ã‚Šã¾ã›ã‚“</p>
                        <p class="text-sm text-gray-500 mt-2">ä¸Šã®ãƒ•ã‚©ãƒ¼ãƒ ã‹ã‚‰ã‚·ãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿ã‚’æŠ•å…¥ã—ã¦ãã ã•ã„</p>
                    </div>
                </div>
            </div>
        </div><!-- PGBASEè¨˜äº‹ç®¡ç†ã‚»ã‚¯ã‚·ãƒ§ãƒ³çµ‚äº† -->

        <!-- å–¶æ¥­ãƒªã‚¹ãƒˆï¼ˆGym Hunterï¼‰ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
        <div id="gymhunter-section" style="display:none;">
            <div class="section mb-6">
                <div class="section-header">
                    <h2>ğŸ“¤ Excelãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ‰ãƒ­ãƒƒãƒ—</h2>
                </div>
                <div class="section-content">
                    <div id="drop-zone" style="border: 3px dashed #ccc; border-radius: 12px; padding: 60px; text-align: center; cursor: pointer; transition: all 0.3s;">
                        <div style="font-size: 48px; margin-bottom: 16px;">ğŸ“</div>
                        <p style="font-size: 18px; color: #666;">Gym Hunterã§ç”Ÿæˆã—ãŸ<br><strong>.xlsx ãƒ•ã‚¡ã‚¤ãƒ«</strong>ã‚’ã“ã“ã«ãƒ‰ãƒ­ãƒƒãƒ—</p>
                        <p style="font-size: 14px; color: #999; margin-top: 8px;">ã¾ãŸã¯ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠ</p>
                        <input type="file" id="file-input" accept=".xlsx,.xls" style="display: none;">
                    </div>
                </div>
            </div>

            <!-- ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ -->
            <div class="section mb-6" id="filter-section" style="display:none;">
                <div class="section-content">
                    <div class="flex flex-wrap gap-2">
                        <button onclick="filterByRank('all')" class="filter-btn px-4 py-2 rounded-lg bg-gray-800 text-white">å…¨ã¦</button>
                        <button onclick="filterByRank('S')" class="filter-btn px-4 py-2 rounded-lg bg-green-500 text-white">ğŸ”¥ S ãƒ©ãƒ³ã‚¯</button>
                        <button onclick="filterByRank('A')" class="filter-btn px-4 py-2 rounded-lg bg-blue-500 text-white">â­ A ãƒ©ãƒ³ã‚¯</button>
                        <button onclick="filterByRank('B')" class="filter-btn px-4 py-2 rounded-lg bg-gray-400 text-white">ğŸ“‹ B ãƒ©ãƒ³ã‚¯</button>
                        <button onclick="filterByRank('C')" class="filter-btn px-4 py-2 rounded-lg bg-red-400 text-white">âŒ C ãƒ©ãƒ³ã‚¯</button>
                        <span id="gym-count" class="ml-4 py-2 text-gray-600"></span>
                    </div>
                </div>
            </div>

            <!-- ãƒªã‚¹ãƒˆè¡¨ç¤º -->
            <div class="section" id="list-section" style="display:none;">
                <div class="section-header">
                    <h2>ğŸ“‹ å–¶æ¥­ãƒªã‚¹ãƒˆ</h2>
                </div>
                <div class="section-content" style="overflow-x: auto;">
                    <table id="gym-table" class="min-w-full text-sm">
                        <thead>
                            <tr class="bg-gray-100">
                                <th class="px-4 py-3 text-left">ãƒ©ãƒ³ã‚¯</th>
                                <th class="px-4 py-3 text-left">çŠ¶æ…‹</th>
                                <th class="px-4 py-3 text-left">åº—å</th>
                                <th class="px-4 py-3 text-left">é›»è©±</th>
                                <th class="px-4 py-3 text-left">åˆ¤å®šç†ç”±</th>
                                <th class="px-4 py-3 text-left">è©•ä¾¡</th>
                                <th class="px-4 py-3 text-left">HP</th>
                            </tr>
                        </thead>
                        <tbody id="gym-tbody"></tbody>
                    </table>
                </div>
            </div>
        </div><!-- å–¶æ¥­ãƒªã‚¹ãƒˆã‚»ã‚¯ã‚·ãƒ§ãƒ³çµ‚äº† -->

        <!-- ã‚«ã‚¹ã‚¿ãƒ ã‚¯ã‚¨ã‚¹ãƒˆç®¡ç†ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
        <div id="customquest-section" style="display:none;">
            <div class="section">
                <div class="section-body text-center py-12">
                    <div class="text-4xl mb-4">â­</div>
                    <h2 class="text-xl font-bold mb-2">ã‚«ã‚¹ã‚¿ãƒ ã‚¯ã‚¨ã‚¹ãƒˆç®¡ç†</h2>
                    <p class="text-gray-500 mb-6">å°‚ç”¨ãƒšãƒ¼ã‚¸ã§ç®¡ç†ã—ã¾ã™</p>
                    <a href="/admin-customquest.html" target="_blank"
                        class="px-8 py-3 bg-purple-600 text-white rounded-lg font-bold hover:bg-purple-700 transition inline-block">
                        ã‚«ã‚¹ã‚¿ãƒ ã‚¯ã‚¨ã‚¹ãƒˆç®¡ç†ã‚’é–‹ã â†’
                    </a>
                </div>
            </div>
        </div><!-- ã‚«ã‚¹ã‚¿ãƒ ã‚¯ã‚¨ã‚¹ãƒˆã‚»ã‚¯ã‚·ãƒ§ãƒ³çµ‚äº† -->
    </div>

    <!-- SheetJS (Excelèª­ã¿è¾¼ã¿ç”¨) -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-functions-compat.js"></script>
    <script src="/config.js"></script>

    <script>
        // FirebaseåˆæœŸåŒ–
        firebase.initializeApp(FIREBASE_CONFIG);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const functions = firebase.app().functions('asia-northeast2');

        // ç®¡ç†è€…ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã®ãƒ›ãƒ¯ã‚¤ãƒˆãƒªã‚¹ãƒˆ
        const ADMIN_EMAILS = [
            'official@your-coach-plus.com'
        ];

        // ç®¡ç†è€…PIN
        let adminPassword = '';

        // èªè¨¼ãƒã‚§ãƒƒã‚¯
        auth.onAuthStateChanged(async (user) => {
            if (!user || !ADMIN_EMAILS.includes(user.email)) {
                // æœªãƒ­ã‚°ã‚¤ãƒ³ã¾ãŸã¯ç®¡ç†è€…ã§ãªã„å ´åˆã¯ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã¸
                window.location.href = '/admin-login.html';
                return;
            }

            // ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±è¡¨ç¤º
            document.getElementById('user-info').textContent = user.email;

            // ç®¡ç†è€…PINã‚’å–å¾—ï¼ˆãƒ—ãƒ­ãƒ³ãƒ—ãƒˆï¼‰
            adminPassword = prompt('4æ¡ã®ç®¡ç†è€…PINã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
            if (!adminPassword) {
                alert('PINãŒå¿…è¦ã§ã™');
            }

            // ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ï¼ˆåˆæœŸã‚¿ãƒ–: æ‰€å±åç®¡ç†ï¼‰
            loadContracts();
            loadAffiliations();
        });

        // ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ
        function switchTab(tab) {
            const sections = ['affiliation', 'users', 'comy', 'pgbase', 'gymhunter', 'customquest'];
            const activeClass = 'px-6 py-3 rounded-lg font-bold transition bg-purple-600 text-white';
            const inactiveClass = 'px-6 py-3 rounded-lg font-bold transition bg-gray-200 text-gray-700 hover:bg-gray-300';

            sections.forEach(s => {
                const section = document.getElementById(s + '-section');
                const tabBtn = document.getElementById('tab-' + s);
                if (section) section.style.display = s === tab ? 'block' : 'none';
                if (tabBtn) tabBtn.className = s === tab ? activeClass : inactiveClass;
            });

            // ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
            if (tab === 'affiliation') { loadContracts(); loadAffiliations(); }
            if (tab === 'users') loadUsers();
            if (tab === 'comy') loadComyPosts();
            if (tab === 'pgbase') loadPgBaseArticles();
            if (tab === 'gymhunter') initGymHunter();
        }

        // ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
        function logout() {
            auth.signOut().then(() => {
                window.location.href = '/admin-login.html';
            });
        }

        // æ—¥ä»˜ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
        function formatDate(date) {
            return date.toLocaleDateString('ja-JP', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit'
            });
        }

        // ===== æ‰€å±åç®¡ç†æ©Ÿèƒ½ =====

        // æ³•äººå¥‘ç´„ä½œæˆ
        async function createContract() {
            const companyName = document.getElementById('contract-company-name').value.trim();
            const email = document.getElementById('contract-email').value.trim();
            const planId = document.getElementById('contract-plan').value;
            const customLicenses = document.getElementById('contract-licenses').value;
            const sendEmail = document.getElementById('contract-send-email').checked;

            if (!companyName || !email) {
                alert('ä¼æ¥­åã¨ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¯å¿…é ˆã§ã™');
                return;
            }

            // ãƒ—ãƒ©ãƒ³ã«å¿œã˜ãŸãƒ©ã‚¤ã‚»ãƒ³ã‚¹æ•°
            const planLicenses = {
                'standard': 10,
                'pro': 30,
                'elite': 100,
                'custom': parseInt(customLicenses) || 10
            };
            const licenses = planLicenses[planId];

            const btn = document.getElementById('create-contract-btn');
            btn.disabled = true;
            btn.textContent = 'ä½œæˆä¸­...';

            try {
                const createContractFn = functions.httpsCallable('adminCreateContract');
                const result = await createContractFn({
                    companyName,
                    email,
                    planId,
                    licenses,
                    sendEmail
                });

                if (result.data.success) {
                    alert('å¥‘ç´„ã‚’ä½œæˆã—ã¾ã—ãŸ: ' + companyName);
                    document.getElementById('contract-company-name').value = '';
                    document.getElementById('contract-email').value = '';
                    document.getElementById('contract-plan').value = 'standard';
                    document.getElementById('contract-licenses').value = '';
                    loadContracts();
                }
            } catch (error) {
                console.error('Create contract error:', error);
                alert('ã‚¨ãƒ©ãƒ¼: ' + error.message);
            } finally {
                btn.disabled = false;
                btn.textContent = 'âœ¨ å¥‘ç´„ã‚’ä½œæˆ';
            }
        }

        // æ³•äººå¥‘ç´„ä¸€è¦§èª­ã¿è¾¼ã¿
        async function loadContracts() {
            const loading = document.getElementById('contracts-loading');
            const list = document.getElementById('contracts-list');
            const empty = document.getElementById('contracts-empty');

            loading.style.display = 'block';
            loading.textContent = 'ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™...';
            list.style.display = 'none';
            empty.style.display = 'none';

            try {
                const snapshot = await db.collection('corporateContracts').get();

                document.getElementById('total-contracts').textContent = snapshot.size;

                loading.style.display = 'none';

                if (snapshot.empty) {
                    empty.style.display = 'block';
                    return;
                }

                const contracts = [];
                snapshot.forEach(doc => {
                    contracts.push({ id: doc.id, ...doc.data() });
                });
                // createdAtã§ã‚½ãƒ¼ãƒˆï¼ˆã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ï¼‰
                contracts.sort((a, b) => {
                    const aTime = a.createdAt?.toDate?.() || new Date(0);
                    const bTime = b.createdAt?.toDate?.() || new Date(0);
                    return bTime - aTime;
                });

                list.style.display = 'block';
                renderContracts(contracts);

            } catch (error) {
                console.error('Load contracts error:', error);
                loading.style.display = 'block';
                loading.innerHTML = '<p style="color: red;">ã‚¨ãƒ©ãƒ¼: ' + error.message + '</p>';
            }
        }

        // æ³•äººå¥‘ç´„ä¸€è¦§è¡¨ç¤º
        function renderContracts(contracts) {
            const container = document.getElementById('contracts-list');
            container.innerHTML = `
                <table class="w-full text-sm" style="min-width:700px;">
                    <thead class="bg-gray-100">
                        <tr class="whitespace-nowrap">
                            <th class="px-3 py-2 text-left">æ‰€å±å</th>
                            <th class="px-3 py-2 text-left">ãƒ¡ãƒ¼ãƒ«</th>
                            <th class="px-3 py-2 text-center">ãƒ—ãƒ©ãƒ³</th>
                            <th class="px-3 py-2 text-center">ãƒ©ã‚¤ã‚»ãƒ³ã‚¹</th>
                            <th class="px-3 py-2 text-center">åˆ©ç”¨ä¸­</th>
                            <th class="px-3 py-2 text-center">æœ‰åŠ¹æœŸé™</th>
                            <th class="px-3 py-2 text-center">çŠ¶æ…‹</th>
                            <th class="px-3 py-2 text-center">æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${contracts.map(c => {
                            const validUntilDate = c.validUntil?.toDate ? c.validUntil.toDate() : null;
                            const validUntil = validUntilDate ? validUntilDate.toLocaleDateString('ja-JP') : '-';
                            const validUntilISO = validUntilDate ? validUntilDate.toISOString().split('T')[0] : '';
                            const isExpired = validUntilDate && validUntilDate < new Date();
                            const statusClass = c.status === 'active' && !isExpired ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800';
                            const statusText = c.status === 'active' && !isExpired ? 'æœ‰åŠ¹' : (c.status === 'expired' ? 'æœŸé™åˆ‡ã‚Œ' : 'ç„¡åŠ¹');
                            return `
                                <tr class="border-t hover:bg-gray-50 whitespace-nowrap">
                                    <td class="px-3 py-3 font-medium">${c.organizationName || '-'}</td>
                                    <td class="px-3 py-3">${c.email || '-'}</td>
                                    <td class="px-3 py-3 text-center">${c.planId || '-'}</td>
                                    <td class="px-3 py-3 text-center">${c.licenses || '-'}</td>
                                    <td class="px-3 py-3 text-center">${(c.registeredUsers || []).length}</td>
                                    <td class="px-3 py-3 text-center">${validUntil}</td>
                                    <td class="px-4 py-3 text-center">
                                        <span class="px-2 py-1 rounded-full text-xs font-medium ${statusClass}">${statusText}</span>
                                    </td>
                                    <td class="px-4 py-3 text-center">
                                        <button onclick="editContract(this)" data-id="${c.id}" data-org="${(c.organizationName || '').replace(/"/g, '&quot;')}" data-licenses="${c.licenses || 0}" data-until="${validUntilISO}" data-status="${c.status || 'active'}"
                                            class="text-xs text-purple-600 hover:text-purple-800 font-bold">ç·¨é›†</button>
                                    </td>
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
            `;
        }

        // æ³•äººå¥‘ç´„ç·¨é›†
        function editContract(btn) {
            const contractId = btn.dataset.id;
            const orgName = btn.dataset.org;
            const licenses = parseInt(btn.dataset.licenses) || 0;
            const validUntil = btn.dataset.until;
            const status = btn.dataset.status;
            const html = `
                <div style="text-align:left;">
                    <p style="font-weight:bold;margin-bottom:12px;">${orgName} ã®å¥‘ç´„ã‚’ç·¨é›†</p>
                    <label style="display:block;margin-bottom:4px;font-size:13px;font-weight:600;">ãƒ©ã‚¤ã‚»ãƒ³ã‚¹æ•°</label>
                    <input type="number" id="edit-licenses" value="${licenses}" min="1" style="width:100%;padding:8px;border:1px solid #ddd;border-radius:6px;margin-bottom:12px;">
                    <label style="display:block;margin-bottom:4px;font-size:13px;font-weight:600;">æœ‰åŠ¹æœŸé™</label>
                    <input type="date" id="edit-valid-until" value="${validUntil}" style="width:100%;padding:8px;border:1px solid #ddd;border-radius:6px;margin-bottom:12px;">
                    <label style="display:block;margin-bottom:4px;font-size:13px;font-weight:600;">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</label>
                    <select id="edit-status" style="width:100%;padding:8px;border:1px solid #ddd;border-radius:6px;margin-bottom:4px;">
                        <option value="active" ${status === 'active' ? 'selected' : ''}>activeï¼ˆæœ‰åŠ¹ï¼‰</option>
                        <option value="expired" ${status === 'expired' ? 'selected' : ''}>expiredï¼ˆæœŸé™åˆ‡ã‚Œï¼‰</option>
                        <option value="cancelled" ${status === 'cancelled' ? 'selected' : ''}>cancelledï¼ˆã‚­ãƒ£ãƒ³ã‚»ãƒ«ï¼‰</option>
                    </select>
                </div>
            `;

            // ã‚·ãƒ³ãƒ—ãƒ«ãªãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ˆpromptã®ä»£æ›¿ï¼‰
            const modal = document.createElement('div');
            modal.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);z-index:9999;display:flex;align-items:center;justify-content:center;';
            modal.innerHTML = `
                <div style="background:white;border-radius:12px;padding:24px;max-width:400px;width:90%;box-shadow:0 20px 60px rgba(0,0,0,0.3);">
                    ${html}
                    <div style="display:flex;gap:8px;margin-top:16px;">
                        <button id="edit-cancel" style="flex:1;padding:10px;background:#f5f5f5;border:1px solid #ddd;border-radius:8px;cursor:pointer;font-weight:600;">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                        <button id="edit-save" style="flex:1;padding:10px;background:linear-gradient(135deg,#667eea,#764ba2);color:white;border:none;border-radius:8px;cursor:pointer;font-weight:600;">ä¿å­˜</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);

            modal.querySelector('#edit-cancel').onclick = () => modal.remove();
            modal.querySelector('#edit-save').onclick = async () => {
                const newLicenses = document.getElementById('edit-licenses').value;
                const newValidUntil = document.getElementById('edit-valid-until').value;
                const newStatus = document.getElementById('edit-status').value;

                const saveBtn = modal.querySelector('#edit-save');
                saveBtn.disabled = true;
                saveBtn.textContent = 'ä¿å­˜ä¸­...';

                try {
                    const updateFn = functions.httpsCallable('adminUpdateContract');
                    await updateFn({
                        contractId: contractId,
                        updates: {
                            licenses: parseInt(newLicenses),
                            validUntil: newValidUntil ? new Date(newValidUntil + 'T23:59:59').toISOString() : undefined,
                            status: newStatus
                        }
                    });
                    alert('âœ… å¥‘ç´„ã‚’æ›´æ–°ã—ã¾ã—ãŸ');
                    modal.remove();
                    loadContracts();
                } catch (error) {
                    console.error('Update contract error:', error);
                    alert('âŒ ' + (error.message || 'æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ'));
                    saveBtn.disabled = false;
                    saveBtn.textContent = 'ä¿å­˜';
                }
            };
        }

        // æ‰€å±ååˆ¥ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§èª­ã¿è¾¼ã¿
        async function loadAffiliations() {
            const loading = document.getElementById('affiliation-loading');
            const list = document.getElementById('affiliation-list');
            const empty = document.getElementById('affiliation-empty');

            loading.style.display = 'block';
            list.style.display = 'none';
            empty.style.display = 'none';

            try {
                // organizationNameãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’å–å¾—
                const snapshot = await db.collection('users')
                    .where('organizationName', '!=', null)
                    .get();

                const affiliationMap = {};
                let totalUsers = 0;

                snapshot.forEach(doc => {
                    const user = { id: doc.id, ...doc.data() };
                    const orgName = user.organizationName;
                    if (orgName && orgName.trim()) {
                        if (!affiliationMap[orgName]) {
                            affiliationMap[orgName] = [];
                        }
                        affiliationMap[orgName].push(user);
                        totalUsers++;
                    }
                });

                // çµ±è¨ˆæ›´æ–°
                document.getElementById('total-affiliations').textContent = Object.keys(affiliationMap).length;
                document.getElementById('affiliation-users').textContent = totalUsers;

                loading.style.display = 'none';

                if (Object.keys(affiliationMap).length === 0) {
                    empty.style.display = 'block';
                    return;
                }

                list.style.display = 'block';
                renderAffiliations(affiliationMap);

            } catch (error) {
                console.error('Load affiliations error:', error);
                loading.innerHTML = '<p style="color: red;">ã‚¨ãƒ©ãƒ¼: ' + error.message + '</p>';
            }
        }

        // æ‰€å±ååˆ¥ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§è¡¨ç¤º
        function renderAffiliations(affiliationMap) {
            const container = document.getElementById('affiliation-list');
            const sortedOrgs = Object.keys(affiliationMap).sort();

            container.innerHTML = sortedOrgs.map(orgName => {
                const users = affiliationMap[orgName];
                return `
                    <div class="border-2 rounded-xl p-4 border-blue-300 bg-blue-50">
                        <div class="flex items-start justify-between mb-3">
                            <div class="flex items-center gap-3">
                                <span class="font-bold text-xl text-blue-700">ğŸ¢ ${orgName}</span>
                                <span class="px-2 py-1 text-xs rounded-full font-medium bg-blue-200 text-blue-800">
                                    ${users.length}äºº
                                </span>
                            </div>
                        </div>

                        <details class="mt-3" open>
                            <summary class="text-sm text-blue-600 cursor-pointer hover:underline font-medium">
                                ğŸ‘¤ æ‰€å±ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§
                            </summary>
                            <div class="mt-2 bg-white rounded-lg p-3 space-y-2 border border-gray-200">
                                ${users.map((user, i) => `
                                    <div class="text-sm flex items-center justify-between ${i > 0 ? 'pt-2 border-t border-gray-100' : ''}">
                                        <div class="flex items-center gap-2">
                                            <span class="w-6 h-6 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center text-xs font-bold">${i + 1}</span>
                                            <div>
                                                <span class="text-gray-800 font-medium">${user.displayName || user.nickname || 'åå‰æœªè¨­å®š'}</span>
                                                <span class="text-gray-400 text-xs ml-2">${user.email || ''}</span>
                                            </div>
                                        </div>
                                        <button onclick="removeUserAffiliation('${user.id}', '${orgName}')"
                                            class="px-2 py-1 text-xs rounded bg-red-100 text-red-700 hover:bg-red-200 transition">
                                            è§£é™¤
                                        </button>
                                    </div>
                                `).join('')}
                            </div>
                        </details>
                    </div>
                `;
            }).join('');
        }

        // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«æ‰€å±åã‚’è¨­å®šï¼ˆãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ä»˜ãï¼‰
        async function setUserAffiliation() {
            const userIdOrEmail = document.getElementById('affiliation-user-id').value.trim();
            const orgName = document.getElementById('affiliation-org-name').value.trim();
            const btn = document.getElementById('set-affiliation-btn');

            if (!userIdOrEmail) {
                alert('ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã¾ãŸã¯ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }
            if (!orgName) {
                alert('æ‰€å±åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }

            btn.disabled = true;
            btn.textContent = 'â³ è¨­å®šä¸­...';

            try {
                // ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‹IDã‹ã‚’åˆ¤å®š
                let userId = userIdOrEmail;
                if (userIdOrEmail.includes('@')) {
                    const snapshot = await db.collection('users')
                        .where('email', '==', userIdOrEmail)
                        .limit(1)
                        .get();
                    if (snapshot.empty) {
                        throw new Error('è©²å½“ã™ã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: ' + userIdOrEmail);
                    }
                    userId = snapshot.docs[0].id;
                }

                // æ³•äººå¥‘ç´„ã‚’æ¤œç´¢ã—ã¦ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
                const contractSnapshot = await db.collection('corporateContracts')
                    .where('organizationName', '==', orgName)
                    .where('status', '==', 'active')
                    .limit(1)
                    .get();

                if (!contractSnapshot.empty) {
                    const contract = contractSnapshot.docs[0].data();
                    const contractRef = contractSnapshot.docs[0].ref;

                    // æœ‰åŠ¹æœŸé™ãƒã‚§ãƒƒã‚¯
                    if (contract.validUntil && contract.validUntil.toDate() < new Date()) {
                        throw new Error('ã“ã®æ‰€å±ã®å¥‘ç´„æœŸé™ãŒåˆ‡ã‚Œã¦ã„ã¾ã™ï¼ˆæœŸé™: ' + contract.validUntil.toDate().toLocaleDateString('ja-JP') + 'ï¼‰');
                    }

                    // ãƒ©ã‚¤ã‚»ãƒ³ã‚¹æ•°ãƒã‚§ãƒƒã‚¯
                    const licenses = contract.licenses || -1;
                    const registeredUsers = contract.registeredUsers || [];
                    if (licenses !== -1 && registeredUsers.length >= licenses && !registeredUsers.includes(userId)) {
                        throw new Error('ãƒ©ã‚¤ã‚»ãƒ³ã‚¹ä¸Šé™ã«é”ã—ã¦ã„ã¾ã™ï¼ˆ' + registeredUsers.length + '/' + licenses + 'åï¼‰');
                    }

                    // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®organizationNameã‚’æ›´æ–°
                    await db.collection('users').doc(userId).update({
                        organizationName: orgName,
                        organizationJoinedAt: firebase.firestore.FieldValue.serverTimestamp(),
                        isPremium: true
                    });

                    // å¥‘ç´„ã®registeredUsersã‚’æ›´æ–°
                    if (!registeredUsers.includes(userId)) {
                        await contractRef.update({
                            registeredUsers: firebase.firestore.FieldValue.arrayUnion(userId),
                            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                        });
                    }
                } else {
                    // å¥‘ç´„ãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã¯è­¦å‘Šä»˜ãã§è¨­å®š
                    if (!confirm('âš ï¸ ã€Œ' + orgName + 'ã€ã«å¯¾å¿œã™ã‚‹æ³•äººå¥‘ç´„ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚\n\nãã®ã¾ã¾æ‰€å±åã‚’è¨­å®šã—ã¾ã™ã‹ï¼Ÿï¼ˆæ‰‹å‹•ç®¡ç†ã«ãªã‚Šã¾ã™ï¼‰')) {
                        btn.disabled = false;
                        btn.textContent = 'âœ¨ æ‰€å±åã‚’è¨­å®š';
                        return;
                    }
                    await db.collection('users').doc(userId).update({
                        organizationName: orgName,
                        organizationJoinedAt: firebase.firestore.FieldValue.serverTimestamp(),
                        isPremium: true
                    });
                }

                alert('âœ… æ‰€å±åã‚’è¨­å®šã—ã¾ã—ãŸ\n\nãƒ¦ãƒ¼ã‚¶ãƒ¼: ' + userIdOrEmail + '\næ‰€å±å: ' + orgName);
                document.getElementById('affiliation-user-id').value = '';
                document.getElementById('affiliation-org-name').value = '';
                await loadAffiliations();

            } catch (error) {
                console.error('Set affiliation error:', error);
                alert('âŒ ' + (error.message || 'è¨­å®šã«å¤±æ•—ã—ã¾ã—ãŸ'));
            } finally {
                btn.disabled = false;
                btn.textContent = 'âœ¨ æ‰€å±åã‚’è¨­å®š';
            }
        }

        // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æ‰€å±åã‚’è§£é™¤
        async function removeUserAffiliation(userId, orgName) {
            if (!confirm(`ã“ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æ‰€å±åã€Œ${orgName}ã€ã‚’è§£é™¤ã—ã¾ã™ã‹ï¼Ÿ\n\nãƒ—ãƒ¬ãƒŸã‚¢ãƒ æ©Ÿèƒ½ãŒä½¿ãˆãªããªã‚Šã¾ã™ã€‚`)) return;

            try {
                await db.collection('users').doc(userId).update({
                    organizationName: firebase.firestore.FieldValue.delete()
                });
                await loadAffiliations();
            } catch (error) {
                console.error('Remove affiliation error:', error);
                alert('âŒ è§£é™¤ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (error.message || error));
            }
        }

        // ===== ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†æ©Ÿèƒ½ =====
        let allUsers = [];

        async function loadUsers() {
            const loading = document.getElementById('users-loading');
            const list = document.getElementById('users-list');
            const empty = document.getElementById('users-empty');
            const filter = document.getElementById('user-filter').value;

            loading.style.display = 'block';
            list.style.display = 'none';
            empty.style.display = 'none';

            try {
                // Cloud Functionã‹ã‚‰ Firebase Auth æƒ…å ±ã‚’å«ã‚€ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§ã‚’å–å¾—
                console.log('[Admin] Calling getAdminUserList...');
                const getAdminUserList = functions.httpsCallable('getAdminUserList');
                const result = await getAdminUserList();
                console.log('[Admin] Result:', result.data);

                if (!result.data.success) {
                    throw new Error('ãƒ‡ãƒ¼ã‚¿å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
                }

                // æœ€åˆã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æ—¥ä»˜ã‚’ç¢ºèª
                if (result.data.users.length > 0) {
                    console.log('[Admin] First user dates:', {
                        createdAt: result.data.users[0].createdAt,
                        lastLoginAt: result.data.users[0].lastLoginAt
                    });
                }

                allUsers = [];
                const now = new Date();
                let premiumCount = 0;
                let orgCount = 0;
                let billingCount = 0;

                result.data.users.forEach(user => {
                    // Premiumåˆ¤å®šï¼ˆæ‰€å±åãŒã‚ã‚‹ã‹ã€isPremiumãŒtrueï¼‰
                    const hasOrganization = user.organizationName && user.organizationName.trim();
                    const isPremium = user.isPremium === true || hasOrganization;

                    // ç™»éŒ²æ—¥ãƒ»ãƒ­ã‚°ã‚¤ãƒ³æ—¥ï¼ˆFirebase Authã‹ã‚‰å–å¾—æ¸ˆã¿ï¼‰
                    const regDate = user.createdAt ? new Date(user.createdAt) : new Date();
                    const lastLogin = user.lastLoginAt ? new Date(user.lastLoginAt) : null;
                    const daysSinceReg = Math.floor((now - regDate) / (1000 * 60 * 60 * 24));

                    user._isPremium = isPremium;
                    user._hasOrganization = hasOrganization;
                    user._regDate = regDate;
                    user._lastLogin = lastLogin;
                    user._daysSinceReg = daysSinceReg;

                    allUsers.push(user);

                    if (isPremium) premiumCount++;
                    if (hasOrganization) orgCount++;
                    if (user.isPremium === true && !hasOrganization) billingCount++;
                });

                // çµ±è¨ˆæ›´æ–°
                document.getElementById('total-users').textContent = allUsers.length;
                document.getElementById('premium-users').textContent = premiumCount;
                document.getElementById('org-users').textContent = orgCount;
                document.getElementById('billing-users').textContent = billingCount;

                // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼é©ç”¨
                let filtered = allUsers;
                switch (filter) {
                    case 'premium':
                        filtered = allUsers.filter(u => u._isPremium);
                        break;
                    case 'affiliation':
                        filtered = allUsers.filter(u => u._hasOrganization);
                        break;
                    case 'billing':
                        filtered = allUsers.filter(u => u.isPremium === true && !u._hasOrganization);
                        break;
                    case 'trainer':
                        filtered = allUsers.filter(u => u.role === 'trainer');
                        break;
                }

                // ç™»éŒ²æ—¥ã§ã‚½ãƒ¼ãƒˆï¼ˆæ–°ã—ã„é †ï¼‰
                filtered.sort((a, b) => b._regDate - a._regDate);

                loading.style.display = 'none';

                if (filtered.length === 0) {
                    empty.style.display = 'block';
                    return;
                }

                list.style.display = 'block';
                document.getElementById('user-count').textContent = `${filtered.length}äºº`;
                renderUsers(filtered);

            } catch (error) {
                console.error('Load users error:', error);
                loading.innerHTML = '<p style="color: red;">ã‚¨ãƒ©ãƒ¼: ' + error.message + '</p>';
            }
        }

        function renderUsers(users) {
            const tbody = document.getElementById('users-tbody');
            tbody.innerHTML = users.map(user => {
                const status = [];
                if (user.isPremium === true && !user._hasOrganization) {
                    status.push('<span class="px-2 py-1 text-xs rounded-full bg-yellow-100 text-yellow-800">ğŸ’³ èª²é‡‘</span>');
                }
                if (user._hasOrganization) {
                    status.push('<span class="px-2 py-1 text-xs rounded-full bg-blue-100 text-blue-800">ğŸ¢ ' + (user.organizationName || 'æ‰€å±') + '</span>');
                }
                if (user.role === 'trainer') {
                    status.push('<span class="px-2 py-1 text-xs rounded-full bg-teal-100 text-teal-800">ğŸ‹ï¸ ãƒˆãƒ¬ãƒ¼ãƒŠãƒ¼</span>');
                }
                if (status.length === 0) {
                    status.push('<span class="px-2 py-1 text-xs rounded-full bg-gray-100 text-gray-600">ç„¡æ–™</span>');
                }

                const freeCredits = user.freeCredits || 0;
                const paidCredits = user.paidCredits || 0;

                return `
                    <tr class="hover:bg-gray-50">
                        <td class="px-4 py-3">
                            <div class="font-medium text-gray-900">${user.displayName || user.nickname || 'åå‰æœªè¨­å®š'}</div>
                            <div class="text-xs text-gray-500">${user.email || 'ãƒ¡ãƒ¼ãƒ«æœªè¨­å®š'}</div>
                        </td>
                        <td class="px-4 py-3">
                            <div class="flex flex-wrap gap-1">
                                ${status.join('')}
                            </div>
                        </td>
                        <td class="px-4 py-3 text-gray-600">
                            ${user._regDate.toLocaleDateString('ja-JP')}
                            <div class="text-xs text-gray-400">${user._daysSinceReg}æ—¥ç›®</div>
                        </td>
                        <td class="px-4 py-3 text-gray-600">
                            ${user._lastLogin ? user._lastLogin.toLocaleDateString('ja-JP') : '-'}
                        </td>
                        <td class="px-4 py-3">
                            <div class="text-xs">
                                <span class="text-green-600">ç„¡æ–™: ${freeCredits}</span> /
                                <span class="text-blue-600">æœ‰å„Ÿ: ${paidCredits}</span>
                            </div>
                        </td>
                        <td class="px-4 py-3">
                            <button onclick="showUserDetail('${user.id}')" class="text-purple-600 hover:underline text-sm">
                                è©³ç´°
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function showUserDetail(userId) {
            const user = allUsers.find(u => u.id === userId);
            if (!user) return;

            const isTrainer = user.role === 'trainer';
            const hasOrg = user.organizationName && user.organizationName.trim();
            let trainerSection = '';
            if (isTrainer) {
                trainerSection = `
                    <div style="margin-top:12px;padding:12px;background:#f0fdfa;border:1px solid #99f6e4;border-radius:8px;">
                        <div style="font-weight:600;color:#0d9488;margin-bottom:8px;">ğŸ‹ï¸ ãƒˆãƒ¬ãƒ¼ãƒŠãƒ¼ï¼ˆ${user.organizationName}ï¼‰</div>
                        <button onclick="toggleTrainerRole('${user.id}', false)" style="padding:6px 16px;background:#ef4444;color:white;border:none;border-radius:6px;cursor:pointer;font-size:13px;">ãƒˆãƒ¬ãƒ¼ãƒŠãƒ¼è§£é™¤</button>
                    </div>`;
            } else if (hasOrg) {
                trainerSection = `
                    <div style="margin-top:12px;padding:12px;background:#f0fdfa;border:1px solid #99f6e4;border-radius:8px;">
                        <div style="font-size:12px;color:#6b7280;margin-bottom:8px;">æ‰€å±: ${user.organizationName}</div>
                        <button onclick="toggleTrainerRole('${user.id}', true)" style="padding:6px 16px;background:#0d9488;color:white;border:none;border-radius:6px;cursor:pointer;font-size:13px;">ãƒˆãƒ¬ãƒ¼ãƒŠãƒ¼ã«è¨­å®š</button>
                    </div>`;
            } else {
                trainerSection = `
                    <div style="margin-top:12px;padding:12px;background:#fef3c7;border:1px solid #fcd34d;border-radius:8px;">
                        <div style="font-size:12px;color:#92400e;">ãƒˆãƒ¬ãƒ¼ãƒŠãƒ¼ã«è¨­å®šã™ã‚‹ã«ã¯organizationNameãŒå¿…è¦ã§ã™</div>
                    </div>`;
            }

            // ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º
            const overlay = document.createElement('div');
            overlay.id = 'user-detail-overlay';
            overlay.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.4);z-index:100;display:flex;align-items:center;justify-content:center;';
            overlay.onclick = (e) => { if (e.target === overlay) overlay.remove(); };
            overlay.innerHTML = `
                <div style="background:white;border-radius:16px;padding:24px;max-width:440px;width:90%;box-shadow:0 20px 60px rgba(0,0,0,0.3);position:relative;">
                    <button onclick="document.getElementById('user-detail-overlay').remove()" style="position:absolute;top:12px;right:16px;background:none;border:none;font-size:20px;cursor:pointer;color:#999;">&times;</button>
                    <h3 style="font-size:18px;font-weight:700;margin-bottom:16px;">ãƒ¦ãƒ¼ã‚¶ãƒ¼è©³ç´°</h3>
                    <div style="font-size:13px;line-height:2;">
                        <div><strong>ID:</strong> <span style="font-family:monospace;font-size:11px;">${user.id}</span></div>
                        <div><strong>ãƒ¡ãƒ¼ãƒ«:</strong> ${user.email || 'æœªè¨­å®š'}</div>
                        <div><strong>åå‰:</strong> ${user.displayName || user.nickname || 'æœªè¨­å®š'}</div>
                        <div><strong>ç™»éŒ²æ—¥:</strong> ${user._regDate.toLocaleDateString('ja-JP')}</div>
                        <div><strong>ç„¡æ–™ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆ:</strong> ${user.freeCredits || 0} / <strong>æœ‰å„Ÿ:</strong> ${user.paidCredits || 0}</div>
                        <div><strong>Premium:</strong> ${user.isPremium ? 'ã¯ã„' : 'ã„ã„ãˆ'}</div>
                        <div><strong>æ‰€å±å:</strong> ${user.organizationName || 'ãªã—'}</div>
                        <div><strong>Role:</strong> ${user.role || 'ãªã—'}</div>
                    </div>
                    ${trainerSection}
                    <div id="trainer-toggle-msg" style="margin-top:8px;font-size:13px;"></div>
                </div>
            `;
            document.body.appendChild(overlay);
        }

        async function toggleTrainerRole(userId, setAsTrainer) {
            const msgEl = document.getElementById('trainer-toggle-msg');
            if (!msgEl) return;
            msgEl.innerHTML = '<span style="color:#6b7280;">å‡¦ç†ä¸­...</span>';
            try {
                const setTrainerRole = functions.httpsCallable('setTrainerRole');
                const result = await setTrainerRole({ userId, setAsTrainer });
                msgEl.innerHTML = '<span style="color:#059669;">' + result.data.message + '</span>';
                // ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§ã‚’å†èª­ã¿è¾¼ã¿
                setTimeout(() => {
                    const overlay = document.getElementById('user-detail-overlay');
                    if (overlay) overlay.remove();
                    loadUsers();
                }, 1500);
            } catch (e) {
                msgEl.innerHTML = '<span style="color:#dc2626;">ã‚¨ãƒ©ãƒ¼: ' + (e.message || e) + '</span>';
            }
        }

        // ===== COMYæŠ•ç¨¿ç®¡ç†æ©Ÿèƒ½ (comy_posts ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³) =====
        const COMY_CATEGORIES = {
            question:   { name: 'è³ªå•',           emoji: 'â“', color: 'blue' },
            tips:       { name: 'ã‚³ãƒ„ãƒ»ãƒã‚¦ãƒã‚¦', emoji: 'ğŸ’¡', color: 'yellow' },
            progress:   { name: 'çµŒéå ±å‘Š',       emoji: 'ğŸ“ˆ', color: 'green' },
            recipe:     { name: 'ãƒ¬ã‚·ãƒ”',         emoji: 'ğŸ³', color: 'orange' },
            motivation: { name: 'ãƒ¢ãƒãƒ™ãƒ¼ã‚·ãƒ§ãƒ³', emoji: 'ğŸ”¥', color: 'red' },
        };

        let allComyPosts = [];

        async function loadComyPosts() {
            const loading = document.getElementById('comy-loading');
            const list = document.getElementById('comy-list');
            const empty = document.getElementById('comy-empty');
            const filter = document.getElementById('comy-filter').value;

            loading.style.display = 'block';
            list.style.display = 'none';
            empty.style.display = 'none';

            try {
                let query = db.collection('comy_posts').orderBy('createdAt', 'desc');
                if (filter !== 'all') {
                    query = query.where('category', '==', filter);
                }
                const snapshot = await query.limit(200).get();

                allComyPosts = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                // çµ±è¨ˆæ›´æ–°ï¼ˆå…¨ä»¶ã§ã‚«ã‚¦ãƒ³ãƒˆï¼‰
                const allSnapshot = await db.collection('comy_posts').get();
                const allPosts = allSnapshot.docs.map(doc => doc.data());
                const catCounts = { question: 0, tips: 0, progress: 0, recipe: 0, motivation: 0 };
                allPosts.forEach(p => {
                    const cat = (p.category || '').toLowerCase();
                    if (catCounts[cat] !== undefined) catCounts[cat]++;
                });

                document.getElementById('comy-total').textContent = allPosts.length;
                document.getElementById('comy-cat-question').textContent = catCounts.question;
                document.getElementById('comy-cat-tips').textContent = catCounts.tips;
                document.getElementById('comy-cat-progress').textContent = catCounts.progress;
                document.getElementById('comy-cat-recipe').textContent = catCounts.recipe;
                document.getElementById('comy-cat-motivation').textContent = catCounts.motivation;

                loading.style.display = 'none';

                if (allComyPosts.length === 0) {
                    empty.style.display = 'block';
                    document.getElementById('comy-count').textContent = '';
                    return;
                }

                list.style.display = 'block';
                document.getElementById('comy-count').textContent = `${allComyPosts.length}ä»¶`;
                renderComyPosts(allComyPosts);

            } catch (error) {
                console.error('Load comy posts error:', error);
                loading.innerHTML = '<p style="color: red;">ã‚¨ãƒ©ãƒ¼: ' + error.message + '</p>';
            }
        }

        function getComyCategoryBadge(category) {
            const cat = COMY_CATEGORIES[(category || '').toLowerCase()];
            if (!cat) return '<span class="px-2 py-1 text-xs rounded-full bg-gray-100 text-gray-700">ä¸æ˜</span>';
            return `<span class="px-2 py-1 text-xs rounded-full bg-${cat.color}-100 text-${cat.color}-700">${cat.emoji} ${cat.name}</span>`;
        }

        function formatComyTime(ts) {
            if (!ts) return 'ä¸æ˜';
            // Firestore Timestamp or millis
            const date = ts.toDate ? ts.toDate() : new Date(typeof ts === 'number' ? ts : ts.seconds * 1000);
            return date.toLocaleString('ja-JP');
        }

        function renderComyPosts(posts) {
            const container = document.getElementById('comy-list');
            container.innerHTML = posts.map(post => {
                const categoryBadge = getComyCategoryBadge(post.category);
                const timestamp = formatComyTime(post.createdAt);
                const initial = (post.authorName || 'U')[0];

                return `
                    <div class="border-2 rounded-xl p-4 transition-all border-gray-200 bg-white hover:shadow-md">
                        <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
                        <div class="flex items-start justify-between mb-3">
                            <div class="flex items-center gap-3">
                                ${post.authorPhotoUrl
                                    ? `<img src="${post.authorPhotoUrl}" alt="" class="w-10 h-10 rounded-full object-cover">`
                                    : `<div class="w-10 h-10 bg-gradient-to-br from-pink-500 to-orange-500 rounded-full flex items-center justify-center text-white font-bold">${initial}</div>`
                                }
                                <div>
                                    <div class="font-bold text-gray-800">${post.authorName || 'ä¸æ˜'}</div>
                                    <div class="text-xs text-gray-500">${timestamp}</div>
                                </div>
                            </div>
                            <div class="flex items-center gap-2">
                                ${categoryBadge}
                            </div>
                        </div>

                        <!-- ã‚¿ã‚¤ãƒˆãƒ« -->
                        ${post.title ? `<div class="font-semibold text-gray-900 mb-2">${post.title}</div>` : ''}

                        <!-- æœ¬æ–‡ -->
                        <div class="bg-gray-50 p-3 rounded-lg mb-3">
                            <p class="text-sm text-gray-800 whitespace-pre-wrap">${post.content || '(å†…å®¹ãªã—)'}</p>
                        </div>

                        <!-- ç”»åƒ -->
                        ${post.imageUrl ? `
                            <div class="mb-3">
                                <img src="${post.imageUrl}" alt="æŠ•ç¨¿ç”»åƒ" class="w-full max-w-sm h-48 object-cover rounded-lg border">
                            </div>
                        ` : ''}

                        <!-- ã„ã„ã­ãƒ»ã‚³ãƒ¡ãƒ³ãƒˆãƒ»ID -->
                        <div class="flex items-center gap-4 text-sm text-gray-500 mb-3">
                            <span>â¤ï¸ ${post.likeCount || 0}</span>
                            <span>ğŸ’¬ ${post.commentCount || 0}</span>
                            <span class="text-xs text-gray-400">ID: ${post.userId || 'ä¸æ˜'}</span>
                        </div>

                        <!-- ã‚³ãƒ¡ãƒ³ãƒˆè¡¨ç¤ºãƒœã‚¿ãƒ³ -->
                        ${(post.commentCount || 0) > 0 ? `
                            <div id="comments-area-${post.id}">
                                <button onclick="loadComyComments('${post.id}')"
                                    class="text-sm text-purple-600 hover:underline mb-2">
                                    ğŸ’¬ ã‚³ãƒ¡ãƒ³ãƒˆ${post.commentCount}ä»¶ã‚’è¡¨ç¤º
                                </button>
                            </div>
                        ` : ''}

                        <!-- ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ -->
                        <div class="flex gap-2 flex-wrap">
                            <button onclick="deleteComyPost('${post.id}')"
                                class="px-4 py-2 text-sm rounded-lg font-medium bg-red-100 text-red-700 hover:bg-red-200 transition">
                                ğŸ—‘ï¸ å‰Šé™¤
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        async function loadComyComments(postId) {
            const area = document.getElementById('comments-area-' + postId);
            if (!area) return;
            area.innerHTML = '<p class="text-xs text-gray-400">èª­ã¿è¾¼ã¿ä¸­...</p>';

            try {
                const snapshot = await db.collection('comy_posts').doc(postId)
                    .collection('comments').orderBy('createdAt', 'asc').get();
                const comments = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                if (comments.length === 0) {
                    area.innerHTML = '<p class="text-xs text-gray-400">ã‚³ãƒ¡ãƒ³ãƒˆãªã—</p>';
                    return;
                }

                area.innerHTML = '<div class="space-y-2 mt-2 pl-4 border-l-2 border-gray-200">' +
                    comments.map(c => {
                        const time = formatComyTime(c.createdAt);
                        return `
                            <div class="text-sm">
                                <span class="font-medium text-gray-700">${c.authorName || 'ä¸æ˜'}</span>
                                <span class="text-xs text-gray-400 ml-2">${time}</span>
                                <p class="text-gray-600 mt-0.5">${c.content || ''}</p>
                            </div>
                        `;
                    }).join('') +
                '</div>';
            } catch (error) {
                console.error('Load comments error:', error);
                area.innerHTML = '<p class="text-xs text-red-500">ã‚³ãƒ¡ãƒ³ãƒˆèª­ã¿è¾¼ã¿å¤±æ•—</p>';
            }
        }

        async function deleteComyPost(postId) {
            if (!confirm('ã“ã®æŠ•ç¨¿ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\nã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚')) return;

            try {
                // ã‚µãƒ–ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆcommentsï¼‰ã‚‚å‰Šé™¤
                const commentsSnap = await db.collection('comy_posts').doc(postId).collection('comments').get();
                const batch = db.batch();
                commentsSnap.docs.forEach(doc => batch.delete(doc.ref));
                batch.delete(db.collection('comy_posts').doc(postId));
                await batch.commit();

                alert('ğŸ—‘ï¸ æŠ•ç¨¿ã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
                await loadComyPosts();
            } catch (error) {
                console.error('Delete comy post error:', error);
                alert('âŒ å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (error.message || error));
            }
        }


        // ========== PGBASEè¨˜äº‹ç®¡ç† ==========

        const categoryLabels = {
            NUTRITION: 'ğŸ¥— æ „é¤Šã®åŸºæœ¬',
            PROTEIN: 'ğŸ¥© ã‚¿ãƒ³ãƒ‘ã‚¯è³ª',
            CARBS: 'ğŸš ç‚­æ°´åŒ–ç‰©',
            FAT: 'ğŸ¥‘ è„‚è³ª',
            VITAMINS: 'ğŸ’Š ãƒ“ã‚¿ãƒŸãƒ³ãƒ»ãƒŸãƒãƒ©ãƒ«',
            TRAINING: 'ğŸ‹ï¸ ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°',
            RECOVERY: 'ğŸ˜´ å›å¾©ãƒ»ä¼‘é¤Š',
            MINDSET: 'ğŸ§  ãƒ¡ãƒ³ã‚¿ãƒ«'
        };

        // PGBASEè¨˜äº‹ä¸€è¦§èª­ã¿è¾¼ã¿
        async function loadPgBaseArticles() {
            const loading = document.getElementById('pgbase-loading');
            const list = document.getElementById('pgbase-list');
            const empty = document.getElementById('pgbase-empty');
            const stats = document.getElementById('pgbase-stats');

            loading.style.display = 'block';
            list.style.display = 'none';
            empty.style.display = 'none';
            stats.style.display = 'none';

            try {
                const snapshot = await db.collection('pgbase_articles').orderBy('order').get();

                if (snapshot.empty) {
                    loading.style.display = 'none';
                    empty.style.display = 'block';
                    return;
                }

                const articles = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                // çµ±è¨ˆæ›´æ–°
                const freeCount = articles.filter(a => !a.isPremium).length;
                const premiumCount = articles.filter(a => a.isPremium).length;
                const categories = [...new Set(articles.map(a => a.category))];

                document.getElementById('pgbase-total').textContent = articles.length;
                document.getElementById('pgbase-free').textContent = freeCount;
                document.getElementById('pgbase-premium').textContent = premiumCount;
                document.getElementById('pgbase-categories').textContent = categories.length;

                // è¨˜äº‹ä¸€è¦§ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
                list.innerHTML = articles.map(article => `
                    <div class="border-2 border-gray-200 rounded-lg p-4 hover:border-purple-400 transition">
                        <div class="flex justify-between items-start">
                            <div class="flex-1">
                                <div class="flex items-center gap-2 mb-2">
                                    <span class="text-xs px-2 py-1 rounded-full ${article.isPremium ? 'bg-yellow-100 text-yellow-800' : 'bg-green-100 text-green-800'}">
                                        ${article.isPremium ? 'â­ ãƒ—ãƒ¬ãƒŸã‚¢ãƒ ' : 'ğŸ†“ ç„¡æ–™'}
                                    </span>
                                    <span class="text-xs px-2 py-1 bg-purple-100 text-purple-800 rounded-full">
                                        ${categoryLabels[article.category] || article.category}
                                    </span>
                                    <span class="text-xs text-gray-500">é †åº: ${article.order}</span>
                                </div>
                                <h3 class="font-bold text-lg text-gray-900">${article.title}</h3>
                                <p class="text-sm text-gray-600 mt-1">${article.summary}</p>
                                <div class="flex gap-4 mt-2 text-xs text-gray-500">
                                    <span>ğŸ“– ${article.readingTime}åˆ†</span>
                                    <span>ğŸ†” ${article.id}</span>
                                </div>
                            </div>
                            <button onclick="deletePgBaseArticle('${article.id}')" class="text-red-500 hover:text-red-700 p-2" title="å‰Šé™¤">
                                ğŸ—‘ï¸
                            </button>
                        </div>
                    </div>
                `).join('');

                loading.style.display = 'none';
                stats.style.display = 'grid';
                list.style.display = 'block';

            } catch (error) {
                console.error('Load PGBASE articles error:', error);
                loading.innerHTML = '<p style="color: red;">ã‚¨ãƒ©ãƒ¼: ' + error.message + '</p>';
            }
        }

        // ã‚·ãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿ä¸€æ‹¬æŠ•å…¥
        async function seedPgBaseArticles() {
            const jsonInput = document.getElementById('pgbase-json-input').value.trim();
            const resultDiv = document.getElementById('pgbase-seed-result');

            if (!jsonInput) {
                resultDiv.innerHTML = '<p class="text-red-500">JSONãƒ‡ãƒ¼ã‚¿ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</p>';
                return;
            }

            try {
                const data = JSON.parse(jsonInput);
                const articles = data.articles || [];

                if (articles.length === 0) {
                    resultDiv.innerHTML = '<p class="text-red-500">è¨˜äº‹ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“</p>';
                    return;
                }

                resultDiv.innerHTML = '<p class="text-blue-500">æŠ•å…¥ä¸­...</p>';

                const batch = db.batch();
                articles.forEach(article => {
                    const docRef = db.collection('pgbase_articles').doc(article.id);
                    batch.set(docRef, {
                        ...article,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                });

                await batch.commit();

                resultDiv.innerHTML = `
                    <div class="bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded">
                        âœ… ${articles.length}ä»¶ã®è¨˜äº‹ã‚’æŠ•å…¥ã—ã¾ã—ãŸï¼
                    </div>
                `;

                // ä¸€è¦§ã‚’æ›´æ–°
                loadPgBaseArticles();

            } catch (error) {
                console.error('Seed error:', error);
                resultDiv.innerHTML = `<p class="text-red-500">ã‚¨ãƒ©ãƒ¼: ${error.message}</p>`;
            }
        }

        // è¨˜äº‹å‰Šé™¤
        async function deletePgBaseArticle(articleId) {
            if (!confirm(`è¨˜äº‹ã€Œ${articleId}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) return;

            try {
                await db.collection('pgbase_articles').doc(articleId).delete();
                alert('å‰Šé™¤ã—ã¾ã—ãŸ');
                loadPgBaseArticles();
            } catch (error) {
                alert('å‰Šé™¤ã‚¨ãƒ©ãƒ¼: ' + error.message);
            }
        }

        // ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‰ãƒ­ãƒƒãƒ—å‡¦ç†
        function handleDragOver(e) {
            e.preventDefault();
            e.stopPropagation();
            const dropzone = document.getElementById('pgbase-dropzone');
            dropzone.classList.add('border-purple-500', 'bg-purple-100');
            dropzone.classList.remove('border-gray-300');
        }

        function handleDragLeave(e) {
            e.preventDefault();
            e.stopPropagation();
            const dropzone = document.getElementById('pgbase-dropzone');
            dropzone.classList.remove('border-purple-500', 'bg-purple-100');
            dropzone.classList.add('border-gray-300');
        }

        function handleFileDrop(e) {
            e.preventDefault();
            e.stopPropagation();
            handleDragLeave(e);

            const files = e.dataTransfer.files;
            if (files.length > 0) {
                readJsonFile(files[0]);
            }
        }

        function handleFileSelect(e) {
            const files = e.target.files;
            if (files.length > 0) {
                readJsonFile(files[0]);
            }
        }

        function readJsonFile(file) {
            const resultDiv = document.getElementById('pgbase-seed-result');

            if (!file.name.endsWith('.json')) {
                resultDiv.innerHTML = '<p class="text-red-500">JSONãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„</p>';
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const json = JSON.parse(e.target.result);
                    document.getElementById('pgbase-json-input').value = JSON.stringify(json, null, 2);

                    const articleCount = json.articles ? json.articles.length : 0;
                    resultDiv.innerHTML = `
                        <div class="bg-blue-100 border border-blue-400 text-blue-700 px-4 py-3 rounded">
                            âœ… ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿å®Œäº†: <strong>${file.name}</strong> (${articleCount}ä»¶ã®è¨˜äº‹)
                            <br><span class="text-sm">ã€ŒğŸš€ ä¸€æ‹¬æŠ•å…¥ã€ãƒœã‚¿ãƒ³ã§æŠ•å…¥ã—ã¦ãã ã•ã„</span>
                        </div>
                    `;
                } catch (err) {
                    resultDiv.innerHTML = `<p class="text-red-500">JSONãƒ‘ãƒ¼ã‚¹ã‚¨ãƒ©ãƒ¼: ${err.message}</p>`;
                }
            };
            reader.readAsText(file);
        }

        function clearPgBaseInput() {
            document.getElementById('pgbase-json-input').value = '';
            document.getElementById('pgbase-seed-result').innerHTML = '';
        }

        // ===== Gym Hunter å–¶æ¥­ãƒªã‚¹ãƒˆæ©Ÿèƒ½ =====
        let gymData = [];
        let gymHunterInitialized = false;
        const GYMS_COLLECTION = 'gymLeads';

        // ã‚¸ãƒ IDã‚’ç”Ÿæˆï¼ˆåº—å+ä½æ‰€ã®ãƒãƒƒã‚·ãƒ¥ï¼‰
        function generateGymId(name, address) {
            const str = `${name || ''}_${address || ''}`.toLowerCase().replace(/\s+/g, '');
            let hash = 0;
            for (let i = 0; i < str.length; i++) {
                const char = str.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash = hash & hash;
            }
            return 'gym_' + Math.abs(hash).toString(36);
        }

        // Firestoreã‹ã‚‰ã‚¸ãƒ ãƒªã‚¹ãƒˆã‚’èª­ã¿è¾¼ã¿
        async function loadGymsFromFirestore() {
            try {
                const snapshot = await db.collection(GYMS_COLLECTION).orderBy('createdAt', 'desc').get();
                gymData = [];
                snapshot.forEach(doc => {
                    gymData.push({ id: doc.id, ...doc.data() });
                });
                return gymData;
            } catch (err) {
                console.error('Firestoreèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', err);
                return [];
            }
        }

        // Firestoreã«ã‚¸ãƒ ã‚’ä¿å­˜ï¼ˆé‡è¤‡ãƒã‚§ãƒƒã‚¯ä»˜ãï¼‰
        async function saveGymsToFirestore(gyms) {
            const batch = db.batch();
            let newCount = 0;
            let skipCount = 0;

            for (const gym of gyms) {
                const gymId = generateGymId(gym.name, gym.address);
                const docRef = db.collection(GYMS_COLLECTION).doc(gymId);

                // æ—¢å­˜ãƒã‚§ãƒƒã‚¯
                const existing = await docRef.get();
                if (existing.exists) {
                    skipCount++;
                    continue;
                }

                // æ–°è¦è¿½åŠ 
                batch.set(docRef, {
                    name: gym.name || '',
                    address: gym.address || '',
                    phone: gym.phone || '',
                    website: gym.website || '',
                    rank: gym.rank || 'B',
                    reason: gym.reason || '',
                    features: gym.features || '',
                    rating: gym.rating || null,
                    status: '',
                    scrapedAt: gym.scraped_at || null,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                newCount++;
            }

            if (newCount > 0) {
                await batch.commit();
            }

            return { newCount, skipCount };
        }

        // ã‚¸ãƒ ã®çŠ¶æ…‹ã‚’Firestoreã§æ›´æ–°
        async function updateGymStatusInFirestore(gymId, status) {
            try {
                await db.collection(GYMS_COLLECTION).doc(gymId).update({
                    status: status,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
            } catch (err) {
                console.error('çŠ¶æ…‹æ›´æ–°ã‚¨ãƒ©ãƒ¼:', err);
            }
        }

        async function initGymHunter() {
            if (gymHunterInitialized) return;
            gymHunterInitialized = true;

            const dropZone = document.getElementById('drop-zone');
            const fileInput = document.getElementById('file-input');

            // ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—
            dropZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                dropZone.style.borderColor = '#667eea';
                dropZone.style.background = '#f0f4ff';
            });

            dropZone.addEventListener('dragleave', (e) => {
                e.preventDefault();
                dropZone.style.borderColor = '#ccc';
                dropZone.style.background = 'white';
            });

            dropZone.addEventListener('drop', (e) => {
                e.preventDefault();
                dropZone.style.borderColor = '#ccc';
                dropZone.style.background = 'white';
                const file = e.dataTransfer.files[0];
                if (file) loadExcelFile(file);
            });

            // ã‚¯ãƒªãƒƒã‚¯ã§ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠ
            dropZone.addEventListener('click', () => fileInput.click());
            fileInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) loadExcelFile(file);
            });

            // æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã‚’Firestoreã‹ã‚‰èª­ã¿è¾¼ã¿
            showGymLoading(true);
            gymData = await loadGymsFromFirestore();
            showGymLoading(false);

            if (gymData.length > 0) {
                displayGymList(gymData);
                document.getElementById('filter-section').style.display = 'block';
                document.getElementById('list-section').style.display = 'block';
                updateGymCount(gymData.length);
            }
        }

        function showGymLoading(show) {
            const dropZone = document.getElementById('drop-zone');
            if (show) {
                dropZone.innerHTML = '<p class="text-gray-500">èª­ã¿è¾¼ã¿ä¸­...</p>';
            } else {
                dropZone.innerHTML = `
                    <p class="text-gray-500 mb-2">Excelãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—</p>
                    <p class="text-gray-400 text-sm">ã¾ãŸã¯ ã‚¯ãƒªãƒƒã‚¯ã—ã¦é¸æŠ</p>
                `;
            }
        }

        async function loadExcelFile(file) {
            const reader = new FileReader();
            reader.onload = async function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const sheetName = workbook.SheetNames[0];
                    const sheet = workbook.Sheets[sheetName];
                    const excelData = XLSX.utils.sheet_to_json(sheet);

                    // Firestoreã«ä¿å­˜ï¼ˆé‡è¤‡ãƒã‚§ãƒƒã‚¯ä»˜ãï¼‰
                    showGymLoading(true);
                    const result = await saveGymsToFirestore(excelData);

                    // æœ€æ–°ãƒ‡ãƒ¼ã‚¿ã‚’å†èª­ã¿è¾¼ã¿
                    gymData = await loadGymsFromFirestore();
                    showGymLoading(false);

                    displayGymList(gymData);
                    document.getElementById('filter-section').style.display = 'block';
                    document.getElementById('list-section').style.display = 'block';
                    updateGymCount(gymData.length);

                    // çµæœã‚’é€šçŸ¥
                    alert(`ã‚¤ãƒ³ãƒãƒ¼ãƒˆå®Œäº†\næ–°è¦è¿½åŠ : ${result.newCount}ä»¶\nã‚¹ã‚­ãƒƒãƒ—ï¼ˆé‡è¤‡ï¼‰: ${result.skipCount}ä»¶`);
                } catch (err) {
                    alert('ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: ' + err.message);
                    showGymLoading(false);
                }
            };
            reader.readAsArrayBuffer(file);
        }

        function displayGymList(data) {
            const tbody = document.getElementById('gym-tbody');
            tbody.innerHTML = '';

            data.forEach((row, idx) => {
                const rank = row.rank || 'B';
                const rankStyle = getRankStyle(rank);
                const reason = row.reason || '';
                const shortReason = reason.substring(0, 60);
                const hasMore = reason.length > 60;
                const gymId = row.id || '';
                const status = row.status || '';
                const tr = document.createElement('tr');
                tr.className = 'border-b hover:bg-gray-50 gym-row';
                tr.dataset.rank = rank;

                tr.innerHTML = `
                    <td class="px-4 py-3">
                        <span class="px-3 py-1 rounded-full text-white font-bold ${rankStyle.bg}">${rank}</span>
                    </td>
                    <td class="px-4 py-3">
                        ${renderStatusSelect(gymId, status, idx)}
                    </td>
                    <td class="px-4 py-3 font-medium">${escapeHtml(row.name || '')}</td>
                    <td class="px-4 py-3">
                        ${row.phone ? `<a href="tel:${row.phone}" class="text-blue-600 hover:underline">${escapeHtml(row.phone)}</a>` : '-'}
                    </td>
                    <td class="px-4 py-3 text-gray-600 text-xs" style="max-width: 350px;">
                        <span id="reason-short-${idx}">${escapeHtml(shortReason)}${hasMore ? '...' : ''}</span>
                        <span id="reason-full-${idx}" style="display:none;">${escapeHtml(reason)}</span>
                        ${hasMore ? `<button onclick="toggleReason(${idx})" id="reason-btn-${idx}" class="ml-2 text-blue-500 hover:underline text-xs">â–¼ å±•é–‹</button>` : ''}
                    </td>
                    <td class="px-4 py-3">${row.rating || '-'}</td>
                    <td class="px-4 py-3">
                        ${row.website ? `<a href="${escapeHtml(row.website)}" target="_blank" class="text-blue-600 hover:underline">HP</a>` : '-'}
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        function getRankStyle(rank) {
            const styles = {
                'S': { bg: 'bg-green-500' },
                'A': { bg: 'bg-blue-500' },
                'B': { bg: 'bg-gray-400' },
                'C': { bg: 'bg-red-400' }
            };
            return styles[rank] || styles['B'];
        }

        // çŠ¶æ…‹ç®¡ç†
        const STATUS_OPTIONS = [
            { value: '', label: 'æœªå¯¾å¿œ', color: 'bg-gray-200 text-gray-600' },
            { value: 'called', label: 'æ¶é›»æ¸ˆ', color: 'bg-yellow-100 text-yellow-700' },
            { value: 'negotiating', label: 'å•†è«‡ä¸­', color: 'bg-blue-100 text-blue-700' },
            { value: 'closed', label: 'æˆç´„', color: 'bg-green-100 text-green-700' },
            { value: 'rejected', label: 'è¦‹é€ã‚Š', color: 'bg-red-100 text-red-700' }
        ];

        function renderStatusSelect(gymId, currentStatus, idx) {
            const options = STATUS_OPTIONS.map(opt =>
                `<option value="${opt.value}" ${currentStatus === opt.value ? 'selected' : ''}>${opt.label}</option>`
            ).join('');
            return `<select onchange="updateStatus('${gymId}', this.value, ${idx})"
                           id="status-${idx}"
                           class="text-xs px-2 py-1 rounded border ${getStatusColor(currentStatus)}">
                        ${options}
                    </select>`;
        }

        function getStatusColor(status) {
            const opt = STATUS_OPTIONS.find(o => o.value === status);
            return opt ? opt.color : 'bg-gray-200 text-gray-600';
        }

        async function updateStatus(gymId, status, idx) {
            // UIã‚’å³åº§ã«æ›´æ–°
            const select = document.getElementById(`status-${idx}`);
            select.className = `text-xs px-2 py-1 rounded border ${getStatusColor(status)}`;

            // ãƒ­ãƒ¼ã‚«ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚‚æ›´æ–°
            const gym = gymData.find(g => g.id === gymId);
            if (gym) gym.status = status;

            // Firestoreã«ä¿å­˜
            await updateGymStatusInFirestore(gymId, status);
        }

        function filterByRank(rank) {
            const rows = document.querySelectorAll('.gym-row');
            let count = 0;

            rows.forEach(row => {
                if (rank === 'all' || row.dataset.rank === rank) {
                    row.style.display = '';
                    count++;
                } else {
                    row.style.display = 'none';
                }
            });

            updateGymCount(count);

            // ãƒœã‚¿ãƒ³ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ–çŠ¶æ…‹
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.style.opacity = '0.6';
            });
            event.target.style.opacity = '1';
        }

        function updateGymCount(count) {
            document.getElementById('gym-count').textContent = `è¡¨ç¤º: ${count}ä»¶`;
        }

        function toggleReason(idx) {
            const short = document.getElementById(`reason-short-${idx}`);
            const full = document.getElementById(`reason-full-${idx}`);
            const btn = document.getElementById(`reason-btn-${idx}`);

            if (full.style.display === 'none') {
                short.style.display = 'none';
                full.style.display = 'inline';
                btn.textContent = 'â–² é–‰ã˜ã‚‹';
            } else {
                short.style.display = 'inline';
                full.style.display = 'none';
                btn.textContent = 'â–¼ å±•é–‹';
            }
        }


        function escapeHtml(str) {
            if (!str) return '';
            return str.replace(/[&<>"']/g, (m) => ({
                '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;'
            }[m]));
        }

    </script>
</body>
</html>
