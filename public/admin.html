<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç®¡ç†ç”»é¢ - Your Coach+ v2</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            background: #f5f7fa;
            color: #333;
        }

        .header {
            background: white;
            border-bottom: 1px solid #e0e0e0;
            padding: 16px 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .header h1 {
            font-size: 24px;
            color: #667eea;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .user-info {
            font-size: 14px;
            color: #666;
        }

        .btn-logout {
            padding: 8px 16px;
            background: #f5f5f5;
            border: 1px solid #ddd;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.2s;
        }

        .btn-logout:hover {
            background: #e0e0e0;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 24px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 32px;
        }

        .stat-card {
            background: white;
            padding: 24px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }

        .stat-card h3 {
            font-size: 14px;
            color: #666;
            margin-bottom: 8px;
        }

        .stat-card .value {
            font-size: 32px;
            font-weight: 700;
            color: #667eea;
        }

        .section {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            margin-bottom: 24px;
        }

        .section-header {
            padding: 20px 24px;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .section-header h2 {
            font-size: 20px;
        }

        .section-content {
            padding: 24px;
        }

        .org-list {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .org-card {
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            padding: 20px;
            transition: border-color 0.2s;
        }

        .org-card:hover {
            border-color: #667eea;
        }

        .org-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 16px;
        }

        .org-name {
            font-size: 18px;
            font-weight: 700;
            color: #333;
            margin-bottom: 4px;
        }

        .org-email {
            font-size: 14px;
            color: #666;
        }

        .org-status {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        .org-status.active {
            background: #d4edda;
            color: #155724;
        }

        .org-status.cancelled {
            background: #f8d7da;
            color: #721c24;
        }

        .org-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 16px;
        }

        .org-info-item {
            display: flex;
            flex-direction: column;
        }

        .org-info-label {
            font-size: 12px;
            color: #666;
            margin-bottom: 4px;
        }

        .org-info-value {
            font-size: 14px;
            font-weight: 600;
            color: #333;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e0e0e0;
            border-radius: 4px;
            overflow: hidden;
            margin-top: 8px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            transition: width 0.3s;
        }

        .code-display {
            background: #f5f5f5;
            padding: 12px 16px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 16px;
            font-weight: 700;
            color: #667eea;
            text-align: center;
            margin-top: 8px;
        }

        .btn-primary {
            padding: 10px 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
        }

        .btn-secondary {
            padding: 8px 16px;
            background: white;
            color: #667eea;
            border: 2px solid #667eea;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-secondary:hover {
            background: #667eea;
            color: white;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #999;
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 16px;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>ğŸ”§ Your Coach+ ç®¡ç†ç”»é¢</h1>
        <div class="header-right">
            <span class="user-info" id="user-info">èª­ã¿è¾¼ã¿ä¸­...</span>
            <button class="btn-logout" onclick="logout()">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
        </div>
    </div>

    <div class="container">
        <!-- ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ -->
        <div class="flex flex-wrap gap-2 mb-6">
            <button id="tab-giftcode" onclick="switchTab('giftcode')" class="px-6 py-3 rounded-lg font-bold transition bg-purple-600 text-white">
                ğŸ ã‚®ãƒ•ãƒˆã‚³ãƒ¼ãƒ‰
            </button>
            <button id="tab-b2b2c" onclick="switchTab('b2b2c')" class="px-6 py-3 rounded-lg font-bold transition bg-gray-200 text-gray-700 hover:bg-gray-300">
                ğŸ¢ B2B2Cä¼æ¥­
            </button>
            <button id="tab-users" onclick="switchTab('users')" class="px-6 py-3 rounded-lg font-bold transition bg-gray-200 text-gray-700 hover:bg-gray-300">
                ğŸ‘¥ ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†
            </button>
            <button id="tab-referrals" onclick="switchTab('referrals')" class="px-6 py-3 rounded-lg font-bold transition bg-gray-200 text-gray-700 hover:bg-gray-300">
                ğŸ¤ ç´¹ä»‹ã‚³ãƒ¼ãƒ‰
            </button>
            <button id="tab-comy" onclick="switchTab('comy')" class="px-6 py-3 rounded-lg font-bold transition bg-gray-200 text-gray-700 hover:bg-gray-300">
                ğŸ’¬ COMYæŠ•ç¨¿
            </button>
            <button id="tab-pgbase" onclick="switchTab('pgbase')" class="px-6 py-3 rounded-lg font-bold transition bg-gray-200 text-gray-700 hover:bg-gray-300">
                ğŸ“š PGBASEè¨˜äº‹
            </button>
            <button id="tab-analytics" onclick="switchTab('analytics')" class="px-6 py-3 rounded-lg font-bold transition bg-gray-200 text-gray-700 hover:bg-gray-300">
                ğŸ“Š ä½¿ç”¨çŠ¶æ³åˆ†æ
            </button>
        </div>

        <!-- ã‚®ãƒ•ãƒˆã‚³ãƒ¼ãƒ‰ç®¡ç†ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
        <div id="giftcode-section">
            <!-- æ–°è¦ã‚³ãƒ¼ãƒ‰ä½œæˆ -->
            <div class="section mb-6">
                <div class="section-header">
                    <h2>â• æ–°è¦ã‚®ãƒ•ãƒˆã‚³ãƒ¼ãƒ‰ä½œæˆ</h2>
                </div>
                <div class="section-content">
                    <div class="grid md:grid-cols-2 gap-4 mb-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">ã‚³ãƒ¼ãƒ‰</label>
                            <input type="text" id="new-code"
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 uppercase font-mono"
                                placeholder="ä¾‹: FAMILYPLUS2025"
                                oninput="this.value = this.value.toUpperCase()">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">ãƒ¡ãƒ¢ï¼ˆä»»æ„ï¼‰</label>
                            <input type="text" id="new-note"
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500"
                                placeholder="ä¾‹: å®¶æ—é…å¸ƒç”¨">
                        </div>
                    </div>
                    <button onclick="createGiftCode()" id="create-btn" class="btn-primary">
                        âœ¨ ã‚³ãƒ¼ãƒ‰ã‚’ä½œæˆ
                    </button>
                </div>
            </div>

            <!-- ã‚®ãƒ•ãƒˆã‚³ãƒ¼ãƒ‰ä¸€è¦§ -->
            <div class="section">
                <div class="section-header">
                    <h2>ğŸ“‹ ã‚®ãƒ•ãƒˆã‚³ãƒ¼ãƒ‰ä¸€è¦§</h2>
                    <button onclick="loadGiftCodes()" class="btn-secondary">ğŸ”„ æ›´æ–°</button>
                </div>
                <div class="section-content">
                    <div id="giftcode-loading" class="loading">ã‚³ãƒ¼ãƒ‰ã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™...</div>
                    <div id="giftcode-list" class="space-y-4" style="display:none;"></div>
                    <div id="giftcode-empty" class="empty-state" style="display:none;">
                        <div class="empty-state-icon">ğŸ“­</div>
                        <p>ã¾ã ã‚®ãƒ•ãƒˆã‚³ãƒ¼ãƒ‰ãŒã‚ã‚Šã¾ã›ã‚“</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- B2B2Cã‚»ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆæ—¢å­˜ï¼‰ -->
        <div id="b2b2c-section" style="display:none;">
            <!-- çµ±è¨ˆæƒ…å ± -->
            <div class="stats-grid">
            <div class="stat-card">
                <h3>å¥‘ç´„ä¼æ¥­æ•°</h3>
                <div class="value" id="total-orgs">-</div>
            </div>
            <div class="stat-card">
                <h3>ç·ãƒ©ã‚¤ã‚»ãƒ³ã‚¹æ•°</h3>
                <div class="value" id="total-licenses">-</div>
            </div>
            <div class="stat-card">
                <h3>ä½¿ç”¨ä¸­ãƒ©ã‚¤ã‚»ãƒ³ã‚¹</h3>
                <div class="value" id="used-licenses">-</div>
            </div>
            <div class="stat-card">
                <h3>æœˆé–“åç›Š</h3>
                <div class="value" id="monthly-revenue">-</div>
            </div>
        </div>

        <!-- ä¼æ¥­ä¸€è¦§ -->
        <div class="section">
            <div class="section-header">
                <h2>å¥‘ç´„ä¼æ¥­ä¸€è¦§</h2>
            </div>
            <div class="section-content">
                <div id="loading" class="loading">
                    ä¼æ¥­æƒ…å ±ã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™...
                </div>
                <div id="org-list" class="org-list" style="display:none;"></div>
                <div id="empty-state" class="empty-state" style="display:none;">
                    <div class="empty-state-icon">ğŸ“­</div>
                    <p>ã¾ã å¥‘ç´„ä¼æ¥­ãŒã‚ã‚Šã¾ã›ã‚“</p>
                </div>
            </div>
        </div>
        </div><!-- B2B2Cã‚»ã‚¯ã‚·ãƒ§ãƒ³çµ‚äº† -->

        <!-- ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
        <div id="users-section" style="display:none;">
            <!-- çµ±è¨ˆ -->
            <div class="stats-grid">
                <div class="stat-card">
                    <h3>ç·ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°</h3>
                    <div class="value" id="total-users">-</div>
                </div>
                <div class="stat-card">
                    <h3>Premiumä¼šå“¡</h3>
                    <div class="value" id="premium-users">-</div>
                </div>
                <div class="stat-card">
                    <h3>B2B/ã‚®ãƒ•ãƒˆã‚³ãƒ¼ãƒ‰åˆ©ç”¨</h3>
                    <div class="value" id="code-users">-</div>
                </div>
                <div class="stat-card">
                    <h3>ãƒˆãƒ©ã‚¤ã‚¢ãƒ«ä¸­</h3>
                    <div class="value" id="trial-users">-</div>
                </div>
            </div>

            <!-- ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ -->
            <div class="section mb-6">
                <div class="section-content">
                    <div class="flex flex-wrap gap-3 items-center">
                        <label class="flex items-center gap-2">
                            <span class="text-sm font-medium">è¡¨ç¤º:</span>
                            <select id="user-filter" onchange="loadUsers()" class="px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500">
                                <option value="all">å…¨ãƒ¦ãƒ¼ã‚¶ãƒ¼</option>
                                <option value="premium">Premiumä¼šå“¡ã®ã¿</option>
                                <option value="b2b">B2Bã‚³ãƒ¼ãƒ‰åˆ©ç”¨è€…</option>
                                <option value="gift">ã‚®ãƒ•ãƒˆã‚³ãƒ¼ãƒ‰åˆ©ç”¨è€…</option>
                                <option value="stripe">Stripeèª²é‡‘è€…</option>
                                <option value="trial">ãƒˆãƒ©ã‚¤ã‚¢ãƒ«ä¸­</option>
                            </select>
                        </label>
                        <button onclick="loadUsers()" class="btn-secondary">ğŸ”„ æ›´æ–°</button>
                    </div>
                </div>
            </div>

            <!-- ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§ -->
            <div class="section">
                <div class="section-header">
                    <h2>ğŸ“‹ ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§</h2>
                    <span id="user-count" class="text-sm text-gray-500"></span>
                </div>
                <div class="section-content">
                    <div id="users-loading" class="loading">ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™...</div>
                    <div id="users-list" style="display:none;">
                        <div class="overflow-x-auto">
                            <table class="min-w-full text-sm">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-4 py-3 text-left font-medium text-gray-600">ãƒ¦ãƒ¼ã‚¶ãƒ¼</th>
                                        <th class="px-4 py-3 text-left font-medium text-gray-600">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</th>
                                        <th class="px-4 py-3 text-left font-medium text-gray-600">ç™»éŒ²æ—¥</th>
                                        <th class="px-4 py-3 text-left font-medium text-gray-600">æœ€çµ‚ãƒ­ã‚°ã‚¤ãƒ³</th>
                                        <th class="px-4 py-3 text-left font-medium text-gray-600">ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆ</th>
                                        <th class="px-4 py-3 text-left font-medium text-gray-600">è©³ç´°</th>
                                    </tr>
                                </thead>
                                <tbody id="users-tbody" class="divide-y divide-gray-200"></tbody>
                            </table>
                        </div>
                    </div>
                    <div id="users-empty" class="empty-state" style="display:none;">
                        <div class="empty-state-icon">ğŸ‘¤</div>
                        <p>è©²å½“ã™ã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã„ã¾ã›ã‚“</p>
                    </div>
                </div>
            </div>
        </div><!-- ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†ã‚»ã‚¯ã‚·ãƒ§ãƒ³çµ‚äº† -->

        <!-- ç´¹ä»‹ã‚³ãƒ¼ãƒ‰ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
        <div id="referrals-section" style="display:none;">
            <!-- çµ±è¨ˆ -->
            <div class="stats-grid">
                <div class="stat-card">
                    <h3>ç·ç´¹ä»‹æ•°</h3>
                    <div class="value" id="total-referrals">-</div>
                </div>
                <div class="stat-card">
                    <h3>ç´¹ä»‹è€…æ•°ï¼ˆã‚³ãƒ¼ãƒ‰ç™ºè¡Œï¼‰</h3>
                    <div class="value" id="referrer-count">-</div>
                </div>
                <div class="stat-card">
                    <h3>è¢«ç´¹ä»‹è€…æ•°</h3>
                    <div class="value" id="referee-count">-</div>
                </div>
                <div class="stat-card">
                    <h3>ä»˜ä¸ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆåˆè¨ˆ</h3>
                    <div class="value" id="total-referral-credits">-</div>
                </div>
            </div>

            <!-- ç´¹ä»‹ã‚³ãƒ¼ãƒ‰ä¸€è¦§ -->
            <div class="section">
                <div class="section-header">
                    <h2>ğŸ¤ ç´¹ä»‹ã‚³ãƒ¼ãƒ‰åˆ©ç”¨çŠ¶æ³</h2>
                    <button onclick="loadReferrals()" class="btn-secondary">ğŸ”„ æ›´æ–°</button>
                </div>
                <div class="section-content">
                    <div id="referrals-loading" class="loading">ç´¹ä»‹ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™...</div>
                    <div id="referrals-list" style="display:none;">
                        <div class="overflow-x-auto">
                            <table class="min-w-full text-sm">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-4 py-3 text-left font-medium text-gray-600">ç´¹ä»‹è€…</th>
                                        <th class="px-4 py-3 text-left font-medium text-gray-600">ç´¹ä»‹ã‚³ãƒ¼ãƒ‰</th>
                                        <th class="px-4 py-3 text-left font-medium text-gray-600">è¢«ç´¹ä»‹è€…</th>
                                        <th class="px-4 py-3 text-left font-medium text-gray-600">é©ç”¨æ—¥æ™‚</th>
                                        <th class="px-4 py-3 text-left font-medium text-gray-600">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</th>
                                    </tr>
                                </thead>
                                <tbody id="referrals-tbody" class="divide-y divide-gray-200"></tbody>
                            </table>
                        </div>
                    </div>
                    <div id="referrals-empty" class="empty-state" style="display:none;">
                        <div class="empty-state-icon">ğŸ¤</div>
                        <p>ã¾ã ç´¹ä»‹ã‚³ãƒ¼ãƒ‰ãŒä½¿ç”¨ã•ã‚Œã¦ã„ã¾ã›ã‚“</p>
                    </div>
                </div>
            </div>

            <!-- ç´¹ä»‹è€…åˆ¥è©³ç´° -->
            <div class="section">
                <div class="section-header">
                    <h2>ğŸ‘¤ ç´¹ä»‹è€…åˆ¥ã‚µãƒãƒªãƒ¼</h2>
                </div>
                <div class="section-content">
                    <div id="referrer-summary" class="space-y-4"></div>
                </div>
            </div>
        </div><!-- ç´¹ä»‹ã‚³ãƒ¼ãƒ‰ã‚»ã‚¯ã‚·ãƒ§ãƒ³çµ‚äº† -->

        <!-- COMYã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
        <div id="comy-section" style="display:none;">
            <!-- çµ±è¨ˆ -->
            <div class="stats-grid">
                <div class="stat-card">
                    <h3>ç·æŠ•ç¨¿æ•°</h3>
                    <div class="value" id="total-posts">-</div>
                </div>
                <div class="stat-card">
                    <h3>è³ªå•</h3>
                    <div class="value text-purple-600" id="question-posts">-</div>
                </div>
                <div class="stat-card">
                    <h3>ã‚³ãƒ„ãƒ»ãƒã‚¦ãƒã‚¦</h3>
                    <div class="value text-yellow-600" id="tips-posts">-</div>
                </div>
                <div class="stat-card">
                    <h3>çµŒéå ±å‘Š</h3>
                    <div class="value text-blue-600" id="progress-posts">-</div>
                </div>
            </div>

            <!-- æ¤œç´¢ãƒ»ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ -->
            <div class="section mb-6">
                <div class="section-content">
                    <div class="flex flex-wrap gap-3 items-center mb-4">
                        <div class="flex-1 min-w-[200px]">
                            <input type="text" id="comy-search" placeholder="æ¤œç´¢ï¼ˆã‚¿ã‚¤ãƒˆãƒ«ã€å†…å®¹ã€æŠ•ç¨¿è€…åï¼‰"
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500"
                                onkeyup="filterComyPosts()">
                        </div>
                        <label class="flex items-center gap-2">
                            <span class="text-sm font-medium">ã‚«ãƒ†ã‚´ãƒª:</span>
                            <select id="comy-filter" onchange="filterComyPosts()" class="px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500">
                                <option value="all">ã™ã¹ã¦</option>
                                <option value="question">â“ è³ªå•</option>
                                <option value="tips">ğŸ’¡ ã‚³ãƒ„ãƒ»ãƒã‚¦ãƒã‚¦</option>
                                <option value="progress">ğŸ“ˆ çµŒéå ±å‘Š</option>
                                <option value="recipe">ğŸ³ ãƒ¬ã‚·ãƒ”</option>
                                <option value="motivation">ğŸ”¥ ãƒ¢ãƒãƒ™ãƒ¼ã‚·ãƒ§ãƒ³</option>
                            </select>
                        </label>
                        <button onclick="loadComyPosts()" class="btn-secondary">ğŸ”„ æ›´æ–°</button>
                    </div>
                </div>
            </div>

            <!-- æŠ•ç¨¿ä¸€è¦§ -->
            <div class="section">
                <div class="section-header">
                    <h2>ğŸ’¬ COMYæŠ•ç¨¿ä¸€è¦§ï¼ˆãƒã‚¤ãƒ†ã‚£ãƒ–ã‚¢ãƒ—ãƒªï¼‰</h2>
                    <span id="comy-count" class="text-sm text-gray-500"></span>
                </div>
                <div class="section-content">
                    <div id="comy-loading" class="loading">æŠ•ç¨¿ã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™...</div>
                    <div id="comy-list" class="space-y-4" style="display:none;"></div>
                    <div id="comy-empty" class="empty-state" style="display:none;">
                        <div class="empty-state-icon">ğŸ’¬</div>
                        <p>è©²å½“ã™ã‚‹æŠ•ç¨¿ãŒã‚ã‚Šã¾ã›ã‚“</p>
                    </div>
                </div>
            </div>
        </div><!-- COMYã‚»ã‚¯ã‚·ãƒ§ãƒ³çµ‚äº† -->

        <!-- PGBASEã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
        <div id="pgbase-section" style="display:none;">
            <!-- çµ±è¨ˆ -->
            <div class="stats-grid">
                <div class="stat-card">
                    <h3>ç·è¨˜äº‹æ•°</h3>
                    <div class="value" id="total-articles">-</div>
                </div>
                <div class="stat-card">
                    <h3>æ „é¤Š</h3>
                    <div class="value text-green-600" id="nutrition-articles">-</div>
                </div>
                <div class="stat-card">
                    <h3>ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°</h3>
                    <div class="value text-orange-600" id="training-articles">-</div>
                </div>
                <div class="stat-card">
                    <h3>å›å¾©ãƒ»ä¼‘é¤Š</h3>
                    <div class="value text-blue-600" id="recovery-articles">-</div>
                </div>
            </div>

            <!-- æ–°è¦è¨˜äº‹ä½œæˆ -->
            <div class="section mb-6">
                <div class="section-header">
                    <h2>â• æ–°è¦è¨˜äº‹ä½œæˆ</h2>
                </div>
                <div class="section-content">
                    <div class="grid md:grid-cols-2 gap-4 mb-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">ã‚¿ã‚¤ãƒˆãƒ«</label>
                            <input type="text" id="pgbase-title"
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500"
                                placeholder="è¨˜äº‹ã®ã‚¿ã‚¤ãƒˆãƒ«">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">ã‚«ãƒ†ã‚´ãƒª</label>
                            <select id="pgbase-category"
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500">
                                <option value="nutrition">ğŸ¥— æ „é¤Šã®åŸºæœ¬</option>
                                <option value="protein">ğŸ– ã‚¿ãƒ³ãƒ‘ã‚¯è³ª</option>
                                <option value="carbs">ğŸš ç‚­æ°´åŒ–ç‰©</option>
                                <option value="fat">ğŸ¥‘ è„‚è³ª</option>
                                <option value="vitamins">ğŸ’Š ãƒ“ã‚¿ãƒŸãƒ³ãƒ»ãƒŸãƒãƒ©ãƒ«</option>
                                <option value="training">ğŸ’ª ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°</option>
                                <option value="recovery">ğŸ˜´ å›å¾©ãƒ»ä¼‘é¤Š</option>
                                <option value="mindset">ğŸ§  ãƒ¡ãƒ³ã‚¿ãƒ«</option>
                            </select>
                        </div>
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-1">æ¦‚è¦</label>
                        <input type="text" id="pgbase-summary"
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500"
                            placeholder="è¨˜äº‹ã®æ¦‚è¦ï¼ˆä¸€è¦§ã«è¡¨ç¤ºï¼‰">
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-1">æœ¬æ–‡ï¼ˆMarkdownå¯¾å¿œï¼‰</label>
                        <textarea id="pgbase-content" rows="8"
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500"
                            placeholder="è¨˜äº‹ã®æœ¬æ–‡ã‚’Markdownå½¢å¼ã§å…¥åŠ›..."></textarea>
                    </div>
                    <div class="grid md:grid-cols-3 gap-4 mb-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">èª­äº†æ™‚é–“ï¼ˆåˆ†ï¼‰</label>
                            <input type="number" id="pgbase-reading-time" value="5" min="1"
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">è¡¨ç¤ºé †åº</label>
                            <input type="number" id="pgbase-order" value="0" min="0"
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500">
                        </div>
                        <div class="flex items-end">
                            <label class="flex items-center gap-2">
                                <input type="checkbox" id="pgbase-premium" class="w-5 h-5">
                                <span class="text-sm font-medium text-gray-700">ãƒ—ãƒ¬ãƒŸã‚¢ãƒ è¨˜äº‹</span>
                            </label>
                        </div>
                    </div>
                    <button onclick="createPgBaseArticle()" id="create-article-btn" class="btn-primary">
                        âœ¨ è¨˜äº‹ã‚’ä½œæˆ
                    </button>
                </div>
            </div>

            <!-- è¨˜äº‹ä¸€è¦§ -->
            <div class="section">
                <div class="section-header">
                    <h2>ğŸ“š è¨˜äº‹ä¸€è¦§</h2>
                    <button onclick="loadPgBaseArticles()" class="btn-secondary">ğŸ”„ æ›´æ–°</button>
                </div>
                <div class="section-content">
                    <div id="pgbase-loading" class="loading">è¨˜äº‹ã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™...</div>
                    <div id="pgbase-list" class="space-y-4" style="display:none;"></div>
                    <div id="pgbase-empty" class="empty-state" style="display:none;">
                        <div class="empty-state-icon">ğŸ“š</div>
                        <p>ã¾ã è¨˜äº‹ãŒã‚ã‚Šã¾ã›ã‚“</p>
                    </div>
                </div>
            </div>
        </div><!-- PGBASEã‚»ã‚¯ã‚·ãƒ§ãƒ³çµ‚äº† -->

        <!-- ä½¿ç”¨çŠ¶æ³åˆ†æã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
        <div id="analytics-section" style="display:none;">
            <!-- æœŸé–“ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ -->
            <div class="section mb-6">
                <div class="section-content">
                    <div class="flex flex-wrap gap-3 items-center">
                        <label class="flex items-center gap-2">
                            <span class="text-sm font-medium">æœŸé–“:</span>
                            <select id="analytics-period" onchange="loadAnalytics()" class="px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500">
                                <option value="7">éå»7æ—¥</option>
                                <option value="30" selected>éå»30æ—¥</option>
                                <option value="90">éå»90æ—¥</option>
                                <option value="365">éå»1å¹´</option>
                            </select>
                        </label>
                        <button onclick="loadAnalytics()" class="btn-secondary">ğŸ”„ æ›´æ–°</button>
                    </div>
                </div>
            </div>

            <!-- çµ±è¨ˆã‚µãƒãƒªãƒ¼ -->
            <div class="stats-grid">
                <div class="stat-card">
                    <h3>ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒ¦ãƒ¼ã‚¶ãƒ¼</h3>
                    <div class="value" id="analytics-users">-</div>
                </div>
                <div class="stat-card">
                    <h3>ç·ã‚¤ãƒ™ãƒ³ãƒˆæ•°</h3>
                    <div class="value" id="analytics-events">-</div>
                </div>
                <div class="stat-card">
                    <h3>ä½¿ç”¨æ©Ÿèƒ½æ•°</h3>
                    <div class="value" id="analytics-features-used">-</div>
                </div>
                <div class="stat-card">
                    <h3>æœªä½¿ç”¨æ©Ÿèƒ½æ•°</h3>
                    <div class="value text-red-600" id="analytics-features-unused">-</div>
                </div>
            </div>

            <!-- ã‚«ãƒ†ã‚´ãƒªåˆ¥ä½¿ç”¨ç‡ -->
            <div class="section mb-6">
                <div class="section-header">
                    <h2>ğŸ“Š ã‚«ãƒ†ã‚´ãƒªåˆ¥ä½¿ç”¨ç‡</h2>
                </div>
                <div class="section-content">
                    <div id="analytics-categories" class="grid grid-cols-2 md:grid-cols-4 gap-4"></div>
                </div>
            </div>

            <!-- æ©Ÿèƒ½ãƒ©ãƒ³ã‚­ãƒ³ã‚° -->
            <div class="grid md:grid-cols-2 gap-6 mb-6">
                <!-- äººæ°—æ©Ÿèƒ½TOP10 -->
                <div class="section">
                    <div class="section-header">
                        <h2>ğŸ”¥ äººæ°—æ©Ÿèƒ½TOP10</h2>
                    </div>
                    <div class="section-content">
                        <div id="analytics-top-features" class="space-y-2"></div>
                    </div>
                </div>

                <!-- æœªä½¿ç”¨æ©Ÿèƒ½ -->
                <div class="section">
                    <div class="section-header">
                        <h2>âš ï¸ æœªä½¿ç”¨æ©Ÿèƒ½</h2>
                    </div>
                    <div class="section-content">
                        <div id="analytics-unused-features" class="space-y-2"></div>
                    </div>
                </div>
            </div>

            <!-- æ—¥åˆ¥æ¨ç§» -->
            <div class="section mb-6">
                <div class="section-header">
                    <h2>ğŸ“ˆ æ—¥åˆ¥ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£</h2>
                </div>
                <div class="section-content">
                    <div id="analytics-daily" class="overflow-x-auto">
                        <div class="flex gap-1 min-w-max" id="analytics-daily-chart"></div>
                    </div>
                </div>
            </div>

            <!-- ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§ -->
            <div class="section">
                <div class="section-header">
                    <h2>ğŸ‘¥ ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ©ãƒ³ã‚­ãƒ³ã‚°</h2>
                    <span id="analytics-user-count" class="text-sm text-gray-500"></span>
                </div>
                <div class="section-content">
                    <div id="analytics-loading" class="loading">ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™...</div>
                    <div id="analytics-users-list" style="display:none;">
                        <div class="overflow-x-auto">
                            <table class="min-w-full text-sm">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-4 py-3 text-left font-medium text-gray-600">é †ä½</th>
                                        <th class="px-4 py-3 text-left font-medium text-gray-600">ãƒ¦ãƒ¼ã‚¶ãƒ¼</th>
                                        <th class="px-4 py-3 text-left font-medium text-gray-600">ã‚¤ãƒ™ãƒ³ãƒˆæ•°</th>
                                        <th class="px-4 py-3 text-left font-medium text-gray-600">ä½¿ç”¨æ©Ÿèƒ½æ•°</th>
                                        <th class="px-4 py-3 text-left font-medium text-gray-600">è©³ç´°</th>
                                    </tr>
                                </thead>
                                <tbody id="analytics-users-tbody" class="divide-y divide-gray-200"></tbody>
                            </table>
                        </div>
                    </div>
                    <div id="analytics-empty" class="empty-state" style="display:none;">
                        <div class="empty-state-icon">ğŸ“Š</div>
                        <p>ã¾ã åˆ†æãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</p>
                    </div>
                </div>
            </div>
        </div><!-- ä½¿ç”¨çŠ¶æ³åˆ†æã‚»ã‚¯ã‚·ãƒ§ãƒ³çµ‚äº† -->
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-functions-compat.js"></script>
    <script src="/config.js"></script>

    <script>
        // FirebaseåˆæœŸåŒ–
        firebase.initializeApp(FIREBASE_CONFIG);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const functions = firebase.app().functions('asia-northeast2');

        // ç®¡ç†è€…ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã®ãƒ›ãƒ¯ã‚¤ãƒˆãƒªã‚¹ãƒˆ
        const ADMIN_EMAILS = [
            'official@your-coach-plus.com'
        ];

        // ç®¡ç†è€…PIN
        let adminPassword = '';

        // èªè¨¼ãƒã‚§ãƒƒã‚¯
        auth.onAuthStateChanged(async (user) => {
            if (!user || !ADMIN_EMAILS.includes(user.email)) {
                // æœªãƒ­ã‚°ã‚¤ãƒ³ã¾ãŸã¯ç®¡ç†è€…ã§ãªã„å ´åˆã¯ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã¸
                window.location.href = '/admin-login.html';
                return;
            }

            // ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±è¡¨ç¤º
            document.getElementById('user-info').textContent = user.email;

            // ç®¡ç†è€…PINã‚’å–å¾—ï¼ˆãƒ—ãƒ­ãƒ³ãƒ—ãƒˆï¼‰
            adminPassword = prompt('4æ¡ã®ç®¡ç†è€…PINã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
            if (!adminPassword) {
                alert('PINãŒå¿…è¦ã§ã™');
            }

            // ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
            await loadGiftCodes();
            await loadOrganizations();
        });

        // ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ
        function switchTab(tab) {
            const sections = ['giftcode', 'b2b2c', 'users', 'referrals', 'comy', 'pgbase', 'analytics'];
            const activeClass = 'px-6 py-3 rounded-lg font-bold transition bg-purple-600 text-white';
            const inactiveClass = 'px-6 py-3 rounded-lg font-bold transition bg-gray-200 text-gray-700 hover:bg-gray-300';

            sections.forEach(s => {
                const section = document.getElementById(s + '-section');
                const tabBtn = document.getElementById('tab-' + s);
                if (section) section.style.display = s === tab ? 'block' : 'none';
                if (tabBtn) tabBtn.className = s === tab ? activeClass : inactiveClass;
            });

            // ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
            if (tab === 'users') loadUsers();
            if (tab === 'referrals') loadReferrals();
            if (tab === 'comy') loadComyPosts();
            if (tab === 'pgbase') loadPgBaseArticles();
            if (tab === 'analytics') loadAnalytics();
        }

        // ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
        function logout() {
            auth.signOut().then(() => {
                window.location.href = '/admin-login.html';
            });
        }

        // ä¼æ¥­ä¸€è¦§èª­ã¿è¾¼ã¿
        async function loadOrganizations() {
            try {
                const snapshot = await db.collection('b2b2cOrganizations').get();

                const loading = document.getElementById('loading');
                const orgList = document.getElementById('org-list');
                const emptyState = document.getElementById('empty-state');

                loading.style.display = 'none';

                if (snapshot.empty) {
                    emptyState.style.display = 'block';
                    updateStats([], 0, 0);
                    return;
                }

                orgList.style.display = 'flex';

                const organizations = [];
                let totalLicenses = 0;
                let usedLicenses = 0;

                snapshot.forEach(doc => {
                    const org = { id: doc.id, ...doc.data() };
                    organizations.push(org);

                    if (org.licenses !== -1) {
                        totalLicenses += org.licenses;
                    }
                    usedLicenses += org.users ? org.users.length : 0;
                });

                // å„ä¼æ¥­ã®ä½¿ç”¨è€…ã‚’å–å¾—
                for (const org of organizations) {
                    console.log(`[B2B2C] Searching users for org ${org.id} (${org.name})`);
                    const usersSnapshot = await db.collection('users')
                        .where('b2b2cOrgId', '==', org.id)
                        .get();
                    org.users = [];
                    console.log(`[B2B2C] Found ${usersSnapshot.size} users`);
                    usersSnapshot.forEach(userDoc => {
                        const userData = userDoc.data();
                        org.users.push({
                            id: userDoc.id,
                            email: userData.email || 'ä¸æ˜',
                            displayName: userData.displayName || userData.nickname || 'åå‰æœªè¨­å®š'
                        });
                    });
                }

                // çµ±è¨ˆæƒ…å ±æ›´æ–°
                updateStats(organizations, totalLicenses, usedLicenses);

                // ä¼æ¥­ã‚«ãƒ¼ãƒ‰è¡¨ç¤º
                orgList.innerHTML = organizations.map(org => createOrgCard(org)).join('');

            } catch (error) {
                console.error('Error loading organizations:', error);
                document.getElementById('loading').innerHTML =
                    '<p style="color: red;">ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message + '</p>';
            }
        }

        // çµ±è¨ˆæƒ…å ±æ›´æ–°
        function updateStats(organizations, totalLicenses, usedLicenses) {
            document.getElementById('total-orgs').textContent = organizations.length;
            document.getElementById('total-licenses').textContent =
                totalLicenses > 0 ? totalLicenses : 'ç„¡åˆ¶é™å«ã‚€';
            document.getElementById('used-licenses').textContent = usedLicenses;

            // æœˆé–“åç›Šè¨ˆç®—ï¼ˆå¹´é–“ãƒ—ãƒ©ãƒ³ã‚’12ã§å‰²ã‚‹ï¼‰
            const monthlyRevenue = organizations.reduce((sum, org) => {
                return sum + (org.price || 0) / 12;
            }, 0);
            document.getElementById('monthly-revenue').textContent =
                'Â¥' + Math.round(monthlyRevenue).toLocaleString();
        }

        // ä¼æ¥­ã‚«ãƒ¼ãƒ‰ç”Ÿæˆ
        function createOrgCard(org) {
            const usagePercent = org.licenses === -1
                ? 0
                : Math.round(((org.users ? org.users.length : 0) / org.licenses) * 100);

            const planName = getPlanName(org.planId);
            const statusClass = org.status === 'active' ? 'active' : 'cancelled';
            const statusText = org.status === 'active' ? 'âœ… æœ‰åŠ¹' : 'âŒ ç„¡åŠ¹';

            return `
                <div class="org-card">
                    <div class="org-header">
                        <div>
                            <div class="org-name">${org.name || 'ä¼æ¥­åæœªè¨­å®š'}</div>
                            <div class="org-email">${org.email || 'ãƒ¡ãƒ¼ãƒ«æœªè¨­å®š'}</div>
                        </div>
                        <div class="org-status ${statusClass}">${statusText}</div>
                    </div>

                    <div class="org-info">
                        <div class="org-info-item">
                            <div class="org-info-label">ãƒ—ãƒ©ãƒ³</div>
                            <div class="org-info-value">${planName}</div>
                        </div>
                        <div class="org-info-item">
                            <div class="org-info-label">å¹´é–“æ–™é‡‘</div>
                            <div class="org-info-value">Â¥${(org.price || 0).toLocaleString()}</div>
                        </div>
                        <div class="org-info-item">
                            <div class="org-info-label">ãƒ©ã‚¤ã‚»ãƒ³ã‚¹ä½¿ç”¨çŠ¶æ³</div>
                            <div class="org-info-value">
                                ${org.users ? org.users.length : 0} / ${org.licenses === -1 ? 'ç„¡åˆ¶é™' : org.licenses}
                                ${org.licenses !== -1 ? `(${usagePercent}%)` : ''}
                            </div>
                            ${org.licenses !== -1 ? `
                                <div class="progress-bar">
                                    <div class="progress-fill" style="width: ${usagePercent}%"></div>
                                </div>
                            ` : ''}
                        </div>
                        <div class="org-info-item">
                            <div class="org-info-label">æœ‰åŠ¹æœŸé™</div>
                            <div class="org-info-value">
                                ${org.validUntil ? formatDate(org.validUntil.toDate()) : 'æœªè¨­å®š'}
                            </div>
                        </div>
                    </div>

                    <div class="org-info-item">
                        <div class="org-info-label">ã‚¢ã‚¯ã‚»ã‚¹ã‚³ãƒ¼ãƒ‰</div>
                        <div class="code-display">${org.accessCode || 'ã‚³ãƒ¼ãƒ‰æœªç™ºè¡Œ'}</div>
                    </div>

                    ${org.users && org.users.length > 0 ? `
                        <details class="mt-4">
                            <summary class="text-sm text-blue-600 cursor-pointer hover:underline font-medium">
                                ğŸ‘¥ ä½¿ç”¨è€…ä¸€è¦§ (${org.users.length}äºº)
                            </summary>
                            <div class="mt-2 bg-gray-50 rounded-lg p-3 space-y-2 border border-gray-200">
                                ${org.users.map((user, i) => `
                                    <div class="text-sm flex items-center gap-2 ${i > 0 ? 'pt-2 border-t border-gray-100' : ''}">
                                        <span class="w-6 h-6 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center text-xs font-bold">${i + 1}</span>
                                        <div>
                                            <span class="text-gray-800 font-medium">${user.displayName}</span>
                                            <span class="text-gray-400 text-xs ml-2">${user.email}</span>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </details>
                    ` : '<p class="text-sm text-gray-400 mt-4">ğŸ‘¥ ä½¿ç”¨è€…ãªã—</p>'}
                </div>
            `;
        }

        // ãƒ—ãƒ©ãƒ³åå–å¾—
        function getPlanName(planId) {
            const planNames = {
                'beginner': 'ãƒ“ã‚®ãƒŠãƒ¼ãƒ—ãƒ©ãƒ³ï¼ˆ10äººï¼‰',
                'pro': 'ãƒ—ãƒ­ãƒ—ãƒ©ãƒ³ï¼ˆ30äººï¼‰',
                'max': 'MAXãƒ—ãƒ©ãƒ³ï¼ˆç„¡åˆ¶é™ï¼‰',
                'custom_beginner': 'ã‚«ã‚¹ã‚¿ãƒ ãƒ“ã‚®ãƒŠãƒ¼ï¼ˆ10äººãƒ»30%OFFï¼‰',
                'custom_pro': 'ã‚«ã‚¹ã‚¿ãƒ ãƒ—ãƒ­ï¼ˆ30äººãƒ»30%OFFï¼‰',
                'custom_max': 'ã‚«ã‚¹ã‚¿ãƒ MAXï¼ˆç„¡åˆ¶é™ãƒ»30%OFFï¼‰'
            };
            return planNames[planId] || planId;
        }

        // æ—¥ä»˜ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
        function formatDate(date) {
            return date.toLocaleDateString('ja-JP', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit'
            });
        }

        // ===== ã‚®ãƒ•ãƒˆã‚³ãƒ¼ãƒ‰ç®¡ç†æ©Ÿèƒ½ =====

        // ã‚®ãƒ•ãƒˆã‚³ãƒ¼ãƒ‰ä¸€è¦§èª­ã¿è¾¼ã¿
        async function loadGiftCodes() {
            if (!adminPassword) {
                document.getElementById('giftcode-loading').innerHTML = '<p style="color: orange;">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“</p>';
                return;
            }

            try {
                const getGiftCodes = functions.httpsCallable('getGiftCodes');
                const result = await getGiftCodes({ adminPassword });

                const loading = document.getElementById('giftcode-loading');
                const list = document.getElementById('giftcode-list');
                const empty = document.getElementById('giftcode-empty');

                loading.style.display = 'none';

                if (!result.data.success || result.data.codes.length === 0) {
                    empty.style.display = 'block';
                    list.style.display = 'none';
                    return;
                }

                empty.style.display = 'none';
                list.style.display = 'block';
                console.log('[GiftCodes] Result:', result.data.codes);
                renderGiftCodes(result.data.codes);

            } catch (error) {
                console.error('Load gift codes error:', error);
                document.getElementById('giftcode-loading').innerHTML =
                    '<p style="color: red;">ã‚¨ãƒ©ãƒ¼: ' + (error.message || 'ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒæ­£ã—ããªã„å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™') + '</p>';
            }
        }

        // ã‚®ãƒ•ãƒˆã‚³ãƒ¼ãƒ‰ä¸€è¦§è¡¨ç¤º
        function renderGiftCodes(codes) {
            const container = document.getElementById('giftcode-list');
            container.innerHTML = codes.map(code => `
                <div class="border-2 rounded-xl p-4 transition-all ${code.isActive ? 'border-green-300 bg-green-50' : 'border-gray-200 bg-gray-100'}">
                    <div class="flex items-start justify-between mb-3">
                        <div class="flex items-center gap-3">
                            <span class="font-mono font-bold text-xl ${code.isActive ? 'text-green-700' : 'text-gray-400'}">${code.code}</span>
                            <span class="px-2 py-1 text-xs rounded-full font-medium ${code.isActive ? 'bg-green-200 text-green-800' : 'bg-gray-200 text-gray-600'}">
                                ${code.isActive ? 'âœ… æœ‰åŠ¹' : 'âŒ ç„¡åŠ¹'}
                            </span>
                        </div>
                        <div class="flex items-center gap-2">
                            <button onclick="toggleGiftCode('${code.code}', ${!code.isActive})"
                                class="px-3 py-1.5 text-sm rounded-lg font-medium transition ${code.isActive ? 'bg-orange-100 text-orange-700 hover:bg-orange-200' : 'bg-green-100 text-green-700 hover:bg-green-200'}">
                                ${code.isActive ? 'ğŸ”’ ç„¡åŠ¹åŒ–' : 'ğŸ”“ æœ‰åŠ¹åŒ–'}
                            </button>
                            <button onclick="deleteGiftCode('${code.code}')"
                                class="px-3 py-1.5 text-sm rounded-lg font-medium bg-red-100 text-red-700 hover:bg-red-200 transition">
                                ğŸ—‘ï¸ å‰Šé™¤
                            </button>
                        </div>
                    </div>

                    ${code.note ? `<p class="text-sm text-gray-600 mb-3">ğŸ“ ${code.note}</p>` : ''}

                    <div class="flex flex-wrap items-center gap-4 text-sm text-gray-600">
                        <span>ğŸ‘¥ ä½¿ç”¨è€…: <strong class="text-gray-800">${code.usedCount}äºº</strong></span>
                        ${code.createdAt ? `<span>ğŸ“… ä½œæˆ: ${new Date(code.createdAt).toLocaleDateString('ja-JP')}</span>` : ''}
                        ${code.lastUsedAt ? `<span>ğŸ• æœ€çµ‚ä½¿ç”¨: ${new Date(code.lastUsedAt).toLocaleDateString('ja-JP')}</span>` : ''}
                    </div>

                    ${code.usedByDetails && code.usedByDetails.length > 0 ? `
                        <details class="mt-3" open>
                            <summary class="text-sm text-purple-600 cursor-pointer hover:underline font-medium">
                                ğŸ‘¤ ä½¿ç”¨è€…è©³ç´° (${code.usedByDetails.length}äºº)
                            </summary>
                            <div class="mt-2 bg-white rounded-lg p-3 space-y-2 border border-gray-200">
                                ${code.usedByDetails.map((user, i) => `
                                    <div class="text-sm flex items-center gap-2 ${i > 0 ? 'pt-2 border-t border-gray-100' : ''}">
                                        <span class="w-6 h-6 rounded-full bg-purple-100 text-purple-600 flex items-center justify-center text-xs font-bold">${i + 1}</span>
                                        <div>
                                            <span class="text-gray-800 font-medium">${user.displayName || 'åå‰æœªè¨­å®š'}</span>
                                            <span class="text-gray-400 text-xs ml-2">${user.email || 'ãƒ¡ãƒ¼ãƒ«æœªå–å¾—'}</span>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </details>
                    ` : `<p class="text-sm text-gray-400 mt-3">ğŸ‘¤ ä½¿ç”¨è€…è©³ç´°: ãªã—ï¼ˆusedCount: ${code.usedCount}ï¼‰</p>`}
                </div>
            `).join('');
        }

        // ã‚®ãƒ•ãƒˆã‚³ãƒ¼ãƒ‰ä½œæˆ
        async function createGiftCode() {
            const code = document.getElementById('new-code').value.trim().toUpperCase();
            const note = document.getElementById('new-note').value.trim();
            const btn = document.getElementById('create-btn');

            if (!code) {
                alert('ã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }
            if (code.length < 3) {
                alert('ã‚³ãƒ¼ãƒ‰ã¯3æ–‡å­—ä»¥ä¸Šã§å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }

            btn.disabled = true;
            btn.textContent = 'â³ ä½œæˆä¸­...';

            try {
                const createGiftCodeFn = functions.httpsCallable('createGiftCode');
                const result = await createGiftCodeFn({ code, note, adminPassword });

                if (result.data.success) {
                    alert('âœ… ã‚³ãƒ¼ãƒ‰ã‚’ä½œæˆã—ã¾ã—ãŸ\n\nã‚³ãƒ¼ãƒ‰: ' + code);
                    document.getElementById('new-code').value = '';
                    document.getElementById('new-note').value = '';
                    await loadGiftCodes();
                }
            } catch (error) {
                console.error('Create code error:', error);
                alert('âŒ ' + (error.message || 'ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸ'));
            } finally {
                btn.disabled = false;
                btn.textContent = 'âœ¨ ã‚³ãƒ¼ãƒ‰ã‚’ä½œæˆ';
            }
        }

        // ã‚®ãƒ•ãƒˆã‚³ãƒ¼ãƒ‰æœ‰åŠ¹/ç„¡åŠ¹åˆ‡ã‚Šæ›¿ãˆ
        async function toggleGiftCode(code, isActive) {
            if (!confirm(`ã‚³ãƒ¼ãƒ‰ã€Œ${code}ã€ã‚’${isActive ? 'æœ‰åŠ¹åŒ–' : 'ç„¡åŠ¹åŒ–'}ã—ã¾ã™ã‹ï¼Ÿ`)) return;

            try {
                const toggleGiftCodeFn = functions.httpsCallable('toggleGiftCode');
                const result = await toggleGiftCodeFn({ code, isActive, adminPassword });
                if (result.data.success) {
                    await loadGiftCodes();
                }
            } catch (error) {
                console.error('Toggle code error:', error);
                alert('âŒ æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (error.message || error));
            }
        }

        // ã‚®ãƒ•ãƒˆã‚³ãƒ¼ãƒ‰å‰Šé™¤
        async function deleteGiftCode(code) {
            if (!confirm(`âš ï¸ ã‚³ãƒ¼ãƒ‰ã€Œ${code}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\n\nã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚`)) return;

            try {
                const deleteGiftCodeFn = functions.httpsCallable('deleteGiftCode');
                const result = await deleteGiftCodeFn({ code, adminPassword });
                if (result.data.success) {
                    await loadGiftCodes();
                }
            } catch (error) {
                console.error('Delete code error:', error);
                alert('âŒ å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (error.message || error));
            }
        }

        // ===== ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†æ©Ÿèƒ½ =====
        let allUsers = [];

        async function loadUsers() {
            const loading = document.getElementById('users-loading');
            const list = document.getElementById('users-list');
            const empty = document.getElementById('users-empty');
            const filter = document.getElementById('user-filter').value;

            loading.style.display = 'block';
            list.style.display = 'none';
            empty.style.display = 'none';

            try {
                // Cloud Functionã‹ã‚‰ Firebase Auth æƒ…å ±ã‚’å«ã‚€ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§ã‚’å–å¾—
                console.log('[Admin] Calling getAdminUserList...');
                const getAdminUserList = functions.httpsCallable('getAdminUserList');
                const result = await getAdminUserList();
                console.log('[Admin] Result:', result.data);

                if (!result.data.success) {
                    throw new Error('ãƒ‡ãƒ¼ã‚¿å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
                }

                // æœ€åˆã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æ—¥ä»˜ã‚’ç¢ºèª
                if (result.data.users.length > 0) {
                    console.log('[Admin] First user dates:', {
                        createdAt: result.data.users[0].createdAt,
                        lastLoginAt: result.data.users[0].lastLoginAt
                    });
                }

                allUsers = [];
                const now = new Date();
                let premiumCount = 0;
                let codeCount = 0;
                let trialCount = 0;

                result.data.users.forEach(user => {
                    // Premiumåˆ¤å®š
                    const isPremium = user.subscription?.status === 'active' ||
                                      user.b2b2cOrgId ||
                                      user.subscription?.giftCodeActive === true;

                    // ç™»éŒ²æ—¥ãƒ»ãƒ­ã‚°ã‚¤ãƒ³æ—¥ï¼ˆFirebase Authã‹ã‚‰å–å¾—æ¸ˆã¿ï¼‰
                    const regDate = user.createdAt ? new Date(user.createdAt) : new Date();
                    const lastLogin = user.lastLoginAt ? new Date(user.lastLoginAt) : null;
                    const daysSinceReg = Math.floor((now - regDate) / (1000 * 60 * 60 * 24));
                    const isTrialActive = !isPremium && daysSinceReg <= 7;

                    user._isPremium = isPremium;
                    user._isTrialActive = isTrialActive;
                    user._regDate = regDate;
                    user._lastLogin = lastLogin;
                    user._daysSinceReg = daysSinceReg;

                    allUsers.push(user);

                    if (isPremium) premiumCount++;
                    if (user.b2b2cOrgId || user.subscription?.giftCodeActive) codeCount++;
                    if (isTrialActive) trialCount++;
                });

                // çµ±è¨ˆæ›´æ–°
                document.getElementById('total-users').textContent = allUsers.length;
                document.getElementById('premium-users').textContent = premiumCount;
                document.getElementById('code-users').textContent = codeCount;
                document.getElementById('trial-users').textContent = trialCount;

                // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼é©ç”¨
                let filtered = allUsers;
                switch (filter) {
                    case 'premium':
                        filtered = allUsers.filter(u => u._isPremium);
                        break;
                    case 'b2b':
                        filtered = allUsers.filter(u => u.b2b2cOrgId);
                        break;
                    case 'gift':
                        filtered = allUsers.filter(u => u.subscription?.giftCodeActive);
                        break;
                    case 'stripe':
                        filtered = allUsers.filter(u => u.subscription?.status === 'active' && !u.b2b2cOrgId && !u.subscription?.giftCodeActive);
                        break;
                    case 'trial':
                        filtered = allUsers.filter(u => u._isTrialActive);
                        break;
                }

                // ç™»éŒ²æ—¥ã§ã‚½ãƒ¼ãƒˆï¼ˆæ–°ã—ã„é †ï¼‰
                filtered.sort((a, b) => b._regDate - a._regDate);

                loading.style.display = 'none';

                if (filtered.length === 0) {
                    empty.style.display = 'block';
                    return;
                }

                list.style.display = 'block';
                document.getElementById('user-count').textContent = `${filtered.length}äºº`;
                renderUsers(filtered);

            } catch (error) {
                console.error('Load users error:', error);
                loading.innerHTML = '<p style="color: red;">ã‚¨ãƒ©ãƒ¼: ' + error.message + '</p>';
            }
        }

        function renderUsers(users) {
            const tbody = document.getElementById('users-tbody');
            tbody.innerHTML = users.map(user => {
                const status = [];
                if (user.subscription?.status === 'active' && !user.b2b2cOrgId && !user.subscription?.giftCodeActive) {
                    status.push('<span class="px-2 py-1 text-xs rounded-full bg-yellow-100 text-yellow-800">ğŸ’³ Stripe</span>');
                }
                if (user.b2b2cOrgId) {
                    status.push('<span class="px-2 py-1 text-xs rounded-full bg-blue-100 text-blue-800">ğŸ¢ B2B</span>');
                }
                if (user.subscription?.giftCodeActive) {
                    status.push('<span class="px-2 py-1 text-xs rounded-full bg-purple-100 text-purple-800">ğŸ ã‚®ãƒ•ãƒˆ</span>');
                }
                if (user._isTrialActive) {
                    status.push('<span class="px-2 py-1 text-xs rounded-full bg-green-100 text-green-800">ğŸ†“ ãƒˆãƒ©ã‚¤ã‚¢ãƒ«</span>');
                }
                if (user.referredBy) {
                    status.push('<span class="px-2 py-1 text-xs rounded-full bg-pink-100 text-pink-800">ğŸ¤ ç´¹ä»‹</span>');
                }
                if (status.length === 0) {
                    status.push('<span class="px-2 py-1 text-xs rounded-full bg-gray-100 text-gray-600">ç„¡æ–™</span>');
                }

                const freeCredits = user.freeCredits || 0;
                const paidCredits = user.paidCredits || 0;

                return `
                    <tr class="hover:bg-gray-50">
                        <td class="px-4 py-3">
                            <div class="font-medium text-gray-900">${user.displayName || user.nickname || 'åå‰æœªè¨­å®š'}</div>
                            <div class="text-xs text-gray-500">${user.email || 'ãƒ¡ãƒ¼ãƒ«æœªè¨­å®š'}</div>
                        </td>
                        <td class="px-4 py-3">
                            <div class="flex flex-wrap gap-1">
                                ${status.join('')}
                            </div>
                        </td>
                        <td class="px-4 py-3 text-gray-600">
                            ${user._regDate.toLocaleDateString('ja-JP')}
                            <div class="text-xs text-gray-400">${user._daysSinceReg}æ—¥ç›®</div>
                        </td>
                        <td class="px-4 py-3 text-gray-600">
                            ${user._lastLogin ? user._lastLogin.toLocaleDateString('ja-JP') : '-'}
                        </td>
                        <td class="px-4 py-3">
                            <div class="text-xs">
                                <span class="text-green-600">ç„¡æ–™: ${freeCredits}</span> /
                                <span class="text-blue-600">æœ‰å„Ÿ: ${paidCredits}</span>
                            </div>
                        </td>
                        <td class="px-4 py-3">
                            <button onclick="showUserDetail('${user.id}')" class="text-purple-600 hover:underline text-sm">
                                è©³ç´°
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function showUserDetail(userId) {
            const user = allUsers.find(u => u.id === userId);
            if (!user) return;

            const details = [
                `ID: ${user.id}`,
                `ãƒ¡ãƒ¼ãƒ«: ${user.email || 'æœªè¨­å®š'}`,
                `åå‰: ${user.displayName || user.nickname || 'æœªè¨­å®š'}`,
                `ç™»éŒ²æ—¥: ${user._regDate.toLocaleDateString('ja-JP')}`,
                `---`,
                `ç„¡æ–™ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆ: ${user.freeCredits || 0}`,
                `æœ‰å„Ÿã‚¯ãƒ¬ã‚¸ãƒƒãƒˆ: ${user.paidCredits || 0}`,
                `---`,
                `Stripeã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: ${user.subscription?.status || 'ãªã—'}`,
                `B2Bçµ„ç¹”ID: ${user.b2b2cOrgId || 'ãªã—'}`,
                `ã‚®ãƒ•ãƒˆã‚³ãƒ¼ãƒ‰: ${user.subscription?.giftCodeActive ? 'æœ‰åŠ¹' : 'ãªã—'}`,
                `---`,
                `ç´¹ä»‹ã‚³ãƒ¼ãƒ‰: ${user.referralCode || 'æœªç™ºè¡Œ'}`,
                `ç´¹ä»‹è€…ID: ${user.referredBy || 'ãªã—'}`,
            ];

            alert(details.join('\n'));
        }

        // ===== ç´¹ä»‹ã‚³ãƒ¼ãƒ‰ç®¡ç†æ©Ÿèƒ½ =====
        let allReferrals = [];

        async function loadReferrals() {
            const loading = document.getElementById('referrals-loading');
            const list = document.getElementById('referrals-list');
            const empty = document.getElementById('referrals-empty');

            loading.style.display = 'block';
            list.style.display = 'none';
            empty.style.display = 'none';

            try {
                // referralsã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‚’å–å¾—
                const snapshot = await db.collection('referrals').orderBy('createdAt', 'desc').get();
                allReferrals = [];

                const referrerMap = {};

                snapshot.forEach(doc => {
                    const data = doc.data();
                    allReferrals.push({ id: doc.id, ...data });

                    // ç´¹ä»‹è€…åˆ¥é›†è¨ˆ
                    const referrerId = data.referrerId;
                    if (!referrerMap[referrerId]) {
                        referrerMap[referrerId] = {
                            referrerId,
                            referrerName: data.referrerInfo?.displayName || 'ä¸æ˜',
                            referrerEmail: data.referrerInfo?.email || 'ä¸æ˜',
                            referees: []
                        };
                    }
                    referrerMap[referrerId].referees.push(data);
                });

                // çµ±è¨ˆæ›´æ–°
                const uniqueReferrers = Object.keys(referrerMap).length;
                document.getElementById('total-referrals').textContent = allReferrals.length;
                document.getElementById('referrer-count').textContent = uniqueReferrers;
                document.getElementById('referee-count').textContent = allReferrals.length;
                document.getElementById('total-referral-credits').textContent = (allReferrals.length * 100) + 'å›'; // åŒæ–¹50ãšã¤

                loading.style.display = 'none';

                if (allReferrals.length === 0) {
                    empty.style.display = 'block';
                    document.getElementById('referrer-summary').innerHTML = '<p class="text-gray-500 text-center">ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</p>';
                    return;
                }

                list.style.display = 'block';
                renderReferrals(allReferrals);
                renderReferrerSummary(Object.values(referrerMap));

            } catch (error) {
                console.error('Load referrals error:', error);
                loading.innerHTML = '<p style="color: red;">ã‚¨ãƒ©ãƒ¼: ' + error.message + '</p>';
            }
        }

        function renderReferrals(referrals) {
            const tbody = document.getElementById('referrals-tbody');
            tbody.innerHTML = referrals.map(ref => {
                const createdAt = ref.createdAt?.toDate?.() || new Date();
                return `
                    <tr class="hover:bg-gray-50">
                        <td class="px-4 py-3">
                            <div class="font-medium text-gray-900">${ref.referrerInfo?.displayName || 'ä¸æ˜'}</div>
                            <div class="text-xs text-gray-500">${ref.referrerInfo?.email || ''}</div>
                        </td>
                        <td class="px-4 py-3">
                            <span class="font-mono text-pink-600 font-medium">${ref.referralCode || '-'}</span>
                        </td>
                        <td class="px-4 py-3">
                            <div class="text-xs text-gray-500">${ref.referredUserId || '-'}</div>
                        </td>
                        <td class="px-4 py-3 text-gray-600 text-sm">
                            ${createdAt.toLocaleDateString('ja-JP')} ${createdAt.toLocaleTimeString('ja-JP', {hour: '2-digit', minute: '2-digit'})}
                        </td>
                        <td class="px-4 py-3">
                            <span class="px-2 py-1 text-xs rounded-full ${ref.status === 'completed' ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800'}">
                                ${ref.status === 'completed' ? 'âœ… å®Œäº†' : 'â³ ' + (ref.status || 'ä¸æ˜')}
                            </span>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function renderReferrerSummary(referrers) {
            const container = document.getElementById('referrer-summary');
            // ç´¹ä»‹äººæ•°ã§ã‚½ãƒ¼ãƒˆ
            referrers.sort((a, b) => b.referees.length - a.referees.length);

            container.innerHTML = referrers.map(r => `
                <div class="border border-gray-200 rounded-lg p-4">
                    <div class="flex items-start justify-between mb-2">
                        <div>
                            <div class="font-medium text-gray-900">${r.referrerName}</div>
                            <div class="text-sm text-gray-500">${r.referrerEmail}</div>
                        </div>
                        <div class="text-right">
                            <div class="text-2xl font-bold text-pink-600">${r.referees.length}äºº</div>
                            <div class="text-xs text-gray-500">ç´¹ä»‹</div>
                        </div>
                    </div>
                    <div class="text-sm text-gray-600">
                        ç²å¾—ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆ: <span class="font-medium text-green-600">${r.referees.length * 50}å›</span>
                    </div>
                </div>
            `).join('');
        }

        // ===== COMYæŠ•ç¨¿ç®¡ç†æ©Ÿèƒ½ï¼ˆãƒã‚¤ãƒ†ã‚£ãƒ–ã‚¢ãƒ—ãƒªç”¨ comy_postsï¼‰ =====
        let allComyPosts = [];
        let filteredComyPosts = [];

        async function loadComyPosts() {
            const loading = document.getElementById('comy-loading');
            const list = document.getElementById('comy-list');
            const empty = document.getElementById('comy-empty');

            loading.style.display = 'block';
            list.style.display = 'none';
            empty.style.display = 'none';

            try {
                // comy_posts ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‹ã‚‰ç›´æ¥å–å¾—
                const snapshot = await db.collection('comy_posts')
                    .orderBy('createdAt', 'desc')
                    .limit(200)
                    .get();

                allComyPosts = [];
                let questionCount = 0;
                let tipsCount = 0;
                let progressCount = 0;

                snapshot.forEach(doc => {
                    const data = doc.data();
                    const post = { id: doc.id, ...data };
                    allComyPosts.push(post);

                    // ã‚«ãƒ†ã‚´ãƒªåˆ¥ã‚«ã‚¦ãƒ³ãƒˆ
                    const category = (data.category || '').toLowerCase();
                    if (category === 'question') questionCount++;
                    else if (category === 'tips') tipsCount++;
                    else if (category === 'progress') progressCount++;
                });

                // çµ±è¨ˆæ›´æ–°
                document.getElementById('total-posts').textContent = allComyPosts.length;
                document.getElementById('question-posts').textContent = questionCount;
                document.getElementById('tips-posts').textContent = tipsCount;
                document.getElementById('progress-posts').textContent = progressCount;

                loading.style.display = 'none';

                // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼é©ç”¨
                filterComyPosts();

            } catch (error) {
                console.error('Load comy posts error:', error);
                loading.innerHTML = '<p style="color: red;">ã‚¨ãƒ©ãƒ¼: ' + error.message + '</p>';
            }
        }

        function filterComyPosts() {
            const searchText = (document.getElementById('comy-search')?.value || '').toLowerCase();
            const categoryFilter = document.getElementById('comy-filter').value;
            const list = document.getElementById('comy-list');
            const empty = document.getElementById('comy-empty');

            filteredComyPosts = allComyPosts.filter(post => {
                // ã‚«ãƒ†ã‚´ãƒªãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
                if (categoryFilter !== 'all') {
                    const postCategory = (post.category || '').toLowerCase();
                    if (postCategory !== categoryFilter) return false;
                }

                // ãƒ†ã‚­ã‚¹ãƒˆæ¤œç´¢
                if (searchText) {
                    const title = (post.title || '').toLowerCase();
                    const content = (post.content || '').toLowerCase();
                    const authorName = (post.authorName || '').toLowerCase();
                    if (!title.includes(searchText) && !content.includes(searchText) && !authorName.includes(searchText)) {
                        return false;
                    }
                }

                return true;
            });

            if (filteredComyPosts.length === 0) {
                list.style.display = 'none';
                empty.style.display = 'block';
                return;
            }

            list.style.display = 'block';
            empty.style.display = 'none';
            document.getElementById('comy-count').textContent = `${filteredComyPosts.length}ä»¶`;
            renderComyPosts(filteredComyPosts);
        }

        function renderComyPosts(posts) {
            const container = document.getElementById('comy-list');
            container.innerHTML = posts.map(post => {
                const categoryBadge = getComyCategoryBadge(post.category);
                const timestamp = post.createdAt ? new Date(post.createdAt).toLocaleString('ja-JP') : 'ä¸æ˜';
                const authorInitial = (post.authorName || 'U')[0].toUpperCase();

                return `
                    <div class="border-2 rounded-xl p-4 transition-all border-gray-200 bg-white hover:border-purple-300">
                        <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
                        <div class="flex items-start justify-between mb-3">
                            <div class="flex items-center gap-3">
                                ${post.authorPhotoUrl
                                    ? `<img src="${post.authorPhotoUrl}" alt="Avatar" class="w-10 h-10 rounded-full object-cover">`
                                    : `<div class="w-10 h-10 bg-gradient-to-br from-purple-500 to-pink-500 rounded-full flex items-center justify-center text-white font-bold">${authorInitial}</div>`
                                }
                                <div>
                                    <div class="font-bold text-gray-800">${post.authorName || 'åŒ¿å'}</div>
                                    <div class="text-xs text-gray-500">ID: ${post.userId || 'ä¸æ˜'}</div>
                                </div>
                            </div>
                            <div class="flex items-center gap-2 flex-wrap">
                                ${categoryBadge}
                            </div>
                        </div>

                        <!-- ã‚¿ã‚¤ãƒˆãƒ« -->
                        ${post.title ? `
                        <div class="text-lg font-semibold text-gray-800 mb-2">
                            ${post.title}
                        </div>
                        ` : ''}

                        <!-- æŠ•ç¨¿æ—¥æ™‚ -->
                        <div class="text-xs text-gray-500 mb-3">
                            ğŸ“… ${timestamp}
                        </div>

                        <!-- æŠ•ç¨¿å†…å®¹ -->
                        <div class="bg-gray-50 p-3 rounded-lg mb-3">
                            <p class="text-sm text-gray-800 whitespace-pre-wrap">${post.content || '(å†…å®¹ãªã—)'}</p>
                        </div>

                        <!-- ç”»åƒ -->
                        ${post.imageUrl ? `
                        <div class="mb-3">
                            <img src="${post.imageUrl}" alt="æŠ•ç¨¿ç”»åƒ" class="w-full max-h-64 object-cover rounded-lg border border-gray-200">
                        </div>
                        ` : ''}

                        <!-- çµ±è¨ˆ -->
                        <div class="flex items-center gap-4 text-sm text-gray-600 mb-3">
                            <span>â¤ï¸ ã„ã„ã­: ${post.likeCount || 0}</span>
                            <span>ğŸ’¬ ã‚³ãƒ¡ãƒ³ãƒˆ: ${post.commentCount || 0}</span>
                        </div>

                        <!-- ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ -->
                        <div class="flex gap-2 flex-wrap">
                            <button onclick="deleteComyPost('${post.id}')"
                                class="px-4 py-2 text-sm rounded-lg font-medium bg-red-100 text-red-700 hover:bg-red-200 transition flex items-center gap-1">
                                ğŸ—‘ï¸ å‰Šé™¤
                            </button>
                            <button onclick="showComyPostDetail('${post.id}')"
                                class="px-4 py-2 text-sm rounded-lg font-medium bg-gray-100 text-gray-700 hover:bg-gray-200 transition flex items-center gap-1">
                                ğŸ“„ è©³ç´°
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function getComyCategoryBadge(category) {
            const categories = {
                'question': { emoji: 'â“', name: 'è³ªå•', color: 'purple' },
                'tips': { emoji: 'ğŸ’¡', name: 'ã‚³ãƒ„ãƒ»ãƒã‚¦ãƒã‚¦', color: 'yellow' },
                'progress': { emoji: 'ğŸ“ˆ', name: 'çµŒéå ±å‘Š', color: 'blue' },
                'recipe': { emoji: 'ğŸ³', name: 'ãƒ¬ã‚·ãƒ”', color: 'green' },
                'motivation': { emoji: 'ğŸ”¥', name: 'ãƒ¢ãƒãƒ™ãƒ¼ã‚·ãƒ§ãƒ³', color: 'orange' }
            };
            const cat = categories[(category || '').toLowerCase()] || { emoji: 'ğŸ“', name: category || 'ä¸æ˜', color: 'gray' };
            return `<span class="px-2 py-1 text-xs rounded-full bg-${cat.color}-100 text-${cat.color}-700">${cat.emoji} ${cat.name}</span>`;
        }

        async function deleteComyPost(postId) {
            if (!confirm('âš ï¸ ã“ã®æŠ•ç¨¿ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\n\nã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚')) return;

            try {
                // ã¾ãšã‚³ãƒ¡ãƒ³ãƒˆã‚’å‰Šé™¤
                const commentsSnapshot = await db.collection('comy_posts').doc(postId).collection('comments').get();
                if (!commentsSnapshot.empty) {
                    const batch = db.batch();
                    commentsSnapshot.forEach(commentDoc => {
                        batch.delete(commentDoc.ref);
                    });
                    await batch.commit();
                }

                // æŠ•ç¨¿ã‚’å‰Šé™¤
                await db.collection('comy_posts').doc(postId).delete();

                alert('âœ… æŠ•ç¨¿ã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
                await loadComyPosts();
            } catch (error) {
                console.error('Delete comy post error:', error);
                alert('âŒ å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (error.message || error));
            }
        }

        function showComyPostDetail(postId) {
            const post = allComyPosts.find(p => p.id === postId);
            if (!post) return;

            const details = [
                `ã€æŠ•ç¨¿è©³ç´°ã€‘`,
                `ID: ${post.id}`,
                `æŠ•ç¨¿è€…: ${post.authorName || 'åŒ¿å'}`,
                `æŠ•ç¨¿è€…ID: ${post.userId || 'ä¸æ˜'}`,
                `---`,
                `ã‚¿ã‚¤ãƒˆãƒ«: ${post.title || '(ãªã—)'}`,
                `ã‚«ãƒ†ã‚´ãƒª: ${post.category || 'ä¸æ˜'}`,
                `---`,
                `å†…å®¹:`,
                post.content || '(ãªã—)',
                `---`,
                `ã„ã„ã­æ•°: ${post.likeCount || 0}`,
                `ã‚³ãƒ¡ãƒ³ãƒˆæ•°: ${post.commentCount || 0}`,
                `æŠ•ç¨¿æ—¥æ™‚: ${post.createdAt ? new Date(post.createdAt).toLocaleString('ja-JP') : 'ä¸æ˜'}`,
            ];

            alert(details.join('\n'));
        }

        // ===== æ—§COMYæŠ•ç¨¿ç®¡ç†æ©Ÿèƒ½ï¼ˆcommunityProjectsç”¨ãƒ»å¾Œæ–¹äº’æ›ï¼‰ =====
        let allCommunityPosts = [];

        async function loadCommunityPosts() {
            // æ—§ãƒãƒ¼ã‚¸ãƒ§ãƒ³äº’æ›ç”¨ - ç¾åœ¨ã¯ loadComyPosts() ã‚’ä½¿ç”¨
            console.log('[Admin] loadCommunityPosts is deprecated, use loadComyPosts instead');
        }

        // ===== PGBASEè¨˜äº‹ç®¡ç†æ©Ÿèƒ½ =====
        let allPgBaseArticles = [];

        async function loadPgBaseArticles() {
            const loading = document.getElementById('pgbase-loading');
            const list = document.getElementById('pgbase-list');
            const empty = document.getElementById('pgbase-empty');

            loading.style.display = 'block';
            list.style.display = 'none';
            empty.style.display = 'none';

            try {
                const snapshot = await db.collection('pgbase_articles')
                    .orderBy('order', 'asc')
                    .get();

                allPgBaseArticles = [];
                let nutritionCount = 0;
                let trainingCount = 0;
                let recoveryCount = 0;

                snapshot.forEach(doc => {
                    const data = doc.data();
                    const article = { id: doc.id, ...data };
                    allPgBaseArticles.push(article);

                    const cat = (data.category || '').toLowerCase();
                    if (['nutrition', 'protein', 'carbs', 'fat', 'vitamins'].includes(cat)) nutritionCount++;
                    else if (cat === 'training') trainingCount++;
                    else if (cat === 'recovery') recoveryCount++;
                });

                // çµ±è¨ˆæ›´æ–°
                document.getElementById('total-articles').textContent = allPgBaseArticles.length;
                document.getElementById('nutrition-articles').textContent = nutritionCount;
                document.getElementById('training-articles').textContent = trainingCount;
                document.getElementById('recovery-articles').textContent = recoveryCount;

                loading.style.display = 'none';

                if (allPgBaseArticles.length === 0) {
                    empty.style.display = 'block';
                    return;
                }

                list.style.display = 'block';
                renderPgBaseArticles(allPgBaseArticles);

            } catch (error) {
                console.error('Load pgbase articles error:', error);
                loading.innerHTML = '<p style="color: red;">ã‚¨ãƒ©ãƒ¼: ' + error.message + '</p>';
            }
        }

        function renderPgBaseArticles(articles) {
            const container = document.getElementById('pgbase-list');
            const categoryEmojis = {
                'nutrition': 'ğŸ¥—', 'protein': 'ğŸ–', 'carbs': 'ğŸš', 'fat': 'ğŸ¥‘',
                'vitamins': 'ğŸ’Š', 'training': 'ğŸ’ª', 'recovery': 'ğŸ˜´', 'mindset': 'ğŸ§ '
            };

            container.innerHTML = articles.map(article => {
                const emoji = categoryEmojis[article.category] || 'ğŸ“„';
                const createdAt = article.createdAt ? new Date(article.createdAt).toLocaleDateString('ja-JP') : 'ä¸æ˜';

                return `
                    <div class="border-2 rounded-xl p-4 transition-all border-gray-200 bg-white hover:border-purple-300">
                        <div class="flex items-start justify-between mb-2">
                            <div class="flex items-center gap-2">
                                <span class="text-2xl">${emoji}</span>
                                <div>
                                    <div class="font-bold text-gray-800">${article.title || '(ã‚¿ã‚¤ãƒˆãƒ«ãªã—)'}</div>
                                    <div class="text-xs text-gray-500">${article.category || 'ä¸æ˜'} | é †åº: ${article.order || 0} | ${article.readingTime || 5}åˆ†</div>
                                </div>
                            </div>
                            <div class="flex items-center gap-2">
                                ${article.isPremium ? '<span class="px-2 py-1 text-xs rounded-full bg-yellow-100 text-yellow-800">â­ ãƒ—ãƒ¬ãƒŸã‚¢ãƒ </span>' : ''}
                            </div>
                        </div>
                        <div class="text-sm text-gray-600 mb-2">${article.summary || '(æ¦‚è¦ãªã—)'}</div>
                        <div class="text-xs text-gray-400 mb-3">ä½œæˆ: ${createdAt}</div>
                        <div class="flex gap-2">
                            <button onclick="deletePgBaseArticle('${article.id}')"
                                class="px-3 py-1.5 text-sm rounded-lg font-medium bg-red-100 text-red-700 hover:bg-red-200 transition">
                                ğŸ—‘ï¸ å‰Šé™¤
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        async function createPgBaseArticle() {
            const title = document.getElementById('pgbase-title').value.trim();
            const category = document.getElementById('pgbase-category').value;
            const summary = document.getElementById('pgbase-summary').value.trim();
            const content = document.getElementById('pgbase-content').value.trim();
            const readingTime = parseInt(document.getElementById('pgbase-reading-time').value) || 5;
            const order = parseInt(document.getElementById('pgbase-order').value) || 0;
            const isPremium = document.getElementById('pgbase-premium').checked;
            const btn = document.getElementById('create-article-btn');

            if (!title) {
                alert('ã‚¿ã‚¤ãƒˆãƒ«ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }
            if (!content) {
                alert('æœ¬æ–‡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }

            btn.disabled = true;
            btn.textContent = 'â³ ä½œæˆä¸­...';

            try {
                const now = Date.now();
                await db.collection('pgbase_articles').add({
                    title,
                    category,
                    summary,
                    content,
                    readingTime,
                    order,
                    isPremium,
                    createdAt: now,
                    updatedAt: now
                });

                alert('âœ… è¨˜äº‹ã‚’ä½œæˆã—ã¾ã—ãŸ');

                // ãƒ•ã‚©ãƒ¼ãƒ ã‚’ã‚¯ãƒªã‚¢
                document.getElementById('pgbase-title').value = '';
                document.getElementById('pgbase-summary').value = '';
                document.getElementById('pgbase-content').value = '';
                document.getElementById('pgbase-reading-time').value = '5';
                document.getElementById('pgbase-order').value = '0';
                document.getElementById('pgbase-premium').checked = false;

                await loadPgBaseArticles();
            } catch (error) {
                console.error('Create pgbase article error:', error);
                alert('âŒ ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
            } finally {
                btn.disabled = false;
                btn.textContent = 'âœ¨ è¨˜äº‹ã‚’ä½œæˆ';
            }
        }

        async function deletePgBaseArticle(articleId) {
            if (!confirm('âš ï¸ ã“ã®è¨˜äº‹ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\n\nã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚')) return;

            try {
                await db.collection('pgbase_articles').doc(articleId).delete();
                alert('âœ… è¨˜äº‹ã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
                await loadPgBaseArticles();
            } catch (error) {
                console.error('Delete pgbase article error:', error);
                alert('âŒ å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
            }
        }

        // ===== ä½¿ç”¨çŠ¶æ³åˆ†ææ©Ÿèƒ½ =====
        let analyticsData = null;

        async function loadAnalytics() {
            const loading = document.getElementById('analytics-loading');
            const usersList = document.getElementById('analytics-users-list');
            const empty = document.getElementById('analytics-empty');
            const period = parseInt(document.getElementById('analytics-period').value);

            loading.style.display = 'block';
            usersList.style.display = 'none';
            empty.style.display = 'none';

            try {
                const getAdminAnalytics = functions.httpsCallable('getAdminAnalytics');
                const result = await getAdminAnalytics({ adminPassword, period });

                if (!result.data.success) {
                    throw new Error('ãƒ‡ãƒ¼ã‚¿å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
                }

                analyticsData = result.data;
                console.log('[Analytics] Data loaded:', analyticsData);

                // çµ±è¨ˆã‚µãƒãƒªãƒ¼æ›´æ–°
                document.getElementById('analytics-users').textContent = analyticsData.totalUsers;

                const totalEvents = Object.values(analyticsData.featureUsage).reduce((sum, f) => sum + f.count, 0);
                document.getElementById('analytics-events').textContent = totalEvents.toLocaleString();

                document.getElementById('analytics-features-used').textContent = Object.keys(analyticsData.featureUsage).length;
                document.getElementById('analytics-features-unused').textContent = analyticsData.unusedFeatures.length;

                // ã‚«ãƒ†ã‚´ãƒªåˆ¥ä½¿ç”¨ç‡
                renderCategoryStats(analyticsData.categoryStats);

                // äººæ°—æ©Ÿèƒ½TOP10
                renderTopFeatures(analyticsData.featureUsage, analyticsData.allFeatures);

                // æœªä½¿ç”¨æ©Ÿèƒ½
                renderUnusedFeatures(analyticsData.unusedFeatures);

                // æ—¥åˆ¥æ¨ç§»
                renderDailyChart(analyticsData.dailyUsage);

                // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ©ãƒ³ã‚­ãƒ³ã‚°
                renderAnalyticsUsers(analyticsData.userStats);

                loading.style.display = 'none';

                if (analyticsData.totalUsers === 0) {
                    empty.style.display = 'block';
                } else {
                    usersList.style.display = 'block';
                }

            } catch (error) {
                console.error('Load analytics error:', error);
                loading.innerHTML = '<p style="color: red;">ã‚¨ãƒ©ãƒ¼: ' + error.message + '</p>';
            }
        }

        function renderCategoryStats(categoryStats) {
            const container = document.getElementById('analytics-categories');
            const categoryNames = {
                dashboard: { name: 'ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰', icon: 'ğŸ ', color: 'blue' },
                meal: { name: 'é£Ÿäº‹è¨˜éŒ²', icon: 'ğŸ½ï¸', color: 'green' },
                workout: { name: 'é‹å‹•è¨˜éŒ²', icon: 'ğŸ’ª', color: 'orange' },
                analysis: { name: 'AIåˆ†æ', icon: 'ğŸ§ ', color: 'purple' },
                pgbase: { name: 'PGBASE', icon: 'ğŸ“š', color: 'pink' },
                comy: { name: 'COMY', icon: 'ğŸ‘¥', color: 'teal' },
                history: { name: 'å±¥æ­´', icon: 'ğŸ“…', color: 'gray' },
                settings: { name: 'è¨­å®š', icon: 'âš™ï¸', color: 'slate' },
                navigation: { name: 'ãƒŠãƒ“', icon: 'ğŸ§­', color: 'indigo' },
                condition: { name: 'ã‚³ãƒ³ãƒ‡ã‚£', icon: 'â¤ï¸', color: 'red' },
            };

            container.innerHTML = Object.entries(categoryStats).map(([key, stats]) => {
                const cat = categoryNames[key] || { name: key, icon: 'ğŸ“Š', color: 'gray' };
                const barColor = stats.usageRate >= 80 ? 'bg-green-500' :
                                stats.usageRate >= 50 ? 'bg-yellow-500' :
                                stats.usageRate >= 20 ? 'bg-orange-500' : 'bg-red-500';
                return `
                    <div class="bg-white border rounded-lg p-3">
                        <div class="flex items-center gap-2 mb-2">
                            <span class="text-xl">${cat.icon}</span>
                            <span class="font-medium text-sm">${cat.name}</span>
                        </div>
                        <div class="text-2xl font-bold text-${cat.color}-600">${stats.usageRate}%</div>
                        <div class="text-xs text-gray-500">${stats.used}/${stats.total}æ©Ÿèƒ½</div>
                        <div class="w-full h-2 bg-gray-200 rounded mt-2">
                            <div class="${barColor} h-2 rounded" style="width: ${stats.usageRate}%"></div>
                        </div>
                        <div class="text-xs text-gray-400 mt-1">${stats.totalCount.toLocaleString()}å›ä½¿ç”¨</div>
                    </div>
                `;
            }).join('');
        }

        function renderTopFeatures(featureUsage, allFeatures) {
            const container = document.getElementById('analytics-top-features');

            const sorted = Object.entries(featureUsage)
                .sort((a, b) => b[1].count - a[1].count)
                .slice(0, 10);

            if (sorted.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center">ãƒ‡ãƒ¼ã‚¿ãªã—</p>';
                return;
            }

            const maxCount = sorted[0][1].count;

            container.innerHTML = sorted.map(([key, data], idx) => {
                const feature = allFeatures[key] || { name: key };
                const barWidth = Math.round((data.count / maxCount) * 100);
                const medal = idx === 0 ? 'ğŸ¥‡' : idx === 1 ? 'ğŸ¥ˆ' : idx === 2 ? 'ğŸ¥‰' : `${idx + 1}.`;
                return `
                    <div class="flex items-center gap-3">
                        <span class="w-6 text-center font-bold">${medal}</span>
                        <div class="flex-1">
                            <div class="flex justify-between text-sm mb-1">
                                <span class="font-medium">${feature.name}</span>
                                <span class="text-gray-500">${data.count.toLocaleString()}å› (${data.userCount}äºº)</span>
                            </div>
                            <div class="w-full h-2 bg-gray-200 rounded">
                                <div class="bg-purple-500 h-2 rounded" style="width: ${barWidth}%"></div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function renderUnusedFeatures(unusedFeatures) {
            const container = document.getElementById('analytics-unused-features');

            if (unusedFeatures.length === 0) {
                container.innerHTML = '<p class="text-green-600 text-center font-medium">ğŸ‰ å…¨æ©Ÿèƒ½ãŒä½¿ç”¨ã•ã‚Œã¦ã„ã¾ã™ï¼</p>';
                return;
            }

            container.innerHTML = unusedFeatures.map(feature => `
                <div class="flex items-center gap-2 p-2 bg-red-50 border border-red-200 rounded">
                    <span class="text-red-500">âš ï¸</span>
                    <span class="text-sm">${feature.name}</span>
                    <span class="text-xs text-gray-400">(${feature.category})</span>
                </div>
            `).join('');
        }

        function renderDailyChart(dailyUsage) {
            const container = document.getElementById('analytics-daily-chart');

            // æ—¥ä»˜ã§ã‚½ãƒ¼ãƒˆ
            const sorted = Object.entries(dailyUsage).sort((a, b) => a[0].localeCompare(b[0]));

            if (sorted.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center py-4">ãƒ‡ãƒ¼ã‚¿ãªã—</p>';
                return;
            }

            const maxCount = Math.max(...sorted.map(([, d]) => d.count));

            container.innerHTML = sorted.map(([date, data]) => {
                const barHeight = Math.max(10, Math.round((data.count / maxCount) * 100));
                const shortDate = date.slice(5); // MM-DDå½¢å¼
                return `
                    <div class="flex flex-col items-center" style="min-width: 30px;">
                        <div class="text-xs text-gray-500 mb-1">${data.count}</div>
                        <div class="w-5 bg-purple-500 rounded-t" style="height: ${barHeight}px;"></div>
                        <div class="text-xs text-gray-400 mt-1 transform -rotate-45 origin-top-left" style="white-space: nowrap;">${shortDate}</div>
                    </div>
                `;
            }).join('');
        }

        function renderAnalyticsUsers(userStats) {
            const container = document.getElementById('analytics-users-tbody');
            document.getElementById('analytics-user-count').textContent = `${userStats.length}äºº`;

            container.innerHTML = userStats.map((user, idx) => `
                <tr class="hover:bg-gray-50">
                    <td class="px-4 py-3 font-bold text-purple-600">${idx + 1}</td>
                    <td class="px-4 py-3">
                        <div class="font-medium text-gray-900">${user.displayName}</div>
                        <div class="text-xs text-gray-500">${user.email}</div>
                    </td>
                    <td class="px-4 py-3 text-gray-600">${user.totalEvents.toLocaleString()}</td>
                    <td class="px-4 py-3 text-gray-600">${user.featureCount}</td>
                    <td class="px-4 py-3">
                        <button onclick="showUserAnalyticsDetail('${user.userId}')" class="text-purple-600 hover:underline text-sm">
                            è©³ç´°
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        function showUserAnalyticsDetail(userId) {
            const user = analyticsData.userStats.find(u => u.userId === userId);
            if (!user) return;

            const featureList = Object.entries(user.features)
                .sort((a, b) => b[1] - a[1])
                .map(([key, count]) => {
                    const feature = analyticsData.allFeatures[key] || { name: key };
                    return `${feature.name}: ${count}å›`;
                })
                .join('\n');

            alert(`ãƒ¦ãƒ¼ã‚¶ãƒ¼: ${user.displayName}\nãƒ¡ãƒ¼ãƒ«: ${user.email}\n\nã€ä½¿ç”¨æ©Ÿèƒ½ã€‘\n${featureList}`);
        }

    </script>
</body>
</html>
