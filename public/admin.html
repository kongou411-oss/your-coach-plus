<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç®¡ç†ç”»é¢ - Your Coach+</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            background: #f5f7fa;
            color: #333;
        }

        .header {
            background: white;
            border-bottom: 1px solid #e0e0e0;
            padding: 16px 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .header h1 {
            font-size: 24px;
            color: #667eea;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .user-info {
            font-size: 14px;
            color: #666;
        }

        .btn-logout {
            padding: 8px 16px;
            background: #f5f5f5;
            border: 1px solid #ddd;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.2s;
        }

        .btn-logout:hover {
            background: #e0e0e0;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 24px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 32px;
        }

        .stat-card {
            background: white;
            padding: 24px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }

        .stat-card h3 {
            font-size: 14px;
            color: #666;
            margin-bottom: 8px;
        }

        .stat-card .value {
            font-size: 32px;
            font-weight: 700;
            color: #667eea;
        }

        .section {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            margin-bottom: 24px;
        }

        .section-header {
            padding: 20px 24px;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .section-header h2 {
            font-size: 20px;
        }

        .section-content {
            padding: 24px;
        }

        .org-list {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .org-card {
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            padding: 20px;
            transition: border-color 0.2s;
        }

        .org-card:hover {
            border-color: #667eea;
        }

        .org-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 16px;
        }

        .org-name {
            font-size: 18px;
            font-weight: 700;
            color: #333;
            margin-bottom: 4px;
        }

        .org-email {
            font-size: 14px;
            color: #666;
        }

        .org-status {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        .org-status.active {
            background: #d4edda;
            color: #155724;
        }

        .org-status.cancelled {
            background: #f8d7da;
            color: #721c24;
        }

        .org-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 16px;
        }

        .org-info-item {
            display: flex;
            flex-direction: column;
        }

        .org-info-label {
            font-size: 12px;
            color: #666;
            margin-bottom: 4px;
        }

        .org-info-value {
            font-size: 14px;
            font-weight: 600;
            color: #333;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e0e0e0;
            border-radius: 4px;
            overflow: hidden;
            margin-top: 8px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            transition: width 0.3s;
        }

        .code-display {
            background: #f5f5f5;
            padding: 12px 16px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 16px;
            font-weight: 700;
            color: #667eea;
            text-align: center;
            margin-top: 8px;
        }

        .btn-primary {
            padding: 10px 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
        }

        .btn-secondary {
            padding: 8px 16px;
            background: white;
            color: #667eea;
            border: 2px solid #667eea;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-secondary:hover {
            background: #667eea;
            color: white;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #999;
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 16px;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>ğŸ”§ Your Coach+ ç®¡ç†ç”»é¢</h1>
        <div class="header-right">
            <span class="user-info" id="user-info">èª­ã¿è¾¼ã¿ä¸­...</span>
            <button class="btn-logout" onclick="logout()">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
        </div>
    </div>

    <div class="container">
        <!-- ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ -->
        <div class="flex flex-wrap gap-2 mb-6">
            <button id="tab-giftcode" onclick="switchTab('giftcode')" class="px-6 py-3 rounded-lg font-bold transition bg-purple-600 text-white">
                ğŸ ã‚®ãƒ•ãƒˆã‚³ãƒ¼ãƒ‰
            </button>
            <button id="tab-b2b2c" onclick="switchTab('b2b2c')" class="px-6 py-3 rounded-lg font-bold transition bg-gray-200 text-gray-700 hover:bg-gray-300">
                ğŸ¢ B2B2Cä¼æ¥­
            </button>
            <button id="tab-users" onclick="switchTab('users')" class="px-6 py-3 rounded-lg font-bold transition bg-gray-200 text-gray-700 hover:bg-gray-300">
                ğŸ‘¥ ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†
            </button>
            <button id="tab-referrals" onclick="switchTab('referrals')" class="px-6 py-3 rounded-lg font-bold transition bg-gray-200 text-gray-700 hover:bg-gray-300">
                ğŸ¤ ç´¹ä»‹ã‚³ãƒ¼ãƒ‰
            </button>
        </div>

        <!-- ã‚®ãƒ•ãƒˆã‚³ãƒ¼ãƒ‰ç®¡ç†ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
        <div id="giftcode-section">
            <!-- æ–°è¦ã‚³ãƒ¼ãƒ‰ä½œæˆ -->
            <div class="section mb-6">
                <div class="section-header">
                    <h2>â• æ–°è¦ã‚®ãƒ•ãƒˆã‚³ãƒ¼ãƒ‰ä½œæˆ</h2>
                </div>
                <div class="section-content">
                    <div class="grid md:grid-cols-2 gap-4 mb-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">ã‚³ãƒ¼ãƒ‰</label>
                            <input type="text" id="new-code"
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 uppercase font-mono"
                                placeholder="ä¾‹: FAMILYPLUS2025"
                                oninput="this.value = this.value.toUpperCase()">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">ãƒ¡ãƒ¢ï¼ˆä»»æ„ï¼‰</label>
                            <input type="text" id="new-note"
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500"
                                placeholder="ä¾‹: å®¶æ—é…å¸ƒç”¨">
                        </div>
                    </div>
                    <button onclick="createGiftCode()" id="create-btn" class="btn-primary">
                        âœ¨ ã‚³ãƒ¼ãƒ‰ã‚’ä½œæˆ
                    </button>
                </div>
            </div>

            <!-- ã‚®ãƒ•ãƒˆã‚³ãƒ¼ãƒ‰ä¸€è¦§ -->
            <div class="section">
                <div class="section-header">
                    <h2>ğŸ“‹ ã‚®ãƒ•ãƒˆã‚³ãƒ¼ãƒ‰ä¸€è¦§</h2>
                    <button onclick="loadGiftCodes()" class="btn-secondary">ğŸ”„ æ›´æ–°</button>
                </div>
                <div class="section-content">
                    <div id="giftcode-loading" class="loading">ã‚³ãƒ¼ãƒ‰ã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™...</div>
                    <div id="giftcode-list" class="space-y-4" style="display:none;"></div>
                    <div id="giftcode-empty" class="empty-state" style="display:none;">
                        <div class="empty-state-icon">ğŸ“­</div>
                        <p>ã¾ã ã‚®ãƒ•ãƒˆã‚³ãƒ¼ãƒ‰ãŒã‚ã‚Šã¾ã›ã‚“</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- B2B2Cã‚»ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆæ—¢å­˜ï¼‰ -->
        <div id="b2b2c-section" style="display:none;">
            <!-- çµ±è¨ˆæƒ…å ± -->
            <div class="stats-grid">
            <div class="stat-card">
                <h3>å¥‘ç´„ä¼æ¥­æ•°</h3>
                <div class="value" id="total-orgs">-</div>
            </div>
            <div class="stat-card">
                <h3>ç·ãƒ©ã‚¤ã‚»ãƒ³ã‚¹æ•°</h3>
                <div class="value" id="total-licenses">-</div>
            </div>
            <div class="stat-card">
                <h3>ä½¿ç”¨ä¸­ãƒ©ã‚¤ã‚»ãƒ³ã‚¹</h3>
                <div class="value" id="used-licenses">-</div>
            </div>
            <div class="stat-card">
                <h3>æœˆé–“åç›Š</h3>
                <div class="value" id="monthly-revenue">-</div>
            </div>
        </div>

        <!-- ä¼æ¥­ä¸€è¦§ -->
        <div class="section">
            <div class="section-header">
                <h2>å¥‘ç´„ä¼æ¥­ä¸€è¦§</h2>
            </div>
            <div class="section-content">
                <div id="loading" class="loading">
                    ä¼æ¥­æƒ…å ±ã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™...
                </div>
                <div id="org-list" class="org-list" style="display:none;"></div>
                <div id="empty-state" class="empty-state" style="display:none;">
                    <div class="empty-state-icon">ğŸ“­</div>
                    <p>ã¾ã å¥‘ç´„ä¼æ¥­ãŒã‚ã‚Šã¾ã›ã‚“</p>
                </div>
            </div>
        </div>
        </div><!-- B2B2Cã‚»ã‚¯ã‚·ãƒ§ãƒ³çµ‚äº† -->

        <!-- ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
        <div id="users-section" style="display:none;">
            <!-- çµ±è¨ˆ -->
            <div class="stats-grid">
                <div class="stat-card">
                    <h3>ç·ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°</h3>
                    <div class="value" id="total-users">-</div>
                </div>
                <div class="stat-card">
                    <h3>Premiumä¼šå“¡</h3>
                    <div class="value" id="premium-users">-</div>
                </div>
                <div class="stat-card">
                    <h3>B2B/ã‚®ãƒ•ãƒˆã‚³ãƒ¼ãƒ‰åˆ©ç”¨</h3>
                    <div class="value" id="code-users">-</div>
                </div>
                <div class="stat-card">
                    <h3>ãƒˆãƒ©ã‚¤ã‚¢ãƒ«ä¸­</h3>
                    <div class="value" id="trial-users">-</div>
                </div>
            </div>

            <!-- ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ -->
            <div class="section mb-6">
                <div class="section-content">
                    <div class="flex flex-wrap gap-3 items-center">
                        <label class="flex items-center gap-2">
                            <span class="text-sm font-medium">è¡¨ç¤º:</span>
                            <select id="user-filter" onchange="loadUsers()" class="px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500">
                                <option value="all">å…¨ãƒ¦ãƒ¼ã‚¶ãƒ¼</option>
                                <option value="premium">Premiumä¼šå“¡ã®ã¿</option>
                                <option value="b2b">B2Bã‚³ãƒ¼ãƒ‰åˆ©ç”¨è€…</option>
                                <option value="gift">ã‚®ãƒ•ãƒˆã‚³ãƒ¼ãƒ‰åˆ©ç”¨è€…</option>
                                <option value="stripe">Stripeèª²é‡‘è€…</option>
                                <option value="trial">ãƒˆãƒ©ã‚¤ã‚¢ãƒ«ä¸­</option>
                            </select>
                        </label>
                        <button onclick="loadUsers()" class="btn-secondary">ğŸ”„ æ›´æ–°</button>
                    </div>
                </div>
            </div>

            <!-- ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§ -->
            <div class="section">
                <div class="section-header">
                    <h2>ğŸ“‹ ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§</h2>
                    <span id="user-count" class="text-sm text-gray-500"></span>
                </div>
                <div class="section-content">
                    <div id="users-loading" class="loading">ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™...</div>
                    <div id="users-list" style="display:none;">
                        <div class="overflow-x-auto">
                            <table class="min-w-full text-sm">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-4 py-3 text-left font-medium text-gray-600">ãƒ¦ãƒ¼ã‚¶ãƒ¼</th>
                                        <th class="px-4 py-3 text-left font-medium text-gray-600">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</th>
                                        <th class="px-4 py-3 text-left font-medium text-gray-600">ç™»éŒ²æ—¥</th>
                                        <th class="px-4 py-3 text-left font-medium text-gray-600">ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆ</th>
                                        <th class="px-4 py-3 text-left font-medium text-gray-600">è©³ç´°</th>
                                    </tr>
                                </thead>
                                <tbody id="users-tbody" class="divide-y divide-gray-200"></tbody>
                            </table>
                        </div>
                    </div>
                    <div id="users-empty" class="empty-state" style="display:none;">
                        <div class="empty-state-icon">ğŸ‘¤</div>
                        <p>è©²å½“ã™ã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã„ã¾ã›ã‚“</p>
                    </div>
                </div>
            </div>
        </div><!-- ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†ã‚»ã‚¯ã‚·ãƒ§ãƒ³çµ‚äº† -->

        <!-- ç´¹ä»‹ã‚³ãƒ¼ãƒ‰ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
        <div id="referrals-section" style="display:none;">
            <!-- çµ±è¨ˆ -->
            <div class="stats-grid">
                <div class="stat-card">
                    <h3>ç·ç´¹ä»‹æ•°</h3>
                    <div class="value" id="total-referrals">-</div>
                </div>
                <div class="stat-card">
                    <h3>ç´¹ä»‹è€…æ•°ï¼ˆã‚³ãƒ¼ãƒ‰ç™ºè¡Œï¼‰</h3>
                    <div class="value" id="referrer-count">-</div>
                </div>
                <div class="stat-card">
                    <h3>è¢«ç´¹ä»‹è€…æ•°</h3>
                    <div class="value" id="referee-count">-</div>
                </div>
                <div class="stat-card">
                    <h3>ä»˜ä¸ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆåˆè¨ˆ</h3>
                    <div class="value" id="total-referral-credits">-</div>
                </div>
            </div>

            <!-- ç´¹ä»‹ã‚³ãƒ¼ãƒ‰ä¸€è¦§ -->
            <div class="section">
                <div class="section-header">
                    <h2>ğŸ¤ ç´¹ä»‹ã‚³ãƒ¼ãƒ‰åˆ©ç”¨çŠ¶æ³</h2>
                    <button onclick="loadReferrals()" class="btn-secondary">ğŸ”„ æ›´æ–°</button>
                </div>
                <div class="section-content">
                    <div id="referrals-loading" class="loading">ç´¹ä»‹ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™...</div>
                    <div id="referrals-list" style="display:none;">
                        <div class="overflow-x-auto">
                            <table class="min-w-full text-sm">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-4 py-3 text-left font-medium text-gray-600">ç´¹ä»‹è€…</th>
                                        <th class="px-4 py-3 text-left font-medium text-gray-600">ç´¹ä»‹ã‚³ãƒ¼ãƒ‰</th>
                                        <th class="px-4 py-3 text-left font-medium text-gray-600">è¢«ç´¹ä»‹è€…</th>
                                        <th class="px-4 py-3 text-left font-medium text-gray-600">é©ç”¨æ—¥æ™‚</th>
                                        <th class="px-4 py-3 text-left font-medium text-gray-600">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</th>
                                    </tr>
                                </thead>
                                <tbody id="referrals-tbody" class="divide-y divide-gray-200"></tbody>
                            </table>
                        </div>
                    </div>
                    <div id="referrals-empty" class="empty-state" style="display:none;">
                        <div class="empty-state-icon">ğŸ¤</div>
                        <p>ã¾ã ç´¹ä»‹ã‚³ãƒ¼ãƒ‰ãŒä½¿ç”¨ã•ã‚Œã¦ã„ã¾ã›ã‚“</p>
                    </div>
                </div>
            </div>

            <!-- ç´¹ä»‹è€…åˆ¥è©³ç´° -->
            <div class="section">
                <div class="section-header">
                    <h2>ğŸ‘¤ ç´¹ä»‹è€…åˆ¥ã‚µãƒãƒªãƒ¼</h2>
                </div>
                <div class="section-content">
                    <div id="referrer-summary" class="space-y-4"></div>
                </div>
            </div>
        </div><!-- ç´¹ä»‹ã‚³ãƒ¼ãƒ‰ã‚»ã‚¯ã‚·ãƒ§ãƒ³çµ‚äº† -->
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-functions-compat.js"></script>
    <script src="/config.js"></script>

    <script>
        // FirebaseåˆæœŸåŒ–
        firebase.initializeApp(FIREBASE_CONFIG);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const functions = firebase.app().functions('asia-northeast2');

        // ç®¡ç†è€…ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã®ãƒ›ãƒ¯ã‚¤ãƒˆãƒªã‚¹ãƒˆ
        const ADMIN_EMAILS = [
            'kongou411@gmail.com'
        ];

        // ç®¡ç†è€…ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ï¼ˆç’°å¢ƒå¤‰æ•°ã‹ã‚‰å–å¾—ã™ã‚‹ã®ãŒç†æƒ³ã ãŒã€ã“ã“ã§ã¯ãƒ¡ãƒ¢ãƒªã«ä¿æŒï¼‰
        let adminPassword = '';

        // èªè¨¼ãƒã‚§ãƒƒã‚¯
        auth.onAuthStateChanged(async (user) => {
            if (!user || !ADMIN_EMAILS.includes(user.email)) {
                // æœªãƒ­ã‚°ã‚¤ãƒ³ã¾ãŸã¯ç®¡ç†è€…ã§ãªã„å ´åˆã¯ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã¸
                window.location.href = '/admin-login.html';
                return;
            }

            // ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±è¡¨ç¤º
            document.getElementById('user-info').textContent = user.email;

            // ç®¡ç†è€…ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å–å¾—ï¼ˆãƒ—ãƒ­ãƒ³ãƒ—ãƒˆï¼‰
            adminPassword = prompt('ç®¡ç†è€…ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆã‚®ãƒ•ãƒˆã‚³ãƒ¼ãƒ‰ç®¡ç†ç”¨ï¼‰');
            if (!adminPassword) {
                alert('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒå¿…è¦ã§ã™');
            }

            // ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
            await loadGiftCodes();
            await loadOrganizations();
        });

        // ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ
        function switchTab(tab) {
            const sections = ['giftcode', 'b2b2c', 'users', 'referrals'];
            const activeClass = 'px-6 py-3 rounded-lg font-bold transition bg-purple-600 text-white';
            const inactiveClass = 'px-6 py-3 rounded-lg font-bold transition bg-gray-200 text-gray-700 hover:bg-gray-300';

            sections.forEach(s => {
                const section = document.getElementById(s + '-section');
                const tabBtn = document.getElementById('tab-' + s);
                if (section) section.style.display = s === tab ? 'block' : 'none';
                if (tabBtn) tabBtn.className = s === tab ? activeClass : inactiveClass;
            });

            // ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
            if (tab === 'users') loadUsers();
            if (tab === 'referrals') loadReferrals();
        }

        // ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
        function logout() {
            auth.signOut().then(() => {
                window.location.href = '/admin-login.html';
            });
        }

        // ä¼æ¥­ä¸€è¦§èª­ã¿è¾¼ã¿
        async function loadOrganizations() {
            try {
                const snapshot = await db.collection('b2b2cOrganizations').get();

                const loading = document.getElementById('loading');
                const orgList = document.getElementById('org-list');
                const emptyState = document.getElementById('empty-state');

                loading.style.display = 'none';

                if (snapshot.empty) {
                    emptyState.style.display = 'block';
                    updateStats([], 0, 0);
                    return;
                }

                orgList.style.display = 'flex';

                const organizations = [];
                let totalLicenses = 0;
                let usedLicenses = 0;

                snapshot.forEach(doc => {
                    const org = { id: doc.id, ...doc.data() };
                    organizations.push(org);

                    if (org.licenses !== -1) {
                        totalLicenses += org.licenses;
                    }
                    usedLicenses += org.usedLicenses || 0;
                });

                // çµ±è¨ˆæƒ…å ±æ›´æ–°
                updateStats(organizations, totalLicenses, usedLicenses);

                // ä¼æ¥­ã‚«ãƒ¼ãƒ‰è¡¨ç¤º
                orgList.innerHTML = organizations.map(org => createOrgCard(org)).join('');

            } catch (error) {
                console.error('Error loading organizations:', error);
                document.getElementById('loading').innerHTML =
                    '<p style="color: red;">ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message + '</p>';
            }
        }

        // çµ±è¨ˆæƒ…å ±æ›´æ–°
        function updateStats(organizations, totalLicenses, usedLicenses) {
            document.getElementById('total-orgs').textContent = organizations.length;
            document.getElementById('total-licenses').textContent =
                totalLicenses > 0 ? totalLicenses : 'ç„¡åˆ¶é™å«ã‚€';
            document.getElementById('used-licenses').textContent = usedLicenses;

            // æœˆé–“åç›Šè¨ˆç®—ï¼ˆå¹´é–“ãƒ—ãƒ©ãƒ³ã‚’12ã§å‰²ã‚‹ï¼‰
            const monthlyRevenue = organizations.reduce((sum, org) => {
                return sum + (org.price || 0) / 12;
            }, 0);
            document.getElementById('monthly-revenue').textContent =
                'Â¥' + Math.round(monthlyRevenue).toLocaleString();
        }

        // ä¼æ¥­ã‚«ãƒ¼ãƒ‰ç”Ÿæˆ
        function createOrgCard(org) {
            const usagePercent = org.licenses === -1
                ? 0
                : Math.round((org.usedLicenses / org.licenses) * 100);

            const planName = getPlanName(org.planId);
            const statusClass = org.status === 'active' ? 'active' : 'cancelled';
            const statusText = org.status === 'active' ? 'âœ… æœ‰åŠ¹' : 'âŒ ç„¡åŠ¹';

            return `
                <div class="org-card">
                    <div class="org-header">
                        <div>
                            <div class="org-name">${org.name || 'ä¼æ¥­åæœªè¨­å®š'}</div>
                            <div class="org-email">${org.email || 'ãƒ¡ãƒ¼ãƒ«æœªè¨­å®š'}</div>
                        </div>
                        <div class="org-status ${statusClass}">${statusText}</div>
                    </div>

                    <div class="org-info">
                        <div class="org-info-item">
                            <div class="org-info-label">ãƒ—ãƒ©ãƒ³</div>
                            <div class="org-info-value">${planName}</div>
                        </div>
                        <div class="org-info-item">
                            <div class="org-info-label">å¹´é–“æ–™é‡‘</div>
                            <div class="org-info-value">Â¥${(org.price || 0).toLocaleString()}</div>
                        </div>
                        <div class="org-info-item">
                            <div class="org-info-label">ãƒ©ã‚¤ã‚»ãƒ³ã‚¹ä½¿ç”¨çŠ¶æ³</div>
                            <div class="org-info-value">
                                ${org.usedLicenses || 0} / ${org.licenses === -1 ? 'ç„¡åˆ¶é™' : org.licenses}
                                ${org.licenses !== -1 ? `(${usagePercent}%)` : ''}
                            </div>
                            ${org.licenses !== -1 ? `
                                <div class="progress-bar">
                                    <div class="progress-fill" style="width: ${usagePercent}%"></div>
                                </div>
                            ` : ''}
                        </div>
                        <div class="org-info-item">
                            <div class="org-info-label">æœ‰åŠ¹æœŸé™</div>
                            <div class="org-info-value">
                                ${org.validUntil ? formatDate(org.validUntil.toDate()) : 'æœªè¨­å®š'}
                            </div>
                        </div>
                    </div>

                    <div class="org-info-item">
                        <div class="org-info-label">ã‚¢ã‚¯ã‚»ã‚¹ã‚³ãƒ¼ãƒ‰</div>
                        <div class="code-display">${org.accessCode || 'ã‚³ãƒ¼ãƒ‰æœªç™ºè¡Œ'}</div>
                    </div>
                </div>
            `;
        }

        // ãƒ—ãƒ©ãƒ³åå–å¾—
        function getPlanName(planId) {
            const planNames = {
                'beginner': 'ãƒ“ã‚®ãƒŠãƒ¼ãƒ—ãƒ©ãƒ³ï¼ˆ10äººï¼‰',
                'pro': 'ãƒ—ãƒ­ãƒ—ãƒ©ãƒ³ï¼ˆ30äººï¼‰',
                'max': 'MAXãƒ—ãƒ©ãƒ³ï¼ˆç„¡åˆ¶é™ï¼‰',
                'custom_beginner': 'ã‚«ã‚¹ã‚¿ãƒ ãƒ“ã‚®ãƒŠãƒ¼ï¼ˆ10äººãƒ»30%OFFï¼‰',
                'custom_pro': 'ã‚«ã‚¹ã‚¿ãƒ ãƒ—ãƒ­ï¼ˆ30äººãƒ»30%OFFï¼‰',
                'custom_max': 'ã‚«ã‚¹ã‚¿ãƒ MAXï¼ˆç„¡åˆ¶é™ãƒ»30%OFFï¼‰'
            };
            return planNames[planId] || planId;
        }

        // æ—¥ä»˜ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
        function formatDate(date) {
            return date.toLocaleDateString('ja-JP', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit'
            });
        }

        // ===== ã‚®ãƒ•ãƒˆã‚³ãƒ¼ãƒ‰ç®¡ç†æ©Ÿèƒ½ =====

        // ã‚®ãƒ•ãƒˆã‚³ãƒ¼ãƒ‰ä¸€è¦§èª­ã¿è¾¼ã¿
        async function loadGiftCodes() {
            if (!adminPassword) {
                document.getElementById('giftcode-loading').innerHTML = '<p style="color: orange;">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“</p>';
                return;
            }

            try {
                const getGiftCodes = functions.httpsCallable('getGiftCodes');
                const result = await getGiftCodes({ adminPassword });

                const loading = document.getElementById('giftcode-loading');
                const list = document.getElementById('giftcode-list');
                const empty = document.getElementById('giftcode-empty');

                loading.style.display = 'none';

                if (!result.data.success || result.data.codes.length === 0) {
                    empty.style.display = 'block';
                    list.style.display = 'none';
                    return;
                }

                empty.style.display = 'none';
                list.style.display = 'block';
                renderGiftCodes(result.data.codes);

            } catch (error) {
                console.error('Load gift codes error:', error);
                document.getElementById('giftcode-loading').innerHTML =
                    '<p style="color: red;">ã‚¨ãƒ©ãƒ¼: ' + (error.message || 'ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒæ­£ã—ããªã„å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™') + '</p>';
            }
        }

        // ã‚®ãƒ•ãƒˆã‚³ãƒ¼ãƒ‰ä¸€è¦§è¡¨ç¤º
        function renderGiftCodes(codes) {
            const container = document.getElementById('giftcode-list');
            container.innerHTML = codes.map(code => `
                <div class="border-2 rounded-xl p-4 transition-all ${code.isActive ? 'border-green-300 bg-green-50' : 'border-gray-200 bg-gray-100'}">
                    <div class="flex items-start justify-between mb-3">
                        <div class="flex items-center gap-3">
                            <span class="font-mono font-bold text-xl ${code.isActive ? 'text-green-700' : 'text-gray-400'}">${code.code}</span>
                            <span class="px-2 py-1 text-xs rounded-full font-medium ${code.isActive ? 'bg-green-200 text-green-800' : 'bg-gray-200 text-gray-600'}">
                                ${code.isActive ? 'âœ… æœ‰åŠ¹' : 'âŒ ç„¡åŠ¹'}
                            </span>
                        </div>
                        <div class="flex items-center gap-2">
                            <button onclick="toggleGiftCode('${code.code}', ${!code.isActive})"
                                class="px-3 py-1.5 text-sm rounded-lg font-medium transition ${code.isActive ? 'bg-orange-100 text-orange-700 hover:bg-orange-200' : 'bg-green-100 text-green-700 hover:bg-green-200'}">
                                ${code.isActive ? 'ğŸ”’ ç„¡åŠ¹åŒ–' : 'ğŸ”“ æœ‰åŠ¹åŒ–'}
                            </button>
                            <button onclick="deleteGiftCode('${code.code}')"
                                class="px-3 py-1.5 text-sm rounded-lg font-medium bg-red-100 text-red-700 hover:bg-red-200 transition">
                                ğŸ—‘ï¸ å‰Šé™¤
                            </button>
                        </div>
                    </div>

                    ${code.note ? `<p class="text-sm text-gray-600 mb-3">ğŸ“ ${code.note}</p>` : ''}

                    <div class="flex flex-wrap items-center gap-4 text-sm text-gray-600">
                        <span>ğŸ‘¥ ä½¿ç”¨è€…: <strong class="text-gray-800">${code.usedCount}äºº</strong></span>
                        ${code.createdAt ? `<span>ğŸ“… ä½œæˆ: ${new Date(code.createdAt).toLocaleDateString('ja-JP')}</span>` : ''}
                        ${code.lastUsedAt ? `<span>ğŸ• æœ€çµ‚ä½¿ç”¨: ${new Date(code.lastUsedAt).toLocaleDateString('ja-JP')}</span>` : ''}
                    </div>

                    ${code.usedByDetails && code.usedByDetails.length > 0 ? `
                        <details class="mt-3">
                            <summary class="text-sm text-purple-600 cursor-pointer hover:underline font-medium">
                                ğŸ‘¤ ä½¿ç”¨è€…è©³ç´° (${code.usedByDetails.length}äºº)
                            </summary>
                            <div class="mt-2 bg-white rounded-lg p-3 space-y-2 border border-gray-200">
                                ${code.usedByDetails.map((user, i) => `
                                    <div class="text-sm flex items-center gap-2 ${i > 0 ? 'pt-2 border-t border-gray-100' : ''}">
                                        <span class="w-6 h-6 rounded-full bg-purple-100 text-purple-600 flex items-center justify-center text-xs font-bold">${i + 1}</span>
                                        <span class="text-gray-800 font-medium">${user.email || 'ãƒ¡ãƒ¼ãƒ«æœªå–å¾—'}</span>
                                        ${user.displayName ? `<span class="text-gray-400 text-xs">(${user.displayName})</span>` : ''}
                                    </div>
                                `).join('')}
                            </div>
                        </details>
                    ` : ''}
                </div>
            `).join('');
        }

        // ã‚®ãƒ•ãƒˆã‚³ãƒ¼ãƒ‰ä½œæˆ
        async function createGiftCode() {
            const code = document.getElementById('new-code').value.trim().toUpperCase();
            const note = document.getElementById('new-note').value.trim();
            const btn = document.getElementById('create-btn');

            if (!code) {
                alert('ã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }
            if (code.length < 3) {
                alert('ã‚³ãƒ¼ãƒ‰ã¯3æ–‡å­—ä»¥ä¸Šã§å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }

            btn.disabled = true;
            btn.textContent = 'â³ ä½œæˆä¸­...';

            try {
                const createGiftCodeFn = functions.httpsCallable('createGiftCode');
                const result = await createGiftCodeFn({ code, note, adminPassword });

                if (result.data.success) {
                    alert('âœ… ã‚³ãƒ¼ãƒ‰ã‚’ä½œæˆã—ã¾ã—ãŸ\n\nã‚³ãƒ¼ãƒ‰: ' + code);
                    document.getElementById('new-code').value = '';
                    document.getElementById('new-note').value = '';
                    await loadGiftCodes();
                }
            } catch (error) {
                console.error('Create code error:', error);
                alert('âŒ ' + (error.message || 'ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸ'));
            } finally {
                btn.disabled = false;
                btn.textContent = 'âœ¨ ã‚³ãƒ¼ãƒ‰ã‚’ä½œæˆ';
            }
        }

        // ã‚®ãƒ•ãƒˆã‚³ãƒ¼ãƒ‰æœ‰åŠ¹/ç„¡åŠ¹åˆ‡ã‚Šæ›¿ãˆ
        async function toggleGiftCode(code, isActive) {
            if (!confirm(`ã‚³ãƒ¼ãƒ‰ã€Œ${code}ã€ã‚’${isActive ? 'æœ‰åŠ¹åŒ–' : 'ç„¡åŠ¹åŒ–'}ã—ã¾ã™ã‹ï¼Ÿ`)) return;

            try {
                const toggleGiftCodeFn = functions.httpsCallable('toggleGiftCode');
                const result = await toggleGiftCodeFn({ code, isActive, adminPassword });
                if (result.data.success) {
                    await loadGiftCodes();
                }
            } catch (error) {
                console.error('Toggle code error:', error);
                alert('âŒ æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (error.message || error));
            }
        }

        // ã‚®ãƒ•ãƒˆã‚³ãƒ¼ãƒ‰å‰Šé™¤
        async function deleteGiftCode(code) {
            if (!confirm(`âš ï¸ ã‚³ãƒ¼ãƒ‰ã€Œ${code}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\n\nã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚`)) return;

            try {
                const deleteGiftCodeFn = functions.httpsCallable('deleteGiftCode');
                const result = await deleteGiftCodeFn({ code, adminPassword });
                if (result.data.success) {
                    await loadGiftCodes();
                }
            } catch (error) {
                console.error('Delete code error:', error);
                alert('âŒ å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (error.message || error));
            }
        }

        // ===== ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†æ©Ÿèƒ½ =====
        let allUsers = [];

        async function loadUsers() {
            const loading = document.getElementById('users-loading');
            const list = document.getElementById('users-list');
            const empty = document.getElementById('users-empty');
            const filter = document.getElementById('user-filter').value;

            loading.style.display = 'block';
            list.style.display = 'none';
            empty.style.display = 'none';

            try {
                const snapshot = await db.collection('users').get();
                allUsers = [];

                const now = new Date();
                let premiumCount = 0;
                let codeCount = 0;
                let trialCount = 0;

                snapshot.forEach(doc => {
                    const data = doc.data();
                    const user = { id: doc.id, ...data };

                    // Premiumåˆ¤å®š
                    const isPremium = data.subscription?.status === 'active' ||
                                      data.b2b2cOrgId ||
                                      data.subscription?.giftCodeActive === true;

                    // ãƒˆãƒ©ã‚¤ã‚¢ãƒ«åˆ¤å®š
                    const regDate = data.registeredAt?.toDate?.() || data.createdAt?.toDate?.() || new Date();
                    const daysSinceReg = Math.floor((now - regDate) / (1000 * 60 * 60 * 24));
                    const isTrialActive = !isPremium && daysSinceReg <= 7;

                    user._isPremium = isPremium;
                    user._isTrialActive = isTrialActive;
                    user._regDate = regDate;
                    user._daysSinceReg = daysSinceReg;

                    allUsers.push(user);

                    if (isPremium) premiumCount++;
                    if (data.b2b2cOrgId || data.subscription?.giftCodeActive) codeCount++;
                    if (isTrialActive) trialCount++;
                });

                // çµ±è¨ˆæ›´æ–°
                document.getElementById('total-users').textContent = allUsers.length;
                document.getElementById('premium-users').textContent = premiumCount;
                document.getElementById('code-users').textContent = codeCount;
                document.getElementById('trial-users').textContent = trialCount;

                // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼é©ç”¨
                let filtered = allUsers;
                switch (filter) {
                    case 'premium':
                        filtered = allUsers.filter(u => u._isPremium);
                        break;
                    case 'b2b':
                        filtered = allUsers.filter(u => u.b2b2cOrgId);
                        break;
                    case 'gift':
                        filtered = allUsers.filter(u => u.subscription?.giftCodeActive);
                        break;
                    case 'stripe':
                        filtered = allUsers.filter(u => u.subscription?.status === 'active' && !u.b2b2cOrgId && !u.subscription?.giftCodeActive);
                        break;
                    case 'trial':
                        filtered = allUsers.filter(u => u._isTrialActive);
                        break;
                }

                // ç™»éŒ²æ—¥ã§ã‚½ãƒ¼ãƒˆï¼ˆæ–°ã—ã„é †ï¼‰
                filtered.sort((a, b) => b._regDate - a._regDate);

                loading.style.display = 'none';

                if (filtered.length === 0) {
                    empty.style.display = 'block';
                    return;
                }

                list.style.display = 'block';
                document.getElementById('user-count').textContent = `${filtered.length}äºº`;
                renderUsers(filtered);

            } catch (error) {
                console.error('Load users error:', error);
                loading.innerHTML = '<p style="color: red;">ã‚¨ãƒ©ãƒ¼: ' + error.message + '</p>';
            }
        }

        function renderUsers(users) {
            const tbody = document.getElementById('users-tbody');
            tbody.innerHTML = users.map(user => {
                const status = [];
                if (user.subscription?.status === 'active' && !user.b2b2cOrgId && !user.subscription?.giftCodeActive) {
                    status.push('<span class="px-2 py-1 text-xs rounded-full bg-yellow-100 text-yellow-800">ğŸ’³ Stripe</span>');
                }
                if (user.b2b2cOrgId) {
                    status.push('<span class="px-2 py-1 text-xs rounded-full bg-blue-100 text-blue-800">ğŸ¢ B2B</span>');
                }
                if (user.subscription?.giftCodeActive) {
                    status.push('<span class="px-2 py-1 text-xs rounded-full bg-purple-100 text-purple-800">ğŸ ã‚®ãƒ•ãƒˆ</span>');
                }
                if (user._isTrialActive) {
                    status.push('<span class="px-2 py-1 text-xs rounded-full bg-green-100 text-green-800">ğŸ†“ ãƒˆãƒ©ã‚¤ã‚¢ãƒ«</span>');
                }
                if (user.referredBy) {
                    status.push('<span class="px-2 py-1 text-xs rounded-full bg-pink-100 text-pink-800">ğŸ¤ ç´¹ä»‹</span>');
                }
                if (status.length === 0) {
                    status.push('<span class="px-2 py-1 text-xs rounded-full bg-gray-100 text-gray-600">ç„¡æ–™</span>');
                }

                const freeCredits = user.freeCredits || 0;
                const paidCredits = user.paidCredits || 0;

                return `
                    <tr class="hover:bg-gray-50">
                        <td class="px-4 py-3">
                            <div class="font-medium text-gray-900">${user.displayName || user.nickname || 'åå‰æœªè¨­å®š'}</div>
                            <div class="text-xs text-gray-500">${user.email || 'ãƒ¡ãƒ¼ãƒ«æœªè¨­å®š'}</div>
                        </td>
                        <td class="px-4 py-3">
                            <div class="flex flex-wrap gap-1">
                                ${status.join('')}
                            </div>
                        </td>
                        <td class="px-4 py-3 text-gray-600">
                            ${user._regDate.toLocaleDateString('ja-JP')}
                            <div class="text-xs text-gray-400">${user._daysSinceReg}æ—¥ç›®</div>
                        </td>
                        <td class="px-4 py-3">
                            <div class="text-xs">
                                <span class="text-green-600">ç„¡æ–™: ${freeCredits}</span> /
                                <span class="text-blue-600">æœ‰å„Ÿ: ${paidCredits}</span>
                            </div>
                        </td>
                        <td class="px-4 py-3">
                            <button onclick="showUserDetail('${user.id}')" class="text-purple-600 hover:underline text-sm">
                                è©³ç´°
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function showUserDetail(userId) {
            const user = allUsers.find(u => u.id === userId);
            if (!user) return;

            const details = [
                `ID: ${user.id}`,
                `ãƒ¡ãƒ¼ãƒ«: ${user.email || 'æœªè¨­å®š'}`,
                `åå‰: ${user.displayName || user.nickname || 'æœªè¨­å®š'}`,
                `ç™»éŒ²æ—¥: ${user._regDate.toLocaleDateString('ja-JP')}`,
                `---`,
                `ç„¡æ–™ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆ: ${user.freeCredits || 0}`,
                `æœ‰å„Ÿã‚¯ãƒ¬ã‚¸ãƒƒãƒˆ: ${user.paidCredits || 0}`,
                `---`,
                `Stripeã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: ${user.subscription?.status || 'ãªã—'}`,
                `B2Bçµ„ç¹”ID: ${user.b2b2cOrgId || 'ãªã—'}`,
                `ã‚®ãƒ•ãƒˆã‚³ãƒ¼ãƒ‰: ${user.subscription?.giftCodeActive ? 'æœ‰åŠ¹' : 'ãªã—'}`,
                `---`,
                `ç´¹ä»‹ã‚³ãƒ¼ãƒ‰: ${user.referralCode || 'æœªç™ºè¡Œ'}`,
                `ç´¹ä»‹è€…ID: ${user.referredBy || 'ãªã—'}`,
            ];

            alert(details.join('\n'));
        }

        // ===== ç´¹ä»‹ã‚³ãƒ¼ãƒ‰ç®¡ç†æ©Ÿèƒ½ =====
        let allReferrals = [];

        async function loadReferrals() {
            const loading = document.getElementById('referrals-loading');
            const list = document.getElementById('referrals-list');
            const empty = document.getElementById('referrals-empty');

            loading.style.display = 'block';
            list.style.display = 'none';
            empty.style.display = 'none';

            try {
                // referralsã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‚’å–å¾—
                const snapshot = await db.collection('referrals').orderBy('createdAt', 'desc').get();
                allReferrals = [];

                const referrerMap = {};

                snapshot.forEach(doc => {
                    const data = doc.data();
                    allReferrals.push({ id: doc.id, ...data });

                    // ç´¹ä»‹è€…åˆ¥é›†è¨ˆ
                    const referrerId = data.referrerId;
                    if (!referrerMap[referrerId]) {
                        referrerMap[referrerId] = {
                            referrerId,
                            referrerName: data.referrerInfo?.displayName || 'ä¸æ˜',
                            referrerEmail: data.referrerInfo?.email || 'ä¸æ˜',
                            referees: []
                        };
                    }
                    referrerMap[referrerId].referees.push(data);
                });

                // çµ±è¨ˆæ›´æ–°
                const uniqueReferrers = Object.keys(referrerMap).length;
                document.getElementById('total-referrals').textContent = allReferrals.length;
                document.getElementById('referrer-count').textContent = uniqueReferrers;
                document.getElementById('referee-count').textContent = allReferrals.length;
                document.getElementById('total-referral-credits').textContent = (allReferrals.length * 100) + 'å›'; // åŒæ–¹50ãšã¤

                loading.style.display = 'none';

                if (allReferrals.length === 0) {
                    empty.style.display = 'block';
                    document.getElementById('referrer-summary').innerHTML = '<p class="text-gray-500 text-center">ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</p>';
                    return;
                }

                list.style.display = 'block';
                renderReferrals(allReferrals);
                renderReferrerSummary(Object.values(referrerMap));

            } catch (error) {
                console.error('Load referrals error:', error);
                loading.innerHTML = '<p style="color: red;">ã‚¨ãƒ©ãƒ¼: ' + error.message + '</p>';
            }
        }

        function renderReferrals(referrals) {
            const tbody = document.getElementById('referrals-tbody');
            tbody.innerHTML = referrals.map(ref => {
                const createdAt = ref.createdAt?.toDate?.() || new Date();
                return `
                    <tr class="hover:bg-gray-50">
                        <td class="px-4 py-3">
                            <div class="font-medium text-gray-900">${ref.referrerInfo?.displayName || 'ä¸æ˜'}</div>
                            <div class="text-xs text-gray-500">${ref.referrerInfo?.email || ''}</div>
                        </td>
                        <td class="px-4 py-3">
                            <span class="font-mono text-pink-600 font-medium">${ref.referralCode || '-'}</span>
                        </td>
                        <td class="px-4 py-3">
                            <div class="text-xs text-gray-500">${ref.referredUserId || '-'}</div>
                        </td>
                        <td class="px-4 py-3 text-gray-600 text-sm">
                            ${createdAt.toLocaleDateString('ja-JP')} ${createdAt.toLocaleTimeString('ja-JP', {hour: '2-digit', minute: '2-digit'})}
                        </td>
                        <td class="px-4 py-3">
                            <span class="px-2 py-1 text-xs rounded-full ${ref.status === 'completed' ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800'}">
                                ${ref.status === 'completed' ? 'âœ… å®Œäº†' : 'â³ ' + (ref.status || 'ä¸æ˜')}
                            </span>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function renderReferrerSummary(referrers) {
            const container = document.getElementById('referrer-summary');
            // ç´¹ä»‹äººæ•°ã§ã‚½ãƒ¼ãƒˆ
            referrers.sort((a, b) => b.referees.length - a.referees.length);

            container.innerHTML = referrers.map(r => `
                <div class="border border-gray-200 rounded-lg p-4">
                    <div class="flex items-start justify-between mb-2">
                        <div>
                            <div class="font-medium text-gray-900">${r.referrerName}</div>
                            <div class="text-sm text-gray-500">${r.referrerEmail}</div>
                        </div>
                        <div class="text-right">
                            <div class="text-2xl font-bold text-pink-600">${r.referees.length}äºº</div>
                            <div class="text-xs text-gray-500">ç´¹ä»‹</div>
                        </div>
                    </div>
                    <div class="text-sm text-gray-600">
                        ç²å¾—ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆ: <span class="font-medium text-green-600">${r.referees.length * 50}å›</span>
                    </div>
                </div>
            `).join('');
        }
    </script>
</body>
</html>
