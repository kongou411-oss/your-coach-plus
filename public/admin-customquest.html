<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>カスタムクエスト管理 - Your Coach+</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-functions-compat.js"></script>
    <script src="/config.js"></script>
    <script src="/js/cq-databases.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif; background: #f0f2f5; color: #333; height: 100vh; overflow: hidden; }
        .cq-header { background: white; border-bottom: 1px solid #e0e0e0; padding: 12px 24px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 4px rgba(0,0,0,0.05); z-index: 40; position: relative; }
        .cq-layout { display: flex; height: calc(100vh - 57px); }
        .cq-left { width: 280px; min-width: 280px; background: white; border-right: 1px solid #e0e0e0; display: flex; flex-direction: column; overflow: hidden; }
        .cq-main { flex: 1; overflow-y: auto; padding: 20px; }
        .cq-drawer-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.3); z-index: 45; opacity: 0; pointer-events: none; transition: opacity 0.3s; }
        .cq-drawer-overlay.open { opacity: 1; pointer-events: auto; }
        .cq-drawer { position: fixed; right: 0; top: 0; height: 100vh; width: 540px; background: rgba(255,255,255,0.92); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border-left: 1px solid rgba(255,255,255,0.3); box-shadow: -8px 0 30px rgba(0,0,0,0.12); transform: translateX(100%); transition: transform 0.3s cubic-bezier(0.4,0,0.2,1); z-index: 50; display: flex; flex-direction: column; overflow: hidden; }
        .cq-drawer.open { transform: translateX(0); }
        .tpl-card { border: 1px solid #e5e7eb; border-radius: 10px; padding: 10px 12px; margin-bottom: 8px; cursor: pointer; transition: all 0.15s; background: white; }
        .tpl-card:hover { border-color: #a78bfa; box-shadow: 0 2px 8px rgba(167,139,250,0.15); }
        .tpl-card-meal { border-left: 3px solid #22c55e; }
        .tpl-card-workout { border-left: 3px solid #3b82f6; }
        .bento-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; }
        .bento-card { background: white; border-radius: 14px; padding: 16px; box-shadow: 0 1px 4px rgba(0,0,0,0.06); border: 1px solid #e5e7eb; }
        .bento-card-lg { grid-column: span 2; grid-row: span 2; }
        .bento-card-md { grid-column: span 2; }
        .pfc-bar-bg { height: 22px; background: #f3f4f6; border-radius: 11px; overflow: hidden; position: relative; margin-bottom: 8px; }
        .pfc-bar-fill { height: 100%; border-radius: 11px; transition: width 0.4s ease, background-color 0.3s; }
        .pfc-bar-label { position: absolute; left: 8px; top: 50%; transform: translateY(-50%); font-size: 11px; font-weight: 600; color: #374151; z-index: 1; }
        .pfc-bar-value { position: absolute; right: 8px; top: 50%; transform: translateY(-50%); font-size: 10px; color: #6b7280; z-index: 1; }
        .cq-cat-btn { font-size: 11px; padding: 3px 8px; border: 1px solid #d1d5db; border-radius: 9999px; background: white; cursor: pointer; transition: all 0.15s; }
        .cq-cat-btn:hover { background: #fef9c3; border-color: #facc15; }
        .cq-cat-active { background: #fef08a !important; border-color: #eab308 !important; font-weight: 600; }
        .slot-timeline { display: flex; gap: 12px; overflow-x: auto; padding: 8px 0; }
        .slot-card { min-width: 110px; border: 2px solid #e5e7eb; border-radius: 12px; padding: 10px; text-align: center; cursor: pointer; transition: all 0.2s; flex-shrink: 0; }
        .slot-card:hover { border-color: #a78bfa; transform: translateY(-2px); }
        .slot-card.assigned { border-color: #22c55e; background: #f0fdf4; }
        .slot-card.selected { border-color: #7c3aed; background: #f5f3ff; box-shadow: 0 4px 12px rgba(124,58,237,0.15); }
        .cq-left::-webkit-scrollbar, .cq-main::-webkit-scrollbar, .cq-drawer::-webkit-scrollbar { width: 6px; }
        .cq-left::-webkit-scrollbar-thumb, .cq-main::-webkit-scrollbar-thumb, .cq-drawer::-webkit-scrollbar-thumb { background: #d1d5db; border-radius: 3px; }
        .prof-tab { padding: 6px 14px; font-size: 12px; font-weight: 600; border-bottom: 2px solid transparent; cursor: pointer; color: #6b7280; transition: all 0.2s; border-radius: 6px 6px 0 0; }
        .prof-tab.active { border-color: #7c3aed; color: #7c3aed; background: #f5f3ff; }
        @media (max-width: 1200px) { .bento-grid { grid-template-columns: repeat(2, 1fr); } .bento-card-lg { grid-column: span 2; grid-row: span 1; } }
        @media (max-width: 768px) { .cq-layout { flex-direction: column; } .cq-left { width: 100%; min-width: 100%; max-height: 200px; border-right: none; border-bottom: 1px solid #e0e0e0; } .cq-drawer { width: 100%; } .bento-grid { grid-template-columns: 1fr; } .bento-card-lg, .bento-card-md { grid-column: span 1; } }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="cq-header">
        <div class="flex items-center gap-3">
            <a href="/admin.html" class="text-sm text-gray-500 hover:text-purple-600 transition">&#8592; 管理画面</a>
            <span class="text-gray-300">|</span>
            <h1 class="text-lg font-bold text-gray-800">カスタムクエスト管理</h1>
            <span class="text-xs bg-purple-100 text-purple-700 px-2 py-0.5 rounded-full font-bold" id="cq-template-count">0</span>
        </div>
        <div class="flex items-center gap-3">
            <span class="text-sm text-gray-500" id="user-info"></span>
            <button onclick="logout()" class="text-xs text-red-500 hover:text-red-700">ログアウト</button>
        </div>
    </div>

    <div class="cq-layout">
        <!-- Left Pane: Template Library -->
        <div class="cq-left">
            <div class="p-3 border-b border-gray-200">
                <div class="flex items-center justify-between mb-2">
                    <span class="text-sm font-bold text-gray-700">テンプレート</span>
                    <button onclick="openDrawer('create')" class="bg-purple-600 text-white text-xs px-3 py-1.5 rounded-lg hover:bg-purple-700 font-bold">+ 新規</button>
                </div>
                <input type="text" id="cq-tpl-search" placeholder="検索..." oninput="renderTemplateList()" class="w-full border border-gray-300 rounded-lg px-3 py-1.5 text-sm mb-2">
                <div class="flex gap-1">
                    <button onclick="setLeftFilter('ALL')" class="cq-left-filter text-[10px] px-2 py-1 rounded-full border border-gray-300 cq-cat-active" data-filter="ALL">ALL</button>
                    <button onclick="setLeftFilter('MEAL')" class="cq-left-filter text-[10px] px-2 py-1 rounded-full border border-gray-300" data-filter="MEAL">MEAL</button>
                    <button onclick="setLeftFilter('WORKOUT')" class="cq-left-filter text-[10px] px-2 py-1 rounded-full border border-gray-300" data-filter="WORKOUT">WORKOUT</button>
                    <select id="cq-tpl-sort" onchange="renderTemplateList()" class="text-[10px] border border-gray-300 rounded px-1 py-0.5 ml-auto">
                        <option value="newest">新しい順</option><option value="oldest">古い順</option><option value="name-asc">名前順</option><option value="cal-desc">Cal高い順</option><option value="cal-asc">Cal低い順</option>
                    </select>
                </div>
            </div>
            <div class="flex-1 overflow-y-auto p-3" id="cq-template-list"><div class="text-center text-gray-400 text-sm py-8">読み込み中...</div></div>
            <div class="p-2 border-t border-gray-200 text-center">
                <div class="flex gap-1 justify-center">
                    <button onclick="createDefaultTemplates()" class="text-[10px] bg-indigo-500 text-white px-2 py-1 rounded hover:bg-indigo-600">食事テンプレ一括</button>
                    <button onclick="createDefaultWorkoutTemplates()" class="text-[10px] bg-blue-500 text-white px-2 py-1 rounded hover:bg-blue-600">運動テンプレ一括</button>
                </div>
                <div id="cq-default-tpl-msg" class="text-[10px] mt-1"></div>
            </div>
        </div>

        <!-- Main Pane -->
        <div class="cq-main">
            <!-- User Selection -->
            <div class="bg-white rounded-xl p-4 mb-4 shadow-sm border border-gray-200">
                <div class="flex flex-wrap items-center gap-3 mb-3">
                    <div class="flex-1 min-w-[200px]">
                        <div class="flex gap-2">
                            <input type="text" id="cq-assign-uid" placeholder="ユーザーIDを入力..." class="flex-1 border border-gray-300 rounded-lg px-3 py-2 text-sm">
                            <button onclick="loadUserSlots()" class="bg-purple-600 text-white px-4 py-2 rounded-lg text-sm hover:bg-purple-700 font-bold">読み込み</button>
                        </div>
                    </div>
                    <div class="flex items-center gap-2">
                        <label class="flex items-center gap-1 text-sm cursor-pointer">
                            <input type="checkbox" id="cq-assign-persistent" checked class="rounded">
                            <span class="text-xs font-bold text-yellow-700 bg-yellow-100 px-2 py-0.5 rounded">永続</span>
                        </label>
                        <input type="date" id="cq-assign-date" class="border border-gray-300 rounded-lg px-2 py-1.5 text-sm">
                    </div>
                </div>
                <div class="flex flex-wrap gap-1" id="cq-recent-users"><span class="text-gray-400 text-xs">最近のユーザー: なし</span></div>
                <div id="cq-assign-user-info" class="mt-2 text-sm font-bold text-purple-700"></div>
            </div>

            <!-- Bento Grid -->
            <div id="cq-bento-container" class="hidden">
                <div class="bento-grid">
                    <!-- PFC Summary -->
                    <div class="bento-card bento-card-lg" id="bento-pfc">
                        <div class="flex items-center justify-between mb-3">
                            <h3 class="font-bold text-gray-800">PFC サマリー</h3>
                            <span class="text-xs text-gray-400" id="pfc-target-label">---</span>
                        </div>
                        <div id="pfc-bars-container"><div class="text-gray-400 text-sm text-center py-4">ユーザーを読み込んでください</div></div>
                    </div>
                    <!-- Slot Timeline -->
                    <div class="bento-card bento-card-lg" id="bento-slots">
                        <div class="flex items-center justify-between mb-2">
                            <h3 class="font-bold text-gray-800">スロットタイムライン</h3>
                            <button onclick="assignAllSlots()" class="text-[10px] bg-green-600 text-white px-3 py-1 rounded hover:bg-green-700 font-bold">一括保存</button>
                        </div>
                        <div id="cq-slot-timeline" class="slot-timeline mb-3"></div>
                        <div id="cq-assign-slot-container"><div class="text-gray-400 text-sm text-center py-2">---</div></div>
                        <input type="hidden" id="cq-assign-slot" value="">
                        <div id="cq-bulk-assign-message" class="mt-1 text-sm"></div>
                        <div id="cq-assign-message" class="mt-1 text-sm"></div>
                    </div>
                    <!-- Profile -->
                    <div class="bento-card bento-card-md">
                        <div class="flex items-center justify-between mb-2">
                            <h3 class="font-bold text-gray-800 text-sm">プロフィール</h3>
                            <button onclick="toggleProfileEditor()" class="text-[10px] bg-orange-500 text-white px-2 py-1 rounded hover:bg-orange-600">編集</button>
                        </div>
                        <div id="cq-user-profile-content" class="text-xs max-h-[300px] overflow-y-auto"><span class="text-gray-400">データなし</span></div>
                    </div>
                    <!-- Routine -->
                    <div class="bento-card bento-card-md">
                        <h3 class="font-bold text-gray-800 text-sm mb-2">ルーティン</h3>
                        <div id="cq-user-routine-content" class="text-xs max-h-[300px] overflow-y-auto"><span class="text-gray-400">データなし</span></div>
                    </div>
                    <!-- User Templates -->
                    <div class="bento-card bento-card-md">
                        <h3 class="font-bold text-gray-800 text-sm mb-2" id="cq-info-tab-templates">テンプレート</h3>
                        <div id="cq-user-templates-content" class="text-xs max-h-[300px] overflow-y-auto"><span class="text-gray-400">データなし</span></div>
                    </div>
                    <!-- Assignment History -->
                    <div class="bento-card bento-card-md">
                        <h3 class="font-bold text-gray-800 text-sm mb-2" id="cq-assign-list-title">割当履歴</h3>
                        <div id="cq-assign-list" class="text-xs max-h-[300px] overflow-y-auto"><span class="text-gray-400">データなし</span></div>
                    </div>
                </div>
            </div>

            <!-- Profile Editor -->
            <div id="cq-profile-editor" class="hidden mt-4 bg-white rounded-xl p-4 shadow-sm border border-gray-200">
                <div class="flex items-center justify-between mb-3">
                    <h3 class="font-bold text-gray-800">プロフィール編集</h3>
                    <div class="flex gap-2">
                        <button onclick="resetAllProfileDefaults()" class="text-xs text-gray-500 hover:text-gray-700">リセット</button>
                        <button onclick="saveUserProfile()" class="bg-green-600 text-white px-4 py-1.5 rounded-lg text-sm hover:bg-green-700 font-bold">保存</button>
                    </div>
                </div>
                <div id="cq-profile-save-msg" class="hidden text-sm mb-2"></div>
                <div class="flex gap-1 mb-3 border-b border-gray-200 pb-1">
                    <button onclick="switchProfileTab('schedule')" id="cq-tab-schedule" class="prof-tab active">時刻</button>
                    <button onclick="switchProfileTab('basic')" id="cq-tab-basic" class="prof-tab">基本</button>
                    <button onclick="switchProfileTab('goal')" id="cq-tab-goal" class="prof-tab">目標/PFC</button>
                    <button onclick="switchProfileTab('food')" id="cq-tab-food" class="prof-tab">食材</button>
                </div>
                <div id="cq-panel-schedule" class="cq-prof-panel">
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                        <div><label class="block text-xs text-gray-500 mb-1">起床</label><input type="time" id="cq-prof-wake" value="07:00" class="w-full border border-gray-300 rounded px-2 py-1.5 text-sm" onchange="onMealsPerDayChange()"></div>
                        <div><label class="block text-xs text-gray-500 mb-1">就寝</label><input type="time" id="cq-prof-sleep" value="23:00" class="w-full border border-gray-300 rounded px-2 py-1.5 text-sm" onchange="onMealsPerDayChange()"></div>
                        <div><label class="block text-xs text-gray-500 mb-1">食事回数</label><input type="number" id="cq-prof-meals" value="5" min="2" max="8" class="w-full border border-gray-300 rounded px-2 py-1.5 text-sm" onchange="onMealsPerDayChange()"></div>
                        <div><label class="block text-xs text-gray-500 mb-1">トレ後食事番号</label><input type="number" id="cq-prof-training-after" placeholder="例:3" min="1" max="8" class="w-full border border-gray-300 rounded px-2 py-1.5 text-sm" onchange="toggleTrainingFields();onMealsPerDayChange()"></div>
                    </div>
                    <div id="cq-training-fields" class="hidden mt-3 grid grid-cols-3 gap-3">
                        <div><label class="block text-xs text-gray-500 mb-1">トレ開始</label><input type="time" id="cq-prof-training-time" value="17:00" class="w-full border border-gray-300 rounded px-2 py-1.5 text-sm" onchange="onMealsPerDayChange()"></div>
                        <div><label class="block text-xs text-gray-500 mb-1">トレ時間(分)</label><input type="number" id="cq-prof-training-dur" value="120" class="w-full border border-gray-300 rounded px-2 py-1.5 text-sm"></div>
                        <div><label class="block text-xs text-gray-500 mb-1">スタイル</label><select id="cq-prof-style" class="w-full border border-gray-300 rounded px-2 py-1.5 text-sm"><option value="POWER">パワー</option><option value="PUMP" selected>パンプ</option><option value="MIXED">ミックス</option></select></div>
                    </div>
                </div>
                <div id="cq-panel-basic" class="cq-prof-panel hidden">
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                        <div><label class="block text-xs text-gray-500 mb-1">ニックネーム</label><input type="text" id="cq-prof-nickname" class="w-full border border-gray-300 rounded px-2 py-1.5 text-sm"></div>
                        <div><label class="block text-xs text-gray-500 mb-1">年齢</label><input type="number" id="cq-prof-age" class="w-full border border-gray-300 rounded px-2 py-1.5 text-sm"></div>
                        <div><label class="block text-xs text-gray-500 mb-1">性別</label><select id="cq-prof-gender" class="w-full border border-gray-300 rounded px-2 py-1.5 text-sm"><option value="MALE">男性</option><option value="FEMALE">女性</option><option value="OTHER">その他</option></select></div>
                        <div><label class="block text-xs text-gray-500 mb-1">身長cm</label><input type="number" id="cq-prof-height" step="0.1" class="w-full border border-gray-300 rounded px-2 py-1.5 text-sm"></div>
                        <div><label class="block text-xs text-gray-500 mb-1">体重kg</label><input type="number" id="cq-prof-weight" step="0.1" class="w-full border border-gray-300 rounded px-2 py-1.5 text-sm"></div>
                        <div><label class="block text-xs text-gray-500 mb-1">体脂肪%</label><input type="number" id="cq-prof-bodyfat" step="0.1" class="w-full border border-gray-300 rounded px-2 py-1.5 text-sm"></div>
                        <div><label class="block text-xs text-gray-500 mb-1">目標体重</label><input type="number" id="cq-prof-target-weight" step="0.1" class="w-full border border-gray-300 rounded px-2 py-1.5 text-sm"></div>
                        <div><label class="block text-xs text-gray-500 mb-1">理想体重</label><input type="number" id="cq-prof-ideal-weight" step="0.1" class="w-full border border-gray-300 rounded px-2 py-1.5 text-sm"></div>
                        <div><label class="block text-xs text-gray-500 mb-1">理想体脂肪%</label><input type="number" id="cq-prof-ideal-bodyfat" step="0.1" class="w-full border border-gray-300 rounded px-2 py-1.5 text-sm"></div>
                    </div>
                </div>
                <div id="cq-panel-goal" class="cq-prof-panel hidden">
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                        <div><label class="block text-xs text-gray-500 mb-1">目標</label><select id="cq-prof-goal" class="w-full border border-gray-300 rounded px-2 py-1.5 text-sm"><option value="LOSE_FAST">急速減量</option><option value="LOSE">減量</option><option value="LOSE_SLOW">ゆるやか減量</option><option value="MAINTAIN" selected>維持</option><option value="GAIN_SLOW">ゆるやか増量</option><option value="GAIN">増量</option></select></div>
                        <div><label class="block text-xs text-gray-500 mb-1">活動レベル</label><select id="cq-prof-activity" class="w-full border border-gray-300 rounded px-2 py-1.5 text-sm"><option value="DESK_WORK" selected>デスクワーク</option><option value="STANDING_WORK">立ち仕事</option><option value="PHYSICAL_LABOR">肉体労働</option></select></div>
                        <div><label class="block text-xs text-gray-500 mb-1">Cal調整</label><input type="number" id="cq-prof-cal-adjust" value="0" class="w-full border border-gray-300 rounded px-2 py-1.5 text-sm"></div>
                        <div><label class="block text-xs text-gray-500 mb-1">食費</label><select id="cq-prof-budget" class="w-full border border-gray-300 rounded px-2 py-1.5 text-sm"><option value="1">節約</option><option value="2" selected>標準</option><option value="3">ゆとり</option></select></div>
                    </div>
                    <div class="mt-3 grid grid-cols-3 gap-3">
                        <div><label class="block text-xs text-gray-500 mb-1">P%</label><input type="number" id="cq-prof-prot-ratio" value="30" class="w-full border border-gray-300 rounded px-2 py-1.5 text-sm"></div>
                        <div><label class="block text-xs text-gray-500 mb-1">F%</label><input type="number" id="cq-prof-fat-ratio" value="25" class="w-full border border-gray-300 rounded px-2 py-1.5 text-sm"></div>
                        <div><label class="block text-xs text-gray-500 mb-1">C%</label><input type="number" id="cq-prof-carb-ratio" value="45" class="w-full border border-gray-300 rounded px-2 py-1.5 text-sm"></div>
                    </div>
                    <div class="mt-3"><div class="text-xs font-bold text-gray-600 mb-1">トレ前PFC(g)</div><div class="grid grid-cols-3 gap-3"><div><input type="number" id="cq-prof-pre-p" value="20" class="w-full border border-gray-300 rounded px-2 py-1.5 text-sm" placeholder="P"></div><div><input type="number" id="cq-prof-pre-f" value="5" class="w-full border border-gray-300 rounded px-2 py-1.5 text-sm" placeholder="F"></div><div><input type="number" id="cq-prof-pre-c" value="50" class="w-full border border-gray-300 rounded px-2 py-1.5 text-sm" placeholder="C"></div></div></div>
                    <div class="mt-2"><div class="text-xs font-bold text-gray-600 mb-1">トレ後PFC(g)</div><div class="grid grid-cols-3 gap-3"><div><input type="number" id="cq-prof-post-p" value="30" class="w-full border border-gray-300 rounded px-2 py-1.5 text-sm" placeholder="P"></div><div><input type="number" id="cq-prof-post-f" value="5" class="w-full border border-gray-300 rounded px-2 py-1.5 text-sm" placeholder="F"></div><div><input type="number" id="cq-prof-post-c" value="60" class="w-full border border-gray-300 rounded px-2 py-1.5 text-sm" placeholder="C"></div></div></div>
                </div>
                <div id="cq-panel-food" class="cq-prof-panel hidden">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                        <div><label class="block text-xs text-gray-500 mb-1">優先タンパク源</label><input type="text" id="cq-prof-prot-sources" placeholder="鶏むね肉, 鮭" class="w-full border border-gray-300 rounded px-2 py-1.5 text-sm"></div>
                        <div><label class="block text-xs text-gray-500 mb-1">優先炭水化物源</label><input type="text" id="cq-prof-carb-sources" placeholder="白米, 玄米" class="w-full border border-gray-300 rounded px-2 py-1.5 text-sm"></div>
                        <div><label class="block text-xs text-gray-500 mb-1">優先脂質源</label><input type="text" id="cq-prof-fat-sources" placeholder="オリーブオイル" class="w-full border border-gray-300 rounded px-2 py-1.5 text-sm"></div>
                        <div><label class="block text-xs text-gray-500 mb-1">避けたい食材</label><input type="text" id="cq-prof-avoid-foods" class="w-full border border-gray-300 rounded px-2 py-1.5 text-sm"></div>
                        <div><label class="block text-xs text-gray-500 mb-1">アレルギー</label><input type="text" id="cq-prof-allergies" class="w-full border border-gray-300 rounded px-2 py-1.5 text-sm"></div>
                        <div><label class="block text-xs text-gray-500 mb-1">よく食べる食材</label><input type="text" id="cq-prof-fav-foods" class="w-full border border-gray-300 rounded px-2 py-1.5 text-sm"></div>
                        <div><label class="block text-xs text-gray-500 mb-1">NG食材</label><input type="text" id="cq-prof-ng-foods" class="w-full border border-gray-300 rounded px-2 py-1.5 text-sm"></div>
                    </div>
                </div>
            </div>

            <!-- Custom Items Panel (hidden by default) -->
            <div id="cq-user-panels" class="hidden mt-4 bg-white rounded-xl p-4 shadow-sm border border-gray-200">
                <h3 class="font-bold text-gray-800 text-sm mb-2" id="cq-info-tab-custom">カスタムアイテム</h3>
                <div id="cq-user-custom-items-content" class="text-xs max-h-[300px] overflow-y-auto"><span class="text-gray-400">データなし</span></div>
            </div>
        </div>
    </div>

    <!-- Drawer Overlay -->
    <div class="cq-drawer-overlay" id="cq-drawer-overlay" onclick="closeDrawer()"></div>
    <!-- Glassmorphism Drawer -->
    <div class="cq-drawer" id="cq-drawer">
        <div class="p-4 border-b border-gray-200 flex items-center justify-between">
            <h2 class="font-bold text-gray-800" id="cq-drawer-title">テンプレート作成</h2>
            <button onclick="closeDrawer()" class="text-gray-400 hover:text-gray-600 text-2xl leading-none">&times;</button>
        </div>
        <div class="flex-1 overflow-y-auto p-4">
            <div class="mb-3"><label class="block text-sm font-bold mb-1">テンプレート名</label><input type="text" id="cq-tpl-title" placeholder="例: 【減量】定番の朝食セット" class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm"></div>
            <div class="mb-3"><label class="block text-sm font-bold mb-1">タイプ</label><select id="cq-tpl-type" class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm" onchange="onTemplateTypeChange()"><option value="MEAL">MEAL</option><option value="WORKOUT">WORKOUT</option></select></div>
            <div class="flex flex-wrap gap-1 mb-3" id="cq-category-tabs"></div>
            <!-- Meal inputs -->
            <div id="cq-meal-inputs">
                <div class="flex gap-2 items-end mb-2">
                    <div class="flex-1"><label class="block text-xs text-gray-500 mb-1" id="cq-tpl-item-label">食品名</label><div class="relative"><input type="text" id="cq-tpl-food-search" placeholder="食品名で検索..." class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm" oninput="filterFoodList()" onfocus="showFoodDropdown()" autocomplete="off"><div id="cq-food-dropdown" class="absolute z-50 w-full bg-white border border-gray-300 rounded-lg mt-1 max-h-48 overflow-y-auto hidden shadow-lg"></div></div></div>
                    <div style="width:75px"><label class="block text-xs text-gray-500 mb-1">量</label><input type="number" id="cq-tpl-food-amount" placeholder="100" min="0" step="0.1" class="w-full border border-gray-300 rounded-lg px-2 py-2 text-sm"></div>
                    <div style="width:65px"><label class="block text-xs text-gray-500 mb-1">単位</label><select id="cq-tpl-food-unit" class="w-full border border-gray-300 rounded-lg px-1 py-2 text-sm"><option value="g">g</option><option value="個">個</option><option value="ml">ml</option><option value="杯">杯</option><option value="枚">枚</option><option value="本">本</option><option value="丁">丁</option><option value="粒">粒</option></select></div>
                    <button onclick="addTemplateItem()" class="bg-blue-500 text-white px-3 py-2 rounded-lg text-sm hover:bg-blue-600 font-bold">+</button>
                </div>
            </div>
            <!-- Workout inputs -->
            <div id="cq-workout-inputs" class="hidden">
                <div class="flex gap-2 items-end mb-2">
                    <div class="flex-1"><label class="block text-xs text-gray-500 mb-1">種目名</label><div class="relative"><input type="text" id="cq-tpl-exercise-search" placeholder="種目名で検索..." class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm" oninput="filterFoodList()" onfocus="showFoodDropdown()" autocomplete="off"><div id="cq-exercise-dropdown" class="absolute z-50 w-full bg-white border border-gray-300 rounded-lg mt-1 max-h-48 overflow-y-auto hidden shadow-lg"></div></div></div>
                    <button onclick="addTemplateItem()" class="bg-blue-500 text-white px-3 py-2 rounded-lg text-sm hover:bg-blue-600 font-bold">+</button>
                </div>
                <div id="cq-strength-fields" class="flex flex-wrap gap-2 mt-2">
                    <div style="width:75px"><label class="block text-xs text-gray-500 mb-1">セット</label><input type="number" id="cq-ex-sets" placeholder="3" class="w-full border border-gray-300 rounded px-2 py-1.5 text-sm"></div>
                    <div style="width:75px"><label class="block text-xs text-gray-500 mb-1">回数</label><input type="number" id="cq-ex-reps" placeholder="10" class="w-full border border-gray-300 rounded px-2 py-1.5 text-sm"></div>
                    <div style="width:75px"><label class="block text-xs text-gray-500 mb-1">重量kg</label><input type="number" id="cq-ex-weight" placeholder="60" step="0.5" class="w-full border border-gray-300 rounded px-2 py-1.5 text-sm"></div>
                    <div style="width:75px"><label class="block text-xs text-gray-500 mb-1">分</label><input type="number" id="cq-ex-duration-strength" placeholder="15" class="w-full border border-gray-300 rounded px-2 py-1.5 text-sm"></div>
                </div>
                <div id="cq-rm-fields" class="flex gap-2 mt-2">
                    <div style="width:85px"><label class="block text-xs text-gray-500 mb-1">1RM%下限</label><input type="number" id="cq-ex-rm-min" placeholder="70" max="100" step="5" class="w-full border border-orange-300 rounded px-2 py-1.5 text-sm"></div>
                    <div style="width:85px"><label class="block text-xs text-gray-500 mb-1">1RM%上限</label><input type="number" id="cq-ex-rm-max" placeholder="80" max="100" step="5" class="w-full border border-orange-300 rounded px-2 py-1.5 text-sm"></div>
                </div>
                <div id="cq-cardio-fields" class="hidden flex gap-2 mt-2">
                    <div style="width:75px"><label class="block text-xs text-gray-500 mb-1">分</label><input type="number" id="cq-ex-duration-cardio" placeholder="30" class="w-full border border-gray-300 rounded px-2 py-1.5 text-sm"></div>
                    <div style="width:85px"><label class="block text-xs text-gray-500 mb-1">距離km</label><input type="number" id="cq-ex-distance" placeholder="5" step="0.1" class="w-full border border-gray-300 rounded px-2 py-1.5 text-sm"></div>
                </div>
                <div id="cq-stretch-fields" class="hidden flex gap-2 mt-2">
                    <div style="width:75px"><label class="block text-xs text-gray-500 mb-1">分</label><input type="number" id="cq-ex-duration-stretch" placeholder="10" class="w-full border border-gray-300 rounded px-2 py-1.5 text-sm"></div>
                </div>
            </div>
            <div class="mt-3"><label class="block text-sm font-bold mb-1">追加済みアイテム</label><div id="cq-tpl-item-list" class="border border-dashed border-gray-300 rounded-lg p-3 min-h-[50px] text-sm text-gray-400">アイテムを追加してください</div></div>
            <div id="cq-tpl-message" class="mt-2 text-sm"></div>
        </div>
        <div class="p-4 border-t border-gray-200">
            <button onclick="handleDrawerSave()" id="cq-drawer-save-btn" class="w-full bg-purple-600 text-white py-2.5 rounded-lg font-bold hover:bg-purple-700 transition">テンプレートを保存</button>
        </div>
    </div>

    <!-- MAIN SCRIPT (loaded after cq-databases.js) -->
    <script src="/js/cq-functions.js"></script>
</body>
</html>
