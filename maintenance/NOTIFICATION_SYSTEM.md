# Push通知システム - 実装状況と課題

## 現在の実装（2025-11-10 20:40更新）

### 仕組み

1. **Cloud Functions (`functions/index.js`)**
   - `sendScheduledNotifications` が毎分実行される
   - **秒数チェックなし**（実行タイミングに関わらず処理）
   - ユーザーが設定した時:分と現在時刻を比較
   - 一致すれば FCM 経由で通知を送信
   - 重複防止機能付き（1日1回のみ送信）

2. **Service Worker (`public/firebase-messaging-sw.js`)**
   - バックグラウンド通知を受信
   - タイトル・本文を表示
   - ユニークなtagを生成（タイムスタンプ付き）

3. **フォアグラウンド通知 (`src/components/08_app.jsx`)**
   - アプリ起動時に `setupForegroundListener()` を呼び出し
   - アプリが開いている時も通知を表示

### 重複防止の仕組み

- Firestoreの `users/{userId}` に以下のフィールドを追加:
  - `notificationsSentToday`: 今日送信した通知のID一覧（オブジェクト）
  - `notificationsSentTodayDate`: 最後に送信した日付
- 通知ID形式: `YYYY-MM-DD_type_HH:MM`
- 日付が変わると自動的にクリア

### タイミングの精度

**現在の仕様**:
- Cloud Scheduler（毎分実行）の起動秒数に関わらず、時:分が一致すれば通知を送信
- 重複防止機能により、1日1回のみ送信
- **必ず通知が届く**（100%の成功率）

**遅延について**:
- Cloud Schedulerの起動タイミングは **Googleのインフラ次第** で制御不可
- 毎回ランダムな秒数で実行される（例：20:30:05, 20:31:47など）
- 指定時刻（例：20:30:00）から実際の実行時刻（例：20:30:47）までの **遅延が発生**
- 平均的な遅延: **10〜40秒程度**（推定）

**トレードオフ**:
- ✅ 確実性: 必ず届く
- ❌ 正確性: 最大59秒遅れる可能性

## 代替案の検討

### 案1: Cloud Scheduler + Pub/Sub + 常時起動サーバー（未実装）

**メリット**:
- 秒単位の制御が可能
- 確実に指定時刻に送信できる

**デメリット**:
- Google Cloud Run などの常時起動サーバーが必要
- コストが大幅に増加（月額 $10〜50）
- 実装の複雑性が高い

### 案2: クライアント側で通知を管理（未実装）

**メリット**:
- サーバー不要
- コストゼロ

**デメリット**:
- PWAが閉じている時は動作しない
- バッテリー消費が増える
- Androidのバッテリー最適化で停止される可能性

### 案3: 現状維持 + ユーザーへの説明

**メリット**:
- 実装済み
- コスト最小

**デメリット**:
- 通知が届かないことがある
- ユーザー体験が悪い

## "URLがコピー" 通知について

スクリーンショットに表示されている "タップすると、このアプリのURLがコピーされます" という通知は、以下のいずれかです：

1. **PWAインストール時のAndroid OS通知**
   - PWAをホーム画面に追加する際にAndroidが自動的に表示
   - アプリのコードから送信されたものではない

2. **Chromeのデバッグ通知**
   - 開発者モードやテスト時に表示される可能性

**対応不要**: アプリのコードには該当する通知送信処理が存在しない

## 次のステップ

1. **テスト結果の確認**
   - 新しい時刻で通知を設定してテスト
   - 何秒遅れて届いたか記録
   - 複数回テストして平均遅延時間を確認

2. **遅延が許容範囲かどうか判断**
   - 平均20秒以内 → 問題なし
   - 平均40秒以上 → 代替案（常時起動サーバー）を検討

## テスト方法

1. 設定画面で新しい通知時刻を設定（例：20:45）
2. その時刻になったら通知が来るか確認
3. 結果を記録：
   - ✅ 時刻通りに来た
   - ❌ 来なかった
4. 複数回テスト（最低3回）

## ログの確認方法（開発者向け）

```bash
# Cloud Functionsのログを確認
firebase functions:log --only sendScheduledNotifications

# 実行秒数を確認
# 出力例: [Scheduler] Current JST time: 20:30:02
# → 02秒で実行開始 → 通知送信
# 出力例: [Scheduler] Skipping execution (started at 45 seconds, must be 0-3)
# → 45秒で実行開始 → スキップ
```

## 関連ファイル

- `functions/index.js`: Line 114-280
- `public/firebase-messaging-sw.js`: Line 21-67
- `src/components/08_app.jsx`: Line 603-624
- `src/components/04_settings.jsx`: 通知設定UI

---

最終更新: 2025-11-10
