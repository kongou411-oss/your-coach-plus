# Gym Hunter 利用ガイド

## 概要
大阪市内のジムをGoogle Maps APIで自動収集し、Gemini AIでスコアリングする営業リスト作成ツール。

---

## 利用フロー

### 1. 事前準備（初回のみ）
```bash
cd C:/Users/yourc/ycn_re/gym_hunter
python test_setup.py  # 全て[OK]になることを確認
```

### 2. 検索エリアの設定（任意）
`main.py` の `SEARCH_QUERIES` を編集：
```python
SEARCH_QUERIES = [
    "大阪市北区 24時間ジム",
    "大阪市北区 パーソナルジム",
    "大阪市中央区 24時間ジム",
    "大阪市中央区 パーソナルジム",
]
```

### 3. 実行
```bash
python main.py
```

**所要時間目安**: 約5-7分（4クエリ、60-70件の場合）

| 処理 | 時間/件 | 備考 |
|------|---------|------|
| Places API検索 | 1秒 | クエリごと |
| HP取得（Playwright） | 2秒 | サイトにより変動 |
| Gemini分析 | 2-3秒 | API応答時間 |
| **合計** | 約5秒/件 | 70件で約6分 |

### 4. 結果確認
- 出力: `gym_list_YYYYMMDD_HHMMSS.csv`
- Excelで開く場合はUTF-8 BOM対応済み

### 5. 営業アクション
| ランク | アクション |
|--------|-----------|
| **S** | 即架電・訪問 |
| **A** | 1週間以内にアプローチ |
| **B** | 情報不足。HP再確認後判断 |
| **C** | 除外（大手チェーン等） |

---

## コスト詳細

### Google Maps Platform

| API | 単価 | 無料枠 |
|-----|------|--------|
| Text Search | $32 / 1,000リクエスト | 月$200クレジット |
| Place Details | $17 / 1,000リクエスト | 同上 |

#### 1回の実行コスト試算（4クエリ、約65件取得）
| 項目 | 数量 | 単価 | 小計 |
|------|------|------|------|
| Text Search | 4回 | $0.032 | $0.128 |
| Place Details | 65回 | $0.017 | $1.105 |
| **合計** | - | - | **$1.23（約185円）** |

#### 月間無料枠での実行可能回数
- $200 ÷ $1.23 ≈ **162回/月**
- 毎日5回実行しても無料枠内

### Vertex AI (Gemini 2.5 Flash)

| 項目 | 単価（per 1M tokens） |
|------|----------------------|
| 入力 | $0.15 |
| 出力 | $0.60 |

※ Gemini 2.5 Flash の最新料金（2025年時点）

#### 1回の実行コスト試算（65件分析）
| 項目 | トークン数 | 単価 | 小計 |
|------|-----------|------|------|
| 入力（プロンプト+HP） | 65件 × 4,000 = 260,000 | $0.15/1M | $0.039 |
| 出力（JSON応答） | 65件 × 200 = 13,000 | $0.60/1M | $0.008 |
| **合計** | - | - | **$0.047（約7円）** |

### 総コスト

| 項目 | 1回あたり | 月10回利用 |
|------|----------|-----------|
| Maps API | $1.23（185円） | $12.3（1,850円） |
| Vertex AI | $0.05（7円） | $0.5（75円） |
| **合計** | **$1.28（192円）** | **$12.8（1,925円）** |

> **実質コスト**: 月$200の無料クレジット内なら **月間無料**

---

## 注意事項

### API関連
1. **Maps APIキーの制限推奨**
   - Google Cloud Console → 認証情報 → APIキーを編集
   - 「APIの制限」→ Places API のみ許可
   - 不正利用防止のため

2. **レート制限**
   - Places API: 秒間100リクエストまで
   - Vertex AI: 分間60リクエストまで
   - コード内に `time.sleep()` で対策済み

3. **gcloud認証の有効期限**
   - 認証トークンは数時間で期限切れ
   - エラー時は再認証：
   ```bash
   gcloud auth application-default login
   ```

### スクレイピング関連
1. **robots.txt非準拠サイト**
   - 一部サイトはスクレイピングでエラーになる場合あり
   - 該当サイトはランクB（情報不足）で記録

2. **JavaScript重いサイト**
   - SPA等は正しくテキスト取得できない場合あり
   - 2秒の待機時間を設定済み

### 運用Tips
1. **重複実行の回避**
   - 同じエリアを短期間で複数回実行すると重複データが発生
   - CSVは追記モードなので、必要に応じて古いファイルを削除

2. **エリア拡大時**
   - クエリを増やすとAPI呼び出し数が増加
   - 10クエリ以上は複数回に分けて実行推奨

3. **大手チェーンの除外**
   - `EXCLUDE_KEYWORDS` に追加可能
   ```python
   EXCLUDE_KEYWORDS = [
       "エニタイム", "ANYTIME", "RIZAP", ...
       "チョコザップ",  # 追加例
   ]
   ```

---

## トラブルシューティング

| エラー | 原因 | 対処 |
|--------|------|------|
| `Your default credentials were not found` | gcloud認証切れ | `gcloud auth application-default login` |
| `API key not valid` | Maps APIキー無効 | Cloud Consoleで確認・再発行 |
| `RESOURCE_EXHAUSTED` | レート制限 | 5-10分待って再実行 |
| `Publisher Model was not found` | モデル名/リージョン不正 | `.env`のGEMINI_MODEL確認 |

---

## ファイル構成

```
gym_hunter/
├── main.py              # メインスクリプト
├── test_setup.py        # セットアップ確認
├── .env                 # API設定（Git除外）
├── .env.example         # 設定テンプレート
├── requirements.txt     # 依存関係
├── .gitignore           # Git除外設定
├── USAGE_GUIDE.md       # このファイル
└── gym_list_*.csv       # 出力ファイル（Git除外）
```

---

## 料金モニタリング

### Google Cloud Console
https://console.cloud.google.com/billing

### 予算アラート設定推奨
1. Cloud Console → 課金 → 予算とアラート
2. 予算額: $50（無料枠超過防止）
3. アラート: 50%, 90%, 100%でメール通知
