# Your Coach+ - 食事入力ユーザーフロー分析

## 分析概要

このドキュメントは、Your Coach+アプリケーションにおける**食事入力フロー**を詳細に分析し、各シナリオでのタップ数と実装詳細を記録しています。

**分析対象ファイル:**
- `components/03_dashboard.js` - ダッシュボード
- `components/07_add_item_v2.js` - 食事入力モーダル
- `components/04_settings.js` - テンプレート・ルーティン管理
- `components/08_app.js` - メインアプリケーション

---

## シナリオ1: テンプレートを使用した食事入力

### フロー概要
12日以上利用すると自動でアンロックされる機能。保存した食事の組み合わせを1タップで復元できる最速の方法。

### ステップバイステップ

| # | アクション | 説明 | タップ数 | ファイル位置 |
|---|----------|------|--------|----------|
| 1 | ダッシュボード表示 | 初期状態 | 0 | - |
| 2 | 「食事」＋ボタンをタップ | 食事入力モーダルが開く | 1 | 03_dashboard.js:1478 |
| 3 | 「テンプレート」ボタンをタップ | テンプレート選択画面 | 1 | 07_add_item_v2.js:3902-3912 |
| 4 | テンプレートを選択 | リストから目的のテンプレートをタップ | 1 | 07_add_item_v2.js:3966 |
| 5 | 「記録」ボタンをタップ | 食事を保存 | 1 | 07_add_item_v2.js:4159 |

**合計: 4タップ（オプション: +1タップで食事名入力）**

### 技術詳細

- **アンロック条件**: 12日以上利用（`FEATURES.TRAINING_TEMPLATE.id`）
- **テンプレート表示**: Line 3918-4035
- **テンプレート選択時の処理**:
  - 選択されたテンプレートの`items`配列を`addedItems`に複製
  - モーダルは自動的に閉じる（`setShowTemplates(false)`）
  - アイテムは即座に「追加済み」セクションに表示

---

## シナリオ2: ルーティンを活用した食事入力

### 重要な注意事項

**ルーティンは食事テンプレートではなく、トレーニング計画です。**
- ルーティン表示: ダッシュボード上部に「Day X/Y」と本日のトレーニング分割を表示
- 食事入力の短縮効果: なし（表示機能のみ）

### ダッシュボード上のルーティン表示

| # | アクション | タップ数 | ファイル位置 |
|---|----------|--------|----------|
| - | 本日のルーティンを確認（自動表示） | 0 | 08_app.js:1443-1479 |

### 食事入力時のルーティン活用

| # | アクション | タップ数 |
|---|----------|--------|
| 1 | 「食事」＋ボタン | 1 |
| 2 | 食事名をルーティンのコンテキストで入力 | 1 |
| 3 | 入力方法を選択（テンプレート・検索など） | 1 |
| 4 | 食材を追加 | 3-5 |
| 5 | 「記録」ボタン | 1 |

**合計: 6-9タップ（他の方法と同等）**

### ルーティン設定フロー

| # | アクション | タップ数 |
|---|----------|--------|
| 1 | 設定タブを開く | 1 |
| 2 | 「ルーティン」セクションを展開 | 1 |
| 3 | Day1-7を編集（各Day: 名前変更1 + 休息日設定0-1 + 分割タイプ0-1） | 6-12 |
| 4 | 追加ルーティン枠を設定（最大5個） | 0-10 |

**合計: 8-24タップ（1回のみの設定）**

---

## シナリオ3: データベース検索による食事入力

### フロー概要
食材データベースから検索して入力。栄養情報が事前登録されているため、手動入力より高速。

### ステップバイステップ

| # | アクション | タップ数 | ファイル位置 |
|---|----------|--------|----------|
| 1 | 「食事」＋ボタン | 1 | 03_dashboard.js:1478 |
| 2 | 「食材を検索」ボタン | 1 | 07_add_item_v2.js:3869-3879 |
| 3 | 検索入力欄にタップ | 1 | 07_add_item_v2.js:4054-4060 |
| 4 | 食材名をタイプ（例: トマト） | 1 | (リアルタイム検索) |
| 5 | 検索結果から食材をタップ | 1 | 07_add_item_v2.js:4100+ |
| 6 | 数量をスライダーで調整 | 1 | (数量調整画面) |
| 7 | 「追加」ボタン | 1 | 07_add_item_v2.js:4100+ |
| 8 | 「記録」ボタン | 1 | 07_add_item_v2.js:4159 |

**単品: 8タップ**
**複数品: 8 + 4N タップ（N: 追加食材数）**

### 検索モーダルの特徴

- **リアルタイム検索**: 入力と同時に結果更新
- **結果数**: 最大20件
- **追加済み表示**: モーダル内に「追加済み」セクションで全アイテム表示
- **インライン編集**: 追加済みアイテムの編集・削除がモーダル内で可能
- **PFC合計**: 自動計算・表示

### 数量調整

デフォルト: 100gの栄養情報をベースに自動計算
```javascript
ratio = newAmount / 100;
calories = baseCalories * ratio;
protein = baseProtein * ratio;
```

---

## シナリオ4: 分析画面への遷移

### フロー概要
ダッシュボードからAI分析画面に移動。PFC分析とトレンドグラフを表示。

### ステップバイステップ

| # | アクション | タップ数 | ファイル位置 |
|---|----------|--------|----------|
| 1 | ダッシュボード上の「分析」ボタン | 1 | 03_dashboard.js:1524-1545 |
| 2 | 「分析を実行」ボタン | 1 | 02_analysis.js |
| 3 | AI処理中（待機） | - | Gemini API呼び出し（5-10秒） |
| 4 | 結果表示 | 0 | (自動表示) |
| 5 | 「ホーム」タップで戻る | 1 | BAB下部 |

**合計: 3タップ**

### 分析の詳細

- **クレジット消費**: 1回につき1クレジット
- **計算内容**:
  - 食事スコア: PFC実績 vs 目標の差分
  - 総合スコア: 食事スコア + トレーニングスコア の加重平均
- **出力**: 0-100のスコア、詳細フィードバック、グラフ

---

## シナリオ5: AI写真解析による食事入力

### フロー概要
写真を撮影・アップロード。Gemini AIが自動で食材を認識・栄養計算。最速で最も正確。

### ステップバイステップ

| # | アクション | タップ数 | ファイル位置 |
|---|----------|--------|----------|
| 1 | 「食事」＋ボタン | 1 | 03_dashboard.js:1478 |
| 2 | 「写真から記録」ボタン（黒背景） | 1 | 07_add_item_v2.js:3856-3866 |
| 3 | 「カメラで撮影」または「ギャラリーから選択」 | 1 | (ネイティブ選択) |
| 4 | 「AIで解析」ボタン | 1 | (Gemini API呼び出し) |
| 5 | AI処理中（待機） | - | (5-10秒) |
| 6 | 結果確認・編集（オプション） | 0-3 | 07_add_item_v2.js:3400+ |
| 7 | 「記録」ボタン | 1 | 07_add_item_v2.js:4159 |

**合計: 5-8タップ**

### AI認識の詳細

**API送信形式:**
```javascript
const prompt = `この画像から認識される食材と推定量を返してください: { foods: [...] }`
```

**出力形式:**
```json
{
  "foods": [
    { "name": "鶏肉", "amount": "150g", "calories": 250, "protein": 40 },
    { "name": "ご飯", "amount": "150g", "calories": 250, "protein": 5 }
  ]
}
```

**クレジット消費**: 1回につき1クレジット

---

## シナリオ6: カスタム手動入力

### フロー概要
データベースにない食材を手動で栄養情報を入力。最も詳細だが最も時間がかかる。

### ステップバイステップ

| # | アクション | タップ数 | ファイル位置 |
|---|----------|--------|----------|
| 1 | 「食事」＋ボタン | 1 | 03_dashboard.js:1478 |
| 2 | 「手動で作成」ボタン | 1 | 07_add_item_v2.js:3882-3898 |
| 3 | 食材名入力 | 1 | 07_add_item_v2.js:3730+ |
| 4 | 数量入力 | 1 | (フォーム) |
| 5 | カロリー入力 | 1 | (フォーム) |
| 6 | タンパク質（P）入力 | 1 | (フォーム) |
| 7 | 脂質（F）入力 | 1 | (フォーム) |
| 8 | 炭水化物（C）入力 | 1 | (フォーム) |
| 9 | 「追加」ボタン | 1 | (フォーム) |
| 10 | 「記録」ボタン | 1 | 07_add_item_v2.js:4159 |

**単品: 10タップ**
**複数品: 10 + 7N タップ（N: 追加食材数）**

### フォーム検証

```javascript
// 入力範囲チェック
calories: 0-2000 kcal
protein: 0-200g
fat: 0-150g
carbs: 0-500g

// PFC一貫性チェック
P*4 + F*9 + C*4 ≈ Calories (許容範囲: ±10%)
```

---

## タップ数比較表

| シナリオ | 最小 | 平均 | 最大 | 推奨度 |
|--------|-----|-----|-----|------|
| **テンプレート** | 4 | 5 | 6 | ⭐⭐⭐⭐⭐ |
| **AI写真** | 5 | 6 | 8 | ⭐⭐⭐⭐ |
| **検索** | 8 | 10 | 20+ | ⭐⭐⭐ |
| **手動** | 10 | 15 | 50+ | ⭐⭐ |
| **分析** | 3 | 3 | 3 | ⭐⭐⭐ |

---

## 機能アンロックタイムライン

- **Day 1**: 基本入力、検索、手動作成、写真解析
- **Day 5-7**: 初回分析実行可能（ルーティンアンロック）
- **Day 12+**: テンプレート機能アンロック

---

## クレジット消費ガイド

**毎日の推奨パターン:**
- 朝食: テンプレート (0 credits)
- 昼食: 検索 (0 credits)
- 夕食: 手動 (0 credits)
- 分析: 1回 (1 credit)
- 写真解析: 1回 (1 credit)

**合計: 2 credits/day = 60 credits/month**
初期: 50 credits, Premium: 100 credits/month

---

**分析対象ファイルサイズ:**
- 03_dashboard.js: 2,000行
- 07_add_item_v2.js: 5,500行
- 04_settings.js: 4,500行
- 08_app.js: 2,500行

**生成日: 2025年11月1日**
