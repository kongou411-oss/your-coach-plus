<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Â±•Ê≠¥„Ç∞„É©„Éï v1.6.0</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- ÁõÆÊ®ô„É©„Ç§„É≥„Éª„É°„É¢Ê©üËÉΩ -->
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@2.2.1"></script>
    <!-- „Ç´„Çπ„Çø„É†ÊúüÈñìÈÅ∏Êäû -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/ja.js"></script>
    <style>
        .tab-button {
            transition: all 0.3s ease;
            position: relative;
        }
        .tab-button.active {
            font-weight: 600;
        }
        .tab-button.active::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: currentColor;
        }
        .sub-tab-button {
            transition: all 0.2s ease;
        }
        .sub-tab-button.active {
            transform: scale(1.05);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .chart-container {
            animation: fadeIn 0.4s ease-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .day-box {
            aspect-ratio: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border-radius: 0.5rem;
            font-weight: 600;
            font-size: 0.75rem;
        }
        .day-box.done {
            background-color: #22c55e;
            color: white;
        }
        .day-box.not-done {
            background-color: #e5e7eb;
            color: #6b7280;
        }
        .range-control {
            background: #f3f4f6;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            padding: 0.75rem;
            margin-top: 1rem;
        }
        .period-button {
            transition: all 0.2s ease;
        }
        .period-button.active {
            background: #3b82f6;
            color: white;
            font-weight: 600;
        }
        .comparison-enabled .chart-section {
            border: 2px solid #3b82f6;
        }
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        .modal.show {
            display: flex;
        }
        .modal-content {
            background: white;
            border-radius: 1rem;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            animation: slideUp 0.3s ease-out;
        }
        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        .ai-analyzing {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .ai-analyzing .spinner {
            width: 20px;
            height: 20px;
            border: 3px solid #e5e7eb;
            border-top-color: #3b82f6;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .sync-icon {
            transition: transform 0.3s ease;
        }
        .sync-icon.syncing {
            animation: rotate 1s ease-in-out;
        }
        @keyframes rotate {
            to { transform: rotate(360deg); }
        }
        .info-icon {
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .info-icon:hover {
            transform: scale(1.1);
            color: #3b82f6;
        }
        .tooltip {
            display: none;
            position: absolute;
            background: white;
            border: 2px solid #3b82f6;
            border-radius: 0.5rem;
            padding: 1rem;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 100;
            max-width: 400px;
            animation: fadeIn 0.2s ease-out;
        }
        .tooltip.show {
            display: block;
        }
        .help-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }
        .help-modal.show {
            display: flex;
        }
        .help-content {
            background: white;
            border-radius: 1rem;
            max-width: 700px;
            width: 90%;
            max-height: 85vh;
            overflow-y: auto;
            animation: slideUp 0.3s ease-out;
        }
        .floating-panel {
            position: fixed;
            top: 80px;
            right: 20px;
            width: 320px;
            max-height: calc(100vh - 100px);
            background: white;
            border-radius: 1rem;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            z-index: 1500;
            overflow-y: auto;
            animation: slideInRight 0.3s ease-out;
        }
        .floating-panel.hidden {
            display: none;
        }
        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        .stats-inline {
            display: flex;
            justify-content: center;
            gap: 1.5rem;
            padding: 0.75rem;
            background: linear-gradient(to right, #f3f4f6, #e5e7eb);
            border-radius: 0.5rem;
            font-size: 0.875rem;
            margin-top: 1rem;
        }
        .stats-inline .stat-item {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .stats-inline .stat-value {
            font-size: 1.25rem;
            font-weight: bold;
        }
        .stats-inline .stat-label {
            font-size: 0.75rem;
            color: #6b7280;
            margin-top: 0.25rem;
        }
        .compact-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }
        .compact-buttons {
            display: flex;
            gap: 0.5rem;
        }
        .compact-buttons button {
            padding: 0.5rem 0.75rem;
            font-size: 0.875rem;
            border-radius: 0.5rem;
            transition: all 0.2s;
        }
    </style>
</head>
<body class="bg-gray-100 p-4">
    <div class="max-w-6xl mx-auto">
        <div class="flex items-center justify-between mb-4">
            <h1 class="text-2xl font-bold text-gray-800">üìä Â±•Ê≠¥„Ç∞„É©„Éï</h1>
        </div>

        <!-- „É°„Ç§„É≥„Ç≥„É≥„ÉÜ„Éä -->
        <div class="bg-white rounded-lg shadow-lg overflow-hidden">
            <!-- Â§ß„Ç´„ÉÜ„Ç¥„É™„Çø„Éñ -->
            <div class="flex border-b bg-gray-50">
                <button
                    class="tab-button flex-1 py-4 px-4 text-center transition text-gray-600"
                    onclick="selectMainCategory('nutrition', event)">
                    <div class="flex items-center justify-center gap-2">
                        <i data-lucide="utensils" class="w-5 h-5"></i>
                        <div>
                            <div class="text-sm font-semibold">È£ü‰∫ã</div>
                            <div class="text-xs opacity-75">85ÁÇπ</div>
                        </div>
                    </div>
                </button>
                <button
                    class="tab-button flex-1 py-4 px-4 text-center transition text-gray-600"
                    onclick="selectMainCategory('training', event)">
                    <div class="flex items-center justify-center gap-2">
                        <i data-lucide="dumbbell" class="w-5 h-5"></i>
                        <div>
                            <div class="text-sm font-semibold">ÈÅãÂãï</div>
                            <div class="text-xs opacity-75">88ÁÇπ</div>
                        </div>
                    </div>
                </button>
                <button
                    class="tab-button flex-1 py-4 px-4 text-center transition text-gray-600"
                    onclick="selectMainCategory('condition', event)">
                    <div class="flex items-center justify-center gap-2">
                        <i data-lucide="activity" class="w-5 h-5"></i>
                        <div>
                            <div class="text-sm font-semibold">„Ç≥„É≥„Éá„Ç£„Ç∑„Éß„É≥</div>
                            <div class="text-xs opacity-75">24/30ÁÇπ</div>
                        </div>
                    </div>
                </button>
                <button
                    class="tab-button flex-1 py-4 px-4 text-center transition active text-purple-600 bg-white border-b-0"
                    onclick="selectMainCategory('performance', event)">
                    <div class="flex items-center justify-center gap-2">
                        <i data-lucide="trending-up" class="w-5 h-5"></i>
                        <div>
                            <div class="text-sm font-semibold">„Éë„Éï„Ç©„Éº„Éû„É≥„Çπ</div>
                            <div class="text-xs opacity-75">Á∑èÂêà92ÁÇπ</div>
                        </div>
                    </div>
                </button>
            </div>

            <!-- Â∞è„Ç´„ÉÜ„Ç¥„É™„Çø„ÉñÔºàÈ£ü‰∫ãÔºâ -->
            <div id="nutrition-subtabs" class="sub-tabs flex flex-wrap gap-2 p-4 bg-green-50 border-b hidden">
                <button class="sub-tab-button active px-4 py-2 bg-white text-green-700 rounded-lg text-sm font-semibold border-2 border-green-500" onclick="selectSubCategory('nutrition', 'calories')">
                    „Ç´„É≠„É™„Éº
                </button>
                <button class="sub-tab-button px-4 py-2 bg-white text-gray-700 rounded-lg text-sm font-semibold border-2 border-transparent hover:border-gray-300" onclick="selectSubCategory('nutrition', 'protein')">
                    „Çø„É≥„Éë„ÇØË≥™
                </button>
                <button class="sub-tab-button px-4 py-2 bg-white text-gray-700 rounded-lg text-sm font-semibold border-2 border-transparent hover:border-gray-300" onclick="selectSubCategory('nutrition', 'carbs')">
                    ÁÇ≠Ê∞¥ÂåñÁâ©
                </button>
                <button class="sub-tab-button px-4 py-2 bg-white text-gray-700 rounded-lg text-sm font-semibold border-2 border-transparent hover:border-gray-300" onclick="selectSubCategory('nutrition', 'fat')">
                    ËÑÇË≥™
                </button>
                <button class="sub-tab-button px-4 py-2 bg-white text-gray-700 rounded-lg text-sm font-semibold border-2 border-transparent hover:border-gray-300" onclick="selectSubCategory('nutrition', 'water')">
                    Ê∞¥ÂàÜÊëÇÂèñ
                </button>
            </div>

            <!-- Â∞è„Ç´„ÉÜ„Ç¥„É™„Çø„ÉñÔºàÈÅãÂãïÔºâ -->
            <div id="training-subtabs" class="sub-tabs flex flex-wrap gap-2 p-4 bg-orange-50 border-b hidden">
                <button class="sub-tab-button active px-4 py-2 bg-white text-orange-700 rounded-lg text-sm font-semibold border-2 border-orange-500" onclick="selectSubCategory('training', 'workout_duration')">
                    ÈÅãÂãïÊôÇÈñì
                </button>
                <button class="sub-tab-button px-4 py-2 bg-white text-gray-700 rounded-lg text-sm font-semibold border-2 border-transparent hover:border-gray-300" onclick="selectSubCategory('training', 'workout_volume')">
                    Á∑èË≤†Ëç∑Èáè
                </button>
                <button class="sub-tab-button px-4 py-2 bg-white text-gray-700 rounded-lg text-sm font-semibold border-2 border-transparent hover:border-gray-300" onclick="selectSubCategory('training', 'steps')">
                    Ê≠©Êï∞
                </button>
                <button class="sub-tab-button px-4 py-2 bg-white text-gray-700 rounded-lg text-sm font-semibold border-2 border-transparent hover:border-gray-300" onclick="selectSubCategory('training', 'cardio')">
                    ÊúâÈÖ∏Á¥†ÈÅãÂãï
                </button>
            </div>

            <!-- Â∞è„Ç´„ÉÜ„Ç¥„É™„Çø„ÉñÔºà„Ç≥„É≥„Éá„Ç£„Ç∑„Éß„É≥Ôºâ -->
            <div id="condition-subtabs" class="sub-tabs flex flex-wrap gap-2 p-4 bg-red-50 border-b hidden">
                <button class="sub-tab-button active px-4 py-2 bg-white text-red-700 rounded-lg text-sm font-semibold border-2 border-red-500" onclick="selectSubCategory('condition', 'weight')">
                    ‰ΩìÈáç
                </button>
                <button class="sub-tab-button px-4 py-2 bg-white text-gray-700 rounded-lg text-sm font-semibold border-2 border-transparent hover:border-gray-300" onclick="selectSubCategory('condition', 'body_fat')">
                    ‰ΩìËÑÇËÇ™Áéá
                </button>
                <button class="sub-tab-button px-4 py-2 bg-white text-gray-700 rounded-lg text-sm font-semibold border-2 border-transparent hover:border-gray-300" onclick="selectSubCategory('condition', 'sleep')">
                    Áù°Áú†ÊôÇÈñì
                </button>
                <button class="sub-tab-button px-4 py-2 bg-white text-gray-700 rounded-lg text-sm font-semibold border-2 border-transparent hover:border-gray-300" onclick="selectSubCategory('condition', 'mood')">
                    Ê∞óÂàÜ
                </button>
                <button class="sub-tab-button px-4 py-2 bg-white text-gray-700 rounded-lg text-sm font-semibold border-2 border-transparent hover:border-gray-300" onclick="selectSubCategory('condition', 'energy')">
                    „Ç®„Éç„É´„ÇÆ„Éº
                </button>
            </div>

            <!-- Â∞è„Ç´„ÉÜ„Ç¥„É™„Çø„ÉñÔºà„Éë„Éï„Ç©„Éº„Éû„É≥„ÇπÔºâ -->
            <div id="performance-subtabs" class="sub-tabs flex flex-wrap gap-2 p-4 bg-purple-50 border-b">
                <button class="sub-tab-button active px-4 py-2 bg-white text-purple-700 rounded-lg text-sm font-semibold border-2 border-purple-500" onclick="selectSubCategory('performance', 'lbm')">
                    LBM
                </button>
                <button class="sub-tab-button px-4 py-2 bg-white text-gray-700 rounded-lg text-sm font-semibold border-2 border-transparent hover:border-gray-300" onclick="selectSubCategory('performance', 'directive')">
                    ÊåáÁ§∫Êõ∏ÈÅîÊàêÁä∂Ê≥Å
                </button>
                <button class="sub-tab-button px-4 py-2 bg-white text-gray-700 rounded-lg text-sm font-semibold border-2 border-transparent hover:border-gray-300" onclick="selectSubCategory('performance', 'overall')">
                    Á∑èÂêàÂàÜÊûê
                </button>
            </div>

            <!-- Ë©≥Á¥∞„Ç∞„É©„ÉïË°®Á§∫„Ç®„É™„Ç¢ -->
            <div class="p-6">
                <!-- „Ç∞„É©„Éï1Ôºà„É°„Ç§„É≥Ôºâ -->
                <div id="chart-1" class="chart-section mb-6">
                    <!-- „Ç≥„É≥„Éë„ÇØ„Éà„Éò„ÉÉ„ÉÄ„Éº -->
                    <div class="compact-header">
                        <div>
                            <h3 id="chart-title-1" class="text-2xl font-bold text-gray-800">üí™ LBMÔºàÈô§ËÑÇËÇ™‰ΩìÈáçÔºâ</h3>
                            <p id="chart-period-1" class="text-sm text-gray-500 mt-1">ÈÅéÂéª7Êó•Èñì„ÅÆÊé®Áßª</p>
                        </div>
                        <div class="compact-buttons">
                            <button onclick="toggleSettingsPanel(1)" class="bg-gray-100 hover:bg-gray-200 text-gray-700 flex items-center gap-1">
                                <i data-lucide="settings" class="w-4 h-4"></i>
                                <span class="hidden sm:inline">Ë®≠ÂÆö</span>
                            </button>
                            <button onclick="openGoalSettingModal()" class="bg-green-500 hover:bg-green-600 text-white flex items-center gap-1">
                                <i data-lucide="target" class="w-4 h-4"></i>
                            </button>
                            <button onclick="openHelpModal()" class="bg-blue-500 hover:bg-blue-600 text-white flex items-center gap-1">
                                <i data-lucide="help-circle" class="w-4 h-4"></i>
                            </button>
                            <button onclick="analyzeWithGemini()" class="bg-gradient-to-r from-purple-600 to-blue-600 hover:from-purple-700 hover:to-blue-700 text-white flex items-center gap-1">
                                <i data-lucide="sparkles" class="w-4 h-4"></i>
                                <span class="hidden sm:inline">AIÂàÜÊûê</span>
                            </button>
                        </div>
                    </div>

                    <!-- ÊúüÈñìÈÅ∏ÊäûÔºà„Çø„ÉñÂΩ¢ÂºèÔºâ -->
                    <div class="mb-4">
                        <div class="flex items-center gap-1 bg-gray-100 p-1 rounded-lg overflow-x-auto">
                            <button class="period-button active flex-1 px-3 py-2 rounded-md text-sm font-semibold bg-white text-purple-700 shadow-sm transition whitespace-nowrap" onclick="selectPeriod(1, 7)">7Êó•</button>
                            <button class="period-button flex-1 px-3 py-2 rounded-md text-sm font-semibold text-gray-600 hover:text-gray-900 transition whitespace-nowrap" onclick="selectPeriod(1, 14)">14Êó•</button>
                            <button class="period-button flex-1 px-3 py-2 rounded-md text-sm font-semibold text-gray-600 hover:text-gray-900 transition whitespace-nowrap" onclick="selectPeriod(1, 30)">30Êó•</button>
                            <button class="period-button flex-1 px-3 py-2 rounded-md text-sm font-semibold text-gray-600 hover:text-gray-900 transition whitespace-nowrap" onclick="selectPeriod(1, 60)">60Êó•</button>
                            <button class="period-button flex-1 px-3 py-2 rounded-md text-sm font-semibold text-gray-600 hover:text-gray-900 transition whitespace-nowrap" onclick="selectPeriod(1, 90)">90Êó•</button>
                            <button class="period-button flex-1 px-3 py-2 rounded-md text-sm font-semibold text-gray-600 hover:text-gray-900 transition whitespace-nowrap" onclick="selectPeriod(1, 180)">180Êó•</button>
                            <button class="period-button flex-1 px-3 py-2 rounded-md text-sm font-semibold text-gray-600 hover:text-gray-900 transition whitespace-nowrap" onclick="selectPeriod(1, 365)">365Êó•</button>
                        </div>
                    </div>

                    <!-- „Ç´„ÉÜ„Ç¥„É™Âà•ÁØÑÂõ≤Ë°®Á§∫ -->
                    <div class="mb-3 p-2 bg-gradient-to-r from-purple-50 to-blue-50 rounded-lg border border-purple-200">
                        <div class="flex items-center justify-between text-xs">
                            <span class="text-gray-600">ÂÖ®ÊúüÈñìÔºà90Êó•Ôºâ„ÅÆÁØÑÂõ≤:</span>
                            <span class="font-semibold text-gray-800">
                                <span class="text-orange-600" id="category-min-1">60.0</span>
                                <span class="text-gray-400 mx-1">ÔΩû</span>
                                <span class="text-green-600" id="category-max-1">63.0</span>
                                <span id="category-unit-1" class="text-gray-500 ml-1">kg</span>
                            </span>
                        </div>
                    </div>

                    <div style="height: 350px; position: relative;">
                        <canvas id="main-chart-1"></canvas>
                    </div>

                    <!-- „Ç≥„É≥„Éë„ÇØ„Éà„Å™Áµ±Ë®àÊÉÖÂ†±Ôºà1Ë°åÔºâ -->
                    <div class="stats-inline">
                        <div class="stat-item">
                            <div class="stat-value text-blue-600" id="stat-avg-1">62.0kg</div>
                            <div class="stat-label">Âπ≥Âùá<span id="stat-avg-unit-1" class="hidden"></span></div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value text-green-600" id="stat-max-1">62.5kg</div>
                            <div class="stat-label">ÊúÄÈ´ò<span id="stat-max-unit-1" class="hidden"></span></div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value text-orange-600" id="stat-min-1">61.0kg</div>
                            <div class="stat-label">ÊúÄ‰Ωé<span id="stat-min-unit-1" class="hidden"></span></div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value text-purple-600" id="chart-value-1">62.5kg</div>
                            <div class="stat-label">ÁèæÂú®<span id="chart-unit-1" class="hidden"></span></div>
                        </div>
                    </div>

                    <!-- ÊóßÁµ±Ë®àÊÉÖÂ†±„Ç≥„É≥„ÉÜ„ÉäÔºàÈùûË°®Á§∫Áî®„Éª‰∫íÊèõÊÄßÁ∂≠ÊåÅÔºâ -->
                    <div id="stats-container-1" class="hidden"></div>
                </div>

                <!-- „Ç∞„É©„Éï2ÔºàÊØîËºÉÁî®Ôºâ -->
                <div id="chart-2" class="chart-section hidden">
                    <div class="border-t-2 border-dashed border-gray-300 pt-6 mt-6">
                        <!-- „Ç≥„É≥„Éë„ÇØ„Éà„Éò„ÉÉ„ÉÄ„Éº -->
                        <div class="compact-header">
                            <div>
                                <h3 id="chart-title-2" class="text-2xl font-bold text-gray-800">üí™ LBMÔºàÈô§ËÑÇËÇ™‰ΩìÈáçÔºâ- ÊØîËºÉ</h3>
                                <p id="chart-period-2" class="text-sm text-gray-500 mt-1">ÈÅéÂéª30Êó•Èñì„ÅÆÊé®Áßª</p>
                            </div>
                        </div>

                        <!-- ÊúüÈñìÈÅ∏ÊäûÔºà„Çø„ÉñÂΩ¢ÂºèÔºâ -->
                        <div class="mb-4">
                            <div class="flex items-center gap-1 bg-gray-100 p-1 rounded-lg overflow-x-auto">
                                <button class="period-button flex-1 px-3 py-2 rounded-md text-sm font-semibold text-gray-600 hover:text-gray-900 transition whitespace-nowrap" onclick="selectPeriod(2, 7)">7Êó•</button>
                                <button class="period-button flex-1 px-3 py-2 rounded-md text-sm font-semibold text-gray-600 hover:text-gray-900 transition whitespace-nowrap" onclick="selectPeriod(2, 14)">14Êó•</button>
                                <button class="period-button active flex-1 px-3 py-2 rounded-md text-sm font-semibold bg-white text-blue-700 shadow-sm transition whitespace-nowrap" onclick="selectPeriod(2, 30)">30Êó•</button>
                                <button class="period-button flex-1 px-3 py-2 rounded-md text-sm font-semibold text-gray-600 hover:text-gray-900 transition whitespace-nowrap" onclick="selectPeriod(2, 60)">60Êó•</button>
                                <button class="period-button flex-1 px-3 py-2 rounded-md text-sm font-semibold text-gray-600 hover:text-gray-900 transition whitespace-nowrap" onclick="selectPeriod(2, 90)">90Êó•</button>
                                <button class="period-button flex-1 px-3 py-2 rounded-md text-sm font-semibold text-gray-600 hover:text-gray-900 transition whitespace-nowrap" onclick="selectPeriod(2, 180)">180Êó•</button>
                                <button class="period-button flex-1 px-3 py-2 rounded-md text-sm font-semibold text-gray-600 hover:text-gray-900 transition whitespace-nowrap" onclick="selectPeriod(2, 365)">365Êó•</button>
                            </div>
                        </div>

                        <!-- „Ç´„ÉÜ„Ç¥„É™Âà•ÁØÑÂõ≤Ë°®Á§∫ -->
                        <div class="mb-3 p-2 bg-gradient-to-r from-blue-50 to-cyan-50 rounded-lg border border-blue-200">
                            <div class="flex items-center justify-between text-xs">
                                <span class="text-gray-600">ÂÖ®ÊúüÈñìÔºà90Êó•Ôºâ„ÅÆÁØÑÂõ≤:</span>
                                <span class="font-semibold text-gray-800">
                                    <span class="text-orange-600" id="category-min-2">60.0</span>
                                    <span class="text-gray-400 mx-1">ÔΩû</span>
                                    <span class="text-green-600" id="category-max-2">63.0</span>
                                    <span id="category-unit-2" class="text-gray-500 ml-1">kg</span>
                                </span>
                            </div>
                        </div>

                        <div style="height: 350px; position: relative;">
                            <canvas id="main-chart-2"></canvas>
                        </div>

                        <!-- „Ç≥„É≥„Éë„ÇØ„Éà„Å™Áµ±Ë®àÊÉÖÂ†±Ôºà1Ë°åÔºâ -->
                        <div class="stats-inline">
                            <div class="stat-item">
                                <div class="stat-value text-blue-600" id="stat-avg-2">61.5kg</div>
                                <div class="stat-label">Âπ≥Âùá<span id="stat-avg-unit-2" class="hidden"></span></div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value text-green-600" id="stat-max-2">62.5kg</div>
                                <div class="stat-label">ÊúÄÈ´ò<span id="stat-max-unit-2" class="hidden"></span></div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value text-orange-600" id="stat-min-2">60.0kg</div>
                                <div class="stat-label">ÊúÄ‰Ωé<span id="stat-min-unit-2" class="hidden"></span></div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value text-purple-600" id="chart-value-2">62.5kg</div>
                                <div class="stat-label">ÁèæÂú®<span id="chart-unit-2" class="hidden"></span></div>
                            </div>
                        </div>

                        <!-- ÊóßÁµ±Ë®àÊÉÖÂ†±„Ç≥„É≥„ÉÜ„ÉäÔºàÈùûË°®Á§∫Áî®„Éª‰∫íÊèõÊÄßÁ∂≠ÊåÅÔºâ -->
                        <div id="stats-container-2" class="hidden"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- AIÂàÜÊûêÁµêÊûú„É¢„Éº„ÉÄ„É´ -->
        <div id="ai-analysis-modal" class="modal">
            <div class="modal-content">
                <div class="sticky top-0 bg-gradient-to-r from-purple-600 to-blue-600 text-white p-4 rounded-t-lg">
                    <div class="flex justify-between items-center">
                        <div class="flex items-center gap-2">
                            <i data-lucide="sparkles" class="w-5 h-5"></i>
                            <h3 class="text-lg font-bold">AI „Ç∞„É©„ÉïÂàÜÊûê</h3>
                        </div>
                        <button onclick="closeAnalysisModal()" class="p-1 hover:bg-white/20 rounded">
                            <i data-lucide="x" class="w-5 h-5"></i>
                        </button>
                    </div>
                </div>
                <div id="analysis-content" class="p-6">
                    <div class="ai-analyzing">
                        <div class="spinner"></div>
                        <span class="text-gray-600">ÂàÜÊûê‰∏≠...</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- „Éò„É´„Éó„É¢„Éº„ÉÄ„É´ -->
        <div id="help-modal" class="help-modal">
            <div class="help-content">
                <div class="sticky top-0 bg-gradient-to-r from-blue-600 to-cyan-600 text-white p-4 rounded-t-lg">
                    <div class="flex justify-between items-center">
                        <div class="flex items-center gap-2">
                            <i data-lucide="help-circle" class="w-5 h-5"></i>
                            <h3 class="text-lg font-bold">Â±•Ê≠¥„Ç∞„É©„Éï„ÅÆ‰Ωø„ÅÑÊñπ</h3>
                        </div>
                        <button onclick="closeHelpModal()" class="p-1 hover:bg-white/20 rounded">
                            <i data-lucide="x" class="w-5 h-5"></i>
                        </button>
                    </div>
                </div>
                <div class="p-6">
                    <div class="space-y-6">
                        <!-- Âü∫Êú¨Êìç‰Ωú -->
                        <div>
                            <h4 class="text-lg font-bold text-gray-800 mb-3 flex items-center gap-2">
                                <i data-lucide="mouse-pointer-click" class="w-5 h-5 text-blue-600"></i>
                                Âü∫Êú¨Êìç‰Ωú
                            </h4>
                            <ul class="space-y-2 text-sm text-gray-700">
                                <li class="flex items-start gap-2">
                                    <span class="text-blue-600 font-bold">1.</span>
                                    <span><strong>„Ç´„ÉÜ„Ç¥„É™„Çø„Éñ</strong>: È£ü‰∫ã„ÉªÈÅãÂãï„Éª„Ç≥„É≥„Éá„Ç£„Ç∑„Éß„É≥„Éª„Éë„Éï„Ç©„Éº„Éû„É≥„Çπ„ÇíÂàá„ÇäÊõø„Åà</span>
                                </li>
                                <li class="flex items-start gap-2">
                                    <span class="text-blue-600 font-bold">2.</span>
                                    <span><strong>„Çµ„Éñ„Ç´„ÉÜ„Ç¥„É™„Çø„Éñ</strong>: ÂêÑ„Ç´„ÉÜ„Ç¥„É™ÂÜÖ„ÅÆË©≥Á¥∞ÊåáÊ®ô„ÇíÈÅ∏Êäû</span>
                                </li>
                                <li class="flex items-start gap-2">
                                    <span class="text-blue-600 font-bold">3.</span>
                                    <span><strong>ÊúüÈñì„Éú„Çø„É≥</strong>: 7Êó•Èñì/14Êó•Èñì/30Êó•Èñì/90Êó•Èñì„Åã„ÇâË°®Á§∫ÊúüÈñì„ÇíÈÅ∏Êäû</span>
                                </li>
                            </ul>
                        </div>

                        <!-- ÊØîËºÉ„É¢„Éº„Éâ -->
                        <div class="bg-blue-50 p-4 rounded-lg border border-blue-200">
                            <h4 class="text-lg font-bold text-gray-800 mb-3 flex items-center gap-2">
                                <i data-lucide="columns-2" class="w-5 h-5 text-blue-600"></i>
                                ÊØîËºÉ„É¢„Éº„Éâ
                            </h4>
                            <p class="text-sm text-gray-700 mb-3">
                                2„Å§„ÅÆ„Ç∞„É©„Éï„ÇíÂêåÊôÇ„Å´Ë°®Á§∫„Åó„ÄÅÁï∞„Å™„ÇãÊúüÈñì„ÇíÊØîËºÉ„Åß„Åç„Åæ„Åô„ÄÇ
                            </p>
                            <ul class="space-y-2 text-sm text-gray-700">
                                <li class="flex items-start gap-2">
                                    <span class="text-blue-600">‚Ä¢</span>
                                    <span>‰æã: ‰∏ä„ÅÆ„Ç∞„É©„Éï„Åß„Äå7Êó•Èñì„Äç„ÄÅ‰∏ã„ÅÆ„Ç∞„É©„Éï„Åß„Äå30Êó•Èñì„Äç„ÇíÈÅ∏Êäû„Åó„Å¶Áü≠Êúü„Å®Èï∑Êúü„ÇíÊØîËºÉ</span>
                                </li>
                                <li class="flex items-start gap-2">
                                    <span class="text-blue-600">‚Ä¢</span>
                                    <span>‰∏ä„ÅÆ„Ç∞„É©„Éï„ÅßÈÅ∏Êäû„Åó„ÅüÊúüÈñì„ÅØ„ÄÅ‰∏ã„ÅÆ„Ç∞„É©„Éï„ÅßÈÅ∏Êäû„Åß„Åç„Åæ„Åõ„ÇìÔºàÈáçË§áÈò≤Ê≠¢Ôºâ</span>
                                </li>
                            </ul>
                        </div>

                        <!-- YËª∏ÈÄ£Âãï -->
                        <div class="bg-purple-50 p-4 rounded-lg border border-purple-200">
                            <h4 class="text-lg font-bold text-gray-800 mb-3 flex items-center gap-2">
                                <i data-lucide="refresh-cw" class="w-5 h-5 text-purple-600"></i>
                                YËª∏ÈÄ£ÂãïÊ©üËÉΩ
                            </h4>
                            <p class="text-sm text-gray-700 mb-3">
                                ‰∏ä„ÅÆ„Ç∞„É©„Éï„ÅÆYËª∏ÁØÑÂõ≤„ÇíÂ§âÊõ¥„Åô„Çã„Å®„ÄÅ‰∏ã„ÅÆ„Ç∞„É©„Éï„ÇÇËá™Âãï„ÅßÂêå„ÅòÁØÑÂõ≤„Å´Ë™øÊï¥„Åï„Çå„Åæ„Åô„ÄÇ
                            </p>
                            <ul class="space-y-2 text-sm text-gray-700">
                                <li class="flex items-start gap-2">
                                    <span class="text-purple-600">‚Ä¢</span>
                                    <span><strong>ON„ÅÆÂ†¥Âêà</strong>: ‰∏ä‰∏ã„ÅÆ„Ç∞„É©„Éï„ÅßÂêå„Åò„Çπ„Ç±„Éº„É´„Çí‰ΩøÁî®ÔºàÊØîËºÉ„Åó„ÇÑ„Åô„ÅÑÔºâ</span>
                                </li>
                                <li class="flex items-start gap-2">
                                    <span class="text-purple-600">‚Ä¢</span>
                                    <span><strong>OFF„ÅÆÂ†¥Âêà</strong>: ‰∏ä‰∏ã„ÅÆ„Ç∞„É©„Éï„ÅßÁã¨Á´ã„Åó„Åü„Çπ„Ç±„Éº„É´„Çí‰ΩøÁî®</span>
                                </li>
                                <li class="flex items-start gap-2">
                                    <span class="text-purple-600">‚Ä¢</span>
                                    <span>„ÉÅ„Çß„ÉÉ„ÇØ„Éú„ÉÉ„ÇØ„Çπ„Çí„ÇØ„É™„ÉÉ„ÇØ„ÅßON/OFFÂàá„ÇäÊõø„ÅàÂèØËÉΩ</span>
                                </li>
                            </ul>
                        </div>

                        <!-- YËª∏ÁØÑÂõ≤Ë™øÊï¥ -->
                        <div>
                            <h4 class="text-lg font-bold text-gray-800 mb-3 flex items-center gap-2">
                                <i data-lucide="sliders-horizontal" class="w-5 h-5 text-green-600"></i>
                                YËª∏ÁØÑÂõ≤„ÅÆË™øÊï¥
                            </h4>
                            <ul class="space-y-2 text-sm text-gray-700">
                                <li class="flex items-start gap-2">
                                    <span class="text-green-600">‚Ä¢</span>
                                    <span><strong>„Éá„Éï„Ç©„É´„Éà</strong>: ÂÖ®ÊúüÈñìÔºà90Êó•ÈñìÔºâ„ÅÆÊúÄ‰ΩéÂÄ§ÔΩûÊúÄÈ´òÂÄ§„ÇíÂü∫Ê∫ñ„Å´Ëá™ÂãïË®≠ÂÆö</span>
                                </li>
                                <li class="flex items-start gap-2">
                                    <span class="text-green-600">‚Ä¢</span>
                                    <span><strong>ÊâãÂãïË™øÊï¥</strong>: „ÄåÊúÄÂ∞èÂÄ§„Äç„ÄåÊúÄÂ§ßÂÄ§„Äç„ÅÆÂÖ•ÂäõÊ¨Ñ„Å´Êï∞ÂÄ§„ÇíÂÖ•Âäõ„Åó„Å¶Ë°®Á§∫ÁØÑÂõ≤„ÇíÂ§âÊõ¥</span>
                                </li>
                                <li class="flex items-start gap-2">
                                    <span class="text-green-600">‚Ä¢</span>
                                    <span><strong>ÂàùÊúüÂÄ§„Å´Êàª„Åô</strong>: „Éú„Çø„É≥„Çí„ÇØ„É™„ÉÉ„ÇØ„Åß„Éá„Éï„Ç©„É´„Éà„ÅÆÁØÑÂõ≤„Å´Êàª„Åô</span>
                                </li>
                            </ul>
                        </div>

                        <!-- AIÂàÜÊûê -->
                        <div class="bg-gradient-to-r from-purple-50 to-blue-50 p-4 rounded-lg border border-purple-200">
                            <h4 class="text-lg font-bold text-gray-800 mb-3 flex items-center gap-2">
                                <i data-lucide="sparkles" class="w-5 h-5 text-purple-600"></i>
                                AIÂàÜÊûêÊ©üËÉΩ
                            </h4>
                            <p class="text-sm text-gray-700 mb-3">
                                Gemini AI„Åå„Ç∞„É©„Éï„Éá„Éº„Çø„ÇíÂàÜÊûê„Åó„ÄÅ„Éà„É¨„É≥„ÉâË©ï‰æ°„ÉªÊîπÂñÑÊèêÊ°à„ÇíÁîüÊàê„Åó„Åæ„Åô„ÄÇ
                            </p>
                            <ul class="space-y-2 text-sm text-gray-700">
                                <li class="flex items-start gap-2">
                                    <span class="text-purple-600">‚Ä¢</span>
                                    <span><strong>„Éà„É¨„É≥„ÉâÂàÜÊûê</strong>: Â¢óÂä†/Ê∏õÂ∞ë/Ê®™„Å∞„ÅÑ„ÇíÂà§ÂÆö„ÅóÁêÜÁî±„ÇíË™¨Êòé</span>
                                </li>
                                <li class="flex items-start gap-2">
                                    <span class="text-purple-600">‚Ä¢</span>
                                    <span><strong>ÁõÆÊ®ôÈÅîÊàê‰∫àÊ∏¨</strong>: ÁèæÂú®„ÅÆ„Éö„Éº„Çπ„ÅßÁõÆÊ®ôÈÅîÊàê„Åæ„Åß„ÅÆÊó•Êï∞„Çí‰∫àÊ∏¨</span>
                                </li>
                                <li class="flex items-start gap-2">
                                    <span class="text-purple-600">‚Ä¢</span>
                                    <span><strong>ÊîπÂñÑÊèêÊ°à</strong>: ÂÖ∑‰ΩìÁöÑ„Å™„Ç¢„ÇØ„Ç∑„Éß„É≥ÔºàÈ£ü‰∫ã/ÈÅãÂãï/‰ºëÈ§äÔºâ„Çí3„Å§ÊèêÁ§∫</span>
                                </li>
                                <li class="flex items-start gap-2">
                                    <span class="text-purple-600">‚Ä¢</span>
                                    <span><strong>Ê≥®ÊÑèÁÇπ</strong>: „Éá„Éº„Çø„Åã„ÇâÊ∞ó„Çí„Å§„Åë„Çã„Åπ„Åç„Éù„Ç§„É≥„Éà„ÇíÊäΩÂá∫</span>
                                </li>
                            </ul>
                        </div>

                        <!-- Áµ±Ë®àÊÉÖÂ†± -->
                        <div>
                            <h4 class="text-lg font-bold text-gray-800 mb-3 flex items-center gap-2">
                                <i data-lucide="bar-chart-3" class="w-5 h-5 text-orange-600"></i>
                                Áµ±Ë®àÊÉÖÂ†±„ÅÆË¶ãÊñπ
                            </h4>
                            <ul class="space-y-2 text-sm text-gray-700">
                                <li class="flex items-start gap-2">
                                    <span class="text-blue-600">‚Ä¢</span>
                                    <span><strong>Âπ≥Âùá</strong>: ÈÅ∏ÊäûÊúüÈñìÂÜÖ„ÅÆÂπ≥ÂùáÂÄ§</span>
                                </li>
                                <li class="flex items-start gap-2">
                                    <span class="text-green-600">‚Ä¢</span>
                                    <span><strong>ÊúÄÈ´ò</strong>: ÈÅ∏ÊäûÊúüÈñìÂÜÖ„ÅÆÊúÄÈ´òÂÄ§</span>
                                </li>
                                <li class="flex items-start gap-2">
                                    <span class="text-orange-600">‚Ä¢</span>
                                    <span><strong>ÊúÄ‰Ωé</strong>: ÈÅ∏ÊäûÊúüÈñìÂÜÖ„ÅÆÊúÄ‰ΩéÂÄ§</span>
                                </li>
                                <li class="flex items-start gap-2">
                                    <span class="text-purple-600">‚Ä¢</span>
                                    <span><strong>ÊåáÁ§∫Êõ∏ÈÅîÊàêÁä∂Ê≥Å</strong>: ÈÅîÊàêÁéáÔºà%Ôºâ„ÄÅÂÆå‰∫ÜÊó•Êï∞„ÄÅÊú™ÂÆå‰∫ÜÊó•Êï∞„ÇíË°®Á§∫</span>
                                </li>
                            </ul>
                        </div>

                        <!-- „Éá„Éº„Çø‰øùÂ≠òÔºà„Çπ„ÇØ„É™„Éº„É≥„Ç∑„Éß„ÉÉ„ÉàÊé®Â•®Ôºâ -->
                        <div class="bg-green-50 p-4 rounded-lg border border-green-200">
                            <h4 class="text-lg font-bold text-gray-800 mb-3 flex items-center gap-2">
                                <i data-lucide="camera" class="w-5 h-5 text-green-600"></i>
                                „Éá„Éº„Çø‰øùÂ≠òÊñπÊ≥ï
                            </h4>
                            <p class="text-sm text-gray-700 mb-3">
                                „Ç∞„É©„Éï„Çí„Çπ„ÇØ„É™„Éº„É≥„Ç∑„Éß„ÉÉ„Éà„Åß‰øùÂ≠ò„Åô„Çã„Åì„Å®„ÇíÊé®Â•®„Åó„Åæ„ÅôÔºö
                            </p>
                            <ul class="space-y-2 text-sm text-gray-700">
                                <li class="flex items-start gap-2">
                                    <span class="text-green-600">üì∏</span>
                                    <span><strong>Windows</strong>: Win + Shift + SÔºàÁîªÈù¢„ÅÆ‰∏ÄÈÉ®„ÇíÈÅ∏ÊäûÔºâ</span>
                                </li>
                                <li class="flex items-start gap-2">
                                    <span class="text-green-600">üì∏</span>
                                    <span><strong>Mac</strong>: Cmd + Shift + 4ÔºàÁîªÈù¢„ÅÆ‰∏ÄÈÉ®„ÇíÈÅ∏ÊäûÔºâ</span>
                                </li>
                                <li class="flex items-start gap-2">
                                    <span class="text-green-600">üì∏</span>
                                    <span><strong>„Éñ„É©„Ç¶„Ç∂</strong>: Âè≥„ÇØ„É™„ÉÉ„ÇØ ‚Üí „Äå„Éö„Éº„Ç∏„ÅÆ„Çπ„ÇØ„É™„Éº„É≥„Ç∑„Éß„ÉÉ„Éà„ÇíÊíÆ„Çã„ÄçÔºàFirefoxÔºâ</span>
                                </li>
                            </ul>
                        </div>

                        <!-- Êñ∞Ê©üËÉΩÔºàÁßªÂãïÂπ≥Âùá„ÉªÈáç„Å≠Âêà„Çè„ÅõÔºâ -->
                        <div class="bg-gradient-to-r from-orange-50 to-yellow-50 p-4 rounded-lg border border-orange-200">
                            <h4 class="text-lg font-bold text-gray-800 mb-3 flex items-center gap-2">
                                <i data-lucide="sparkles" class="w-5 h-5 text-orange-600"></i>
                                Êñ∞Ê©üËÉΩ
                            </h4>
                            <ul class="space-y-2 text-sm text-gray-700">
                                <li class="flex items-start gap-2 bg-white p-2 rounded">
                                    <span class="text-orange-600 font-bold">NEW</span>
                                    <div>
                                        <strong>ÁßªÂãïÂπ≥ÂùáÁ∑ö</strong>
                                        <p class="text-xs text-gray-600 mt-1">‰∏ÄÂÆöÊúüÈñì„ÅÆÂπ≥ÂùáÂÄ§„ÇíÁ∑ö„ÅßË°®Á§∫„Åó„ÄÅ„Éé„Ç§„Ç∫„ÇíÈô§Âéª„Åó„Å¶„Éà„É¨„É≥„Éâ„ÇíÊòéÁ¢∫„Å´ÊääÊè°„Åß„Åç„Åæ„Åô„ÄÇ3Êó•/5Êó•/7Êó•/14Êó•/30Êó•„Åã„ÇâÈÅ∏ÊäûÂèØËÉΩ„ÄÇ</p>
                                    </div>
                                </li>
                                <li class="flex items-start gap-2 bg-white p-2 rounded">
                                    <span class="text-orange-600 font-bold">NEW</span>
                                    <div>
                                        <strong>Ë§áÊï∞ÊåáÊ®ô„ÅÆÈáç„Å≠Âêà„Çè„Åõ</strong>
                                        <p class="text-xs text-gray-600 mt-1">ÊúÄÂ§ß3„Å§„ÅÆÊåáÊ®ô„Çí1„Å§„ÅÆ„Ç∞„É©„Éï„Å´Ë°®Á§∫„Åó„ÄÅÁõ∏Èñ¢Èñ¢‰øÇ„ÇíÂàÜÊûê„Åß„Åç„Åæ„Åô„ÄÇ‰æã: LBM„Å®Á∑èÂêà„Çπ„Ç≥„Ç¢„ÅÆÈñ¢‰øÇ„ÇíÁ¢∫Ë™ç„ÄÇ</p>
                                    </div>
                                </li>
                                <li class="flex items-start gap-2 bg-white p-2 rounded">
                                    <span class="text-green-600 font-bold">Âº∑Âåñ</span>
                                    <div>
                                        <strong>ÁõÆÊ®ô„É©„Ç§„É≥Ë°®Á§∫</strong>
                                        <p class="text-xs text-gray-600 mt-1">ÂêÑÊåáÊ®ô„Å´ÁõÆÊ®ôÂÄ§„ÇíË®≠ÂÆö„Åô„Çã„Å®„ÄÅ„Ç∞„É©„Éï„Å´Á∑ëËâ≤„ÅÆÁÇπÁ∑ö„ÅßË°®Á§∫„Åï„Çå„Åæ„Åô„ÄÇÈÅîÊàêÂ∫¶„Åå‰∏ÄÁõÆÁû≠ÁÑ∂„ÄÇ</p>
                                    </div>
                                </li>
                                <li class="flex items-start gap-2 bg-white p-2 rounded">
                                    <span class="text-green-600 font-bold">Âº∑Âåñ</span>
                                    <div>
                                        <strong>„É°„É¢Ê©üËÉΩ</strong>
                                        <p class="text-xs text-gray-600 mt-1">„Ç∞„É©„Éï‰∏ä„ÅÆ„Éù„Ç§„É≥„Éà„Çí„ÇØ„É™„ÉÉ„ÇØ„Åó„Å¶„É°„É¢„ÇíËøΩÂä†„ÄÇ„ÉÅ„Éº„Éà„Éá„Ç§„ÄÅ‰ΩìË™ø‰∏çËâØ„Å™„Å©„ÇíË®òÈå≤„Åó„ÄÅ„Éá„Éº„Çø„Å®„ÅÆÁõ∏Èñ¢„ÇíÁ¢∫Ë™ç„Åß„Åç„Åæ„Åô„ÄÇ</p>
                                    </div>
                                </li>
                            </ul>
                        </div>

                        <!-- „Éí„É≥„Éà -->
                        <div class="bg-yellow-50 p-4 rounded-lg border border-yellow-200">
                            <h4 class="text-lg font-bold text-gray-800 mb-3 flex items-center gap-2">
                                <i data-lucide="lightbulb" class="w-5 h-5 text-yellow-600"></i>
                                Ê¥ªÁî®„Éí„É≥„Éà
                            </h4>
                            <ul class="space-y-2 text-sm text-gray-700">
                                <li class="flex items-start gap-2">
                                    <span class="text-yellow-600">üí°</span>
                                    <span>Áü≠ÊúüÔºà7Êó•ÈñìÔºâ„ÅßÁ¥∞„Åã„ÅÑÂ§âÂåñ„ÇíÁ¢∫Ë™ç„Åó„ÄÅÈï∑ÊúüÔºà30-90Êó•ÈñìÔºâ„ÅßÂÖ®‰ΩìÁöÑ„Å™„Éà„É¨„É≥„Éâ„ÇíÊääÊè°„Åó„Åæ„Åó„Çá„ÅÜ</span>
                                </li>
                                <li class="flex items-start gap-2">
                                    <span class="text-yellow-600">üí°</span>
                                    <span>ÊØîËºÉ„É¢„Éº„Éâ„ÅßÁü≠Êúü„Å®Èï∑Êúü„Çí‰∏¶„Åπ„Å¶Ë°®Á§∫„Åô„Çã„Å®„ÄÅ‰∏ÄÊôÇÁöÑ„Å™Â§âÂãï„Å®Êú¨ÂΩì„ÅÆ„Éà„É¨„É≥„Éâ„ÇíÂå∫Âà•„Åß„Åç„Åæ„Åô</span>
                                </li>
                                <li class="flex items-start gap-2">
                                    <span class="text-yellow-600">üí°</span>
                                    <span>YËª∏ÁØÑÂõ≤„ÇíË™øÊï¥„Åô„Çã„Åì„Å®„Åß„ÄÅÂ∞è„Åï„Å™Â§âÂåñ„ÇÇÂ§ß„Åç„ÅèË°®Á§∫„Åß„Åç„ÄÅÂæÆÁ¥∞„Å™„Éà„É¨„É≥„Éâ„ÇíÁô∫Ë¶ã„Åß„Åç„Åæ„Åô</span>
                                </li>
                                <li class="flex items-start gap-2">
                                    <span class="text-yellow-600">üí°</span>
                                    <span>ÁßªÂãïÂπ≥ÂùáÁ∑öÔºà7Êó•Ôºâ„ÇíË°®Á§∫„Åô„Çã„Å®„ÄÅÊó•„ÄÖ„ÅÆÂ§âÂãï„Å´ÊÉë„Çè„Åï„Çå„Åö„ÄÅÊú¨ÂΩì„ÅÆ„Éà„É¨„É≥„Éâ„ÅåË¶ã„Åà„Å¶„Åç„Åæ„Åô</span>
                                </li>
                                <li class="flex items-start gap-2">
                                    <span class="text-yellow-600">üí°</span>
                                    <span>Ë§áÊï∞ÊåáÊ®ô„ÇíÈáç„Å≠Âêà„Çè„Åõ„Å¶„ÄÅÂõ†ÊûúÈñ¢‰øÇ„ÇíÁô∫Ë¶ã„Åó„Åæ„Åó„Çá„ÅÜÔºà‰æã: ‰ΩìÈáç„Å®„Ç´„É≠„É™„Éº„ÅÆÈñ¢‰øÇÔºâ</span>
                                </li>
                                <li class="flex items-start gap-2">
                                    <span class="text-yellow-600">üí°</span>
                                    <span>AIÂàÜÊûê„ÅØÂÆöÊúüÁöÑ„Å´ÂÆüË°å„Åó„ÄÅÂÆ¢Ë¶≥ÁöÑ„Å™„Éï„Ç£„Éº„Éâ„Éê„ÉÉ„ÇØ„ÇíÂèó„Åë„Çã„Åì„Å®„ÅßÊîπÂñÑ„Å´„Å§„Å™„Åí„Åæ„Åó„Çá„ÅÜ</span>
                                </li>
                                <li class="flex items-start gap-2">
                                    <span class="text-yellow-600">üí°</span>
                                    <span>„Ç∞„É©„Éï„Å´„É°„É¢ÔºàüìùÔºâ„ÇíËøΩÂä†„Åó„Å¶„ÄÅÁâπÂà•„Å™Êó•Ôºà„ÉÅ„Éº„Éà„Éá„Ç§„ÄÅÈ¢®ÈÇ™„Å™„Å©Ôºâ„ÇíË®òÈå≤„Åß„Åç„Åæ„Åô</span>
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- „ÉÑ„Éº„É´„ÉÅ„ÉÉ„Éó -->
        <div id="tooltip" class="tooltip"></div>

        <!-- „Éï„É≠„Éº„ÉÜ„Ç£„É≥„Ç∞Ë®≠ÂÆö„Éë„Éç„É´ -->
        <div id="settings-panel" class="floating-panel hidden">
            <div class="sticky top-0 bg-gradient-to-r from-gray-700 to-gray-600 text-white p-4 rounded-t-xl">
                <div class="flex justify-between items-center">
                    <div class="flex items-center gap-2">
                        <i data-lucide="settings" class="w-5 h-5"></i>
                        <h3 class="text-lg font-bold">„Ç∞„É©„ÉïË®≠ÂÆö</h3>
                    </div>
                    <button onclick="closeSettingsPanel()" class="p-1 hover:bg-white/20 rounded">
                        <i data-lucide="x" class="w-5 h-5"></i>
                    </button>
                </div>
            </div>

            <div class="p-4 space-y-6">
                <!-- „Ç´„Çπ„Çø„É†ÊúüÈñìË®≠ÂÆö -->
                <div>
                    <h4 class="font-bold text-gray-800 mb-3 flex items-center gap-2">
                        <i data-lucide="calendar" class="w-4 h-4 text-indigo-600"></i>
                        „Ç´„Çπ„Çø„É†ÊúüÈñì
                    </h4>
                    <div class="space-y-2">
                        <div>
                            <label class="text-xs text-gray-600 block mb-1">ÈñãÂßãÊó•</label>
                            <input type="text" id="custom-start-panel" placeholder="ÈñãÂßãÊó•„ÇíÈÅ∏Êäû" class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                        </div>
                        <div>
                            <label class="text-xs text-gray-600 block mb-1">ÁµÇ‰∫ÜÊó•</label>
                            <input type="text" id="custom-end-panel" placeholder="ÁµÇ‰∫ÜÊó•„ÇíÈÅ∏Êäû" class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                        </div>
                        <button onclick="applyCustomPeriodFromPanel()" class="w-full px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition font-semibold text-sm">
                            ÈÅ©Áî®
                        </button>
                    </div>
                </div>

                <!-- YËª∏ÁØÑÂõ≤Ë®≠ÂÆö -->
                <div>
                    <h4 class="font-bold text-gray-800 mb-3 flex items-center gap-2">
                        <i data-lucide="sliders-horizontal" class="w-4 h-4 text-green-600"></i>
                        YËª∏ÁØÑÂõ≤
                    </h4>
                    <div class="space-y-2">
                        <div>
                            <label class="text-xs text-gray-600 block mb-1">ÊúÄÂ∞èÂÄ§</label>
                            <input type="number" id="axis-min-panel" step="0.1" class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent" onchange="updateAxisRangeFromPanel()">
                        </div>
                        <div>
                            <label class="text-xs text-gray-600 block mb-1">ÊúÄÂ§ßÂÄ§</label>
                            <input type="number" id="axis-max-panel" step="0.1" class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent" onchange="updateAxisRangeFromPanel()">
                        </div>
                        <button onclick="resetAxisRangeFromPanel()" class="w-full px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition font-semibold text-sm">
                            ÂàùÊúüÂÄ§„Å´Êàª„Åô
                        </button>
                    </div>
                </div>

                <!-- Ë°®Á§∫„Ç™„Éó„Ç∑„Éß„É≥ -->
                <div>
                    <h4 class="font-bold text-gray-800 mb-3 flex items-center gap-2">
                        <i data-lucide="eye" class="w-4 h-4 text-purple-600"></i>
                        Ë°®Á§∫„Ç™„Éó„Ç∑„Éß„É≥
                    </h4>
                    <div class="space-y-3">
                        <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                            <div class="flex items-center gap-2">
                                <i data-lucide="columns-2" class="w-4 h-4 text-blue-600"></i>
                                <label for="comparison-mode-panel" class="text-sm font-semibold text-gray-700">ÊØîËºÉ„É¢„Éº„Éâ</label>
                            </div>
                            <input type="checkbox" id="comparison-mode-panel" class="w-4 h-4" onchange="toggleComparisonMode()">
                        </div>
                        <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                            <div class="flex items-center gap-2">
                                <i data-lucide="refresh-cw" class="w-4 h-4 text-purple-600"></i>
                                <label for="sync-axis-panel" class="text-sm font-semibold text-gray-700">YËª∏ÈÄ£Âãï</label>
                            </div>
                            <input type="checkbox" id="sync-axis-panel" class="w-4 h-4" checked onchange="toggleAxisSync()">
                        </div>
                        <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                            <div class="flex items-center gap-2">
                                <i data-lucide="trending-up" class="w-4 h-4 text-orange-600"></i>
                                <label for="moving-average-panel" class="text-sm font-semibold text-gray-700">ÁßªÂãïÂπ≥ÂùáÁ∑ö</label>
                            </div>
                            <input type="checkbox" id="moving-average-panel" class="w-4 h-4" onchange="toggleMovingAverage(1)">
                        </div>
                        <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                            <div class="flex items-center gap-2">
                                <i data-lucide="arrow-right" class="w-4 h-4 text-green-600"></i>
                                <label for="prediction-panel" class="text-sm font-semibold text-gray-700">‰∫àÊ∏¨Á∑öÔºà7Êó•ÂÖàÔºâ</label>
                            </div>
                            <input type="checkbox" id="prediction-panel" class="w-4 h-4" onchange="togglePrediction(1)">
                        </div>
                    </div>
                </div>

                <!-- ÁßªÂãïÂπ≥ÂùáÊúüÈñì -->
                <div>
                    <h4 class="font-bold text-gray-800 mb-3 flex items-center gap-2">
                        <i data-lucide="calendar" class="w-4 h-4 text-indigo-600"></i>
                        ÁßªÂãïÂπ≥ÂùáÊúüÈñì
                    </h4>
                    <div class="space-y-2">
                        <select id="ma-period-panel" onchange="changeMovingAveragePeriod(1, this.value)" class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                            <option value="3">3Êó•</option>
                            <option value="5">5Êó•</option>
                            <option value="7" selected>7Êó•</option>
                            <option value="14">14Êó•</option>
                            <option value="30">30Êó•</option>
                        </select>
                    </div>
                </div>

                <!-- ‰∏ã„Ç∞„É©„Éï„ÅÆ„Ç´„ÉÜ„Ç¥„É™ÈÅ∏Êäû -->
                <div>
                    <h4 class="font-bold text-gray-800 mb-3 flex items-center gap-2">
                        <i data-lucide="bar-chart-2" class="w-4 h-4 text-blue-600"></i>
                        ‰∏ã„Ç∞„É©„Éï„ÅÆ„Ç´„ÉÜ„Ç¥„É™
                    </h4>
                    <div class="space-y-2">
                        <select id="chart2-category-panel" onchange="changeChart2Category(this.value)" class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            <option value="lbm" selected>üí™ LBMÔºàÈô§ËÑÇËÇ™‰ΩìÈáçÔºâ</option>
                            <option value="directive">üìã ÊåáÁ§∫Êõ∏ÈÅîÊàêÁä∂Ê≥Å</option>
                            <option value="overall">üéØ Á∑èÂêàÂàÜÊûê„Çπ„Ç≥„Ç¢</option>
                        </select>
                        <p class="text-xs text-gray-500">ÊØîËºÉ„É¢„Éº„ÉâONÊôÇ„ÄÅ‰∏ä„Ç∞„É©„Éï„Å®Áï∞„Å™„ÇãÊåáÊ®ô„ÇíË°®Á§∫„Åß„Åç„Åæ„Åô</p>
                    </div>
                </div>

                <!-- „Éò„É´„Éó„É™„É≥„ÇØ -->
                <div class="pt-4 border-t border-gray-200">
                    <button onclick="openHelpModal(); closeSettingsPanel();" class="w-full flex items-center justify-center gap-2 px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition font-semibold text-sm">
                        <i data-lucide="help-circle" class="w-4 h-4"></i>
                        ‰Ωø„ÅÑÊñπ„ÇíË¶ã„Çã
                    </button>
                </div>
            </div>
        </div>

        <!-- ÁõÆÊ®ôË®≠ÂÆö„É¢„Éº„ÉÄ„É´ -->
        <div id="goal-setting-modal" class="modal">
            <div class="modal-content">
                <div class="sticky top-0 bg-gradient-to-r from-green-600 to-teal-600 text-white p-4 rounded-t-lg">
                    <div class="flex justify-between items-center">
                        <div class="flex items-center gap-2">
                            <i data-lucide="target" class="w-5 h-5"></i>
                            <h3 class="text-lg font-bold">ÁõÆÊ®ôË®≠ÂÆö</h3>
                        </div>
                        <button onclick="closeGoalSettingModal()" class="p-1 hover:bg-white/20 rounded">
                            <i data-lucide="x" class="w-5 h-5"></i>
                        </button>
                    </div>
                </div>
                <div class="p-6">
                    <div class="space-y-4">
                        <!-- ÊåáÊ®ôÈÅ∏Êäû -->
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">ÁõÆÊ®ô„ÇíË®≠ÂÆö„Åô„ÇãÊåáÊ®ô</label>
                            <select id="goal-metric" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                                <option value="lbm">üí™ LBMÔºàÈô§ËÑÇËÇ™‰ΩìÈáçÔºâ</option>
                                <option value="overall">üéØ Á∑èÂêàÂàÜÊûê„Çπ„Ç≥„Ç¢</option>
                            </select>
                        </div>

                        <!-- ÁõÆÊ®ôÂÄ§ -->
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">ÁõÆÊ®ôÂÄ§</label>
                            <div class="flex items-center gap-2">
                                <input type="number" id="goal-value" step="0.1" placeholder="‰æã: 65.0" class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                                <span id="goal-unit" class="text-gray-600 font-semibold">kg</span>
                            </div>
                        </div>

                        <!-- ÈÅîÊàê‰∫àÂÆöÊó• -->
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">ÈÅîÊàê‰∫àÂÆöÊó•Ôºà‰ªªÊÑèÔºâ</label>
                            <input type="date" id="goal-date" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                        </div>

                        <!-- „Ç∞„É©„Éï„Å´Ë°®Á§∫„Åô„Çã„Åã -->
                        <div class="flex items-center gap-2">
                            <input type="checkbox" id="goal-show-line" checked class="w-4 h-4">
                            <label for="goal-show-line" class="text-sm font-semibold text-gray-700">„Ç∞„É©„Éï„Å´ÁõÆÊ®ô„É©„Ç§„É≥„ÇíË°®Á§∫</label>
                        </div>

                        <!-- ÁèæÂú®„ÅÆÁõÆÊ®ô -->
                        <div id="current-goal-info" class="bg-blue-50 p-4 rounded-lg border border-blue-200 hidden">
                            <h4 class="text-sm font-bold text-blue-700 mb-2">ÁèæÂú®„ÅÆÁõÆÊ®ô</h4>
                            <div id="current-goal-text" class="text-sm text-gray-700"></div>
                        </div>

                        <!-- „Éú„Çø„É≥ -->
                        <div class="flex gap-3">
                            <button onclick="saveGoal()" class="flex-1 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition flex items-center justify-center gap-2 font-semibold">
                                <i data-lucide="check" class="w-4 h-4"></i>
                                ÁõÆÊ®ô„Çí‰øùÂ≠ò
                            </button>
                            <button onclick="clearGoal()" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition font-semibold">
                                „ÇØ„É™„Ç¢
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- v9„ÅÆÊîπËâØ„Éù„Ç§„É≥„Éà -->
        <div class="bg-white rounded-lg shadow-md p-4 mt-6">
            <h3 class="font-bold text-lg mb-3 text-gray-800">‚úÖ v9„ÅÆÊñ∞Ê©üËÉΩ</h3>
            <ul class="list-disc pl-5 space-y-1 text-sm text-gray-700">
                <li><strong>YËª∏ÈÄ£ÂãïÊ©üËÉΩ</strong>: ‰∏ä„ÅÆ„Ç∞„É©„Éï„ÅÆYËª∏ÁØÑÂõ≤„ÇíÂ§âÊõ¥„Åô„Çã„Å®„ÄÅ‰∏ã„ÅÆ„Ç∞„É©„Éï„ÇÇËá™Âãï„ÅßÂêå„ÅòÁØÑÂõ≤„Å´Ë™øÊï¥</li>
                <li><strong>Ëá™Âãï„É¨„É≥„Ç∏Ë™øÊï¥</strong>: „Ç∞„É©„Éï„ÅÆÈ´ò„Åï„ÇíË°®Á§∫ÁØÑÂõ≤„Å´Âøú„Åò„Å¶Ëá™ÂãïÊúÄÈÅ©ÂåñÔºàË¶ñË¶öÁöÑ„Å´Ë¶ã„ÇÑ„Åô„ÅèÔºâ</li>
                <li><strong>ÊúÄ‰ΩéÂÄ§/ÊúÄÂ§ßÂÄ§„Éô„Éº„Çπ</strong>: „Éá„Éï„Ç©„É´„Éà„ÅÆYËª∏ÁØÑÂõ≤„ÅØÂÖ®ÊúüÈñìÔºà90Êó•ÈñìÔºâ„ÅÆÊúÄ‰ΩéÂÄ§„Å®ÊúÄÂ§ßÂÄ§„ÇíÂü∫Ê∫ñ„Å´Ëá™ÂãïË®≠ÂÆö</li>
                <li><strong>ÈÄ£ÂãïON/OFFÂàáÊõø</strong>: „ÉÅ„Çß„ÉÉ„ÇØ„Éú„ÉÉ„ÇØ„Çπ„ÅßYËª∏ÈÄ£Âãï„Çí‰ªªÊÑè„Å´ON/OFFÂèØËÉΩ</li>
                <li><strong>„É™„Ç¢„É´„Çø„Ç§„É†ÂêåÊúü</strong>: ‰∏ä„ÅÆ„Ç∞„É©„Éï„ÅÆÊï∞ÂÄ§ÂÖ•Âäõ„Éï„Ç£„Éº„É´„Éâ„ÇíÂ§âÊõ¥„Åô„Çã„Å®Âç≥Â∫ß„Å´‰∏ã„ÅÆ„Ç∞„É©„Éï„ÇÇÊõ¥Êñ∞</li>
                <li><strong>ÊúüÈñì„ÅÆÈáçË§áÈò≤Ê≠¢</strong>: ‰∏ä„ÅÆ„Ç∞„É©„Éï„ÅßÈÅ∏Êäû„Åó„ÅüÊúüÈñì„ÅØ„ÄÅ‰∏ã„ÅÆ„Ç∞„É©„Éï„ÅßÈÅ∏Êäû„Åß„Åç„Å™„ÅÑ„Çà„ÅÜ„Å´Ëá™Âãï„ÅßÁÑ°ÂäπÂåñ</li>
                <li><strong>ÊåáÁ§∫Êõ∏ÈÅîÊàêÁä∂Ê≥Å</strong>: ÂÆå‰∫Ü/Êú™ÂÆå‰∫Ü„ÅÆ2Êäû„Éá„Éº„Çø„Å´ÂØæÂøúÔºà„Éê„Éº„Ç∞„É©„ÉïË°®Á§∫„ÄÅÈÅîÊàêÁéá„ÉªÂÆå‰∫ÜÊó•Êï∞„ÉªÊú™ÂÆå‰∫ÜÊó•Êï∞„ÇíÁµ±Ë®àË°®Á§∫Ôºâ</li>
                <li><strong>‰Ωø„ÅÑÊñπ„Ç¨„Ç§„Éâ</strong>: „Äå‰Ωø„ÅÑÊñπ„Äç„Éú„Çø„É≥„ÅßË©≥Á¥∞„Å™Êìç‰ΩúË™¨Êòé„ÇíË°®Á§∫„ÄÅÂêÑÊ©üËÉΩ„Å´i„Ç¢„Ç§„Ç≥„É≥„Åß„ÉÑ„Éº„É´„ÉÅ„ÉÉ„ÉóË°®Á§∫</li>
            </ul>
        </div>

        <!-- ‰ªäÂæåÂÆüË£Ö„Åô„Åπ„ÅçÊ©üËÉΩÔºàÊèêÊ°àÔºâ -->
        <div class="bg-gradient-to-r from-blue-50 to-purple-50 rounded-lg shadow-md p-4 mt-6 border-2 border-blue-300">
            <h3 class="font-bold text-lg mb-3 text-gray-800 flex items-center gap-2">
                <span>üí°</span>
                ‰ªäÂæåÂÆüË£Ö„Åô„Åπ„ÅçÊ©üËÉΩÔºàÊèêÊ°àÔºâ
            </h3>

            <!-- ÂÑ™ÂÖàÂ∫¶: È´ò -->
            <div class="mb-4">
                <h4 class="font-semibold text-md mb-2 text-red-700">üî¥ ÂÑ™ÂÖàÂ∫¶: È´ò</h4>
                <ul class="space-y-2 text-sm text-gray-700">
                    <li class="flex items-start gap-2 bg-white p-2 rounded">
                        <span class="text-red-600 font-bold">1.</span>
                        <div>
                            <strong>„Éá„Éº„Çø„Ç®„ÇØ„Çπ„Éù„Éº„ÉàÊ©üËÉΩ</strong>
                            <p class="text-xs text-gray-600 mt-1">CSV/PDFÂΩ¢Âºè„Åß„Ç∞„É©„Éï„Å®Áµ±Ë®à„Éá„Éº„Çø„Çí„Ç®„ÇØ„Çπ„Éù„Éº„Éà„ÄÇÂåªÂ∏´„ÇÑÊ†ÑÈ§äÂ£´„Å®„ÅÆÂÖ±Êúâ„Å´‰æøÂà©</p>
                        </div>
                    </li>
                    <li class="flex items-start gap-2 bg-white p-2 rounded">
                        <span class="text-red-600 font-bold">2.</span>
                        <div>
                            <strong>ÁõÆÊ®ôË®≠ÂÆö„ÉªÈÄ≤ÊçóË°®Á§∫</strong>
                            <p class="text-xs text-gray-600 mt-1">ÂêÑÊåáÊ®ô„Å´ÁõÆÊ®ôÂÄ§„ÇíË®≠ÂÆö„Åó„ÄÅ„Ç∞„É©„Éï‰∏ä„Å´ÁõÆÊ®ô„É©„Ç§„É≥„ÇíË°®Á§∫„ÄÇÈÅîÊàêÂ∫¶„ÇíÂèØË¶ñÂåñ</p>
                        </div>
                    </li>
                    <li class="flex items-start gap-2 bg-white p-2 rounded">
                        <span class="text-red-600 font-bold">3.</span>
                        <div>
                            <strong>„Ç¢„Éé„ÉÜ„Éº„Ç∑„Éß„É≥Ôºà„É°„É¢ÔºâÊ©üËÉΩ</strong>
                            <p class="text-xs text-gray-600 mt-1">ÁâπÂÆö„ÅÆÊó•‰ªò„Å´„É°„É¢„ÇíËøΩÂä†Ôºà‰æã: „ÄåÈ¢®ÈÇ™„Åß‰ºëÈ§ä„Äç„Äå„ÉÅ„Éº„Éà„Éá„Ç§„ÄçÔºâ„ÄÇ„Ç∞„É©„Éï‰∏ä„Å´„Éû„Éº„Ç´„ÉºË°®Á§∫</p>
                        </div>
                    </li>
                    <li class="flex items-start gap-2 bg-white p-2 rounded">
                        <span class="text-red-600 font-bold">4.</span>
                        <div>
                            <strong>„Ç´„Çπ„Çø„É†ÊúüÈñìÈÅ∏Êäû</strong>
                            <p class="text-xs text-gray-600 mt-1">„Ç´„É¨„É≥„ÉÄ„ÉºUI„Åß‰ªªÊÑè„ÅÆÊó•‰ªòÁØÑÂõ≤„ÇíÈÅ∏ÊäûÂèØËÉΩ„Å´Ôºà‰æã: 2024/10/1 „Äú 2024/10/15Ôºâ</p>
                        </div>
                    </li>
                </ul>
            </div>

            <!-- ÂÑ™ÂÖàÂ∫¶: ‰∏≠ -->
            <div class="mb-4">
                <h4 class="font-semibold text-md mb-2 text-orange-700">üü° ÂÑ™ÂÖàÂ∫¶: ‰∏≠</h4>
                <ul class="space-y-2 text-sm text-gray-700">
                    <li class="flex items-start gap-2 bg-white p-2 rounded">
                        <span class="text-orange-600 font-bold">5.</span>
                        <div>
                            <strong>Ë§áÊï∞ÊåáÊ®ô„ÅÆÈáç„Å≠Âêà„Çè„Åõ</strong>
                            <p class="text-xs text-gray-600 mt-1">1„Å§„ÅÆ„Ç∞„É©„Éï„Å´Ë§áÊï∞„ÅÆÊåáÊ®ô„ÇíË°®Á§∫Ôºà‰æã: ‰ΩìÈáç„Å®LBM„ÇíÂêåÊôÇË°®Á§∫Ôºâ„ÄÇÁõ∏Èñ¢Èñ¢‰øÇ„ÇíÂàÜÊûê</p>
                        </div>
                    </li>
                    <li class="flex items-start gap-2 bg-white p-2 rounded">
                        <span class="text-orange-600 font-bold">6.</span>
                        <div>
                            <strong>ÁßªÂãïÂπ≥ÂùáÁ∑ö„ÅÆË°®Á§∫</strong>
                            <p class="text-xs text-gray-600 mt-1">7Êó•/14Êó•/30Êó•ÁßªÂãïÂπ≥ÂùáÁ∑ö„Çí„Ç™„Éº„Éê„Éº„É¨„Ç§Ë°®Á§∫„ÄÇ„Éé„Ç§„Ç∫„ÇíÈô§Âéª„Åó„Å¶„Éà„É¨„É≥„Éâ„ÇíÊääÊè°</p>
                        </div>
                    </li>
                    <li class="flex items-start gap-2 bg-white p-2 rounded">
                        <span class="text-orange-600 font-bold">7.</span>
                        <div>
                            <strong>ÈÄ±Ê¨°„ÉªÊúàÊ¨°„Çµ„Éû„É™„Éº</strong>
                            <p class="text-xs text-gray-600 mt-1">ÈÄ±„Åî„Å®„ÉªÊúà„Åî„Å®„ÅÆÂπ≥ÂùáÂÄ§„ÇÑÈÅîÊàêÁéá„Çí‰∏ÄË¶ßË°®Á§∫„ÄÇÈï∑Êúü„Éà„É¨„É≥„Éâ„Çí‰øØÁû∞</p>
                        </div>
                    </li>
                    <li class="flex items-start gap-2 bg-white p-2 rounded">
                        <span class="text-orange-600 font-bold">8.</span>
                        <div>
                            <strong>„Ç∞„É©„Éï„ÅÆÁîªÂÉè‰øùÂ≠ò</strong>
                            <p class="text-xs text-gray-600 mt-1">„Ç∞„É©„Éï„ÇíPNG/JPGÂΩ¢Âºè„Åß‰øùÂ≠ò„ÄÇSNS„ÇÑÂ†±ÂëäÊõ∏„Å∏„ÅÆË≤º„Çä‰ªò„Åë„Å´‰æøÂà©</p>
                        </div>
                    </li>
                </ul>
            </div>

            <!-- ÂÑ™ÂÖàÂ∫¶: ‰Ωé -->
            <div>
                <h4 class="font-semibold text-md mb-2 text-green-700">üü¢ ÂÑ™ÂÖàÂ∫¶: ‰ΩéÔºàÂ∞ÜÊù•ÁöÑ„Å´Ôºâ</h4>
                <ul class="space-y-2 text-sm text-gray-700">
                    <li class="flex items-start gap-2 bg-white p-2 rounded">
                        <span class="text-green-600 font-bold">9.</span>
                        <div>
                            <strong>‰∫àÊ∏¨Á∑ö„ÅÆË°®Á§∫</strong>
                            <p class="text-xs text-gray-600 mt-1">Ê©üÊ¢∞Â≠¶Áøí„Åß‰ªäÂæå„ÅÆÊé®Áßª„Çí‰∫àÊ∏¨„ÄÇÊú™Êù•7Êó•Èñì„ÅÆ‰∫àÊ∏¨Á∑ö„ÇíË°®Á§∫</p>
                        </div>
                    </li>
                    <li class="flex items-start gap-2 bg-white p-2 rounded">
                        <span class="text-green-600 font-bold">10.</span>
                        <div>
                            <strong>„Éë„Éº„ÇΩ„Éä„É©„Ç§„Ç∫„Åï„Çå„ÅüAI„Ç≥„Éº„ÉÅ„É≥„Ç∞</strong>
                            <p class="text-xs text-gray-600 mt-1">„É¶„Éº„Ç∂„Éº„ÅÆÂ±•Ê≠¥„Åã„ÇâÊúÄÈÅ©„Å™„Ç¢„Éâ„Éê„Ç§„Çπ„ÇíËá™ÂãïÁîüÊàê„ÄÇÊØéÈÄ±ÊúàÊõúÊó•„Å´„É¨„Éù„Éº„ÉàÈÖç‰ø°</p>
                        </div>
                    </li>
                    <li class="flex items-start gap-2 bg-white p-2 rounded">
                        <span class="text-green-600 font-bold">11.</span>
                        <div>
                            <strong>‰ªñ„É¶„Éº„Ç∂„Éº„Å®„ÅÆÊØîËºÉ</strong>
                            <p class="text-xs text-gray-600 mt-1">ÂåøÂêçÂåñ„Åï„Çå„Åü‰ªñ„É¶„Éº„Ç∂„Éº„ÅÆÂπ≥ÂùáÂÄ§„Å®Ëá™ÂàÜ„ÅÆ„Éá„Éº„Çø„ÇíÊØîËºÉÔºà„Éó„É©„Ç§„Éê„Ç∑„Éº‰øùË≠∑ÂøÖÈ†àÔºâ</p>
                        </div>
                    </li>
                    <li class="flex items-start gap-2 bg-white p-2 rounded">
                        <span class="text-green-600 font-bold">12.</span>
                        <div>
                            <strong>„Ç§„É≥„Çø„É©„ÇØ„ÉÜ„Ç£„Éñ„Å™„Éâ„É™„É´„ÉÄ„Ç¶„É≥</strong>
                            <p class="text-xs text-gray-600 mt-1">„Ç∞„É©„Éï‰∏ä„ÅÆÁÇπ„Çí„ÇØ„É™„ÉÉ„ÇØ„Åô„Çã„Å®„ÄÅ„Åù„ÅÆÊó•„ÅÆË©≥Á¥∞„Éá„Éº„ÇøÔºàÈ£ü‰∫ãÂÜÖÂÆπ„ÄÅ„Éà„É¨„Éº„Éã„É≥„Ç∞„É°„Éã„É•„ÉºÔºâ„ÇíË°®Á§∫</p>
                        </div>
                    </li>
                </ul>
            </div>
        </div>
    </div>

    <!-- „Éâ„É™„É´„ÉÄ„Ç¶„É≥„É¢„Éº„ÉÄ„É´ -->
    <div id="drilldown-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden" onclick="closeDrillDownModal()">
        <div class="bg-white rounded-lg shadow-2xl w-11/12 max-w-2xl max-h-[90vh] overflow-y-auto" onclick="event.stopPropagation()">
            <!-- „É¢„Éº„ÉÄ„É´„Éò„ÉÉ„ÉÄ„Éº -->
            <div class="sticky top-0 bg-gradient-to-r from-purple-600 to-blue-600 text-white p-4 rounded-t-lg flex items-center justify-between z-10">
                <div class="flex items-center gap-3">
                    <i data-lucide="calendar" class="w-6 h-6"></i>
                    <div>
                        <h3 class="text-xl font-bold" id="drilldown-title">Ë©≥Á¥∞ÊÉÖÂ†±</h3>
                        <p class="text-sm opacity-90" id="drilldown-subtitle">Êó•‰ªò„Å®ÂÄ§</p>
                    </div>
                </div>
                <button onclick="closeDrillDownModal()" class="p-2 hover:bg-white hover:bg-opacity-20 rounded-full transition">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>

            <!-- „É¢„Éº„ÉÄ„É´„Ç≥„É≥„ÉÜ„É≥„ÉÑ -->
            <div class="p-6">
                <!-- „É°„Éà„É™„ÇØ„ÇπÊÉÖÂ†± -->
                <div class="bg-gradient-to-r from-purple-50 to-blue-50 rounded-lg p-4 mb-4 border border-purple-200">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-gray-600 mb-1">ÊåáÊ®ô</p>
                            <p class="text-2xl font-bold text-purple-700" id="drilldown-metric"></p>
                        </div>
                        <div class="text-right">
                            <p class="text-sm text-gray-600 mb-1">ÂÄ§</p>
                            <p class="text-3xl font-bold text-blue-700" id="drilldown-value"></p>
                        </div>
                    </div>
                </div>

                <!-- „É°„É¢„Çª„ÇØ„Ç∑„Éß„É≥ -->
                <div class="bg-gray-50 rounded-lg p-4 mb-4">
                    <h4 class="font-semibold text-gray-800 mb-3 flex items-center gap-2">
                        <i data-lucide="message-square" class="w-4 h-4 text-orange-600"></i>
                        „É°„É¢
                    </h4>
                    <div id="drilldown-memo-display" class="mb-3 hidden">
                        <div class="bg-white p-3 rounded border border-gray-200">
                            <p class="text-sm text-gray-700" id="drilldown-memo-text"></p>
                        </div>
                    </div>
                    <div id="drilldown-memo-empty" class="text-sm text-gray-500 italic mb-3">
                        „Åì„ÅÆ„Éá„Éº„Çø„Éù„Ç§„É≥„Éà„Å´„ÅØ„É°„É¢„Åå„ÅÇ„Çä„Åæ„Åõ„Çì
                    </div>
                    <button
                        onclick="toggleMemoEdit()"
                        class="text-sm px-3 py-2 bg-orange-500 text-white rounded-lg hover:bg-orange-600 transition flex items-center gap-2">
                        <i data-lucide="edit" class="w-4 h-4"></i>
                        <span id="memo-edit-button-text">„É°„É¢„ÇíËøΩÂä†</span>
                    </button>
                    <div id="drilldown-memo-edit" class="mt-3 hidden">
                        <textarea
                            id="drilldown-memo-input"
                            rows="3"
                            placeholder="„É°„É¢„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑÔºà‰æã: „ÉÅ„Éº„Éà„Éá„Ç§„ÄÅ‰ΩìË™ø‰∏çËâØ„Å™„Å©Ôºâ"
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-orange-500"></textarea>
                        <div class="flex gap-2 mt-2">
                            <button
                                onclick="saveMemo()"
                                class="flex-1 px-3 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 transition text-sm font-semibold">
                                ‰øùÂ≠ò
                            </button>
                            <button
                                onclick="deleteMemo()"
                                class="px-3 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition text-sm font-semibold">
                                ÂâäÈô§
                            </button>
                            <button
                                onclick="toggleMemoEdit()"
                                class="px-3 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400 transition text-sm font-semibold">
                                „Ç≠„É£„É≥„Çª„É´
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Èñ¢ÈÄ£„Éá„Éº„ÇøÔºàÂ∞ÜÊù•„ÅÆÊã°ÂºµÁî®Ôºâ -->
                <div class="bg-blue-50 rounded-lg p-4">
                    <h4 class="font-semibold text-gray-800 mb-3 flex items-center gap-2">
                        <i data-lucide="info" class="w-4 h-4 text-blue-600"></i>
                        „Åì„ÅÆÊó•„ÅÆÊÉÖÂ†±
                    </h4>
                    <p class="text-sm text-gray-600">
                        „Çà„ÇäË©≥Á¥∞„Å™ÊÉÖÂ†±ÔºàÈ£ü‰∫ã„ÄÅ„Éà„É¨„Éº„Éã„É≥„Ç∞„Å™„Å©Ôºâ„ÅØ„ÄÅ„É°„Ç§„É≥„Ç¢„Éó„É™„ÅÆ„ÄåÂ±•Ê≠¥„Äç„Çø„Éñ„Åã„ÇâÁ¢∫Ë™ç„Åß„Åç„Åæ„Åô„ÄÇ
                    </p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Lucide„Ç¢„Ç§„Ç≥„É≥ÂàùÊúüÂåñ
        lucide.createIcons();

        let currentMainCategory = 'performance';
        let currentSubCategory = 'lbm';
        let comparisonMode = false;
        let axisSync = true; // YËª∏ÈÄ£ÂãïON/OFF
        let charts = { 1: null, 2: null };
        let currentPeriods = { 1: 7, 2: 30 };
        let currentAxisRanges = { 1: { min: null, max: null }, 2: { min: null, max: null } };
        let globalMinMax = { min: 0, max: 100 }; // ÂÖ®ÊúüÈñì„ÅÆÊúÄ‰ΩéÂÄ§„ÉªÊúÄÂ§ßÂÄ§
        let currentData = { 1: [], 2: [] };
        let goals = {}; // ÁõÆÊ®ô„Éá„Éº„ÇøÔºàLocalStorage„Åã„ÇâË™≠„ÅøËæº„ÅøÔºâ
        let annotations = {}; // „Ç¢„Éé„ÉÜ„Éº„Ç∑„Éß„É≥Ôºà„É°„É¢Ôºâ„Éá„Éº„Çø
        let showMovingAverage = { 1: false, 2: false }; // ÁßªÂãïÂπ≥ÂùáÁ∑öË°®Á§∫
        let movingAveragePeriod = { 1: 7, 2: 7 }; // ÁßªÂãïÂπ≥Âùá„ÅÆÊúüÈñì
        let showPrediction = { 1: false, 2: false }; // ‰∫àÊ∏¨Á∑öË°®Á§∫
        let chart2Category = 'lbm'; // Chart2„ÅÆË°®Á§∫„Ç´„ÉÜ„Ç¥„É™

        // „Éâ„É™„É´„ÉÄ„Ç¶„É≥„É¢„Éº„ÉÄ„É´Áî®„ÅÆÂ§âÊï∞
        let currentDrillDownData = {
            chartNum: null,
            index: null,
            label: null,
            value: null,
            metric: null,
            annotationKey: null
        };

        // „ÇØ„É≠„Çπ„Éò„Ç¢Áî®„ÅÆÂ§âÊï∞
        let crosshairPosition = { x: null, y: null };
        let showCrosshair = false;

        // Gemini APIË®≠ÂÆöÔºà„Éá„É¢Áî® - ÂÆüÈöõ„ÅØconfig.js„Åã„ÇâÂèñÂæóÔºâ
        const GEMINI_API_KEY = 'YOUR_API_KEY_HERE';
        const GEMINI_API_URL = 'https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash-exp:generateContent';

        // ÊåáÊ®ô„ÅÆÊó•Êú¨Ë™ûÂêç„Å®„É°„ÇøÊÉÖÂ†±
        const metricInfo = {
            // „Éë„Éï„Ç©„Éº„Éû„É≥„Çπ
            lbm: { name: 'LBMÔºàÈô§ËÑÇËÇ™‰ΩìÈáçÔºâ', unit: 'kg', target: 65, category: 'performance' },
            directive: { name: 'ÊåáÁ§∫Êõ∏ÈÅîÊàêÁä∂Ê≥Å', unit: '', target: 1, isBinary: true, category: 'performance' },
            overall: { name: 'Á∑èÂêàÂàÜÊûê„Çπ„Ç≥„Ç¢', unit: 'ÁÇπ', target: 100, category: 'performance' },

            // È£ü‰∫ã
            calories: { name: '„Ç´„É≠„É™„Éº', unit: 'kcal', target: 2200, category: 'nutrition' },
            protein: { name: '„Çø„É≥„Éë„ÇØË≥™', unit: 'g', target: 150, category: 'nutrition' },
            carbs: { name: 'ÁÇ≠Ê∞¥ÂåñÁâ©', unit: 'g', target: 250, category: 'nutrition' },
            fat: { name: 'ËÑÇË≥™', unit: 'g', target: 60, category: 'nutrition' },
            water: { name: 'Ê∞¥ÂàÜÊëÇÂèñ', unit: 'L', target: 2.5, category: 'nutrition' },

            // ÈÅãÂãï
            workout_duration: { name: 'ÈÅãÂãïÊôÇÈñì', unit: 'ÂàÜ', target: 60, category: 'training' },
            workout_volume: { name: 'Á∑èË≤†Ëç∑Èáè', unit: 'kg', target: 5000, category: 'training' },
            steps: { name: 'Ê≠©Êï∞', unit: 'Ê≠©', target: 10000, category: 'training' },
            cardio: { name: 'ÊúâÈÖ∏Á¥†ÈÅãÂãï', unit: 'ÂàÜ', target: 30, category: 'training' },

            // „Ç≥„É≥„Éá„Ç£„Ç∑„Éß„É≥
            weight: { name: '‰ΩìÈáç', unit: 'kg', target: 70, category: 'condition' },
            body_fat: { name: '‰ΩìËÑÇËÇ™Áéá', unit: '%', target: 15, category: 'condition' },
            sleep: { name: 'Áù°Áú†ÊôÇÈñì', unit: 'ÊôÇÈñì', target: 7.5, category: 'condition' },
            mood: { name: 'Ê∞óÂàÜ', unit: 'ÁÇπ', target: 8, category: 'condition' },
            energy: { name: '„Ç®„Éç„É´„ÇÆ„Éº„É¨„Éô„É´', unit: 'ÁÇπ', target: 8, category: 'condition' }
        };

        // ÂÆüÈöõ„ÅÆ„Éá„Éº„Çø„ÇíË™≠„ÅøËæº„ÇÄÈñ¢Êï∞
        async function loadRealData() {
            const userId = window.currentUser?.uid || 'demo_user';
            const allData = {
                // „Éë„Éï„Ç©„Éº„Éû„É≥„Çπ
                lbm: [],
                directive: [],
                overall: [],
                // È£ü‰∫ã
                calories: [],
                protein: [],
                carbs: [],
                fat: [],
                water: [],
                // ÈÅãÂãï
                workout_duration: [],
                workout_volume: [],
                steps: [],
                cardio: [],
                // „Ç≥„É≥„Éá„Ç£„Ç∑„Éß„É≥
                weight: [],
                body_fat: [],
                sleep: [],
                mood: [],
                energy: []
            };

            // ÈÅéÂéª90Êó•ÂàÜ„ÅÆ„Éá„Éº„Çø„ÇíÂèñÂæó
            for (let i = 89; i >= 0; i--) {
                const date = new Date();
                date.setDate(date.getDate() - i);
                const dateStr = date.toISOString().split('T')[0];

                let record = null;
                if (typeof DataService !== 'undefined') {
                    record = await DataService.getDailyRecord(userId, dateStr);
                }

                if (record) {
                    // È£ü‰∫ã„Éá„Éº„Çø
                    const meals = record.meals || [];
                    let totalCalories = 0, totalProtein = 0, totalCarbs = 0, totalFat = 0;
                    meals.forEach(meal => {
                        totalCalories += meal.calories || 0;
                        totalProtein += meal.protein || 0;
                        totalCarbs += meal.carbs || 0;
                        totalFat += meal.fat || 0;
                    });
                    allData.calories.push(totalCalories);
                    allData.protein.push(totalProtein);
                    allData.carbs.push(totalCarbs);
                    allData.fat.push(totalFat);
                    allData.water.push(record.conditions?.water || 0);

                    // ÈÅãÂãï„Éá„Éº„Çø
                    const workouts = record.workouts || [];
                    let totalDuration = 0, totalVolume = 0;
                    workouts.forEach(workout => {
                        totalDuration += workout.duration || 0;
                        workout.sets?.forEach(set => {
                            totalVolume += (set.weight || 0) * (set.reps || 0);
                        });
                    });
                    allData.workout_duration.push(totalDuration);
                    allData.workout_volume.push(totalVolume);
                    allData.steps.push(record.conditions?.steps || 0);
                    allData.cardio.push(record.conditions?.cardio || 0);

                    // „Ç≥„É≥„Éá„Ç£„Ç∑„Éß„É≥„Éá„Éº„Çø
                    allData.weight.push(record.conditions?.weight || 0);
                    allData.body_fat.push(record.conditions?.bodyFatPercentage || 0);
                    allData.sleep.push(record.conditions?.sleep || 0);
                    allData.mood.push(record.conditions?.mood || 0);
                    allData.energy.push(record.conditions?.energy || 0);

                    // „Éë„Éï„Ç©„Éº„Éû„É≥„Çπ„Éá„Éº„Çø
                    const weight = record.conditions?.weight || 0;
                    const bodyFat = record.conditions?.bodyFatPercentage || 0;
                    const lbm = weight > 0 && bodyFat > 0 ? weight * (1 - bodyFat / 100) : 0;
                    allData.lbm.push(lbm);

                    allData.directive.push(record.directiveCompleted ? 1 : 0);
                    allData.overall.push(record.overallScore || 0);
                } else {
                    // „Éá„Éº„Çø„Åå„Å™„ÅÑÂ†¥Âêà„ÅØ0„ÇíËøΩÂä†
                    Object.keys(allData).forEach(key => {
                        allData[key].push(0);
                    });
                }
            }

            return allData;
        }

        // „ÉÄ„Éü„Éº„Éá„Éº„ÇøÔºàDataService„ÅåÂà©Áî®„Åß„Åç„Å™„ÅÑÂ†¥Âêà„ÅÆ„Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØÔºâ
        const allData = {
            // „Éë„Éï„Ç©„Éº„Éû„É≥„Çπ
            lbm: Array.from({ length: 90 }, (_, i) => 61.0 + (i * 0.02) + (Math.random() * 0.3 - 0.15)),
            directive: Array.from({ length: 90 }, () => Math.random() > 0.3 ? 1 : 0),
            overall: Array.from({ length: 90 }, (_, i) => 80 + (i * 0.1) + (Math.random() * 8 - 4)),

            // È£ü‰∫ã
            calories: Array.from({ length: 90 }, (_, i) => 2000 + (i * 2) + (Math.random() * 200 - 100)),
            protein: Array.from({ length: 90 }, (_, i) => 140 + (i * 0.1) + (Math.random() * 20 - 10)),
            carbs: Array.from({ length: 90 }, (_, i) => 230 + (i * 0.2) + (Math.random() * 40 - 20)),
            fat: Array.from({ length: 90 }, (_, i) => 55 + (i * 0.05) + (Math.random() * 10 - 5)),
            water: Array.from({ length: 90 }, (_, i) => 2.0 + (i * 0.005) + (Math.random() * 0.5 - 0.25)),

            // ÈÅãÂãï
            workout_duration: Array.from({ length: 90 }, (_, i) => 50 + (i * 0.1) + (Math.random() * 20 - 10)),
            workout_volume: Array.from({ length: 90 }, (_, i) => 4500 + (i * 5) + (Math.random() * 1000 - 500)),
            steps: Array.from({ length: 90 }, (_, i) => 8000 + (i * 20) + (Math.random() * 2000 - 1000)),
            cardio: Array.from({ length: 90 }, (_, i) => 25 + (i * 0.05) + (Math.random() * 10 - 5)),

            // „Ç≥„É≥„Éá„Ç£„Ç∑„Éß„É≥
            weight: Array.from({ length: 90 }, (_, i) => 72.0 - (i * 0.01) + (Math.random() * 0.4 - 0.2)),
            body_fat: Array.from({ length: 90 }, (_, i) => 18.0 - (i * 0.01) + (Math.random() * 0.5 - 0.25)),
            sleep: Array.from({ length: 90 }, (_, i) => 7.0 + (Math.random() * 1.5 - 0.5)),
            mood: Array.from({ length: 90 }, (_, i) => 7.0 + (Math.random() * 2 - 1)),
            energy: Array.from({ length: 90 }, (_, i) => 7.0 + (i * 0.01) + (Math.random() * 2 - 1))
        };

        // ÂÖ®ÊúüÈñì„ÅÆÊúÄ‰ΩéÂÄ§„ÉªÊúÄÂ§ßÂÄ§„ÇíË®àÁÆó
        function calculateGlobalMinMax(metric) {
            const data = allData[metric];
            const info = metricInfo[metric];

            // ÊåáÁ§∫Êõ∏Ôºà„Éê„Ç§„Éä„É™„Éá„Éº„ÇøÔºâ„ÅØ0-1Âõ∫ÂÆö
            if (info.isBinary) {
                return { min: 0, max: 1 };
            }

            const min = Math.min(...data);
            const max = Math.max(...data);
            const range = max - min;

            // „Éû„Éº„Ç∏„É≥„ÇíÂ§ß„Åç„ÇÅ„Å´Ë®≠ÂÆöÔºà20%Ôºâ„Åó„Å¶„ÄÅÊï∞ÂÄ§„ÅåË¶ãÂàá„Çå„Å™„ÅÑ„Çà„ÅÜ„Å´„Åô„Çã
            const margin = Math.max(range * 0.2, 0.5); // ÊúÄ‰Ωé„Åß„ÇÇ0.5„ÅÆ„Éû„Éº„Ç∏„É≥

            return {
                min: Math.floor((min - margin) * 10) / 10,
                max: Math.ceil((max + margin) * 10) / 10
            };
        }

        // ÊåáÂÆöÊúüÈñì„ÅÆ„Éá„Éº„Çø„ÇíÂèñÂæó
        function generateData(days) {
            const result = {};
            // „Åô„Åπ„Å¶„ÅÆÊåáÊ®ô„ÅÆ„Éá„Éº„Çø„ÇíËøî„Åô
            for (const key in allData) {
                result[key] = allData[key].slice(-days);
            }
            return result;
        }

        // „É©„Éô„É´ÁîüÊàê
        function generateLabels(days) {
            if (days <= 7) {
                // 7Êó•‰ª•ÂÜÖ: 1, 2, 3, 4, 5, 6, 7Êó•Ââç
                const labels = Array.from({ length: days }, (_, i) => `${days - i}`);
                labels[labels.length - 1] += 'Êó•Ââç'; // ÊúÄÂæå„Å´Âçò‰Ωç„ÇíËøΩÂä†
                return labels;
            } else if (days <= 30) {
                // 30Êó•‰ª•ÂÜÖ: Êï∞Â≠ó„ÅÆ„Åø„ÄÅÊúÄÂæå„Å´„ÄåÊó•Ââç„Äç
                const labels = Array.from({ length: days }, (_, i) => `${days - i}`);
                labels[labels.length - 1] += 'Êó•Ââç';
                return labels;
            } else {
                // 30Êó•‰ª•‰∏ä: ÈÄ±Âçò‰Ωç„ÅßË°®Á§∫
                const labels = Array.from({ length: days }, (_, i) => {
                    const weeksAgo = Math.floor((days - i - 1) / 7);
                    if (i % 7 === 0 && weeksAgo > 0) return `${weeksAgo}ÈÄ±Ââç`;
                    if (i === days - 1) return '‰ªäÊó•';
                    return '';
                });
                return labels;
            }
        }

        // ÁßªÂãïÂπ≥Âùá„ÇíË®àÁÆó
        function calculateMovingAverage(data, period) {
            const result = [];
            for (let i = 0; i < data.length; i++) {
                if (i < period - 1) {
                    result.push(null); // ÊúÄÂàù„ÅÆÊï∞Êó•„ÅØË®àÁÆó„Åß„Åç„Å™„ÅÑ
                } else {
                    const sum = data.slice(i - period + 1, i + 1).reduce((a, b) => a + b, 0);
                    result.push(sum / period);
                }
            }
            return result;
        }

        // Á∑öÂΩ¢ÂõûÂ∏∞„Åß‰∫àÊ∏¨Á∑ö„ÇíË®àÁÆó
        function calculatePrediction(data, futureDays = 7) {
            const validData = data.filter(v => v > 0);
            if (validData.length < 3) return [];

            // Á∑öÂΩ¢ÂõûÂ∏∞„ÅÆË®àÁÆó
            const n = validData.length;
            const indices = Array.from({ length: n }, (_, i) => i);
            const sumX = indices.reduce((a, b) => a + b, 0);
            const sumY = validData.reduce((a, b) => a + b, 0);
            const sumXY = indices.reduce((sum, x, i) => sum + x * validData[i], 0);
            const sumX2 = indices.reduce((sum, x) => sum + x * x, 0);

            const slope = (n * sumXY - sumX * sumY) / (n * sumX2 - sumX * sumX);
            const intercept = (sumY - slope * sumX) / n;

            // ‰∫àÊ∏¨ÂÄ§„ÇíË®àÁÆó
            const predictions = [];
            for (let i = 0; i < data.length + futureDays; i++) {
                predictions.push(slope * i + intercept);
            }

            return predictions;
        }

        // ÁßªÂãïÂπ≥ÂùáÁ∑ö„ÅÆË°®Á§∫ÂàáÊõø
        function toggleMovingAverage(chartNum) {
            showMovingAverage[chartNum] = !showMovingAverage[chartNum];
            updateChart(chartNum);
        }

        // ÁßªÂãïÂπ≥Âùá„ÅÆÊúüÈñì„ÇíÂ§âÊõ¥
        function changeMovingAveragePeriod(chartNum, period) {
            movingAveragePeriod[chartNum] = parseInt(period);
            if (showMovingAverage[chartNum]) {
                updateChart(chartNum);
            }
        }

        // ‰∫àÊ∏¨Á∑ö„ÅÆË°®Á§∫ÂàáÊõø
        function togglePrediction(chartNum) {
            showPrediction[chartNum] = !showPrediction[chartNum];
            updateChart(chartNum);
        }

        // Chart2„ÅÆ„Ç´„ÉÜ„Ç¥„É™„ÇíÂ§âÊõ¥
        function changeChart2Category(category) {
            chart2Category = category;
            currentSubCategory = category;
            updateChart(2);
        }

        // YËª∏ÈÄ£Âãï„ÅÆON/OFFÂàáÊõø
        function toggleAxisSync() {
            // „Éë„Éç„É´„Åæ„Åü„ÅØ„É°„Ç§„É≥ÁîªÈù¢„ÅÆ„ÉÅ„Çß„ÉÉ„ÇØ„Éú„ÉÉ„ÇØ„Çπ„Åã„ÇâÁä∂ÊÖã„ÇíÂèñÂæó
            const syncAxisPanelElement = document.getElementById('sync-axis-panel');
            const syncAxisElement = document.getElementById('sync-axis');

            // „Éë„Éç„É´„ÅÆË¶ÅÁ¥†„Åå„ÅÇ„Çå„Å∞„Åù„Å°„Çâ„Çí‰ΩøÁî®„ÄÅ„Å™„Åë„Çå„Å∞„É°„Ç§„É≥„ÅÆË¶ÅÁ¥†„Çí‰ΩøÁî®
            const checkboxElement = syncAxisPanelElement || syncAxisElement;
            if (!checkboxElement) {
                console.warn('YËª∏ÈÄ£ÂãïË¶ÅÁ¥†„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì');
                return;
            }

            axisSync = checkboxElement.checked;

            // ‰∏°Êñπ„ÅÆ„ÉÅ„Çß„ÉÉ„ÇØ„Éú„ÉÉ„ÇØ„Çπ„ÇíÂêåÊúü
            if (syncAxisPanelElement) syncAxisPanelElement.checked = axisSync;
            if (syncAxisElement) syncAxisElement.checked = axisSync;

            const icon = document.querySelector('.sync-icon');

            if (axisSync) {
                // ON„Å´„Å™„Å£„Åü„Çâ„ÄÅ„Ç∞„É©„Éï1„ÅÆÂÄ§„Çí„Ç∞„É©„Éï2„Å´ÂèçÊò†
                if (icon) {
                    icon.classList.add('syncing');
                    setTimeout(() => icon.classList.remove('syncing'), 1000);
                }

                if (comparisonMode && currentAxisRanges[1].min !== null) {
                    const axisMin2Element = document.getElementById('axis-min-2');
                    const axisMax2Element = document.getElementById('axis-max-2');

                    currentAxisRanges[2] = { ...currentAxisRanges[1] };
                    if (axisMin2Element) axisMin2Element.value = currentAxisRanges[1].min;
                    if (axisMax2Element) axisMax2Element.value = currentAxisRanges[1].max;
                    updateChart(2);
                }
            }

            lucide.createIcons();
        }

        // GeminiÂàÜÊûê
        async function analyzeWithGemini() {
            const modal = document.getElementById('ai-analysis-modal');
            const content = document.getElementById('analysis-content');

            modal.classList.add('show');
            content.innerHTML = `
                <div class="ai-analyzing">
                    <div class="spinner"></div>
                    <span class="text-gray-600">AI„Åå„Ç∞„É©„Éï„ÇíÂàÜÊûê‰∏≠...</span>
                </div>
            `;

            const metric = metricInfo[currentSubCategory];
            const data1 = currentData[1];
            const period1 = currentPeriods[1];

            // „Éá„Éº„Çø„ÅÆÁµ±Ë®àÊÉÖÂ†±„ÇíË®àÁÆó
            const avg = (data1.reduce((a, b) => a + b, 0) / data1.length).toFixed(1);
            const max = Math.max(...data1).toFixed(1);
            const min = Math.min(...data1).toFixed(1);
            const trend = (data1[data1.length - 1] - data1[0]).toFixed(1);
            const trendPercent = ((trend / data1[0]) * 100).toFixed(1);

            // Gemini„Å∏„ÅÆ„Éó„É≠„É≥„Éó„Éà‰ΩúÊàê
            const prompt = `
„ÅÇ„Å™„Åü„ÅØ„Éó„É≠„Éï„Çß„ÉÉ„Ç∑„Éß„Éä„É´„Å™„Éï„Ç£„ÉÉ„Éà„Éç„Çπ„Ç≥„Éº„ÉÅ„Åß„Åô„ÄÇ‰ª•‰∏ã„ÅÆ„Éá„Éº„Çø„ÇíÂàÜÊûê„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ

„ÄêÊåáÊ®ô„Äë${metric.name}
„ÄêÊúüÈñì„ÄëÈÅéÂéª${period1}Êó•Èñì
„Äê„Éá„Éº„Çø„Äë${data1.map(v => v.toFixed(1)).join(', ')}
„ÄêÁµ±Ë®à„Äë
- Âπ≥Âùá: ${avg}${metric.unit}
- ÊúÄÈ´ò: ${max}${metric.unit}
- ÊúÄ‰Ωé: ${min}${metric.unit}
- Â§âÂåñÈáè: ${trend > 0 ? '+' : ''}${trend}${metric.unit} (${trendPercent}%)
„ÄêÁõÆÊ®ô„Äë${metric.target}${metric.unit}

‰ª•‰∏ã„ÅÆÂΩ¢Âºè„ÅßÁ∞°ÊΩî„Å´ÂõûÁ≠î„Åó„Å¶„Åè„Å†„Åï„ÅÑÔºàÂêÑ„Çª„ÇØ„Ç∑„Éß„É≥200ÊñáÂ≠ó‰ª•ÂÜÖÔºâÔºö

## „Éà„É¨„É≥„ÉâÂàÜÊûê
[Â¢óÂä†/Ê∏õÂ∞ë/Ê®™„Å∞„ÅÑ„ÇíÂà§ÂÆö„Åó„ÄÅ„Åù„ÅÆÁêÜÁî±„Çí1-2Êñá„Åß]

## ÁõÆÊ®ôÈÅîÊàê‰∫àÊ∏¨
[ÁèæÂú®„ÅÆ„Éö„Éº„Çπ„ÅßÁõÆÊ®ôÈÅîÊàê„Åæ„Åß„ÅÆ‰∫àÊ∏¨Êó•Êï∞„Å®Ê†πÊã†„Çí1-2Êñá„Åß]

## ÊîπÂñÑÊèêÊ°à
1. [ÂÖ∑‰ΩìÁöÑ„Å™„Ç¢„ÇØ„Ç∑„Éß„É≥1]
2. [ÂÖ∑‰ΩìÁöÑ„Å™„Ç¢„ÇØ„Ç∑„Éß„É≥2]
3. [ÂÖ∑‰ΩìÁöÑ„Å™„Ç¢„ÇØ„Ç∑„Éß„É≥3]

## Ê≥®ÊÑèÁÇπ
[Ê∞ó„Çí„Å§„Åë„Çã„Åπ„Åç„Éù„Ç§„É≥„Éà„Çí1-2Êñá„Åß]
`;

            try {
                // „Éá„É¢Áî®„ÅÆ„Ç∑„Éü„É•„É¨„Éº„Ç∑„Éß„É≥ÔºàÂÆüÈöõ„ÅØGemini API„ÇíÂëº„Å≥Âá∫„ÅóÔºâ
                await new Promise(resolve => setTimeout(resolve, 2000));

                // „Éá„É¢Áî®„ÅÆ„É¨„Çπ„Éù„É≥„Çπ
                const demoResponse = `## „Éà„É¨„É≥„ÉâÂàÜÊûê
ÈÅéÂéª${period1}Êó•Èñì„Åß${trend > 0 ? 'Â¢óÂä†' : 'Ê∏õÂ∞ë'}ÂÇæÂêë„Å´„ÅÇ„Çä„Åæ„ÅôÔºà${trend > 0 ? '+' : ''}${trend}${metric.unit}„ÄÅ${trendPercent}%„ÅÆÂ§âÂåñÔºâ„ÄÇ${trend > 0 ? 'È†ÜË™ø„Å™„Éö„Éº„Çπ„ÅßÁõÆÊ®ô„Å´Âêë„Åã„Å£„Å¶„ÅÑ„Åæ„Åô„ÄÇ' : 'ÊîπÂñÑ„ÅÆ‰ΩôÂú∞„Åå„ÅÇ„Çä„Åæ„Åô„ÄÇ'}

## ÁõÆÊ®ôÈÅîÊàê‰∫àÊ∏¨
ÁèæÂú®„ÅÆ„Éö„Éº„ÇπÔºà1Êó•„ÅÇ„Åü„Çä${(trend / period1).toFixed(2)}${metric.unit}Ôºâ„ÇíÁ∂≠ÊåÅ„Åô„Çå„Å∞„ÄÅÁ¥Ñ${Math.ceil((metric.target - data1[data1.length - 1]) / (trend / period1))}Êó•Âæå„Å´ÁõÆÊ®ôÈÅîÊàê„ÅåÂèØËÉΩ„Åß„Åô„ÄÇ„Åü„Å†„Åó„ÄÅ‰ΩìË™ø„ÇÑÁí∞Â¢É„Å´„Çà„ÇäÂ§âÂãï„Åô„ÇãÂèØËÉΩÊÄß„Åå„ÅÇ„Çä„Åæ„Åô„ÄÇ

## ÊîπÂñÑÊèêÊ°à
1. **„Çø„É≥„Éë„ÇØË≥™ÊëÇÂèñ„ÇíÂ¢ó„ÇÑ„Åô**: ‰ΩìÈáç1kg„ÅÇ„Åü„Çä2.0g‰ª•‰∏ä„ÇíÁõÆÊåá„Åó„ÄÅÈ∂è„ÇÄ„Å≠ËÇâ„ÇÑÈ≠ö„ÇíÊØéÈ£ü„Å´Âèñ„ÇäÂÖ•„Çå„Åæ„Åó„Çá„ÅÜ
2. **Á≠ã„Éà„É¨È†ªÂ∫¶„ÇíÈÄ±4-5Âõû„Å´**: BIG3Ôºà„Éô„É≥„ÉÅ„Éó„É¨„Çπ„ÄÅ„Çπ„ÇØ„ÉØ„ÉÉ„Éà„ÄÅ„Éá„ÉÉ„Éâ„É™„Éï„ÉàÔºâ„Çí‰∏≠ÂøÉ„Å´È´òÂº∑Â∫¶„Éà„É¨„Éº„Éã„É≥„Ç∞„ÇíÂÆüÊñΩ
3. **Áù°Áú†ÊôÇÈñì„ÇíÁ¢∫‰øù**: Á≠ãËÇâ„ÅÆÂõûÂæ©„Å®ÊàêÈï∑„Å´„ÅØ7-8ÊôÇÈñì„ÅÆË≥™„ÅÆÈ´ò„ÅÑÁù°Áú†„ÅåÂøÖÈ†à„Åß„Åô

## Ê≥®ÊÑèÁÇπ
„Éá„Éº„Çø„ÅÆÂ§âÂãï„Åå${Math.max(...data1) - Math.min(...data1) > 1 ? 'Â§ß„Åç„ÅÑ' : 'Â∞è„Åï„ÅÑ'}„Åü„ÇÅ„ÄÅ${Math.max(...data1) - Math.min(...data1) > 1 ? 'Ê∏¨ÂÆöÁí∞Â¢É„ÇÑÊôÇÈñì„ÇíÁµ±‰∏Ä„Åô„Çã„Åì„Å®„ÅßÁ≤æÂ∫¶„ÅåÂêë‰∏ä„Åó„Åæ„Åô„ÄÇ' : 'ÂÆâÂÆö„Åó„Åü„Éö„Éº„Çπ„ÇíÁ∂≠ÊåÅ„Åß„Åç„Å¶„ÅÑ„Åæ„Åô„ÄÇ'}Áü≠ÊúüÁöÑ„Å™Â§âÂãï„Å´‰∏ÄÂñú‰∏ÄÊÜÇ„Åõ„Åö„ÄÅÈï∑ÊúüÁöÑ„Å™„Éà„É¨„É≥„Éâ„Å´Ê≥®ÁõÆ„Åó„Åæ„Åó„Çá„ÅÜ„ÄÇ`;

                content.innerHTML = `
                    <div class="prose prose-sm max-w-none">
                        <div class="mb-4 p-3 bg-purple-50 rounded-lg border border-purple-200">
                            <div class="flex items-center gap-2 text-purple-700 font-semibold mb-2">
                                ${metric.name} „ÅÆÂàÜÊûêÁµêÊûú
                            </div>
                            <div class="text-xs text-purple-600">
                                ÊúüÈñì: ÈÅéÂéª${period1}Êó•Èñì | Â§âÂåñ: ${trend > 0 ? '+' : ''}${trend}${metric.unit} (${trendPercent}%)
                            </div>
                        </div>
                        <div class="whitespace-pre-line text-sm text-gray-700 leading-relaxed">
${demoResponse}
                        </div>
                        <div class="mt-6 p-4 bg-blue-50 rounded-lg border border-blue-200">
                            <div class="text-xs text-blue-700">
                                üí° „Åì„ÅÆÂàÜÊûê„ÅØÈÅéÂéª${period1}Êó•Èñì„ÅÆ„Éá„Éº„Çø„Å´Âü∫„Å•„ÅÑ„Å¶„ÅÑ„Åæ„Åô„ÄÇ„Çà„ÇäÊ≠£Á¢∫„Å™‰∫àÊ∏¨„Å´„ÅØ„ÄÅ30Êó•Èñì‰ª•‰∏ä„ÅÆ„Éá„Éº„ÇøËìÑÁ©ç„Çí„Åä„Åô„Åô„ÇÅ„Åó„Åæ„Åô„ÄÇ
                            </div>
                        </div>
                    </div>
                `;

                // „Ç¢„Ç§„Ç≥„É≥„ÇíÂÜçÂàùÊúüÂåñ
                lucide.createIcons();

            } catch (error) {
                content.innerHTML = `
                    <div class="text-center py-8">
                        <div class="text-red-600 mb-2">‚ö†Ô∏è ÂàÜÊûê„Å´Â§±Êïó„Åó„Åæ„Åó„Åü</div>
                        <div class="text-sm text-gray-600">${error.message}</div>
                        <button onclick="closeAnalysisModal()" class="mt-4 px-4 py-2 bg-gray-200 rounded-lg hover:bg-gray-300">
                            Èñâ„Åò„Çã
                        </button>
                    </div>
                `;
            }
        }

        function closeAnalysisModal() {
            document.getElementById('ai-analysis-modal').classList.remove('show');
        }

        // „Éò„É´„Éó„É¢„Éº„ÉÄ„É´
        function openHelpModal() {
            document.getElementById('help-modal').classList.add('show');
            lucide.createIcons();
        }

        function closeHelpModal() {
            document.getElementById('help-modal').classList.remove('show');
        }

        // „ÉÑ„Éº„É´„ÉÅ„ÉÉ„Éó
        const tooltipContent = {
            comparison: `
                <div class="text-sm">
                    <div class="font-bold text-blue-600 mb-2">ÊØîËºÉ„É¢„Éº„Éâ„Å®„ÅØÔºü</div>
                    <p class="mb-2">2„Å§„ÅÆ„Ç∞„É©„Éï„ÇíÂêåÊôÇ„Å´Ë°®Á§∫„Åó„ÄÅÁï∞„Å™„ÇãÊúüÈñì„ÅÆ„Éá„Éº„Çø„ÇíÊØîËºÉ„Åß„Åç„Åæ„Åô„ÄÇ</p>
                    <div class="font-semibold mb-1">‰Ωø„ÅÑÊñπ:</div>
                    <ul class="text-xs space-y-1 pl-4">
                        <li>‚Ä¢ „ÉÅ„Çß„ÉÉ„ÇØ„ÇíON„Å´„Åô„Çã„Å®‰∏ã„Å´„Ç∞„É©„Éï„ÅåËøΩÂä†Ë°®Á§∫</li>
                        <li>‚Ä¢ ‰∏ä‰∏ã„ÅßÁï∞„Å™„ÇãÊúüÈñì„ÇíÈÅ∏ÊäûÂèØËÉΩÔºà‰æã: 7Êó• vs 30Êó•Ôºâ</li>
                        <li>‚Ä¢ Áü≠Êúü„Å®Èï∑Êúü„ÅÆ„Éà„É¨„É≥„ÉâÊØîËºÉ„Å´ÊúÄÈÅ©</li>
                    </ul>
                </div>
            `,
            sync: `
                <div class="text-sm">
                    <div class="font-bold text-purple-600 mb-2">YËª∏ÈÄ£Âãï„Å®„ÅØÔºü</div>
                    <p class="mb-2">‰∏ä„ÅÆ„Ç∞„É©„Éï„ÅÆYËª∏ÁØÑÂõ≤„ÇíÂ§âÊõ¥„Åô„Çã„Å®„ÄÅ‰∏ã„ÅÆ„Ç∞„É©„Éï„ÇÇËá™Âãï„ÅßÂêå„ÅòÁØÑÂõ≤„Å´Ë™øÊï¥„Åï„Çå„ÇãÊ©üËÉΩ„Åß„Åô„ÄÇ</p>
                    <div class="font-semibold mb-1">„É°„É™„ÉÉ„Éà:</div>
                    <ul class="text-xs space-y-1 pl-4">
                        <li>‚Ä¢ Âêå„Åò„Çπ„Ç±„Éº„É´„ÅßÊØîËºÉ„Åß„Åç„Çã</li>
                        <li>‚Ä¢ Êï∞ÂÄ§„ÅÆÂ§ßÂ∞è„ÇíÁõ¥ÊÑüÁöÑ„Å´ÊØîËºÉ</li>
                        <li>‚Ä¢ „ÉØ„É≥„ÇØ„É™„ÉÉ„ÇØ„ÅßON/OFFÂàáÊõøÂèØËÉΩ</li>
                    </ul>
                </div>
            `
        };

        let tooltipTimeout;
        function showTooltip(event, type) {
            clearTimeout(tooltipTimeout);
            const tooltip = document.getElementById('tooltip');
            tooltip.innerHTML = tooltipContent[type];
            tooltip.classList.add('show');

            // ‰ΩçÁΩÆË™øÊï¥
            const rect = event.target.getBoundingClientRect();
            tooltip.style.position = 'fixed';
            tooltip.style.left = rect.left + 'px';
            tooltip.style.top = (rect.bottom + 10) + 'px';
        }

        function hideTooltip() {
            tooltipTimeout = setTimeout(() => {
                document.getElementById('tooltip').classList.remove('show');
            }, 200);
        }

        // ÊØîËºÉ„É¢„Éº„ÉâÂàá„ÇäÊõø„Åà
        function toggleComparisonMode() {
            // „Éë„Éç„É´„Åæ„Åü„ÅØ„É°„Ç§„É≥ÁîªÈù¢„ÅÆ„ÉÅ„Çß„ÉÉ„ÇØ„Éú„ÉÉ„ÇØ„Çπ„Åã„ÇâÁä∂ÊÖã„ÇíÂèñÂæó
            const comparisonModePanelElement = document.getElementById('comparison-mode-panel');
            const comparisonModeElement = document.getElementById('comparison-mode');
            const chart2Element = document.getElementById('chart-2');

            if (!chart2Element) {
                console.warn('Chart 2Ë¶ÅÁ¥†„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì');
                return;
            }

            // „Éë„Éç„É´„ÅÆË¶ÅÁ¥†„Åå„ÅÇ„Çå„Å∞„Åù„Å°„Çâ„Çí‰ΩøÁî®„ÄÅ„Å™„Åë„Çå„Å∞„É°„Ç§„É≥„ÅÆË¶ÅÁ¥†„Çí‰ΩøÁî®
            const checkboxElement = comparisonModePanelElement || comparisonModeElement;
            if (!checkboxElement) {
                console.warn('ÊØîËºÉ„É¢„Éº„ÉâË¶ÅÁ¥†„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì');
                return;
            }

            comparisonMode = checkboxElement.checked;

            // ‰∏°Êñπ„ÅÆ„ÉÅ„Çß„ÉÉ„ÇØ„Éú„ÉÉ„ÇØ„Çπ„ÇíÂêåÊúü
            if (comparisonModePanelElement) comparisonModePanelElement.checked = comparisonMode;
            if (comparisonModeElement) comparisonModeElement.checked = comparisonMode;

            chart2Element.classList.toggle('hidden', !comparisonMode);

            if (comparisonMode) {
                // ÊØîËºÉ„É¢„Éº„ÉâONÊôÇ„ÄÅYËª∏ÈÄ£Âãï„ÅåON„Å™„ÇâÂêå„ÅòÁØÑÂõ≤„ÇíÈÅ©Áî®
                if (axisSync && currentAxisRanges[1].min !== null) {
                    const axisMin2Element = document.getElementById('axis-min-2');
                    const axisMax2Element = document.getElementById('axis-max-2');

                    currentAxisRanges[2] = { ...currentAxisRanges[1] };
                    if (axisMin2Element) axisMin2Element.value = currentAxisRanges[1].min;
                    if (axisMax2Element) axisMax2Element.value = currentAxisRanges[1].max;
                }
                updateChart(2);
                updateChart2PeriodButtons();
            }
        }

        // Â§ß„Ç´„ÉÜ„Ç¥„É™ÈÅ∏ÊäûÔºà„Éá„É¢Áî® - ÂÆüÈöõ„Å´„ÅØÂêÑ„Ç´„ÉÜ„Ç¥„É™„ÅÆ„Ç≥„É≥„ÉÜ„É≥„ÉÑ„ÇíË°®Á§∫Ôºâ
        function selectMainCategory(category, event) {
            currentMainCategory = category;

            // „Ç´„ÉÜ„Ç¥„É™„Åî„Å®„ÅÆËâ≤Ë®≠ÂÆöÔºàÁîªÂÉèÈÄö„ÇäÔºâ
            const categoryColors = {
                nutrition: 'text-green-600',      // È£ü‰∫ã: Á∑ë
                training: 'text-orange-600',      // ÈÅãÂãï: „Ç™„É¨„É≥„Ç∏
                condition: 'text-red-600',        // „Ç≥„É≥„Éá„Ç£„Ç∑„Éß„É≥: Ëµ§
                performance: 'text-purple-600'    // „Éë„Éï„Ç©„Éº„Éû„É≥„Çπ: Á¥´
            };

            // „Çø„Éñ„ÅÆ„Ç¢„ÇØ„ÉÜ„Ç£„ÉñÁä∂ÊÖã„ÇíÊõ¥Êñ∞
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active', 'text-green-600', 'text-orange-600', 'text-red-600', 'text-purple-600', 'bg-white', 'border-b-0');
                btn.classList.add('text-gray-600');
            });

            const colorClass = categoryColors[category] || 'text-purple-600';
            // „Ç§„Éô„É≥„Éà„ÅåÊ∏°„Åï„Çå„Å¶„ÅÑ„ÇãÂ†¥Âêà„ÅØevent.currentTarget„Çí‰ΩøÁî®„ÄÅ„Åù„Çå‰ª•Â§ñ„ÅØË©≤ÂΩì„Åô„Çã„Éú„Çø„É≥„ÇíÊ§úÁ¥¢
            const targetButton = event ? event.currentTarget : document.querySelector(`.tab-button[onclick*="${category}"]`);
            if (targetButton) {
                targetButton.classList.add('active', colorClass, 'bg-white', 'border-b-0');
                targetButton.classList.remove('text-gray-600');
            }

            // „Åô„Åπ„Å¶„ÅÆ„Çµ„Éñ„Çø„Éñ„ÇíÈùûË°®Á§∫
            document.querySelectorAll('.sub-tabs').forEach(tab => {
                tab.classList.add('hidden');
            });

            // ÈÅ∏Êäû„Åï„Çå„Åü„Ç´„ÉÜ„Ç¥„É™„ÅÆ„Çµ„Éñ„Çø„Éñ„ÇíË°®Á§∫
            const subtabs = document.getElementById(`${category}-subtabs`);
            if (subtabs) {
                subtabs.classList.remove('hidden');
            }

            // ÂêÑ„Ç´„ÉÜ„Ç¥„É™„ÅÆÊúÄÂàù„ÅÆÊåáÊ®ô„ÇíÈÅ∏Êäû
            const firstMetrics = {
                nutrition: 'calories',
                training: 'workout_duration',
                condition: 'weight',
                performance: 'lbm'
            };

            // ÊúÄÂàù„ÅÆ„Çµ„Éñ„Ç´„ÉÜ„Ç¥„É™„ÇíÈÅ∏Êäû
            if (firstMetrics[category]) {
                selectSubCategory(category, firstMetrics[category]);
            }

            // „Ç¢„Ç§„Ç≥„É≥„ÇíÂÜçÊèèÁîª
            lucide.createIcons();
        }

        // ÊúüÈñìÈÅ∏Êäû
        function selectPeriod(chartNum, days) {
            currentPeriods[chartNum] = days;

            // „Çø„Éñ„ÅÆ„Ç¢„ÇØ„ÉÜ„Ç£„ÉñÁä∂ÊÖã„ÇíÊõ¥Êñ∞ÔºàÊñ∞„Åó„ÅÑ„Çπ„Çø„Ç§„É´Ôºâ
            const container = chartNum === 1 ? document.getElementById('chart-1') : document.getElementById('chart-2');
            container.querySelectorAll('.period-button').forEach(btn => {
                btn.classList.remove('active', 'bg-white', 'text-purple-700', 'shadow-sm');
                btn.classList.add('text-gray-600');
            });
            event.currentTarget.classList.add('active', 'bg-white', 'text-purple-700', 'shadow-sm');
            event.currentTarget.classList.remove('text-gray-600');

            updateChart(chartNum);

            // „Ç∞„É©„Éï1„ÅÆÊúüÈñì„ÅåÂ§âÊõ¥„Åï„Çå„ÅüÂ†¥Âêà„ÄÅ„Ç∞„É©„Éï2„ÅÆÊúüÈñì„Éú„Çø„É≥„ÇíÊõ¥Êñ∞
            if (chartNum === 1 && comparisonMode) {
                updateChart2PeriodButtons();
            }
        }

        // ÊúüÈñìÁØÑÂõ≤ÈÅ∏ÊäûÔºà‰ªäÈÄ±„ÄÅÂÖàÈÄ±„ÄÅ‰ªäÊúà„ÄÅÂÖàÊúàÔºâ
        function selectPeriodRange(chartNum, rangeType) {
            const today = new Date();
            let startDate, endDate, days;

            switch(rangeType) {
                case 'thisWeek':
                    // ‰ªäÈÄ±ÔºàÊúàÊõúÊó•ÔΩûÊó•ÊõúÊó•Ôºâ
                    const dayOfWeek = today.getDay();
                    const diffToMonday = dayOfWeek === 0 ? 6 : dayOfWeek - 1; // ÊúàÊõú„ÇíÈÄ±„ÅÆÈñãÂßã„Å®„Åô„Çã
                    startDate = new Date(today);
                    startDate.setDate(today.getDate() - diffToMonday);
                    endDate = today;
                    days = Math.ceil((endDate - startDate) / (1000 * 60 * 60 * 24)) + 1;
                    break;

                case 'lastWeek':
                    // ÂÖàÈÄ±ÔºàÂÖàÈÄ±„ÅÆÊúàÊõúÊó•ÔΩûÊó•ÊõúÊó•Ôºâ
                    const lastWeekEnd = new Date(today);
                    const daysToLastSunday = today.getDay() === 0 ? 0 : today.getDay();
                    lastWeekEnd.setDate(today.getDate() - daysToLastSunday);
                    startDate = new Date(lastWeekEnd);
                    startDate.setDate(lastWeekEnd.getDate() - 6);
                    days = 7;
                    break;

                case 'thisMonth':
                    // ‰ªäÊúàÔºà1Êó•ÔΩû‰ªäÊó•Ôºâ
                    startDate = new Date(today.getFullYear(), today.getMonth(), 1);
                    endDate = today;
                    days = today.getDate();
                    break;

                case 'lastMonth':
                    // ÂÖàÊúàÔºàÂÖàÊúà„ÅÆ1Êó•ÔΩûÊú´Êó•Ôºâ
                    const lastMonthDate = new Date(today.getFullYear(), today.getMonth() - 1, 1);
                    const lastMonthEnd = new Date(today.getFullYear(), today.getMonth(), 0);
                    days = lastMonthEnd.getDate();
                    break;
            }

            currentPeriods[chartNum] = days;

            // „Çø„Éñ„ÅÆ„Ç¢„ÇØ„ÉÜ„Ç£„ÉñÁä∂ÊÖã„ÇíÊõ¥Êñ∞ÔºàÊñ∞„Åó„ÅÑ„Çπ„Çø„Ç§„É´Ôºâ
            const container = chartNum === 1 ? document.getElementById('chart-1') : document.getElementById('chart-2');
            container.querySelectorAll('.period-button').forEach(btn => {
                btn.classList.remove('active', 'bg-white', 'text-purple-700', 'shadow-sm');
                btn.classList.add('text-gray-600');
            });
            event.currentTarget.classList.add('active', 'bg-white', 'text-purple-700', 'shadow-sm');
            event.currentTarget.classList.remove('text-gray-600');

            updateChart(chartNum);

            // „Ç∞„É©„Éï1„ÅÆÊúüÈñì„ÅåÂ§âÊõ¥„Åï„Çå„ÅüÂ†¥Âêà„ÄÅ„Ç∞„É©„Éï2„ÅÆÊúüÈñì„Éú„Çø„É≥„ÇíÊõ¥Êñ∞
            if (chartNum === 1 && comparisonMode) {
                updateChart2PeriodButtons();
            }
        }

        // „Ç∞„É©„Éï2„ÅÆÊúüÈñì„Éú„Çø„É≥„ÇíÊõ¥Êñ∞Ôºà„Ç∞„É©„Éï1„Å®Âêå„ÅòÊúüÈñì„ÇíÁÑ°ÂäπÂåñÔºâ
        function updateChart2PeriodButtons() {
            const chart2Container = document.getElementById('chart-2');
            const buttons = chart2Container.querySelectorAll('.period-button');

            buttons.forEach(btn => {
                const btnText = btn.textContent;
                const days = parseInt(btnText);

                if (days === currentPeriods[1]) {
                    btn.disabled = true;
                    btn.classList.add('opacity-50', 'cursor-not-allowed');
                    btn.onclick = null;
                } else {
                    btn.disabled = false;
                    btn.classList.remove('opacity-50', 'cursor-not-allowed');
                    // onclick „ÇíÂæ©ÂÖÉ
                    const dayValue = btnText === '7Êó•Èñì' ? 7 : btnText === '14Êó•Èñì' ? 14 : btnText === '30Êó•Èñì' ? 30 : 90;
                    btn.onclick = () => selectPeriod(2, dayValue);
                }
            });
        }

        // YËª∏„É¨„É≥„Ç∏„Çí„É™„Çª„ÉÉ„Éà
        function resetAxisRange(chartNum) {
            const axisMinElement = document.getElementById(`axis-min-${chartNum}`);
            const axisMaxElement = document.getElementById(`axis-max-${chartNum}`);

            if (axisMinElement && axisMaxElement) {
                axisMinElement.value = globalMinMax.min;
                axisMaxElement.value = globalMinMax.max;
                updateAxisRange(chartNum);
            }
        }

        // YËª∏„É¨„É≥„Ç∏„ÇíÊõ¥Êñ∞
        function updateAxisRange(chartNum) {
            const axisMinElement = document.getElementById(`axis-min-${chartNum}`);
            const axisMaxElement = document.getElementById(`axis-max-${chartNum}`);

            if (!axisMinElement || !axisMaxElement) {
                console.warn(`YËª∏„É¨„É≥„Ç∏Ë¶ÅÁ¥†„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì: chart ${chartNum}`);
                return;
            }

            const min = parseFloat(axisMinElement.value);
            const max = parseFloat(axisMaxElement.value);

            if (!isNaN(min) && !isNaN(max) && min < max) {
                currentAxisRanges[chartNum] = { min, max };

                // „Ç∞„É©„Éï„ÇíÊõ¥Êñ∞
                if (charts[chartNum]) {
                    charts[chartNum].options.scales.y.min = min;
                    charts[chartNum].options.scales.y.max = max;
                    charts[chartNum].update();
                }

                // YËª∏ÈÄ£Âãï„ÅåON„Åß„ÄÅ„Ç∞„É©„Éï1„ÅÆÂ§âÊõ¥„Å™„Çâ„ÄÅ„Ç∞„É©„Éï2„ÇÇÂêåÊúü
                if (axisSync && chartNum === 1 && comparisonMode) {
                    const axisMin2Element = document.getElementById('axis-min-2');
                    const axisMax2Element = document.getElementById('axis-max-2');

                    currentAxisRanges[2] = { min, max };
                    if (axisMin2Element) axisMin2Element.value = min;
                    if (axisMax2Element) axisMax2Element.value = max;

                    if (charts[2]) {
                        charts[2].options.scales.y.min = min;
                        charts[2].options.scales.y.max = max;
                        charts[2].update();
                    }

                    // ÂêåÊúü„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥
                    const icon = document.querySelector('.sync-icon');
                    if (icon) {
                        icon.classList.add('syncing');
                        setTimeout(() => icon.classList.remove('syncing'), 1000);
                    }
                    lucide.createIcons();
                }
            }
        }

        // „Ç∞„É©„ÉïÊõ¥Êñ∞
        function updateChart(chartNum) {
            const days = currentPeriods[chartNum];

            // Chart2„ÅßÊØîËºÉ„É¢„Éº„Éâ„ÅÆÂ†¥Âêà„ÅØ„ÄÅchart2Category„Çí‰ΩøÁî®
            const categoryToUse = (chartNum === 2 && comparisonMode) ? chart2Category : currentSubCategory;

            const data = generateData(days)[categoryToUse];
            const labels = generateLabels(days);
            const metric = metricInfo[categoryToUse];

            // „Éá„Éº„Çø„Çí‰øùÂ≠ò
            currentData[chartNum] = data;

            // „Çø„Ç§„Éà„É´Êõ¥Êñ∞
            document.getElementById(`chart-title-${chartNum}`).textContent = `${metric.name}${chartNum === 2 ? ' - ÊØîËºÉ' : ''}`;
            document.getElementById(`chart-period-${chartNum}`).textContent = `ÈÅéÂéª${days}Êó•Èñì„ÅÆÊé®Áßª`;

            // „Ç´„ÉÜ„Ç¥„É™Âà•„ÅÆÊúÄ‰ΩéÂÄ§„ÉªÊúÄÈ´òÂÄ§„ÇíË®àÁÆó„Åó„Å¶Ë°®Á§∫ÔºàÂÖ®ÊúüÈñì90Êó•Ôºâ
            const categoryMinElement = document.getElementById(`category-min-${chartNum}`);
            const categoryMaxElement = document.getElementById(`category-max-${chartNum}`);
            const categoryUnitElement = document.getElementById(`category-unit-${chartNum}`);

            if (categoryMinElement && categoryMaxElement && categoryUnitElement) {
                const fullData = generateData(90)[categoryToUse];
                const categoryMin = Math.min(...fullData);
                const categoryMax = Math.max(...fullData);
                categoryMinElement.textContent = categoryMin.toFixed(1);
                categoryMaxElement.textContent = categoryMax.toFixed(1);
                categoryUnitElement.textContent = metric.unit;
            }

            // ÂÄ§„ÅÆË°®Á§∫Ôºà„Éê„Ç§„Éä„É™„ÅÆÂ†¥Âêà„ÅØÂÆå‰∫Ü/Êú™ÂÆå‰∫ÜÔºâ
            const currentValue = data[data.length - 1];
            if (metric.isBinary) {
                document.getElementById(`chart-value-${chartNum}`).textContent = currentValue === 1 ? '‚úì ÂÆå‰∫Ü' : '‚úó Êú™ÂÆå‰∫Ü';
                document.getElementById(`chart-unit-${chartNum}`).textContent = '';
            } else {
                document.getElementById(`chart-value-${chartNum}`).textContent = `${currentValue.toFixed(1)}${metric.unit}`;
                document.getElementById(`chart-unit-${chartNum}`).textContent = '';
            }

            // Áµ±Ë®àË®àÁÆó
            if (metric.isBinary) {
                // „Éê„Ç§„Éä„É™„Éá„Éº„ÇøÔºàÊåáÁ§∫Êõ∏Ôºâ„ÅÆÂ†¥Âêà„ÅØÂÆå‰∫ÜÁéá„ÇíË°®Á§∫
                const completionRate = ((data.reduce((a, b) => a + b, 0) / data.length) * 100).toFixed(0);
                document.getElementById(`stat-avg-${chartNum}`).textContent = `${completionRate}%`;
                document.getElementById(`stat-avg-unit-${chartNum}`).textContent = '';
                document.getElementById(`stat-max-${chartNum}`).textContent = `${data.filter(v => v === 1).length}Êó•`;
                document.getElementById(`stat-max-unit-${chartNum}`).textContent = '';
                document.getElementById(`stat-min-${chartNum}`).textContent = `${data.filter(v => v === 0).length}Êó•`;
                document.getElementById(`stat-min-unit-${chartNum}`).textContent = '';
            } else {
                const avg = (data.reduce((a, b) => a + b, 0) / data.length).toFixed(1);
                const max = Math.max(...data).toFixed(1);
                const min = Math.min(...data).toFixed(1);

                const avgText = `${avg}${metric.unit}`;
                const maxText = `${max}${metric.unit}`;
                const minText = `${min}${metric.unit}`;

                console.log(`Chart ${chartNum} stats:`, { avgText, maxText, minText, metric: metric.name });

                document.getElementById(`stat-avg-${chartNum}`).textContent = avgText;
                document.getElementById(`stat-max-${chartNum}`).textContent = maxText;
                document.getElementById(`stat-min-${chartNum}`).textContent = minText;
                document.getElementById(`stat-avg-unit-${chartNum}`).textContent = '';
                document.getElementById(`stat-max-unit-${chartNum}`).textContent = '';
                document.getElementById(`stat-min-unit-${chartNum}`).textContent = '';
            }

            // YËª∏„É¨„É≥„Ç∏Ë®≠ÂÆöÔºà„Éá„Éº„Çø„Å´Âü∫„Å•„ÅÑ„Å¶Ëá™ÂãïË™øÊï¥Ôºâ
            // Chart2„ÅßÁï∞„Å™„Çã„Ç´„ÉÜ„Ç¥„É™„Çí‰ΩøÁî®„Åô„ÇãÂ†¥Âêà„ÅØ„ÄÅ„Åù„ÅÆ„Ç´„ÉÜ„Ç¥„É™„ÅÆglobalMinMax„ÇíË®àÁÆó
            const currentGlobalMinMax = (chartNum === 2 && comparisonMode && categoryToUse !== currentSubCategory)
                ? calculateGlobalMinMax(categoryToUse)
                : globalMinMax;

            if (!currentAxisRanges[chartNum].min || currentAxisRanges[chartNum].min === currentGlobalMinMax.min) {
                // ÁèæÂú®Ë°®Á§∫„Åó„Å¶„ÅÑ„Çã„Éá„Éº„Çø„ÅÆÁØÑÂõ≤„ÇíÂèñÂæó
                const validData = data.filter(v => v > 0);
                if (validData.length > 0 && !metric.isBinary) {
                    const dataMin = Math.min(...validData);
                    const dataMax = Math.max(...validData);
                    const dataRange = dataMax - dataMin;

                    // ÈÅ©Âàá„Å™„Éû„Éº„Ç∏„É≥„ÇíË®≠ÂÆöÔºà„Éá„Éº„ÇøÁØÑÂõ≤„ÅÆ20%Ôºâ
                    const margin = Math.max(dataRange * 0.2, 0.5);

                    currentAxisRanges[chartNum] = {
                        min: Math.floor((dataMin - margin) * 10) / 10,
                        max: Math.ceil((dataMax + margin) * 10) / 10
                    };
                } else {
                    currentAxisRanges[chartNum] = { ...currentGlobalMinMax };
                }

                // Ëª∏ÂÖ•Âäõ„Éï„Ç£„Éº„É´„Éâ„ÅåÂ≠òÂú®„Åô„ÇãÂ†¥Âêà„ÅÆ„ÅøÂÄ§„ÇíË®≠ÂÆö
                const axisMinElement = document.getElementById(`axis-min-${chartNum}`);
                const axisMaxElement = document.getElementById(`axis-max-${chartNum}`);
                if (axisMinElement) axisMinElement.value = currentAxisRanges[chartNum].min;
                if (axisMaxElement) axisMaxElement.value = currentAxisRanges[chartNum].max;
            }

            // „Ç∞„É©„ÉïÊèèÁîª
            if (charts[chartNum]) charts[chartNum].destroy();

            const chartType = metric.isBinary ? 'bar' : 'line';

            // ÁõÆÊ®ô„É©„Ç§„É≥„Å®„É°„É¢„Éû„Éº„Ç´„Éº„ÅÆ„Ç¢„Éé„ÉÜ„Éº„Ç∑„Éß„É≥Ë®≠ÂÆö
            const chartAnnotations = {};

            // ÁõÆÊ®ô„É©„Ç§„É≥
            const goal = goals[categoryToUse];
            if (goal && goal.showLine && !metric.isBinary) {
                chartAnnotations.goalLine = {
                    type: 'line',
                    yMin: goal.value,
                    yMax: goal.value,
                    borderColor: 'rgb(34, 197, 94)', // green-500
                    borderWidth: 2,
                    borderDash: [6, 6],
                    label: {
                        display: true,
                        content: `ÁõÆÊ®ô: ${goal.value}${metric.unit}`,
                        position: 'end',
                        backgroundColor: 'rgba(34, 197, 94, 0.8)',
                        color: 'white',
                        font: {
                            size: 11,
                            weight: 'bold'
                        },
                        padding: 4
                    }
                };
            }

            // „É°„É¢„Éû„Éº„Ç´„Éº
            const markers = getAnnotationMarkers(chartNum, categoryToUse);
            Object.assign(chartAnnotations, markers);

            // „Éá„Éº„Çø„Çª„ÉÉ„Éà„ÅÆÈÖçÂàó„ÇíÊßãÁØâ
            const datasets = [{
                label: metric.name,
                data: data,
                borderColor: chartNum === 1 ? 'rgb(168, 85, 247)' : 'rgb(59, 130, 246)',
                backgroundColor: chartNum === 1 ? 'rgba(168, 85, 247, 0.6)' : 'rgba(59, 130, 246, 0.6)',
                fill: !metric.isBinary,
                tension: 0.4,
                yAxisID: 'y'
            }];

            // ÁßªÂãïÂπ≥ÂùáÁ∑ö„ÇíËøΩÂä†
            if (showMovingAverage[chartNum] && !metric.isBinary) {
                const maData = calculateMovingAverage(data, movingAveragePeriod[chartNum]);
                datasets.push({
                    label: `${metric.name}Ôºà${movingAveragePeriod[chartNum]}Êó•ÁßªÂãïÂπ≥ÂùáÔºâ`,
                    data: maData,
                    borderColor: chartNum === 1 ? 'rgb(251, 146, 60)' : 'rgb(14, 165, 233)',
                    backgroundColor: 'transparent',
                    borderWidth: 2,
                    borderDash: [5, 5],
                    fill: false,
                    tension: 0.4,
                    pointRadius: 0,
                    yAxisID: 'y'
                });
            }

            // ‰∫àÊ∏¨Á∑ö„ÇíËøΩÂä†
            if (showPrediction[chartNum] && !metric.isBinary && data.length >= 3) {
                const predictionData = calculatePrediction(data, 7);
                const predictionLabels = [...labels];
                for (let i = 1; i <= 7; i++) {
                    predictionLabels.push(`+${i}Êó•`);
                }

                datasets.push({
                    label: `${metric.name}Ôºà‰∫àÊ∏¨Ôºâ`,
                    data: predictionData,
                    borderColor: 'rgb(34, 197, 94)',
                    backgroundColor: 'transparent',
                    borderWidth: 2,
                    borderDash: [10, 5],
                    fill: false,
                    tension: 0.1,
                    pointRadius: 0,
                    yAxisID: 'y'
                });

                // „É©„Éô„É´„ÇíÊõ¥Êñ∞
                labels = predictionLabels;
            }

            // „ÇØ„É≠„Çπ„Éò„Ç¢„Éó„É©„Ç∞„Ç§„É≥
            const crosshairPlugin = {
                id: 'crosshair',
                afterDatasetsDraw: (chart) => {
                    if (chart.crosshair && chart.crosshair.draw) {
                        const ctx = chart.ctx;
                        const x = chart.crosshair.x;
                        const y = chart.crosshair.y;
                        const chartArea = chart.chartArea;

                        ctx.save();
                        ctx.strokeStyle = 'rgba(147, 51, 234, 0.6)';
                        ctx.lineWidth = 1;
                        ctx.setLineDash([5, 5]);

                        // Á∏¶Á∑ö
                        ctx.beginPath();
                        ctx.moveTo(x, chartArea.top);
                        ctx.lineTo(x, chartArea.bottom);
                        ctx.stroke();

                        // Ê®™Á∑ö
                        ctx.beginPath();
                        ctx.moveTo(chartArea.left, y);
                        ctx.lineTo(chartArea.right, y);
                        ctx.stroke();

                        ctx.restore();
                    }
                }
            };

            const chartConfig = {
                type: chartType,
                data: {
                    labels: labels,
                    datasets: datasets
                },
                plugins: [crosshairPlugin],
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    onClick: (event, activeElements) => {
                        if (activeElements.length > 0) {
                            const datasetIndex = activeElements[0].datasetIndex;
                            const index = activeElements[0].index;
                            const dataset = chartConfig.data.datasets[datasetIndex];

                            // „É°„Ç§„É≥„Éá„Éº„Çø„Çª„ÉÉ„Éà„ÅÆÂ†¥Âêà„ÅÆ„Åø„Éâ„É™„É´„ÉÄ„Ç¶„É≥
                            if (datasetIndex === 0 && index < data.length) {
                                showDrillDownModal(chartNum, index, labels[index], data[index], metric);
                            }
                        }
                    },
                    layout: {
                        padding: {
                            left: 10,
                            right: 20,
                            top: 20,
                            bottom: 10
                        }
                    },
                    plugins: {
                        legend: {
                            display: datasets.length > 1,
                            position: 'top',
                            labels: {
                                boxWidth: 12,
                                font: { size: 10 },
                                padding: 8
                            }
                        },
                        tooltip: {
                            enabled: true,
                            mode: 'index',
                            intersect: false,
                            callbacks: {
                                label: function(context) {
                                    const label = context.dataset.label || '';
                                    const value = context.formattedValue;
                                    const unit = metric.unit || '';
                                    const index = context.dataIndex;
                                    const chartLabel = context.chart.data.labels[index];
                                    const key = `${categoryToUse}_${chartLabel}`;

                                    if (annotations[key]) {
                                        return [
                                            `${label}: ${value}${unit}`,
                                            '',
                                            `üìù „É°„É¢: ${annotations[key].note}`
                                        ];
                                    }

                                    return `${label}: ${value}${unit}`;
                                }
                            }
                        },
                        annotation: {
                            annotations: chartAnnotations
                        }
                    },
                    interaction: {
                        mode: 'index',
                        intersect: false
                    },
                    onHover: (event, activeElements, chart) => {
                        // „Éû„Ç¶„Çπ„Éõ„Éê„ÉºÊôÇ„Å´„ÇØ„É≠„Çπ„Éò„Ç¢„ÇíË°®Á§∫
                        const canvasPosition = Chart.helpers.getRelativePosition(event, chart);

                        if (canvasPosition.x >= chart.chartArea.left &&
                            canvasPosition.x <= chart.chartArea.right &&
                            canvasPosition.y >= chart.chartArea.top &&
                            canvasPosition.y <= chart.chartArea.bottom) {

                            chart.crosshair = {
                                x: canvasPosition.x,
                                y: canvasPosition.y,
                                draw: true
                            };
                        } else {
                            chart.crosshair = { draw: false };
                        }

                        chart.draw();
                    },
                    scales: (() => {
                        const scales = {
                            y: {
                                type: 'linear',
                                display: true,
                                position: 'left',
                                beginAtZero: false,
                                min: currentAxisRanges[chartNum].min,
                                max: currentAxisRanges[chartNum].max,
                                ticks: metric.isBinary ? {
                                    stepSize: 1,
                                    callback: function(value) {
                                        return value === 1 ? 'ÂÆå‰∫Ü' : value === 0 ? 'Êú™ÂÆå‰∫Ü' : '';
                                    }
                                } : {
                                    padding: 10,
                                    font: {
                                        size: 11
                                    }
                                },
                                grid: {
                                    drawBorder: true,
                                    color: 'rgba(0, 0, 0, 0.1)'
                                }
                            },
                            x: {
                                ticks: {
                                    padding: 5,
                                    font: {
                                        size: 11
                                    }
                                },
                                grid: {
                                    display: false
                                }
                            }
                        };

                        return scales;
                    })()
                }
            };

            charts[chartNum] = new Chart(document.getElementById(`main-chart-${chartNum}`), chartConfig);
        }

        // Â∞è„Ç´„ÉÜ„Ç¥„É™ÈÅ∏Êäû
        function selectSubCategory(category, subCategory) {
            currentSubCategory = subCategory;

            // ÂÖ®ÊúüÈñì„ÅÆÊúÄ‰ΩéÂÄ§„ÉªÊúÄÂ§ßÂÄ§„ÇíÂÜçË®àÁÆó
            globalMinMax = calculateGlobalMinMax(subCategory);

            // YËª∏„É¨„É≥„Ç∏„Çí„É™„Çª„ÉÉ„Éà
            currentAxisRanges = { 1: { min: null, max: null }, 2: { min: null, max: null } };

            // „Ç´„ÉÜ„Ç¥„É™Âà•„ÅÆËâ≤Ë®≠ÂÆöÔºàÁîªÂÉèÈÄö„ÇäÔºâ
            const categoryColors = {
                nutrition: { border: 'border-green-500', text: 'text-green-700' },   // È£ü‰∫ã: Á∑ë
                training: { border: 'border-orange-500', text: 'text-orange-700' },  // ÈÅãÂãï: „Ç™„É¨„É≥„Ç∏
                condition: { border: 'border-red-500', text: 'text-red-700' },       // „Ç≥„É≥„Éá„Ç£„Ç∑„Éß„É≥: Ëµ§
                performance: { border: 'border-purple-500', text: 'text-purple-700' }// „Éë„Éï„Ç©„Éº„Éû„É≥„Çπ: Á¥´
            };

            const colors = categoryColors[category] || categoryColors.performance;

            // ÁèæÂú®„ÅÆ„Ç´„ÉÜ„Ç¥„É™„ÅÆ„Çµ„Éñ„Çø„Éñ„Éú„Çø„É≥„ÅÆ„Åø„ÇíÊõ¥Êñ∞
            const subtabContainer = document.getElementById(`${category}-subtabs`);
            if (subtabContainer) {
                subtabContainer.querySelectorAll('.sub-tab-button').forEach(btn => {
                    btn.classList.remove('active', 'border-orange-500', 'text-orange-700', 'border-green-500', 'text-green-700', 'border-red-500', 'text-red-700', 'border-purple-500', 'text-purple-700');
                    btn.classList.add('border-transparent', 'text-gray-700');
                });

                if (event && event.currentTarget) {
                    event.currentTarget.classList.add('active', colors.border, colors.text);
                    event.currentTarget.classList.remove('border-transparent', 'text-gray-700');
                }
            }

            updateChart(1);
            if (comparisonMode) {
                updateChart(2);
            }
        }

        // ÁõÆÊ®ô„Éá„Éº„Çø„ÅÆË™≠„ÅøËæº„Åø
        function loadGoals() {
            try {
                const stored = localStorage.getItem('fitness_goals');
                if (stored) {
                    goals = JSON.parse(stored);
                }
            } catch (error) {
                console.error('ÁõÆÊ®ô„Éá„Éº„Çø„ÅÆË™≠„ÅøËæº„Åø„Ç®„É©„Éº:', error);
                goals = {};
            }
        }

        // ÁõÆÊ®ô„Éá„Éº„Çø„ÅÆ‰øùÂ≠ò
        function saveGoalsToStorage() {
            try {
                localStorage.setItem('fitness_goals', JSON.stringify(goals));
            } catch (error) {
                console.error('ÁõÆÊ®ô„Éá„Éº„Çø„ÅÆ‰øùÂ≠ò„Ç®„É©„Éº:', error);
            }
        }

        // ÁõÆÊ®ôË®≠ÂÆö„É¢„Éº„ÉÄ„É´„ÇíÈñã„Åè
        function openGoalSettingModal() {
            const modal = document.getElementById('goal-setting-modal');
            const metricSelect = document.getElementById('goal-metric');

            // ÁèæÂú®„ÅÆÊåáÊ®ô„ÇíÈÅ∏ÊäûÁä∂ÊÖã„Å´„Åô„Çã
            metricSelect.value = currentSubCategory;
            updateGoalUnit();

            // Êó¢Â≠ò„ÅÆÁõÆÊ®ô„Çí„É≠„Éº„Éâ
            loadCurrentGoal();

            modal.classList.add('show');
            lucide.createIcons();
        }

        function closeGoalSettingModal() {
            document.getElementById('goal-setting-modal').classList.remove('show');
        }

        // ÊåáÊ®ô„Å´Âøú„Åò„Å¶Âçò‰Ωç„ÇíÊõ¥Êñ∞
        document.getElementById('goal-metric')?.addEventListener('change', updateGoalUnit);

        function updateGoalUnit() {
            const metricSelect = document.getElementById('goal-metric');
            const selectedMetric = metricSelect.value;
            const metric = metricInfo[selectedMetric];
            document.getElementById('goal-unit').textContent = metric.unit;
            loadCurrentGoal();
        }

        // ÁèæÂú®„ÅÆÁõÆÊ®ô„ÇíË°®Á§∫
        function loadCurrentGoal() {
            const metricSelect = document.getElementById('goal-metric');
            const selectedMetric = metricSelect.value;
            const goal = goals[selectedMetric];
            const infoDiv = document.getElementById('current-goal-info');
            const textDiv = document.getElementById('current-goal-text');

            if (goal) {
                const metric = metricInfo[selectedMetric];
                let text = `ÁõÆÊ®ôÂÄ§: ${goal.value}${metric.unit}`;
                if (goal.date) {
                    text += `<br>ÈÅîÊàê‰∫àÂÆöÊó•: ${goal.date}`;
                }
                text += `<br>„Ç∞„É©„ÉïË°®Á§∫: ${goal.showLine ? 'ON' : 'OFF'}`;

                textDiv.innerHTML = text;
                infoDiv.classList.remove('hidden');

                // „Éï„Ç©„Éº„É†„Å´ÂÄ§„ÇíË®≠ÂÆö
                document.getElementById('goal-value').value = goal.value;
                document.getElementById('goal-date').value = goal.date || '';
                document.getElementById('goal-show-line').checked = goal.showLine;
            } else {
                infoDiv.classList.add('hidden');
                // „Éï„Ç©„Éº„É†„Çí„ÇØ„É™„Ç¢
                document.getElementById('goal-value').value = '';
                document.getElementById('goal-date').value = '';
                document.getElementById('goal-show-line').checked = true;
            }
        }

        // ÁõÆÊ®ô„Çí‰øùÂ≠ò
        function saveGoal() {
            const metricSelect = document.getElementById('goal-metric');
            const selectedMetric = metricSelect.value;
            const value = parseFloat(document.getElementById('goal-value').value);
            const date = document.getElementById('goal-date').value;
            const showLine = document.getElementById('goal-show-line').checked;

            if (isNaN(value) || value <= 0) {
                alert('ÊúâÂäπ„Å™ÁõÆÊ®ôÂÄ§„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                return;
            }

            // ÁõÆÊ®ô„Çí‰øùÂ≠ò
            goals[selectedMetric] = {
                value: value,
                date: date || null,
                showLine: showLine,
                createdAt: new Date().toISOString()
            };

            saveGoalsToStorage();

            // „Ç∞„É©„Éï„ÇíÊõ¥Êñ∞ÔºàÁõÆÊ®ô„É©„Ç§„É≥„ÇíË°®Á§∫Ôºâ
            updateChart(1);
            if (comparisonMode) {
                updateChart(2);
            }

            alert('ÁõÆÊ®ô„Çí‰øùÂ≠ò„Åó„Åæ„Åó„ÅüÔºÅ');
            closeGoalSettingModal();
        }

        // ÁõÆÊ®ô„Çí„ÇØ„É™„Ç¢
        function clearGoal() {
            const metricSelect = document.getElementById('goal-metric');
            const selectedMetric = metricSelect.value;

            if (goals[selectedMetric]) {
                if (confirm('„Åì„ÅÆÊåáÊ®ô„ÅÆÁõÆÊ®ô„Çí„ÇØ„É™„Ç¢„Åó„Åæ„Åô„ÅãÔºü')) {
                    delete goals[selectedMetric];
                    saveGoalsToStorage();
                    loadCurrentGoal();

                    // „Ç∞„É©„Éï„ÇíÊõ¥Êñ∞
                    updateChart(1);
                    if (comparisonMode) {
                        updateChart(2);
                    }

                    alert('ÁõÆÊ®ô„Çí„ÇØ„É™„Ç¢„Åó„Åæ„Åó„Åü');
                }
            } else {
                alert('Ë®≠ÂÆö„Åï„Çå„ÅüÁõÆÊ®ô„Åå„ÅÇ„Çä„Åæ„Åõ„Çì');
            }
        }

        // „Ç¢„Éé„ÉÜ„Éº„Ç∑„Éß„É≥Ôºà„É°„É¢ÔºâÊ©üËÉΩ
        function loadAnnotations() {
            try {
                const stored = localStorage.getItem('fitness_annotations');
                if (stored) {
                    annotations = JSON.parse(stored);
                }
            } catch (error) {
                console.error('„Ç¢„Éé„ÉÜ„Éº„Ç∑„Éß„É≥„ÅÆË™≠„ÅøËæº„Åø„Ç®„É©„Éº:', error);
                annotations = {};
            }
        }

        function saveAnnotations() {
            try {
                localStorage.setItem('fitness_annotations', JSON.stringify(annotations));
            } catch (error) {
                console.error('„Ç¢„Éé„ÉÜ„Éº„Ç∑„Éß„É≥„ÅÆ‰øùÂ≠ò„Ç®„É©„Éº:', error);
            }
        }

        // „Ç∞„É©„Éï„ÅÆ„ÇØ„É™„ÉÉ„ÇØ„Ç§„Éô„É≥„Éà„Åß„É°„É¢„ÇíËøΩÂä†
        function addAnnotationOnClick(chartNum, event) {
            const chart = charts[chartNum];
            if (!chart) return;

            const points = chart.getElementsAtEventForMode(event, 'nearest', { intersect: true }, true);

            if (points.length > 0) {
                const point = points[0];
                const dataIndex = point.index;
                const label = chart.data.labels[dataIndex];
                const metric = metricInfo[currentSubCategory];

                // „É°„É¢„ÇíÂÖ•Âäõ
                const note = prompt(`${label}„ÅÆ„É°„É¢„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ:\nÔºà‰æã: È¢®ÈÇ™„Åß‰ºëÈ§ä„ÄÅ„ÉÅ„Éº„Éà„Éá„Ç§„ÄÅ‰ΩìË™øËâØÂ•ΩÔºâ`);

                if (note && note.trim() !== '') {
                    const key = `${currentSubCategory}_${label}`;
                    annotations[key] = {
                        date: label,
                        note: note.trim(),
                        metric: currentSubCategory,
                        createdAt: new Date().toISOString()
                    };

                    saveAnnotations();
                    updateChart(chartNum);
                    alert('„É°„É¢„Çí‰øùÂ≠ò„Åó„Åæ„Åó„ÅüÔºÅ');
                }
            }
        }

        // „Ç¢„Éé„ÉÜ„Éº„Ç∑„Éß„É≥„Éû„Éº„Ç´„Éº„Çí„Ç∞„É©„Éï„Å´ËøΩÂä†
        function getAnnotationMarkers(chartNum, category) {
            const labels = charts[chartNum]?.data.labels || [];
            const markers = {};

            labels.forEach((label, index) => {
                const key = `${category}_${label}`;
                if (annotations[key]) {
                    markers[`note_${index}`] = {
                        type: 'point',
                        xValue: index,
                        yValue: currentData[chartNum][index],
                        backgroundColor: 'rgba(255, 193, 7, 0.8)', // amber-400
                        borderColor: 'rgb(245, 158, 11)',
                        borderWidth: 2,
                        radius: 8,
                        label: {
                            display: true,
                            content: 'üìù',
                            position: 'top',
                            font: {
                                size: 14
                            }
                        }
                    };
                }
            });

            return markers;
        }

        // „Ç∞„É©„Éï„Éõ„Éê„ÉºÊôÇ„Å´„É°„É¢„ÇíË°®Á§∫
        function showAnnotationTooltip(chartNum, tooltipItems) {
            if (!tooltipItems || tooltipItems.length === 0) return;

            const index = tooltipItems[0].dataIndex;
            const label = charts[chartNum].data.labels[index];
            const key = `${currentSubCategory}_${label}`;

            if (annotations[key]) {
                return [
                    tooltipItems[0].formattedValue,
                    '',
                    `üìù „É°„É¢: ${annotations[key].note}`
                ];
            }

            return tooltipItems[0].formattedValue;
        }

        // „Éï„É≠„Éº„ÉÜ„Ç£„É≥„Ç∞Ë®≠ÂÆö„Éë„Éç„É´
        let currentPanelChart = 1; // „Å©„ÅÆ„Ç∞„É©„Éï„ÅÆË®≠ÂÆö„ÇíÈñã„ÅÑ„Å¶„ÅÑ„Çã„Åã

        function toggleSettingsPanel(chartNum) {
            const panel = document.getElementById('settings-panel');
            const isHidden = panel.classList.contains('hidden');

            if (isHidden) {
                currentPanelChart = chartNum;
                openSettingsPanel();
            } else {
                closeSettingsPanel();
            }
        }

        function openSettingsPanel() {
            const panel = document.getElementById('settings-panel');
            panel.classList.remove('hidden');

            // „Éë„Éç„É´„ÅÆÁä∂ÊÖã„ÇíÁèæÂú®„ÅÆ„Ç∞„É©„ÉïË®≠ÂÆö„Å´ÂêåÊúü
            syncPanelToCurrentSettings();

            // Flatpickr„ÇíÂàùÊúüÂåñÔºà„Éë„Éç„É´Áî®Ôºâ
            initPanelFlatpickr();

            lucide.createIcons();
        }

        function closeSettingsPanel() {
            document.getElementById('settings-panel').classList.add('hidden');
        }

        function syncPanelToCurrentSettings() {
            // YËª∏ÁØÑÂõ≤„ÇíÂêåÊúü
            const axisMinPanel = document.getElementById('axis-min-panel');
            const axisMaxPanel = document.getElementById('axis-max-panel');
            const comparisonModePanel = document.getElementById('comparison-mode-panel');
            const syncAxisPanel = document.getElementById('sync-axis-panel');

            if (axisMinPanel) axisMinPanel.value = currentAxisRanges[currentPanelChart].min || '';
            if (axisMaxPanel) axisMaxPanel.value = currentAxisRanges[currentPanelChart].max || '';

            // ÊØîËºÉ„É¢„Éº„Éâ„Å®YËª∏ÈÄ£Âãï„ÇíÂêåÊúü
            if (comparisonModePanel) comparisonModePanel.checked = comparisonMode;
            if (syncAxisPanel) syncAxisPanel.checked = axisSync;

            // Chart2„Ç´„ÉÜ„Ç¥„É™„Éâ„É≠„ÉÉ„Éó„ÉÄ„Ç¶„É≥„ÇíÊõ¥Êñ∞
            updateChart2CategoryDropdown();
        }

        function updateChart2CategoryDropdown() {
            const select = document.getElementById('chart2-category-panel');
            if (!select) return;

            // ÁèæÂú®ÈÅ∏Êäû„Åï„Çå„Å¶„ÅÑ„ÇãÂÄ§„Çí‰øùÂ≠ò
            const currentValue = chart2Category;

            // „Åô„Åπ„Å¶„ÅÆ„Ç™„Éó„Ç∑„Éß„É≥„Çí„ÇØ„É™„Ç¢
            select.innerHTML = '';

            // „Ç´„ÉÜ„Ç¥„É™Âà•„Å´„Ç∞„É´„Éº„ÉóÂåñ„Åó„Å¶„Ç™„Éó„Ç∑„Éß„É≥„ÇíËøΩÂä†
            const categories = {
                '„Éë„Éï„Ç©„Éº„Éû„É≥„Çπ': ['lbm', 'directive', 'overall'],
                'È£ü‰∫ã': ['calories', 'protein', 'carbs', 'fat', 'water'],
                'ÈÅãÂãï': ['workout_duration', 'workout_volume', 'steps', 'cardio'],
                '„Ç≥„É≥„Éá„Ç£„Ç∑„Éß„É≥': ['weight', 'body_fat', 'sleep', 'mood', 'energy']
            };

            for (const [categoryName, metrics] of Object.entries(categories)) {
                const optgroup = document.createElement('optgroup');
                optgroup.label = categoryName;

                for (const metric of metrics) {
                    if (metricInfo[metric]) {
                        const option = document.createElement('option');
                        option.value = metric;
                        option.textContent = `${metricInfo[metric].icon} ${metricInfo[metric].name}`;
                        if (metric === currentValue) {
                            option.selected = true;
                        }
                        optgroup.appendChild(option);
                    }
                }

                select.appendChild(optgroup);
            }
        }

        function initPanelFlatpickr() {
            if (!flatpickrInstances['panel']) {
                flatpickrInstances['panel'] = {
                    start: flatpickr('#custom-start-panel', {
                        locale: 'ja',
                        dateFormat: 'Y-m-d',
                        maxDate: 'today',
                        onChange: function(selectedDates) {
                            if (flatpickrInstances['panel']?.end) {
                                flatpickrInstances['panel'].end.set('minDate', selectedDates[0]);
                            }
                        }
                    }),
                    end: flatpickr('#custom-end-panel', {
                        locale: 'ja',
                        dateFormat: 'Y-m-d',
                        maxDate: 'today'
                    })
                };
            }
        }

        function applyCustomPeriodFromPanel() {
            const startDate = document.getElementById('custom-start-panel').value;
            const endDate = document.getElementById('custom-end-panel').value;

            if (!startDate || !endDate) {
                alert('ÈñãÂßãÊó•„Å®ÁµÇ‰∫ÜÊó•„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                return;
            }

            const start = new Date(startDate);
            const end = new Date(endDate);

            if (start > end) {
                alert('ÈñãÂßãÊó•„ÅØÁµÇ‰∫ÜÊó•„Çà„ÇäÂâç„Åß„ÅÇ„ÇãÂøÖË¶Å„Åå„ÅÇ„Çä„Åæ„Åô');
                return;
            }

            const days = Math.ceil((end - start) / (1000 * 60 * 60 * 24)) + 1;

            if (days > 90) {
                alert('ÊúÄÂ§ß90Êó•Èñì„Åæ„ÅßÈÅ∏Êäû„Åß„Åç„Åæ„Åô');
                return;
            }

            currentPeriods[currentPanelChart] = days;

            // ÊúüÈñì„Éú„Çø„É≥„ÅÆÈÅ∏ÊäûÁä∂ÊÖã„Çí„É™„Çª„ÉÉ„Éà
            const container = currentPanelChart === 1 ? document.getElementById('chart-1') : document.getElementById('chart-2');
            container.querySelectorAll('.period-button').forEach(btn => {
                btn.classList.remove('active');
                btn.classList.remove('border-purple-500', 'border-blue-500', 'font-semibold');
                btn.classList.add('border-gray-300');
            });

            updateChart(currentPanelChart);
            alert(`„Ç´„Çπ„Çø„É†ÊúüÈñìÔºà${days}Êó•ÈñìÔºâ„ÇíÈÅ©Áî®„Åó„Åæ„Åó„Åü`);
        }

        function updateAxisRangeFromPanel() {
            const min = parseFloat(document.getElementById('axis-min-panel').value);
            const max = parseFloat(document.getElementById('axis-max-panel').value);

            if (!isNaN(min) && !isNaN(max) && min < max) {
                currentAxisRanges[currentPanelChart] = { min, max };

                // „Ç∞„É©„Éï„ÇíÊõ¥Êñ∞
                if (charts[currentPanelChart]) {
                    charts[currentPanelChart].options.scales.y.min = min;
                    charts[currentPanelChart].options.scales.y.max = max;
                    charts[currentPanelChart].update();
                }

                // YËª∏ÈÄ£Âãï„ÅåON„Åß„ÄÅ„Ç∞„É©„Éï1„ÅÆÂ§âÊõ¥„Å™„Çâ„ÄÅ„Ç∞„É©„Éï2„ÇÇÂêåÊúü
                if (axisSync && currentPanelChart === 1 && comparisonMode) {
                    currentAxisRanges[2] = { min, max };
                    if (charts[2]) {
                        charts[2].options.scales.y.min = min;
                        charts[2].options.scales.y.max = max;
                        charts[2].update();
                    }
                }
            }
        }

        function resetAxisRangeFromPanel() {
            document.getElementById('axis-min-panel').value = globalMinMax.min;
            document.getElementById('axis-max-panel').value = globalMinMax.max;
            updateAxisRangeFromPanel();
        }

        // „Ç´„Çπ„Çø„É†ÊúüÈñìÈÅ∏ÊäûÊ©üËÉΩ
        let flatpickrInstances = {};

        function initFlatpickr() {
            // Flatpickr„ÇíÊó•Êú¨Ë™û„Å´Ë®≠ÂÆö
            if (typeof flatpickr !== 'undefined') {
                flatpickr.localize(flatpickr.l10ns.ja);
            }

            // Chart 1„ÅÆFlatpickrÂàùÊúüÂåñ
            if (!flatpickrInstances[1]) {
                flatpickrInstances[1] = {
                    start: flatpickr('#custom-start-1', {
                        locale: 'ja',
                        dateFormat: 'Y-m-d',
                        maxDate: 'today',
                        onChange: function(selectedDates) {
                            if (flatpickrInstances[1]?.end) {
                                flatpickrInstances[1].end.set('minDate', selectedDates[0]);
                            }
                        }
                    }),
                    end: flatpickr('#custom-end-1', {
                        locale: 'ja',
                        dateFormat: 'Y-m-d',
                        maxDate: 'today'
                    })
                };
            }

            // Chart 2„ÅÆFlatpickrÂàùÊúüÂåñ
            if (!flatpickrInstances[2]) {
                flatpickrInstances[2] = {
                    start: flatpickr('#custom-start-2', {
                        locale: 'ja',
                        dateFormat: 'Y-m-d',
                        maxDate: 'today',
                        onChange: function(selectedDates) {
                            if (flatpickrInstances[2]?.end) {
                                flatpickrInstances[2].end.set('minDate', selectedDates[0]);
                            }
                        }
                    }),
                    end: flatpickr('#custom-end-2', {
                        locale: 'ja',
                        dateFormat: 'Y-m-d',
                        maxDate: 'today'
                    })
                };
            }
        }

        function toggleCustomPeriod(chartNum) {
            const customPeriodDiv = document.getElementById(`custom-period-${chartNum}`);
            customPeriodDiv.classList.toggle('hidden');

            // ÂàùÂõûË°®Á§∫ÊôÇ„Å´Flatpickr„ÇíÂàùÊúüÂåñ
            if (!customPeriodDiv.classList.contains('hidden')) {
                initFlatpickr();
            }

            lucide.createIcons();
        }

        function applyCustomPeriod(chartNum) {
            const startDate = document.getElementById(`custom-start-${chartNum}`).value;
            const endDate = document.getElementById(`custom-end-${chartNum}`).value;

            if (!startDate || !endDate) {
                alert('ÈñãÂßãÊó•„Å®ÁµÇ‰∫ÜÊó•„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                return;
            }

            const start = new Date(startDate);
            const end = new Date(endDate);

            if (start > end) {
                alert('ÈñãÂßãÊó•„ÅØÁµÇ‰∫ÜÊó•„Çà„ÇäÂâç„Åß„ÅÇ„ÇãÂøÖË¶Å„Åå„ÅÇ„Çä„Åæ„Åô');
                return;
            }

            // Êó•Êï∞„ÇíË®àÁÆó
            const days = Math.ceil((end - start) / (1000 * 60 * 60 * 24)) + 1;

            if (days > 90) {
                alert('ÊúÄÂ§ß90Êó•Èñì„Åæ„ÅßÈÅ∏Êäû„Åß„Åç„Åæ„Åô');
                return;
            }

            // „Ç´„Çπ„Çø„É†ÊúüÈñì„ÇíÈÅ©Áî®
            currentPeriods[chartNum] = days;

            // ÊúüÈñì„Éú„Çø„É≥„ÅÆÈÅ∏ÊäûÁä∂ÊÖã„Çí„É™„Çª„ÉÉ„Éà
            const container = chartNum === 1 ? document.getElementById('chart-1') : document.getElementById('chart-2');
            container.querySelectorAll('.period-button').forEach(btn => {
                btn.classList.remove('active');
            });

            // „Ç´„Çπ„Çø„É†ÊúüÈñì„ÅÆUI„ÇíÈñâ„Åò„Çã
            document.getElementById(`custom-period-${chartNum}`).classList.add('hidden');

            // „Ç∞„É©„Éï„ÇíÊõ¥Êñ∞
            updateChart(chartNum);

            alert(`„Ç´„Çπ„Çø„É†ÊúüÈñìÔºà${days}Êó•ÈñìÔºâ„ÇíÈÅ©Áî®„Åó„Åæ„Åó„Åü`);
        }

        // ===== „Éâ„É™„É´„ÉÄ„Ç¶„É≥„É¢„Éº„ÉÄ„É´Ê©üËÉΩ =====

        function showDrillDownModal(chartNum, index, label, value, metric) {
            // Chart2„ÅßÊØîËºÉ„É¢„Éº„Éâ„ÅÆÂ†¥Âêà„ÅØ„ÄÅchart2Category„Çí‰ΩøÁî®
            const categoryToUse = (chartNum === 2 && comparisonMode) ? chart2Category : currentSubCategory;

            // „Éá„Éº„Çø„Çí‰øùÂ≠ò
            const annotationKey = `${categoryToUse}_${label}`;
            currentDrillDownData = {
                chartNum,
                index,
                label,
                value,
                metric,
                annotationKey
            };

            // „É©„Éô„É´„Åã„ÇâÂÆüÈöõ„ÅÆÊó•‰ªò„ÇíË®àÁÆó
            const daysAgo = parseInt(label.replace(/[^\d]/g, '')) || 0;
            const today = new Date();
            const targetDate = new Date(today);
            targetDate.setDate(today.getDate() - daysAgo);

            // Êó•‰ªò„Çí„Éï„Ç©„Éº„Éû„ÉÉ„Éà (10/15ÂΩ¢Âºè)
            const dateString = `${targetDate.getMonth() + 1}/${targetDate.getDate()}`;
            const daysAgoString = daysAgo === 0 ? '‰ªäÊó•' : `${daysAgo}Êó•Ââç`;

            // „É¢„Éº„ÉÄ„É´„ÅÆÂÜÖÂÆπ„ÇíÊõ¥Êñ∞
            document.getElementById('drilldown-title').textContent = `${dateString} (${daysAgoString})`;
            document.getElementById('drilldown-subtitle').textContent = `${metric.name}„ÅÆ„Éá„Éº„Çø`;
            document.getElementById('drilldown-metric').textContent = metric.name;

            // ÂÄ§„ÅÆË°®Á§∫Ôºà„Éê„Ç§„Éä„É™„Éá„Éº„Çø„ÅÆÂ†¥Âêà„ÅØÂÆå‰∫Ü/Êú™ÂÆå‰∫Ü„Å´Â§âÊèõÔºâ
            if (metric.isBinary) {
                document.getElementById('drilldown-value').textContent = value === 1 ? '‚úÖ ÂÆå‰∫Ü' : '‚ùå Êú™ÂÆå‰∫Ü';
            } else {
                document.getElementById('drilldown-value').textContent = `${value.toFixed(1)} ${metric.unit}`;
            }

            // „É°„É¢„ÅÆË°®Á§∫
            if (annotations[annotationKey]) {
                document.getElementById('drilldown-memo-text').textContent = annotations[annotationKey].note;
                document.getElementById('drilldown-memo-display').classList.remove('hidden');
                document.getElementById('drilldown-memo-empty').classList.add('hidden');
                document.getElementById('memo-edit-button-text').textContent = '„É°„É¢„ÇíÁ∑®ÈõÜ';
            } else {
                document.getElementById('drilldown-memo-display').classList.add('hidden');
                document.getElementById('drilldown-memo-empty').classList.remove('hidden');
                document.getElementById('memo-edit-button-text').textContent = '„É°„É¢„ÇíËøΩÂä†';
            }

            // Á∑®ÈõÜUI„Çí„É™„Çª„ÉÉ„Éà
            document.getElementById('drilldown-memo-edit').classList.add('hidden');
            document.getElementById('drilldown-memo-input').value = annotations[annotationKey]?.note || '';

            // „É¢„Éº„ÉÄ„É´„ÇíË°®Á§∫
            const modal = document.getElementById('drilldown-modal');
            modal.classList.remove('hidden');

            // „Ç¢„Ç§„Ç≥„É≥„ÇíÂÜçÊèèÁîª
            lucide.createIcons();
        }

        function closeDrillDownModal() {
            const modal = document.getElementById('drilldown-modal');
            modal.classList.add('hidden');

            // Á∑®ÈõÜUI„Çí„É™„Çª„ÉÉ„Éà
            document.getElementById('drilldown-memo-edit').classList.add('hidden');
        }

        function toggleMemoEdit() {
            const editDiv = document.getElementById('drilldown-memo-edit');
            editDiv.classList.toggle('hidden');

            // „Ç¢„Ç§„Ç≥„É≥„ÇíÂÜçÊèèÁîª
            lucide.createIcons();
        }

        function saveMemo() {
            const noteText = document.getElementById('drilldown-memo-input').value.trim();

            if (!noteText) {
                alert('„É°„É¢„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                return;
            }

            // „Ç¢„Éé„ÉÜ„Éº„Ç∑„Éß„É≥„Çí‰øùÂ≠ò
            annotations[currentDrillDownData.annotationKey] = {
                note: noteText,
                value: currentDrillDownData.value,
                metric: currentDrillDownData.metric.name
            };

            // LocalStorage„Å´‰øùÂ≠ò
            localStorage.setItem('history_v10_annotations', JSON.stringify(annotations));

            // UI„ÇíÊõ¥Êñ∞
            document.getElementById('drilldown-memo-text').textContent = noteText;
            document.getElementById('drilldown-memo-display').classList.remove('hidden');
            document.getElementById('drilldown-memo-empty').classList.add('hidden');
            document.getElementById('memo-edit-button-text').textContent = '„É°„É¢„ÇíÁ∑®ÈõÜ';
            document.getElementById('drilldown-memo-edit').classList.add('hidden');

            // „Ç∞„É©„Éï„ÇíÊõ¥Êñ∞Ôºà„ÉÑ„Éº„É´„ÉÅ„ÉÉ„Éó„Å´„É°„É¢„ÅåË°®Á§∫„Åï„Çå„Çã„Çà„ÅÜ„Å´Ôºâ
            updateChart(currentDrillDownData.chartNum);

            alert('„É°„É¢„Çí‰øùÂ≠ò„Åó„Åæ„Åó„Åü');
        }

        function deleteMemo() {
            if (!confirm('„Åì„ÅÆ„É°„É¢„ÇíÂâäÈô§„Åó„Å¶„ÇÇ„Çà„Çç„Åó„ÅÑ„Åß„Åô„Åã?')) {
                return;
            }

            // „Ç¢„Éé„ÉÜ„Éº„Ç∑„Éß„É≥„ÇíÂâäÈô§
            delete annotations[currentDrillDownData.annotationKey];

            // LocalStorage„ÇíÊõ¥Êñ∞
            localStorage.setItem('history_v10_annotations', JSON.stringify(annotations));

            // UI„ÇíÊõ¥Êñ∞
            document.getElementById('drilldown-memo-display').classList.add('hidden');
            document.getElementById('drilldown-memo-empty').classList.remove('hidden');
            document.getElementById('memo-edit-button-text').textContent = '„É°„É¢„ÇíËøΩÂä†';
            document.getElementById('drilldown-memo-edit').classList.add('hidden');
            document.getElementById('drilldown-memo-input').value = '';

            // „Ç∞„É©„Éï„ÇíÊõ¥Êñ∞
            updateChart(currentDrillDownData.chartNum);

            alert('„É°„É¢„ÇíÂâäÈô§„Åó„Åæ„Åó„Åü');
        }

        // ÂàùÊúüË°®Á§∫
        async function init() {
            loadGoals(); // ÁõÆÊ®ô„Éá„Éº„Çø„ÇíË™≠„ÅøËæº„Åø
            loadAnnotations(); // „É°„É¢„Éá„Éº„Çø„ÇíË™≠„ÅøËæº„Åø

            // ÂÆü„Éá„Éº„Çø„ÅÆË™≠„ÅøËæº„Åø„ÇíË©¶Ë°å
            if (typeof DataService !== 'undefined') {
                try {
                    const realData = await loadRealData();
                    // allData„Çí‰∏äÊõ∏„Åç
                    Object.keys(realData).forEach(key => {
                        if (allData[key]) {
                            allData[key] = realData[key];
                        }
                    });
                    console.log('Real data loaded successfully');
                } catch (error) {
                    console.warn('Failed to load real data, using dummy data:', error);
                }
            }

            globalMinMax = calculateGlobalMinMax('lbm');
            updateChart(1);
        }

        init();
    </script>
</body>
</html>
