<!DOCTYPE html>
<!--
  å±¥æ­´ã‚°ãƒ©ãƒ• v2.2.0
  æ›´æ–°æ—¥: 2025-10-22
  å¤‰æ›´å†…å®¹:
  - é‹å‹•ã‚«ãƒ†ã‚´ãƒªã®ã€Œ1RMã€ã€Œ5RMã€ã€Œ10RMã€ã‚’ã€ŒRMã€1ã¤ã«çµ±åˆ
  - RMé¸æŠæ™‚ã«å°‚ç”¨èª¿æ•´ãƒ‘ãƒãƒ«ã‚’è¡¨ç¤ºï¼ˆå›æ•°é¸æŠãƒ»ç¨®ç›®é¸æŠã®2æ®µéšï¼‰
  - ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒå®Ÿéš›ã«è¨˜éŒ²ã—ãŸRMå›æ•°ã¨ç¨®ç›®ã®ã¿ã‚’å‹•çš„ã«è¡¨ç¤º
  - ç¨®ç›®åˆ¥ãƒ»å›æ•°åˆ¥ã®RMæ¨ç§»ã‚’ã‚°ãƒ©ãƒ•ã§ç¢ºèªå¯èƒ½ã«
-->
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>å±¥æ­´ã‚°ãƒ©ãƒ• v2.0.0</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-storage-compat.js"></script>

    <!-- App Services -->
    <script src="config.js"></script>
    <script src="services.js"></script>
    <!-- ç›®æ¨™ãƒ©ã‚¤ãƒ³ãƒ»ãƒ¡ãƒ¢æ©Ÿèƒ½ -->
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@2.2.1"></script>
    <!-- ã‚«ã‚¹ã‚¿ãƒ æœŸé–“é¸æŠ -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/ja.js"></script>
    <style>
        /* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒãƒ¼ã‚’å®Œå…¨éè¡¨ç¤º */
        * {
            scrollbar-width: none; /* Firefox */
            -ms-overflow-style: none; /* IE/Edge */
        }
        *::-webkit-scrollbar {
            display: none; /* Chrome/Safari/Opera */
        }

        .tab-button {
            transition: all 0.3s ease;
            position: relative;
        }
        .tab-button.active {
            font-weight: 600;
        }
        .tab-button.active::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: currentColor;
        }
        .sub-tab-button {
            transition: all 0.2s ease;
        }
        .sub-tab-button.active {
            transform: scale(1.05);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .chart-container {
            animation: fadeIn 0.4s ease-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .day-box {
            aspect-ratio: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border-radius: 0.5rem;
            font-weight: 600;
            font-size: 0.75rem;
        }
        .day-box.done {
            background-color: #22c55e;
            color: white;
        }
        .day-box.not-done {
            background-color: #e5e7eb;
            color: #6b7280;
        }
        .range-control {
            background: #f3f4f6;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            padding: 0.75rem;
            margin-top: 1rem;
        }
        .period-button {
            transition: all 0.2s ease;
            position: relative;
            padding: 0.5rem 1rem;
            background: transparent;
            border: none;
            color: #6b7280;
            font-weight: 500;
        }
        .period-button.active {
            color: #7c3aed;
            font-weight: 600;
        }
        .period-button.active::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: #7c3aed;
        }
        .period-button:hover {
            color: #7c3aed;
            background: rgba(124, 58, 237, 0.05);
        }
        .comparison-enabled .chart-section {
            border: 2px solid #3b82f6;
        }
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        .modal.show {
            display: flex;
        }
        .modal-content {
            background: white;
            border-radius: 1rem;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            animation: slideUp 0.3s ease-out;
        }
        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        .ai-analyzing {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .ai-analyzing .spinner {
            width: 20px;
            height: 20px;
            border: 3px solid #e5e7eb;
            border-top-color: #3b82f6;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .sync-icon {
            transition: transform 0.3s ease;
        }
        .sync-icon.syncing {
            animation: rotate 1s ease-in-out;
        }
        @keyframes rotate {
            to { transform: rotate(360deg); }
        }
        .info-icon {
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .info-icon:hover {
            transform: scale(1.1);
            color: #3b82f6;
        }
        .tooltip {
            display: none;
            position: absolute;
            background: white;
            border: 2px solid #3b82f6;
            border-radius: 0.5rem;
            padding: 1rem;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 100;
            max-width: 400px;
            animation: fadeIn 0.2s ease-out;
        }
        .tooltip.show {
            display: block;
        }
        .help-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }
        .help-modal.show {
            display: flex;
        }
        .help-content {
            background: white;
            border-radius: 1rem;
            max-width: 700px;
            width: 90%;
            max-height: 85vh;
            overflow-y: auto;
            animation: slideUp 0.3s ease-out;
        }
        .floating-panel {
            position: fixed;
            top: 80px;
            right: 20px;
            width: 320px;
            max-height: calc(100vh - 100px);
            background: white;
            border-radius: 1rem;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            z-index: 1500;
            overflow-y: auto;
            animation: slideInRight 0.3s ease-out;
        }
        .floating-panel.hidden {
            display: none;
        }
        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        .stats-inline {
            display: flex;
            justify-content: space-around;
            gap: 0.5rem;
            padding: 0.75rem;
            background: linear-gradient(to right, #f3f4f6, #e5e7eb);
            border-radius: 0.5rem;
            font-size: 0.875rem;
            margin-top: 1rem;
        }
        .stats-inline .stat-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            flex: 1;
        }
        .stats-inline .stat-value {
            font-size: 1.125rem;
            font-weight: bold;
        }
        .stats-inline .stat-value .unit {
            font-size: 0.75rem;
            font-weight: normal;
            opacity: 0.7;
        }
        .stats-inline .stat-label {
            font-size: 0.625rem;
            color: #6b7280;
            margin-top: 0.25rem;
        }
        .compact-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }
        .compact-buttons {
            display: flex;
            gap: 0.5rem;
        }
        .compact-buttons button {
            padding: 0.5rem 0.75rem;
            font-size: 0.875rem;
            border-radius: 0.5rem;
            transition: all 0.2s;
        }
    </style>
</head>
<body class="bg-gray-100">
    <!-- å±¥æ­´ãƒãƒŠãƒ¼ï¼ˆãƒ•ãƒ«ãƒ¯ã‚¤ãƒ‰ï¼‰ -->
    <div class="bg-gradient-to-r from-purple-500 to-indigo-600 shadow-md p-3 mb-4">
        <div class="flex items-center gap-2 text-white">
            <i data-lucide="trending-up" class="w-5 h-5"></i>
            <span class="text-lg font-bold">å±¥æ­´</span>
        </div>
    </div>

    <div class="max-w-6xl mx-auto px-4">
        <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒŠ -->
        <div class="bg-white rounded-lg shadow-lg overflow-hidden">
            <!-- å¤§ã‚«ãƒ†ã‚´ãƒªã‚¿ãƒ– -->
            <div class="flex border-b bg-gray-50">
                <button type="button"
                    class="tab-button flex-1 py-3 px-2 text-center transition text-green-600 relative"
                    data-category="nutrition"
                    onclick="selectMainCategory('nutrition', event)">
                    <div class="flex flex-col items-center justify-center gap-1">
                        <i data-lucide="utensils" class="w-5 h-5"></i>
                        <div class="text-xs font-semibold whitespace-nowrap">
                            é£Ÿäº‹
                        </div>
                    </div>
                </button>
                <button type="button"
                    class="tab-button flex-1 py-3 px-2 text-center transition text-orange-600 relative"
                    data-category="training"
                    onclick="selectMainCategory('training', event)">
                    <div class="flex flex-col items-center justify-center gap-1">
                        <i data-lucide="dumbbell" class="w-5 h-5"></i>
                        <div class="text-xs font-semibold whitespace-nowrap">
                            é‹å‹•
                        </div>
                    </div>
                </button>
                <button type="button"
                    class="tab-button flex-1 py-3 px-2 text-center transition text-red-600 relative"
                    data-category="condition"
                    onclick="selectMainCategory('condition', event)">
                    <div class="flex flex-col items-center justify-center gap-1">
                        <i data-lucide="heart-pulse" class="w-5 h-5"></i>
                        <div class="text-xs font-semibold whitespace-nowrap">
                            ã‚³ãƒ³ãƒ‡ã‚£ã‚·ãƒ§ãƒ³
                        </div>
                    </div>
                </button>
                <button type="button"
                    class="tab-button flex-1 py-3 px-2 text-center transition active text-purple-600 bg-white border-b-0 relative"
                    data-category="performance"
                    onclick="selectMainCategory('performance', event)">
                    <div class="flex flex-col items-center justify-center gap-1">
                        <i data-lucide="trending-up" class="w-5 h-5"></i>
                        <div class="text-xs font-semibold whitespace-nowrap">
                            ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹
                        </div>
                    </div>
                </button>
                <button type="button"
                    class="tab-button flex-1 py-3 px-2 text-center transition text-yellow-600 relative"
                    data-category="insights"
                    onclick="selectMainCategory('insights', event)">
                    <div class="flex flex-col items-center justify-center gap-1">
                        <i data-lucide="lightbulb" class="w-5 h-5"></i>
                        <div class="text-xs font-semibold whitespace-nowrap">
                            é–ƒã
                        </div>
                    </div>
                </button>
            </div>

            <!-- å°ã‚«ãƒ†ã‚´ãƒªã‚¿ãƒ–ï¼ˆé£Ÿäº‹ï¼‰ -->
            <div id="nutrition-subtabs" class="sub-tabs border-b bg-green-50 hidden">
                <div class="flex overflow-x-auto px-2 py-1 gap-1">
                <button type="button" class="sub-tab-button active px-2 py-1 bg-white text-green-700 rounded text-xs font-semibold border border-green-500" onclick="selectSubCategory('nutrition', 'calories')">
                    æ‘‚å–ã‚«ãƒ­ãƒªãƒ¼
                </button>
                <button type="button" class="sub-tab-button px-2 py-1 bg-white text-gray-700 rounded text-xs font-semibold border border-transparent hover:border-gray-300" onclick="selectSubCategory('nutrition', 'protein')">
                    ã‚¿ãƒ³ãƒ‘ã‚¯è³ª
                </button>
                <button type="button" class="sub-tab-button px-2 py-1 bg-white text-gray-700 rounded text-xs font-semibold border border-transparent hover:border-gray-300" onclick="selectSubCategory('nutrition', 'fat')">
                    è„‚è³ª
                </button>
                <button type="button" class="sub-tab-button px-2 py-1 bg-white text-gray-700 rounded text-xs font-semibold border border-transparent hover:border-gray-300" onclick="selectSubCategory('nutrition', 'carbs')">
                    ç‚­æ°´åŒ–ç‰©
                </button>
                <button type="button" class="sub-tab-button px-2 py-1 bg-white text-gray-700 rounded text-xs font-semibold border border-transparent hover:border-gray-300" onclick="selectSubCategory('nutrition', 'sugar')">
                    ç³–è³ª
                </button>
                <button type="button" class="sub-tab-button px-2 py-1 bg-white text-gray-700 rounded text-xs font-semibold border border-transparent hover:border-gray-300" onclick="selectSubCategory('nutrition', 'fiber')">
                    é£Ÿç‰©ç¹Šç¶­
                </button>
                <button type="button" class="sub-tab-button px-2 py-1 bg-white text-gray-700 rounded text-xs font-semibold border border-transparent hover:border-gray-300" onclick="selectSubCategory('nutrition', 'vitamin_score')">
                    ãƒ“ã‚¿ãƒŸãƒ³
                </button>
                <button type="button" class="sub-tab-button px-2 py-1 bg-white text-gray-700 rounded text-xs font-semibold border border-transparent hover:border-gray-300" onclick="selectSubCategory('nutrition', 'mineral_score')">
                    ãƒŸãƒãƒ©ãƒ«
                </button>
                </div>
            </div>

            <!-- å°ã‚«ãƒ†ã‚´ãƒªã‚¿ãƒ–ï¼ˆé‹å‹•ï¼‰ -->
            <div id="training-subtabs" class="sub-tabs border-b bg-orange-50 hidden">
                <div class="flex overflow-x-auto px-2 py-1 gap-1">
                <button type="button" class="sub-tab-button active px-2 py-1 bg-white text-orange-700 rounded text-xs font-semibold border border-orange-500" onclick="selectSubCategory('training', 'total_time')">
                    ç·æ™‚é–“
                </button>
                <button type="button" class="sub-tab-button px-2 py-1 bg-white text-gray-700 rounded text-xs font-semibold border border-transparent hover:border-gray-300" onclick="selectSubCategory('training', 'total_exercises')">
                    ç·ç¨®ç›®æ•°
                </button>
                <button type="button" class="sub-tab-button px-2 py-1 bg-white text-gray-700 rounded text-xs font-semibold border border-transparent hover:border-gray-300" onclick="selectSubCategory('training', 'total_weight')">
                    ç·é‡é‡
                </button>
                <button type="button" class="sub-tab-button px-2 py-1 bg-white text-gray-700 rounded text-xs font-semibold border border-transparent hover:border-gray-300" onclick="selectSubCategory('training', 'rm')">
                    RM
                </button>
                </div>
            </div>

            <!-- å°ã‚«ãƒ†ã‚´ãƒªã‚¿ãƒ–ï¼ˆã‚³ãƒ³ãƒ‡ã‚£ã‚·ãƒ§ãƒ³ï¼‰ -->
            <div id="condition-subtabs" class="sub-tabs border-b bg-red-50 hidden">
                <div class="flex overflow-x-auto px-2 py-1 gap-1">
                <button type="button" class="sub-tab-button active px-2 py-1 bg-white text-red-700 rounded text-xs font-semibold border border-red-500" onclick="selectSubCategory('condition', 'sleep_duration')">
                    ç¡çœ æ™‚é–“
                </button>
                <button type="button" class="sub-tab-button px-2 py-1 bg-white text-gray-700 rounded text-xs font-semibold border border-transparent hover:border-gray-300" onclick="selectSubCategory('condition', 'sleep_quality')">
                    ç¡çœ ã®è³ª
                </button>
                <button type="button" class="sub-tab-button px-2 py-1 bg-white text-gray-700 rounded text-xs font-semibold border border-transparent hover:border-gray-300" onclick="selectSubCategory('condition', 'appetite')">
                    é£Ÿæ¬²
                </button>
                <button type="button" class="sub-tab-button px-2 py-1 bg-white text-gray-700 rounded text-xs font-semibold border border-transparent hover:border-gray-300" onclick="selectSubCategory('condition', 'gut_health')">
                    è…¸å†…ç’°å¢ƒ
                </button>
                <button type="button" class="sub-tab-button px-2 py-1 bg-white text-gray-700 rounded text-xs font-semibold border border-transparent hover:border-gray-300" onclick="selectSubCategory('condition', 'focus')">
                    é›†ä¸­åŠ›
                </button>
                <button type="button" class="sub-tab-button px-2 py-1 bg-white text-gray-700 rounded text-xs font-semibold border border-transparent hover:border-gray-300" onclick="selectSubCategory('condition', 'stress')">
                    ã‚¹ãƒˆãƒ¬ã‚¹
                </button>
                </div>
            </div>

            <!-- å°ã‚«ãƒ†ã‚´ãƒªã‚¿ãƒ–ï¼ˆãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ï¼‰ -->
            <div id="performance-subtabs" class="sub-tabs border-b bg-purple-50">
                <div class="flex overflow-x-auto px-2 py-1 gap-1">
                <button type="button" class="sub-tab-button active px-2 py-1 bg-white text-purple-700 rounded text-xs font-semibold border border-purple-500" onclick="selectSubCategory('performance', 'lbm')">
                    LBM
                </button>
                <button type="button" class="sub-tab-button px-2 py-1 bg-white text-gray-700 rounded text-xs font-semibold border border-transparent hover:border-gray-300" onclick="selectSubCategory('performance', 'directive')">
                    æŒ‡ç¤ºæ›¸é”æˆç‡
                </button>
                <button type="button" class="sub-tab-button px-2 py-1 bg-white text-gray-700 rounded text-xs font-semibold border border-transparent hover:border-gray-300" onclick="selectSubCategory('performance', 'overall')">
                    ç·åˆåˆ†æ
                </button>
                </div>
            </div>

            <!-- é–ƒãã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
            <div id="insights-content" class="p-6 hidden">
                <div class="mb-6">
                    <h2 class="text-2xl font-bold text-gray-800 flex items-center gap-2">
                        <i data-lucide="lightbulb" class="w-7 h-7 text-yellow-500"></i>
                        é–ƒããƒ¡ãƒ¢ä¸€è¦§
                    </h2>
                    <p class="text-sm text-gray-600 mt-2">å…¨æœŸé–“ã®é–ƒããƒ¡ãƒ¢ã‚’è¡¨ç¤ºã—ã¾ã™</p>
                </div>
                <div id="insights-list" class="space-y-3">
                    <!-- JavaScriptã§å‹•çš„ã«ç”Ÿæˆ -->
                </div>
            </div>

            <!-- è©³ç´°ã‚°ãƒ©ãƒ•è¡¨ç¤ºã‚¨ãƒªã‚¢ -->
            <div id="graph-area" class="p-6">
                <!-- ã‚°ãƒ©ãƒ•1ï¼ˆãƒ¡ã‚¤ãƒ³ï¼‰ -->
                <div id="chart-1" class="chart-section mb-6">
                    <!-- ã‚³ãƒ³ãƒ‘ã‚¯ãƒˆãƒ˜ãƒƒãƒ€ãƒ¼ -->
                    <div class="mb-3">
                        <div>
                            <h3 id="chart-title-1" class="text-2xl font-bold text-gray-800">ğŸ’ª LBM - é™¤è„‚è‚ªä½“é‡</h3>
                            <p id="chart-period-1" class="text-sm text-gray-500 mt-1">éå»7æ—¥é–“ã®æ¨ç§»</p>
                        </div>
                        <div class="flex gap-2 mt-2">
                            <button type="button" onclick="performHistoryAnalysis()" class="px-3 py-2 bg-gradient-to-r from-purple-600 to-blue-600 hover:from-purple-700 hover:to-blue-700 text-white rounded-lg flex items-center gap-2 text-sm font-semibold shadow-sm transition">
                                <i data-lucide="sparkles" class="w-4 h-4"></i>
                                <span>AIåˆ†æ</span>
                            </button>
                            <button type="button" onclick="toggleSettingsPanel(1)" class="px-3 py-2 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-lg flex items-center gap-2 text-sm font-semibold transition">
                                <i data-lucide="settings" class="w-4 h-4"></i>
                                <span>è¨­å®š</span>
                            </button>
                        </div>
                    </div>

                    <!-- RMå°‚ç”¨èª¿æ•´ãƒ‘ãƒãƒ« -->
                    <div id="rm-control-panel" class="mb-4 p-3 bg-orange-50 rounded-lg border border-orange-200 hidden">
                        <div class="mb-2">
                            <div class="text-xs font-semibold text-orange-900 mb-1">å›æ•°ã‚’é¸æŠ</div>
                            <div id="rm-reps-buttons" class="flex flex-wrap gap-1">
                                <!-- å‹•çš„ã«ç”Ÿæˆ -->
                            </div>
                        </div>
                        <div>
                            <button
                                type="button"
                                onclick="document.getElementById('rm-exercise-list').classList.toggle('hidden'); lucide.createIcons();"
                                class="w-full flex items-center justify-between text-xs font-semibold text-orange-900 mb-1 px-2 py-1 hover:bg-orange-100 rounded transition"
                            >
                                <span>ç¨®ç›®ã‚’é¸æŠ</span>
                                <i data-lucide="chevron-down" class="w-3 h-3"></i>
                            </button>
                            <div id="rm-exercise-list" class="hidden">
                                <div id="rm-exercise-buttons" class="flex flex-wrap gap-1 max-h-32 overflow-y-auto">
                                    <!-- å‹•çš„ã«ç”Ÿæˆ -->
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- æœŸé–“é¸æŠï¼ˆã‚¿ãƒ–å¼UIï¼‰ -->
                    <div class="mb-4 border-b border-gray-200">
                        <div class="flex overflow-x-auto">
                            <button type="button" class="period-button active text-sm" onclick="selectPeriod(1, 7, event)">7æ—¥</button>
                            <button type="button" class="period-button text-sm" onclick="selectPeriod(1, 14, event)">14æ—¥</button>
                            <button type="button" class="period-button text-sm" onclick="selectPeriod(1, 30, event)">30æ—¥</button>
                            <button type="button" class="period-button text-sm" onclick="selectPeriod(1, 60, event)">60æ—¥</button>
                            <button type="button" class="period-button text-sm" onclick="selectPeriod(1, 90, event)">90æ—¥</button>
                            <button type="button" class="period-button text-sm" onclick="selectPeriod(1, 180, event)">180æ—¥</button>
                            <button type="button" class="period-button text-sm" onclick="selectPeriod(1, 365, event)">1å¹´</button>
                        </div>
                    </div>

                    <div style="height: 350px; position: relative;">
                        <canvas id="main-chart-1"></canvas>
                    </div>

                    <!-- é¸æŠã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ãƒã‚¤ãƒ³ãƒˆã®è©³ç´°ã¨ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ -->
                    <div id="selected-point-1" class="mt-3 p-3 bg-white rounded-lg border-2 border-purple-300 shadow-sm">
                        <div class="flex items-center justify-between">
                            <button type="button" onclick="navigateDataPoint(1, -1)" class="p-2 hover:bg-gray-100 rounded-full transition">
                                <i data-lucide="chevron-left" class="w-5 h-5 text-gray-700"></i>
                            </button>
                            <div class="text-center flex-1">
                                <div id="selected-date-1" class="text-sm font-semibold text-gray-800 mb-1"></div>
                                <div id="selected-value-1" class="text-2xl font-bold text-purple-600"></div>
                            </div>
                            <button type="button" onclick="navigateDataPoint(1, 1)" class="p-2 hover:bg-gray-100 rounded-full transition">
                                <i data-lucide="chevron-right" class="w-5 h-5 text-gray-700"></i>
                            </button>
                        </div>
                        <!-- ãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ—è¡¨ç¤º/éè¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆãƒœã‚¿ãƒ³ -->
                        <div class="mt-2 pt-2 border-t border-gray-200">
                            <button type="button" id="tooltip-toggle-1" onclick="toggleTooltip(1)" class="w-full px-3 py-1.5 text-xs font-semibold bg-gray-100 text-gray-700 rounded hover:bg-gray-200 transition">
                                <i data-lucide="info" class="w-3 h-3 inline-block mr-1"></i>
                                ãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ—ã‚’è¡¨ç¤º
                            </button>
                        </div>
                    </div>

                    <!-- ã‚³ãƒ³ãƒ‘ã‚¯ãƒˆãªçµ±è¨ˆæƒ…å ±ï¼ˆ1è¡Œï¼‰ -->
                    <div class="stats-inline">
                        <div class="stat-item">
                            <div class="stat-value text-blue-600" id="stat-avg-1">62.0kg</div>
                            <div class="stat-label">å¹³å‡<span id="stat-avg-unit-1" class="hidden"></span></div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value text-green-600" id="stat-max-1">62.5kg</div>
                            <div class="stat-label">æœ€é«˜<span id="stat-max-unit-1" class="hidden"></span></div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value text-orange-600" id="stat-min-1">61.0kg</div>
                            <div class="stat-label">æœ€ä½<span id="stat-min-unit-1" class="hidden"></span></div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value text-purple-600" id="chart-value-1">62.5kg</div>
                            <div class="stat-label">ç¾åœ¨<span id="chart-unit-1" class="hidden"></span></div>
                        </div>
                    </div>

                    <!-- è©³ç´°çµ±è¨ˆæƒ…å ±ï¼ˆæ¨™æº–åå·®ãƒ»ãƒˆãƒ¬ãƒ³ãƒ‰ï¼‰ -->
                    <div class="mt-3 grid grid-cols-2 gap-2">
                        <div class="p-3 bg-gray-50 rounded-lg">
                            <div class="text-xs text-gray-600 mb-1">æ¨™æº–åå·®</div>
                            <div class="text-lg font-bold text-gray-800" id="stat-stddev-1">0.5kg</div>
                        </div>
                        <div class="p-3 bg-gradient-to-r from-purple-50 to-blue-50 rounded-lg border border-purple-200">
                            <div class="text-xs text-gray-600 mb-1">ãƒˆãƒ¬ãƒ³ãƒ‰</div>
                            <div class="flex items-center gap-2">
                                <span class="text-2xl" id="stat-trend-icon-1">â†’</span>
                                <div>
                                    <div class="text-sm font-bold" id="stat-trend-label-1">æ¨ªã°ã„</div>
                                    <div class="text-xs text-gray-600" id="stat-trend-value-1">+0.0kg (0.0%)</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- ã‚«ãƒ†ã‚´ãƒªåˆ¥ç¯„å›²è¡¨ç¤º -->
                    <div class="mt-3 p-2 bg-gradient-to-r from-purple-50 to-blue-50 rounded-lg border border-purple-200">
                        <div class="flex items-center justify-between text-xs">
                            <span class="text-gray-600">å…¨æœŸé–“ï¼ˆ50å¹´ï¼‰ã®ç¯„å›²:</span>
                            <span class="font-semibold text-gray-800">
                                <span class="text-orange-600" id="category-min-1">60.0</span>
                                <span class="text-gray-400 mx-1">ï½</span>
                                <span class="text-green-600" id="category-max-1">63.0</span>
                                <span id="category-unit-1" class="text-gray-500 ml-1">kg</span>
                            </span>
                        </div>
                    </div>

                    <!-- æ—§çµ±è¨ˆæƒ…å ±ã‚³ãƒ³ãƒ†ãƒŠï¼ˆéè¡¨ç¤ºç”¨ãƒ»äº’æ›æ€§ç¶­æŒï¼‰ -->
                    <div id="stats-container-1" class="hidden"></div>
                </div>

                <!-- ã‚°ãƒ©ãƒ•2ï¼ˆæ¯”è¼ƒç”¨ï¼‰ -->
                <div id="chart-2" class="chart-section hidden">
                    <div class="border-t-2 border-dashed border-gray-300 pt-6 mt-6">
                        <!-- ã‚³ãƒ³ãƒ‘ã‚¯ãƒˆãƒ˜ãƒƒãƒ€ãƒ¼ -->
                        <div class="compact-header">
                            <div>
                                <h3 id="chart-title-2" class="text-2xl font-bold text-gray-800">ğŸ’ª LBM - é™¤è„‚è‚ªä½“é‡ - æ¯”è¼ƒ</h3>
                                <p id="chart-period-2" class="text-sm text-gray-500 mt-1">éå»30æ—¥é–“ã®æ¨ç§»</p>
                            </div>
                        </div>

                        <!-- æœŸé–“é¸æŠï¼ˆãƒ¢ãƒã‚¤ãƒ«å¯¾å¿œãƒ»ç”»é¢å¹…ã«åã¾ã‚‹ï¼‰ -->
                        <div class="mb-4">
                            <div class="grid grid-cols-4 gap-1.5">
                                <button type="button" class="period-button px-2 py-1.5 rounded text-xs font-semibold bg-white text-gray-700 border border-gray-300 transition" onclick="selectPeriod(2, 7, event)">7æ—¥</button>
                                <button type="button" class="period-button px-2 py-1.5 rounded text-xs font-semibold bg-white text-gray-700 border border-gray-300 transition" onclick="selectPeriod(2, 14, event)">14æ—¥</button>
                                <button type="button" class="period-button active px-2 py-1.5 rounded text-xs font-semibold bg-blue-600 text-white shadow-sm transition" onclick="selectPeriod(2, 30, event)">30æ—¥</button>
                                <button type="button" class="period-button px-2 py-1.5 rounded text-xs font-semibold bg-white text-gray-700 border border-gray-300 transition" onclick="selectPeriod(2, 60, event)">60æ—¥</button>
                                <button type="button" class="period-button px-2 py-1.5 rounded text-xs font-semibold bg-white text-gray-700 border border-gray-300 transition" onclick="selectPeriod(2, 90, event)">90æ—¥</button>
                                <button type="button" class="period-button px-2 py-1.5 rounded text-xs font-semibold bg-white text-gray-700 border border-gray-300 transition" onclick="selectPeriod(2, 180, event)">180æ—¥</button>
                                <button type="button" class="period-button px-2 py-1.5 rounded text-xs font-semibold bg-white text-gray-700 border border-gray-300 transition" onclick="selectPeriod(2, 365, event)">1å¹´</button>
                            </div>
                        </div>

                        <!-- ã‚«ãƒ†ã‚´ãƒªåˆ¥ç¯„å›²è¡¨ç¤º -->
                        <div class="mb-3 p-2 bg-gradient-to-r from-blue-50 to-cyan-50 rounded-lg border border-blue-200">
                            <div class="flex items-center justify-between text-xs">
                                <span class="text-gray-600">å…¨æœŸé–“ï¼ˆ50å¹´ï¼‰ã®ç¯„å›²:</span>
                                <span class="font-semibold text-gray-800">
                                    <span class="text-orange-600" id="category-min-2">60.0</span>
                                    <span class="text-gray-400 mx-1">ï½</span>
                                    <span class="text-green-600" id="category-max-2">63.0</span>
                                    <span id="category-unit-2" class="text-gray-500 ml-1">kg</span>
                                </span>
                            </div>
                        </div>

                        <div style="height: 350px; position: relative;">
                            <canvas id="main-chart-2"></canvas>
                        </div>

                        <!-- ã‚³ãƒ³ãƒ‘ã‚¯ãƒˆãªçµ±è¨ˆæƒ…å ±ï¼ˆ1è¡Œï¼‰ -->
                        <div class="stats-inline">
                            <div class="stat-item">
                                <div class="stat-value text-blue-600" id="stat-avg-2">61.5kg</div>
                                <div class="stat-label">å¹³å‡<span id="stat-avg-unit-2" class="hidden"></span></div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value text-green-600" id="stat-max-2">62.5kg</div>
                                <div class="stat-label">æœ€é«˜<span id="stat-max-unit-2" class="hidden"></span></div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value text-orange-600" id="stat-min-2">60.0kg</div>
                                <div class="stat-label">æœ€ä½<span id="stat-min-unit-2" class="hidden"></span></div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value text-purple-600" id="chart-value-2">62.5kg</div>
                                <div class="stat-label">ç¾åœ¨<span id="chart-unit-2" class="hidden"></span></div>
                            </div>
                        </div>

                        <!-- é¸æŠã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ãƒã‚¤ãƒ³ãƒˆã®è©³ç´°ã¨ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ -->
                        <div id="selected-point-2" class="mt-3 p-3 bg-white rounded-lg border-2 border-blue-300 shadow-sm hidden">
                            <div class="flex items-center justify-between">
                                <button type="button" onclick="navigateDataPoint(2, -1)" class="p-2 hover:bg-gray-100 rounded-full transition">
                                    <i data-lucide="chevron-left" class="w-5 h-5 text-gray-700"></i>
                                </button>
                                <div class="text-center flex-1">
                                    <div id="selected-date-2" class="text-sm font-semibold text-gray-800 mb-1"></div>
                                    <div id="selected-value-2" class="text-2xl font-bold text-blue-600"></div>
                                </div>
                                <button type="button" onclick="navigateDataPoint(2, 1)" class="p-2 hover:bg-gray-100 rounded-full transition">
                                    <i data-lucide="chevron-right" class="w-5 h-5 text-gray-700"></i>
                                </button>
                            </div>
                        </div>

                        <!-- æ—§çµ±è¨ˆæƒ…å ±ã‚³ãƒ³ãƒ†ãƒŠï¼ˆéè¡¨ç¤ºç”¨ãƒ»äº’æ›æ€§ç¶­æŒï¼‰ -->
                        <div id="stats-container-2" class="hidden"></div>
                    </div>
                </div>
            </div>
        </div>


        <!-- ãƒ˜ãƒ«ãƒ—ãƒ¢ãƒ¼ãƒ€ãƒ« -->
        <div id="help-modal" class="help-modal">
            <div class="help-content">
                <div class="sticky top-0 bg-gradient-to-r from-blue-600 to-cyan-600 text-white p-4 rounded-t-lg">
                    <div class="flex justify-between items-center">
                        <div class="flex items-center gap-2">
                            <i data-lucide="help-circle" class="w-5 h-5"></i>
                            <h3 class="text-lg font-bold">å±¥æ­´ã‚°ãƒ©ãƒ•ã®ä½¿ã„æ–¹</h3>
                        </div>
                        <button type="button" onclick="closeHelpModal()" class="p-1 hover:bg-white/20 rounded">
                            <i data-lucide="x" class="w-5 h-5"></i>
                        </button>
                    </div>
                </div>
                <div class="p-6">
                    <div class="space-y-6">
                        <!-- åŸºæœ¬æ“ä½œ -->
                        <div>
                            <h4 class="text-lg font-bold text-gray-800 mb-3 flex items-center gap-2">
                                <i data-lucide="mouse-pointer-click" class="w-5 h-5 text-blue-600"></i>
                                åŸºæœ¬æ“ä½œ
                            </h4>
                            <ul class="space-y-2 text-sm text-gray-700">
                                <li class="flex items-start gap-2">
                                    <span class="text-blue-600 font-bold">1.</span>
                                    <span><strong>ã‚«ãƒ†ã‚´ãƒªã‚¿ãƒ–</strong>: é£Ÿäº‹ãƒ»é‹å‹•ãƒ»ã‚³ãƒ³ãƒ‡ã‚£ã‚·ãƒ§ãƒ³ãƒ»ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã‚’åˆ‡ã‚Šæ›¿ãˆ</span>
                                </li>
                                <li class="flex items-start gap-2">
                                    <span class="text-blue-600 font-bold">2.</span>
                                    <span><strong>ã‚µãƒ–ã‚«ãƒ†ã‚´ãƒªã‚¿ãƒ–</strong>: å„ã‚«ãƒ†ã‚´ãƒªå†…ã®è©³ç´°æŒ‡æ¨™ã‚’é¸æŠ</span>
                                </li>
                                <li class="flex items-start gap-2">
                                    <span class="text-blue-600 font-bold">3.</span>
                                    <span><strong>æœŸé–“ãƒœã‚¿ãƒ³</strong>: 7æ—¥é–“/14æ—¥é–“/30æ—¥é–“/90æ—¥é–“ã‹ã‚‰è¡¨ç¤ºæœŸé–“ã‚’é¸æŠ</span>
                                </li>
                            </ul>
                        </div>

                        <!-- æ¯”è¼ƒãƒ¢ãƒ¼ãƒ‰ -->
                        <div class="bg-blue-50 p-4 rounded-lg border border-blue-200">
                            <h4 class="text-lg font-bold text-gray-800 mb-3 flex items-center gap-2">
                                <i data-lucide="columns-2" class="w-5 h-5 text-blue-600"></i>
                                æ¯”è¼ƒãƒ¢ãƒ¼ãƒ‰
                            </h4>
                            <p class="text-sm text-gray-700 mb-3">
                                2ã¤ã®ã‚°ãƒ©ãƒ•ã‚’åŒæ™‚ã«è¡¨ç¤ºã—ã€ç•°ãªã‚‹æœŸé–“ã‚’æ¯”è¼ƒã§ãã¾ã™ã€‚
                            </p>
                            <ul class="space-y-2 text-sm text-gray-700">
                                <li class="flex items-start gap-2">
                                    <span class="text-blue-600">â€¢</span>
                                    <span>ä¾‹: ä¸Šã®ã‚°ãƒ©ãƒ•ã§ã€Œ7æ—¥é–“ã€ã€ä¸‹ã®ã‚°ãƒ©ãƒ•ã§ã€Œ30æ—¥é–“ã€ã‚’é¸æŠã—ã¦çŸ­æœŸã¨é•·æœŸã‚’æ¯”è¼ƒ</span>
                                </li>
                                <li class="flex items-start gap-2">
                                    <span class="text-blue-600">â€¢</span>
                                    <span>ä¸Šã®ã‚°ãƒ©ãƒ•ã§é¸æŠã—ãŸæœŸé–“ã¯ã€ä¸‹ã®ã‚°ãƒ©ãƒ•ã§é¸æŠã§ãã¾ã›ã‚“ï¼ˆé‡è¤‡é˜²æ­¢ï¼‰</span>
                                </li>
                            </ul>
                        </div>

                        <!-- Yè»¸é€£å‹• -->
                        <div class="bg-purple-50 p-4 rounded-lg border border-purple-200">
                            <h4 class="text-lg font-bold text-gray-800 mb-3 flex items-center gap-2">
                                <i data-lucide="refresh-cw" class="w-5 h-5 text-purple-600"></i>
                                Yè»¸é€£å‹•æ©Ÿèƒ½
                            </h4>
                            <p class="text-sm text-gray-700 mb-3">
                                ä¸Šã®ã‚°ãƒ©ãƒ•ã®Yè»¸ç¯„å›²ã‚’å¤‰æ›´ã™ã‚‹ã¨ã€ä¸‹ã®ã‚°ãƒ©ãƒ•ã‚‚è‡ªå‹•ã§åŒã˜ç¯„å›²ã«èª¿æ•´ã•ã‚Œã¾ã™ã€‚
                            </p>
                            <ul class="space-y-2 text-sm text-gray-700">
                                <li class="flex items-start gap-2">
                                    <span class="text-purple-600">â€¢</span>
                                    <span><strong>ONã®å ´åˆ</strong>: ä¸Šä¸‹ã®ã‚°ãƒ©ãƒ•ã§åŒã˜ã‚¹ã‚±ãƒ¼ãƒ«ã‚’ä½¿ç”¨ï¼ˆæ¯”è¼ƒã—ã‚„ã™ã„ï¼‰</span>
                                </li>
                                <li class="flex items-start gap-2">
                                    <span class="text-purple-600">â€¢</span>
                                    <span><strong>OFFã®å ´åˆ</strong>: ä¸Šä¸‹ã®ã‚°ãƒ©ãƒ•ã§ç‹¬ç«‹ã—ãŸã‚¹ã‚±ãƒ¼ãƒ«ã‚’ä½¿ç”¨</span>
                                </li>
                                <li class="flex items-start gap-2">
                                    <span class="text-purple-600">â€¢</span>
                                    <span>ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã‚’ã‚¯ãƒªãƒƒã‚¯ã§ON/OFFåˆ‡ã‚Šæ›¿ãˆå¯èƒ½</span>
                                </li>
                            </ul>
                        </div>

                        <!-- Yè»¸ç¯„å›²èª¿æ•´ -->
                        <div>
                            <h4 class="text-lg font-bold text-gray-800 mb-3 flex items-center gap-2">
                                <i data-lucide="sliders-horizontal" class="w-5 h-5 text-green-600"></i>
                                Yè»¸ç¯„å›²ã®èª¿æ•´
                            </h4>
                            <ul class="space-y-2 text-sm text-gray-700">
                                <li class="flex items-start gap-2">
                                    <span class="text-green-600">â€¢</span>
                                    <span><strong>ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ</strong>: å…¨æœŸé–“ï¼ˆ90æ—¥é–“ï¼‰ã®æœ€ä½å€¤ï½æœ€é«˜å€¤ã‚’åŸºæº–ã«è‡ªå‹•è¨­å®š</span>
                                </li>
                                <li class="flex items-start gap-2">
                                    <span class="text-green-600">â€¢</span>
                                    <span><strong>æ‰‹å‹•èª¿æ•´</strong>: ã€Œæœ€å°å€¤ã€ã€Œæœ€å¤§å€¤ã€ã®å…¥åŠ›æ¬„ã«æ•°å€¤ã‚’å…¥åŠ›ã—ã¦è¡¨ç¤ºç¯„å›²ã‚’å¤‰æ›´</span>
                                </li>
                                <li class="flex items-start gap-2">
                                    <span class="text-green-600">â€¢</span>
                                    <span><strong>åˆæœŸå€¤ã«æˆ»ã™</strong>: ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã§ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ç¯„å›²ã«æˆ»ã™</span>
                                </li>
                            </ul>
                        </div>

                        <!-- AIåˆ†æ -->
                        <div class="bg-gradient-to-r from-purple-50 to-blue-50 p-4 rounded-lg border border-purple-200">
                            <h4 class="text-lg font-bold text-gray-800 mb-3 flex items-center gap-2">
                                <i data-lucide="sparkles" class="w-5 h-5 text-purple-600"></i>
                                AIåˆ†ææ©Ÿèƒ½
                            </h4>
                            <p class="text-sm text-gray-700 mb-3">
                                Gemini AIãŒã‚°ãƒ©ãƒ•ãƒ‡ãƒ¼ã‚¿ã‚’åˆ†æã—ã€ãƒˆãƒ¬ãƒ³ãƒ‰è©•ä¾¡ãƒ»æ”¹å–„ææ¡ˆã‚’ç”Ÿæˆã—ã¾ã™ã€‚
                            </p>
                            <ul class="space-y-2 text-sm text-gray-700">
                                <li class="flex items-start gap-2">
                                    <span class="text-purple-600">â€¢</span>
                                    <span><strong>ãƒˆãƒ¬ãƒ³ãƒ‰åˆ†æ</strong>: å¢—åŠ /æ¸›å°‘/æ¨ªã°ã„ã‚’åˆ¤å®šã—ç†ç”±ã‚’èª¬æ˜</span>
                                </li>
                                <li class="flex items-start gap-2">
                                    <span class="text-purple-600">â€¢</span>
                                    <span><strong>ç›®æ¨™é”æˆäºˆæ¸¬</strong>: ç¾åœ¨ã®ãƒšãƒ¼ã‚¹ã§ç›®æ¨™é”æˆã¾ã§ã®æ—¥æ•°ã‚’äºˆæ¸¬</span>
                                </li>
                                <li class="flex items-start gap-2">
                                    <span class="text-purple-600">â€¢</span>
                                    <span><strong>æ”¹å–„ææ¡ˆ</strong>: å…·ä½“çš„ãªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆé£Ÿäº‹/é‹å‹•/ä¼‘é¤Šï¼‰ã‚’3ã¤æç¤º</span>
                                </li>
                                <li class="flex items-start gap-2">
                                    <span class="text-purple-600">â€¢</span>
                                    <span><strong>æ³¨æ„ç‚¹</strong>: ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰æ°—ã‚’ã¤ã‘ã‚‹ã¹ããƒã‚¤ãƒ³ãƒˆã‚’æŠ½å‡º</span>
                                </li>
                            </ul>
                        </div>

                        <!-- çµ±è¨ˆæƒ…å ± -->
                        <div>
                            <h4 class="text-lg font-bold text-gray-800 mb-3 flex items-center gap-2">
                                <i data-lucide="bar-chart-3" class="w-5 h-5 text-orange-600"></i>
                                çµ±è¨ˆæƒ…å ±ã®è¦‹æ–¹
                            </h4>
                            <ul class="space-y-2 text-sm text-gray-700">
                                <li class="flex items-start gap-2">
                                    <span class="text-blue-600">â€¢</span>
                                    <span><strong>å¹³å‡</strong>: é¸æŠæœŸé–“å†…ã®å¹³å‡å€¤</span>
                                </li>
                                <li class="flex items-start gap-2">
                                    <span class="text-green-600">â€¢</span>
                                    <span><strong>æœ€é«˜</strong>: é¸æŠæœŸé–“å†…ã®æœ€é«˜å€¤</span>
                                </li>
                                <li class="flex items-start gap-2">
                                    <span class="text-orange-600">â€¢</span>
                                    <span><strong>æœ€ä½</strong>: é¸æŠæœŸé–“å†…ã®æœ€ä½å€¤</span>
                                </li>
                                <li class="flex items-start gap-2">
                                    <span class="text-purple-600">â€¢</span>
                                    <span><strong>æŒ‡ç¤ºæ›¸é”æˆçŠ¶æ³</strong>: é”æˆç‡ï¼ˆ%ï¼‰ã€å®Œäº†æ—¥æ•°ã€æœªå®Œäº†æ—¥æ•°ã‚’è¡¨ç¤º</span>
                                </li>
                            </ul>
                        </div>

                        <!-- ãƒ‡ãƒ¼ã‚¿ä¿å­˜ï¼ˆã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆæ¨å¥¨ï¼‰ -->
                        <div class="bg-green-50 p-4 rounded-lg border border-green-200">
                            <h4 class="text-lg font-bold text-gray-800 mb-3 flex items-center gap-2">
                                <i data-lucide="camera" class="w-5 h-5 text-green-600"></i>
                                ãƒ‡ãƒ¼ã‚¿ä¿å­˜æ–¹æ³•
                            </h4>
                            <p class="text-sm text-gray-700 mb-3">
                                ã‚°ãƒ©ãƒ•ã‚’ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆã§ä¿å­˜ã™ã‚‹ã“ã¨ã‚’æ¨å¥¨ã—ã¾ã™ï¼š
                            </p>
                            <ul class="space-y-2 text-sm text-gray-700">
                                <li class="flex items-start gap-2">
                                    <span class="text-green-600">ğŸ“¸</span>
                                    <span><strong>Windows</strong>: Win + Shift + Sï¼ˆç”»é¢ã®ä¸€éƒ¨ã‚’é¸æŠï¼‰</span>
                                </li>
                                <li class="flex items-start gap-2">
                                    <span class="text-green-600">ğŸ“¸</span>
                                    <span><strong>Mac</strong>: Cmd + Shift + 4ï¼ˆç”»é¢ã®ä¸€éƒ¨ã‚’é¸æŠï¼‰</span>
                                </li>
                                <li class="flex items-start gap-2">
                                    <span class="text-green-600">ğŸ“¸</span>
                                    <span><strong>ãƒ–ãƒ©ã‚¦ã‚¶</strong>: å³ã‚¯ãƒªãƒƒã‚¯ â†’ ã€Œãƒšãƒ¼ã‚¸ã®ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆã‚’æ’®ã‚‹ã€ï¼ˆFirefoxï¼‰</span>
                                </li>
                            </ul>
                        </div>

                        <!-- æ–°æ©Ÿèƒ½ï¼ˆç§»å‹•å¹³å‡ãƒ»é‡ã­åˆã‚ã›ï¼‰ -->
                        <div class="bg-gradient-to-r from-orange-50 to-yellow-50 p-4 rounded-lg border border-orange-200">
                            <h4 class="text-lg font-bold text-gray-800 mb-3 flex items-center gap-2">
                                <i data-lucide="sparkles" class="w-5 h-5 text-orange-600"></i>
                                æ–°æ©Ÿèƒ½
                            </h4>
                            <ul class="space-y-2 text-sm text-gray-700">
                                <li class="flex items-start gap-2 bg-white p-2 rounded">
                                    <span class="text-orange-600 font-bold">NEW</span>
                                    <div>
                                        <strong>ç§»å‹•å¹³å‡ç·š</strong>
                                        <p class="text-xs text-gray-600 mt-1">ä¸€å®šæœŸé–“ã®å¹³å‡å€¤ã‚’ç·šã§è¡¨ç¤ºã—ã€ãƒã‚¤ã‚ºã‚’é™¤å»ã—ã¦ãƒˆãƒ¬ãƒ³ãƒ‰ã‚’æ˜ç¢ºã«æŠŠæ¡ã§ãã¾ã™ã€‚3æ—¥/5æ—¥/7æ—¥/14æ—¥/30æ—¥ã‹ã‚‰é¸æŠå¯èƒ½ã€‚</p>
                                    </div>
                                </li>
                                <li class="flex items-start gap-2 bg-white p-2 rounded">
                                    <span class="text-orange-600 font-bold">NEW</span>
                                    <div>
                                        <strong>è¤‡æ•°æŒ‡æ¨™ã®é‡ã­åˆã‚ã›</strong>
                                        <p class="text-xs text-gray-600 mt-1">æœ€å¤§3ã¤ã®æŒ‡æ¨™ã‚’1ã¤ã®ã‚°ãƒ©ãƒ•ã«è¡¨ç¤ºã—ã€ç›¸é–¢é–¢ä¿‚ã‚’åˆ†æã§ãã¾ã™ã€‚ä¾‹: LBMã¨ç·åˆã‚¹ã‚³ã‚¢ã®é–¢ä¿‚ã‚’ç¢ºèªã€‚</p>
                                    </div>
                                </li>
                                <li class="flex items-start gap-2 bg-white p-2 rounded">
                                    <span class="text-green-600 font-bold">å¼·åŒ–</span>
                                    <div>
                                        <strong>ç›®æ¨™ãƒ©ã‚¤ãƒ³è¡¨ç¤º</strong>
                                        <p class="text-xs text-gray-600 mt-1">å„æŒ‡æ¨™ã«ç›®æ¨™å€¤ã‚’è¨­å®šã™ã‚‹ã¨ã€ã‚°ãƒ©ãƒ•ã«ç·‘è‰²ã®ç‚¹ç·šã§è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚é”æˆåº¦ãŒä¸€ç›®ç­ç„¶ã€‚</p>
                                    </div>
                                </li>
                                <li class="flex items-start gap-2 bg-white p-2 rounded">
                                    <span class="text-green-600 font-bold">å¼·åŒ–</span>
                                    <div>
                                        <strong>ãƒ¡ãƒ¢æ©Ÿèƒ½</strong>
                                        <p class="text-xs text-gray-600 mt-1">ã‚°ãƒ©ãƒ•ä¸Šã®ãƒã‚¤ãƒ³ãƒˆã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãƒ¡ãƒ¢ã‚’è¿½åŠ ã€‚ãƒãƒ¼ãƒˆãƒ‡ã‚¤ã€ä½“èª¿ä¸è‰¯ãªã©ã‚’è¨˜éŒ²ã—ã€ãƒ‡ãƒ¼ã‚¿ã¨ã®ç›¸é–¢ã‚’ç¢ºèªã§ãã¾ã™ã€‚</p>
                                    </div>
                                </li>
                            </ul>
                        </div>

                        <!-- ãƒ’ãƒ³ãƒˆ -->
                        <div class="bg-yellow-50 p-4 rounded-lg border border-yellow-200">
                            <h4 class="text-lg font-bold text-gray-800 mb-3 flex items-center gap-2">
                                <i data-lucide="lightbulb" class="w-5 h-5 text-yellow-600"></i>
                                æ´»ç”¨ãƒ’ãƒ³ãƒˆ
                            </h4>
                            <ul class="space-y-2 text-sm text-gray-700">
                                <li class="flex items-start gap-2">
                                    <span class="text-yellow-600">ğŸ’¡</span>
                                    <span>çŸ­æœŸï¼ˆ7æ—¥é–“ï¼‰ã§ç´°ã‹ã„å¤‰åŒ–ã‚’ç¢ºèªã—ã€é•·æœŸï¼ˆ30-90æ—¥é–“ï¼‰ã§å…¨ä½“çš„ãªãƒˆãƒ¬ãƒ³ãƒ‰ã‚’æŠŠæ¡ã—ã¾ã—ã‚‡ã†</span>
                                </li>
                                <li class="flex items-start gap-2">
                                    <span class="text-yellow-600">ğŸ’¡</span>
                                    <span>æ¯”è¼ƒãƒ¢ãƒ¼ãƒ‰ã§çŸ­æœŸã¨é•·æœŸã‚’ä¸¦ã¹ã¦è¡¨ç¤ºã™ã‚‹ã¨ã€ä¸€æ™‚çš„ãªå¤‰å‹•ã¨æœ¬å½“ã®ãƒˆãƒ¬ãƒ³ãƒ‰ã‚’åŒºåˆ¥ã§ãã¾ã™</span>
                                </li>
                                <li class="flex items-start gap-2">
                                    <span class="text-yellow-600">ğŸ’¡</span>
                                    <span>Yè»¸ç¯„å›²ã‚’èª¿æ•´ã™ã‚‹ã“ã¨ã§ã€å°ã•ãªå¤‰åŒ–ã‚‚å¤§ããè¡¨ç¤ºã§ãã€å¾®ç´°ãªãƒˆãƒ¬ãƒ³ãƒ‰ã‚’ç™ºè¦‹ã§ãã¾ã™</span>
                                </li>
                                <li class="flex items-start gap-2">
                                    <span class="text-yellow-600">ğŸ’¡</span>
                                    <span>ç§»å‹•å¹³å‡ç·šï¼ˆ7æ—¥ï¼‰ã‚’è¡¨ç¤ºã™ã‚‹ã¨ã€æ—¥ã€…ã®å¤‰å‹•ã«æƒ‘ã‚ã•ã‚Œãšã€æœ¬å½“ã®ãƒˆãƒ¬ãƒ³ãƒ‰ãŒè¦‹ãˆã¦ãã¾ã™</span>
                                </li>
                                <li class="flex items-start gap-2">
                                    <span class="text-yellow-600">ğŸ’¡</span>
                                    <span>è¤‡æ•°æŒ‡æ¨™ã‚’é‡ã­åˆã‚ã›ã¦ã€å› æœé–¢ä¿‚ã‚’ç™ºè¦‹ã—ã¾ã—ã‚‡ã†ï¼ˆä¾‹: ä½“é‡ã¨ã‚«ãƒ­ãƒªãƒ¼ã®é–¢ä¿‚ï¼‰</span>
                                </li>
                                <li class="flex items-start gap-2">
                                    <span class="text-yellow-600">ğŸ’¡</span>
                                    <span>AIåˆ†æã¯å®šæœŸçš„ã«å®Ÿè¡Œã—ã€å®¢è¦³çš„ãªãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚’å—ã‘ã‚‹ã“ã¨ã§æ”¹å–„ã«ã¤ãªã’ã¾ã—ã‚‡ã†</span>
                                </li>
                                <li class="flex items-start gap-2">
                                    <span class="text-yellow-600">ğŸ’¡</span>
                                    <span>ã‚°ãƒ©ãƒ•ã«ãƒ¡ãƒ¢ï¼ˆğŸ“ï¼‰ã‚’è¿½åŠ ã—ã¦ã€ç‰¹åˆ¥ãªæ—¥ï¼ˆãƒãƒ¼ãƒˆãƒ‡ã‚¤ã€é¢¨é‚ªãªã©ï¼‰ã‚’è¨˜éŒ²ã§ãã¾ã™</span>
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ— -->
        <div id="tooltip" class="tooltip"></div>

        <!-- ãƒ•ãƒ­ãƒ¼ãƒ†ã‚£ãƒ³ã‚°è¨­å®šãƒ‘ãƒãƒ« -->
        <div id="settings-panel" class="floating-panel hidden">
            <div class="sticky top-0 bg-gradient-to-r from-gray-700 to-gray-600 text-white p-4 rounded-t-xl">
                <div class="flex justify-between items-center">
                    <div class="flex items-center gap-2">
                        <i data-lucide="settings" class="w-5 h-5"></i>
                        <h3 class="text-lg font-bold">ã‚°ãƒ©ãƒ•è¨­å®š</h3>
                    </div>
                    <button type="button" onclick="closeSettingsPanel()" class="p-1 hover:bg-white/20 rounded">
                        <i data-lucide="x" class="w-5 h-5"></i>
                    </button>
                </div>
            </div>

            <div class="p-4 space-y-6">
                <!-- ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ -->
                <div class="grid grid-cols-2 gap-2">
                    <button type="button" onclick="openGoalSettingModal(); closeSettingsPanel();" class="flex items-center justify-center gap-2 px-4 py-3 bg-green-500 text-white rounded-lg hover:bg-green-600 transition font-semibold text-sm">
                        <i data-lucide="target" class="w-4 h-4"></i>
                        ç›®æ¨™è¨­å®š
                    </button>
                    <button type="button" onclick="openHelpModal(); closeSettingsPanel();" class="flex items-center justify-center gap-2 px-4 py-3 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition font-semibold text-sm">
                        <i data-lucide="help-circle" class="w-4 h-4"></i>
                        ä½¿ã„æ–¹
                    </button>
                </div>

                <!-- ã‚«ã‚¹ã‚¿ãƒ æœŸé–“è¨­å®š -->
                <div>
                    <h4 class="font-bold text-gray-800 mb-3 flex items-center gap-2">
                        <i data-lucide="calendar" class="w-4 h-4 text-indigo-600"></i>
                        ã‚«ã‚¹ã‚¿ãƒ æœŸé–“
                    </h4>
                    <div class="space-y-2">
                        <div>
                            <label class="text-xs text-gray-600 block mb-1">é–‹å§‹æ—¥</label>
                            <input type="text" id="custom-start-panel" placeholder="é–‹å§‹æ—¥ã‚’é¸æŠ" class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                        </div>
                        <div>
                            <label class="text-xs text-gray-600 block mb-1">çµ‚äº†æ—¥</label>
                            <input type="text" id="custom-end-panel" placeholder="çµ‚äº†æ—¥ã‚’é¸æŠ" class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                        </div>
                        <button type="button" onclick="applyCustomPeriodFromPanel()" class="w-full px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition font-semibold text-sm">
                            é©ç”¨
                        </button>
                    </div>
                </div>

                <!-- Yè»¸ç¯„å›²è¨­å®š -->
                <div>
                    <h4 class="font-bold text-gray-800 mb-3 flex items-center gap-2">
                        <i data-lucide="sliders-horizontal" class="w-4 h-4 text-green-600"></i>
                        Yè»¸ç¯„å›²
                    </h4>
                    <div class="space-y-2">
                        <div>
                            <label class="text-xs text-gray-600 block mb-1">æœ€å°å€¤</label>
                            <input type="number" id="axis-min-panel" step="0.1" class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent" onchange="updateAxisRangeFromPanel()">
                        </div>
                        <div>
                            <label class="text-xs text-gray-600 block mb-1">æœ€å¤§å€¤</label>
                            <input type="number" id="axis-max-panel" step="0.1" class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent" onchange="updateAxisRangeFromPanel()">
                        </div>
                        <button type="button" onclick="resetAxisRangeFromPanel()" class="w-full px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition font-semibold text-sm">
                            åˆæœŸå€¤ã«æˆ»ã™
                        </button>
                    </div>
                </div>

                <!-- è¡¨ç¤ºã‚ªãƒ—ã‚·ãƒ§ãƒ³ -->
                <div>
                    <h4 class="font-bold text-gray-800 mb-3 flex items-center gap-2">
                        <i data-lucide="eye" class="w-4 h-4 text-purple-600"></i>
                        è¡¨ç¤ºã‚ªãƒ—ã‚·ãƒ§ãƒ³
                    </h4>
                    <div class="space-y-3">
                        <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                            <div class="flex items-center gap-2">
                                <i data-lucide="columns-2" class="w-4 h-4 text-blue-600"></i>
                                <label for="comparison-mode-panel" class="text-sm font-semibold text-gray-700">æ¯”è¼ƒãƒ¢ãƒ¼ãƒ‰</label>
                            </div>
                            <input type="checkbox" id="comparison-mode-panel" class="w-4 h-4" onchange="toggleComparisonMode()">
                        </div>
                        <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                            <div class="flex items-center gap-2">
                                <i data-lucide="refresh-cw" class="w-4 h-4 text-purple-600"></i>
                                <label for="sync-axis-panel" class="text-sm font-semibold text-gray-700">Yè»¸é€£å‹•</label>
                            </div>
                            <input type="checkbox" id="sync-axis-panel" class="w-4 h-4" checked onchange="toggleAxisSync()">
                        </div>
                        <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                            <div class="flex items-center gap-2">
                                <i data-lucide="trending-up" class="w-4 h-4 text-orange-600"></i>
                                <label for="moving-average-panel" class="text-sm font-semibold text-gray-700">ç§»å‹•å¹³å‡ç·š</label>
                            </div>
                            <input type="checkbox" id="moving-average-panel" class="w-4 h-4" onchange="toggleMovingAverage(1)">
                        </div>
                        <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                            <div class="flex items-center gap-2">
                                <i data-lucide="arrow-right" class="w-4 h-4 text-green-600"></i>
                                <label for="prediction-panel" class="text-sm font-semibold text-gray-700">äºˆæ¸¬ç·šï¼ˆ7æ—¥å…ˆï¼‰</label>
                            </div>
                            <input type="checkbox" id="prediction-panel" class="w-4 h-4" onchange="togglePrediction(1)">
                        </div>
                    </div>
                </div>

                <!-- ç§»å‹•å¹³å‡æœŸé–“ -->
                <div>
                    <h4 class="font-bold text-gray-800 mb-3 flex items-center gap-2">
                        <i data-lucide="calendar" class="w-4 h-4 text-indigo-600"></i>
                        ç§»å‹•å¹³å‡æœŸé–“
                    </h4>
                    <div class="space-y-2">
                        <select id="ma-period-panel" onchange="changeMovingAveragePeriod(1, this.value)" class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                            <option value="3">3æ—¥</option>
                            <option value="5">5æ—¥</option>
                            <option value="7" selected>7æ—¥</option>
                            <option value="14">14æ—¥</option>
                            <option value="30">30æ—¥</option>
                        </select>
                    </div>
                </div>

                <!-- ä¸‹ã‚°ãƒ©ãƒ•ã®ã‚«ãƒ†ã‚´ãƒªé¸æŠ -->
                <div>
                    <h4 class="font-bold text-gray-800 mb-3 flex items-center gap-2">
                        <i data-lucide="bar-chart-2" class="w-4 h-4 text-blue-600"></i>
                        ä¸‹ã‚°ãƒ©ãƒ•ã®ã‚«ãƒ†ã‚´ãƒª
                    </h4>
                    <div class="space-y-2">
                        <select id="chart2-category-panel" onchange="changeChart2Category(this.value)" class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            <option value="lbm" selected>ğŸ’ª LBM - é™¤è„‚è‚ªä½“é‡</option>
                            <option value="directive">ğŸ“‹ æŒ‡ç¤ºæ›¸é”æˆçŠ¶æ³</option>
                            <option value="overall">ğŸ¯ ç·åˆåˆ†æã‚¹ã‚³ã‚¢</option>
                        </select>
                        <p class="text-xs text-gray-500">æ¯”è¼ƒãƒ¢ãƒ¼ãƒ‰ONæ™‚ã€ä¸Šã‚°ãƒ©ãƒ•ã¨ç•°ãªã‚‹æŒ‡æ¨™ã‚’è¡¨ç¤ºã§ãã¾ã™</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- ç›®æ¨™è¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ« -->
        <div id="goal-setting-modal" class="modal">
            <div class="modal-content">
                <div class="sticky top-0 bg-gradient-to-r from-green-600 to-teal-600 text-white p-4 rounded-t-lg">
                    <div class="flex justify-between items-center">
                        <div class="flex items-center gap-2">
                            <i data-lucide="target" class="w-5 h-5"></i>
                            <h3 class="text-lg font-bold">ç›®æ¨™è¨­å®š</h3>
                        </div>
                        <button type="button" onclick="closeGoalSettingModal()" class="p-1 hover:bg-white/20 rounded">
                            <i data-lucide="x" class="w-5 h-5"></i>
                        </button>
                    </div>
                </div>
                <div class="p-6">
                    <div class="space-y-4">
                        <!-- æŒ‡æ¨™é¸æŠ -->
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">ç›®æ¨™ã‚’è¨­å®šã™ã‚‹æŒ‡æ¨™</label>
                            <select id="goal-metric" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                                <option value="lbm">ğŸ’ª LBM - é™¤è„‚è‚ªä½“é‡</option>
                                <option value="overall">ğŸ¯ ç·åˆåˆ†æã‚¹ã‚³ã‚¢</option>
                            </select>
                        </div>

                        <!-- ç›®æ¨™å€¤ -->
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">ç›®æ¨™å€¤</label>
                            <div class="flex items-center gap-2">
                                <input type="number" id="goal-value" step="0.1" placeholder="ä¾‹: 65.0" class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                                <span id="goal-unit" class="text-gray-600 font-semibold">kg</span>
                            </div>
                        </div>

                        <!-- é”æˆäºˆå®šæ—¥ -->
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">é”æˆäºˆå®šæ—¥ï¼ˆä»»æ„ï¼‰</label>
                            <input type="date" id="goal-date" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                        </div>

                        <!-- ã‚°ãƒ©ãƒ•ã«è¡¨ç¤ºã™ã‚‹ã‹ -->
                        <div class="flex items-center gap-2">
                            <input type="checkbox" id="goal-show-line" checked class="w-4 h-4">
                            <label for="goal-show-line" class="text-sm font-semibold text-gray-700">ã‚°ãƒ©ãƒ•ã«ç›®æ¨™ãƒ©ã‚¤ãƒ³ã‚’è¡¨ç¤º</label>
                        </div>

                        <!-- ç¾åœ¨ã®ç›®æ¨™ -->
                        <div id="current-goal-info" class="bg-blue-50 p-4 rounded-lg border border-blue-200 hidden">
                            <h4 class="text-sm font-bold text-blue-700 mb-2">ç¾åœ¨ã®ç›®æ¨™</h4>
                            <div id="current-goal-text" class="text-sm text-gray-700"></div>
                        </div>

                        <!-- ãƒœã‚¿ãƒ³ -->
                        <div class="flex gap-3">
                            <button type="button" onclick="saveGoal()" class="flex-1 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition flex items-center justify-center gap-2 font-semibold">
                                <i data-lucide="check" class="w-4 h-4"></i>
                                ç›®æ¨™ã‚’ä¿å­˜
                            </button>
                            <button type="button" onclick="clearGoal()" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition font-semibold">
                                ã‚¯ãƒªã‚¢
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <!-- ãƒ‰ãƒªãƒ«ãƒ€ã‚¦ãƒ³ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="drilldown-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden" onclick="closeDrillDownModal()">
        <div class="bg-white rounded-lg shadow-2xl w-11/12 max-w-2xl max-h-[90vh] overflow-y-auto" onclick="event.stopPropagation()">
            <!-- ãƒ¢ãƒ¼ãƒ€ãƒ«ãƒ˜ãƒƒãƒ€ãƒ¼ -->
            <div class="sticky top-0 bg-gradient-to-r from-purple-600 to-blue-600 text-white p-4 rounded-t-lg flex items-center justify-between z-10">
                <div class="flex items-center gap-3">
                    <i data-lucide="calendar" class="w-6 h-6"></i>
                    <div>
                        <h3 class="text-xl font-bold" id="drilldown-title">è©³ç´°æƒ…å ±</h3>
                        <p class="text-sm opacity-90" id="drilldown-subtitle">æ—¥ä»˜ã¨å€¤</p>
                    </div>
                </div>
                <button type="button" onclick="closeDrillDownModal()" class="p-2 hover:bg-white hover:bg-opacity-20 rounded-full transition">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>

            <!-- ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
            <div class="p-6">
                <!-- ãƒ¡ãƒˆãƒªã‚¯ã‚¹æƒ…å ± -->
                <div class="bg-gradient-to-r from-purple-50 to-blue-50 rounded-lg p-4 mb-4 border border-purple-200">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-gray-600 mb-1">æŒ‡æ¨™</p>
                            <p class="text-2xl font-bold text-purple-700" id="drilldown-metric"></p>
                        </div>
                        <div class="text-right">
                            <p class="text-sm text-gray-600 mb-1">å€¤</p>
                            <p class="text-3xl font-bold text-blue-700" id="drilldown-value"></p>
                        </div>
                    </div>
                </div>

                <!-- ãƒ¡ãƒ¢ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
                <div class="bg-gray-50 rounded-lg p-4 mb-4">
                    <h4 class="font-semibold text-gray-800 mb-3 flex items-center gap-2">
                        <i data-lucide="message-square" class="w-4 h-4 text-orange-600"></i>
                        ãƒ¡ãƒ¢
                    </h4>
                    <div id="drilldown-memo-display" class="mb-3 hidden">
                        <div class="bg-white p-3 rounded border border-gray-200">
                            <p class="text-sm text-gray-700" id="drilldown-memo-text"></p>
                        </div>
                    </div>
                    <div id="drilldown-memo-empty" class="text-sm text-gray-500 italic mb-3">
                        ã“ã®ãƒ‡ãƒ¼ã‚¿ãƒã‚¤ãƒ³ãƒˆã«ã¯ãƒ¡ãƒ¢ãŒã‚ã‚Šã¾ã›ã‚“
                    </div>
                    <button type="button"
                        onclick="toggleMemoEdit()"
                        class="text-sm px-3 py-2 bg-orange-500 text-white rounded-lg hover:bg-orange-600 transition flex items-center gap-2">
                        <i data-lucide="edit" class="w-4 h-4"></i>
                        <span id="memo-edit-button-text">ãƒ¡ãƒ¢ã‚’è¿½åŠ </span>
                    </button>
                    <div id="drilldown-memo-edit" class="mt-3 hidden">
                        <textarea
                            id="drilldown-memo-input"
                            rows="3"
                            placeholder="ãƒ¡ãƒ¢ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆä¾‹: ãƒãƒ¼ãƒˆãƒ‡ã‚¤ã€ä½“èª¿ä¸è‰¯ãªã©ï¼‰"
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-orange-500"></textarea>
                        <div class="flex gap-2 mt-2">
                            <button type="button"
                                onclick="saveMemo()"
                                class="flex-1 px-3 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 transition text-sm font-semibold">
                                ä¿å­˜
                            </button>
                            <button type="button"
                                onclick="deleteMemo()"
                                class="px-3 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition text-sm font-semibold">
                                å‰Šé™¤
                            </button>
                            <button type="button"
                                onclick="toggleMemoEdit()"
                                class="px-3 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400 transition text-sm font-semibold">
                                ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                            </button>
                        </div>
                    </div>
                </div>

                <!-- é–¢é€£ãƒ‡ãƒ¼ã‚¿ï¼ˆå°†æ¥ã®æ‹¡å¼µç”¨ï¼‰ -->
                <div class="bg-blue-50 rounded-lg p-4">
                    <h4 class="font-semibold text-gray-800 mb-3 flex items-center gap-2">
                        <i data-lucide="info" class="w-4 h-4 text-blue-600"></i>
                        ã“ã®æ—¥ã®æƒ…å ±
                    </h4>
                    <p class="text-sm text-gray-600">
                        ã‚ˆã‚Šè©³ç´°ãªæƒ…å ±ï¼ˆé£Ÿäº‹ã€ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ãªã©ï¼‰ã¯ã€ãƒ¡ã‚¤ãƒ³ã‚¢ãƒ—ãƒªã®ã€Œå±¥æ­´ã€ã‚¿ãƒ–ã‹ã‚‰ç¢ºèªã§ãã¾ã™ã€‚
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- å±¥æ­´åˆ†æãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="history-analysis-loading-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-[9999] flex items-center justify-center">
        <div class="bg-white rounded-2xl p-8 text-center max-w-sm mx-4">
            <div class="mb-4">
                <div class="inline-block animate-spin rounded-full h-16 w-16 border-4 border-purple-200 border-t-purple-600"></div>
            </div>
            <h3 class="text-xl font-bold text-gray-800 mb-2">åˆ†æä¸­...</h3>
            <p class="text-sm text-gray-600">æœŸé–“ãƒ‡ãƒ¼ã‚¿ã‚’åˆ†æã—ã¦ã„ã¾ã™</p>
        </div>
    </div>

    <!-- å±¥æ­´åˆ†æãƒ¬ãƒãƒ¼ãƒˆãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="history-analysis-report-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-[9999] flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl w-full max-w-3xl max-h-[90vh] overflow-hidden flex flex-col">
            <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
            <div class="p-6 border-b bg-gradient-to-r from-purple-600 to-blue-600 text-white">
                <div class="flex justify-between items-start mb-2">
                    <h2 class="text-2xl font-bold">ğŸ“Š æœŸé–“åˆ†æãƒ¬ãƒãƒ¼ãƒˆ</h2>
                    <button onclick="closeHistoryAnalysisModal()" class="p-2 hover:bg-white/20 rounded-full transition">
                        <i data-lucide="x" class="w-6 h-6"></i>
                    </button>
                </div>
                <p class="text-sm opacity-90" id="history-analysis-period"></p>
            </div>

            <!-- ãƒ¬ãƒãƒ¼ãƒˆå†…å®¹ -->
            <div class="flex-1 overflow-y-auto p-6">
                <div id="history-analysis-report-content" class="prose max-w-none">
                    <!-- AIãƒ¬ãƒãƒ¼ãƒˆãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã‚‹ -->
                </div>
            </div>

            <!-- è³ªå•å…¥åŠ›ã‚¨ãƒªã‚¢ -->
            <div class="border-t bg-gray-50 p-4">
                <div class="flex items-center gap-2">
                    <input
                        type="text"
                        id="history-analysis-question-input"
                        placeholder="ã“ã®ãƒ‡ãƒ¼ã‚¿ã«ã¤ã„ã¦è³ªå•ã™ã‚‹..."
                        class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500"
                        onkeypress="if(event.key==='Enter') askHistoryAnalysisQuestion()"
                    />
                    <button
                        onclick="askHistoryAnalysisQuestion()"
                        class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition"
                    >
                        <i data-lucide="send" class="w-5 h-5"></i>
                    </button>
                </div>
                <div id="history-analysis-answer" class="mt-3 hidden">
                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-3">
                        <p class="text-sm font-semibold text-blue-900 mb-1">ğŸ’¬ å›ç­”</p>
                        <p id="history-analysis-answer-text" class="text-sm text-gray-700"></p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ===== FirebaseåˆæœŸåŒ– =====
        let auth, db, storage, functions;
        if (!DEV_MODE) {
            if (!firebase.apps.length) {
                firebase.initializeApp(FIREBASE_CONFIG);
            }
            auth = firebase.auth();
            db = firebase.firestore();
            storage = firebase.storage();
            functions = firebase.functions();
        }

        // Lucideã‚¢ã‚¤ã‚³ãƒ³åˆæœŸåŒ–
        lucide.createIcons();

        let currentMainCategory = 'performance';
        let currentSubCategory = 'lbm';
        let comparisonMode = false;
        let axisSync = true; // Yè»¸é€£å‹•ON/OFF
        let charts = { 1: null, 2: null };
        let currentPeriods = { 1: 7, 2: 30 };
        let currentAxisRanges = { 1: { min: null, max: null }, 2: { min: null, max: null } };
        let globalMinMax = { min: 0, max: 100 }; // å…¨æœŸé–“ã®æœ€ä½å€¤ãƒ»æœ€å¤§å€¤
        let currentData = { 1: [], 2: [] };
        let goals = {}; // ç›®æ¨™ãƒ‡ãƒ¼ã‚¿ï¼ˆLocalStorageã‹ã‚‰èª­ã¿è¾¼ã¿ï¼‰
        let annotations = {}; // ã‚¢ãƒãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆãƒ¡ãƒ¢ï¼‰ãƒ‡ãƒ¼ã‚¿
        let showMovingAverage = { 1: false, 2: false }; // ç§»å‹•å¹³å‡ç·šè¡¨ç¤º
        let selectedDataIndex = { 1: null, 2: null }; // é¸æŠã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ãƒã‚¤ãƒ³ãƒˆã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
        let movingAveragePeriod = { 1: 7, 2: 7 }; // ç§»å‹•å¹³å‡ã®æœŸé–“
        let showPrediction = { 1: false, 2: false }; // äºˆæ¸¬ç·šè¡¨ç¤º
        let chart2Category = 'lbm'; // Chart2ã®è¡¨ç¤ºã‚«ãƒ†ã‚´ãƒª

        // ãƒ‰ãƒªãƒ«ãƒ€ã‚¦ãƒ³ãƒ¢ãƒ¼ãƒ€ãƒ«ç”¨ã®å¤‰æ•°
        let currentDrillDownData = {
            chartNum: null,
            index: null,
            label: null,
            value: null,
            metric: null,
            annotationKey: null
        };

        // ã‚¯ãƒ­ã‚¹ãƒ˜ã‚¢ç”¨ã®å¤‰æ•°
        let crosshairPosition = { x: null, y: null };
        let showCrosshair = false;

        // é–ƒããƒ¡ãƒ¢ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ã™ã‚‹å¤‰æ•°ï¼ˆæ—¥ä»˜ -> ãƒ¡ãƒ¢ã®ãƒãƒƒãƒ—ï¼‰
        let dailyNotes = {};

        // æŒ‡æ¨™ã®æ—¥æœ¬èªåã¨ãƒ¡ã‚¿æƒ…å ±
        const metricInfo = {
            // ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹
            lbm: { name: 'LBM - é™¤è„‚è‚ªä½“é‡', unit: 'kg', category: 'performance' },
            directive: { name: 'æŒ‡ç¤ºæ›¸é”æˆçŠ¶æ³', unit: '', isBinary: true, category: 'performance' },
            overall: { name: 'ç·åˆåˆ†æã‚¹ã‚³ã‚¢', unit: 'ç‚¹', category: 'performance' },

            // é£Ÿäº‹
            calories: { name: 'æ‘‚å–ã‚«ãƒ­ãƒªãƒ¼', unit: 'kcal', category: 'nutrition' },
            protein: { name: 'ã‚¿ãƒ³ãƒ‘ã‚¯è³ª', unit: 'g', category: 'nutrition' },
            fat: { name: 'è„‚è³ª', unit: 'g', category: 'nutrition' },
            carbs: { name: 'ç‚­æ°´åŒ–ç‰©', unit: 'g', category: 'nutrition' },
            sugar: { name: 'ç³–è³ª', unit: 'g', category: 'nutrition' },
            fiber: { name: 'é£Ÿç‰©ç¹Šç¶­', unit: 'g', category: 'nutrition' },
            vitamin_score: { name: 'ãƒ“ã‚¿ãƒŸãƒ³é”æˆç‡', unit: '%', category: 'nutrition' },
            mineral_score: { name: 'ãƒŸãƒãƒ©ãƒ«é”æˆç‡', unit: '%', category: 'nutrition' },

            // é‹å‹•
            total_time: { name: 'ç·æ™‚é–“', unit: 'åˆ†', category: 'training', icon: 'â±ï¸' },
            total_exercises: { name: 'ç·ç¨®ç›®æ•°', unit: 'ç¨®ç›®', category: 'training', icon: 'ğŸ‹ï¸' },
            total_weight: { name: 'ç·é‡é‡', unit: 'kg', category: 'training', icon: 'ğŸ’ª' },

            // ã‚³ãƒ³ãƒ‡ã‚£ã‚·ãƒ§ãƒ³
            sleep_duration: {
                name: 'ç¡çœ æ™‚é–“',
                unit: '',
                category: 'condition',
                getLabel: (value) => {
                    const labels = ['æœªè¨˜éŒ²', '5hä»¥ä¸‹', '6h', '7h', '8h', '9hä»¥ä¸Š'];
                    return labels[value] || `${value}ç‚¹`;
                }
            },
            sleep_quality: {
                name: 'ç¡çœ ã®è³ª',
                unit: '',
                category: 'condition',
                getLabel: (value) => {
                    const labels = ['æœªè¨˜éŒ²', 'æœ€æ‚ª', 'æ‚ª', 'æ™®é€š', 'è‰¯', 'æœ€é«˜'];
                    return labels[value] || `${value}ç‚¹`;
                }
            },
            appetite: {
                name: 'é£Ÿæ¬²',
                unit: '',
                category: 'condition',
                getLabel: (value) => {
                    const labels = ['æœªè¨˜éŒ²', 'ãªã—', 'å°‘', 'æ™®é€š', 'è‰¯å¥½', 'æœ€é«˜'];
                    return labels[value] || `${value}ç‚¹`;
                }
            },
            gut_health: {
                name: 'è…¸å†…ç’°å¢ƒ',
                unit: '',
                category: 'condition',
                getLabel: (value) => {
                    const labels = ['æœªè¨˜éŒ²', 'ä¸èª¿', 'ã‚„ã‚„æ‚ª', 'æ™®é€š', 'è‰¯å¥½', 'æœ€é«˜'];
                    return labels[value] || `${value}ç‚¹`;
                }
            },
            focus: {
                name: 'é›†ä¸­åŠ›',
                unit: '',
                category: 'condition',
                getLabel: (value) => {
                    const labels = ['æœªè¨˜éŒ²', 'æœ€ä½', 'ä½', 'æ™®é€š', 'é«˜', 'æœ€é«˜'];
                    return labels[value] || `${value}ç‚¹`;
                }
            },
            stress: {
                name: 'ã‚¹ãƒˆãƒ¬ã‚¹',
                unit: '',
                category: 'condition',
                getLabel: (value) => {
                    const labels = ['æœªè¨˜éŒ²', 'æ¥µå¤§', 'é«˜', 'æ™®é€š', 'ä½', 'ãªã—'];
                    return labels[value] || `${value}ç‚¹`;
                }
            }
        };

        // å®Ÿéš›ã®ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚€é–¢æ•°
        async function loadRealData() {
            const userId = window.currentUser?.uid || 'demo_user';
            const allData = {
                // ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹
                lbm: [],
                directive: [],
                overall: [],
                // é£Ÿäº‹
                calories: [],
                protein: [],
                fat: [],
                carbs: [],
                sugar: [],
                fiber: [],
                vitamin_score: [],
                mineral_score: [],
                // é‹å‹•
                total_time: [],
                total_exercises: [],
                total_weight: [],
                rm: {}, // å›æ•°Ã—ç¨®ç›®åˆ¥ã®RMè¨˜éŒ²
                // ã‚³ãƒ³ãƒ‡ã‚£ã‚·ãƒ§ãƒ³
                sleep_duration: [],
                sleep_quality: [],
                appetite: [],
                gut_health: [],
                focus: [],
                stress: []
            };

            // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³ã§æ—¥ä»˜ã‚’å–å¾—ã™ã‚‹é–¢æ•°
            const getLocalDateString = (date) => {
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                return `${year}-${month}-${day}`;
            };

            // å…¨æœŸé–“ã®ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ï¼ˆéå»90æ—¥åˆ†ï¼‰
            const today = getLocalDateString(new Date());
            console.log('[å±¥æ­´ãƒ‡ãƒ¼ã‚¿å–å¾—] é–‹å§‹ - userId:', userId, 'today:', today);

            // LocalStorageã®å†…å®¹ã‚’ç¢ºèªï¼ˆDEV_MODEç”¨ï¼‰
            if (typeof DEV_MODE !== 'undefined' && DEV_MODE) {
                const storageKey = typeof STORAGE_KEYS !== 'undefined' ? STORAGE_KEYS.DAILY_RECORDS : 'yourCoachBeta_dailyRecords';
                const saved = localStorage.getItem(storageKey);
                if (saved) {
                    const records = JSON.parse(saved);
                    console.log('[å±¥æ­´ãƒ‡ãƒ¼ã‚¿å–å¾—] LocalStorageå†…ã®æ—¥ä»˜ä¸€è¦§:', Object.keys(records));
                    console.log('[å±¥æ­´ãƒ‡ãƒ¼ã‚¿å–å¾—] ä»Šæ—¥ã®ãƒ‡ãƒ¼ã‚¿:', records[today]);
                } else {
                    console.log('[å±¥æ­´ãƒ‡ãƒ¼ã‚¿å–å¾—] LocalStorageã«ãƒ‡ãƒ¼ã‚¿ãªã—');
                }
            }

            for (let i = 89; i >= 0; i--) {
                const date = new Date();
                date.setDate(date.getDate() - i);
                const dateStr = getLocalDateString(date);

                let record = null;
                if (typeof DataService !== 'undefined') {
                    record = await DataService.getDailyRecord(userId, dateStr);
                }

                if (record) {
                    console.log(`[å±¥æ­´ãƒ‡ãƒ¼ã‚¿å–å¾—] ${dateStr} (${i}æ—¥å‰): meals=${record.meals?.length || 0}, workouts=${record.workouts?.length || 0}, conditions=${record.conditions ? 'ã‚ã‚Š' : 'ãªã—'}`);
                } else if (i <= 7) {
                    // éå»7æ—¥åˆ†ã¯ãƒ­ã‚°å‡ºåŠ›ï¼ˆãƒ‡ãƒãƒƒã‚°ç”¨ï¼‰
                    console.log(`[å±¥æ­´ãƒ‡ãƒ¼ã‚¿å–å¾—] ${dateStr} (${i}æ—¥å‰): ãƒ‡ãƒ¼ã‚¿ãªã—`);
                }

                if (record) {
                    // é£Ÿäº‹ãƒ‡ãƒ¼ã‚¿ - mealsã‹ã‚‰é›†è¨ˆ
                    const meals = record.meals || [];
                    let totalCalories = 0, totalProtein = 0, totalCarbs = 0, totalFat = 0, totalSugar = 0, totalFiber = 0;
                    meals.forEach(meal => {
                        totalCalories += meal.calories || 0;
                        // meal.itemsã‹ã‚‰è©³ç´°ãªæ „é¤Šç´ ã‚’é›†è¨ˆ
                        (meal.items || []).forEach(item => {
                            totalProtein += item.protein || 0;
                            totalFat += item.fat || 0;
                            totalCarbs += item.carbs || 0;
                            totalSugar += item.sugar || 0;
                            totalFiber += item.fiber || 0;
                        });
                    });
                    allData.calories.push(totalCalories);
                    allData.protein.push(totalProtein);
                    allData.fat.push(totalFat);
                    allData.carbs.push(totalCarbs);
                    allData.sugar.push(totalSugar);
                    allData.fiber.push(totalFiber);

                    // ãƒ“ã‚¿ãƒŸãƒ³ãƒ»ãƒŸãƒãƒ©ãƒ«é”æˆç‡ï¼ˆä»®è¨ˆç®— - å®Ÿè£…ã«å¿œã˜ã¦èª¿æ•´ï¼‰
                    allData.vitamin_score.push(record.vitaminScore || 0);
                    allData.mineral_score.push(record.mineralScore || 0);

                    // é‹å‹•ãƒ‡ãƒ¼ã‚¿ - workoutsã‹ã‚‰é›†è¨ˆ
                    const workouts = record.workouts || [];
                    let totalTime = 0, totalExercises = workouts.length, totalWeight = 0;
                    const rmData = {}; // å›æ•°Ã—ç¨®ç›®åˆ¥ã®RMãƒ‡ãƒ¼ã‚¿

                    workouts.forEach(workout => {
                        totalTime += workout.duration || 0;

                        // exercisesãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ãŒã‚ã‚‹å ´åˆï¼ˆæ–°å½¢å¼ï¼‰
                        if (workout.exercises) {
                            workout.exercises.forEach(exercise => {
                                const exerciseName = exercise.exercise?.name || exercise.name || 'unknown';

                                (exercise.sets || []).forEach(set => {
                                    const weight = set.weight || 0;
                                    const reps = set.reps || 0;
                                    totalWeight += weight * reps;

                                    // RMè¨˜éŒ²ãŒã‚ã‚Œã°ãã¡ã‚‰ã‚’ä½¿ç”¨ï¼ˆå„ªå…ˆï¼‰
                                    if (set.rm && set.rmWeight) {
                                        const key = `${set.rm}_${exerciseName}`;
                                        rmData[key] = Math.max(rmData[key] || 0, set.rmWeight);
                                    }
                                    // RMè¨˜éŒ²ãŒãªã„å ´åˆã¯é€šå¸¸ã®ã‚»ãƒƒãƒˆãƒ‡ãƒ¼ã‚¿ã‹ã‚‰æ¨å®š
                                    else if (reps > 0 && weight > 0) {
                                        const key = `${reps}_${exerciseName}`;
                                        rmData[key] = Math.max(rmData[key] || 0, weight);
                                    }
                                });
                            });
                        }
                        // æ—§å½¢å¼ï¼ˆsetsãŒç›´æ¥workoutã®ä¸‹ã«ã‚ã‚‹ï¼‰
                        else {
                            const exerciseName = workout.name || 'unknown';

                            (workout.sets || []).forEach(set => {
                                const weight = set.weight || 0;
                                const reps = set.reps || 0;
                                totalWeight += weight * reps;

                                // RMè¨˜éŒ²ãŒã‚ã‚Œã°ãã¡ã‚‰ã‚’ä½¿ç”¨ï¼ˆå„ªå…ˆï¼‰
                                if (set.rm && set.rmWeight) {
                                    const key = `${set.rm}_${exerciseName}`;
                                    rmData[key] = Math.max(rmData[key] || 0, set.rmWeight);
                                }
                                // RMè¨˜éŒ²ãŒãªã„å ´åˆã¯é€šå¸¸ã®ã‚»ãƒƒãƒˆãƒ‡ãƒ¼ã‚¿ã‹ã‚‰æ¨å®š
                                else if (reps > 0 && weight > 0) {
                                    const key = `${reps}_${exerciseName}`;
                                    rmData[key] = Math.max(rmData[key] || 0, weight);
                                }
                            });
                        }
                    });
                    allData.total_time.push(totalTime);
                    allData.total_exercises.push(totalExercises);
                    allData.total_weight.push(totalWeight);

                    // RMè¨˜éŒ²ã‚’ä¿å­˜ï¼ˆã™ã¹ã¦ã®å›æ•°Ã—ç¨®ç›®ã®çµ„ã¿åˆã‚ã›ï¼‰
                    for (const key in rmData) {
                        if (!allData.rm) allData.rm = {};
                        if (!allData.rm[key]) allData.rm[key] = [];
                        allData.rm[key].push(rmData[key]);
                    }
                    // ã“ã®æ—¥ã«è¨˜éŒ²ãŒãªã„RMç¨®ç›®ã«ã¯0ã‚’è¿½åŠ 
                    if (allData.rm) {
                        for (const key in allData.rm) {
                            if (!rmData[key]) {
                                allData.rm[key].push(0);
                            }
                        }
                    }

                    // ã‚³ãƒ³ãƒ‡ã‚£ã‚·ãƒ§ãƒ³ãƒ‡ãƒ¼ã‚¿ - conditionsã‹ã‚‰å–å¾—
                    const conditions = record.conditions || {};
                    allData.sleep_duration.push(conditions.sleepHours || 0);
                    allData.sleep_quality.push(conditions.sleepQuality || 0);
                    allData.appetite.push(conditions.appetite || 0);
                    allData.gut_health.push(conditions.digestion || 0);
                    allData.focus.push(conditions.focus || 0);
                    allData.stress.push(conditions.stress || 0);

                    // ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ‡ãƒ¼ã‚¿ - ä½“çµ„æˆã‹ã‚‰å–å¾—
                    // ã¾ãšrecord.bodyCompositionã‚’ç¢ºèªã€ãªã‘ã‚Œã°userProfileã‹ã‚‰å–å¾—
                    let weight = 0, bodyFat = 0;
                    if (record.bodyComposition) {
                        weight = record.bodyComposition.weight || 0;
                        bodyFat = record.bodyComposition.bodyFatPercentage || 0;
                    } else if (window.currentUser) {
                        // userProfileã‹ã‚‰å–å¾—ï¼ˆãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼‰
                        const userProfileKey = typeof STORAGE_KEYS !== 'undefined' ? STORAGE_KEYS.USER_PROFILE : 'yourCoachBeta_userProfile';
                        const userProfile = JSON.parse(localStorage.getItem(userProfileKey) || '{}');
                        weight = userProfile.weight || 0;
                        bodyFat = userProfile.bodyFatPercentage || 0;
                    }
                    const lbm = weight > 0 && bodyFat > 0 ? weight * (1 - bodyFat / 100) : 0;
                    allData.lbm.push(lbm);

                    allData.directive.push(record.directiveCompleted ? 1 : 0);
                    allData.overall.push(record.overallScore || 0);

                    // é–ƒããƒ¡ãƒ¢ã‚’ä¿å­˜
                    if (record.notes && record.notes.trim()) {
                        dailyNotes[dateStr] = record.notes.trim();
                    }
                } else {
                    // ãƒ‡ãƒ¼ã‚¿ãŒãªã„å ´åˆã¯0ã‚’è¿½åŠ 
                    Object.keys(allData).forEach(key => {
                        if (key === 'rm') {
                            // rmã¯ç‰¹æ®Šå‡¦ç†ï¼ˆã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆå‹ï¼‰
                            for (const rmKey in allData.rm) {
                                allData.rm[rmKey].push(0);
                            }
                        } else if (Array.isArray(allData[key])) {
                            allData[key].push(0);
                        }
                    });
                }
            }

            // ãƒ‡ãƒ¼ã‚¿å–å¾—å®Œäº†ã®ãƒ­ã‚°
            console.log('[å±¥æ­´ãƒ‡ãƒ¼ã‚¿å–å¾—] å®Œäº† - ã‚«ãƒ­ãƒªãƒ¼ãƒ‡ãƒ¼ã‚¿æ•°:', allData.calories.length);
            console.log('[å±¥æ­´ãƒ‡ãƒ¼ã‚¿å–å¾—] æœ€å¾Œã®7æ—¥åˆ†ã®ã‚«ãƒ­ãƒªãƒ¼:', allData.calories.slice(-7));
            console.log('[å±¥æ­´ãƒ‡ãƒ¼ã‚¿å–å¾—] æœ€å¾Œã®7æ—¥åˆ†ã®é‹å‹•æ™‚é–“:', allData.total_time.slice(-7));

            return allData;
        }

        // ã‚°ãƒ­ãƒ¼ãƒãƒ«ãƒ‡ãƒ¼ã‚¿ï¼ˆå®Ÿãƒ‡ãƒ¼ã‚¿ã§ä¸Šæ›¸ãã•ã‚Œã‚‹ï¼‰
        let allData = {
            // ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹
            lbm: [],
            directive: [],
            overall: [],
            // é£Ÿäº‹
            calories: [],
            protein: [],
            fat: [],
            carbs: [],
            sugar: [],
            fiber: [],
            vitamin_score: [],
            mineral_score: [],
            // é‹å‹•
            total_time: [],
            total_exercises: [],
            total_weight: [],
            rm: {}, // å›æ•°Ã—ç¨®ç›®åˆ¥ã®RMè¨˜éŒ²ï¼ˆå‹•çš„ã«è¿½åŠ ï¼‰
            // ã‚³ãƒ³ãƒ‡ã‚£ã‚·ãƒ§ãƒ³
            sleep_duration: [],
            sleep_quality: [],
            appetite: [],
            gut_health: [],
            focus: [],
            stress: []
        };

        // å…¨æœŸé–“ã®æœ€ä½å€¤ãƒ»æœ€å¤§å€¤ã‚’è¨ˆç®—
        function calculateGlobalMinMax(metric) {
            const data = allData[metric];
            const info = metricInfo[metric];

            // ãƒ‡ãƒ¼ã‚¿ã¾ãŸã¯ãƒ¡ãƒˆãƒªãƒƒã‚¯æƒ…å ±ãŒãªã„å ´åˆã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã‚’è¿”ã™
            if (!data || !info) {
                console.warn(`No data or metric info for: ${metric}`);
                return { min: 0, max: 10 };
            }

            // é…åˆ—ãƒã‚§ãƒƒã‚¯
            if (!Array.isArray(data)) {
                console.warn(`Data for ${metric} is not an array`);
                return { min: 0, max: 10 };
            }

            if (data.length === 0) {
                return { min: 0, max: 10 };
            }

            // æŒ‡ç¤ºæ›¸ï¼ˆãƒã‚¤ãƒŠãƒªãƒ‡ãƒ¼ã‚¿ï¼‰ã¯0-1å›ºå®š
            if (info.isBinary) {
                return { min: 0, max: 1 };
            }

            // æœ‰åŠ¹ãªæ•°å€¤ã®ã¿ã‚’ãƒ•ã‚£ãƒ«ã‚¿
            const validData = data.filter(v => typeof v === 'number' && !isNaN(v) && v > 0);

            if (validData.length === 0) {
                return { min: 0, max: 10 };
            }

            const min = Math.min(...validData);
            const max = Math.max(...validData);
            const range = max - min;

            // ãƒãƒ¼ã‚¸ãƒ³ã‚’å¤§ãã‚ã«è¨­å®šï¼ˆ20%ï¼‰ã—ã¦ã€æ•°å€¤ãŒè¦‹åˆ‡ã‚Œãªã„ã‚ˆã†ã«ã™ã‚‹
            const margin = Math.max(range * 0.2, 0.5); // æœ€ä½ã§ã‚‚0.5ã®ãƒãƒ¼ã‚¸ãƒ³

            return {
                min: Math.floor((min - margin) * 10) / 10,
                max: Math.ceil((max + margin) * 10) / 10
            };
        }

        // æŒ‡å®šæœŸé–“ã®ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
        function generateData(days) {
            const result = {};
            // ã™ã¹ã¦ã®æŒ‡æ¨™ã®ãƒ‡ãƒ¼ã‚¿ã‚’è¿”ã™
            for (const key in allData) {
                if (key === 'rm') {
                    // rmã¯ç‰¹æ®Šå‡¦ç†ï¼ˆã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆå‹ï¼‰
                    result[key] = allData[key];
                } else if (Array.isArray(allData[key])) {
                    result[key] = allData[key].slice(-days);
                }
            }
            return result;
        }

        // æŒ‡å®šæœŸé–“ã®ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
        function getDataForPeriod(category, period) {
            if (!allData[category]) {
                return null;
            }
            return allData[category].slice(-period);
        }

        // ãƒ©ãƒ™ãƒ«ç”Ÿæˆ
        function generateLabels(days) {
            if (days <= 7) {
                // 7æ—¥ä»¥å†…: æ•°å­—ã®ã¿ï¼ˆå˜ä½ã¯è¡¨ç¤ºæ™‚ã«è¿½åŠ ï¼‰0=ä»Šæ—¥
                const labels = Array.from({ length: days }, (_, i) => `${days - 1 - i}`);
                return labels;
            } else if (days <= 30) {
                // 30æ—¥ä»¥å†…: æ•°å­—ã®ã¿ï¼ˆå˜ä½ã¯è¡¨ç¤ºæ™‚ã«è¿½åŠ ï¼‰0=ä»Šæ—¥
                const labels = Array.from({ length: days }, (_, i) => `${days - 1 - i}`);
                return labels;
            } else {
                // 30æ—¥ä»¥ä¸Š: æ•°å­—ã®ã¿ï¼ˆå˜ä½ã¯è¡¨ç¤ºæ™‚ã«è¿½åŠ ï¼‰0=ä»Šæ—¥
                const labels = Array.from({ length: days }, (_, i) => `${days - 1 - i}`);
                return labels;
            }
        }

        // ç§»å‹•å¹³å‡ã‚’è¨ˆç®—
        function calculateMovingAverage(data, period) {
            const result = [];
            for (let i = 0; i < data.length; i++) {
                if (i < period - 1) {
                    result.push(null); // æœ€åˆã®æ•°æ—¥ã¯è¨ˆç®—ã§ããªã„
                } else {
                    const sum = data.slice(i - period + 1, i + 1).reduce((a, b) => a + b, 0);
                    result.push(sum / period);
                }
            }
            return result;
        }

        // ç·šå½¢å›å¸°ã§äºˆæ¸¬ç·šã‚’è¨ˆç®—
        function calculatePrediction(data, futureDays = 7) {
            const validData = data.filter(v => v > 0);
            if (validData.length < 3) return [];

            // ç·šå½¢å›å¸°ã®è¨ˆç®—
            const n = validData.length;
            const indices = Array.from({ length: n }, (_, i) => i);
            const sumX = indices.reduce((a, b) => a + b, 0);
            const sumY = validData.reduce((a, b) => a + b, 0);
            const sumXY = indices.reduce((sum, x, i) => sum + x * validData[i], 0);
            const sumX2 = indices.reduce((sum, x) => sum + x * x, 0);

            const slope = (n * sumXY - sumX * sumY) / (n * sumX2 - sumX * sumX);
            const intercept = (sumY - slope * sumX) / n;

            // äºˆæ¸¬å€¤ã‚’è¨ˆç®—
            const predictions = [];
            for (let i = 0; i < data.length + futureDays; i++) {
                predictions.push(slope * i + intercept);
            }

            return predictions;
        }

        // ç§»å‹•å¹³å‡ç·šã®è¡¨ç¤ºåˆ‡æ›¿
        function toggleMovingAverage(chartNum) {
            showMovingAverage[chartNum] = !showMovingAverage[chartNum];
            updateChart(chartNum);
        }

        // ç§»å‹•å¹³å‡ã®æœŸé–“ã‚’å¤‰æ›´
        function changeMovingAveragePeriod(chartNum, period) {
            movingAveragePeriod[chartNum] = parseInt(period);
            if (showMovingAverage[chartNum]) {
                updateChart(chartNum);
            }
        }

        // äºˆæ¸¬ç·šã®è¡¨ç¤ºåˆ‡æ›¿
        function togglePrediction(chartNum) {
            showPrediction[chartNum] = !showPrediction[chartNum];
            updateChart(chartNum);
        }

        // Chart2ã®ã‚«ãƒ†ã‚´ãƒªã‚’å¤‰æ›´
        function changeChart2Category(category) {
            chart2Category = category;
            currentSubCategory = category;
            updateChart(2);
        }

        // Yè»¸é€£å‹•ã®ON/OFFåˆ‡æ›¿
        function toggleAxisSync() {
            // ãƒ‘ãƒãƒ«ã¾ãŸã¯ãƒ¡ã‚¤ãƒ³ç”»é¢ã®ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã‹ã‚‰çŠ¶æ…‹ã‚’å–å¾—
            const syncAxisPanelElement = document.getElementById('sync-axis-panel');
            const syncAxisElement = document.getElementById('sync-axis');

            // ãƒ‘ãƒãƒ«ã®è¦ç´ ãŒã‚ã‚Œã°ãã¡ã‚‰ã‚’ä½¿ç”¨ã€ãªã‘ã‚Œã°ãƒ¡ã‚¤ãƒ³ã®è¦ç´ ã‚’ä½¿ç”¨
            const checkboxElement = syncAxisPanelElement || syncAxisElement;
            if (!checkboxElement) {
                console.warn('Yè»¸é€£å‹•è¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                return;
            }

            axisSync = checkboxElement.checked;

            // ä¸¡æ–¹ã®ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã‚’åŒæœŸ
            if (syncAxisPanelElement) syncAxisPanelElement.checked = axisSync;
            if (syncAxisElement) syncAxisElement.checked = axisSync;

            const icon = document.querySelector('.sync-icon');

            if (axisSync) {
                // ONã«ãªã£ãŸã‚‰ã€ã‚°ãƒ©ãƒ•1ã®å€¤ã‚’ã‚°ãƒ©ãƒ•2ã«åæ˜ 
                if (icon) {
                    icon.classList.add('syncing');
                    setTimeout(() => icon.classList.remove('syncing'), 1000);
                }

                if (comparisonMode && currentAxisRanges[1].min !== null) {
                    const axisMin2Element = document.getElementById('axis-min-2');
                    const axisMax2Element = document.getElementById('axis-max-2');

                    currentAxisRanges[2] = { ...currentAxisRanges[1] };
                    if (axisMin2Element) axisMin2Element.value = currentAxisRanges[1].min;
                    if (axisMax2Element) axisMax2Element.value = currentAxisRanges[1].max;
                    updateChart(2);
                }
            }

            lucide.createIcons();
        }

        // Geminiåˆ†æï¼ˆè¦ªã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã¸ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡ï¼‰
        // ãƒ­ãƒ¼ã‚«ãƒ«å‚¾å‘èª¿æŸ»ï¼ˆç¾åœ¨è¡¨ç¤ºä¸­ã®æœŸé–“ã‚’ä½¿ç”¨ï¼‰
        function showLocalTrendAnalysis() {
            const metric = metricInfo[currentSubCategory];
            const period = currentPeriods[1]; // ç¾åœ¨è¡¨ç¤ºä¸­ã®æœŸé–“
            const data = currentData[1]; // ç¾åœ¨è¡¨ç¤ºä¸­ã®ãƒ‡ãƒ¼ã‚¿

            if (!data || data.length === 0) {
                alert(`ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“`);
                return;
            }

            // ãƒ‡ãƒ¼ã‚¿ã®çµ±è¨ˆæƒ…å ±ã‚’è¨ˆç®—
            const avg = (data.reduce((a, b) => a + b, 0) / data.length).toFixed(1);
            const max = Math.max(...data).toFixed(1);
            const min = Math.min(...data).toFixed(1);
            const trend = (data[data.length - 1] - data[0]).toFixed(1);
            const trendPercent = ((trend / data[0]) * 100).toFixed(1);
            const stdDev = calculateStdDev(data).toFixed(1);

            // ãƒˆãƒ¬ãƒ³ãƒ‰åˆ¤å®š
            let trendLabel = 'æ¨ªã°ã„';
            let trendIcon = 'â†’';
            let trendColor = 'text-gray-600';
            if (Math.abs(parseFloat(trendPercent)) < 5) {
                trendLabel = 'æ¨ªã°ã„';
                trendIcon = 'â†’';
                trendColor = 'text-gray-600';
            } else if (parseFloat(trend) > 0) {
                trendLabel = 'å¢—åŠ å‚¾å‘';
                trendIcon = 'â†‘';
                trendColor = 'text-green-600';
            } else {
                trendLabel = 'æ¸›å°‘å‚¾å‘';
                trendIcon = 'â†“';
                trendColor = 'text-red-600';
            }

            // ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º
            const periodLabel = period === 365 ? '1å¹´é–“' : `${period}æ—¥é–“`;
            const modalHTML = `
                <div class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4" onclick="this.remove()">
                    <div class="bg-white rounded-2xl w-full max-w-md p-6" onclick="event.stopPropagation()">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-xl font-bold flex items-center gap-2">
                                <i data-lucide="bar-chart-2" class="w-5 h-5 text-blue-600"></i>
                                å‚¾å‘èª¿æŸ»ï¼š${metric.name}
                            </h3>
                            <button onclick="this.closest('.fixed').remove()" class="p-2 hover:bg-gray-100 rounded-full">
                                <i data-lucide="x" class="w-5 h-5"></i>
                            </button>
                        </div>
                        <div class="space-y-4">
                            <div class="p-3 bg-blue-50 rounded-lg border border-blue-200">
                                <div class="text-sm font-semibold text-blue-900 mb-1">æœŸé–“</div>
                                <div class="text-lg font-bold text-blue-700">éå»${periodLabel}</div>
                            </div>
                            <div class="grid grid-cols-2 gap-3">
                                <div class="p-3 bg-gray-50 rounded-lg">
                                    <div class="text-xs text-gray-600 mb-1">å¹³å‡å€¤</div>
                                    <div class="text-lg font-bold">${avg}${metric.unit}</div>
                                </div>
                                <div class="p-3 bg-gray-50 rounded-lg">
                                    <div class="text-xs text-gray-600 mb-1">æ¨™æº–åå·®</div>
                                    <div class="text-lg font-bold">${stdDev}${metric.unit}</div>
                                </div>
                                <div class="p-3 bg-green-50 rounded-lg border border-green-200">
                                    <div class="text-xs text-green-700 mb-1">æœ€é«˜å€¤</div>
                                    <div class="text-lg font-bold text-green-800">${max}${metric.unit}</div>
                                </div>
                                <div class="p-3 bg-red-50 rounded-lg border border-red-200">
                                    <div class="text-xs text-red-700 mb-1">æœ€ä½å€¤</div>
                                    <div class="text-lg font-bold text-red-800">${min}${metric.unit}</div>
                                </div>
                            </div>
                            <div class="p-4 bg-gradient-to-r from-purple-50 to-blue-50 rounded-lg border border-purple-200">
                                <div class="text-sm font-semibold text-purple-900 mb-2">ãƒˆãƒ¬ãƒ³ãƒ‰</div>
                                <div class="flex items-center gap-3">
                                    <span class="text-3xl ${trendColor}">${trendIcon}</span>
                                    <div>
                                        <div class="text-lg font-bold ${trendColor}">${trendLabel}</div>
                                        <div class="text-sm text-gray-600">
                                            ${trend > 0 ? '+' : ''}${trend}${metric.unit} (${trendPercent}%)
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', modalHTML);
            lucide.createIcons();
        }

        // æ¨™æº–åå·®è¨ˆç®—
        function calculateStdDev(values) {
            const avg = values.reduce((a, b) => a + b, 0) / values.length;
            const squareDiffs = values.map(value => Math.pow(value - avg, 2));
            const avgSquareDiff = squareDiffs.reduce((a, b) => a + b, 0) / squareDiffs.length;
            return Math.sqrt(avgSquareDiff);
        }

        async function analyzeWithGemini() {
            console.log('[AIåˆ†æ] ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯');
            console.log('currentSubCategory:', currentSubCategory);
            console.log('currentMainCategory:', currentMainCategory);

            // ç¾åœ¨ã®ã‚«ãƒ†ã‚´ãƒªã¨ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
            const metric = metricInfo[currentSubCategory];
            const data1 = currentData[1];
            const period1 = currentPeriods[1];

            console.log('data1:', data1);
            console.log('data1 length:', data1 ? data1.length : 'undefined');

            // ãƒ‡ãƒ¼ã‚¿ã®å­˜åœ¨ç¢ºèª
            if (!data1 || data1.length === 0) {
                console.error('[AIåˆ†æ] ãƒ‡ãƒ¼ã‚¿ãŒç©ºã§ã™');
                alert('åˆ†æã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚è¨˜éŒ²ã‚’è¿½åŠ ã—ã¦ã‹ã‚‰å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚');
                return;
            }

            // ãƒ‡ãƒ¼ã‚¿ã®çµ±è¨ˆæƒ…å ±ã‚’è¨ˆç®—
            const avg = (data1.reduce((a, b) => a + b, 0) / data1.length).toFixed(1);
            const max = Math.max(...data1).toFixed(1);
            const min = Math.min(...data1).toFixed(1);
            const trend = (data1[data1.length - 1] - data1[0]).toFixed(1);
            const trendPercent = data1[0] !== 0 ? ((trend / data1[0]) * 100).toFixed(1) : '0.0';

            console.log('[AIåˆ†æ] çµ±è¨ˆæƒ…å ±:', { avg, max, min, trend, trendPercent });

            // è¦ªã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ï¼ˆReactï¼‰ã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡
            console.log('[AIåˆ†æ] postMessageé€ä¿¡');
            window.parent.postMessage({
                type: 'REQUEST_AI_ANALYSIS',
                category: currentMainCategory,
                subCategory: currentSubCategory,
                metricInfo: metric,
                data: data1,
                period: period1,
                stats: {
                    avg: avg,
                    max: max,
                    min: min,
                    trend: trend,
                    trendPercent: trendPercent
                }
            }, '*');
        }

        // ãƒ˜ãƒ«ãƒ—ãƒ¢ãƒ¼ãƒ€ãƒ«
        function openHelpModal() {
            document.getElementById('help-modal').classList.add('show');
            lucide.createIcons();
        }

        function closeHelpModal() {
            document.getElementById('help-modal').classList.remove('show');
        }

        // ãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ—
        const tooltipContent = {
            comparison: `
                <div class="text-sm">
                    <div class="font-bold text-blue-600 mb-2">æ¯”è¼ƒãƒ¢ãƒ¼ãƒ‰ã¨ã¯ï¼Ÿ</div>
                    <p class="mb-2">2ã¤ã®ã‚°ãƒ©ãƒ•ã‚’åŒæ™‚ã«è¡¨ç¤ºã—ã€ç•°ãªã‚‹æœŸé–“ã®ãƒ‡ãƒ¼ã‚¿ã‚’æ¯”è¼ƒã§ãã¾ã™ã€‚</p>
                    <div class="font-semibold mb-1">ä½¿ã„æ–¹:</div>
                    <ul class="text-xs space-y-1 pl-4">
                        <li>â€¢ ãƒã‚§ãƒƒã‚¯ã‚’ONã«ã™ã‚‹ã¨ä¸‹ã«ã‚°ãƒ©ãƒ•ãŒè¿½åŠ è¡¨ç¤º</li>
                        <li>â€¢ ä¸Šä¸‹ã§ç•°ãªã‚‹æœŸé–“ã‚’é¸æŠå¯èƒ½ï¼ˆä¾‹: 7æ—¥ vs 30æ—¥ï¼‰</li>
                        <li>â€¢ çŸ­æœŸã¨é•·æœŸã®ãƒˆãƒ¬ãƒ³ãƒ‰æ¯”è¼ƒã«æœ€é©</li>
                    </ul>
                </div>
            `,
            sync: `
                <div class="text-sm">
                    <div class="font-bold text-purple-600 mb-2">Yè»¸é€£å‹•ã¨ã¯ï¼Ÿ</div>
                    <p class="mb-2">ä¸Šã®ã‚°ãƒ©ãƒ•ã®Yè»¸ç¯„å›²ã‚’å¤‰æ›´ã™ã‚‹ã¨ã€ä¸‹ã®ã‚°ãƒ©ãƒ•ã‚‚è‡ªå‹•ã§åŒã˜ç¯„å›²ã«èª¿æ•´ã•ã‚Œã‚‹æ©Ÿèƒ½ã§ã™ã€‚</p>
                    <div class="font-semibold mb-1">ãƒ¡ãƒªãƒƒãƒˆ:</div>
                    <ul class="text-xs space-y-1 pl-4">
                        <li>â€¢ åŒã˜ã‚¹ã‚±ãƒ¼ãƒ«ã§æ¯”è¼ƒã§ãã‚‹</li>
                        <li>â€¢ æ•°å€¤ã®å¤§å°ã‚’ç›´æ„Ÿçš„ã«æ¯”è¼ƒ</li>
                        <li>â€¢ ãƒ¯ãƒ³ã‚¯ãƒªãƒƒã‚¯ã§ON/OFFåˆ‡æ›¿å¯èƒ½</li>
                    </ul>
                </div>
            `
        };

        let tooltipTimeout;
        function showTooltip(event, type) {
            clearTimeout(tooltipTimeout);
            const tooltip = document.getElementById('tooltip');
            tooltip.innerHTML = tooltipContent[type];
            tooltip.classList.add('show');

            // ä½ç½®èª¿æ•´
            const rect = event.target.getBoundingClientRect();
            tooltip.style.position = 'fixed';
            tooltip.style.left = rect.left + 'px';
            tooltip.style.top = (rect.bottom + 10) + 'px';
        }

        function hideTooltip() {
            tooltipTimeout = setTimeout(() => {
                document.getElementById('tooltip').classList.remove('show');
            }, 200);
        }

        // æ¯”è¼ƒãƒ¢ãƒ¼ãƒ‰åˆ‡ã‚Šæ›¿ãˆ
        function toggleComparisonMode() {
            // ãƒ‘ãƒãƒ«ã¾ãŸã¯ãƒ¡ã‚¤ãƒ³ç”»é¢ã®ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã‹ã‚‰çŠ¶æ…‹ã‚’å–å¾—
            const comparisonModePanelElement = document.getElementById('comparison-mode-panel');
            const comparisonModeElement = document.getElementById('comparison-mode');
            const chart2Element = document.getElementById('chart-2');

            if (!chart2Element) {
                console.warn('Chart 2è¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                return;
            }

            // ãƒ‘ãƒãƒ«ã®è¦ç´ ãŒã‚ã‚Œã°ãã¡ã‚‰ã‚’ä½¿ç”¨ã€ãªã‘ã‚Œã°ãƒ¡ã‚¤ãƒ³ã®è¦ç´ ã‚’ä½¿ç”¨
            const checkboxElement = comparisonModePanelElement || comparisonModeElement;
            if (!checkboxElement) {
                console.warn('æ¯”è¼ƒãƒ¢ãƒ¼ãƒ‰è¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                return;
            }

            comparisonMode = checkboxElement.checked;

            // ä¸¡æ–¹ã®ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã‚’åŒæœŸ
            if (comparisonModePanelElement) comparisonModePanelElement.checked = comparisonMode;
            if (comparisonModeElement) comparisonModeElement.checked = comparisonMode;

            chart2Element.classList.toggle('hidden', !comparisonMode);

            if (comparisonMode) {
                // æ¯”è¼ƒãƒ¢ãƒ¼ãƒ‰ONæ™‚ã€Yè»¸é€£å‹•ãŒONãªã‚‰åŒã˜ç¯„å›²ã‚’é©ç”¨
                if (axisSync && currentAxisRanges[1].min !== null) {
                    const axisMin2Element = document.getElementById('axis-min-2');
                    const axisMax2Element = document.getElementById('axis-max-2');

                    currentAxisRanges[2] = { ...currentAxisRanges[1] };
                    if (axisMin2Element) axisMin2Element.value = currentAxisRanges[1].min;
                    if (axisMax2Element) axisMax2Element.value = currentAxisRanges[1].max;
                }
                updateChart(2);
                updateChart2PeriodButtons();
            }
        }

        // å¤§ã‚«ãƒ†ã‚´ãƒªé¸æŠï¼ˆãƒ‡ãƒ¢ç”¨ - å®Ÿéš›ã«ã¯å„ã‚«ãƒ†ã‚´ãƒªã®ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’è¡¨ç¤ºï¼‰
        function selectMainCategory(category, event) {
            currentMainCategory = category;

            // ã‚«ãƒ†ã‚´ãƒªã”ã¨ã®è‰²è¨­å®šï¼ˆã‚¢ãƒ—ãƒªã¨å®Œå…¨ä¸€è‡´ï¼‰
            const categoryColors = {
                nutrition: 'text-green-600',      // é£Ÿäº‹: ç·‘
                training: 'text-orange-600',      // é‹å‹•: ã‚ªãƒ¬ãƒ³ã‚¸
                condition: 'text-red-600',        // ã‚³ãƒ³ãƒ‡ã‚£ã‚·ãƒ§ãƒ³: èµ¤
                performance: 'text-purple-600',   // ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹: ç´«
                insights: 'text-yellow-600'       // é–ƒã: é»„è‰²
            };

            // ã‚¿ãƒ–ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ–çŠ¶æ…‹ã‚’æ›´æ–°ï¼ˆè‰²ã¯ç¶­æŒï¼‰
            document.querySelectorAll('.tab-button').forEach(btn => {
                // èƒŒæ™¯ã¨ãƒœãƒ¼ãƒ€ãƒ¼ã®ã¿ã‚’å‰Šé™¤ã€è‰²ã¯ç¶­æŒ
                btn.classList.remove('active', 'bg-white', 'border-b-0');
                // å„ãƒœã‚¿ãƒ³ã®ã‚«ãƒ†ã‚´ãƒªã«å¿œã˜ãŸè‰²ã‚’å†è¨­å®š
                const btnCategory = btn.getAttribute('data-category');
                if (btnCategory && categoryColors[btnCategory]) {
                    btn.classList.remove('text-green-600', 'text-orange-600', 'text-red-600', 'text-purple-600', 'text-yellow-600');
                    btn.classList.add(categoryColors[btnCategory]);
                }
            });

            const colorClass = categoryColors[category] || 'text-purple-600';
            // ã‚¤ãƒ™ãƒ³ãƒˆãŒæ¸¡ã•ã‚Œã¦ã„ã‚‹å ´åˆã¯event.currentTargetã‚’ä½¿ç”¨ã€ãã‚Œä»¥å¤–ã¯è©²å½“ã™ã‚‹ãƒœã‚¿ãƒ³ã‚’æ¤œç´¢
            const targetButton = event ? event.currentTarget : document.querySelector(`.tab-button[data-category="${category}"]`);
            if (targetButton) {
                targetButton.classList.add('active', colorClass, 'bg-white', 'border-b-0');
            }

            // ã™ã¹ã¦ã®ã‚µãƒ–ã‚¿ãƒ–ã‚’éè¡¨ç¤º
            document.querySelectorAll('.sub-tabs').forEach(tab => {
                tab.classList.add('hidden');
            });

            // é–ƒãã‚«ãƒ†ã‚´ãƒªã®å ´åˆã¯ç‰¹åˆ¥å‡¦ç†
            if (category === 'insights') {
                // ã‚°ãƒ©ãƒ•ã‚¨ãƒªã‚¢ã‚’éè¡¨ç¤º
                document.getElementById('graph-area').classList.add('hidden');
                // é–ƒãã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’è¡¨ç¤º
                document.getElementById('insights-content').classList.remove('hidden');
                // é–ƒããƒ¡ãƒ¢ãƒªã‚¹ãƒˆã‚’ç”Ÿæˆ
                renderInsightsList();
            } else {
                // ã‚°ãƒ©ãƒ•ã‚¨ãƒªã‚¢ã‚’è¡¨ç¤º
                document.getElementById('graph-area').classList.remove('hidden');
                // é–ƒãã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’éè¡¨ç¤º
                document.getElementById('insights-content').classList.add('hidden');

                // é¸æŠã•ã‚ŒãŸã‚«ãƒ†ã‚´ãƒªã®ã‚µãƒ–ã‚¿ãƒ–ã‚’è¡¨ç¤º
                const subtabs = document.getElementById(`${category}-subtabs`);
                if (subtabs) {
                    subtabs.classList.remove('hidden');
                }

                // å„ã‚«ãƒ†ã‚´ãƒªã®æœ€åˆã®æŒ‡æ¨™ã‚’é¸æŠ
                const firstMetrics = {
                    nutrition: 'calories',
                    training: 'total_time',
                    condition: 'sleep_duration',
                    performance: 'lbm'
                };

                // æœ€åˆã®ã‚µãƒ–ã‚«ãƒ†ã‚´ãƒªã‚’é¸æŠ
                if (firstMetrics[category]) {
                    selectSubCategory(category, firstMetrics[category]);
                }
            }

            // ã‚¢ã‚¤ã‚³ãƒ³ã‚’å†æç”»
            lucide.createIcons();
        }

        // é–ƒããƒ¡ãƒ¢ãƒªã‚¹ãƒˆã‚’æç”»ã™ã‚‹é–¢æ•°
        function renderInsightsList() {
            const listContainer = document.getElementById('insights-list');
            listContainer.innerHTML = '';

            // dailyNotesã‚’æ—¥ä»˜é †ã«ã‚½ãƒ¼ãƒˆï¼ˆæ–°ã—ã„é †ï¼‰
            const sortedNotes = Object.entries(dailyNotes).sort((a, b) => {
                return new Date(b[0]) - new Date(a[0]);
            });

            if (sortedNotes.length === 0) {
                listContainer.innerHTML = `
                    <div class="text-center py-12">
                        <i data-lucide="lightbulb-off" class="w-16 h-16 text-gray-300 mx-auto mb-4"></i>
                        <p class="text-gray-500">é–ƒããƒ¡ãƒ¢ã¯ã¾ã ã‚ã‚Šã¾ã›ã‚“</p>
                    </div>
                `;
                lucide.createIcons();
                return;
            }

            sortedNotes.forEach(([dateStr, note]) => {
                const date = new Date(dateStr);
                const dateDisplay = `${date.getFullYear()}/${date.getMonth() + 1}/${date.getDate()}`;
                const dayOfWeek = ['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'][date.getDay()];

                const noteCard = document.createElement('div');
                noteCard.className = 'bg-yellow-50 border-l-4 border-yellow-500 rounded-lg p-4 hover:shadow-md transition';
                noteCard.innerHTML = `
                    <div class="flex items-start gap-3">
                        <i data-lucide="lightbulb" class="w-5 h-5 text-yellow-600 flex-shrink-0 mt-1"></i>
                        <div class="flex-1">
                            <div class="flex items-center justify-between mb-2">
                                <span class="text-sm font-bold text-gray-800">${dateDisplay} (${dayOfWeek})</span>
                            </div>
                            <p class="text-sm text-gray-700 whitespace-pre-wrap">${note}</p>
                        </div>
                    </div>
                `;
                listContainer.appendChild(noteCard);
            });

            lucide.createIcons();
        }

        // æœŸé–“é¸æŠ
        function selectPeriod(chartNum, days) {
            currentPeriods[chartNum] = days;

            const container = chartNum === 1 ? document.getElementById('chart-1') : document.getElementById('chart-2');

            if (chartNum === 1) {
                // ã‚°ãƒ©ãƒ•1: ã‚¿ãƒ–å¼ã‚¹ã‚¿ã‚¤ãƒ«ï¼ˆé€æ˜èƒŒæ™¯ï¼‹ã‚¢ãƒ³ãƒ€ãƒ¼ãƒ©ã‚¤ãƒ³ï¼‰
                container.querySelectorAll('.period-button').forEach(btn => {
                    btn.classList.remove('active');
                });
                if (event && event.currentTarget) {
                    event.currentTarget.classList.add('active');
                }
            } else {
                // ã‚°ãƒ©ãƒ•2: ãƒœã‚¿ãƒ³å¼ã‚¹ã‚¿ã‚¤ãƒ«ï¼ˆèƒŒæ™¯è‰²ä»˜ãï¼‰
                container.querySelectorAll('.period-button').forEach(btn => {
                    btn.classList.remove('active', 'bg-purple-600', 'bg-blue-600', 'text-white', 'shadow-sm');
                    btn.classList.add('bg-white', 'text-gray-700', 'border', 'border-gray-300');
                });
                if (event && event.currentTarget) {
                    event.currentTarget.classList.add('active', 'bg-blue-600', 'text-white', 'shadow-sm');
                    event.currentTarget.classList.remove('bg-white', 'text-gray-700', 'border', 'border-gray-300');
                }
            }

            updateChart(chartNum);

            // ã‚°ãƒ©ãƒ•1ã®æœŸé–“ãŒå¤‰æ›´ã•ã‚ŒãŸå ´åˆã€ã‚°ãƒ©ãƒ•2ã®æœŸé–“ãƒœã‚¿ãƒ³ã‚’æ›´æ–°
            if (chartNum === 1 && comparisonMode) {
                updateChart2PeriodButtons();
            }
        }

        // æœŸé–“ç¯„å›²é¸æŠï¼ˆä»Šé€±ã€å…ˆé€±ã€ä»Šæœˆã€å…ˆæœˆï¼‰
        function selectPeriodRange(chartNum, rangeType) {
            const today = new Date();
            let startDate, endDate, days;

            switch(rangeType) {
                case 'thisWeek':
                    // ä»Šé€±ï¼ˆæœˆæ›œæ—¥ï½æ—¥æ›œæ—¥ï¼‰
                    const dayOfWeek = today.getDay();
                    const diffToMonday = dayOfWeek === 0 ? 6 : dayOfWeek - 1; // æœˆæ›œã‚’é€±ã®é–‹å§‹ã¨ã™ã‚‹
                    startDate = new Date(today);
                    startDate.setDate(today.getDate() - diffToMonday);
                    endDate = today;
                    days = Math.ceil((endDate - startDate) / (1000 * 60 * 60 * 24)) + 1;
                    break;

                case 'lastWeek':
                    // å…ˆé€±ï¼ˆå…ˆé€±ã®æœˆæ›œæ—¥ï½æ—¥æ›œæ—¥ï¼‰
                    const lastWeekEnd = new Date(today);
                    const daysToLastSunday = today.getDay() === 0 ? 0 : today.getDay();
                    lastWeekEnd.setDate(today.getDate() - daysToLastSunday);
                    startDate = new Date(lastWeekEnd);
                    startDate.setDate(lastWeekEnd.getDate() - 6);
                    days = 7;
                    break;

                case 'thisMonth':
                    // ä»Šæœˆï¼ˆ1æ—¥ï½ä»Šæ—¥ï¼‰
                    startDate = new Date(today.getFullYear(), today.getMonth(), 1);
                    endDate = today;
                    days = today.getDate();
                    break;

                case 'lastMonth':
                    // å…ˆæœˆï¼ˆå…ˆæœˆã®1æ—¥ï½æœ«æ—¥ï¼‰
                    const lastMonthDate = new Date(today.getFullYear(), today.getMonth() - 1, 1);
                    const lastMonthEnd = new Date(today.getFullYear(), today.getMonth(), 0);
                    days = lastMonthEnd.getDate();
                    break;
            }

            currentPeriods[chartNum] = days;

            // ã‚¿ãƒ–ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ–çŠ¶æ…‹ã‚’æ›´æ–°ï¼ˆãƒ¢ãƒã‚¤ãƒ«å¯¾å¿œã‚¹ã‚¿ã‚¤ãƒ«ï¼‰
            const container = chartNum === 1 ? document.getElementById('chart-1') : document.getElementById('chart-2');
            const bgColor = chartNum === 1 ? 'bg-purple-600' : 'bg-blue-600';

            container.querySelectorAll('.period-button').forEach(btn => {
                btn.classList.remove('active', 'bg-purple-600', 'bg-blue-600', 'text-white', 'shadow-sm');
                btn.classList.add('bg-white', 'text-gray-700', 'border', 'border-gray-300');
            });
            if (event && event.currentTarget) {
                event.currentTarget.classList.add('active', bgColor, 'text-white', 'shadow-sm');
                event.currentTarget.classList.remove('bg-white', 'text-gray-700', 'border', 'border-gray-300');
            }

            updateChart(chartNum);

            // ã‚°ãƒ©ãƒ•1ã®æœŸé–“ãŒå¤‰æ›´ã•ã‚ŒãŸå ´åˆã€ã‚°ãƒ©ãƒ•2ã®æœŸé–“ãƒœã‚¿ãƒ³ã‚’æ›´æ–°
            if (chartNum === 1 && comparisonMode) {
                updateChart2PeriodButtons();
            }
        }

        // ã‚°ãƒ©ãƒ•2ã®æœŸé–“ãƒœã‚¿ãƒ³ã‚’æ›´æ–°ï¼ˆã‚°ãƒ©ãƒ•1ã¨åŒã˜æœŸé–“ã‚’ç„¡åŠ¹åŒ–ï¼‰
        function updateChart2PeriodButtons() {
            const chart2Container = document.getElementById('chart-2');
            const buttons = chart2Container.querySelectorAll('.period-button');

            buttons.forEach(btn => {
                const btnText = btn.textContent;
                const days = parseInt(btnText);

                if (days === currentPeriods[1]) {
                    btn.disabled = true;
                    btn.classList.add('opacity-50', 'cursor-not-allowed');
                    btn.onclick = null;
                } else {
                    btn.disabled = false;
                    btn.classList.remove('opacity-50', 'cursor-not-allowed');
                    // onclick ã‚’å¾©å…ƒ
                    const dayValue = btnText === '7æ—¥é–“' ? 7 : btnText === '14æ—¥é–“' ? 14 : btnText === '30æ—¥é–“' ? 30 : 90;
                    btn.onclick = () => selectPeriod(2, dayValue);
                }
            });
        }

        // Yè»¸ãƒ¬ãƒ³ã‚¸ã‚’ãƒªã‚»ãƒƒãƒˆ
        function resetAxisRange(chartNum) {
            const axisMinElement = document.getElementById(`axis-min-${chartNum}`);
            const axisMaxElement = document.getElementById(`axis-max-${chartNum}`);

            if (axisMinElement && axisMaxElement) {
                axisMinElement.value = globalMinMax.min;
                axisMaxElement.value = globalMinMax.max;
                updateAxisRange(chartNum);
            }
        }

        // Yè»¸ãƒ¬ãƒ³ã‚¸ã‚’æ›´æ–°
        function updateAxisRange(chartNum) {
            const axisMinElement = document.getElementById(`axis-min-${chartNum}`);
            const axisMaxElement = document.getElementById(`axis-max-${chartNum}`);

            if (!axisMinElement || !axisMaxElement) {
                console.warn(`Yè»¸ãƒ¬ãƒ³ã‚¸è¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: chart ${chartNum}`);
                return;
            }

            const min = parseFloat(axisMinElement.value);
            const max = parseFloat(axisMaxElement.value);

            if (!isNaN(min) && !isNaN(max) && min < max) {
                currentAxisRanges[chartNum] = { min, max };

                // ã‚°ãƒ©ãƒ•ã‚’æ›´æ–°
                if (charts[chartNum]) {
                    charts[chartNum].options.scales.y.min = min;
                    charts[chartNum].options.scales.y.max = max;
                    charts[chartNum].update();
                }

                // Yè»¸é€£å‹•ãŒONã§ã€ã‚°ãƒ©ãƒ•1ã®å¤‰æ›´ãªã‚‰ã€ã‚°ãƒ©ãƒ•2ã‚‚åŒæœŸ
                if (axisSync && chartNum === 1 && comparisonMode) {
                    const axisMin2Element = document.getElementById('axis-min-2');
                    const axisMax2Element = document.getElementById('axis-max-2');

                    currentAxisRanges[2] = { min, max };
                    if (axisMin2Element) axisMin2Element.value = min;
                    if (axisMax2Element) axisMax2Element.value = max;

                    if (charts[2]) {
                        charts[2].options.scales.y.min = min;
                        charts[2].options.scales.y.max = max;
                        charts[2].update();
                    }

                    // åŒæœŸã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
                    const icon = document.querySelector('.sync-icon');
                    if (icon) {
                        icon.classList.add('syncing');
                        setTimeout(() => icon.classList.remove('syncing'), 1000);
                    }
                    lucide.createIcons();
                }
            }
        }

        // ã‚°ãƒ©ãƒ•æ›´æ–°
        function updateChart(chartNum) {
            const days = currentPeriods[chartNum];

            // Chart2ã§æ¯”è¼ƒãƒ¢ãƒ¼ãƒ‰ã®å ´åˆã¯ã€chart2Categoryã‚’ä½¿ç”¨
            const categoryToUse = (chartNum === 2 && comparisonMode) ? chart2Category : currentSubCategory;

            const data = generateData(days)[categoryToUse];
            const labels = generateLabels(days);
            const metric = metricInfo[categoryToUse];

            // ãƒ¡ãƒˆãƒªãƒƒã‚¯æƒ…å ±ãŒãªã„å ´åˆã¯å‡¦ç†ã‚’ä¸­æ–­
            if (!metric) {
                console.error(`Metric info not found for: ${categoryToUse}`);
                return;
            }

            // ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜
            currentData[chartNum] = data;

            // ã‚¿ã‚¤ãƒˆãƒ«æ›´æ–°
            document.getElementById(`chart-title-${chartNum}`).textContent = `${metric.name}${chartNum === 2 ? ' - æ¯”è¼ƒ' : ''}`;
            document.getElementById(`chart-period-${chartNum}`).textContent = `éå»${days}æ—¥é–“ã®æ¨ç§»`;

            // ã‚«ãƒ†ã‚´ãƒªåˆ¥ã®æœ€ä½å€¤ãƒ»æœ€é«˜å€¤ã‚’è¨ˆç®—ã—ã¦è¡¨ç¤ºï¼ˆå…¨æœŸé–“90æ—¥ï¼‰
            const categoryMinElement = document.getElementById(`category-min-${chartNum}`);
            const categoryMaxElement = document.getElementById(`category-max-${chartNum}`);
            const categoryUnitElement = document.getElementById(`category-unit-${chartNum}`);

            if (categoryMinElement && categoryMaxElement && categoryUnitElement) {
                const fullData = generateData(90)[categoryToUse];
                const validFullData = fullData.filter(v => typeof v === 'number' && !isNaN(v) && v > 0);

                if (validFullData.length > 0) {
                    const categoryMin = Math.min(...validFullData);
                    const categoryMax = Math.max(...validFullData);

                    // Format numbers with comma separators (e.g., "2,264.10")
                    const formatNumber = (num) => {
                        return num.toFixed(1).replace(/\B(?=(\d{3})+(?!\d))/g, ',');
                    };

                    categoryMinElement.textContent = formatNumber(categoryMin);
                    categoryMaxElement.textContent = formatNumber(categoryMax) + metric.unit;
                    categoryUnitElement.textContent = ''; // Hide separate unit, it's now in max value
                } else {
                    categoryMinElement.textContent = '-';
                    categoryMaxElement.textContent = '-';
                    categoryUnitElement.textContent = '';
                }
            }

            // å€¤ã®è¡¨ç¤ºï¼ˆãƒã‚¤ãƒŠãƒªã®å ´åˆã¯å®Œäº†/æœªå®Œäº†ï¼‰
            const currentValue = data[data.length - 1];
            if (metric.isBinary) {
                const valueText = (typeof currentValue === 'number' && currentValue === 1) ? 'âœ“ å®Œäº†' : 'âœ— æœªå®Œäº†';
                document.getElementById(`chart-value-${chartNum}`).textContent = valueText;
                document.getElementById(`chart-unit-${chartNum}`).textContent = '';
            } else if (metric.getLabel && typeof currentValue === 'number') {
                // æ®µéšèª¬æ˜ãŒã‚ã‚‹å ´åˆ
                const valueText = metric.getLabel(currentValue);
                document.getElementById(`chart-value-${chartNum}`).textContent = valueText;
                document.getElementById(`chart-unit-${chartNum}`).textContent = '';
            } else {
                const valueText = (typeof currentValue === 'number' && !isNaN(currentValue))
                    ? `${currentValue.toFixed(1)}${metric.unit}`
                    : '-';
                document.getElementById(`chart-value-${chartNum}`).textContent = valueText;
                document.getElementById(`chart-unit-${chartNum}`).textContent = '';
            }

            // çµ±è¨ˆè¨ˆç®—
            if (metric.isBinary) {
                // ãƒã‚¤ãƒŠãƒªãƒ‡ãƒ¼ã‚¿ï¼ˆæŒ‡ç¤ºæ›¸ï¼‰ã®å ´åˆã¯å®Œäº†ç‡ã‚’è¡¨ç¤º
                const completionRate = ((data.reduce((a, b) => a + b, 0) / data.length) * 100).toFixed(0);
                document.getElementById(`stat-avg-${chartNum}`).textContent = `${completionRate}%`;
                document.getElementById(`stat-avg-unit-${chartNum}`).textContent = '';
                document.getElementById(`stat-max-${chartNum}`).textContent = `${data.filter(v => v === 1).length}æ—¥`;
                document.getElementById(`stat-max-unit-${chartNum}`).textContent = '';
                document.getElementById(`stat-min-${chartNum}`).textContent = `${data.filter(v => v === 0).length}æ—¥`;
                document.getElementById(`stat-min-unit-${chartNum}`).textContent = '';
            } else {
                const avg = (data.reduce((a, b) => a + b, 0) / data.length).toFixed(1);
                const max = Math.max(...data).toFixed(1);
                const min = Math.min(...data).toFixed(1);

                const avgText = `${avg}${metric.unit}`;
                const maxText = `${max}${metric.unit}`;
                const minText = `${min}${metric.unit}`;

                console.log(`Chart ${chartNum} stats:`, { avgText, maxText, minText, metric: metric.name });

                document.getElementById(`stat-avg-${chartNum}`).textContent = avgText;
                document.getElementById(`stat-max-${chartNum}`).textContent = maxText;
                document.getElementById(`stat-min-${chartNum}`).textContent = minText;
                document.getElementById(`stat-avg-unit-${chartNum}`).textContent = '';
                document.getElementById(`stat-max-unit-${chartNum}`).textContent = '';
                document.getElementById(`stat-min-unit-${chartNum}`).textContent = '';

                // æ¨™æº–åå·®ã‚’è¨ˆç®—
                const stdDev = calculateStdDev(data).toFixed(1);
                const stddevElement = document.getElementById(`stat-stddev-${chartNum}`);
                if (stddevElement) {
                    stddevElement.textContent = `${stdDev}${metric.unit}`;
                }

                // ãƒˆãƒ¬ãƒ³ãƒ‰ã‚’è¨ˆç®—
                const trend = (data[data.length - 1] - data[0]).toFixed(1);
                const trendPercent = ((trend / data[0]) * 100).toFixed(1);

                let trendLabel = 'æ¨ªã°ã„';
                let trendIcon = 'â†’';
                let trendColor = 'text-gray-600';
                if (Math.abs(parseFloat(trendPercent)) < 5) {
                    trendLabel = 'æ¨ªã°ã„';
                    trendIcon = 'â†’';
                    trendColor = 'text-gray-600';
                } else if (parseFloat(trend) > 0) {
                    trendLabel = 'å¢—åŠ å‚¾å‘';
                    trendIcon = 'â†‘';
                    trendColor = 'text-green-600';
                } else {
                    trendLabel = 'æ¸›å°‘å‚¾å‘';
                    trendIcon = 'â†“';
                    trendColor = 'text-red-600';
                }

                const trendIconElement = document.getElementById(`stat-trend-icon-${chartNum}`);
                const trendLabelElement = document.getElementById(`stat-trend-label-${chartNum}`);
                const trendValueElement = document.getElementById(`stat-trend-value-${chartNum}`);

                if (trendIconElement) {
                    trendIconElement.textContent = trendIcon;
                    trendIconElement.className = `text-2xl ${trendColor}`;
                }
                if (trendLabelElement) {
                    trendLabelElement.textContent = trendLabel;
                    trendLabelElement.className = `text-sm font-bold ${trendColor}`;
                }
                if (trendValueElement) {
                    trendValueElement.textContent = `${trend > 0 ? '+' : ''}${trend}${metric.unit} (${trendPercent}%)`;
                }
            }

            // Yè»¸ãƒ¬ãƒ³ã‚¸è¨­å®šï¼ˆãƒ‡ãƒ¼ã‚¿ã«åŸºã¥ã„ã¦è‡ªå‹•èª¿æ•´ï¼‰
            // Chart2ã§ç•°ãªã‚‹ã‚«ãƒ†ã‚´ãƒªã‚’ä½¿ç”¨ã™ã‚‹å ´åˆã¯ã€ãã®ã‚«ãƒ†ã‚´ãƒªã®globalMinMaxã‚’è¨ˆç®—
            const currentGlobalMinMax = (chartNum === 2 && comparisonMode && categoryToUse !== currentSubCategory)
                ? calculateGlobalMinMax(categoryToUse)
                : globalMinMax;

            // Yè»¸ã‚’é¸æŠæœŸé–“ã®ãƒ‡ãƒ¼ã‚¿ã«åŸºã¥ã„ã¦è‡ªå‹•èª¿æ•´
            // ç¾åœ¨è¡¨ç¤ºã—ã¦ã„ã‚‹ãƒ‡ãƒ¼ã‚¿ã®ç¯„å›²ã‚’å–å¾—
            const validData = data.filter(v => v !== null && v !== undefined && !isNaN(v));
            if (validData.length > 0 && !metric.isBinary) {
                const dataMin = Math.min(...validData);
                const dataMax = Math.max(...validData);
                const dataRange = dataMax - dataMin;

                // é©åˆ‡ãªãƒãƒ¼ã‚¸ãƒ³ã‚’è¨­å®šï¼ˆãƒ‡ãƒ¼ã‚¿ç¯„å›²ã®15%ã€æœ€ä½0.5ï¼‰
                const margin = Math.max(dataRange * 0.15, 0.5);

                currentAxisRanges[chartNum] = {
                    min: Math.floor((dataMin - margin) * 10) / 10,
                    max: Math.ceil((dataMax + margin) * 10) / 10
                };
            } else if (metric.isBinary) {
                // ãƒã‚¤ãƒŠãƒªãƒ‡ãƒ¼ã‚¿ã®å ´åˆã¯å›ºå®šç¯„å›²
                currentAxisRanges[chartNum] = { min: -0.2, max: 1.2 };
            } else {
                // ãƒ‡ãƒ¼ã‚¿ãŒãªã„å ´åˆã¯å…¨æœŸé–“ã®ç¯„å›²ã‚’ä½¿ç”¨
                currentAxisRanges[chartNum] = { ...currentGlobalMinMax };
            }

            // è»¸å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒå­˜åœ¨ã™ã‚‹å ´åˆã®ã¿å€¤ã‚’è¨­å®š
            const axisMinElement = document.getElementById(`axis-min-${chartNum}`);
            const axisMaxElement = document.getElementById(`axis-max-${chartNum}`);
            if (axisMinElement) axisMinElement.value = currentAxisRanges[chartNum].min;
            if (axisMaxElement) axisMaxElement.value = currentAxisRanges[chartNum].max;

            // ã‚°ãƒ©ãƒ•æç”»
            if (charts[chartNum]) charts[chartNum].destroy();

            const chartType = metric.isBinary ? 'bar' : 'line';

            // ç›®æ¨™ãƒ©ã‚¤ãƒ³ã¨ãƒ¡ãƒ¢ãƒãƒ¼ã‚«ãƒ¼ã®ã‚¢ãƒãƒ†ãƒ¼ã‚·ãƒ§ãƒ³è¨­å®š
            const chartAnnotations = {};

            // ç›®æ¨™ãƒ©ã‚¤ãƒ³
            const goal = goals[categoryToUse];
            if (goal && goal.showLine && !metric.isBinary) {
                chartAnnotations.goalLine = {
                    type: 'line',
                    yMin: goal.value,
                    yMax: goal.value,
                    borderColor: 'rgb(34, 197, 94)', // green-500
                    borderWidth: 2,
                    borderDash: [6, 6],
                    label: {
                        display: true,
                        content: `ç›®æ¨™: ${goal.value}${metric.unit}`,
                        position: 'end',
                        backgroundColor: 'rgba(34, 197, 94, 0.8)',
                        color: 'white',
                        font: {
                            size: 11,
                            weight: 'bold'
                        },
                        padding: 4
                    }
                };
            }

            // ãƒ¡ãƒ¢ãƒãƒ¼ã‚«ãƒ¼
            const markers = getAnnotationMarkers(chartNum, categoryToUse);
            Object.assign(chartAnnotations, markers);

            // ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆã®é…åˆ—ã‚’æ§‹ç¯‰
            const datasets = [{
                label: metric.name,
                data: data,
                borderColor: chartNum === 1 ? 'rgb(168, 85, 247)' : 'rgb(59, 130, 246)',
                backgroundColor: chartNum === 1 ? 'rgba(168, 85, 247, 0.6)' : 'rgba(59, 130, 246, 0.6)',
                fill: !metric.isBinary,
                tension: 0.4,
                yAxisID: 'y'
            }];

            // ç§»å‹•å¹³å‡ç·šã‚’è¿½åŠ 
            if (showMovingAverage[chartNum] && !metric.isBinary) {
                const maData = calculateMovingAverage(data, movingAveragePeriod[chartNum]);
                datasets.push({
                    label: `${metric.name}ï¼ˆ${movingAveragePeriod[chartNum]}æ—¥ç§»å‹•å¹³å‡ï¼‰`,
                    data: maData,
                    borderColor: chartNum === 1 ? 'rgb(251, 146, 60)' : 'rgb(14, 165, 233)',
                    backgroundColor: 'transparent',
                    borderWidth: 2,
                    borderDash: [5, 5],
                    fill: false,
                    tension: 0.4,
                    pointRadius: 0,
                    yAxisID: 'y'
                });
            }

            // äºˆæ¸¬ç·šã‚’è¿½åŠ 
            if (showPrediction[chartNum] && !metric.isBinary && data.length >= 3) {
                const predictionData = calculatePrediction(data, 7);
                const predictionLabels = [...labels];
                for (let i = 1; i <= 7; i++) {
                    predictionLabels.push(`+${i}æ—¥`);
                }

                datasets.push({
                    label: `${metric.name}ï¼ˆäºˆæ¸¬ï¼‰`,
                    data: predictionData,
                    borderColor: 'rgb(34, 197, 94)',
                    backgroundColor: 'transparent',
                    borderWidth: 2,
                    borderDash: [10, 5],
                    fill: false,
                    tension: 0.1,
                    pointRadius: 0,
                    yAxisID: 'y'
                });

                // ãƒ©ãƒ™ãƒ«ã‚’æ›´æ–°
                labels = predictionLabels;
            }

            // ã‚¯ãƒ­ã‚¹ãƒ˜ã‚¢ãƒ—ãƒ©ã‚°ã‚¤ãƒ³
            const crosshairPlugin = {
                id: 'crosshair',
                afterDatasetsDraw: (chart) => {
                    if (chart.crosshair && chart.crosshair.draw) {
                        const ctx = chart.ctx;
                        const x = chart.crosshair.x;
                        const y = chart.crosshair.y;
                        const chartArea = chart.chartArea;

                        ctx.save();
                        ctx.strokeStyle = 'rgba(147, 51, 234, 0.6)';
                        ctx.lineWidth = 1;
                        ctx.setLineDash([5, 5]);

                        // ç¸¦ç·š
                        ctx.beginPath();
                        ctx.moveTo(x, chartArea.top);
                        ctx.lineTo(x, chartArea.bottom);
                        ctx.stroke();

                        // æ¨ªç·š
                        ctx.beginPath();
                        ctx.moveTo(chartArea.left, y);
                        ctx.lineTo(chartArea.right, y);
                        ctx.stroke();

                        ctx.restore();
                    }
                }
            };

            // å›ºå®šãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ—ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ï¼ˆã‚«ã‚¹ã‚¿ãƒ ãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ—ã¨ãƒªãƒ¼ãƒ‰ç·šã‚’æç”»ï¼‰
            const fixedTooltipPlugin = {
                id: 'fixedTooltip',
                afterDraw: (chart) => {
                    // ãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ—ãŒæœ‰åŠ¹ã§ã€é¸æŠã•ã‚ŒãŸãƒã‚¤ãƒ³ãƒˆãŒã‚ã‚‹å ´åˆ
                    if (tooltipEnabled[chartNum] && lastClickedIndex[chartNum] !== null) {
                        const ctx = chart.ctx;
                        const meta = chart.getDatasetMeta(0);
                        const dataPoint = meta.data[lastClickedIndex[chartNum]];

                        if (!dataPoint) return;

                        // ãƒ‡ãƒ¼ã‚¿ãƒã‚¤ãƒ³ãƒˆã®åº§æ¨™
                        const pointX = dataPoint.x;
                        const pointY = dataPoint.y;
                        const chartArea = chart.chartArea;

                        // ã‚«ã‚¹ã‚¿ãƒ ãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ—ã®ä½ç½®ï¼ˆå…¨æœŸé–“ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã¨ã‚°ãƒ©ãƒ•ã®é–“ã®æ‹¡å¼µã‚¹ãƒšãƒ¼ã‚¹ï¼‰
                        const tooltipWidth = 200;
                        const tooltipHeight = 55;
                        const tooltipX = (chartArea.left + chartArea.right) / 2;
                        const tooltipY = chartArea.top - 65; // ã‚°ãƒ©ãƒ•ã«ã‹ã¶ã‚‰ãªã„ã‚ˆã†ã«æ›´ã«ä¸Šã«é…ç½®

                        // ãƒ‡ãƒ¼ã‚¿ãƒã‚¤ãƒ³ãƒˆã«å¼·èª¿å††ã‚’æç”»
                        ctx.save();
                        ctx.beginPath();
                        ctx.arc(pointX, pointY, 6, 0, 2 * Math.PI);
                        ctx.fillStyle = 'rgba(147, 51, 234, 0.3)';
                        ctx.fill();
                        ctx.strokeStyle = 'rgba(147, 51, 234, 1)';
                        ctx.lineWidth = 2;
                        ctx.stroke();

                        // ãƒªãƒ¼ãƒ‰ç·šã‚’æç”»
                        ctx.beginPath();
                        ctx.moveTo(pointX, pointY);
                        ctx.lineTo(tooltipX, tooltipY + tooltipHeight);
                        ctx.lineWidth = 2;
                        ctx.strokeStyle = 'rgba(147, 51, 234, 0.8)';
                        ctx.setLineDash([5, 3]);
                        ctx.stroke();

                        // ã‚«ã‚¹ã‚¿ãƒ ãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ—ã‚’æç”»
                        ctx.setLineDash([]);

                        // å½±ã‚’è¿½åŠ 
                        ctx.shadowColor = 'rgba(0, 0, 0, 0.15)';
                        ctx.shadowBlur = 8;
                        ctx.shadowOffsetX = 0;
                        ctx.shadowOffsetY = 2;

                        ctx.fillStyle = 'rgba(255, 255, 255, 1)';
                        ctx.strokeStyle = 'rgba(147, 51, 234, 1)';
                        ctx.lineWidth = 2;

                        // è§’ä¸¸çŸ©å½¢
                        const radius = 8;
                        ctx.beginPath();
                        ctx.moveTo(tooltipX - tooltipWidth/2 + radius, tooltipY);
                        ctx.lineTo(tooltipX + tooltipWidth/2 - radius, tooltipY);
                        ctx.quadraticCurveTo(tooltipX + tooltipWidth/2, tooltipY, tooltipX + tooltipWidth/2, tooltipY + radius);
                        ctx.lineTo(tooltipX + tooltipWidth/2, tooltipY + tooltipHeight - radius);
                        ctx.quadraticCurveTo(tooltipX + tooltipWidth/2, tooltipY + tooltipHeight, tooltipX + tooltipWidth/2 - radius, tooltipY + tooltipHeight);
                        ctx.lineTo(tooltipX - tooltipWidth/2 + radius, tooltipY + tooltipHeight);
                        ctx.quadraticCurveTo(tooltipX - tooltipWidth/2, tooltipY + tooltipHeight, tooltipX - tooltipWidth/2, tooltipY + tooltipHeight - radius);
                        ctx.lineTo(tooltipX - tooltipWidth/2, tooltipY + radius);
                        ctx.quadraticCurveTo(tooltipX - tooltipWidth/2, tooltipY, tooltipX - tooltipWidth/2 + radius, tooltipY);
                        ctx.closePath();
                        ctx.fill();
                        ctx.stroke();

                        // å½±ã‚’ãƒªã‚»ãƒƒãƒˆ
                        ctx.shadowColor = 'transparent';
                        ctx.shadowBlur = 0;
                        ctx.shadowOffsetX = 0;
                        ctx.shadowOffsetY = 0;

                        // ãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ—ã®ãƒ†ã‚­ã‚¹ãƒˆã‚’æç”»
                        const value = chart.data.datasets[0].data[lastClickedIndex[chartNum]];
                        const label = chart.data.labels[lastClickedIndex[chartNum]];
                        const categoryToUse = chartNum === 1 ? currentSubCategory : chart2Category;
                        const unit = metricInfo[categoryToUse]?.unit || '';

                        // æ—¥ä»˜æƒ…å ±
                        const today = new Date();
                        const totalDays = chart.data.labels.length;
                        const daysAgo = totalDays - 1 - lastClickedIndex[chartNum];
                        const targetDate = new Date(today);
                        targetDate.setDate(today.getDate() - daysAgo);
                        const dateStr = `${targetDate.getMonth() + 1}/${targetDate.getDate()}`;
                        let dateLabel;
                        if (daysAgo === 0) dateLabel = `${dateStr} (ä»Šæ—¥)`;
                        else if (daysAgo === 1) dateLabel = `${dateStr} (1æ—¥å‰)`;
                        else dateLabel = `${dateStr} (${daysAgo}æ—¥å‰)`;

                        // å€¤ã®ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
                        let displayValue;
                        if (metric.getLabel && typeof value === 'number') {
                            // æ®µéšèª¬æ˜ãŒã‚ã‚‹å ´åˆ
                            displayValue = metric.getLabel(value);
                        } else if (typeof value === 'number') {
                            displayValue = value % 1 === 0 ? value.toString() : value.toFixed(1);
                        } else {
                            displayValue = value || '-';
                        }

                        ctx.textAlign = 'center';
                        ctx.textBaseline = 'middle';
                        ctx.fillStyle = '#6b7280';
                        ctx.font = '11px sans-serif';
                        ctx.fillText(dateLabel, tooltipX, tooltipY + 15);
                        ctx.font = 'bold 18px sans-serif';
                        ctx.fillStyle = '#7c3aed';
                        ctx.fillText(`${displayValue}${unit}`, tooltipX, tooltipY + 35);

                        ctx.restore();
                    }
                }
            };

            const chartConfig = {
                type: chartType,
                data: {
                    labels: labels,
                    datasets: datasets
                },
                plugins: [crosshairPlugin, fixedTooltipPlugin],
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    onClick: (event, activeElements) => {
                        if (activeElements.length > 0) {
                            const datasetIndex = activeElements[0].datasetIndex;
                            const index = activeElements[0].index;

                            // ãƒ¡ã‚¤ãƒ³ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆã®å ´åˆã€é¸æŠãƒ‘ãƒãƒ«ã‚’è¡¨ç¤ºã—ã€ãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ—ã‚’æœ‰åŠ¹åŒ–
                            if (datasetIndex === 0 && index < data.length) {
                                // æœ€å¾Œã«ã‚¯ãƒªãƒƒã‚¯ã—ãŸä½ç½®ã‚’è¨˜éŒ²ï¼ˆselectDataPointã‚ˆã‚Šå…ˆã«ï¼‰
                                lastClickedChart = chartNum;
                                lastClickedIndex[chartNum] = index;

                                // ãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ—ãŒç„¡åŠ¹ãªå ´åˆã€è‡ªå‹•çš„ã«æœ‰åŠ¹åŒ–
                                if (!tooltipEnabled[chartNum]) {
                                    toggleTooltip(chartNum);
                                }

                                // é¸æŠãƒ‘ãƒãƒ«ã‚’æ›´æ–°
                                selectDataPoint(chartNum, index);
                            }
                        } else {
                            // ã‚°ãƒ©ãƒ•å¤–ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸå ´åˆã€ãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ—ã‚’ç„¡åŠ¹åŒ–
                            if (tooltipEnabled[chartNum] && lastClickedChart === chartNum) {
                                toggleTooltip(chartNum);
                                lastClickedChart = null;
                                lastClickedIndex[chartNum] = null;
                            }
                        }
                    },
                    layout: {
                        padding: {
                            left: 10,
                            right: 20,
                            top: 90,  // ä¸Šéƒ¨ã®ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ã‚’æ‹¡å¤§ã—ã¦ãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ—ç”¨ã®ã‚¹ãƒšãƒ¼ã‚¹ã‚’ç¢ºä¿
                            bottom: 10
                        }
                    },
                    plugins: {
                        legend: {
                            display: datasets.length > 1,
                            position: 'top',
                            labels: {
                                boxWidth: 12,
                                font: { size: 10 },
                                padding: 8
                            }
                        },
                        tooltip: {
                            enabled: false
                        },
                        annotation: {
                            annotations: chartAnnotations
                        }
                    },
                    interaction: {
                        mode: 'index',
                        intersect: false
                    },
                    onHover: (event, activeElements, chart) => {
                        // ãƒã‚¦ã‚¹ãƒ›ãƒãƒ¼æ™‚ã«ã‚¯ãƒ­ã‚¹ãƒ˜ã‚¢ã‚’è¡¨ç¤º
                        const canvasPosition = Chart.helpers.getRelativePosition(event, chart);

                        if (canvasPosition.x >= chart.chartArea.left &&
                            canvasPosition.x <= chart.chartArea.right &&
                            canvasPosition.y >= chart.chartArea.top &&
                            canvasPosition.y <= chart.chartArea.bottom) {

                            chart.crosshair = {
                                x: canvasPosition.x,
                                y: canvasPosition.y,
                                draw: true
                            };
                        } else {
                            chart.crosshair = { draw: false };
                        }

                        chart.draw();
                    },
                    scales: (() => {
                        const scales = {
                            y: {
                                type: 'linear',
                                display: true,
                                position: 'left',
                                beginAtZero: false,
                                min: currentAxisRanges[chartNum].min,
                                max: currentAxisRanges[chartNum].max,
                                ticks: metric.isBinary ? {
                                    stepSize: 1,
                                    callback: function(value) {
                                        return value === 1 ? 'å®Œäº†' : value === 0 ? 'æœªå®Œäº†' : '';
                                    }
                                } : {
                                    padding: 10,
                                    font: {
                                        size: 11
                                    }
                                },
                                grid: {
                                    drawBorder: true,
                                    color: 'rgba(0, 0, 0, 0.1)'
                                }
                            },
                            x: {
                                ticks: {
                                    padding: 5,
                                    font: {
                                        size: 10
                                    },
                                    autoSkip: false,
                                    maxRotation: 0,
                                    callback: function(value, index, ticks) {
                                        const label = this.getLabelForValue(value);
                                        const totalDays = ticks.length;

                                        // å¿…ãš7ãƒã‚¤ãƒ³ãƒˆã«é™å®šã—ã¦å‡ç­‰ã«é…åˆ†
                                        const maxLabels = 7;
                                        const step = Math.floor((totalDays - 1) / (maxLabels - 1));

                                        // è¡¨ç¤ºã™ã‚‹ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’è¨ˆç®—
                                        let shouldDisplay = false;

                                        if (totalDays <= maxLabels) {
                                            // ãƒ‡ãƒ¼ã‚¿ãŒ7å€‹ä»¥ä¸‹ã®å ´åˆã¯ã™ã¹ã¦è¡¨ç¤º
                                            shouldDisplay = true;
                                        } else {
                                            // æœ€åˆã¨æœ€å¾Œã¯å¿…ãšè¡¨ç¤º
                                            if (index === 0 || index === totalDays - 1) {
                                                shouldDisplay = true;
                                            } else {
                                                // å‡ç­‰ã«é…åˆ†ã•ã‚ŒãŸä½ç½®ã«è¡¨ç¤º
                                                for (let i = 1; i < maxLabels - 1; i++) {
                                                    if (index === i * step) {
                                                        shouldDisplay = true;
                                                        break;
                                                    }
                                                }
                                            }
                                        }

                                        if (!shouldDisplay) {
                                            return '';
                                        }

                                        // æœ€å¾Œã®ãƒ©ãƒ™ãƒ«ï¼ˆå³ç«¯ï¼‰ã«ã®ã¿å˜ä½ã‚’è¿½åŠ 
                                        if (index === totalDays - 1) {
                                            return label === '0' ? 'ä»Šæ—¥' : label + 'æ—¥å‰';
                                        }

                                        return label;
                                    }
                                },
                                grid: {
                                    display: false
                                }
                            }
                        };

                        return scales;
                    })()
                }
            };

            charts[chartNum] = new Chart(document.getElementById(`main-chart-${chartNum}`), chartConfig);
        }

        // RMç”¨ã®å¤‰æ•°
        let currentRMReps = null;
        let currentRMExercise = null;

        // å°ã‚«ãƒ†ã‚´ãƒªé¸æŠ
        function selectSubCategory(category, subCategory) {
            currentSubCategory = subCategory;

            // RMé¸æŠæ™‚ã¯èª¿æ•´ãƒ‘ãƒãƒ«ã‚’è¡¨ç¤º
            const rmPanel = document.getElementById('rm-control-panel');
            if (subCategory === 'rm') {
                if (rmPanel) {
                    rmPanel.classList.remove('hidden');
                    initializeRMPanel();
                }
                return; // ãƒ‘ãƒãƒ«è¡¨ç¤ºã®ã¿ã§ã€ã‚°ãƒ©ãƒ•ã¯è¡¨ç¤ºã—ãªã„
            } else {
                if (rmPanel) rmPanel.classList.add('hidden');
                currentRMReps = null;
                currentRMExercise = null;
            }

            // å…¨æœŸé–“ã®æœ€ä½å€¤ãƒ»æœ€å¤§å€¤ã‚’å†è¨ˆç®—
            globalMinMax = calculateGlobalMinMax(subCategory);

            // Yè»¸ãƒ¬ãƒ³ã‚¸ã‚’ãƒªã‚»ãƒƒãƒˆ
            currentAxisRanges = { 1: { min: null, max: null }, 2: { min: null, max: null } };

            // ã‚«ãƒ†ã‚´ãƒªåˆ¥ã®è‰²è¨­å®šï¼ˆã‚¢ãƒ—ãƒªã¨å®Œå…¨ä¸€è‡´ï¼‰
            const categoryColors = {
                nutrition: { border: 'border-green-500', text: 'text-green-700' },   // é£Ÿäº‹: ç·‘
                training: { border: 'border-orange-500', text: 'text-orange-700' },  // é‹å‹•: ã‚ªãƒ¬ãƒ³ã‚¸
                condition: { border: 'border-red-500', text: 'text-red-700' },       // ã‚³ãƒ³ãƒ‡ã‚£ã‚·ãƒ§ãƒ³: èµ¤
                performance: { border: 'border-purple-500', text: 'text-purple-700' }// ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹: ç´«
            };

            const colors = categoryColors[category] || categoryColors.performance;

            // ç¾åœ¨ã®ã‚«ãƒ†ã‚´ãƒªã®ã‚µãƒ–ã‚¿ãƒ–ãƒœã‚¿ãƒ³ã®ã¿ã‚’æ›´æ–°
            const subtabContainer = document.getElementById(`${category}-subtabs`);
            if (subtabContainer) {
                subtabContainer.querySelectorAll('.sub-tab-button').forEach(btn => {
                    btn.classList.remove('active', 'border-orange-500', 'text-orange-700', 'border-green-500', 'text-green-700', 'border-red-500', 'text-red-700', 'border-purple-500', 'text-purple-700');
                    btn.classList.add('border-transparent', 'text-gray-700');
                });

                if (event && event.currentTarget) {
                    event.currentTarget.classList.add('active', colors.border, colors.text);
                    event.currentTarget.classList.remove('border-transparent', 'text-gray-700');
                }
            }

            updateChart(1);
            if (comparisonMode) {
                updateChart(2);
            }
        }

        // RMãƒ‘ãƒãƒ«ã®åˆæœŸåŒ–
        function initializeRMPanel() {
            if (!allData.rm || Object.keys(allData.rm).length === 0) {
                document.getElementById('rm-reps-buttons').innerHTML = '<span class="text-xs text-gray-500">RMè¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“</span>';
                document.getElementById('rm-exercise-buttons').innerHTML = '';
                return;
            }

            // åˆ©ç”¨å¯èƒ½ãªå›æ•°ã‚’æŠ½å‡º
            const repsSet = new Set();
            Object.keys(allData.rm).forEach(key => {
                const [reps, exercise] = key.split('_');
                repsSet.add(parseInt(reps));
            });
            const repsList = Array.from(repsSet).sort((a, b) => a - b);

            // å›æ•°ãƒœã‚¿ãƒ³ã‚’ç”Ÿæˆ
            const repsContainer = document.getElementById('rm-reps-buttons');
            repsContainer.innerHTML = repsList.map((reps, index) =>
                `<button type="button"
                    class="px-2 py-1 text-xs font-semibold rounded border ${index === 0 ? 'bg-orange-600 text-white border-orange-600' : 'bg-white text-gray-700 border-gray-300 hover:border-orange-400'}"
                    onclick="selectRMReps(${reps})">
                    ${reps}RM
                </button>`
            ).join('');

            // æœ€åˆã®å›æ•°ã‚’è‡ªå‹•é¸æŠ
            if (repsList.length > 0) {
                selectRMReps(repsList[0]);
            }
        }

        // RMå›æ•°ã‚’é¸æŠ
        function selectRMReps(reps) {
            currentRMReps = reps;

            // ãƒœã‚¿ãƒ³ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ–çŠ¶æ…‹ã‚’æ›´æ–°
            document.querySelectorAll('#rm-reps-buttons button').forEach(btn => {
                btn.classList.remove('bg-orange-600', 'text-white', 'border-orange-600');
                btn.classList.add('bg-white', 'text-gray-700', 'border-gray-300');
            });
            event.currentTarget.classList.add('bg-orange-600', 'text-white', 'border-orange-600');
            event.currentTarget.classList.remove('bg-white', 'text-gray-700', 'border-gray-300');

            // ã“ã®å›æ•°ã§åˆ©ç”¨å¯èƒ½ãªç¨®ç›®ã‚’æŠ½å‡º
            const exercises = [];
            Object.keys(allData.rm).forEach(key => {
                const [keyReps, exercise] = key.split('_');
                if (parseInt(keyReps) === reps) {
                    exercises.push(exercise);
                }
            });

            // ç¨®ç›®ãƒœã‚¿ãƒ³ã‚’ç”Ÿæˆ
            const exerciseContainer = document.getElementById('rm-exercise-buttons');
            exerciseContainer.innerHTML = exercises.map((exercise, index) =>
                `<button type="button"
                    class="px-2 py-1 text-xs font-semibold rounded border ${index === 0 ? 'bg-orange-600 text-white border-orange-600' : 'bg-white text-gray-700 border-gray-300 hover:border-orange-400'}"
                    onclick="selectRMExercise('${exercise}')">
                    ${exercise}
                </button>`
            ).join('');

            // æœ€åˆã®ç¨®ç›®ã‚’è‡ªå‹•é¸æŠ
            if (exercises.length > 0) {
                currentRMExercise = exercises[0];
                updateRMChart();
            }
        }

        // RMç¨®ç›®ã‚’é¸æŠ
        function selectRMExercise(exercise) {
            currentRMExercise = exercise;

            // ãƒœã‚¿ãƒ³ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ–çŠ¶æ…‹ã‚’æ›´æ–°
            document.querySelectorAll('#rm-exercise-buttons button').forEach(btn => {
                btn.classList.remove('bg-orange-600', 'text-white', 'border-orange-600');
                btn.classList.add('bg-white', 'text-gray-700', 'border-gray-300');
            });
            event.currentTarget.classList.add('bg-orange-600', 'text-white', 'border-orange-600');
            event.currentTarget.classList.remove('bg-white', 'text-gray-700', 'border-gray-300');

            updateRMChart();
        }

        // RMã‚°ãƒ©ãƒ•ã‚’æ›´æ–°
        function updateRMChart() {
            const key = `${currentRMReps}_${currentRMExercise}`;
            currentSubCategory = `rm_${key}`;

            // metricInfoã«å‹•çš„ã«è¿½åŠ 
            if (!metricInfo[currentSubCategory]) {
                metricInfo[currentSubCategory] = {
                    name: `${currentRMExercise} ${currentRMReps}RM`,
                    unit: 'kg',
                    icon: 'ğŸ’ª',
                    isBinary: false
                };
            }

            // allDataã«ãƒãƒƒãƒ”ãƒ³ã‚°
            if (!allData[currentSubCategory]) {
                allData[currentSubCategory] = allData.rm[key] || [];
            }

            globalMinMax = calculateGlobalMinMax(currentSubCategory);
            currentAxisRanges = { 1: { min: null, max: null }, 2: { min: null, max: null } };

            updateChart(1);
            if (comparisonMode) {
                updateChart(2);
            }
        }

        // ç›®æ¨™ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿
        function loadGoals() {
            try {
                const stored = localStorage.getItem('fitness_goals');
                if (stored) {
                    goals = JSON.parse(stored);
                }
            } catch (error) {
                console.error('ç›®æ¨™ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
                goals = {};
            }
        }

        // ç›®æ¨™ãƒ‡ãƒ¼ã‚¿ã®ä¿å­˜
        function saveGoalsToStorage() {
            try {
                localStorage.setItem('fitness_goals', JSON.stringify(goals));
            } catch (error) {
                console.error('ç›®æ¨™ãƒ‡ãƒ¼ã‚¿ã®ä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
            }
        }

        // ç›®æ¨™è¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
        function openGoalSettingModal() {
            const modal = document.getElementById('goal-setting-modal');
            const metricSelect = document.getElementById('goal-metric');

            // ç¾åœ¨ã®æŒ‡æ¨™ã‚’é¸æŠçŠ¶æ…‹ã«ã™ã‚‹
            metricSelect.value = currentSubCategory;
            updateGoalUnit();

            // æ—¢å­˜ã®ç›®æ¨™ã‚’ãƒ­ãƒ¼ãƒ‰
            loadCurrentGoal();

            modal.classList.add('show');
            lucide.createIcons();
        }

        function closeGoalSettingModal() {
            document.getElementById('goal-setting-modal').classList.remove('show');
        }

        // æŒ‡æ¨™ã«å¿œã˜ã¦å˜ä½ã‚’æ›´æ–°
        document.getElementById('goal-metric')?.addEventListener('change', updateGoalUnit);

        function updateGoalUnit() {
            const metricSelect = document.getElementById('goal-metric');
            const selectedMetric = metricSelect.value;
            const metric = metricInfo[selectedMetric];
            document.getElementById('goal-unit').textContent = metric.unit;
            loadCurrentGoal();
        }

        // ç¾åœ¨ã®ç›®æ¨™ã‚’è¡¨ç¤º
        function loadCurrentGoal() {
            const metricSelect = document.getElementById('goal-metric');
            const selectedMetric = metricSelect.value;
            const goal = goals[selectedMetric];
            const infoDiv = document.getElementById('current-goal-info');
            const textDiv = document.getElementById('current-goal-text');

            if (goal) {
                const metric = metricInfo[selectedMetric];
                let text = `ç›®æ¨™å€¤: ${goal.value}${metric.unit}`;
                if (goal.date) {
                    text += `<br>é”æˆäºˆå®šæ—¥: ${goal.date}`;
                }
                text += `<br>ã‚°ãƒ©ãƒ•è¡¨ç¤º: ${goal.showLine ? 'ON' : 'OFF'}`;

                textDiv.innerHTML = text;
                infoDiv.classList.remove('hidden');

                // ãƒ•ã‚©ãƒ¼ãƒ ã«å€¤ã‚’è¨­å®š
                document.getElementById('goal-value').value = goal.value;
                document.getElementById('goal-date').value = goal.date || '';
                document.getElementById('goal-show-line').checked = goal.showLine;
            } else {
                infoDiv.classList.add('hidden');
                // ãƒ•ã‚©ãƒ¼ãƒ ã‚’ã‚¯ãƒªã‚¢
                document.getElementById('goal-value').value = '';
                document.getElementById('goal-date').value = '';
                document.getElementById('goal-show-line').checked = true;
            }
        }

        // ç›®æ¨™ã‚’ä¿å­˜
        function saveGoal() {
            const metricSelect = document.getElementById('goal-metric');
            const selectedMetric = metricSelect.value;
            const value = parseFloat(document.getElementById('goal-value').value);
            const date = document.getElementById('goal-date').value;
            const showLine = document.getElementById('goal-show-line').checked;

            if (isNaN(value) || value <= 0) {
                alert('æœ‰åŠ¹ãªç›®æ¨™å€¤ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }

            // ç›®æ¨™ã‚’ä¿å­˜
            goals[selectedMetric] = {
                value: value,
                date: date || null,
                showLine: showLine,
                createdAt: new Date().toISOString()
            };

            saveGoalsToStorage();

            // ã‚°ãƒ©ãƒ•ã‚’æ›´æ–°ï¼ˆç›®æ¨™ãƒ©ã‚¤ãƒ³ã‚’è¡¨ç¤ºï¼‰
            updateChart(1);
            if (comparisonMode) {
                updateChart(2);
            }

            alert('ç›®æ¨™ã‚’ä¿å­˜ã—ã¾ã—ãŸï¼');
            closeGoalSettingModal();
        }

        // ç›®æ¨™ã‚’ã‚¯ãƒªã‚¢
        function clearGoal() {
            const metricSelect = document.getElementById('goal-metric');
            const selectedMetric = metricSelect.value;

            if (goals[selectedMetric]) {
                if (confirm('ã“ã®æŒ‡æ¨™ã®ç›®æ¨™ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã™ã‹ï¼Ÿ')) {
                    delete goals[selectedMetric];
                    saveGoalsToStorage();
                    loadCurrentGoal();

                    // ã‚°ãƒ©ãƒ•ã‚’æ›´æ–°
                    updateChart(1);
                    if (comparisonMode) {
                        updateChart(2);
                    }

                    alert('ç›®æ¨™ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ');
                }
            } else {
                alert('è¨­å®šã•ã‚ŒãŸç›®æ¨™ãŒã‚ã‚Šã¾ã›ã‚“');
            }
        }

        // ã‚¢ãƒãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆãƒ¡ãƒ¢ï¼‰æ©Ÿèƒ½
        function loadAnnotations() {
            try {
                const stored = localStorage.getItem('fitness_annotations');
                if (stored) {
                    annotations = JSON.parse(stored);
                }
            } catch (error) {
                console.error('ã‚¢ãƒãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã®èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
                annotations = {};
            }
        }

        function saveAnnotations() {
            try {
                localStorage.setItem('fitness_annotations', JSON.stringify(annotations));
            } catch (error) {
                console.error('ã‚¢ãƒãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã®ä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
            }
        }

        // ã‚°ãƒ©ãƒ•ã®ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆã§ãƒ¡ãƒ¢ã‚’è¿½åŠ 
        function addAnnotationOnClick(chartNum, event) {
            const chart = charts[chartNum];
            if (!chart) return;

            const points = chart.getElementsAtEventForMode(event, 'nearest', { intersect: true }, true);

            if (points.length > 0) {
                const point = points[0];
                const dataIndex = point.index;
                const label = chart.data.labels[dataIndex];
                const metric = metricInfo[currentSubCategory];

                // ãƒ¡ãƒ¢ã‚’å…¥åŠ›
                const note = prompt(`${label}ã®ãƒ¡ãƒ¢ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:\nï¼ˆä¾‹: é¢¨é‚ªã§ä¼‘é¤Šã€ãƒãƒ¼ãƒˆãƒ‡ã‚¤ã€ä½“èª¿è‰¯å¥½ï¼‰`);

                if (note && note.trim() !== '') {
                    const key = `${currentSubCategory}_${label}`;
                    annotations[key] = {
                        date: label,
                        note: note.trim(),
                        metric: currentSubCategory,
                        createdAt: new Date().toISOString()
                    };

                    saveAnnotations();
                    updateChart(chartNum);
                    alert('ãƒ¡ãƒ¢ã‚’ä¿å­˜ã—ã¾ã—ãŸï¼');
                }
            }
        }

        // ã‚¢ãƒãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ãƒãƒ¼ã‚«ãƒ¼ã‚’ã‚°ãƒ©ãƒ•ã«è¿½åŠ 
        function getAnnotationMarkers(chartNum, category) {
            const labels = charts[chartNum]?.data.labels || [];
            const markers = {};

            labels.forEach((label, index) => {
                const key = `${category}_${label}`;
                if (annotations[key]) {
                    markers[`note_${index}`] = {
                        type: 'point',
                        xValue: index,
                        yValue: currentData[chartNum][index],
                        backgroundColor: 'rgba(255, 193, 7, 0.8)', // amber-400
                        borderColor: 'rgb(245, 158, 11)',
                        borderWidth: 2,
                        radius: 8,
                        label: {
                            display: true,
                            content: 'ğŸ“',
                            position: 'top',
                            font: {
                                size: 14
                            }
                        }
                    };
                }
            });

            return markers;
        }

        // ã‚°ãƒ©ãƒ•ãƒ›ãƒãƒ¼æ™‚ã«ãƒ¡ãƒ¢ã‚’è¡¨ç¤º
        function showAnnotationTooltip(chartNum, tooltipItems) {
            if (!tooltipItems || tooltipItems.length === 0) return;

            const index = tooltipItems[0].dataIndex;
            const label = charts[chartNum].data.labels[index];
            const key = `${currentSubCategory}_${label}`;

            if (annotations[key]) {
                return [
                    tooltipItems[0].formattedValue,
                    '',
                    `ğŸ“ ãƒ¡ãƒ¢: ${annotations[key].note}`
                ];
            }

            return tooltipItems[0].formattedValue;
        }

        // ãƒ•ãƒ­ãƒ¼ãƒ†ã‚£ãƒ³ã‚°è¨­å®šãƒ‘ãƒãƒ«
        let currentPanelChart = 1; // ã©ã®ã‚°ãƒ©ãƒ•ã®è¨­å®šã‚’é–‹ã„ã¦ã„ã‚‹ã‹

        function toggleSettingsPanel(chartNum) {
            const panel = document.getElementById('settings-panel');
            const isHidden = panel.classList.contains('hidden');

            if (isHidden) {
                currentPanelChart = chartNum;
                openSettingsPanel();
            } else {
                closeSettingsPanel();
            }
        }

        function openSettingsPanel() {
            const panel = document.getElementById('settings-panel');
            panel.classList.remove('hidden');

            // ãƒ‘ãƒãƒ«ã®çŠ¶æ…‹ã‚’ç¾åœ¨ã®ã‚°ãƒ©ãƒ•è¨­å®šã«åŒæœŸ
            syncPanelToCurrentSettings();

            // Flatpickrã‚’åˆæœŸåŒ–ï¼ˆãƒ‘ãƒãƒ«ç”¨ï¼‰
            initPanelFlatpickr();

            lucide.createIcons();
        }

        function closeSettingsPanel() {
            document.getElementById('settings-panel').classList.add('hidden');
        }

        function syncPanelToCurrentSettings() {
            // Yè»¸ç¯„å›²ã‚’åŒæœŸ
            const axisMinPanel = document.getElementById('axis-min-panel');
            const axisMaxPanel = document.getElementById('axis-max-panel');
            const comparisonModePanel = document.getElementById('comparison-mode-panel');
            const syncAxisPanel = document.getElementById('sync-axis-panel');

            if (axisMinPanel) axisMinPanel.value = currentAxisRanges[currentPanelChart].min || '';
            if (axisMaxPanel) axisMaxPanel.value = currentAxisRanges[currentPanelChart].max || '';

            // æ¯”è¼ƒãƒ¢ãƒ¼ãƒ‰ã¨Yè»¸é€£å‹•ã‚’åŒæœŸ
            if (comparisonModePanel) comparisonModePanel.checked = comparisonMode;
            if (syncAxisPanel) syncAxisPanel.checked = axisSync;

            // Chart2ã‚«ãƒ†ã‚´ãƒªãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã‚’æ›´æ–°
            updateChart2CategoryDropdown();
        }

        function updateChart2CategoryDropdown() {
            const select = document.getElementById('chart2-category-panel');
            if (!select) return;

            // ç¾åœ¨é¸æŠã•ã‚Œã¦ã„ã‚‹å€¤ã‚’ä¿å­˜
            const currentValue = chart2Category;

            // ã™ã¹ã¦ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’ã‚¯ãƒªã‚¢
            select.innerHTML = '';

            // ã‚«ãƒ†ã‚´ãƒªåˆ¥ã«ã‚°ãƒ«ãƒ¼ãƒ—åŒ–ã—ã¦ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’è¿½åŠ 
            const categories = {
                'ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹': ['lbm', 'directive', 'overall'],
                'é£Ÿäº‹': ['calories', 'protein', 'carbs', 'fat', 'water'],
                'é‹å‹•': ['workout_duration', 'workout_volume', 'steps', 'cardio'],
                'ã‚³ãƒ³ãƒ‡ã‚£ã‚·ãƒ§ãƒ³': ['weight', 'body_fat', 'sleep', 'mood', 'energy']
            };

            for (const [categoryName, metrics] of Object.entries(categories)) {
                const optgroup = document.createElement('optgroup');
                optgroup.label = categoryName;

                for (const metric of metrics) {
                    if (metricInfo[metric]) {
                        const option = document.createElement('option');
                        option.value = metric;
                        option.textContent = `${metricInfo[metric].icon} ${metricInfo[metric].name}`;
                        if (metric === currentValue) {
                            option.selected = true;
                        }
                        optgroup.appendChild(option);
                    }
                }

                select.appendChild(optgroup);
            }
        }

        function initPanelFlatpickr() {
            if (!flatpickrInstances['panel']) {
                flatpickrInstances['panel'] = {
                    start: flatpickr('#custom-start-panel', {
                        locale: 'ja',
                        dateFormat: 'Y-m-d',
                        maxDate: 'today',
                        onChange: function(selectedDates) {
                            if (flatpickrInstances['panel']?.end) {
                                flatpickrInstances['panel'].end.set('minDate', selectedDates[0]);
                            }
                        }
                    }),
                    end: flatpickr('#custom-end-panel', {
                        locale: 'ja',
                        dateFormat: 'Y-m-d',
                        maxDate: 'today'
                    })
                };
            }
        }

        function applyCustomPeriodFromPanel() {
            const startDate = document.getElementById('custom-start-panel').value;
            const endDate = document.getElementById('custom-end-panel').value;

            if (!startDate || !endDate) {
                alert('é–‹å§‹æ—¥ã¨çµ‚äº†æ—¥ã‚’é¸æŠã—ã¦ãã ã•ã„');
                return;
            }

            const start = new Date(startDate);
            const end = new Date(endDate);

            if (start > end) {
                alert('é–‹å§‹æ—¥ã¯çµ‚äº†æ—¥ã‚ˆã‚Šå‰ã§ã‚ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™');
                return;
            }

            const days = Math.ceil((end - start) / (1000 * 60 * 60 * 24)) + 1;

            if (days > 90) {
                alert('æœ€å¤§90æ—¥é–“ã¾ã§é¸æŠã§ãã¾ã™');
                return;
            }

            currentPeriods[currentPanelChart] = days;

            // æœŸé–“ãƒœã‚¿ãƒ³ã®é¸æŠçŠ¶æ…‹ã‚’ãƒªã‚»ãƒƒãƒˆ
            const container = currentPanelChart === 1 ? document.getElementById('chart-1') : document.getElementById('chart-2');
            container.querySelectorAll('.period-button').forEach(btn => {
                btn.classList.remove('active');
                btn.classList.remove('border-purple-500', 'border-blue-500', 'font-semibold');
                btn.classList.add('border-gray-300');
            });

            updateChart(currentPanelChart);
            alert(`ã‚«ã‚¹ã‚¿ãƒ æœŸé–“ï¼ˆ${days}æ—¥é–“ï¼‰ã‚’é©ç”¨ã—ã¾ã—ãŸ`);
        }

        function updateAxisRangeFromPanel() {
            const min = parseFloat(document.getElementById('axis-min-panel').value);
            const max = parseFloat(document.getElementById('axis-max-panel').value);

            if (!isNaN(min) && !isNaN(max) && min < max) {
                currentAxisRanges[currentPanelChart] = { min, max };

                // ã‚°ãƒ©ãƒ•ã‚’æ›´æ–°
                if (charts[currentPanelChart]) {
                    charts[currentPanelChart].options.scales.y.min = min;
                    charts[currentPanelChart].options.scales.y.max = max;
                    charts[currentPanelChart].update();
                }

                // Yè»¸é€£å‹•ãŒONã§ã€ã‚°ãƒ©ãƒ•1ã®å¤‰æ›´ãªã‚‰ã€ã‚°ãƒ©ãƒ•2ã‚‚åŒæœŸ
                if (axisSync && currentPanelChart === 1 && comparisonMode) {
                    currentAxisRanges[2] = { min, max };
                    if (charts[2]) {
                        charts[2].options.scales.y.min = min;
                        charts[2].options.scales.y.max = max;
                        charts[2].update();
                    }
                }
            }
        }

        function resetAxisRangeFromPanel() {
            document.getElementById('axis-min-panel').value = globalMinMax.min;
            document.getElementById('axis-max-panel').value = globalMinMax.max;
            updateAxisRangeFromPanel();
        }

        // ã‚«ã‚¹ã‚¿ãƒ æœŸé–“é¸æŠæ©Ÿèƒ½
        let flatpickrInstances = {};

        function initFlatpickr() {
            // Flatpickrã‚’æ—¥æœ¬èªã«è¨­å®š
            if (typeof flatpickr !== 'undefined') {
                flatpickr.localize(flatpickr.l10ns.ja);
            }

            // Chart 1ã®FlatpickråˆæœŸåŒ–
            if (!flatpickrInstances[1]) {
                flatpickrInstances[1] = {
                    start: flatpickr('#custom-start-1', {
                        locale: 'ja',
                        dateFormat: 'Y-m-d',
                        maxDate: 'today',
                        onChange: function(selectedDates) {
                            if (flatpickrInstances[1]?.end) {
                                flatpickrInstances[1].end.set('minDate', selectedDates[0]);
                            }
                        }
                    }),
                    end: flatpickr('#custom-end-1', {
                        locale: 'ja',
                        dateFormat: 'Y-m-d',
                        maxDate: 'today'
                    })
                };
            }

            // Chart 2ã®FlatpickråˆæœŸåŒ–
            if (!flatpickrInstances[2]) {
                flatpickrInstances[2] = {
                    start: flatpickr('#custom-start-2', {
                        locale: 'ja',
                        dateFormat: 'Y-m-d',
                        maxDate: 'today',
                        onChange: function(selectedDates) {
                            if (flatpickrInstances[2]?.end) {
                                flatpickrInstances[2].end.set('minDate', selectedDates[0]);
                            }
                        }
                    }),
                    end: flatpickr('#custom-end-2', {
                        locale: 'ja',
                        dateFormat: 'Y-m-d',
                        maxDate: 'today'
                    })
                };
            }
        }

        function toggleCustomPeriod(chartNum) {
            const customPeriodDiv = document.getElementById(`custom-period-${chartNum}`);
            customPeriodDiv.classList.toggle('hidden');

            // åˆå›è¡¨ç¤ºæ™‚ã«Flatpickrã‚’åˆæœŸåŒ–
            if (!customPeriodDiv.classList.contains('hidden')) {
                initFlatpickr();
            }

            lucide.createIcons();
        }

        function applyCustomPeriod(chartNum) {
            const startDate = document.getElementById(`custom-start-${chartNum}`).value;
            const endDate = document.getElementById(`custom-end-${chartNum}`).value;

            if (!startDate || !endDate) {
                alert('é–‹å§‹æ—¥ã¨çµ‚äº†æ—¥ã‚’é¸æŠã—ã¦ãã ã•ã„');
                return;
            }

            const start = new Date(startDate);
            const end = new Date(endDate);

            if (start > end) {
                alert('é–‹å§‹æ—¥ã¯çµ‚äº†æ—¥ã‚ˆã‚Šå‰ã§ã‚ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™');
                return;
            }

            // æ—¥æ•°ã‚’è¨ˆç®—
            const days = Math.ceil((end - start) / (1000 * 60 * 60 * 24)) + 1;

            if (days > 90) {
                alert('æœ€å¤§90æ—¥é–“ã¾ã§é¸æŠã§ãã¾ã™');
                return;
            }

            // ã‚«ã‚¹ã‚¿ãƒ æœŸé–“ã‚’é©ç”¨
            currentPeriods[chartNum] = days;

            // æœŸé–“ãƒœã‚¿ãƒ³ã®é¸æŠçŠ¶æ…‹ã‚’ãƒªã‚»ãƒƒãƒˆ
            const container = chartNum === 1 ? document.getElementById('chart-1') : document.getElementById('chart-2');
            container.querySelectorAll('.period-button').forEach(btn => {
                btn.classList.remove('active');
            });

            // ã‚«ã‚¹ã‚¿ãƒ æœŸé–“ã®UIã‚’é–‰ã˜ã‚‹
            document.getElementById(`custom-period-${chartNum}`).classList.add('hidden');

            // ã‚°ãƒ©ãƒ•ã‚’æ›´æ–°
            updateChart(chartNum);

            alert(`ã‚«ã‚¹ã‚¿ãƒ æœŸé–“ï¼ˆ${days}æ—¥é–“ï¼‰ã‚’é©ç”¨ã—ã¾ã—ãŸ`);
        }

        // ===== ãƒ‰ãƒªãƒ«ãƒ€ã‚¦ãƒ³ãƒ¢ãƒ¼ãƒ€ãƒ«æ©Ÿèƒ½ =====

        function showDrillDownModal(chartNum, index, label, value, metric) {
            // Chart2ã§æ¯”è¼ƒãƒ¢ãƒ¼ãƒ‰ã®å ´åˆã¯ã€chart2Categoryã‚’ä½¿ç”¨
            const categoryToUse = (chartNum === 2 && comparisonMode) ? chart2Category : currentSubCategory;

            // ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜
            const annotationKey = `${categoryToUse}_${label}`;
            currentDrillDownData = {
                chartNum,
                index,
                label,
                value,
                metric,
                annotationKey
            };

            // ãƒ©ãƒ™ãƒ«ã‹ã‚‰å®Ÿéš›ã®æ—¥ä»˜ã‚’è¨ˆç®—
            const daysAgo = parseInt(label.replace(/[^\d]/g, '')) || 0;
            const today = new Date();
            const targetDate = new Date(today);
            targetDate.setDate(today.getDate() - daysAgo);

            // æ—¥ä»˜ã‚’ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ (10/15å½¢å¼ ã¨ YYYY-MM-DDå½¢å¼)
            const dateString = `${targetDate.getMonth() + 1}/${targetDate.getDate()}`;
            const daysAgoString = daysAgo === 0 ? 'ä»Šæ—¥' : `${daysAgo}æ—¥å‰`;
            // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³ã§æ—¥ä»˜ã‚’å–å¾—
            const year = targetDate.getFullYear();
            const month = String(targetDate.getMonth() + 1).padStart(2, '0');
            const day = String(targetDate.getDate()).padStart(2, '0');
            const dateKey = `${year}-${month}-${day}`; // YYYY-MM-DDå½¢å¼

            // ãƒ¢ãƒ¼ãƒ€ãƒ«ã®å†…å®¹ã‚’æ›´æ–°
            document.getElementById('drilldown-title').textContent = `${dateString} (${daysAgoString})`;
            document.getElementById('drilldown-subtitle').textContent = `${metric.name}ã®ãƒ‡ãƒ¼ã‚¿`;
            document.getElementById('drilldown-metric').textContent = metric.name;

            // å€¤ã®è¡¨ç¤ºï¼ˆãƒã‚¤ãƒŠãƒªãƒ‡ãƒ¼ã‚¿ã®å ´åˆã¯å®Œäº†/æœªå®Œäº†ã«å¤‰æ›ï¼‰
            if (metric.isBinary) {
                document.getElementById('drilldown-value').textContent = value === 1 ? 'âœ… å®Œäº†' : 'âŒ æœªå®Œäº†';
            } else if (metric.getLabel && typeof value === 'number') {
                // æ®µéšèª¬æ˜ãŒã‚ã‚‹å ´åˆ
                document.getElementById('drilldown-value').textContent = metric.getLabel(value);
            } else {
                document.getElementById('drilldown-value').textContent = `${value.toFixed(1)} ${metric.unit}`;
            }

            // ãƒ¡ãƒ¢ã®è¡¨ç¤º
            if (annotations[annotationKey]) {
                document.getElementById('drilldown-memo-text').textContent = annotations[annotationKey].note;
                document.getElementById('drilldown-memo-display').classList.remove('hidden');
                document.getElementById('drilldown-memo-empty').classList.add('hidden');
                document.getElementById('memo-edit-button-text').textContent = 'ãƒ¡ãƒ¢ã‚’ç·¨é›†';
            } else {
                document.getElementById('drilldown-memo-display').classList.add('hidden');
                document.getElementById('drilldown-memo-empty').classList.remove('hidden');
                document.getElementById('memo-edit-button-text').textContent = 'ãƒ¡ãƒ¢ã‚’è¿½åŠ ';
            }

            // ç·¨é›†UIã‚’ãƒªã‚»ãƒƒãƒˆ
            document.getElementById('drilldown-memo-edit').classList.add('hidden');
            document.getElementById('drilldown-memo-input').value = annotations[annotationKey]?.note || '';

            // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
            const modal = document.getElementById('drilldown-modal');
            modal.classList.remove('hidden');

            // ã‚¢ã‚¤ã‚³ãƒ³ã‚’å†æç”»
            lucide.createIcons();
        }

        function closeDrillDownModal() {
            const modal = document.getElementById('drilldown-modal');
            modal.classList.add('hidden');

            // ç·¨é›†UIã‚’ãƒªã‚»ãƒƒãƒˆ
            document.getElementById('drilldown-memo-edit').classList.add('hidden');
        }

        function toggleMemoEdit() {
            const editDiv = document.getElementById('drilldown-memo-edit');
            editDiv.classList.toggle('hidden');

            // ã‚¢ã‚¤ã‚³ãƒ³ã‚’å†æç”»
            lucide.createIcons();
        }

        function saveMemo() {
            const noteText = document.getElementById('drilldown-memo-input').value.trim();

            if (!noteText) {
                alert('ãƒ¡ãƒ¢ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }

            // ã‚¢ãƒãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ä¿å­˜
            annotations[currentDrillDownData.annotationKey] = {
                note: noteText,
                value: currentDrillDownData.value,
                metric: currentDrillDownData.metric.name
            };

            // LocalStorageã«ä¿å­˜
            localStorage.setItem('history_v10_annotations', JSON.stringify(annotations));

            // UIã‚’æ›´æ–°
            document.getElementById('drilldown-memo-text').textContent = noteText;
            document.getElementById('drilldown-memo-display').classList.remove('hidden');
            document.getElementById('drilldown-memo-empty').classList.add('hidden');
            document.getElementById('memo-edit-button-text').textContent = 'ãƒ¡ãƒ¢ã‚’ç·¨é›†';
            document.getElementById('drilldown-memo-edit').classList.add('hidden');

            // ã‚°ãƒ©ãƒ•ã‚’æ›´æ–°ï¼ˆãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ—ã«ãƒ¡ãƒ¢ãŒè¡¨ç¤ºã•ã‚Œã‚‹ã‚ˆã†ã«ï¼‰
            updateChart(currentDrillDownData.chartNum);

            alert('ãƒ¡ãƒ¢ã‚’ä¿å­˜ã—ã¾ã—ãŸ');
        }

        function deleteMemo() {
            if (!confirm('ã“ã®ãƒ¡ãƒ¢ã‚’å‰Šé™¤ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹?')) {
                return;
            }

            // ã‚¢ãƒãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å‰Šé™¤
            delete annotations[currentDrillDownData.annotationKey];

            // LocalStorageã‚’æ›´æ–°
            localStorage.setItem('history_v10_annotations', JSON.stringify(annotations));

            // UIã‚’æ›´æ–°
            document.getElementById('drilldown-memo-display').classList.add('hidden');
            document.getElementById('drilldown-memo-empty').classList.remove('hidden');
            document.getElementById('memo-edit-button-text').textContent = 'ãƒ¡ãƒ¢ã‚’è¿½åŠ ';
            document.getElementById('drilldown-memo-edit').classList.add('hidden');
            document.getElementById('drilldown-memo-input').value = '';

            // ã‚°ãƒ©ãƒ•ã‚’æ›´æ–°
            updateChart(currentDrillDownData.chartNum);

            alert('ãƒ¡ãƒ¢ã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
        }

        // åˆæœŸè¡¨ç¤º
        async function init() {
            // DEV_MODEã®ç¢ºèª
            const isDevMode = typeof DEV_MODE !== 'undefined' && DEV_MODE;

            // ç¾åœ¨ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’å–å¾—
            if (isDevMode) {
                // DEV_MODE: LocalStorageã‚’ä½¿ç”¨
                window.currentUser = { uid: DEV_USER_ID || 'demo_user' };
            } else if (typeof firebase !== 'undefined' && firebase.auth) {
                // æœ¬ç•ªãƒ¢ãƒ¼ãƒ‰: Firebaseã‚’ä½¿ç”¨
                const user = firebase.auth().currentUser;
                if (user) {
                    window.currentUser = { uid: user.uid };
                }
            }

            loadGoals(); // ç›®æ¨™ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿
            loadAnnotations(); // ãƒ¡ãƒ¢ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿

            // å®Ÿãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã‚’è©¦è¡Œ
            if (typeof DataService !== 'undefined') {
                try {
                    allData = await loadRealData();
                    console.log('Real data loaded successfully');
                } catch (error) {
                    console.error('Failed to load real data:', error);
                }
            } else {
                console.warn('DataService is not available');
            }

            globalMinMax = calculateGlobalMinMax('lbm');
            updateChart(1);

            // åˆæœŸè¡¨ç¤ºã§ä¸€ç•ªå³ï¼ˆæœ€æ–°ï¼‰ã®ãƒ‡ãƒ¼ã‚¿ãƒã‚¤ãƒ³ãƒˆã‚’é¸æŠ
            setTimeout(() => {
                const chart = charts[1];
                if (chart && chart.data.labels.length > 0) {
                    const lastIndex = chart.data.labels.length - 1;
                    selectDataPoint(1, lastIndex);
                }
            }, 100);
        }

        // ãƒ‡ãƒ¼ã‚¿ãƒã‚¤ãƒ³ãƒˆé¸æŠæ©Ÿèƒ½
        function selectDataPoint(chartNum, index) {
            const chart = charts[chartNum];
            if (!chart || index < 0 || index >= chart.data.labels.length) return;

            selectedDataIndex[chartNum] = index;
            const categoryToUse = chartNum === 1 ? currentSubCategory : chart2Category;
            const unit = metricInfo[categoryToUse]?.unit || '';
            const value = chart.data.datasets[0].data[index];

            // æ—¥ä»˜æƒ…å ±ã‚’å–å¾—
            const today = new Date();
            const totalDays = chart.data.labels.length;
            const daysAgo = totalDays - 1 - index;
            const targetDate = new Date(today);
            targetDate.setDate(today.getDate() - daysAgo);
            const dateStr = `${targetDate.getMonth() + 1}/${targetDate.getDate()}`;

            let dateLabel;
            if (daysAgo === 0) {
                dateLabel = `${dateStr} (ä»Šæ—¥)`;
            } else if (daysAgo === 1) {
                dateLabel = `${dateStr} (1æ—¥å‰)`;
            } else {
                dateLabel = `${dateStr} (${daysAgo}æ—¥å‰)`;
            }

            // å€¤ã®ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
            let displayValue;
            const metric = metricInfo[categoryToUse];
            if (metric && metric.getLabel && typeof value === 'number') {
                // æ®µéšèª¬æ˜ãŒã‚ã‚‹å ´åˆ
                displayValue = metric.getLabel(value);
            } else if (typeof value === 'number') {
                displayValue = value % 1 === 0 ? value.toString() : value.toFixed(1);
            } else {
                displayValue = value || '-';
            }

            // UIã‚’æ›´æ–°
            document.getElementById(`selected-date-${chartNum}`).textContent = dateLabel;
            document.getElementById(`selected-value-${chartNum}`).innerHTML =
                `${displayValue}<span class="text-lg opacity-70 ml-1">${unit}</span>`;
            document.getElementById(`selected-point-${chartNum}`).classList.remove('hidden');

            // ãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ—ã‚’è¡¨ç¤º
            if (tooltipEnabled[chartNum]) {
                const meta = chart.getDatasetMeta(0);
                if (meta.data[index]) {
                    const element = meta.data[index];
                    chart.tooltip.setActiveElements([
                        {datasetIndex: 0, index: index}
                    ], {x: element.x, y: element.y});

                    // ã‚°ãƒ©ãƒ•ã‚’å†æç”»ã—ã¦ãƒªãƒ¼ãƒ‰ç·šã‚’æ›´æ–°
                    requestAnimationFrame(() => {
                        chart.draw();
                    });
                }
            }

            // ã‚¢ã‚¤ã‚³ãƒ³ã‚’å†æç”»
            lucide.createIcons();
        }

        // ãƒ‡ãƒ¼ã‚¿ãƒã‚¤ãƒ³ãƒˆãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³
        function navigateDataPoint(chartNum, direction) {
            const chart = charts[chartNum];
            if (!chart) return;

            const currentIndex = selectedDataIndex[chartNum];
            if (currentIndex === null) return;

            const newIndex = currentIndex + direction;
            if (newIndex >= 0 && newIndex < chart.data.labels.length) {
                selectDataPoint(chartNum, newIndex);

                // æœ€å¾Œã«ã‚¯ãƒªãƒƒã‚¯ã—ãŸä½ç½®ã‚’æ›´æ–°ï¼ˆãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ—è¡¨ç¤ºç”¨ï¼‰
                lastClickedIndex[chartNum] = newIndex;
                lastClickedChart = chartNum;
            }
        }

        // ãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ—ã®è¡¨ç¤º/éè¡¨ç¤ºã‚’åˆ‡ã‚Šæ›¿ãˆ
        let tooltipEnabled = { 1: false, 2: false };
        let lastClickedChart = null;
        let lastClickedIndex = { 1: null, 2: null };

        function toggleTooltip(chartNum) {
            const chart = charts[chartNum];
            if (!chart) return;

            // çŠ¶æ…‹ã‚’åˆ‡ã‚Šæ›¿ãˆ
            tooltipEnabled[chartNum] = !tooltipEnabled[chartNum];

            // Chart.jsã®ãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ—è¨­å®šã‚’æ›´æ–°
            chart.options.plugins.tooltip.enabled = tooltipEnabled[chartNum];

            // ãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ—ã‚’æœ‰åŠ¹åŒ–ã—ãŸå ´åˆã€æœ€å¾Œã«ã‚¯ãƒªãƒƒã‚¯ã—ãŸä½ç½®ã«è¡¨ç¤º
            if (tooltipEnabled[chartNum] && lastClickedIndex[chartNum] !== null) {
                const meta = chart.getDatasetMeta(0);
                if (meta.data[lastClickedIndex[chartNum]]) {
                    const element = meta.data[lastClickedIndex[chartNum]];
                    chart.tooltip.setActiveElements([
                        {datasetIndex: 0, index: lastClickedIndex[chartNum]}
                    ], {x: element.x, y: element.y});
                }
            }

            // ã‚°ãƒ©ãƒ•ã‚’å†æç”»
            requestAnimationFrame(() => {
                chart.draw();
            });

            // ãƒœã‚¿ãƒ³ã®ãƒ†ã‚­ã‚¹ãƒˆã¨ã‚¹ã‚¿ã‚¤ãƒ«ã‚’æ›´æ–°
            const button = document.getElementById(`tooltip-toggle-${chartNum}`);
            if (tooltipEnabled[chartNum]) {
                button.innerHTML = '<i data-lucide="eye-off" class="w-3 h-3 inline-block mr-1"></i>ãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ—ã‚’éè¡¨ç¤º';
                button.classList.remove('bg-gray-100', 'text-gray-700');
                button.classList.add('bg-purple-600', 'text-white');
            } else {
                button.innerHTML = '<i data-lucide="info" class="w-3 h-3 inline-block mr-1"></i>ãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ—ã‚’è¡¨ç¤º';
                button.classList.remove('bg-purple-600', 'text-white');
                button.classList.add('bg-gray-100', 'text-gray-700');
            }

            // ã‚¢ã‚¤ã‚³ãƒ³ã‚’å†æç”»
            lucide.createIcons();
        }

        // ========== å±¥æ­´åˆ†ææ©Ÿèƒ½ ==========

        // å±¥æ­´åˆ†æã®å®Ÿè¡Œ
        async function performHistoryAnalysis() {
            // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
            document.getElementById('history-analysis-loading-modal').classList.remove('hidden');

            try {
                // ç¾åœ¨è¡¨ç¤ºä¸­ã®æœŸé–“ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
                const days = currentPeriods[1];
                const report = await generateHistoryAnalysisReport(days);

                // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’éè¡¨ç¤º
                document.getElementById('history-analysis-loading-modal').classList.add('hidden');

                // ãƒ¬ãƒãƒ¼ãƒˆãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
                document.getElementById('history-analysis-period').textContent = `éå»${days}æ—¥é–“ã®åˆ†æ`;
                document.getElementById('history-analysis-report-content').innerHTML = report;
                document.getElementById('history-analysis-report-modal').classList.remove('hidden');

                // ã‚¢ã‚¤ã‚³ãƒ³ã‚’å†æç”»
                lucide.createIcons();
            } catch (error) {
                console.error('[å±¥æ­´åˆ†æ] ã‚¨ãƒ©ãƒ¼:', error);
                document.getElementById('history-analysis-loading-modal').classList.add('hidden');
                alert('åˆ†æä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚');
            }
        }

        // å±¥æ­´åˆ†æãƒ¬ãƒãƒ¼ãƒˆã®ç”Ÿæˆ
        async function generateHistoryAnalysisReport(days) {
            // æœŸé–“ãƒ‡ãƒ¼ã‚¿ã®é›†è¨ˆ
            const periodData = generateData(days);

            // å„é …ç›®ã®çµ±è¨ˆè¨ˆç®—
            const stats = {};
            const conditionLabels = {
                sleep_duration: ['', '5hä»¥ä¸‹', '6h', '7h', '8h', '9hä»¥ä¸Š'],
                sleep_quality: ['', 'æœ€æ‚ª', 'æ‚ª', 'æ™®é€š', 'è‰¯', 'æœ€é«˜'],
                appetite: ['', 'ãªã—', 'å°‘', 'æ™®é€š', 'è‰¯å¥½', 'æœ€é«˜'],
                gut_health: ['', 'ä¸èª¿', 'ã‚„ã‚„æ‚ª', 'æ™®é€š', 'è‰¯å¥½', 'æœ€é«˜'],
                focus: ['', 'æœ€ä½', 'ä½', 'æ™®é€š', 'é«˜', 'æœ€é«˜'],
                stress: ['', 'æ¥µå¤§', 'é«˜', 'æ™®é€š', 'ä½', 'ãªã—']
            };

            for (const key in periodData) {
                if (Array.isArray(periodData[key]) && periodData[key].length > 0) {
                    const validData = periodData[key].filter(v => typeof v === 'number' && !isNaN(v) && v > 0);
                    if (validData.length > 0) {
                        const sum = validData.reduce((a, b) => a + b, 0);
                        const avg = sum / validData.length;
                        const max = Math.max(...validData);
                        const min = Math.min(...validData);

                        stats[key] = {
                            avg: avg.toFixed(1),
                            max: max.toFixed(1),
                            min: min.toFixed(1),
                            count: validData.length,
                            avgLabel: conditionLabels[key] ? conditionLabels[key][Math.round(avg)] : null
                        };
                    }
                }
            }

            // ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã®å–å¾—ï¼ˆlocalStorageçµŒç”±ï¼‰
            const userProfileKey = typeof STORAGE_KEYS !== 'undefined' ? STORAGE_KEYS.USER_PROFILE : 'yourCoachBeta_userProfile';
            const userProfile = JSON.parse(localStorage.getItem(userProfileKey) || '{}');
            const currentPurpose = userProfile.purpose || 'ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹';
            const userStyle = userProfile.style || 'ä¸€èˆ¬';

            // ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆç”Ÿæˆ
            const prompt = `## å½¹å‰²

ãƒˆãƒƒãƒ—ã‚¢ã‚¹ãƒªãƒ¼ãƒˆæŒ‡å°ã®ã‚¨ãƒªãƒ¼ãƒˆãƒ‘ãƒ¼ã‚½ãƒŠãƒ«ã‚³ãƒ¼ãƒã¨ã—ã¦ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®éå»${days}æ—¥é–“ã®ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰å‚¾å‘ãƒ»ç›¸é–¢ãƒ»ç‰¹å¾´ã‚’åˆ†æã—ã€æ–°ãŸãªæ°—ã¥ãã‚’æä¾›ã—ã¾ã™ã€‚

## åˆ†æã®åŸºæœ¬åŸå‰‡

- **ç›®çš„**: ${currentPurpose}
- **ã‚¹ã‚¿ã‚¤ãƒ«**: ${userStyle}
- **æœŸé–“**: éå»${days}æ—¥é–“
- **é‡ç‚¹**: å„é …ç›®ã®ç›¸é–¢é–¢ä¿‚ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼å›ºæœ‰ã®å‚¾å‘ã€ç‰¹å¾´çš„ãªãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’ç™ºè¦‹

## æœŸé–“ãƒ‡ãƒ¼ã‚¿ï¼ˆéå»${days}æ—¥é–“ï¼‰

### æ „é¤Šã®æ¨ç§»
${stats.calories ? `- ã‚«ãƒ­ãƒªãƒ¼å¹³å‡: ${stats.calories.avg}kcalï¼ˆæœ€ä½${stats.calories.min}ï½æœ€é«˜${stats.calories.max}kcalï¼‰` : ''}
${stats.protein ? `- ã‚¿ãƒ³ãƒ‘ã‚¯è³ªå¹³å‡: ${stats.protein.avg}gï¼ˆæœ€ä½${stats.protein.min}ï½æœ€é«˜${stats.protein.max}gï¼‰` : ''}
${stats.fat ? `- è„‚è³ªå¹³å‡: ${stats.fat.avg}gï¼ˆæœ€ä½${stats.fat.min}ï½æœ€é«˜${stats.fat.max}gï¼‰` : ''}
${stats.carbs ? `- ç‚­æ°´åŒ–ç‰©å¹³å‡: ${stats.carbs.avg}gï¼ˆæœ€ä½${stats.carbs.min}ï½æœ€é«˜${stats.carbs.max}gï¼‰` : ''}

### é‹å‹•ã®æ¨ç§»
${stats.total_time ? `- ç·æ™‚é–“å¹³å‡: ${stats.total_time.avg}åˆ†ï¼ˆæœ€ä½${stats.total_time.min}ï½æœ€é«˜${stats.total_time.max}åˆ†ï¼‰` : ''}
${stats.total_exercises ? `- å®Ÿæ–½ç¨®ç›®æ•°å¹³å‡: ${stats.total_exercises.avg}ç¨®ç›®` : ''}
${stats.total_weight ? `- ç·é‡é‡å¹³å‡: ${stats.total_weight.avg}kg` : ''}

### ã‚³ãƒ³ãƒ‡ã‚£ã‚·ãƒ§ãƒ³ã®æ¨ç§»
${stats.sleep_duration ? `- ç¡çœ æ™‚é–“å¹³å‡: ${stats.sleep_duration.avgLabel || stats.sleep_duration.avg}` : ''}
${stats.sleep_quality ? `- ç¡çœ ã®è³ªå¹³å‡: ${stats.sleep_quality.avgLabel || stats.sleep_quality.avg}` : ''}
${stats.appetite ? `- é£Ÿæ¬²å¹³å‡: ${stats.appetite.avgLabel || stats.appetite.avg}` : ''}
${stats.gut_health ? `- è…¸å†…ç’°å¢ƒå¹³å‡: ${stats.gut_health.avgLabel || stats.gut_health.avg}` : ''}
${stats.focus ? `- é›†ä¸­åŠ›å¹³å‡: ${stats.focus.avgLabel || stats.focus.avg}` : ''}
${stats.stress ? `- ã‚¹ãƒˆãƒ¬ã‚¹å¹³å‡: ${stats.stress.avgLabel || stats.stress.avg}` : ''}

## å‡ºåŠ›å½¢å¼ï¼ˆå³å®ˆï¼‰

éå»${days}æ—¥é–“ã®åˆ†æãƒ¬ãƒãƒ¼ãƒˆã‚’ãŠå±Šã‘ã—ã¾ã™ã€‚

---

â‘  ç›¸é–¢é–¢ä¿‚ã®ç™ºè¦‹

**æ „é¤Š Ã— é‹å‹•**
[ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰è¦‹ã¤ã‹ã£ãŸç›¸é–¢ã‚’1-2æ–‡ã§å…·ä½“çš„ãªæ•°å€¤ã‚’ç¤ºã—ã¦èª¬æ˜]

**æ „é¤Š Ã— ã‚³ãƒ³ãƒ‡ã‚£ã‚·ãƒ§ãƒ³**
[ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰è¦‹ã¤ã‹ã£ãŸç›¸é–¢ã‚’1-2æ–‡ã§å…·ä½“çš„ãªæ•°å€¤ã‚’ç¤ºã—ã¦èª¬æ˜]

**é‹å‹• Ã— ã‚³ãƒ³ãƒ‡ã‚£ã‚·ãƒ§ãƒ³**
[ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰è¦‹ã¤ã‹ã£ãŸç›¸é–¢ã‚’1-2æ–‡ã§å…·ä½“çš„ãªæ•°å€¤ã‚’ç¤ºã—ã¦èª¬æ˜]

---

â‘¡ ã‚ãªãŸã®å‚¾å‘

**æ „é¤Šã®å‚¾å‘**
[æœŸé–“å…¨ä½“ã§ã®æ „é¤Šæ‘‚å–ã®ç‰¹å¾´ã‚’1-2æ–‡ã§å…·ä½“çš„ãªæ•°å€¤ã‚’ç¤ºã—ã¦èª¬æ˜]

**é‹å‹•ã®å‚¾å‘**
[æœŸé–“å…¨ä½“ã§ã®é‹å‹•å®Ÿæ–½ã®ç‰¹å¾´ã‚’1-2æ–‡ã§å…·ä½“çš„ãªæ•°å€¤ã‚’ç¤ºã—ã¦èª¬æ˜]

**ã‚³ãƒ³ãƒ‡ã‚£ã‚·ãƒ§ãƒ³ã®å‚¾å‘**
[æœŸé–“å…¨ä½“ã§ã®ã‚³ãƒ³ãƒ‡ã‚£ã‚·ãƒ§ãƒ³ã®ç‰¹å¾´ã‚’1-2æ–‡ã§å…·ä½“çš„ãªæ•°å€¤ã‚’ç¤ºã—ã¦èª¬æ˜]

---

â‘¢ ç‰¹å¾´çš„ãªãƒ‘ã‚¿ãƒ¼ãƒ³

[ãƒ¦ãƒ¼ã‚¶ãƒ¼å›ºæœ‰ã®ç‰¹å¾´ã‚’ç®‡æ¡æ›¸ãã§2-3å€‹]
- [ãƒ‘ã‚¿ãƒ¼ãƒ³1ï¼šãƒ‡ãƒ¼ã‚¿ã«åŸºã¥ã„ãŸç™ºè¦‹]
- [ãƒ‘ã‚¿ãƒ¼ãƒ³2ï¼šãƒ‡ãƒ¼ã‚¿ã«åŸºã¥ã„ãŸç™ºè¦‹]

---

â‘£ æ–°ãŸãªæ°—ã¥ã

[ä¸Šè¨˜ã®åˆ†æã‹ã‚‰ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæ°—ã¥ã„ã¦ã„ãªã‹ã£ãŸå¯èƒ½æ€§ã®ã‚ã‚‹ç™ºè¦‹ã‚’2-3æ–‡ã§æç¤º]

---

ãƒ«ãƒ¼ãƒ«:
- æ•°å€¤ã¯å¿…ãšå…·ä½“çš„ã«ç¤ºã™
- ã€Œè‰¯ã„ã€ã€Œæ‚ªã„ã€ç­‰ã®æŠ½è±¡è¡¨ç¾ç¦æ­¢
- ãƒ‡ãƒ¼ã‚¿ã«åŸºã¥ã„ãŸäº‹å®Ÿã®ã¿è¨˜è¼‰
- æ”¹å–„æŒ‡ç¤ºã¯ä¸è¦ï¼ˆæ°—ã¥ãã®æä¾›ã®ã¿ï¼‰
- ãƒªã‚¹ãƒˆè¡¨è¨˜ã¯ã€Œ-ã€ã‚’ä½¿ç”¨
- å‚è€ƒæ–‡çŒ®ãƒ»æ³¨é‡ˆç¦æ­¢
- **å¤ªå­—**ã¯è¦‹å‡ºã—ã‚„å¼·èª¿ã§ä½¿ç”¨å¯èƒ½`;

            // Gemini APIã«ãƒªã‚¯ã‚¨ã‚¹ãƒˆ
            const apiKey = typeof GEMINI_API_KEY !== 'undefined' ? GEMINI_API_KEY : '';
            const apiUrl = 'https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash-exp:generateContent';

            const response = await fetch(`${apiUrl}?key=${apiKey}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    contents: [{
                        parts: [{ text: prompt }]
                    }]
                })
            });

            const data = await response.json();
            const reportText = data.candidates[0].content.parts[0].text;

            // Markdownã‚’ç°¡æ˜“HTMLå¤‰æ›
            let html = reportText
                .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
                .replace(/^---$/gm, '<hr class="my-4">')
                .replace(/^â‘  (.+)$/gm, '<h3 class="text-xl font-bold text-purple-700 mt-6 mb-3">â‘  $1</h3>')
                .replace(/^â‘¡ (.+)$/gm, '<h3 class="text-xl font-bold text-purple-700 mt-6 mb-3">â‘¡ $1</h3>')
                .replace(/^â‘¢ (.+)$/gm, '<h3 class="text-xl font-bold text-purple-700 mt-6 mb-3">â‘¢ $1</h3>')
                .replace(/^â‘£ (.+)$/gm, '<h3 class="text-xl font-bold text-purple-700 mt-6 mb-3">â‘£ $1</h3>')
                .replace(/^- (.+)$/gm, '<li class="ml-4">$1</li>')
                .replace(/\n\n/g, '</p><p class="mb-3">')
                .replace(/^(.+)$/gm, '<p class="mb-3">$1</p>');

            return html;
        }

        // å±¥æ­´åˆ†æãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
        function closeHistoryAnalysisModal() {
            document.getElementById('history-analysis-report-modal').classList.add('hidden');
            document.getElementById('history-analysis-answer').classList.add('hidden');
            document.getElementById('history-analysis-question-input').value = '';
        }

        // å±¥æ­´åˆ†æã¸ã®è³ªå•
        async function askHistoryAnalysisQuestion() {
            const questionInput = document.getElementById('history-analysis-question-input');
            const question = questionInput.value.trim();

            if (!question) {
                alert('è³ªå•ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }

            // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º
            const answerDiv = document.getElementById('history-analysis-answer');
            const answerText = document.getElementById('history-analysis-answer-text');
            answerDiv.classList.remove('hidden');
            answerText.textContent = 'å›ç­”ã‚’ç”Ÿæˆä¸­...';

            try {
                const days = currentPeriods[1];
                const periodData = generateData(days);

                // çµ±è¨ˆãƒ‡ãƒ¼ã‚¿ã‚’ç°¡æ½”ã«ã¾ã¨ã‚ã‚‹
                const summaryStats = {};
                for (const key in periodData) {
                    if (Array.isArray(periodData[key]) && periodData[key].length > 0) {
                        const validData = periodData[key].filter(v => typeof v === 'number' && !isNaN(v) && v > 0);
                        if (validData.length > 0) {
                            const sum = validData.reduce((a, b) => a + b, 0);
                            const avg = sum / validData.length;
                            summaryStats[key] = avg.toFixed(1);
                        }
                    }
                }

                const prompt = `ã‚ãªãŸã¯éå»${days}æ—¥é–“ã®ãƒ‡ãƒ¼ã‚¿ã‚’åˆ†æã—ãŸã‚³ãƒ¼ãƒã§ã™ã€‚

ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®è³ªå•: ${question}

ä»¥ä¸‹ã®ãƒ‡ãƒ¼ã‚¿ã‚’å‚è€ƒã«ã€å…·ä½“çš„ãªæ•°å€¤ã‚’ç¤ºã—ã¦å›ç­”ã—ã¦ãã ã•ã„ã€‚

æœŸé–“ãƒ‡ãƒ¼ã‚¿ï¼ˆå¹³å‡å€¤ï¼‰:
${JSON.stringify(summaryStats, null, 2)}

å›ç­”ã¯ç°¡æ½”ã«1-2æ–‡ã§ã€‚ãƒ‡ãƒ¼ã‚¿ã«åŸºã¥ã„ãŸäº‹å®Ÿã®ã¿è¨˜è¼‰ã—ã¦ãã ã•ã„ã€‚`;

                const apiKey = typeof GEMINI_API_KEY !== 'undefined' ? GEMINI_API_KEY : '';
                const apiUrl = 'https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash-exp:generateContent';

                const response = await fetch(`${apiUrl}?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{
                            parts: [{ text: prompt }]
                        }]
                    })
                });

                const data = await response.json();
                const answer = data.candidates[0].content.parts[0].text;

                answerText.textContent = answer;
                questionInput.value = '';
            } catch (error) {
                console.error('[å±¥æ­´åˆ†æè³ªå•] ã‚¨ãƒ©ãƒ¼:', error);
                answerText.textContent = 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚';
            }
        }

        init();
    </script>
</body>
</html>
