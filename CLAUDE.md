# Your Coach+ プロジェクト設定

## プロジェクト概要

Your Coach+は、React 18とFirebaseを使用したフィットネスコーチングアプリケーションです。
食事管理、トレーニング記録、コンディション記録などの機能を提供します。

## 技術スタック

- **フロントエンド**: React 18（CDN版）
- **バックエンド**: Firebase（Auth, Firestore, Storage）
- **AI**: Google Gemini API
- **スタイリング**: Tailwind CSS（CDN）
- **アイコン**: Lucide Icons（CDN）

## ファイル構造

```
C:\Users\yourc\yourcoach_new\
├── index.html              # メインHTMLファイル
├── styles.css              # カスタムCSS（ダークモード対応）
├── styles_dark.css         # ダークモードスタイル
├── config.js               # Firebase設定とアプリ設定
├── utils.js                # ユーティリティ関数
├── services.js             # サービス層（DB、AI）
├── components.js           # Reactコンポーネント（統合版）
├── foodDatabase.js         # 食品データベース
├── trainingDatabase.js     # トレーニングデータベース
└── firebase.json           # Firebase Hosting設定
```

## 開発コマンド

### ローカル開発サーバー
```bash
python -m http.server 8000
# ブラウザで http://localhost:8000 を開く
```

### Firebaseデプロイ
```bash
firebase deploy
```

### キャッシュクリア（開発用）
ブラウザで `clear_cache.html` を開く

### キャッシュバスターの更新（必須）

**重要:** コンポーネントファイルを編集した後、ブラウザに変更を反映させるには**必ず**キャッシュバスターを更新してください。

#### キャッシュバスターとは
index.htmlで読み込まれるJavaScriptファイルのURLに付与されているバージョン番号（例: `?v=20251028v1`）のこと。この値を変更することで、ブラウザに新しいファイルを強制的に読み込ませることができます。

#### 更新手順

1. **編集したファイル名を確認**
   - 例: `components/07_add_item_v2.js` を編集した場合

2. **index.htmlを開く**

3. **該当ファイルの読み込み行を検索**
   ```html
   <script type="text/babel" src="components/07_add_item_v2.js?v=20251025v11"></script>
   ```

4. **キャッシュバスターを更新**
   - フォーマット: `YYYYMMDD + v + 連番`
   - 例: `20251028v1` → `20251028v2`（同日2回目の更新の場合）
   - 例: `20251025v11` → `20251028v1`（日付が変わった場合は連番をリセット）
   ```html
   <script type="text/babel" src="components/07_add_item_v2.js?v=20251028v1"></script>
   ```

5. **ブラウザでスーパーリロード**
   - Windows: `Ctrl + Shift + R` または `Ctrl + F5`
   - Mac: `Cmd + Shift + R`

6. **動作確認**
   - F12でコンソールを開き、エラーがないことを確認
   - 実装した機能が正しく動作することを確認

#### 更新が必要なケース
- ✅ コンポーネントファイル（components/*.js）を編集した場合
- ✅ services.js、utils.js、config.jsを編集した場合
- ✅ styles.css、styles_dark.cssを編集した場合
- ❌ データベースファイル（foodDatabase.js、trainingDatabase.js）は通常キャッシュバスター不要

#### トラブルシューティング
**問題:** キャッシュバスターを更新したのに変更が反映されない

**対策:**
1. ブラウザのキャッシュを完全にクリア（設定 → プライバシーとセキュリティ → 閲覧データを削除）
2. シークレットモードで開く
3. `clear_cache.html` を開く

### ERR_CONNECTION_REFUSED エラーの対策

**問題:** ブラウザで `http://localhost:8000` にアクセスすると `ERR_CONNECTION_REFUSED` エラーが表示される

**原因と対策:**

#### 1. サーバーが起動していない
```bash
# サーバーを起動
python -m http.server 8000
```

#### 2. ポート8000が既に使用されている
```bash
# Windowsでポート8000を使用しているプロセスを確認
netstat -ano | findstr :8000

# プロセスIDが表示されたら、タスクマネージャーで終了するか以下のコマンドで終了
# taskkill /PID [プロセスID] /F
```

#### 3. サーバーがバックグラウンドで起動しているが応答しない
```bash
# すべてのPythonプロセスを終了（注意：他のPythonプログラムも終了します）
taskkill /IM python.exe /F

# サーバーを再起動
python -m http.server 8000
```

#### 4. 代替ポートで起動（ポート8000が解放できない場合）
```bash
# ポート8080で起動
python -m http.server 8080

# ブラウザで http://localhost:8080 を開く
```

**推奨フロー:**
1. まずポート8000の使用状況を確認: `netstat -ano | findstr :8000`
2. 使用中なら強制終了: `taskkill /IM python.exe /F`
3. サーバーを起動: `python -m http.server 8000`
4. ブラウザで確認: `http://localhost:8000`

## 🚨 作業フロー（必須）

### 1. 初回チャット開始時：ローカルサーバーを起動

**必ず最初に実行:**
```bash
python -m http.server 8000
```

**理由:** 毎回初回接続でエラーが発生するため、チャット開始直後にサーバーを起動すること。

### 2. 実装完了後：セルフエラーチェック

**実装後、必ず以下を実行:**
1. ブラウザで http://localhost:8000 を開く
2. F12を押してコンソールを開く
3. 構文エラー（SyntaxError）がないことを確認
4. エラーがなければユーザーに報告
5. エラーがあれば修正してから報告

**確認項目:**
- ✅ コンソールに赤いエラーが表示されていないか
- ✅ 画面が正しく表示されているか
- ✅ ボタンがクリックできるか

### 3. デプロイ：指示されたタイミングのみ

**重要:** ユーザーが明示的に「デプロイして」と指示した場合のみ実行すること。

```bash
firebase deploy --only hosting
```

**禁止事項:**
- ❌ 勝手にデプロイしない
- ❌ 実装完了＝デプロイではない
- ❌ ユーザーの確認を待たずにデプロイしない

### 4. Git更新（バックアップ）：3時間に1回確認

**重要:** 3時間ごとにユーザーに確認し、承認を得てから実行すること。

**確認フォーマット:**
```
🕐 3時間が経過しました

Git更新（バックアップ）を実行しますか？
- 変更ファイル: [ファイル一覧]
- 変更内容: [変更の概要]

承認いただければコミットします。
```

**実行コマンド（承認後）:**
```bash
git add .
git commit -m "チャット内容の説明"
```

**100%遵守事項:**
- ❌ 勝手にGit更新しない
- ❌ 3時間経過しても確認なしで実行しない
- ✅ 必ずユーザーの承認を得てから実行
- ✅ Git更新 = バックアップ + バージョン管理

## コーディング規約

### JavaScript
- **モジュール形式**: ES Modules不使用（CDN版Reactのため）
- **命名規則**:
  - コンポーネント: PascalCase（例: `DashboardView`）
  - 関数: camelCase（例: `getFoodDB`）
  - 定数: UPPER_SNAKE_CASE（例: `DEV_MODE`）
- **React Hooks**:
  - `useState`, `useEffect`, `useCallback`, `useMemo`を適切に使用
  - 依存配列を必ず指定

### CSS
- **主要スタイル**: Tailwind CSSのユーティリティクラスを使用
- **カスタムCSS**: `styles.css`に定義
- **ダークモード**: `dark:`プレフィックスまたは`styles_dark.css`を使用
- **レスポンシブ**: モバイルファーストで設計

### コンポーネント設計
- **単一責任の原則**: 各コンポーネントは1つの機能に集中
- **Props**: 明確な命名とデフォルト値の設定
- **State管理**: ローカルstateは最小限に、必要に応じてグローバル化

## プロジェクトの主要機能

### 認証（components_auth.js）
- Email/Password認証
- Google認証
- オンボーディングフロー（3ステップ）

### ダッシュボード（components_dashboard.js）
- 日次記録の表示
- 食事、トレーニング、サプリ、コンディションの一覧
- カロリー・PFCバランスの表示

### 入力機能（components/07_add_item.js）
- 体組成入力（体重、体脂肪率）
- 食事入力（検索、カスタム、写真解析）
- 運動入力（検索、カスタム）
- コンディション入力（睡眠時間、睡眠の質、食欲、腸内環境、集中力、ストレス）

#### 食事・サプリメント入力の仕様
- **選択画面**: 「どうやって記録しますか？」で3つの選択肢を表示
  1. **写真から記録** (黒背景) - AI食事認識機能
  2. **食材を検索** (白背景、グレー枠) - データベース検索
  3. **手動で作成** (白背景、グレー枠) - カスタム入力
- **検索モーダル**: 食材/サプリメントタブで切り替え可能、カテゴリは常に展開表示
- **テンプレート**: 選択画面の下に表示（12日以上利用で開放）

### 分析機能（components_analysis.js）
- AI搭載のPFC分析
- カレンダービュー
- 履歴グラフ・トレンド

### コミュニティ（components_community.js）
- 投稿の作成・閲覧
- いいね・コメント機能
- 管理者パネル（投稿承認）

### 設定（components_settings.js）
- プロフィール管理
- ルーティン設定
- テンプレート管理

## データ構造

### Firestore Collections
- `users/{userId}` - ユーザープロフィール
- `users/{userId}/dailyRecords/{date}` - 日次記録
- `users/{userId}/favorites` - お気に入り
- `users/{userId}/routines` - ルーティン
- `community/posts` - コミュニティ投稿

### LocalStorage（DEV_MODE=true時）
- `currentUser` - 現在のユーザー情報
- `dailyRecords_${userId}` - 日次記録
- `favorites_${userId}` - お気に入り
- `routines_${userId}` - ルーティン

## 開発フロー

### 新機能の追加
1. 関連ファイルを確認（README.mdのファイル対応表を参照）
2. 該当するcomponentsファイルまたはservices.jsを編集
3. ブラウザで動作確認（F12でコンソールエラーをチェック）
4. 変更をコミット

### バグ修正
1. ブラウザのコンソール（F12）でエラーを確認
2. 該当するファイルを特定
3. 修正を実施
4. 動作確認
5. 変更をコミット

### テスト
- **手動テスト**: ブラウザで各機能を実際に操作
- **DEV_MODE**: `config.js`で`DEV_MODE=true`に設定すると、Firebaseを使わずにLocalStorageでテスト可能
- **エラー確認**: 必ずブラウザのコンソール（F12）でエラーをチェック

## トラブルシューティング

### コンポーネントが表示されない
1. ブラウザのコンソール（F12）を開いてエラーを確認
2. 全てのJSファイルが正しく読み込まれているか確認
3. React/ReactDOMのCDNが正しく読み込まれているか確認

### Firebase接続エラー
- `config.js`のFirebase設定が正しいか確認
- Firebase Consoleでプロジェクトが有効か確認

### データが保存されない
- `config.js`で`DEV_MODE`の設定を確認
- `DEV_MODE=true`: LocalStorage使用
- `DEV_MODE=false`: Firebase使用

### スタイルが適用されない
- `styles.css`が正しく読み込まれているか確認
- Tailwind CSSのCDNが正しく読み込まれているか確認
- ブラウザのキャッシュをクリア

## 重要な注意事項

### UI/UX重要事項

#### BAB（Bottom Action Bar）について
- **正しい定義**: BABは画面下部の「ホーム、履歴、PGBASE、COMY、設定」のタブバーのこと
- **絶対に「FAB」と呼ばない**: FAB（Floating Action Button）は削除済みで存在しない
- **BABの実装**: `components/08_app.js`の2096行目から実装されている
- **BABの構造**:
  - クラス: `fixed bottom-0 left-0 right-0 z-[9999] bg-white border-t shadow-lg`
  - 折りたたみボタン（ChevronUp/ChevronDown）で展開/格納を切り替え
  - `bottomBarExpanded`状態で展開時はメニューが表示される
  - 格納時の高さ: 約40px
  - 展開時の高さ: 約120-150px（メニュー内容により変動）
- **BABとの干渉回避**:
  - 固定配置のUI要素（入力欄など）は、`position: fixed; bottom: ${babHeight}px`でBABの高さに応じて位置を動的に調整する
  - ResizeObserverでBABの高さ変化を監視し、即時連動させる
  - スクロールコンテナには下部に`padding-bottom: ${babHeight + 余白}px`を確保する

#### シェブロンショートカットについて
- **BABとは別物**: 画面左右の端にある展開式ショートカットメニュー
- **実装**: `components/17_chevron_shortcut.js`に実装されている
- **位置**: 画面左右の端（`top-[85%]`の位置）にシェブロンボタンがあり、クリックで展開

### セキュリティ
- **APIキー**: `config.js`の機密情報は公開リポジトリにコミットしない
- **Firebase Rules**: Firestoreセキュリティルールを適切に設定
- **認証**: 全ての機密操作は認証済みユーザーのみに制限

### パフォーマンス
- **画像最適化**: アップロード画像は適切なサイズに圧縮
- **データ取得**: 必要なデータのみを取得（無駄なクエリを避ける）
- **キャッシュ**: 頻繁にアクセスするデータはキャッシュを活用

### メンテナンス
- **バックアップ**: 作業経過3時間で必ずバックアップを作成するように提案
- **バージョン管理**: 会話圧縮後、最優先でGitにコミット
- **ドキュメント**: 大きな変更時はREADME.mdも更新

## AI（Claude Code）への指示

### 🚨🚨🚨 最重要：解釈確認を100%実施すること 🚨🚨🚨

**【絶対厳守】すべての実装を開始する前に、必ず以下の形式で解釈を提示し、ユーザーの承認を得ること**

この解釈確認フローは**例外なく100%実施**すること。どんなに簡単に見える指示でも、必ず解釈確認を行う。解釈確認を怠ると、ユーザーの意図とは異なる実装をしてしまい、修正作業が増えてしまう。

```
## 指示内容の解釈確認

【ご指示】
[ユーザーの指示を引用]

【私の解釈】
1. [解釈1]
2. [解釈2]
...

【実装内容】
- **ファイル1**: [ファイル名]
  - [変更点1]
  - [変更点2]
- **ファイル2**: [ファイル名]
  - [変更点]

この解釈で実装してよろしいでしょうか？
```

**【重要】承認を得るまで実装を開始しないこと。解釈確認なしに実装を開始した場合、ユーザーの信頼を失う。**

### コード修正時
- 変更前に必ず該当ファイルを読み込んで現在の実装を確認
- 大きな変更の場合は、変更前のバックアップを作成するよう確認し、承認後に実行
- 変更後は必ずブラウザで動作確認
- **重要**: ユーザーから明示的な削除指示がない限り、既存のコードや機能を削除しない

### 新機能追加時
- **まず実装方針の解釈を提示し、承認を得てから実装**（必須）
- 関連する既存コードを確認し、スタイルを統一
- 必要に応じてREADME.mdも更新

### デバッグ時
- エラーメッセージを詳細に分析
- 該当箇所のコードを読み込んで問題を特定
- 修正案を複数提示（可能な場合）

### UI/UXデザイン変更時
- ユーザーが提示した画像やデザインを忠実に再現
- **デザインの変更は必ずユーザーの承認を得てから実施**（必須）
- 既存のデザインを変更する場合は、変更前の状態を確認して記録
- **絶対に勝手に削除しない**: 機能やコンポーネントの削除は必ずユーザーの明示的な指示を待つ

## 実装報告のフォーマット

実装完了時は、以下のフォーマットで報告してください。

### 報告テンプレート

```markdown
## 実装完了報告

### セッション情報（必須）
- **トークン使用量**: XX,XXX / 200,000 トークン
- **使用率**: XX%
- **経過時間**: XX分
- **使用クレジット**: XX クレジット

### 実装内容

[実装した機能の概要]

### 変更ファイル

1. **ファイル名**: `components/XX_xxx.js`
   - **変更場所**: Line XXX-YYY
   - **変更内容**: [何をどう変更したか]
   - **キャッシュバスター**: ?v=YYYYMMDDVN

2. **ファイル名**: `components/YY_yyy.js`
   - **変更場所**: Line ZZZ
   - **変更内容**: [何をどう変更したか]
   - **キャッシュバスター**: ?v=YYYYMMDDVN

### 確認方法

**場所**: [設定 → データ管理] など、機能にアクセスする具体的な場所

**手順**:
1. [確認手順1]
2. [確認手順2]
3. [確認手順3]

**期待される動作**:
- ✅ [期待される動作1]
- ✅ [期待される動作2]

### ブラウザ確認

- コンソールエラー: [あり/なし]
- 動作確認: [完了/未完了]
```

### 報告例

```markdown
## 実装完了報告

### セッション情報（必須）
- **トークン使用量**: 45,230 / 200,000 トークン
- **使用率**: 22.6%
- **経過時間**: 15分
- **使用クレジット**: 0.5 クレジット

### 実装内容

カスタムアイテム（食材・料理・サプリ）の管理機能を実装しました。

### 変更ファイル

1. **ファイル名**: `components/07_add_item_v2.js`
   - **変更場所**: Line 3956-3958 (category自動設定), Line 2925-2931 (カスタムサプリ表示), Line 3440 (カスタム判定)
   - **変更内容**:
     - itemTypeに応じてcategoryを自動設定（カスタム食材/カスタム料理/カスタムサプリ）
     - 検索モーダルでカスタムサプリを表示するロジックを追加
     - カスタムアイテム判定にカスタムサプリを追加
   - **キャッシュバスター**: ?v=20251028v6

2. **ファイル名**: `components/04_settings.js`
   - **変更場所**: Line 2510-2725 (データ管理セクション内に追加)
   - **変更内容**: データ管理セクション内にカスタムアイテム管理UIを追加（3タブ：食材/料理/サプリ）
   - **キャッシュバスター**: ?v=20251028v2

### 確認方法

**場所**: 設定（右下タブ）→ データ管理セクションを展開

**手順**:
1. 設定画面を開く
2. 「データ管理」セクションをクリックして展開
3. 「カスタムアイテム管理」が表示されることを確認
4. 食材/料理/サプリのタブが表示されることを確認
5. カスタムアイテムがある場合、一覧が表示されることを確認
6. 編集・削除ボタンが表示されることを確認

**期待される動作**:
- ✅ データ管理セクション内にカスタムアイテム管理が表示される
- ✅ 3つのタブ（食材・料理・サプリ）が正しく切り替わる
- ✅ 各タブに該当するアイテムのみが表示される
- ✅ 「すべて削除」ボタンでカテゴリ単位の削除ができる
- ✅ 個別の編集・削除ボタンが機能する

### ブラウザ確認

- コンソールエラー: なし
- 動作確認: 完了
```

### 重要なポイント

1. **セッション情報を必ず報告**: トークン使用量・使用率・経過時間・使用クレジットを明記
2. **変更場所を明記**: 行番号を必ず記載する
3. **キャッシュバスターを必ず更新**: 変更したすべてのファイルのキャッシュバスターを明記
4. **確認方法を具体的に**: ユーザーが実際に確認できる手順を記載
5. **期待される動作を列挙**: チェックリスト形式で明確に

## 今後の改善予定

1. **モジュール化**: components.jsのさらなる分割
2. **ビルドツール**: Vite/Webpackの導入
3. **TypeScript化**: 型安全性の向上
4. **テスト**: Jest + React Testing Libraryの導入
5. **パフォーマンス**: Code splitting, Lazy loading

---

**最終更新**: 2025年10月28日
**プロジェクト開始**: 2025年10月12日
