# 作業記録 2026-01-30

## 本日の実装内容

### 1. タンパク質係数スライダー
- **変更内容**: 「一般」オプション削除、LBM×2.0〜3.0のスライダーに変更
- **変更ファイル**:
  - `ProfileSettingsScreen.kt` - スライダーUI実装
  - `User.kt` - `proteinCoefficient` フィールド追加

### 2. 白米・玄米の炊飯後対応
- **変更内容**: dbSearchKeyを炊飯後バージョンに修正
- **変更ファイル**:
  - `BodymakingFood.kt`:
    - 白米: `"精白米"` → `"白米（冷やご飯・再加熱）"`
    - 玄米: `"玄米"` → `"玄米（炊飯後）"`

### 3. あんこ追加
- **変更内容**: Tier1高GIカーボとして追加
- **変更ファイル**:
  - `FoodDatabase.kt` - 栄養データ追加（239kcal, P5.6g, F0.4g, C54g, GI78）
  - `BodymakingFood.kt` - Tier1に追加

### 4. 木綿豆腐削除
- **変更ファイル**: `BodymakingFood.kt` から削除

### 5. 高GI/ホエイプロテインの表示条件
- **変更内容**: リアルフード優先時は非表示、サプリ/コンビニ時のみ表示
- **変更ファイル**:
  - `AnalysisViewModel.kt`:
    - `FoodChoice` に応じて `hasSupplementOrConvenience` 判定
    - 高GIカーボ、ホエイプロテインの条件付き表示

### 6. 水溶性・不溶性繊維の対応
- **問題**: 食物繊維の総量は集計されるが、水溶性・不溶性が常に0
- **原因**: MealItem作成/保存/読込時に `solubleFiber/insolubleFiber` が欠落
- **変更ファイル**:
  - `FirestoreMealRepository.kt` - `itemToMap()`, `mapToItem()` に追加
  - `DashboardViewModel.kt` - `createMealItemFromFood()` に追加
  - `MealViewModel.kt` - `addRecognizedFoods()` に追加

### 7. AI分析プロンプト改善
- **変更ファイル**: `AnalysisViewModel.kt`
- **追加ルール**:
  - トレ前後の脂質は5g以内
  - 野菜のPFCも必ず計算に含める
  - 1食のC配分が過剰な場合はトレ前・トレ後に分割
  - 高GIカーボは餅・バナナ・あんこから選択（白米は使用しない）
  - ホエイプロテインは餅・バナナ・あんこと組み合わせる
  - マクロ不足時は「補助食材」セクションを追加

---

## 最終ティア設計（ミクロ最適化）

### P源（B群・セレン・亜鉛）
- Tier1: 鶏むね肉、全卵
- Tier2: 鶏もも、豚ロース、鮭、サバ缶、ツナ缶、マグロ、イカ、エビ
- Tier3: 牛ヒレ、牛もも、サーモン

### F源（脂肪酸バランス・E・Mg）
- Tier1: 全卵、納豆
- Tier2: オリーブオイル、アーモンド、くるみ
- Tier3: MCTオイル、マカダミアナッツ、アボカド

### C源（食物繊維・B1・Mg）
- 高GI（サプリ/コンビニ時のみ）: 餅、バナナ、あんこ
- Tier1低〜中GI: 白米（冷やご飯）、玄米
- Tier2低〜中GI: オートミール、そば

### 野菜（ビタミン・ミネラル・食物繊維）
- Tier1: キャベツ、もやし、玉ねぎ、にんじん、じゃがいも
- Tier2: ブロッコリー、ほうれん草、トマト、きのこ類
- Tier3: ケール

---

## 実機確認待ちの項目

1. **プロテイン係数スライダー** - 保存・反映されるか
2. **水溶性・不溶性繊維** - ダッシュボードで正しく表示されるか
3. **AI分析の食材提案** - ルール通りに出力されるか
4. **マクロ超過問題** - 野菜PFC考慮で改善されたか

---

## デバッグAPK場所
```
ycn_native/androidApp/build/outputs/apk/debug/androidApp-debug.apk
```

---

## 明日の続行方法

```bash
# Claude Code起動後
cd C:\Users\yourc\ycn_re

# 状況確認
git status

# ネイティブアプリビルド
export JAVA_HOME="/c/Program Files/Android/Android Studio/jbr"
cd ycn_native
./gradlew :androidApp:assembleDebug
```

---

## 技術メモ

### FoodChoice による高GI表示制御
```kotlin
val hasSupplementOrConvenience = profile?.mealSlotConfig?.slots?.any { slot ->
    slot.defaultFoodChoice == FoodChoice.SUPPLEMENT ||
    slot.defaultFoodChoice == FoodChoice.CONVENIENCE
} ?: false
```

### トレ前後ルール
- 脂質5g以内（吸収速度優先）
- 高GIカーボ推奨だが、1日の目標Cに対して適切な量を配分
- C配分過剰時はトレ前・トレ後に分割
