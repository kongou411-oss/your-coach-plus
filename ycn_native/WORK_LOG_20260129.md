# 作業記録 2026-01-29

## 本日の実装内容

### 1. 休養日チェックボックス（ダッシュボード）
- **場所**: 運動セクションヘッダー
- **機能**: 手動で休養日を設定可能（ルーティンパターンとは独立）
- **変更ファイル**:
  - `DashboardViewModel.kt` - `isManualRestDay`, `toggleRestDay()` 追加
  - `DashboardScreen.kt` - WorkoutListSection にチェックボックスUI追加
  - `ScoreRepository.kt` - `updateRestDayStatus()`, `getRestDayStatus()` 追加
  - `FirestoreScoreRepository.kt` - 休養日ステータス永続化実装

### 2. 運動後チェックボックス（食事記録）
- **場所**: AddMealScreen
- **機能**: 運動後の食事を記録（GI/GL制限緩和）
- **変更ファイル**:
  - `AddMealScreen.kt` - チェックボックスUI追加
  - テキスト: 「運動後」「GL制限が緩和されます（高GI値食を推奨）」

### 3. 分析機能の改善
- **変更内容**:
  - 全データ揃わなくても分析可能に（警告メッセージ表示）
  - 休養日の絵文字（😴）を削除
- **変更ファイル**:
  - `AnalysisScreen.kt` - GenerateAnalysisCard に警告カード追加

### 4. レベル・XP・クレジット表示バナー
- **場所**: ダッシュボード上部
- **機能**: Lv表示、経験値プログレスバー、無料/有料クレジット表示
- **変更ファイル**:
  - `User.kt` (shared) - `experience`, `calculateLevel()`, `calculateExpProgress()`, `ExpProgress` 追加
  - `FirestoreUserRepository.kt` - experience フィールド読み込み
  - `DashboardScreen.kt` - LevelBanner コンポーネント追加

### 5. ルーティン設定画面
- **場所**: 設定 → 機能タブ → ルーティン設定
- **機能**: 7日間分割パターン表示、デフォルトルーティン作成
- **新規ファイル**:
  - `RoutineSettingsScreen.kt` - UI + ViewModel
- **変更ファイル**:
  - `SettingsScreen.kt` - ナビゲーション追加
  - `AppModule.kt` - RoutineSettingsViewModel DI登録
  - `Screen.kt` - RoutineSettings ルート追加
  - `YourCoachNavHost.kt` - ナビゲーション追加

### 6. AI食品認識にギャラリー選択機能追加 ★本日最新
- **場所**: 食事記録 → AI食品認識
- **機能**: カメラ撮影に加えて、ギャラリーから既存写真を選択可能
- **変更ファイル**:
  - `AiFoodRecognitionScreen.kt` - `galleryLauncher` 追加、ボタンレイアウト変更

### 7. 休養日チェック時の分析バグ修正 ★本日最新
- **問題**: 休養日にチェックを入れて食事・コンディション記録後も分析できなかった
- **原因**: AnalysisViewModel が初期化されず userId が null だった
- **修正内容**:
  - `AnalysisViewModel.kt`:
    - `init` ブロックで FirebaseAuth から自動初期化
    - `loadAllData()` で全データ自動ロード
    - `isRestDay` フラグ追加
  - `AnalysisScreen.kt`:
    - `GenerateAnalysisCard` に `isRestDay` パラメータ追加
    - 休養日の場合は運動記録不要と判定

---

## 実機確認待ちの項目

1. **ギャラリー選択機能**
   - AI食品認識画面でギャラリーボタンが表示されるか
   - ギャラリーから写真選択 → AI分析できるか

2. **休養日での分析**
   - 休養日チェック + 食事 + コンディション記録で分析可能か
   - 警告メッセージが適切に表示されるか

---

## デバッグAPK場所
```
ycn_native/androidApp/build/outputs/apk/debug/app-debug.apk
```

---

## 明日の続行方法

```bash
# Claude Code起動後
cd C:\Users\yourc\ycn_re

# 状況確認
git status

# ネイティブアプリビルド
export JAVA_HOME="/c/Program Files/Android/Android Studio/jbr"
cd ycn_native
./gradlew :androidApp:assembleDebug
```

---

## 未実装・TODO

1. TemplateSettings 画面（現在プレースホルダー）
2. About 画面のナビゲーション実装
3. MealDetail / WorkoutDetail 画面
4. PostDetail / CreatePost 画面（COMY）
5. プロフィール設定画面で userId 取得（現在空文字）

---

## 技術メモ

### 経験値・レベル計算式
```kotlin
// 必要経験値 = 100 * level * (level - 1) / 2
fun getRequiredExpForLevel(level: Int): Int = 100 * level * (level - 1) / 2
```

### Firestore 休養日ステータス
- パス: `users/{userId}/dailyScores/{date}`
- フィールド: `isRestDay: Boolean`
